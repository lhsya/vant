{"remainingRequest":"/Users/adamliu/vant/node_modules/babel-loader/lib/index.js!/Users/adamliu/vant/node_modules/vue/dist/vue.runtime.esm.js","dependencies":[{"path":"/Users/adamliu/vant/node_modules/vue/dist/vue.runtime.esm.js","mtime":1694509796695},{"path":"/Users/adamliu/vant/babel.config.js","mtime":1694509704583},{"path":"/Users/adamliu/vant/node_modules/cache-loader/dist/cjs.js","mtime":1694509793427},{"path":"/Users/adamliu/vant/node_modules/babel-loader/lib/index.js","mtime":1694509794381}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:LyohCiAqIFZ1ZS5qcyB2Mi43LjE0CiAqIChjKSAyMDE0LTIwMjIgRXZhbiBZb3UKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLgogKi8KdmFyIGVtcHR5T2JqZWN0ID0gT2JqZWN0LmZyZWV6ZSh7fSk7CnZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheTsKLy8gVGhlc2UgaGVscGVycyBwcm9kdWNlIGJldHRlciBWTSBjb2RlIGluIEpTIGVuZ2luZXMgZHVlIHRvIHRoZWlyCi8vIGV4cGxpY2l0bmVzcyBhbmQgZnVuY3Rpb24gaW5saW5pbmcuCmZ1bmN0aW9uIGlzVW5kZWYodikgewogIHJldHVybiB2ID09PSB1bmRlZmluZWQgfHwgdiA9PT0gbnVsbDsKfQpmdW5jdGlvbiBpc0RlZih2KSB7CiAgcmV0dXJuIHYgIT09IHVuZGVmaW5lZCAmJiB2ICE9PSBudWxsOwp9CmZ1bmN0aW9uIGlzVHJ1ZSh2KSB7CiAgcmV0dXJuIHYgPT09IHRydWU7Cn0KZnVuY3Rpb24gaXNGYWxzZSh2KSB7CiAgcmV0dXJuIHYgPT09IGZhbHNlOwp9Ci8qKgogKiBDaGVjayBpZiB2YWx1ZSBpcyBwcmltaXRpdmUuCiAqLwpmdW5jdGlvbiBpc1ByaW1pdGl2ZSh2YWx1ZSkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgfHwKICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICB0eXBlb2YgdmFsdWUgPT09ICdzeW1ib2wnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nOwp9CmZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nOwp9Ci8qKgogKiBRdWljayBvYmplY3QgY2hlY2sgLSB0aGlzIGlzIHByaW1hcmlseSB1c2VkIHRvIHRlbGwKICogb2JqZWN0cyBmcm9tIHByaW1pdGl2ZSB2YWx1ZXMgd2hlbiB3ZSBrbm93IHRoZSB2YWx1ZQogKiBpcyBhIEpTT04tY29tcGxpYW50IHR5cGUuCiAqLwpmdW5jdGlvbiBpc09iamVjdChvYmopIHsKICByZXR1cm4gb2JqICE9PSBudWxsICYmIHR5cGVvZiBvYmogPT09ICdvYmplY3QnOwp9Ci8qKgogKiBHZXQgdGhlIHJhdyB0eXBlIHN0cmluZyBvZiBhIHZhbHVlLCBlLmcuLCBbb2JqZWN0IE9iamVjdF0uCiAqLwp2YXIgX3RvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKZnVuY3Rpb24gdG9SYXdUeXBlKHZhbHVlKSB7CiAgcmV0dXJuIF90b1N0cmluZy5jYWxsKHZhbHVlKS5zbGljZSg4LCAtMSk7Cn0KLyoqCiAqIFN0cmljdCBvYmplY3QgdHlwZSBjaGVjay4gT25seSByZXR1cm5zIHRydWUKICogZm9yIHBsYWluIEphdmFTY3JpcHQgb2JqZWN0cy4KICovCmZ1bmN0aW9uIGlzUGxhaW5PYmplY3Qob2JqKSB7CiAgcmV0dXJuIF90b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IE9iamVjdF0nOwp9CmZ1bmN0aW9uIGlzUmVnRXhwKHYpIHsKICByZXR1cm4gX3RvU3RyaW5nLmNhbGwodikgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwp9Ci8qKgogKiBDaGVjayBpZiB2YWwgaXMgYSB2YWxpZCBhcnJheSBpbmRleC4KICovCmZ1bmN0aW9uIGlzVmFsaWRBcnJheUluZGV4KHZhbCkgewogIHZhciBuID0gcGFyc2VGbG9hdChTdHJpbmcodmFsKSk7CiAgcmV0dXJuIG4gPj0gMCAmJiBNYXRoLmZsb29yKG4pID09PSBuICYmIGlzRmluaXRlKHZhbCk7Cn0KZnVuY3Rpb24gaXNQcm9taXNlKHZhbCkgewogIHJldHVybiBpc0RlZih2YWwpICYmIHR5cGVvZiB2YWwudGhlbiA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgdmFsLmNhdGNoID09PSAnZnVuY3Rpb24nOwp9Ci8qKgogKiBDb252ZXJ0IGEgdmFsdWUgdG8gYSBzdHJpbmcgdGhhdCBpcyBhY3R1YWxseSByZW5kZXJlZC4KICovCmZ1bmN0aW9uIHRvU3RyaW5nKHZhbCkgewogIHJldHVybiB2YWwgPT0gbnVsbCA/ICcnIDogQXJyYXkuaXNBcnJheSh2YWwpIHx8IGlzUGxhaW5PYmplY3QodmFsKSAmJiB2YWwudG9TdHJpbmcgPT09IF90b1N0cmluZyA/IEpTT04uc3RyaW5naWZ5KHZhbCwgbnVsbCwgMikgOiBTdHJpbmcodmFsKTsKfQovKioKICogQ29udmVydCBhbiBpbnB1dCB2YWx1ZSB0byBhIG51bWJlciBmb3IgcGVyc2lzdGVuY2UuCiAqIElmIHRoZSBjb252ZXJzaW9uIGZhaWxzLCByZXR1cm4gb3JpZ2luYWwgc3RyaW5nLgogKi8KZnVuY3Rpb24gdG9OdW1iZXIodmFsKSB7CiAgdmFyIG4gPSBwYXJzZUZsb2F0KHZhbCk7CiAgcmV0dXJuIGlzTmFOKG4pID8gdmFsIDogbjsKfQovKioKICogTWFrZSBhIG1hcCBhbmQgcmV0dXJuIGEgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGEga2V5CiAqIGlzIGluIHRoYXQgbWFwLgogKi8KZnVuY3Rpb24gbWFrZU1hcChzdHIsIGV4cGVjdHNMb3dlckNhc2UpIHsKICB2YXIgbWFwID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB2YXIgbGlzdCA9IHN0ci5zcGxpdCgnLCcpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgbWFwW2xpc3RbaV1dID0gdHJ1ZTsKICB9CiAgcmV0dXJuIGV4cGVjdHNMb3dlckNhc2UgPyBmdW5jdGlvbiAodmFsKSB7CiAgICByZXR1cm4gbWFwW3ZhbC50b0xvd2VyQ2FzZSgpXTsKICB9IDogZnVuY3Rpb24gKHZhbCkgewogICAgcmV0dXJuIG1hcFt2YWxdOwogIH07Cn0KLyoqCiAqIENoZWNrIGlmIGEgdGFnIGlzIGEgYnVpbHQtaW4gdGFnLgogKi8KdmFyIGlzQnVpbHRJblRhZyA9IG1ha2VNYXAoJ3Nsb3QsY29tcG9uZW50JywgdHJ1ZSk7Ci8qKgogKiBDaGVjayBpZiBhbiBhdHRyaWJ1dGUgaXMgYSByZXNlcnZlZCBhdHRyaWJ1dGUuCiAqLwp2YXIgaXNSZXNlcnZlZEF0dHJpYnV0ZSA9IG1ha2VNYXAoJ2tleSxyZWYsc2xvdCxzbG90LXNjb3BlLGlzJyk7Ci8qKgogKiBSZW1vdmUgYW4gaXRlbSBmcm9tIGFuIGFycmF5LgogKi8KZnVuY3Rpb24gcmVtb3ZlJDIoYXJyLCBpdGVtKSB7CiAgdmFyIGxlbiA9IGFyci5sZW5ndGg7CiAgaWYgKGxlbikgewogICAgLy8gZmFzdCBwYXRoIGZvciB0aGUgb25seSAvIGxhc3QgaXRlbQogICAgaWYgKGl0ZW0gPT09IGFycltsZW4gLSAxXSkgewogICAgICBhcnIubGVuZ3RoID0gbGVuIC0gMTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGluZGV4ID0gYXJyLmluZGV4T2YoaXRlbSk7CiAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICByZXR1cm4gYXJyLnNwbGljZShpbmRleCwgMSk7CiAgICB9CiAgfQp9Ci8qKgogKiBDaGVjayB3aGV0aGVyIGFuIG9iamVjdCBoYXMgdGhlIHByb3BlcnR5LgogKi8KdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKZnVuY3Rpb24gaGFzT3duKG9iaiwga2V5KSB7CiAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwp9Ci8qKgogKiBDcmVhdGUgYSBjYWNoZWQgdmVyc2lvbiBvZiBhIHB1cmUgZnVuY3Rpb24uCiAqLwpmdW5jdGlvbiBjYWNoZWQoZm4pIHsKICB2YXIgY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIHJldHVybiBmdW5jdGlvbiBjYWNoZWRGbihzdHIpIHsKICAgIHZhciBoaXQgPSBjYWNoZVtzdHJdOwogICAgcmV0dXJuIGhpdCB8fCAoY2FjaGVbc3RyXSA9IGZuKHN0cikpOwogIH07Cn0KLyoqCiAqIENhbWVsaXplIGEgaHlwaGVuLWRlbGltaXRlZCBzdHJpbmcuCiAqLwp2YXIgY2FtZWxpemVSRSA9IC8tKFx3KS9nOwp2YXIgY2FtZWxpemUgPSBjYWNoZWQoZnVuY3Rpb24gKHN0cikgewogIHJldHVybiBzdHIucmVwbGFjZShjYW1lbGl6ZVJFLCBmdW5jdGlvbiAoXywgYykgewogICAgcmV0dXJuIGMgPyBjLnRvVXBwZXJDYXNlKCkgOiAnJzsKICB9KTsKfSk7Ci8qKgogKiBDYXBpdGFsaXplIGEgc3RyaW5nLgogKi8KdmFyIGNhcGl0YWxpemUgPSBjYWNoZWQoZnVuY3Rpb24gKHN0cikgewogIHJldHVybiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSk7Cn0pOwovKioKICogSHlwaGVuYXRlIGEgY2FtZWxDYXNlIHN0cmluZy4KICovCnZhciBoeXBoZW5hdGVSRSA9IC9cQihbQS1aXSkvZzsKdmFyIGh5cGhlbmF0ZSA9IGNhY2hlZChmdW5jdGlvbiAoc3RyKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKGh5cGhlbmF0ZVJFLCAnLSQxJykudG9Mb3dlckNhc2UoKTsKfSk7Ci8qKgogKiBTaW1wbGUgYmluZCBwb2x5ZmlsbCBmb3IgZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IHN1cHBvcnQgaXQsCiAqIGUuZy4sIFBoYW50b21KUyAxLnguIFRlY2huaWNhbGx5LCB3ZSBkb24ndCBuZWVkIHRoaXMgYW55bW9yZQogKiBzaW5jZSBuYXRpdmUgYmluZCBpcyBub3cgcGVyZm9ybWFudCBlbm91Z2ggaW4gbW9zdCBicm93c2Vycy4KICogQnV0IHJlbW92aW5nIGl0IHdvdWxkIG1lYW4gYnJlYWtpbmcgY29kZSB0aGF0IHdhcyBhYmxlIHRvIHJ1biBpbgogKiBQaGFudG9tSlMgMS54LCBzbyB0aGlzIG11c3QgYmUga2VwdCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4KICovCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCmZ1bmN0aW9uIHBvbHlmaWxsQmluZChmbiwgY3R4KSB7CiAgZnVuY3Rpb24gYm91bmRGbihhKSB7CiAgICB2YXIgbCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICByZXR1cm4gbCA/IGwgPiAxID8gZm4uYXBwbHkoY3R4LCBhcmd1bWVudHMpIDogZm4uY2FsbChjdHgsIGEpIDogZm4uY2FsbChjdHgpOwogIH0KICBib3VuZEZuLl9sZW5ndGggPSBmbi5sZW5ndGg7CiAgcmV0dXJuIGJvdW5kRm47Cn0KZnVuY3Rpb24gbmF0aXZlQmluZChmbiwgY3R4KSB7CiAgcmV0dXJuIGZuLmJpbmQoY3R4KTsKfQovLyBAdHMtZXhwZWN0LWVycm9yIGJpbmQgY2Fubm90IGJlIGB1bmRlZmluZWRgCnZhciBiaW5kID0gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPyBuYXRpdmVCaW5kIDogcG9seWZpbGxCaW5kOwovKioKICogQ29udmVydCBhbiBBcnJheS1saWtlIG9iamVjdCB0byBhIHJlYWwgQXJyYXkuCiAqLwpmdW5jdGlvbiB0b0FycmF5KGxpc3QsIHN0YXJ0KSB7CiAgc3RhcnQgPSBzdGFydCB8fCAwOwogIHZhciBpID0gbGlzdC5sZW5ndGggLSBzdGFydDsKICB2YXIgcmV0ID0gbmV3IEFycmF5KGkpOwogIHdoaWxlIChpLS0pIHsKICAgIHJldFtpXSA9IGxpc3RbaSArIHN0YXJ0XTsKICB9CiAgcmV0dXJuIHJldDsKfQovKioKICogTWl4IHByb3BlcnRpZXMgaW50byB0YXJnZXQgb2JqZWN0LgogKi8KZnVuY3Rpb24gZXh0ZW5kKHRvLCBfZnJvbSkgewogIGZvciAodmFyIGtleSBpbiBfZnJvbSkgewogICAgdG9ba2V5XSA9IF9mcm9tW2tleV07CiAgfQogIHJldHVybiB0bzsKfQovKioKICogTWVyZ2UgYW4gQXJyYXkgb2YgT2JqZWN0cyBpbnRvIGEgc2luZ2xlIE9iamVjdC4KICovCmZ1bmN0aW9uIHRvT2JqZWN0KGFycikgewogIHZhciByZXMgPSB7fTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgaWYgKGFycltpXSkgewogICAgICBleHRlbmQocmVzLCBhcnJbaV0pOwogICAgfQogIH0KICByZXR1cm4gcmVzOwp9Ci8qIGVzbGludC1kaXNhYmxlIG5vLXVudXNlZC12YXJzICovCi8qKgogKiBQZXJmb3JtIG5vIG9wZXJhdGlvbi4KICogU3R1YmJpbmcgYXJncyB0byBtYWtlIEZsb3cgaGFwcHkgd2l0aG91dCBsZWF2aW5nIHVzZWxlc3MgdHJhbnNwaWxlZCBjb2RlCiAqIHdpdGggLi4ucmVzdCAoaHR0cHM6Ly9mbG93Lm9yZy9ibG9nLzIwMTcvMDUvMDcvU3RyaWN0LUZ1bmN0aW9uLUNhbGwtQXJpdHkvKS4KICovCmZ1bmN0aW9uIG5vb3AoYSwgYiwgYykge30KLyoqCiAqIEFsd2F5cyByZXR1cm4gZmFsc2UuCiAqLwp2YXIgbm8gPSBmdW5jdGlvbiBubyhhLCBiLCBjKSB7CiAgcmV0dXJuIGZhbHNlOwp9OwovKiBlc2xpbnQtZW5hYmxlIG5vLXVudXNlZC12YXJzICovCi8qKgogKiBSZXR1cm4gdGhlIHNhbWUgdmFsdWUuCiAqLwp2YXIgaWRlbnRpdHkgPSBmdW5jdGlvbiBpZGVudGl0eShfKSB7CiAgcmV0dXJuIF87Cn07Ci8qKgogKiBDaGVjayBpZiB0d28gdmFsdWVzIGFyZSBsb29zZWx5IGVxdWFsIC0gdGhhdCBpcywKICogaWYgdGhleSBhcmUgcGxhaW4gb2JqZWN0cywgZG8gdGhleSBoYXZlIHRoZSBzYW1lIHNoYXBlPwogKi8KZnVuY3Rpb24gbG9vc2VFcXVhbChhLCBiKSB7CiAgaWYgKGEgPT09IGIpIHJldHVybiB0cnVlOwogIHZhciBpc09iamVjdEEgPSBpc09iamVjdChhKTsKICB2YXIgaXNPYmplY3RCID0gaXNPYmplY3QoYik7CiAgaWYgKGlzT2JqZWN0QSAmJiBpc09iamVjdEIpIHsKICAgIHRyeSB7CiAgICAgIHZhciBpc0FycmF5QSA9IEFycmF5LmlzQXJyYXkoYSk7CiAgICAgIHZhciBpc0FycmF5QiA9IEFycmF5LmlzQXJyYXkoYik7CiAgICAgIGlmIChpc0FycmF5QSAmJiBpc0FycmF5QikgewogICAgICAgIHJldHVybiBhLmxlbmd0aCA9PT0gYi5sZW5ndGggJiYgYS5ldmVyeShmdW5jdGlvbiAoZSwgaSkgewogICAgICAgICAgcmV0dXJuIGxvb3NlRXF1YWwoZSwgYltpXSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoYSBpbnN0YW5jZW9mIERhdGUgJiYgYiBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICByZXR1cm4gYS5nZXRUaW1lKCkgPT09IGIuZ2V0VGltZSgpOwogICAgICB9IGVsc2UgaWYgKCFpc0FycmF5QSAmJiAhaXNBcnJheUIpIHsKICAgICAgICB2YXIga2V5c0EgPSBPYmplY3Qua2V5cyhhKTsKICAgICAgICB2YXIga2V5c0IgPSBPYmplY3Qua2V5cyhiKTsKICAgICAgICByZXR1cm4ga2V5c0EubGVuZ3RoID09PSBrZXlzQi5sZW5ndGggJiYga2V5c0EuZXZlcnkoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgcmV0dXJuIGxvb3NlRXF1YWwoYVtrZXldLCBiW2tleV0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9IGVsc2UgaWYgKCFpc09iamVjdEEgJiYgIWlzT2JqZWN0QikgewogICAgcmV0dXJuIFN0cmluZyhhKSA9PT0gU3RyaW5nKGIpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9Ci8qKgogKiBSZXR1cm4gdGhlIGZpcnN0IGluZGV4IGF0IHdoaWNoIGEgbG9vc2VseSBlcXVhbCB2YWx1ZSBjYW4gYmUKICogZm91bmQgaW4gdGhlIGFycmF5IChpZiB2YWx1ZSBpcyBhIHBsYWluIG9iamVjdCwgdGhlIGFycmF5IG11c3QKICogY29udGFpbiBhbiBvYmplY3Qgb2YgdGhlIHNhbWUgc2hhcGUpLCBvciAtMSBpZiBpdCBpcyBub3QgcHJlc2VudC4KICovCmZ1bmN0aW9uIGxvb3NlSW5kZXhPZihhcnIsIHZhbCkgewogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAobG9vc2VFcXVhbChhcnJbaV0sIHZhbCkpIHJldHVybiBpOwogIH0KICByZXR1cm4gLTE7Cn0KLyoqCiAqIEVuc3VyZSBhIGZ1bmN0aW9uIGlzIGNhbGxlZCBvbmx5IG9uY2UuCiAqLwpmdW5jdGlvbiBvbmNlKGZuKSB7CiAgdmFyIGNhbGxlZCA9IGZhbHNlOwogIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNhbGxlZCkgewogICAgICBjYWxsZWQgPSB0cnVlOwogICAgICBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH07Cn0KLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvT2JqZWN0L2lzI3BvbHlmaWxsCmZ1bmN0aW9uIGhhc0NoYW5nZWQoeCwgeSkgewogIGlmICh4ID09PSB5KSB7CiAgICByZXR1cm4geCA9PT0gMCAmJiAxIC8geCAhPT0gMSAvIHk7CiAgfSBlbHNlIHsKICAgIHJldHVybiB4ID09PSB4IHx8IHkgPT09IHk7CiAgfQp9CnZhciBTU1JfQVRUUiA9ICdkYXRhLXNlcnZlci1yZW5kZXJlZCc7CnZhciBBU1NFVF9UWVBFUyA9IFsnY29tcG9uZW50JywgJ2RpcmVjdGl2ZScsICdmaWx0ZXInXTsKdmFyIExJRkVDWUNMRV9IT09LUyA9IFsnYmVmb3JlQ3JlYXRlJywgJ2NyZWF0ZWQnLCAnYmVmb3JlTW91bnQnLCAnbW91bnRlZCcsICdiZWZvcmVVcGRhdGUnLCAndXBkYXRlZCcsICdiZWZvcmVEZXN0cm95JywgJ2Rlc3Ryb3llZCcsICdhY3RpdmF0ZWQnLCAnZGVhY3RpdmF0ZWQnLCAnZXJyb3JDYXB0dXJlZCcsICdzZXJ2ZXJQcmVmZXRjaCcsICdyZW5kZXJUcmFja2VkJywgJ3JlbmRlclRyaWdnZXJlZCddOwp2YXIgY29uZmlnID0gewogIC8qKgogICAqIE9wdGlvbiBtZXJnZSBzdHJhdGVnaWVzICh1c2VkIGluIGNvcmUvdXRpbC9vcHRpb25zKQogICAqLwogIC8vICRmbG93LWRpc2FibGUtbGluZQogIG9wdGlvbk1lcmdlU3RyYXRlZ2llczogT2JqZWN0LmNyZWF0ZShudWxsKSwKICAvKioKICAgKiBXaGV0aGVyIHRvIHN1cHByZXNzIHdhcm5pbmdzLgogICAqLwogIHNpbGVudDogZmFsc2UsCiAgLyoqCiAgICogU2hvdyBwcm9kdWN0aW9uIG1vZGUgdGlwIG1lc3NhZ2Ugb24gYm9vdD8KICAgKi8KICBwcm9kdWN0aW9uVGlwOiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nLAogIC8qKgogICAqIFdoZXRoZXIgdG8gZW5hYmxlIGRldnRvb2xzCiAgICovCiAgZGV2dG9vbHM6IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicsCiAgLyoqCiAgICogV2hldGhlciB0byByZWNvcmQgcGVyZgogICAqLwogIHBlcmZvcm1hbmNlOiBmYWxzZSwKICAvKioKICAgKiBFcnJvciBoYW5kbGVyIGZvciB3YXRjaGVyIGVycm9ycwogICAqLwogIGVycm9ySGFuZGxlcjogbnVsbCwKICAvKioKICAgKiBXYXJuIGhhbmRsZXIgZm9yIHdhdGNoZXIgd2FybnMKICAgKi8KICB3YXJuSGFuZGxlcjogbnVsbCwKICAvKioKICAgKiBJZ25vcmUgY2VydGFpbiBjdXN0b20gZWxlbWVudHMKICAgKi8KICBpZ25vcmVkRWxlbWVudHM6IFtdLAogIC8qKgogICAqIEN1c3RvbSB1c2VyIGtleSBhbGlhc2VzIGZvciB2LW9uCiAgICovCiAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAga2V5Q29kZXM6IE9iamVjdC5jcmVhdGUobnVsbCksCiAgLyoqCiAgICogQ2hlY2sgaWYgYSB0YWcgaXMgcmVzZXJ2ZWQgc28gdGhhdCBpdCBjYW5ub3QgYmUgcmVnaXN0ZXJlZCBhcyBhCiAgICogY29tcG9uZW50LiBUaGlzIGlzIHBsYXRmb3JtLWRlcGVuZGVudCBhbmQgbWF5IGJlIG92ZXJ3cml0dGVuLgogICAqLwogIGlzUmVzZXJ2ZWRUYWc6IG5vLAogIC8qKgogICAqIENoZWNrIGlmIGFuIGF0dHJpYnV0ZSBpcyByZXNlcnZlZCBzbyB0aGF0IGl0IGNhbm5vdCBiZSB1c2VkIGFzIGEgY29tcG9uZW50CiAgICogcHJvcC4gVGhpcyBpcyBwbGF0Zm9ybS1kZXBlbmRlbnQgYW5kIG1heSBiZSBvdmVyd3JpdHRlbi4KICAgKi8KICBpc1Jlc2VydmVkQXR0cjogbm8sCiAgLyoqCiAgICogQ2hlY2sgaWYgYSB0YWcgaXMgYW4gdW5rbm93biBlbGVtZW50LgogICAqIFBsYXRmb3JtLWRlcGVuZGVudC4KICAgKi8KICBpc1Vua25vd25FbGVtZW50OiBubywKICAvKioKICAgKiBHZXQgdGhlIG5hbWVzcGFjZSBvZiBhbiBlbGVtZW50CiAgICovCiAgZ2V0VGFnTmFtZXNwYWNlOiBub29wLAogIC8qKgogICAqIFBhcnNlIHRoZSByZWFsIHRhZyBuYW1lIGZvciB0aGUgc3BlY2lmaWMgcGxhdGZvcm0uCiAgICovCiAgcGFyc2VQbGF0Zm9ybVRhZ05hbWU6IGlkZW50aXR5LAogIC8qKgogICAqIENoZWNrIGlmIGFuIGF0dHJpYnV0ZSBtdXN0IGJlIGJvdW5kIHVzaW5nIHByb3BlcnR5LCBlLmcuIHZhbHVlCiAgICogUGxhdGZvcm0tZGVwZW5kZW50LgogICAqLwogIG11c3RVc2VQcm9wOiBubywKICAvKioKICAgKiBQZXJmb3JtIHVwZGF0ZXMgYXN5bmNocm9ub3VzbHkuIEludGVuZGVkIHRvIGJlIHVzZWQgYnkgVnVlIFRlc3QgVXRpbHMKICAgKiBUaGlzIHdpbGwgc2lnbmlmaWNhbnRseSByZWR1Y2UgcGVyZm9ybWFuY2UgaWYgc2V0IHRvIGZhbHNlLgogICAqLwogIGFzeW5jOiB0cnVlLAogIC8qKgogICAqIEV4cG9zZWQgZm9yIGxlZ2FjeSByZWFzb25zCiAgICovCiAgX2xpZmVjeWNsZUhvb2tzOiBMSUZFQ1lDTEVfSE9PS1MKfTsKCi8qKgogKiB1bmljb2RlIGxldHRlcnMgdXNlZCBmb3IgcGFyc2luZyBodG1sIHRhZ3MsIGNvbXBvbmVudCBuYW1lcyBhbmQgcHJvcGVydHkgcGF0aHMuCiAqIHVzaW5nIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9odG1sNTMvc2VtYW50aWNzLXNjcmlwdGluZy5odG1sI3BvdGVudGlhbGN1c3RvbWVsZW1lbnRuYW1lCiAqIHNraXBwaW5nIFx1MTAwMDAtXHVFRkZGRiBkdWUgdG8gaXQgZnJlZXppbmcgdXAgUGhhbnRvbUpTCiAqLwp2YXIgdW5pY29kZVJlZ0V4cCA9IC9hLXpBLVpcdTAwQjdcdTAwQzAtXHUwMEQ2XHUwMEQ4LVx1MDBGNlx1MDBGOC1cdTAzN0RcdTAzN0YtXHUxRkZGXHUyMDBDLVx1MjAwRFx1MjAzRi1cdTIwNDBcdTIwNzAtXHUyMThGXHUyQzAwLVx1MkZFRlx1MzAwMS1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZGRC87Ci8qKgogKiBDaGVjayBpZiBhIHN0cmluZyBzdGFydHMgd2l0aCAkIG9yIF8KICovCmZ1bmN0aW9uIGlzUmVzZXJ2ZWQoc3RyKSB7CiAgdmFyIGMgPSAoc3RyICsgJycpLmNoYXJDb2RlQXQoMCk7CiAgcmV0dXJuIGMgPT09IDB4MjQgfHwgYyA9PT0gMHg1ZjsKfQovKioKICogRGVmaW5lIGEgcHJvcGVydHkuCiAqLwpmdW5jdGlvbiBkZWYob2JqLCBrZXksIHZhbCwgZW51bWVyYWJsZSkgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgdmFsdWU6IHZhbCwKICAgIGVudW1lcmFibGU6ICEhZW51bWVyYWJsZSwKICAgIHdyaXRhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSk7Cn0KLyoqCiAqIFBhcnNlIHNpbXBsZSBwYXRoLgogKi8KdmFyIGJhaWxSRSA9IG5ldyBSZWdFeHAoIlteIi5jb25jYXQodW5pY29kZVJlZ0V4cC5zb3VyY2UsICIuJF9cXGRdIikpOwpmdW5jdGlvbiBwYXJzZVBhdGgocGF0aCkgewogIGlmIChiYWlsUkUudGVzdChwYXRoKSkgewogICAgcmV0dXJuOwogIH0KICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgcmV0dXJuIGZ1bmN0aW9uIChvYmopIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VnbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCFvYmopIHJldHVybjsKICAgICAgb2JqID0gb2JqW3NlZ21lbnRzW2ldXTsKICAgIH0KICAgIHJldHVybiBvYmo7CiAgfTsKfQoKLy8gY2FuIHdlIHVzZSBfX3Byb3RvX18/CnZhciBoYXNQcm90byA9ICgnX19wcm90b19fJyBpbiB7fSk7Ci8vIEJyb3dzZXIgZW52aXJvbm1lbnQgc25pZmZpbmcKdmFyIGluQnJvd3NlciA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnOwp2YXIgVUEgPSBpbkJyb3dzZXIgJiYgd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTsKdmFyIGlzSUUgPSBVQSAmJiAvbXNpZXx0cmlkZW50Ly50ZXN0KFVBKTsKdmFyIGlzSUU5ID0gVUEgJiYgVUEuaW5kZXhPZignbXNpZSA5LjAnKSA+IDA7CnZhciBpc0VkZ2UgPSBVQSAmJiBVQS5pbmRleE9mKCdlZGdlLycpID4gMDsKVUEgJiYgVUEuaW5kZXhPZignYW5kcm9pZCcpID4gMDsKdmFyIGlzSU9TID0gVUEgJiYgL2lwaG9uZXxpcGFkfGlwb2R8aW9zLy50ZXN0KFVBKTsKVUEgJiYgL2Nocm9tZVwvXGQrLy50ZXN0KFVBKSAmJiAhaXNFZGdlOwpVQSAmJiAvcGhhbnRvbWpzLy50ZXN0KFVBKTsKdmFyIGlzRkYgPSBVQSAmJiBVQS5tYXRjaCgvZmlyZWZveFwvKFxkKykvKTsKLy8gRmlyZWZveCBoYXMgYSAid2F0Y2giIGZ1bmN0aW9uIG9uIE9iamVjdC5wcm90b3R5cGUuLi4KLy8gQHRzLWV4cGVjdC1lcnJvciBmaXJlYm94IHN1cHBvcnQKdmFyIG5hdGl2ZVdhdGNoID0ge30ud2F0Y2g7CnZhciBzdXBwb3J0c1Bhc3NpdmUgPSBmYWxzZTsKaWYgKGluQnJvd3NlcikgewogIHRyeSB7CiAgICB2YXIgb3B0cyA9IHt9OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdHMsICdwYXNzaXZlJywgewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIHN1cHBvcnRzUGFzc2l2ZSA9IHRydWU7CiAgICAgIH0KICAgIH0pOyAvLyBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svZmxvdy9pc3N1ZXMvMjg1CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndGVzdC1wYXNzaXZlJywgbnVsbCwgb3B0cyk7CiAgfSBjYXRjaCAoZSkge30KfQovLyB0aGlzIG5lZWRzIHRvIGJlIGxhenktZXZhbGVkIGJlY2F1c2UgdnVlIG1heSBiZSByZXF1aXJlZCBiZWZvcmUKLy8gdnVlLXNlcnZlci1yZW5kZXJlciBjYW4gc2V0IFZVRV9FTlYKdmFyIF9pc1NlcnZlcjsKdmFyIGlzU2VydmVyUmVuZGVyaW5nID0gZnVuY3Rpb24gaXNTZXJ2ZXJSZW5kZXJpbmcoKSB7CiAgaWYgKF9pc1NlcnZlciA9PT0gdW5kZWZpbmVkKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICghaW5Ccm93c2VyICYmIHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIC8vIGRldGVjdCBwcmVzZW5jZSBvZiB2dWUtc2VydmVyLXJlbmRlcmVyIGFuZCBhdm9pZAogICAgICAvLyBXZWJwYWNrIHNoaW1taW5nIHRoZSBwcm9jZXNzCiAgICAgIF9pc1NlcnZlciA9IGdsb2JhbFsncHJvY2VzcyddICYmIGdsb2JhbFsncHJvY2VzcyddLmVudi5WVUVfRU5WID09PSAnc2VydmVyJzsKICAgIH0gZWxzZSB7CiAgICAgIF9pc1NlcnZlciA9IGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gX2lzU2VydmVyOwp9OwovLyBkZXRlY3QgZGV2dG9vbHMKdmFyIGRldnRvb2xzID0gaW5Ccm93c2VyICYmIHdpbmRvdy5fX1ZVRV9ERVZUT09MU19HTE9CQUxfSE9PS19fOwovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwpmdW5jdGlvbiBpc05hdGl2ZShDdG9yKSB7CiAgcmV0dXJuIHR5cGVvZiBDdG9yID09PSAnZnVuY3Rpb24nICYmIC9uYXRpdmUgY29kZS8udGVzdChDdG9yLnRvU3RyaW5nKCkpOwp9CnZhciBoYXNTeW1ib2wgPSB0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShTeW1ib2wpICYmIHR5cGVvZiBSZWZsZWN0ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShSZWZsZWN0Lm93bktleXMpOwp2YXIgX1NldDsgLy8gJGZsb3ctZGlzYWJsZS1saW5lCi8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwppZiAodHlwZW9mIFNldCAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoU2V0KSkgewogIC8vIHVzZSBuYXRpdmUgU2V0IHdoZW4gYXZhaWxhYmxlLgogIF9TZXQgPSBTZXQ7Cn0gZWxzZSB7CiAgLy8gYSBub24tc3RhbmRhcmQgU2V0IHBvbHlmaWxsIHRoYXQgb25seSB3b3JrcyB3aXRoIHByaW1pdGl2ZSBrZXlzLgogIF9TZXQgPSAvKiogQGNsYXNzICovZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gU2V0KCkgewogICAgICB0aGlzLnNldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9CiAgICBTZXQucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0W2tleV0gPT09IHRydWU7CiAgICB9OwogICAgU2V0LnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHRoaXMuc2V0W2tleV0gPSB0cnVlOwogICAgfTsKICAgIFNldC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuc2V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH07CiAgICByZXR1cm4gU2V0OwogIH0oKTsKfQp2YXIgY3VycmVudEluc3RhbmNlID0gbnVsbDsKLyoqCiAqIFRoaXMgaXMgZXhwb3NlZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIHYzIChlLmcuIHNvbWUgZnVuY3Rpb25zIGluIFZ1ZVVzZQogKiByZWxpZXMgb24gaXQpLiBEbyBub3QgdXNlIHRoaXMgaW50ZXJuYWxseSwganVzdCB1c2UgYGN1cnJlbnRJbnN0YW5jZWAuCiAqCiAqIEBpbnRlcm5hbCB0aGlzIGZ1bmN0aW9uIG5lZWRzIG1hbnVhbCB0eXBlIGRlY2xhcmF0aW9uIGJlY2F1c2UgaXQgcmVsaWVzCiAqIG9uIHByZXZpb3VzbHkgbWFudWFsbHkgYXV0aG9yZWQgdHlwZXMgZnJvbSBWdWUgMgogKi8KZnVuY3Rpb24gZ2V0Q3VycmVudEluc3RhbmNlKCkgewogIHJldHVybiBjdXJyZW50SW5zdGFuY2UgJiYgewogICAgcHJveHk6IGN1cnJlbnRJbnN0YW5jZQogIH07Cn0KLyoqCiAqIEBpbnRlcm5hbAogKi8KZnVuY3Rpb24gc2V0Q3VycmVudEluc3RhbmNlKHZtKSB7CiAgaWYgKHZtID09PSB2b2lkIDApIHsKICAgIHZtID0gbnVsbDsKICB9CiAgaWYgKCF2bSkgY3VycmVudEluc3RhbmNlICYmIGN1cnJlbnRJbnN0YW5jZS5fc2NvcGUub2ZmKCk7CiAgY3VycmVudEluc3RhbmNlID0gdm07CiAgdm0gJiYgdm0uX3Njb3BlLm9uKCk7Cn0KCi8qKgogKiBAaW50ZXJuYWwKICovCnZhciBWTm9kZSA9IC8qKiBAY2xhc3MgKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gVk5vZGUodGFnLCBkYXRhLCBjaGlsZHJlbiwgdGV4dCwgZWxtLCBjb250ZXh0LCBjb21wb25lbnRPcHRpb25zLCBhc3luY0ZhY3RvcnkpIHsKICAgIHRoaXMudGFnID0gdGFnOwogICAgdGhpcy5kYXRhID0gZGF0YTsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICB0aGlzLmVsbSA9IGVsbTsKICAgIHRoaXMubnMgPSB1bmRlZmluZWQ7CiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgdGhpcy5mbkNvbnRleHQgPSB1bmRlZmluZWQ7CiAgICB0aGlzLmZuT3B0aW9ucyA9IHVuZGVmaW5lZDsKICAgIHRoaXMuZm5TY29wZUlkID0gdW5kZWZpbmVkOwogICAgdGhpcy5rZXkgPSBkYXRhICYmIGRhdGEua2V5OwogICAgdGhpcy5jb21wb25lbnRPcHRpb25zID0gY29tcG9uZW50T3B0aW9uczsKICAgIHRoaXMuY29tcG9uZW50SW5zdGFuY2UgPSB1bmRlZmluZWQ7CiAgICB0aGlzLnBhcmVudCA9IHVuZGVmaW5lZDsKICAgIHRoaXMucmF3ID0gZmFsc2U7CiAgICB0aGlzLmlzU3RhdGljID0gZmFsc2U7CiAgICB0aGlzLmlzUm9vdEluc2VydCA9IHRydWU7CiAgICB0aGlzLmlzQ29tbWVudCA9IGZhbHNlOwogICAgdGhpcy5pc0Nsb25lZCA9IGZhbHNlOwogICAgdGhpcy5pc09uY2UgPSBmYWxzZTsKICAgIHRoaXMuYXN5bmNGYWN0b3J5ID0gYXN5bmNGYWN0b3J5OwogICAgdGhpcy5hc3luY01ldGEgPSB1bmRlZmluZWQ7CiAgICB0aGlzLmlzQXN5bmNQbGFjZWhvbGRlciA9IGZhbHNlOwogIH0KICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVk5vZGUucHJvdG90eXBlLCAiY2hpbGQiLCB7CiAgICAvLyBERVBSRUNBVEVEOiBhbGlhcyBmb3IgY29tcG9uZW50SW5zdGFuY2UgZm9yIGJhY2t3YXJkcyBjb21wYXQuCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbXBvbmVudEluc3RhbmNlOwogICAgfSwKICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSk7CiAgcmV0dXJuIFZOb2RlOwp9KCk7CnZhciBjcmVhdGVFbXB0eVZOb2RlID0gZnVuY3Rpb24gY3JlYXRlRW1wdHlWTm9kZSh0ZXh0KSB7CiAgaWYgKHRleHQgPT09IHZvaWQgMCkgewogICAgdGV4dCA9ICcnOwogIH0KICB2YXIgbm9kZSA9IG5ldyBWTm9kZSgpOwogIG5vZGUudGV4dCA9IHRleHQ7CiAgbm9kZS5pc0NvbW1lbnQgPSB0cnVlOwogIHJldHVybiBub2RlOwp9OwpmdW5jdGlvbiBjcmVhdGVUZXh0Vk5vZGUodmFsKSB7CiAgcmV0dXJuIG5ldyBWTm9kZSh1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBTdHJpbmcodmFsKSk7Cn0KLy8gb3B0aW1pemVkIHNoYWxsb3cgY2xvbmUKLy8gdXNlZCBmb3Igc3RhdGljIG5vZGVzIGFuZCBzbG90IG5vZGVzIGJlY2F1c2UgdGhleSBtYXkgYmUgcmV1c2VkIGFjcm9zcwovLyBtdWx0aXBsZSByZW5kZXJzLCBjbG9uaW5nIHRoZW0gYXZvaWRzIGVycm9ycyB3aGVuIERPTSBtYW5pcHVsYXRpb25zIHJlbHkKLy8gb24gdGhlaXIgZWxtIHJlZmVyZW5jZS4KZnVuY3Rpb24gY2xvbmVWTm9kZSh2bm9kZSkgewogIHZhciBjbG9uZWQgPSBuZXcgVk5vZGUodm5vZGUudGFnLCB2bm9kZS5kYXRhLAogIC8vICM3OTc1CiAgLy8gY2xvbmUgY2hpbGRyZW4gYXJyYXkgdG8gYXZvaWQgbXV0YXRpbmcgb3JpZ2luYWwgaW4gY2FzZSBvZiBjbG9uaW5nCiAgLy8gYSBjaGlsZC4KICB2bm9kZS5jaGlsZHJlbiAmJiB2bm9kZS5jaGlsZHJlbi5zbGljZSgpLCB2bm9kZS50ZXh0LCB2bm9kZS5lbG0sIHZub2RlLmNvbnRleHQsIHZub2RlLmNvbXBvbmVudE9wdGlvbnMsIHZub2RlLmFzeW5jRmFjdG9yeSk7CiAgY2xvbmVkLm5zID0gdm5vZGUubnM7CiAgY2xvbmVkLmlzU3RhdGljID0gdm5vZGUuaXNTdGF0aWM7CiAgY2xvbmVkLmtleSA9IHZub2RlLmtleTsKICBjbG9uZWQuaXNDb21tZW50ID0gdm5vZGUuaXNDb21tZW50OwogIGNsb25lZC5mbkNvbnRleHQgPSB2bm9kZS5mbkNvbnRleHQ7CiAgY2xvbmVkLmZuT3B0aW9ucyA9IHZub2RlLmZuT3B0aW9uczsKICBjbG9uZWQuZm5TY29wZUlkID0gdm5vZGUuZm5TY29wZUlkOwogIGNsb25lZC5hc3luY01ldGEgPSB2bm9kZS5hc3luY01ldGE7CiAgY2xvbmVkLmlzQ2xvbmVkID0gdHJ1ZTsKICByZXR1cm4gY2xvbmVkOwp9CgovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqDQpDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4NCg0KUGVybWlzc2lvbiB0byB1c2UsIGNvcHksIG1vZGlmeSwgYW5kL29yIGRpc3RyaWJ1dGUgdGhpcyBzb2Z0d2FyZSBmb3IgYW55DQpwdXJwb3NlIHdpdGggb3Igd2l0aG91dCBmZWUgaXMgaGVyZWJ5IGdyYW50ZWQuDQoNClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiIEFORCBUSEUgQVVUSE9SIERJU0NMQUlNUyBBTEwgV0FSUkFOVElFUyBXSVRIDQpSRUdBUkQgVE8gVEhJUyBTT0ZUV0FSRSBJTkNMVURJTkcgQUxMIElNUExJRUQgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkNCkFORCBGSVRORVNTLiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SIEJFIExJQUJMRSBGT1IgQU5ZIFNQRUNJQUwsIERJUkVDVCwNCklORElSRUNULCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVMgT1IgQU5ZIERBTUFHRVMgV0hBVFNPRVZFUiBSRVNVTFRJTkcgRlJPTQ0KTE9TUyBPRiBVU0UsIERBVEEgT1IgUFJPRklUUywgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIE5FR0xJR0VOQ0UgT1INCk9USEVSIFRPUlRJT1VTIEFDVElPTiwgQVJJU0lORyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBVU0UgT1INClBFUkZPUk1BTkNFIE9GIFRISVMgU09GVFdBUkUuDQoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiAqLwoKdmFyIF9hc3NpZ24gPSBmdW5jdGlvbiBfX2Fzc2lnbigpIHsKICBfYXNzaWduID0gT2JqZWN0LmFzc2lnbiB8fCBmdW5jdGlvbiBfX2Fzc2lnbih0KSB7CiAgICBmb3IgKHZhciBzLCBpID0gMSwgbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgcyA9IGFyZ3VtZW50c1tpXTsKICAgICAgZm9yICh2YXIgcCBpbiBzKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHMsIHApKSB0W3BdID0gc1twXTsKICAgIH0KICAgIHJldHVybiB0OwogIH07CiAgcmV0dXJuIF9hc3NpZ24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKdmFyIHVpZCQyID0gMDsKdmFyIHBlbmRpbmdDbGVhbnVwRGVwcyA9IFtdOwp2YXIgY2xlYW51cERlcHMgPSBmdW5jdGlvbiBjbGVhbnVwRGVwcygpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IHBlbmRpbmdDbGVhbnVwRGVwcy5sZW5ndGg7IGkrKykgewogICAgdmFyIGRlcCA9IHBlbmRpbmdDbGVhbnVwRGVwc1tpXTsKICAgIGRlcC5zdWJzID0gZGVwLnN1YnMuZmlsdGVyKGZ1bmN0aW9uIChzKSB7CiAgICAgIHJldHVybiBzOwogICAgfSk7CiAgICBkZXAuX3BlbmRpbmcgPSBmYWxzZTsKICB9CiAgcGVuZGluZ0NsZWFudXBEZXBzLmxlbmd0aCA9IDA7Cn07Ci8qKgogKiBBIGRlcCBpcyBhbiBvYnNlcnZhYmxlIHRoYXQgY2FuIGhhdmUgbXVsdGlwbGUKICogZGlyZWN0aXZlcyBzdWJzY3JpYmluZyB0byBpdC4KICogQGludGVybmFsCiAqLwp2YXIgRGVwID0gLyoqIEBjbGFzcyAqL2Z1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBEZXAoKSB7CiAgICAvLyBwZW5kaW5nIHN1YnMgY2xlYW51cAogICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOwogICAgdGhpcy5pZCA9IHVpZCQyKys7CiAgICB0aGlzLnN1YnMgPSBbXTsKICB9CiAgRGVwLnByb3RvdHlwZS5hZGRTdWIgPSBmdW5jdGlvbiAoc3ViKSB7CiAgICB0aGlzLnN1YnMucHVzaChzdWIpOwogIH07CiAgRGVwLnByb3RvdHlwZS5yZW1vdmVTdWIgPSBmdW5jdGlvbiAoc3ViKSB7CiAgICAvLyAjMTI2OTYgZGVwcyB3aXRoIG1hc3NpdmUgYW1vdW50IG9mIHN1YnNjcmliZXJzIGFyZSBleHRyZW1lbHkgc2xvdyB0bwogICAgLy8gY2xlYW4gdXAgaW4gQ2hyb21pdW0KICAgIC8vIHRvIHdvcmthcm91bmQgdGhpcywgd2UgdW5zZXQgdGhlIHN1YiBmb3Igbm93LCBhbmQgY2xlYXIgdGhlbSBvbgogICAgLy8gbmV4dCBzY2hlZHVsZXIgZmx1c2guCiAgICB0aGlzLnN1YnNbdGhpcy5zdWJzLmluZGV4T2Yoc3ViKV0gPSBudWxsOwogICAgaWYgKCF0aGlzLl9wZW5kaW5nKSB7CiAgICAgIHRoaXMuX3BlbmRpbmcgPSB0cnVlOwogICAgICBwZW5kaW5nQ2xlYW51cERlcHMucHVzaCh0aGlzKTsKICAgIH0KICB9OwogIERlcC5wcm90b3R5cGUuZGVwZW5kID0gZnVuY3Rpb24gKGluZm8pIHsKICAgIGlmIChEZXAudGFyZ2V0KSB7CiAgICAgIERlcC50YXJnZXQuYWRkRGVwKHRoaXMpOwogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBpbmZvICYmIERlcC50YXJnZXQub25UcmFjaykgewogICAgICAgIERlcC50YXJnZXQub25UcmFjayhfYXNzaWduKHsKICAgICAgICAgIGVmZmVjdDogRGVwLnRhcmdldAogICAgICAgIH0sIGluZm8pKTsKICAgICAgfQogICAgfQogIH07CiAgRGVwLnByb3RvdHlwZS5ub3RpZnkgPSBmdW5jdGlvbiAoaW5mbykgewogICAgLy8gc3RhYmlsaXplIHRoZSBzdWJzY3JpYmVyIGxpc3QgZmlyc3QKICAgIHZhciBzdWJzID0gdGhpcy5zdWJzLmZpbHRlcihmdW5jdGlvbiAocykgewogICAgICByZXR1cm4gczsKICAgIH0pOwogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIWNvbmZpZy5hc3luYykgewogICAgICAvLyBzdWJzIGFyZW4ndCBzb3J0ZWQgaW4gc2NoZWR1bGVyIGlmIG5vdCBydW5uaW5nIGFzeW5jCiAgICAgIC8vIHdlIG5lZWQgdG8gc29ydCB0aGVtIG5vdyB0byBtYWtlIHN1cmUgdGhleSBmaXJlIGluIGNvcnJlY3QKICAgICAgLy8gb3JkZXIKICAgICAgc3Vicy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGEuaWQgLSBiLmlkOwogICAgICB9KTsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwLCBsID0gc3Vicy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIHN1YiA9IHN1YnNbaV07CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGluZm8pIHsKICAgICAgICBzdWIub25UcmlnZ2VyICYmIHN1Yi5vblRyaWdnZXIoX2Fzc2lnbih7CiAgICAgICAgICBlZmZlY3Q6IHN1YnNbaV0KICAgICAgICB9LCBpbmZvKSk7CiAgICAgIH0KICAgICAgc3ViLnVwZGF0ZSgpOwogICAgfQogIH07CiAgcmV0dXJuIERlcDsKfSgpOwovLyBUaGUgY3VycmVudCB0YXJnZXQgd2F0Y2hlciBiZWluZyBldmFsdWF0ZWQuCi8vIFRoaXMgaXMgZ2xvYmFsbHkgdW5pcXVlIGJlY2F1c2Ugb25seSBvbmUgd2F0Y2hlcgovLyBjYW4gYmUgZXZhbHVhdGVkIGF0IGEgdGltZS4KRGVwLnRhcmdldCA9IG51bGw7CnZhciB0YXJnZXRTdGFjayA9IFtdOwpmdW5jdGlvbiBwdXNoVGFyZ2V0KHRhcmdldCkgewogIHRhcmdldFN0YWNrLnB1c2godGFyZ2V0KTsKICBEZXAudGFyZ2V0ID0gdGFyZ2V0Owp9CmZ1bmN0aW9uIHBvcFRhcmdldCgpIHsKICB0YXJnZXRTdGFjay5wb3AoKTsKICBEZXAudGFyZ2V0ID0gdGFyZ2V0U3RhY2tbdGFyZ2V0U3RhY2subGVuZ3RoIC0gMV07Cn0KCi8qCiAqIG5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBwbGF5IHdlbGwgd2l0aAogKiBkeW5hbWljYWxseSBhY2Nlc3NpbmcgbWV0aG9kcyBvbiBBcnJheSBwcm90b3R5cGUKICovCnZhciBhcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlOwp2YXIgYXJyYXlNZXRob2RzID0gT2JqZWN0LmNyZWF0ZShhcnJheVByb3RvKTsKdmFyIG1ldGhvZHNUb1BhdGNoID0gWydwdXNoJywgJ3BvcCcsICdzaGlmdCcsICd1bnNoaWZ0JywgJ3NwbGljZScsICdzb3J0JywgJ3JldmVyc2UnXTsKLyoqCiAqIEludGVyY2VwdCBtdXRhdGluZyBtZXRob2RzIGFuZCBlbWl0IGV2ZW50cwogKi8KbWV0aG9kc1RvUGF0Y2guZm9yRWFjaChmdW5jdGlvbiAobWV0aG9kKSB7CiAgLy8gY2FjaGUgb3JpZ2luYWwgbWV0aG9kCiAgdmFyIG9yaWdpbmFsID0gYXJyYXlQcm90b1ttZXRob2RdOwogIGRlZihhcnJheU1ldGhvZHMsIG1ldGhvZCwgZnVuY3Rpb24gbXV0YXRvcigpIHsKICAgIHZhciBhcmdzID0gW107CiAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgewogICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07CiAgICB9CiAgICB2YXIgcmVzdWx0ID0gb3JpZ2luYWwuYXBwbHkodGhpcywgYXJncyk7CiAgICB2YXIgb2IgPSB0aGlzLl9fb2JfXzsKICAgIHZhciBpbnNlcnRlZDsKICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgIGNhc2UgJ3B1c2gnOgogICAgICBjYXNlICd1bnNoaWZ0JzoKICAgICAgICBpbnNlcnRlZCA9IGFyZ3M7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3NwbGljZSc6CiAgICAgICAgaW5zZXJ0ZWQgPSBhcmdzLnNsaWNlKDIpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgaWYgKGluc2VydGVkKSBvYi5vYnNlcnZlQXJyYXkoaW5zZXJ0ZWQpOwogICAgLy8gbm90aWZ5IGNoYW5nZQogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgb2IuZGVwLm5vdGlmeSh7CiAgICAgICAgdHlwZTogImFycmF5IG11dGF0aW9uIiAvKiBUcmlnZ2VyT3BUeXBlcy5BUlJBWV9NVVRBVElPTiAqLywKICAgICAgICB0YXJnZXQ6IHRoaXMsCiAgICAgICAga2V5OiBtZXRob2QKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBvYi5kZXAubm90aWZ5KCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0pOwp9KTsKdmFyIGFycmF5S2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGFycmF5TWV0aG9kcyk7CnZhciBOT19JTklJVElBTF9WQUxVRSA9IHt9OwovKioKICogSW4gc29tZSBjYXNlcyB3ZSBtYXkgd2FudCB0byBkaXNhYmxlIG9ic2VydmF0aW9uIGluc2lkZSBhIGNvbXBvbmVudCdzCiAqIHVwZGF0ZSBjb21wdXRhdGlvbi4KICovCnZhciBzaG91bGRPYnNlcnZlID0gdHJ1ZTsKZnVuY3Rpb24gdG9nZ2xlT2JzZXJ2aW5nKHZhbHVlKSB7CiAgc2hvdWxkT2JzZXJ2ZSA9IHZhbHVlOwp9Ci8vIHNzciBtb2NrIGRlcAp2YXIgbW9ja0RlcCA9IHsKICBub3RpZnk6IG5vb3AsCiAgZGVwZW5kOiBub29wLAogIGFkZFN1Yjogbm9vcCwKICByZW1vdmVTdWI6IG5vb3AKfTsKLyoqCiAqIE9ic2VydmVyIGNsYXNzIHRoYXQgaXMgYXR0YWNoZWQgdG8gZWFjaCBvYnNlcnZlZAogKiBvYmplY3QuIE9uY2UgYXR0YWNoZWQsIHRoZSBvYnNlcnZlciBjb252ZXJ0cyB0aGUgdGFyZ2V0CiAqIG9iamVjdCdzIHByb3BlcnR5IGtleXMgaW50byBnZXR0ZXIvc2V0dGVycyB0aGF0CiAqIGNvbGxlY3QgZGVwZW5kZW5jaWVzIGFuZCBkaXNwYXRjaCB1cGRhdGVzLgogKi8KdmFyIE9ic2VydmVyID0gLyoqIEBjbGFzcyAqL2Z1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBPYnNlcnZlcih2YWx1ZSwgc2hhbGxvdywgbW9jaykgewogICAgaWYgKHNoYWxsb3cgPT09IHZvaWQgMCkgewogICAgICBzaGFsbG93ID0gZmFsc2U7CiAgICB9CiAgICBpZiAobW9jayA9PT0gdm9pZCAwKSB7CiAgICAgIG1vY2sgPSBmYWxzZTsKICAgIH0KICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIHRoaXMuc2hhbGxvdyA9IHNoYWxsb3c7CiAgICB0aGlzLm1vY2sgPSBtb2NrOwogICAgLy8gdGhpcy52YWx1ZSA9IHZhbHVlCiAgICB0aGlzLmRlcCA9IG1vY2sgPyBtb2NrRGVwIDogbmV3IERlcCgpOwogICAgdGhpcy52bUNvdW50ID0gMDsKICAgIGRlZih2YWx1ZSwgJ19fb2JfXycsIHRoaXMpOwogICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGlmICghbW9jaykgewogICAgICAgIGlmIChoYXNQcm90bykgewogICAgICAgICAgdmFsdWUuX19wcm90b19fID0gYXJyYXlNZXRob2RzOwogICAgICAgICAgLyogZXNsaW50LWVuYWJsZSBuby1wcm90byAqLwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5S2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtleSA9IGFycmF5S2V5c1tpXTsKICAgICAgICAgICAgZGVmKHZhbHVlLCBrZXksIGFycmF5TWV0aG9kc1trZXldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFzaGFsbG93KSB7CiAgICAgICAgdGhpcy5vYnNlcnZlQXJyYXkodmFsdWUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvKioKICAgICAgICogV2FsayB0aHJvdWdoIGFsbCBwcm9wZXJ0aWVzIGFuZCBjb252ZXJ0IHRoZW0gaW50bwogICAgICAgKiBnZXR0ZXIvc2V0dGVycy4gVGhpcyBtZXRob2Qgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIHdoZW4KICAgICAgICogdmFsdWUgdHlwZSBpcyBPYmplY3QuCiAgICAgICAqLwogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgZGVmaW5lUmVhY3RpdmUodmFsdWUsIGtleSwgTk9fSU5JSVRJQUxfVkFMVUUsIHVuZGVmaW5lZCwgc2hhbGxvdywgbW9jayk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogT2JzZXJ2ZSBhIGxpc3Qgb2YgQXJyYXkgaXRlbXMuCiAgICovCiAgT2JzZXJ2ZXIucHJvdG90eXBlLm9ic2VydmVBcnJheSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2YWx1ZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgb2JzZXJ2ZSh2YWx1ZVtpXSwgZmFsc2UsIHRoaXMubW9jayk7CiAgICB9CiAgfTsKICByZXR1cm4gT2JzZXJ2ZXI7Cn0oKTsKLy8gaGVscGVycwovKioKICogQXR0ZW1wdCB0byBjcmVhdGUgYW4gb2JzZXJ2ZXIgaW5zdGFuY2UgZm9yIGEgdmFsdWUsCiAqIHJldHVybnMgdGhlIG5ldyBvYnNlcnZlciBpZiBzdWNjZXNzZnVsbHkgb2JzZXJ2ZWQsCiAqIG9yIHRoZSBleGlzdGluZyBvYnNlcnZlciBpZiB0aGUgdmFsdWUgYWxyZWFkeSBoYXMgb25lLgogKi8KZnVuY3Rpb24gb2JzZXJ2ZSh2YWx1ZSwgc2hhbGxvdywgc3NyTW9ja1JlYWN0aXZpdHkpIHsKICBpZiAodmFsdWUgJiYgaGFzT3duKHZhbHVlLCAnX19vYl9fJykgJiYgdmFsdWUuX19vYl9fIGluc3RhbmNlb2YgT2JzZXJ2ZXIpIHsKICAgIHJldHVybiB2YWx1ZS5fX29iX187CiAgfQogIGlmIChzaG91bGRPYnNlcnZlICYmIChzc3JNb2NrUmVhY3Rpdml0eSB8fCAhaXNTZXJ2ZXJSZW5kZXJpbmcoKSkgJiYgKGlzQXJyYXkodmFsdWUpIHx8IGlzUGxhaW5PYmplY3QodmFsdWUpKSAmJiBPYmplY3QuaXNFeHRlbnNpYmxlKHZhbHVlKSAmJiAhdmFsdWUuX192X3NraXAgLyogUmVhY3RpdmVGbGFncy5TS0lQICovICYmICFpc1JlZih2YWx1ZSkgJiYgISh2YWx1ZSBpbnN0YW5jZW9mIFZOb2RlKSkgewogICAgcmV0dXJuIG5ldyBPYnNlcnZlcih2YWx1ZSwgc2hhbGxvdywgc3NyTW9ja1JlYWN0aXZpdHkpOwogIH0KfQovKioKICogRGVmaW5lIGEgcmVhY3RpdmUgcHJvcGVydHkgb24gYW4gT2JqZWN0LgogKi8KZnVuY3Rpb24gZGVmaW5lUmVhY3RpdmUob2JqLCBrZXksIHZhbCwgY3VzdG9tU2V0dGVyLCBzaGFsbG93LCBtb2NrKSB7CiAgdmFyIGRlcCA9IG5ldyBEZXAoKTsKICB2YXIgcHJvcGVydHkgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KTsKICBpZiAocHJvcGVydHkgJiYgcHJvcGVydHkuY29uZmlndXJhYmxlID09PSBmYWxzZSkgewogICAgcmV0dXJuOwogIH0KICAvLyBjYXRlciBmb3IgcHJlLWRlZmluZWQgZ2V0dGVyL3NldHRlcnMKICB2YXIgZ2V0dGVyID0gcHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0OwogIHZhciBzZXR0ZXIgPSBwcm9wZXJ0eSAmJiBwcm9wZXJ0eS5zZXQ7CiAgaWYgKCghZ2V0dGVyIHx8IHNldHRlcikgJiYgKHZhbCA9PT0gTk9fSU5JSVRJQUxfVkFMVUUgfHwgYXJndW1lbnRzLmxlbmd0aCA9PT0gMikpIHsKICAgIHZhbCA9IG9ialtrZXldOwogIH0KICB2YXIgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUodmFsLCBmYWxzZSwgbW9jayk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiByZWFjdGl2ZUdldHRlcigpIHsKICAgICAgdmFyIHZhbHVlID0gZ2V0dGVyID8gZ2V0dGVyLmNhbGwob2JqKSA6IHZhbDsKICAgICAgaWYgKERlcC50YXJnZXQpIHsKICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgZGVwLmRlcGVuZCh7CiAgICAgICAgICAgIHRhcmdldDogb2JqLAogICAgICAgICAgICB0eXBlOiAiZ2V0IiAvKiBUcmFja09wVHlwZXMuR0VUICovLAogICAgICAgICAgICBrZXk6IGtleQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlcC5kZXBlbmQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNoaWxkT2IpIHsKICAgICAgICAgIGNoaWxkT2IuZGVwLmRlcGVuZCgpOwogICAgICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIGRlcGVuZEFycmF5KHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGlzUmVmKHZhbHVlKSAmJiAhc2hhbGxvdyA/IHZhbHVlLnZhbHVlIDogdmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiByZWFjdGl2ZVNldHRlcihuZXdWYWwpIHsKICAgICAgdmFyIHZhbHVlID0gZ2V0dGVyID8gZ2V0dGVyLmNhbGwob2JqKSA6IHZhbDsKICAgICAgaWYgKCFoYXNDaGFuZ2VkKHZhbHVlLCBuZXdWYWwpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGN1c3RvbVNldHRlcikgewogICAgICAgIGN1c3RvbVNldHRlcigpOwogICAgICB9CiAgICAgIGlmIChzZXR0ZXIpIHsKICAgICAgICBzZXR0ZXIuY2FsbChvYmosIG5ld1ZhbCk7CiAgICAgIH0gZWxzZSBpZiAoZ2V0dGVyKSB7CiAgICAgICAgLy8gIzc5ODE6IGZvciBhY2Nlc3NvciBwcm9wZXJ0aWVzIHdpdGhvdXQgc2V0dGVyCiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKCFzaGFsbG93ICYmIGlzUmVmKHZhbHVlKSAmJiAhaXNSZWYobmV3VmFsKSkgewogICAgICAgIHZhbHVlLnZhbHVlID0gbmV3VmFsOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWwgPSBuZXdWYWw7CiAgICAgIH0KICAgICAgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUobmV3VmFsLCBmYWxzZSwgbW9jayk7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgZGVwLm5vdGlmeSh7CiAgICAgICAgICB0eXBlOiAic2V0IiAvKiBUcmlnZ2VyT3BUeXBlcy5TRVQgKi8sCiAgICAgICAgICB0YXJnZXQ6IG9iaiwKICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgbmV3VmFsdWU6IG5ld1ZhbCwKICAgICAgICAgIG9sZFZhbHVlOiB2YWx1ZQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGRlcC5ub3RpZnkoKTsKICAgICAgfQogICAgfQogIH0pOwogIHJldHVybiBkZXA7Cn0KZnVuY3Rpb24gc2V0KHRhcmdldCwga2V5LCB2YWwpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAoaXNVbmRlZih0YXJnZXQpIHx8IGlzUHJpbWl0aXZlKHRhcmdldCkpKSB7CiAgICB3YXJuKCJDYW5ub3Qgc2V0IHJlYWN0aXZlIHByb3BlcnR5IG9uIHVuZGVmaW5lZCwgbnVsbCwgb3IgcHJpbWl0aXZlIHZhbHVlOiAiLmNvbmNhdCh0YXJnZXQpKTsKICB9CiAgaWYgKGlzUmVhZG9ubHkodGFyZ2V0KSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJTZXQgb3BlcmF0aW9uIG9uIGtleSBcIiIuY29uY2F0KGtleSwgIlwiIGZhaWxlZDogdGFyZ2V0IGlzIHJlYWRvbmx5LiIpKTsKICAgIHJldHVybjsKICB9CiAgdmFyIG9iID0gdGFyZ2V0Ll9fb2JfXzsKICBpZiAoaXNBcnJheSh0YXJnZXQpICYmIGlzVmFsaWRBcnJheUluZGV4KGtleSkpIHsKICAgIHRhcmdldC5sZW5ndGggPSBNYXRoLm1heCh0YXJnZXQubGVuZ3RoLCBrZXkpOwogICAgdGFyZ2V0LnNwbGljZShrZXksIDEsIHZhbCk7CiAgICAvLyB3aGVuIG1vY2tpbmcgZm9yIFNTUiwgYXJyYXkgbWV0aG9kcyBhcmUgbm90IGhpamFja2VkCiAgICBpZiAob2IgJiYgIW9iLnNoYWxsb3cgJiYgb2IubW9jaykgewogICAgICBvYnNlcnZlKHZhbCwgZmFsc2UsIHRydWUpOwogICAgfQogICAgcmV0dXJuIHZhbDsKICB9CiAgaWYgKGtleSBpbiB0YXJnZXQgJiYgIShrZXkgaW4gT2JqZWN0LnByb3RvdHlwZSkpIHsKICAgIHRhcmdldFtrZXldID0gdmFsOwogICAgcmV0dXJuIHZhbDsKICB9CiAgaWYgKHRhcmdldC5faXNWdWUgfHwgb2IgJiYgb2Iudm1Db3VudCkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdBdm9pZCBhZGRpbmcgcmVhY3RpdmUgcHJvcGVydGllcyB0byBhIFZ1ZSBpbnN0YW5jZSBvciBpdHMgcm9vdCAkZGF0YSAnICsgJ2F0IHJ1bnRpbWUgLSBkZWNsYXJlIGl0IHVwZnJvbnQgaW4gdGhlIGRhdGEgb3B0aW9uLicpOwogICAgcmV0dXJuIHZhbDsKICB9CiAgaWYgKCFvYikgewogICAgdGFyZ2V0W2tleV0gPSB2YWw7CiAgICByZXR1cm4gdmFsOwogIH0KICBkZWZpbmVSZWFjdGl2ZShvYi52YWx1ZSwga2V5LCB2YWwsIHVuZGVmaW5lZCwgb2Iuc2hhbGxvdywgb2IubW9jayk7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIG9iLmRlcC5ub3RpZnkoewogICAgICB0eXBlOiAiYWRkIiAvKiBUcmlnZ2VyT3BUeXBlcy5BREQgKi8sCiAgICAgIHRhcmdldDogdGFyZ2V0LAogICAgICBrZXk6IGtleSwKICAgICAgbmV3VmFsdWU6IHZhbCwKICAgICAgb2xkVmFsdWU6IHVuZGVmaW5lZAogICAgfSk7CiAgfSBlbHNlIHsKICAgIG9iLmRlcC5ub3RpZnkoKTsKICB9CiAgcmV0dXJuIHZhbDsKfQpmdW5jdGlvbiBkZWwodGFyZ2V0LCBrZXkpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAoaXNVbmRlZih0YXJnZXQpIHx8IGlzUHJpbWl0aXZlKHRhcmdldCkpKSB7CiAgICB3YXJuKCJDYW5ub3QgZGVsZXRlIHJlYWN0aXZlIHByb3BlcnR5IG9uIHVuZGVmaW5lZCwgbnVsbCwgb3IgcHJpbWl0aXZlIHZhbHVlOiAiLmNvbmNhdCh0YXJnZXQpKTsKICB9CiAgaWYgKGlzQXJyYXkodGFyZ2V0KSAmJiBpc1ZhbGlkQXJyYXlJbmRleChrZXkpKSB7CiAgICB0YXJnZXQuc3BsaWNlKGtleSwgMSk7CiAgICByZXR1cm47CiAgfQogIHZhciBvYiA9IHRhcmdldC5fX29iX187CiAgaWYgKHRhcmdldC5faXNWdWUgfHwgb2IgJiYgb2Iudm1Db3VudCkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdBdm9pZCBkZWxldGluZyBwcm9wZXJ0aWVzIG9uIGEgVnVlIGluc3RhbmNlIG9yIGl0cyByb290ICRkYXRhICcgKyAnLSBqdXN0IHNldCBpdCB0byBudWxsLicpOwogICAgcmV0dXJuOwogIH0KICBpZiAoaXNSZWFkb25seSh0YXJnZXQpKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkRlbGV0ZSBvcGVyYXRpb24gb24ga2V5IFwiIi5jb25jYXQoa2V5LCAiXCIgZmFpbGVkOiB0YXJnZXQgaXMgcmVhZG9ubHkuIikpOwogICAgcmV0dXJuOwogIH0KICBpZiAoIWhhc093bih0YXJnZXQsIGtleSkpIHsKICAgIHJldHVybjsKICB9CiAgZGVsZXRlIHRhcmdldFtrZXldOwogIGlmICghb2IpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIG9iLmRlcC5ub3RpZnkoewogICAgICB0eXBlOiAiZGVsZXRlIiAvKiBUcmlnZ2VyT3BUeXBlcy5ERUxFVEUgKi8sCiAgICAgIHRhcmdldDogdGFyZ2V0LAogICAgICBrZXk6IGtleQogICAgfSk7CiAgfSBlbHNlIHsKICAgIG9iLmRlcC5ub3RpZnkoKTsKICB9Cn0KLyoqCiAqIENvbGxlY3QgZGVwZW5kZW5jaWVzIG9uIGFycmF5IGVsZW1lbnRzIHdoZW4gdGhlIGFycmF5IGlzIHRvdWNoZWQsIHNpbmNlCiAqIHdlIGNhbm5vdCBpbnRlcmNlcHQgYXJyYXkgZWxlbWVudCBhY2Nlc3MgbGlrZSBwcm9wZXJ0eSBnZXR0ZXJzLgogKi8KZnVuY3Rpb24gZGVwZW5kQXJyYXkodmFsdWUpIHsKICBmb3IgKHZhciBlID0gdm9pZCAwLCBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgZSA9IHZhbHVlW2ldOwogICAgaWYgKGUgJiYgZS5fX29iX18pIHsKICAgICAgZS5fX29iX18uZGVwLmRlcGVuZCgpOwogICAgfQogICAgaWYgKGlzQXJyYXkoZSkpIHsKICAgICAgZGVwZW5kQXJyYXkoZSk7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHJlYWN0aXZlKHRhcmdldCkgewogIG1ha2VSZWFjdGl2ZSh0YXJnZXQsIGZhbHNlKTsKICByZXR1cm4gdGFyZ2V0Owp9Ci8qKgogKiBSZXR1cm4gYSBzaGFsbG93bHktcmVhY3RpdmUgY29weSBvZiB0aGUgb3JpZ2luYWwgb2JqZWN0LCB3aGVyZSBvbmx5IHRoZSByb290CiAqIGxldmVsIHByb3BlcnRpZXMgYXJlIHJlYWN0aXZlLiBJdCBhbHNvIGRvZXMgbm90IGF1dG8tdW53cmFwIHJlZnMgKGV2ZW4gYXQgdGhlCiAqIHJvb3QgbGV2ZWwpLgogKi8KZnVuY3Rpb24gc2hhbGxvd1JlYWN0aXZlKHRhcmdldCkgewogIG1ha2VSZWFjdGl2ZSh0YXJnZXQsIHRydWUpOwogIGRlZih0YXJnZXQsICJfX3ZfaXNTaGFsbG93IiAvKiBSZWFjdGl2ZUZsYWdzLklTX1NIQUxMT1cgKi8sIHRydWUpOwogIHJldHVybiB0YXJnZXQ7Cn0KZnVuY3Rpb24gbWFrZVJlYWN0aXZlKHRhcmdldCwgc2hhbGxvdykgewogIC8vIGlmIHRyeWluZyB0byBvYnNlcnZlIGEgcmVhZG9ubHkgcHJveHksIHJldHVybiB0aGUgcmVhZG9ubHkgdmVyc2lvbi4KICBpZiAoIWlzUmVhZG9ubHkodGFyZ2V0KSkgewogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKGlzQXJyYXkodGFyZ2V0KSkgewogICAgICAgIHdhcm4oIkF2b2lkIHVzaW5nIEFycmF5IGFzIHJvb3QgdmFsdWUgZm9yICIuY29uY2F0KHNoYWxsb3cgPyAic2hhbGxvd1JlYWN0aXZlKCkiIDogInJlYWN0aXZlKCkiLCAiIGFzIGl0IGNhbm5vdCBiZSB0cmFja2VkIGluIHdhdGNoKCkgb3Igd2F0Y2hFZmZlY3QoKS4gVXNlICIpLmNvbmNhdChzaGFsbG93ID8gInNoYWxsb3dSZWYoKSIgOiAicmVmKCkiLCAiIGluc3RlYWQuIFRoaXMgaXMgYSBWdWUtMi1vbmx5IGxpbWl0YXRpb24uIikpOwogICAgICB9CiAgICAgIHZhciBleGlzdGluZ09iID0gdGFyZ2V0ICYmIHRhcmdldC5fX29iX187CiAgICAgIGlmIChleGlzdGluZ09iICYmIGV4aXN0aW5nT2Iuc2hhbGxvdyAhPT0gc2hhbGxvdykgewogICAgICAgIHdhcm4oIlRhcmdldCBpcyBhbHJlYWR5IGEgIi5jb25jYXQoZXhpc3RpbmdPYi5zaGFsbG93ID8gIiIgOiAibm9uLSIsICJzaGFsbG93IHJlYWN0aXZlIG9iamVjdCwgYW5kIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gIikuY29uY2F0KHNoYWxsb3cgPyAiIiA6ICJub24tIiwgInNoYWxsb3cuIikpOwogICAgICB9CiAgICB9CiAgICB2YXIgb2IgPSBvYnNlcnZlKHRhcmdldCwgc2hhbGxvdywgaXNTZXJ2ZXJSZW5kZXJpbmcoKSAvKiBzc3IgbW9jayByZWFjdGl2aXR5ICovKTsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFvYikgewogICAgICBpZiAodGFyZ2V0ID09IG51bGwgfHwgaXNQcmltaXRpdmUodGFyZ2V0KSkgewogICAgICAgIHdhcm4oInZhbHVlIGNhbm5vdCBiZSBtYWRlIHJlYWN0aXZlOiAiLmNvbmNhdChTdHJpbmcodGFyZ2V0KSkpOwogICAgICB9CiAgICAgIGlmIChpc0NvbGxlY3Rpb25UeXBlKHRhcmdldCkpIHsKICAgICAgICB3YXJuKCJWdWUgMiBkb2VzIG5vdCBzdXBwb3J0IHJlYWN0aXZlIGNvbGxlY3Rpb24gdHlwZXMgc3VjaCBhcyBNYXAgb3IgU2V0LiIpOwogICAgICB9CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGlzUmVhY3RpdmUodmFsdWUpIHsKICBpZiAoaXNSZWFkb25seSh2YWx1ZSkpIHsKICAgIHJldHVybiBpc1JlYWN0aXZlKHZhbHVlWyJfX3ZfcmF3IiAvKiBSZWFjdGl2ZUZsYWdzLlJBVyAqL10pOwogIH0KCiAgcmV0dXJuICEhKHZhbHVlICYmIHZhbHVlLl9fb2JfXyk7Cn0KZnVuY3Rpb24gaXNTaGFsbG93KHZhbHVlKSB7CiAgcmV0dXJuICEhKHZhbHVlICYmIHZhbHVlLl9fdl9pc1NoYWxsb3cpOwp9CmZ1bmN0aW9uIGlzUmVhZG9ubHkodmFsdWUpIHsKICByZXR1cm4gISEodmFsdWUgJiYgdmFsdWUuX192X2lzUmVhZG9ubHkpOwp9CmZ1bmN0aW9uIGlzUHJveHkodmFsdWUpIHsKICByZXR1cm4gaXNSZWFjdGl2ZSh2YWx1ZSkgfHwgaXNSZWFkb25seSh2YWx1ZSk7Cn0KZnVuY3Rpb24gdG9SYXcob2JzZXJ2ZWQpIHsKICB2YXIgcmF3ID0gb2JzZXJ2ZWQgJiYgb2JzZXJ2ZWRbIl9fdl9yYXciIC8qIFJlYWN0aXZlRmxhZ3MuUkFXICovXTsKICByZXR1cm4gcmF3ID8gdG9SYXcocmF3KSA6IG9ic2VydmVkOwp9CmZ1bmN0aW9uIG1hcmtSYXcodmFsdWUpIHsKICAvLyBub24tZXh0ZW5zaWJsZSBvYmplY3RzIHdvbid0IGJlIG9ic2VydmVkIGFueXdheQogIGlmIChPYmplY3QuaXNFeHRlbnNpYmxlKHZhbHVlKSkgewogICAgZGVmKHZhbHVlLCAiX192X3NraXAiIC8qIFJlYWN0aXZlRmxhZ3MuU0tJUCAqLywgdHJ1ZSk7CiAgfQogIHJldHVybiB2YWx1ZTsKfQovKioKICogQGludGVybmFsCiAqLwpmdW5jdGlvbiBpc0NvbGxlY3Rpb25UeXBlKHZhbHVlKSB7CiAgdmFyIHR5cGUgPSB0b1Jhd1R5cGUodmFsdWUpOwogIHJldHVybiB0eXBlID09PSAnTWFwJyB8fCB0eXBlID09PSAnV2Vha01hcCcgfHwgdHlwZSA9PT0gJ1NldCcgfHwgdHlwZSA9PT0gJ1dlYWtTZXQnOwp9CgovKioKICogQGludGVybmFsCiAqLwp2YXIgUmVmRmxhZyA9ICJfX3ZfaXNSZWYiOwpmdW5jdGlvbiBpc1JlZihyKSB7CiAgcmV0dXJuICEhKHIgJiYgci5fX3ZfaXNSZWYgPT09IHRydWUpOwp9CmZ1bmN0aW9uIHJlZiQxKHZhbHVlKSB7CiAgcmV0dXJuIGNyZWF0ZVJlZih2YWx1ZSwgZmFsc2UpOwp9CmZ1bmN0aW9uIHNoYWxsb3dSZWYodmFsdWUpIHsKICByZXR1cm4gY3JlYXRlUmVmKHZhbHVlLCB0cnVlKTsKfQpmdW5jdGlvbiBjcmVhdGVSZWYocmF3VmFsdWUsIHNoYWxsb3cpIHsKICBpZiAoaXNSZWYocmF3VmFsdWUpKSB7CiAgICByZXR1cm4gcmF3VmFsdWU7CiAgfQogIHZhciByZWYgPSB7fTsKICBkZWYocmVmLCBSZWZGbGFnLCB0cnVlKTsKICBkZWYocmVmLCAiX192X2lzU2hhbGxvdyIgLyogUmVhY3RpdmVGbGFncy5JU19TSEFMTE9XICovLCBzaGFsbG93KTsKICBkZWYocmVmLCAnZGVwJywgZGVmaW5lUmVhY3RpdmUocmVmLCAndmFsdWUnLCByYXdWYWx1ZSwgbnVsbCwgc2hhbGxvdywgaXNTZXJ2ZXJSZW5kZXJpbmcoKSkpOwogIHJldHVybiByZWY7Cn0KZnVuY3Rpb24gdHJpZ2dlclJlZihyZWYpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhcmVmLmRlcCkgewogICAgd2FybigicmVjZWl2ZWQgb2JqZWN0IGlzIG5vdCBhIHRyaWdnZXJhYmxlIHJlZi4iKTsKICB9CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHJlZi5kZXAgJiYgcmVmLmRlcC5ub3RpZnkoewogICAgICB0eXBlOiAic2V0IiAvKiBUcmlnZ2VyT3BUeXBlcy5TRVQgKi8sCiAgICAgIHRhcmdldDogcmVmLAogICAgICBrZXk6ICd2YWx1ZScKICAgIH0pOwogIH0gZWxzZSB7CiAgICByZWYuZGVwICYmIHJlZi5kZXAubm90aWZ5KCk7CiAgfQp9CmZ1bmN0aW9uIHVucmVmKHJlZikgewogIHJldHVybiBpc1JlZihyZWYpID8gcmVmLnZhbHVlIDogcmVmOwp9CmZ1bmN0aW9uIHByb3h5UmVmcyhvYmplY3RXaXRoUmVmcykgewogIGlmIChpc1JlYWN0aXZlKG9iamVjdFdpdGhSZWZzKSkgewogICAgcmV0dXJuIG9iamVjdFdpdGhSZWZzOwogIH0KICB2YXIgcHJveHkgPSB7fTsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iamVjdFdpdGhSZWZzKTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIHByb3h5V2l0aFJlZlVud3JhcChwcm94eSwgb2JqZWN0V2l0aFJlZnMsIGtleXNbaV0pOwogIH0KICByZXR1cm4gcHJveHk7Cn0KZnVuY3Rpb24gcHJveHlXaXRoUmVmVW53cmFwKHRhcmdldCwgc291cmNlLCBrZXkpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIHZhbCA9IHNvdXJjZVtrZXldOwogICAgICBpZiAoaXNSZWYodmFsKSkgewogICAgICAgIHJldHVybiB2YWwudmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG9iID0gdmFsICYmIHZhbC5fX29iX187CiAgICAgICAgaWYgKG9iKSBvYi5kZXAuZGVwZW5kKCk7CiAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgfQogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbHVlKSB7CiAgICAgIHZhciBvbGRWYWx1ZSA9IHNvdXJjZVtrZXldOwogICAgICBpZiAoaXNSZWYob2xkVmFsdWUpICYmICFpc1JlZih2YWx1ZSkpIHsKICAgICAgICBvbGRWYWx1ZS52YWx1ZSA9IHZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHNvdXJjZVtrZXldID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9KTsKfQpmdW5jdGlvbiBjdXN0b21SZWYoZmFjdG9yeSkgewogIHZhciBkZXAgPSBuZXcgRGVwKCk7CiAgdmFyIF9hID0gZmFjdG9yeShmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgZGVwLmRlcGVuZCh7CiAgICAgICAgICB0YXJnZXQ6IHJlZiwKICAgICAgICAgIHR5cGU6ICJnZXQiIC8qIFRyYWNrT3BUeXBlcy5HRVQgKi8sCiAgICAgICAgICBrZXk6ICd2YWx1ZScKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZXAuZGVwZW5kKCk7CiAgICAgIH0KICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBkZXAubm90aWZ5KHsKICAgICAgICAgIHRhcmdldDogcmVmLAogICAgICAgICAgdHlwZTogInNldCIgLyogVHJpZ2dlck9wVHlwZXMuU0VUICovLAogICAgICAgICAga2V5OiAndmFsdWUnCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVwLm5vdGlmeSgpOwogICAgICB9CiAgICB9KSwKICAgIGdldCA9IF9hLmdldCwKICAgIHNldCA9IF9hLnNldDsKICB2YXIgcmVmID0gewogICAgZ2V0IHZhbHVlKCkgewogICAgICByZXR1cm4gZ2V0KCk7CiAgICB9LAogICAgc2V0IHZhbHVlKG5ld1ZhbCkgewogICAgICBzZXQobmV3VmFsKTsKICAgIH0KICB9OwogIGRlZihyZWYsIFJlZkZsYWcsIHRydWUpOwogIHJldHVybiByZWY7Cn0KZnVuY3Rpb24gdG9SZWZzKG9iamVjdCkgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFpc1JlYWN0aXZlKG9iamVjdCkpIHsKICAgIHdhcm4oInRvUmVmcygpIGV4cGVjdHMgYSByZWFjdGl2ZSBvYmplY3QgYnV0IHJlY2VpdmVkIGEgcGxhaW4gb25lLiIpOwogIH0KICB2YXIgcmV0ID0gaXNBcnJheShvYmplY3QpID8gbmV3IEFycmF5KG9iamVjdC5sZW5ndGgpIDoge307CiAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgcmV0W2tleV0gPSB0b1JlZihvYmplY3QsIGtleSk7CiAgfQogIHJldHVybiByZXQ7Cn0KZnVuY3Rpb24gdG9SZWYob2JqZWN0LCBrZXksIGRlZmF1bHRWYWx1ZSkgewogIHZhciB2YWwgPSBvYmplY3Rba2V5XTsKICBpZiAoaXNSZWYodmFsKSkgewogICAgcmV0dXJuIHZhbDsKICB9CiAgdmFyIHJlZiA9IHsKICAgIGdldCB2YWx1ZSgpIHsKICAgICAgdmFyIHZhbCA9IG9iamVjdFtrZXldOwogICAgICByZXR1cm4gdmFsID09PSB1bmRlZmluZWQgPyBkZWZhdWx0VmFsdWUgOiB2YWw7CiAgICB9LAogICAgc2V0IHZhbHVlKG5ld1ZhbCkgewogICAgICBvYmplY3Rba2V5XSA9IG5ld1ZhbDsKICAgIH0KICB9OwogIGRlZihyZWYsIFJlZkZsYWcsIHRydWUpOwogIHJldHVybiByZWY7Cn0KdmFyIHJhd1RvUmVhZG9ubHlGbGFnID0gIl9fdl9yYXdUb1JlYWRvbmx5IjsKdmFyIHJhd1RvU2hhbGxvd1JlYWRvbmx5RmxhZyA9ICJfX3ZfcmF3VG9TaGFsbG93UmVhZG9ubHkiOwpmdW5jdGlvbiByZWFkb25seSh0YXJnZXQpIHsKICByZXR1cm4gY3JlYXRlUmVhZG9ubHkodGFyZ2V0LCBmYWxzZSk7Cn0KZnVuY3Rpb24gY3JlYXRlUmVhZG9ubHkodGFyZ2V0LCBzaGFsbG93KSB7CiAgaWYgKCFpc1BsYWluT2JqZWN0KHRhcmdldCkpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmIChpc0FycmF5KHRhcmdldCkpIHsKICAgICAgICB3YXJuKCJWdWUgMiBkb2VzIG5vdCBzdXBwb3J0IHJlYWRvbmx5IGFycmF5cy4iKTsKICAgICAgfSBlbHNlIGlmIChpc0NvbGxlY3Rpb25UeXBlKHRhcmdldCkpIHsKICAgICAgICB3YXJuKCJWdWUgMiBkb2VzIG5vdCBzdXBwb3J0IHJlYWRvbmx5IGNvbGxlY3Rpb24gdHlwZXMgc3VjaCBhcyBNYXAgb3IgU2V0LiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHdhcm4oInZhbHVlIGNhbm5vdCBiZSBtYWRlIHJlYWRvbmx5OiAiLmNvbmNhdCh0eXBlb2YgdGFyZ2V0KSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFPYmplY3QuaXNFeHRlbnNpYmxlKHRhcmdldCkpIHsKICAgIHdhcm4oIlZ1ZSAyIGRvZXMgbm90IHN1cHBvcnQgY3JlYXRpbmcgcmVhZG9ubHkgcHJveHkgZm9yIG5vbi1leHRlbnNpYmxlIG9iamVjdC4iKTsKICB9CiAgLy8gYWxyZWFkeSBhIHJlYWRvbmx5IG9iamVjdAogIGlmIChpc1JlYWRvbmx5KHRhcmdldCkpIHsKICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIC8vIGFscmVhZHkgaGFzIGEgcmVhZG9ubHkgcHJveHkKICB2YXIgZXhpc3RpbmdGbGFnID0gc2hhbGxvdyA/IHJhd1RvU2hhbGxvd1JlYWRvbmx5RmxhZyA6IHJhd1RvUmVhZG9ubHlGbGFnOwogIHZhciBleGlzdGluZ1Byb3h5ID0gdGFyZ2V0W2V4aXN0aW5nRmxhZ107CiAgaWYgKGV4aXN0aW5nUHJveHkpIHsKICAgIHJldHVybiBleGlzdGluZ1Byb3h5OwogIH0KICB2YXIgcHJveHkgPSBPYmplY3QuY3JlYXRlKE9iamVjdC5nZXRQcm90b3R5cGVPZih0YXJnZXQpKTsKICBkZWYodGFyZ2V0LCBleGlzdGluZ0ZsYWcsIHByb3h5KTsKICBkZWYocHJveHksICJfX3ZfaXNSZWFkb25seSIgLyogUmVhY3RpdmVGbGFncy5JU19SRUFET05MWSAqLywgdHJ1ZSk7CiAgZGVmKHByb3h5LCAiX192X3JhdyIgLyogUmVhY3RpdmVGbGFncy5SQVcgKi8sIHRhcmdldCk7CiAgaWYgKGlzUmVmKHRhcmdldCkpIHsKICAgIGRlZihwcm94eSwgUmVmRmxhZywgdHJ1ZSk7CiAgfQogIGlmIChzaGFsbG93IHx8IGlzU2hhbGxvdyh0YXJnZXQpKSB7CiAgICBkZWYocHJveHksICJfX3ZfaXNTaGFsbG93IiAvKiBSZWFjdGl2ZUZsYWdzLklTX1NIQUxMT1cgKi8sIHRydWUpOwogIH0KICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRhcmdldCk7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBkZWZpbmVSZWFkb25seVByb3BlcnR5KHByb3h5LCB0YXJnZXQsIGtleXNbaV0sIHNoYWxsb3cpOwogIH0KICByZXR1cm4gcHJveHk7Cn0KZnVuY3Rpb24gZGVmaW5lUmVhZG9ubHlQcm9wZXJ0eShwcm94eSwgdGFyZ2V0LCBrZXksIHNoYWxsb3cpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJveHksIGtleSwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgdmFsID0gdGFyZ2V0W2tleV07CiAgICAgIHJldHVybiBzaGFsbG93IHx8ICFpc1BsYWluT2JqZWN0KHZhbCkgPyB2YWwgOiByZWFkb25seSh2YWwpOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KCkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIlNldCBvcGVyYXRpb24gb24ga2V5IFwiIi5jb25jYXQoa2V5LCAiXCIgZmFpbGVkOiB0YXJnZXQgaXMgcmVhZG9ubHkuIikpOwogICAgfQogIH0pOwp9Ci8qKgogKiBSZXR1cm5zIGEgcmVhY3RpdmUtY29weSBvZiB0aGUgb3JpZ2luYWwgb2JqZWN0LCB3aGVyZSBvbmx5IHRoZSByb290IGxldmVsCiAqIHByb3BlcnRpZXMgYXJlIHJlYWRvbmx5LCBhbmQgZG9lcyBOT1QgdW53cmFwIHJlZnMgbm9yIHJlY3Vyc2l2ZWx5IGNvbnZlcnQKICogcmV0dXJuZWQgcHJvcGVydGllcy4KICogVGhpcyBpcyB1c2VkIGZvciBjcmVhdGluZyB0aGUgcHJvcHMgcHJveHkgb2JqZWN0IGZvciBzdGF0ZWZ1bCBjb21wb25lbnRzLgogKi8KZnVuY3Rpb24gc2hhbGxvd1JlYWRvbmx5KHRhcmdldCkgewogIHJldHVybiBjcmVhdGVSZWFkb25seSh0YXJnZXQsIHRydWUpOwp9CmZ1bmN0aW9uIGNvbXB1dGVkKGdldHRlck9yT3B0aW9ucywgZGVidWdPcHRpb25zKSB7CiAgdmFyIGdldHRlcjsKICB2YXIgc2V0dGVyOwogIHZhciBvbmx5R2V0dGVyID0gaXNGdW5jdGlvbihnZXR0ZXJPck9wdGlvbnMpOwogIGlmIChvbmx5R2V0dGVyKSB7CiAgICBnZXR0ZXIgPSBnZXR0ZXJPck9wdGlvbnM7CiAgICBzZXR0ZXIgPSBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCdXcml0ZSBvcGVyYXRpb24gZmFpbGVkOiBjb21wdXRlZCB2YWx1ZSBpcyByZWFkb25seScpOwogICAgfSA6IG5vb3A7CiAgfSBlbHNlIHsKICAgIGdldHRlciA9IGdldHRlck9yT3B0aW9ucy5nZXQ7CiAgICBzZXR0ZXIgPSBnZXR0ZXJPck9wdGlvbnMuc2V0OwogIH0KICB2YXIgd2F0Y2hlciA9IGlzU2VydmVyUmVuZGVyaW5nKCkgPyBudWxsIDogbmV3IFdhdGNoZXIoY3VycmVudEluc3RhbmNlLCBnZXR0ZXIsIG5vb3AsIHsKICAgIGxhenk6IHRydWUKICB9KTsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXRjaGVyICYmIGRlYnVnT3B0aW9ucykgewogICAgd2F0Y2hlci5vblRyYWNrID0gZGVidWdPcHRpb25zLm9uVHJhY2s7CiAgICB3YXRjaGVyLm9uVHJpZ2dlciA9IGRlYnVnT3B0aW9ucy5vblRyaWdnZXI7CiAgfQogIHZhciByZWYgPSB7CiAgICAvLyBzb21lIGxpYnMgcmVseSBvbiB0aGUgcHJlc2VuY2UgZWZmZWN0IGZvciBjaGVja2luZyBjb21wdXRlZCByZWZzCiAgICAvLyBmcm9tIG5vcm1hbCByZWZzLCBidXQgdGhlIGltcGxlbWVudGF0aW9uIGRvZXNuJ3QgbWF0dGVyCiAgICBlZmZlY3Q6IHdhdGNoZXIsCiAgICBnZXQgdmFsdWUoKSB7CiAgICAgIGlmICh3YXRjaGVyKSB7CiAgICAgICAgaWYgKHdhdGNoZXIuZGlydHkpIHsKICAgICAgICAgIHdhdGNoZXIuZXZhbHVhdGUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKERlcC50YXJnZXQpIHsKICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIERlcC50YXJnZXQub25UcmFjaykgewogICAgICAgICAgICBEZXAudGFyZ2V0Lm9uVHJhY2soewogICAgICAgICAgICAgIGVmZmVjdDogRGVwLnRhcmdldCwKICAgICAgICAgICAgICB0YXJnZXQ6IHJlZiwKICAgICAgICAgICAgICB0eXBlOiAiZ2V0IiAvKiBUcmFja09wVHlwZXMuR0VUICovLAogICAgICAgICAgICAgIGtleTogJ3ZhbHVlJwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHdhdGNoZXIuZGVwZW5kKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB3YXRjaGVyLnZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBnZXR0ZXIoKTsKICAgICAgfQogICAgfSwKICAgIHNldCB2YWx1ZShuZXdWYWwpIHsKICAgICAgc2V0dGVyKG5ld1ZhbCk7CiAgICB9CiAgfTsKICBkZWYocmVmLCBSZWZGbGFnLCB0cnVlKTsKICBkZWYocmVmLCAiX192X2lzUmVhZG9ubHkiIC8qIFJlYWN0aXZlRmxhZ3MuSVNfUkVBRE9OTFkgKi8sIG9ubHlHZXR0ZXIpOwogIHJldHVybiByZWY7Cn0KdmFyIFdBVENIRVIgPSAid2F0Y2hlciI7CnZhciBXQVRDSEVSX0NCID0gIiIuY29uY2F0KFdBVENIRVIsICIgY2FsbGJhY2siKTsKdmFyIFdBVENIRVJfR0VUVEVSID0gIiIuY29uY2F0KFdBVENIRVIsICIgZ2V0dGVyIik7CnZhciBXQVRDSEVSX0NMRUFOVVAgPSAiIi5jb25jYXQoV0FUQ0hFUiwgIiBjbGVhbnVwIik7Ci8vIFNpbXBsZSBlZmZlY3QuCmZ1bmN0aW9uIHdhdGNoRWZmZWN0KGVmZmVjdCwgb3B0aW9ucykgewogIHJldHVybiBkb1dhdGNoKGVmZmVjdCwgbnVsbCwgb3B0aW9ucyk7Cn0KZnVuY3Rpb24gd2F0Y2hQb3N0RWZmZWN0KGVmZmVjdCwgb3B0aW9ucykgewogIHJldHVybiBkb1dhdGNoKGVmZmVjdCwgbnVsbCwgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IF9hc3NpZ24oX2Fzc2lnbih7fSwgb3B0aW9ucyksIHsKICAgIGZsdXNoOiAncG9zdCcKICB9KSA6IHsKICAgIGZsdXNoOiAncG9zdCcKICB9KTsKfQpmdW5jdGlvbiB3YXRjaFN5bmNFZmZlY3QoZWZmZWN0LCBvcHRpb25zKSB7CiAgcmV0dXJuIGRvV2F0Y2goZWZmZWN0LCBudWxsLCBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gX2Fzc2lnbihfYXNzaWduKHt9LCBvcHRpb25zKSwgewogICAgZmx1c2g6ICdzeW5jJwogIH0pIDogewogICAgZmx1c2g6ICdzeW5jJwogIH0pOwp9Ci8vIGluaXRpYWwgdmFsdWUgZm9yIHdhdGNoZXJzIHRvIHRyaWdnZXIgb24gdW5kZWZpbmVkIGluaXRpYWwgdmFsdWVzCnZhciBJTklUSUFMX1dBVENIRVJfVkFMVUUgPSB7fTsKLy8gaW1wbGVtZW50YXRpb24KZnVuY3Rpb24gd2F0Y2goc291cmNlLCBjYiwgb3B0aW9ucykgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHR5cGVvZiBjYiAhPT0gJ2Z1bmN0aW9uJykgewogICAgd2FybigiYHdhdGNoKGZuLCBvcHRpb25zPylgIHNpZ25hdHVyZSBoYXMgYmVlbiBtb3ZlZCB0byBhIHNlcGFyYXRlIEFQSS4gIiArICJVc2UgYHdhdGNoRWZmZWN0KGZuLCBvcHRpb25zPylgIGluc3RlYWQuIGB3YXRjaGAgbm93IG9ubHkgIiArICJzdXBwb3J0cyBgd2F0Y2goc291cmNlLCBjYiwgb3B0aW9ucz8pIHNpZ25hdHVyZS4iKTsKICB9CiAgcmV0dXJuIGRvV2F0Y2goc291cmNlLCBjYiwgb3B0aW9ucyk7Cn0KZnVuY3Rpb24gZG9XYXRjaChzb3VyY2UsIGNiLCBfYSkgewogIHZhciBfYiA9IF9hID09PSB2b2lkIDAgPyBlbXB0eU9iamVjdCA6IF9hLAogICAgaW1tZWRpYXRlID0gX2IuaW1tZWRpYXRlLAogICAgZGVlcCA9IF9iLmRlZXAsCiAgICBfYyA9IF9iLmZsdXNoLAogICAgZmx1c2ggPSBfYyA9PT0gdm9pZCAwID8gJ3ByZScgOiBfYywKICAgIG9uVHJhY2sgPSBfYi5vblRyYWNrLAogICAgb25UcmlnZ2VyID0gX2Iub25UcmlnZ2VyOwogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFjYikgewogICAgaWYgKGltbWVkaWF0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHdhcm4oIndhdGNoKCkgXCJpbW1lZGlhdGVcIiBvcHRpb24gaXMgb25seSByZXNwZWN0ZWQgd2hlbiB1c2luZyB0aGUgIiArICJ3YXRjaChzb3VyY2UsIGNhbGxiYWNrLCBvcHRpb25zPykgc2lnbmF0dXJlLiIpOwogICAgfQogICAgaWYgKGRlZXAgIT09IHVuZGVmaW5lZCkgewogICAgICB3YXJuKCJ3YXRjaCgpIFwiZGVlcFwiIG9wdGlvbiBpcyBvbmx5IHJlc3BlY3RlZCB3aGVuIHVzaW5nIHRoZSAiICsgIndhdGNoKHNvdXJjZSwgY2FsbGJhY2ssIG9wdGlvbnM/KSBzaWduYXR1cmUuIik7CiAgICB9CiAgfQogIHZhciB3YXJuSW52YWxpZFNvdXJjZSA9IGZ1bmN0aW9uIHdhcm5JbnZhbGlkU291cmNlKHMpIHsKICAgIHdhcm4oIkludmFsaWQgd2F0Y2ggc291cmNlOiAiLmNvbmNhdChzLCAiLiBBIHdhdGNoIHNvdXJjZSBjYW4gb25seSBiZSBhIGdldHRlci9lZmZlY3QgIikgKyAiZnVuY3Rpb24sIGEgcmVmLCBhIHJlYWN0aXZlIG9iamVjdCwgb3IgYW4gYXJyYXkgb2YgdGhlc2UgdHlwZXMuIik7CiAgfTsKICB2YXIgaW5zdGFuY2UgPSBjdXJyZW50SW5zdGFuY2U7CiAgdmFyIGNhbGwgPSBmdW5jdGlvbiBjYWxsKGZuLCB0eXBlLCBhcmdzKSB7CiAgICBpZiAoYXJncyA9PT0gdm9pZCAwKSB7CiAgICAgIGFyZ3MgPSBudWxsOwogICAgfQogICAgcmV0dXJuIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGZuLCBudWxsLCBhcmdzLCBpbnN0YW5jZSwgdHlwZSk7CiAgfTsKICB2YXIgZ2V0dGVyOwogIHZhciBmb3JjZVRyaWdnZXIgPSBmYWxzZTsKICB2YXIgaXNNdWx0aVNvdXJjZSA9IGZhbHNlOwogIGlmIChpc1JlZihzb3VyY2UpKSB7CiAgICBnZXR0ZXIgPSBmdW5jdGlvbiBnZXR0ZXIoKSB7CiAgICAgIHJldHVybiBzb3VyY2UudmFsdWU7CiAgICB9OwogICAgZm9yY2VUcmlnZ2VyID0gaXNTaGFsbG93KHNvdXJjZSk7CiAgfSBlbHNlIGlmIChpc1JlYWN0aXZlKHNvdXJjZSkpIHsKICAgIGdldHRlciA9IGZ1bmN0aW9uIGdldHRlcigpIHsKICAgICAgc291cmNlLl9fb2JfXy5kZXAuZGVwZW5kKCk7CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9OwogICAgZGVlcCA9IHRydWU7CiAgfSBlbHNlIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgIGlzTXVsdGlTb3VyY2UgPSB0cnVlOwogICAgZm9yY2VUcmlnZ2VyID0gc291cmNlLnNvbWUoZnVuY3Rpb24gKHMpIHsKICAgICAgcmV0dXJuIGlzUmVhY3RpdmUocykgfHwgaXNTaGFsbG93KHMpOwogICAgfSk7CiAgICBnZXR0ZXIgPSBmdW5jdGlvbiBnZXR0ZXIoKSB7CiAgICAgIHJldHVybiBzb3VyY2UubWFwKGZ1bmN0aW9uIChzKSB7CiAgICAgICAgaWYgKGlzUmVmKHMpKSB7CiAgICAgICAgICByZXR1cm4gcy52YWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKGlzUmVhY3RpdmUocykpIHsKICAgICAgICAgIHJldHVybiB0cmF2ZXJzZShzKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24ocykpIHsKICAgICAgICAgIHJldHVybiBjYWxsKHMsIFdBVENIRVJfR0VUVEVSKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuSW52YWxpZFNvdXJjZShzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oc291cmNlKSkgewogICAgaWYgKGNiKSB7CiAgICAgIC8vIGdldHRlciB3aXRoIGNiCiAgICAgIGdldHRlciA9IGZ1bmN0aW9uIGdldHRlcigpIHsKICAgICAgICByZXR1cm4gY2FsbChzb3VyY2UsIFdBVENIRVJfR0VUVEVSKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIG5vIGNiIC0+IHNpbXBsZSBlZmZlY3QKICAgICAgZ2V0dGVyID0gZnVuY3Rpb24gZ2V0dGVyKCkgewogICAgICAgIGlmIChpbnN0YW5jZSAmJiBpbnN0YW5jZS5faXNEZXN0cm95ZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKGNsZWFudXApIHsKICAgICAgICAgIGNsZWFudXAoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhbGwoc291cmNlLCBXQVRDSEVSLCBbb25DbGVhbnVwXSk7CiAgICAgIH07CiAgICB9CiAgfSBlbHNlIHsKICAgIGdldHRlciA9IG5vb3A7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm5JbnZhbGlkU291cmNlKHNvdXJjZSk7CiAgfQogIGlmIChjYiAmJiBkZWVwKSB7CiAgICB2YXIgYmFzZUdldHRlcl8xID0gZ2V0dGVyOwogICAgZ2V0dGVyID0gZnVuY3Rpb24gZ2V0dGVyKCkgewogICAgICByZXR1cm4gdHJhdmVyc2UoYmFzZUdldHRlcl8xKCkpOwogICAgfTsKICB9CiAgdmFyIGNsZWFudXA7CiAgdmFyIG9uQ2xlYW51cCA9IGZ1bmN0aW9uIG9uQ2xlYW51cChmbikgewogICAgY2xlYW51cCA9IHdhdGNoZXIub25TdG9wID0gZnVuY3Rpb24gKCkgewogICAgICBjYWxsKGZuLCBXQVRDSEVSX0NMRUFOVVApOwogICAgfTsKICB9OwogIC8vIGluIFNTUiB0aGVyZSBpcyBubyBuZWVkIHRvIHNldHVwIGFuIGFjdHVhbCBlZmZlY3QsIGFuZCBpdCBzaG91bGQgYmUgbm9vcAogIC8vIHVubGVzcyBpdCdzIGVhZ2VyCiAgaWYgKGlzU2VydmVyUmVuZGVyaW5nKCkpIHsKICAgIC8vIHdlIHdpbGwgYWxzbyBub3QgY2FsbCB0aGUgaW52YWxpZGF0ZSBjYWxsYmFjayAoKyBydW5uZXIgaXMgbm90IHNldCB1cCkKICAgIG9uQ2xlYW51cCA9IG5vb3A7CiAgICBpZiAoIWNiKSB7CiAgICAgIGdldHRlcigpOwogICAgfSBlbHNlIGlmIChpbW1lZGlhdGUpIHsKICAgICAgY2FsbChjYiwgV0FUQ0hFUl9DQiwgW2dldHRlcigpLCBpc011bHRpU291cmNlID8gW10gOiB1bmRlZmluZWQsIG9uQ2xlYW51cF0pOwogICAgfQogICAgcmV0dXJuIG5vb3A7CiAgfQogIHZhciB3YXRjaGVyID0gbmV3IFdhdGNoZXIoY3VycmVudEluc3RhbmNlLCBnZXR0ZXIsIG5vb3AsIHsKICAgIGxhenk6IHRydWUKICB9KTsKICB3YXRjaGVyLm5vUmVjdXJzZSA9ICFjYjsKICB2YXIgb2xkVmFsdWUgPSBpc011bHRpU291cmNlID8gW10gOiBJTklUSUFMX1dBVENIRVJfVkFMVUU7CiAgLy8gb3ZlcndyaXRlIGRlZmF1bHQgcnVuCiAgd2F0Y2hlci5ydW4gPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIXdhdGNoZXIuYWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChjYikgewogICAgICAvLyB3YXRjaChzb3VyY2UsIGNiKQogICAgICB2YXIgbmV3VmFsdWUgPSB3YXRjaGVyLmdldCgpOwogICAgICBpZiAoZGVlcCB8fCBmb3JjZVRyaWdnZXIgfHwgKGlzTXVsdGlTb3VyY2UgPyBuZXdWYWx1ZS5zb21lKGZ1bmN0aW9uICh2LCBpKSB7CiAgICAgICAgcmV0dXJuIGhhc0NoYW5nZWQodiwgb2xkVmFsdWVbaV0pOwogICAgICB9KSA6IGhhc0NoYW5nZWQobmV3VmFsdWUsIG9sZFZhbHVlKSkpIHsKICAgICAgICAvLyBjbGVhbnVwIGJlZm9yZSBydW5uaW5nIGNiIGFnYWluCiAgICAgICAgaWYgKGNsZWFudXApIHsKICAgICAgICAgIGNsZWFudXAoKTsKICAgICAgICB9CiAgICAgICAgY2FsbChjYiwgV0FUQ0hFUl9DQiwgW25ld1ZhbHVlLAogICAgICAgIC8vIHBhc3MgdW5kZWZpbmVkIGFzIHRoZSBvbGQgdmFsdWUgd2hlbiBpdCdzIGNoYW5nZWQgZm9yIHRoZSBmaXJzdCB0aW1lCiAgICAgICAgb2xkVmFsdWUgPT09IElOSVRJQUxfV0FUQ0hFUl9WQUxVRSA/IHVuZGVmaW5lZCA6IG9sZFZhbHVlLCBvbkNsZWFudXBdKTsKICAgICAgICBvbGRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyB3YXRjaEVmZmVjdAogICAgICB3YXRjaGVyLmdldCgpOwogICAgfQogIH07CiAgaWYgKGZsdXNoID09PSAnc3luYycpIHsKICAgIHdhdGNoZXIudXBkYXRlID0gd2F0Y2hlci5ydW47CiAgfSBlbHNlIGlmIChmbHVzaCA9PT0gJ3Bvc3QnKSB7CiAgICB3YXRjaGVyLnBvc3QgPSB0cnVlOwogICAgd2F0Y2hlci51cGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBxdWV1ZVdhdGNoZXIod2F0Y2hlcik7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBwcmUKICAgIHdhdGNoZXIudXBkYXRlID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UgPT09IGN1cnJlbnRJbnN0YW5jZSAmJiAhaW5zdGFuY2UuX2lzTW91bnRlZCkgewogICAgICAgIC8vIHByZS13YXRjaGVyIHRyaWdnZXJlZCBiZWZvcmUKICAgICAgICB2YXIgYnVmZmVyID0gaW5zdGFuY2UuX3ByZVdhdGNoZXJzIHx8IChpbnN0YW5jZS5fcHJlV2F0Y2hlcnMgPSBbXSk7CiAgICAgICAgaWYgKGJ1ZmZlci5pbmRleE9mKHdhdGNoZXIpIDwgMCkgYnVmZmVyLnB1c2god2F0Y2hlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcXVldWVXYXRjaGVyKHdhdGNoZXIpOwogICAgICB9CiAgICB9OwogIH0KICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgd2F0Y2hlci5vblRyYWNrID0gb25UcmFjazsKICAgIHdhdGNoZXIub25UcmlnZ2VyID0gb25UcmlnZ2VyOwogIH0KICAvLyBpbml0aWFsIHJ1bgogIGlmIChjYikgewogICAgaWYgKGltbWVkaWF0ZSkgewogICAgICB3YXRjaGVyLnJ1bigpOwogICAgfSBlbHNlIHsKICAgICAgb2xkVmFsdWUgPSB3YXRjaGVyLmdldCgpOwogICAgfQogIH0gZWxzZSBpZiAoZmx1c2ggPT09ICdwb3N0JyAmJiBpbnN0YW5jZSkgewogICAgaW5zdGFuY2UuJG9uY2UoJ2hvb2s6bW91bnRlZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHdhdGNoZXIuZ2V0KCk7CiAgICB9KTsKICB9IGVsc2UgewogICAgd2F0Y2hlci5nZXQoKTsKICB9CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHdhdGNoZXIudGVhcmRvd24oKTsKICB9Owp9CnZhciBhY3RpdmVFZmZlY3RTY29wZTsKdmFyIEVmZmVjdFNjb3BlID0gLyoqIEBjbGFzcyAqL2Z1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBFZmZlY3RTY29wZShkZXRhY2hlZCkgewogICAgaWYgKGRldGFjaGVkID09PSB2b2lkIDApIHsKICAgICAgZGV0YWNoZWQgPSBmYWxzZTsKICAgIH0KICAgIHRoaXMuZGV0YWNoZWQgPSBkZXRhY2hlZDsKICAgIC8qKgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgIC8qKgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIHRoaXMuZWZmZWN0cyA9IFtdOwogICAgLyoqCiAgICAgKiBAaW50ZXJuYWwKICAgICAqLwogICAgdGhpcy5jbGVhbnVwcyA9IFtdOwogICAgdGhpcy5wYXJlbnQgPSBhY3RpdmVFZmZlY3RTY29wZTsKICAgIGlmICghZGV0YWNoZWQgJiYgYWN0aXZlRWZmZWN0U2NvcGUpIHsKICAgICAgdGhpcy5pbmRleCA9IChhY3RpdmVFZmZlY3RTY29wZS5zY29wZXMgfHwgKGFjdGl2ZUVmZmVjdFNjb3BlLnNjb3BlcyA9IFtdKSkucHVzaCh0aGlzKSAtIDE7CiAgICB9CiAgfQogIEVmZmVjdFNjb3BlLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoZm4pIHsKICAgIGlmICh0aGlzLmFjdGl2ZSkgewogICAgICB2YXIgY3VycmVudEVmZmVjdFNjb3BlID0gYWN0aXZlRWZmZWN0U2NvcGU7CiAgICAgIHRyeSB7CiAgICAgICAgYWN0aXZlRWZmZWN0U2NvcGUgPSB0aGlzOwogICAgICAgIHJldHVybiBmbigpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGFjdGl2ZUVmZmVjdFNjb3BlID0gY3VycmVudEVmZmVjdFNjb3BlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgd2FybigiY2Fubm90IHJ1biBhbiBpbmFjdGl2ZSBlZmZlY3Qgc2NvcGUuIik7CiAgICB9CiAgfTsKICAvKioKICAgKiBUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBub24tZGV0YWNoZWQgc2NvcGVzCiAgICogQGludGVybmFsCiAgICovCiAgRWZmZWN0U2NvcGUucHJvdG90eXBlLm9uID0gZnVuY3Rpb24gKCkgewogICAgYWN0aXZlRWZmZWN0U2NvcGUgPSB0aGlzOwogIH07CiAgLyoqCiAgICogVGhpcyBzaG91bGQgb25seSBiZSBjYWxsZWQgb24gbm9uLWRldGFjaGVkIHNjb3BlcwogICAqIEBpbnRlcm5hbAogICAqLwogIEVmZmVjdFNjb3BlLnByb3RvdHlwZS5vZmYgPSBmdW5jdGlvbiAoKSB7CiAgICBhY3RpdmVFZmZlY3RTY29wZSA9IHRoaXMucGFyZW50OwogIH07CiAgRWZmZWN0U2NvcGUucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAoZnJvbVBhcmVudCkgewogICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgIHZhciBpID0gdm9pZCAwLAogICAgICAgIGwgPSB2b2lkIDA7CiAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmVmZmVjdHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5lZmZlY3RzW2ldLnRlYXJkb3duKCk7CiAgICAgIH0KICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMuY2xlYW51cHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5jbGVhbnVwc1tpXSgpOwogICAgICB9CiAgICAgIGlmICh0aGlzLnNjb3BlcykgewogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLnNjb3Blcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMuc2NvcGVzW2ldLnN0b3AodHJ1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIG5lc3RlZCBzY29wZSwgZGVyZWZlcmVuY2UgZnJvbSBwYXJlbnQgdG8gYXZvaWQgbWVtb3J5IGxlYWtzCiAgICAgIGlmICghdGhpcy5kZXRhY2hlZCAmJiB0aGlzLnBhcmVudCAmJiAhZnJvbVBhcmVudCkgewogICAgICAgIC8vIG9wdGltaXplZCBPKDEpIHJlbW92YWwKICAgICAgICB2YXIgbGFzdCA9IHRoaXMucGFyZW50LnNjb3Blcy5wb3AoKTsKICAgICAgICBpZiAobGFzdCAmJiBsYXN0ICE9PSB0aGlzKSB7CiAgICAgICAgICB0aGlzLnBhcmVudC5zY29wZXNbdGhpcy5pbmRleF0gPSBsYXN0OwogICAgICAgICAgbGFzdC5pbmRleCA9IHRoaXMuaW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMucGFyZW50ID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgfQogIH07CiAgcmV0dXJuIEVmZmVjdFNjb3BlOwp9KCk7CmZ1bmN0aW9uIGVmZmVjdFNjb3BlKGRldGFjaGVkKSB7CiAgcmV0dXJuIG5ldyBFZmZlY3RTY29wZShkZXRhY2hlZCk7Cn0KLyoqCiAqIEBpbnRlcm5hbAogKi8KZnVuY3Rpb24gcmVjb3JkRWZmZWN0U2NvcGUoZWZmZWN0LCBzY29wZSkgewogIGlmIChzY29wZSA9PT0gdm9pZCAwKSB7CiAgICBzY29wZSA9IGFjdGl2ZUVmZmVjdFNjb3BlOwogIH0KICBpZiAoc2NvcGUgJiYgc2NvcGUuYWN0aXZlKSB7CiAgICBzY29wZS5lZmZlY3RzLnB1c2goZWZmZWN0KTsKICB9Cn0KZnVuY3Rpb24gZ2V0Q3VycmVudFNjb3BlKCkgewogIHJldHVybiBhY3RpdmVFZmZlY3RTY29wZTsKfQpmdW5jdGlvbiBvblNjb3BlRGlzcG9zZShmbikgewogIGlmIChhY3RpdmVFZmZlY3RTY29wZSkgewogICAgYWN0aXZlRWZmZWN0U2NvcGUuY2xlYW51cHMucHVzaChmbik7CiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXJuKCJvblNjb3BlRGlzcG9zZSgpIGlzIGNhbGxlZCB3aGVuIHRoZXJlIGlzIG5vIGFjdGl2ZSBlZmZlY3Qgc2NvcGUiICsgIiB0byBiZSBhc3NvY2lhdGVkIHdpdGguIik7CiAgfQp9CmZ1bmN0aW9uIHByb3ZpZGUoa2V5LCB2YWx1ZSkgewogIGlmICghY3VycmVudEluc3RhbmNlKSB7CiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB3YXJuKCJwcm92aWRlKCkgY2FuIG9ubHkgYmUgdXNlZCBpbnNpZGUgc2V0dXAoKS4iKTsKICAgIH0KICB9IGVsc2UgewogICAgLy8gVFMgZG9lc24ndCBhbGxvdyBzeW1ib2wgYXMgaW5kZXggdHlwZQogICAgcmVzb2x2ZVByb3ZpZGVkKGN1cnJlbnRJbnN0YW5jZSlba2V5XSA9IHZhbHVlOwogIH0KfQpmdW5jdGlvbiByZXNvbHZlUHJvdmlkZWQodm0pIHsKICAvLyBieSBkZWZhdWx0IGFuIGluc3RhbmNlIGluaGVyaXRzIGl0cyBwYXJlbnQncyBwcm92aWRlcyBvYmplY3QKICAvLyBidXQgd2hlbiBpdCBuZWVkcyB0byBwcm92aWRlIHZhbHVlcyBvZiBpdHMgb3duLCBpdCBjcmVhdGVzIGl0cwogIC8vIG93biBwcm92aWRlcyBvYmplY3QgdXNpbmcgcGFyZW50IHByb3ZpZGVzIG9iamVjdCBhcyBwcm90b3R5cGUuCiAgLy8gdGhpcyB3YXkgaW4gYGluamVjdGAgd2UgY2FuIHNpbXBseSBsb29rIHVwIGluamVjdGlvbnMgZnJvbSBkaXJlY3QKICAvLyBwYXJlbnQgYW5kIGxldCB0aGUgcHJvdG90eXBlIGNoYWluIGRvIHRoZSB3b3JrLgogIHZhciBleGlzdGluZyA9IHZtLl9wcm92aWRlZDsKICB2YXIgcGFyZW50UHJvdmlkZXMgPSB2bS4kcGFyZW50ICYmIHZtLiRwYXJlbnQuX3Byb3ZpZGVkOwogIGlmIChwYXJlbnRQcm92aWRlcyA9PT0gZXhpc3RpbmcpIHsKICAgIHJldHVybiB2bS5fcHJvdmlkZWQgPSBPYmplY3QuY3JlYXRlKHBhcmVudFByb3ZpZGVzKTsKICB9IGVsc2UgewogICAgcmV0dXJuIGV4aXN0aW5nOwogIH0KfQpmdW5jdGlvbiBpbmplY3Qoa2V5LCBkZWZhdWx0VmFsdWUsIHRyZWF0RGVmYXVsdEFzRmFjdG9yeSkgewogIGlmICh0cmVhdERlZmF1bHRBc0ZhY3RvcnkgPT09IHZvaWQgMCkgewogICAgdHJlYXREZWZhdWx0QXNGYWN0b3J5ID0gZmFsc2U7CiAgfQogIC8vIGZhbGxiYWNrIHRvIGBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2VgIHNvIHRoYXQgdGhpcyBjYW4gYmUgY2FsbGVkIGluCiAgLy8gYSBmdW5jdGlvbmFsIGNvbXBvbmVudAogIHZhciBpbnN0YW5jZSA9IGN1cnJlbnRJbnN0YW5jZTsKICBpZiAoaW5zdGFuY2UpIHsKICAgIC8vICMyNDAwCiAgICAvLyB0byBzdXBwb3J0IGBhcHAudXNlYCBwbHVnaW5zLAogICAgLy8gZmFsbGJhY2sgdG8gYXBwQ29udGV4dCdzIGBwcm92aWRlc2AgaWYgdGhlIGluc3RhbmNlIGlzIGF0IHJvb3QKICAgIHZhciBwcm92aWRlcyA9IGluc3RhbmNlLiRwYXJlbnQgJiYgaW5zdGFuY2UuJHBhcmVudC5fcHJvdmlkZWQ7CiAgICBpZiAocHJvdmlkZXMgJiYga2V5IGluIHByb3ZpZGVzKSB7CiAgICAgIC8vIFRTIGRvZXNuJ3QgYWxsb3cgc3ltYm9sIGFzIGluZGV4IHR5cGUKICAgICAgcmV0dXJuIHByb3ZpZGVzW2tleV07CiAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgIHJldHVybiB0cmVhdERlZmF1bHRBc0ZhY3RvcnkgJiYgaXNGdW5jdGlvbihkZWZhdWx0VmFsdWUpID8gZGVmYXVsdFZhbHVlLmNhbGwoaW5zdGFuY2UpIDogZGVmYXVsdFZhbHVlOwogICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHdhcm4oImluamVjdGlvbiBcIiIuY29uY2F0KFN0cmluZyhrZXkpLCAiXCIgbm90IGZvdW5kLiIpKTsKICAgIH0KICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oImluamVjdCgpIGNhbiBvbmx5IGJlIHVzZWQgaW5zaWRlIHNldHVwKCkgb3IgZnVuY3Rpb25hbCBjb21wb25lbnRzLiIpOwogIH0KfQp2YXIgbm9ybWFsaXplRXZlbnQgPSBjYWNoZWQoZnVuY3Rpb24gKG5hbWUpIHsKICB2YXIgcGFzc2l2ZSA9IG5hbWUuY2hhckF0KDApID09PSAnJic7CiAgbmFtZSA9IHBhc3NpdmUgPyBuYW1lLnNsaWNlKDEpIDogbmFtZTsKICB2YXIgb25jZSA9IG5hbWUuY2hhckF0KDApID09PSAnfic7IC8vIFByZWZpeGVkIGxhc3QsIGNoZWNrZWQgZmlyc3QKICBuYW1lID0gb25jZSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogIHZhciBjYXB0dXJlID0gbmFtZS5jaGFyQXQoMCkgPT09ICchJzsKICBuYW1lID0gY2FwdHVyZSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogIHJldHVybiB7CiAgICBuYW1lOiBuYW1lLAogICAgb25jZTogb25jZSwKICAgIGNhcHR1cmU6IGNhcHR1cmUsCiAgICBwYXNzaXZlOiBwYXNzaXZlCiAgfTsKfSk7CmZ1bmN0aW9uIGNyZWF0ZUZuSW52b2tlcihmbnMsIHZtKSB7CiAgZnVuY3Rpb24gaW52b2tlcigpIHsKICAgIHZhciBmbnMgPSBpbnZva2VyLmZuczsKICAgIGlmIChpc0FycmF5KGZucykpIHsKICAgICAgdmFyIGNsb25lZCA9IGZucy5zbGljZSgpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsb25lZC5sZW5ndGg7IGkrKykgewogICAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGNsb25lZFtpXSwgbnVsbCwgYXJndW1lbnRzLCB2bSwgInYtb24gaGFuZGxlciIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyByZXR1cm4gaGFuZGxlciByZXR1cm4gdmFsdWUgZm9yIHNpbmdsZSBoYW5kbGVycwogICAgICByZXR1cm4gaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoZm5zLCBudWxsLCBhcmd1bWVudHMsIHZtLCAidi1vbiBoYW5kbGVyIik7CiAgICB9CiAgfQogIGludm9rZXIuZm5zID0gZm5zOwogIHJldHVybiBpbnZva2VyOwp9CmZ1bmN0aW9uIHVwZGF0ZUxpc3RlbmVycyhvbiwgb2xkT24sIGFkZCwgcmVtb3ZlLCBjcmVhdGVPbmNlSGFuZGxlciwgdm0pIHsKICB2YXIgbmFtZSwgY3VyLCBvbGQsIGV2ZW50OwogIGZvciAobmFtZSBpbiBvbikgewogICAgY3VyID0gb25bbmFtZV07CiAgICBvbGQgPSBvbGRPbltuYW1lXTsKICAgIGV2ZW50ID0gbm9ybWFsaXplRXZlbnQobmFtZSk7CiAgICBpZiAoaXNVbmRlZihjdXIpKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiSW52YWxpZCBoYW5kbGVyIGZvciBldmVudCBcIiIuY29uY2F0KGV2ZW50Lm5hbWUsICJcIjogZ290ICIpICsgU3RyaW5nKGN1ciksIHZtKTsKICAgIH0gZWxzZSBpZiAoaXNVbmRlZihvbGQpKSB7CiAgICAgIGlmIChpc1VuZGVmKGN1ci5mbnMpKSB7CiAgICAgICAgY3VyID0gb25bbmFtZV0gPSBjcmVhdGVGbkludm9rZXIoY3VyLCB2bSk7CiAgICAgIH0KICAgICAgaWYgKGlzVHJ1ZShldmVudC5vbmNlKSkgewogICAgICAgIGN1ciA9IG9uW25hbWVdID0gY3JlYXRlT25jZUhhbmRsZXIoZXZlbnQubmFtZSwgY3VyLCBldmVudC5jYXB0dXJlKTsKICAgICAgfQogICAgICBhZGQoZXZlbnQubmFtZSwgY3VyLCBldmVudC5jYXB0dXJlLCBldmVudC5wYXNzaXZlLCBldmVudC5wYXJhbXMpOwogICAgfSBlbHNlIGlmIChjdXIgIT09IG9sZCkgewogICAgICBvbGQuZm5zID0gY3VyOwogICAgICBvbltuYW1lXSA9IG9sZDsKICAgIH0KICB9CiAgZm9yIChuYW1lIGluIG9sZE9uKSB7CiAgICBpZiAoaXNVbmRlZihvbltuYW1lXSkpIHsKICAgICAgZXZlbnQgPSBub3JtYWxpemVFdmVudChuYW1lKTsKICAgICAgcmVtb3ZlKGV2ZW50Lm5hbWUsIG9sZE9uW25hbWVdLCBldmVudC5jYXB0dXJlKTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gbWVyZ2VWTm9kZUhvb2soZGVmLCBob29rS2V5LCBob29rKSB7CiAgaWYgKGRlZiBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICBkZWYgPSBkZWYuZGF0YS5ob29rIHx8IChkZWYuZGF0YS5ob29rID0ge30pOwogIH0KICB2YXIgaW52b2tlcjsKICB2YXIgb2xkSG9vayA9IGRlZltob29rS2V5XTsKICBmdW5jdGlvbiB3cmFwcGVkSG9vaygpIHsKICAgIGhvb2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIC8vIGltcG9ydGFudDogcmVtb3ZlIG1lcmdlZCBob29rIHRvIGVuc3VyZSBpdCdzIGNhbGxlZCBvbmx5IG9uY2UKICAgIC8vIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrCiAgICByZW1vdmUkMihpbnZva2VyLmZucywgd3JhcHBlZEhvb2spOwogIH0KICBpZiAoaXNVbmRlZihvbGRIb29rKSkgewogICAgLy8gbm8gZXhpc3RpbmcgaG9vawogICAgaW52b2tlciA9IGNyZWF0ZUZuSW52b2tlcihbd3JhcHBlZEhvb2tdKTsKICB9IGVsc2UgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoaXNEZWYob2xkSG9vay5mbnMpICYmIGlzVHJ1ZShvbGRIb29rLm1lcmdlZCkpIHsKICAgICAgLy8gYWxyZWFkeSBhIG1lcmdlZCBpbnZva2VyCiAgICAgIGludm9rZXIgPSBvbGRIb29rOwogICAgICBpbnZva2VyLmZucy5wdXNoKHdyYXBwZWRIb29rKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIGV4aXN0aW5nIHBsYWluIGhvb2sKICAgICAgaW52b2tlciA9IGNyZWF0ZUZuSW52b2tlcihbb2xkSG9vaywgd3JhcHBlZEhvb2tdKTsKICAgIH0KICB9CiAgaW52b2tlci5tZXJnZWQgPSB0cnVlOwogIGRlZltob29rS2V5XSA9IGludm9rZXI7Cn0KZnVuY3Rpb24gZXh0cmFjdFByb3BzRnJvbVZOb2RlRGF0YShkYXRhLCBDdG9yLCB0YWcpIHsKICAvLyB3ZSBhcmUgb25seSBleHRyYWN0aW5nIHJhdyB2YWx1ZXMgaGVyZS4KICAvLyB2YWxpZGF0aW9uIGFuZCBkZWZhdWx0IHZhbHVlcyBhcmUgaGFuZGxlZCBpbiB0aGUgY2hpbGQKICAvLyBjb21wb25lbnQgaXRzZWxmLgogIHZhciBwcm9wT3B0aW9ucyA9IEN0b3Iub3B0aW9ucy5wcm9wczsKICBpZiAoaXNVbmRlZihwcm9wT3B0aW9ucykpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIHJlcyA9IHt9OwogIHZhciBhdHRycyA9IGRhdGEuYXR0cnMsCiAgICBwcm9wcyA9IGRhdGEucHJvcHM7CiAgaWYgKGlzRGVmKGF0dHJzKSB8fCBpc0RlZihwcm9wcykpIHsKICAgIGZvciAodmFyIGtleSBpbiBwcm9wT3B0aW9ucykgewogICAgICB2YXIgYWx0S2V5ID0gaHlwaGVuYXRlKGtleSk7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgdmFyIGtleUluTG93ZXJDYXNlID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKGtleSAhPT0ga2V5SW5Mb3dlckNhc2UgJiYgYXR0cnMgJiYgaGFzT3duKGF0dHJzLCBrZXlJbkxvd2VyQ2FzZSkpIHsKICAgICAgICAgIHRpcCgiUHJvcCBcIiIuY29uY2F0KGtleUluTG93ZXJDYXNlLCAiXCIgaXMgcGFzc2VkIHRvIGNvbXBvbmVudCAiKSArICIiLmNvbmNhdChmb3JtYXRDb21wb25lbnROYW1lKAogICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0YWcgaXMgc3RyaW5nCiAgICAgICAgICB0YWcgfHwgQ3RvciksICIsIGJ1dCB0aGUgZGVjbGFyZWQgcHJvcCBuYW1lIGlzIikgKyAiIFwiIi5jb25jYXQoa2V5LCAiXCIuICIpICsgIk5vdGUgdGhhdCBIVE1MIGF0dHJpYnV0ZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUgYW5kIGNhbWVsQ2FzZWQgIiArICJwcm9wcyBuZWVkIHRvIHVzZSB0aGVpciBrZWJhYi1jYXNlIGVxdWl2YWxlbnRzIHdoZW4gdXNpbmcgaW4tRE9NICIgKyAidGVtcGxhdGVzLiBZb3Ugc2hvdWxkIHByb2JhYmx5IHVzZSBcIiIuY29uY2F0KGFsdEtleSwgIlwiIGluc3RlYWQgb2YgXCIiKS5jb25jYXQoa2V5LCAiXCIuIikpOwogICAgICAgIH0KICAgICAgfQogICAgICBjaGVja1Byb3AocmVzLCBwcm9wcywga2V5LCBhbHRLZXksIHRydWUpIHx8IGNoZWNrUHJvcChyZXMsIGF0dHJzLCBrZXksIGFsdEtleSwgZmFsc2UpOwogICAgfQogIH0KICByZXR1cm4gcmVzOwp9CmZ1bmN0aW9uIGNoZWNrUHJvcChyZXMsIGhhc2gsIGtleSwgYWx0S2V5LCBwcmVzZXJ2ZSkgewogIGlmIChpc0RlZihoYXNoKSkgewogICAgaWYgKGhhc093bihoYXNoLCBrZXkpKSB7CiAgICAgIHJlc1trZXldID0gaGFzaFtrZXldOwogICAgICBpZiAoIXByZXNlcnZlKSB7CiAgICAgICAgZGVsZXRlIGhhc2hba2V5XTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoaGFzT3duKGhhc2gsIGFsdEtleSkpIHsKICAgICAgcmVzW2tleV0gPSBoYXNoW2FsdEtleV07CiAgICAgIGlmICghcHJlc2VydmUpIHsKICAgICAgICBkZWxldGUgaGFzaFthbHRLZXldOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KCi8vIFRoZSB0ZW1wbGF0ZSBjb21waWxlciBhdHRlbXB0cyB0byBtaW5pbWl6ZSB0aGUgbmVlZCBmb3Igbm9ybWFsaXphdGlvbiBieQovLyBzdGF0aWNhbGx5IGFuYWx5emluZyB0aGUgdGVtcGxhdGUgYXQgY29tcGlsZSB0aW1lLgovLwovLyBGb3IgcGxhaW4gSFRNTCBtYXJrdXAsIG5vcm1hbGl6YXRpb24gY2FuIGJlIGNvbXBsZXRlbHkgc2tpcHBlZCBiZWNhdXNlIHRoZQovLyBnZW5lcmF0ZWQgcmVuZGVyIGZ1bmN0aW9uIGlzIGd1YXJhbnRlZWQgdG8gcmV0dXJuIEFycmF5PFZOb2RlPi4gVGhlcmUgYXJlCi8vIHR3byBjYXNlcyB3aGVyZSBleHRyYSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZDoKLy8gMS4gV2hlbiB0aGUgY2hpbGRyZW4gY29udGFpbnMgY29tcG9uZW50cyAtIGJlY2F1c2UgYSBmdW5jdGlvbmFsIGNvbXBvbmVudAovLyBtYXkgcmV0dXJuIGFuIEFycmF5IGluc3RlYWQgb2YgYSBzaW5nbGUgcm9vdC4gSW4gdGhpcyBjYXNlLCBqdXN0IGEgc2ltcGxlCi8vIG5vcm1hbGl6YXRpb24gaXMgbmVlZGVkIC0gaWYgYW55IGNoaWxkIGlzIGFuIEFycmF5LCB3ZSBmbGF0dGVuIHRoZSB3aG9sZQovLyB0aGluZyB3aXRoIEFycmF5LnByb3RvdHlwZS5jb25jYXQuIEl0IGlzIGd1YXJhbnRlZWQgdG8gYmUgb25seSAxLWxldmVsIGRlZXAKLy8gYmVjYXVzZSBmdW5jdGlvbmFsIGNvbXBvbmVudHMgYWxyZWFkeSBub3JtYWxpemUgdGhlaXIgb3duIGNoaWxkcmVuLgpmdW5jdGlvbiBzaW1wbGVOb3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbikgewogIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIGlmIChpc0FycmF5KGNoaWxkcmVuW2ldKSkgewogICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseShbXSwgY2hpbGRyZW4pOwogICAgfQogIH0KICByZXR1cm4gY2hpbGRyZW47Cn0KLy8gMi4gV2hlbiB0aGUgY2hpbGRyZW4gY29udGFpbnMgY29uc3RydWN0cyB0aGF0IGFsd2F5cyBnZW5lcmF0ZWQgbmVzdGVkIEFycmF5cywKLy8gZS5nLiA8dGVtcGxhdGU+LCA8c2xvdD4sIHYtZm9yLCBvciB3aGVuIHRoZSBjaGlsZHJlbiBpcyBwcm92aWRlZCBieSB1c2VyCi8vIHdpdGggaGFuZC13cml0dGVuIHJlbmRlciBmdW5jdGlvbnMgLyBKU1guIEluIHN1Y2ggY2FzZXMgYSBmdWxsIG5vcm1hbGl6YXRpb24KLy8gaXMgbmVlZGVkIHRvIGNhdGVyIHRvIGFsbCBwb3NzaWJsZSB0eXBlcyBvZiBjaGlsZHJlbiB2YWx1ZXMuCmZ1bmN0aW9uIG5vcm1hbGl6ZUNoaWxkcmVuKGNoaWxkcmVuKSB7CiAgcmV0dXJuIGlzUHJpbWl0aXZlKGNoaWxkcmVuKSA/IFtjcmVhdGVUZXh0Vk5vZGUoY2hpbGRyZW4pXSA6IGlzQXJyYXkoY2hpbGRyZW4pID8gbm9ybWFsaXplQXJyYXlDaGlsZHJlbihjaGlsZHJlbikgOiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gaXNUZXh0Tm9kZShub2RlKSB7CiAgcmV0dXJuIGlzRGVmKG5vZGUpICYmIGlzRGVmKG5vZGUudGV4dCkgJiYgaXNGYWxzZShub2RlLmlzQ29tbWVudCk7Cn0KZnVuY3Rpb24gbm9ybWFsaXplQXJyYXlDaGlsZHJlbihjaGlsZHJlbiwgbmVzdGVkSW5kZXgpIHsKICB2YXIgcmVzID0gW107CiAgdmFyIGksIGMsIGxhc3RJbmRleCwgbGFzdDsKICBmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIGMgPSBjaGlsZHJlbltpXTsKICAgIGlmIChpc1VuZGVmKGMpIHx8IHR5cGVvZiBjID09PSAnYm9vbGVhbicpIGNvbnRpbnVlOwogICAgbGFzdEluZGV4ID0gcmVzLmxlbmd0aCAtIDE7CiAgICBsYXN0ID0gcmVzW2xhc3RJbmRleF07CiAgICAvLyAgbmVzdGVkCiAgICBpZiAoaXNBcnJheShjKSkgewogICAgICBpZiAoYy5sZW5ndGggPiAwKSB7CiAgICAgICAgYyA9IG5vcm1hbGl6ZUFycmF5Q2hpbGRyZW4oYywgIiIuY29uY2F0KG5lc3RlZEluZGV4IHx8ICcnLCAiXyIpLmNvbmNhdChpKSk7CiAgICAgICAgLy8gbWVyZ2UgYWRqYWNlbnQgdGV4dCBub2RlcwogICAgICAgIGlmIChpc1RleHROb2RlKGNbMF0pICYmIGlzVGV4dE5vZGUobGFzdCkpIHsKICAgICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIGNbMF0udGV4dCk7CiAgICAgICAgICBjLnNoaWZ0KCk7CiAgICAgICAgfQogICAgICAgIHJlcy5wdXNoLmFwcGx5KHJlcywgYyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNQcmltaXRpdmUoYykpIHsKICAgICAgaWYgKGlzVGV4dE5vZGUobGFzdCkpIHsKICAgICAgICAvLyBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzCiAgICAgICAgLy8gdGhpcyBpcyBuZWNlc3NhcnkgZm9yIFNTUiBoeWRyYXRpb24gYmVjYXVzZSB0ZXh0IG5vZGVzIGFyZQogICAgICAgIC8vIGVzc2VudGlhbGx5IG1lcmdlZCB3aGVuIHJlbmRlcmVkIHRvIEhUTUwgc3RyaW5ncwogICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIGMpOwogICAgICB9IGVsc2UgaWYgKGMgIT09ICcnKSB7CiAgICAgICAgLy8gY29udmVydCBwcmltaXRpdmUgdG8gdm5vZGUKICAgICAgICByZXMucHVzaChjcmVhdGVUZXh0Vk5vZGUoYykpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoaXNUZXh0Tm9kZShjKSAmJiBpc1RleHROb2RlKGxhc3QpKSB7CiAgICAgICAgLy8gbWVyZ2UgYWRqYWNlbnQgdGV4dCBub2RlcwogICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIGMudGV4dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVmYXVsdCBrZXkgZm9yIG5lc3RlZCBhcnJheSBjaGlsZHJlbiAobGlrZWx5IGdlbmVyYXRlZCBieSB2LWZvcikKICAgICAgICBpZiAoaXNUcnVlKGNoaWxkcmVuLl9pc1ZMaXN0KSAmJiBpc0RlZihjLnRhZykgJiYgaXNVbmRlZihjLmtleSkgJiYgaXNEZWYobmVzdGVkSW5kZXgpKSB7CiAgICAgICAgICBjLmtleSA9ICJfX3ZsaXN0Ii5jb25jYXQobmVzdGVkSW5kZXgsICJfIikuY29uY2F0KGksICJfXyIpOwogICAgICAgIH0KICAgICAgICByZXMucHVzaChjKTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gcmVzOwp9CgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyB2LWZvciBsaXN0cy4KICovCmZ1bmN0aW9uIHJlbmRlckxpc3QodmFsLCByZW5kZXIpIHsKICB2YXIgcmV0ID0gbnVsbCwKICAgIGksCiAgICBsLAogICAga2V5cywKICAgIGtleTsKICBpZiAoaXNBcnJheSh2YWwpIHx8IHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICByZXQgPSBuZXcgQXJyYXkodmFsLmxlbmd0aCk7CiAgICBmb3IgKGkgPSAwLCBsID0gdmFsLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICByZXRbaV0gPSByZW5kZXIodmFsW2ldLCBpKTsKICAgIH0KICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICByZXQgPSBuZXcgQXJyYXkodmFsKTsKICAgIGZvciAoaSA9IDA7IGkgPCB2YWw7IGkrKykgewogICAgICByZXRbaV0gPSByZW5kZXIoaSArIDEsIGkpOwogICAgfQogIH0gZWxzZSBpZiAoaXNPYmplY3QodmFsKSkgewogICAgaWYgKGhhc1N5bWJvbCAmJiB2YWxbU3ltYm9sLml0ZXJhdG9yXSkgewogICAgICByZXQgPSBbXTsKICAgICAgdmFyIGl0ZXJhdG9yID0gdmFsW1N5bWJvbC5pdGVyYXRvcl0oKTsKICAgICAgdmFyIHJlc3VsdCA9IGl0ZXJhdG9yLm5leHQoKTsKICAgICAgd2hpbGUgKCFyZXN1bHQuZG9uZSkgewogICAgICAgIHJldC5wdXNoKHJlbmRlcihyZXN1bHQudmFsdWUsIHJldC5sZW5ndGgpKTsKICAgICAgICByZXN1bHQgPSBpdGVyYXRvci5uZXh0KCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGtleXMgPSBPYmplY3Qua2V5cyh2YWwpOwogICAgICByZXQgPSBuZXcgQXJyYXkoa2V5cy5sZW5ndGgpOwogICAgICBmb3IgKGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIHJldFtpXSA9IHJlbmRlcih2YWxba2V5XSwga2V5LCBpKTsKICAgICAgfQogICAgfQogIH0KICBpZiAoIWlzRGVmKHJldCkpIHsKICAgIHJldCA9IFtdOwogIH0KICByZXQuX2lzVkxpc3QgPSB0cnVlOwogIHJldHVybiByZXQ7Cn0KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIDxzbG90PgogKi8KZnVuY3Rpb24gcmVuZGVyU2xvdChuYW1lLCBmYWxsYmFja1JlbmRlciwgcHJvcHMsIGJpbmRPYmplY3QpIHsKICB2YXIgc2NvcGVkU2xvdEZuID0gdGhpcy4kc2NvcGVkU2xvdHNbbmFtZV07CiAgdmFyIG5vZGVzOwogIGlmIChzY29wZWRTbG90Rm4pIHsKICAgIC8vIHNjb3BlZCBzbG90CiAgICBwcm9wcyA9IHByb3BzIHx8IHt9OwogICAgaWYgKGJpbmRPYmplY3QpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIWlzT2JqZWN0KGJpbmRPYmplY3QpKSB7CiAgICAgICAgd2Fybignc2xvdCB2LWJpbmQgd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCcsIHRoaXMpOwogICAgICB9CiAgICAgIHByb3BzID0gZXh0ZW5kKGV4dGVuZCh7fSwgYmluZE9iamVjdCksIHByb3BzKTsKICAgIH0KICAgIG5vZGVzID0gc2NvcGVkU2xvdEZuKHByb3BzKSB8fCAoaXNGdW5jdGlvbihmYWxsYmFja1JlbmRlcikgPyBmYWxsYmFja1JlbmRlcigpIDogZmFsbGJhY2tSZW5kZXIpOwogIH0gZWxzZSB7CiAgICBub2RlcyA9IHRoaXMuJHNsb3RzW25hbWVdIHx8IChpc0Z1bmN0aW9uKGZhbGxiYWNrUmVuZGVyKSA/IGZhbGxiYWNrUmVuZGVyKCkgOiBmYWxsYmFja1JlbmRlcik7CiAgfQogIHZhciB0YXJnZXQgPSBwcm9wcyAmJiBwcm9wcy5zbG90OwogIGlmICh0YXJnZXQpIHsKICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCd0ZW1wbGF0ZScsIHsKICAgICAgc2xvdDogdGFyZ2V0CiAgICB9LCBub2Rlcyk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBub2RlczsKICB9Cn0KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVzb2x2aW5nIGZpbHRlcnMKICovCmZ1bmN0aW9uIHJlc29sdmVGaWx0ZXIoaWQpIHsKICByZXR1cm4gcmVzb2x2ZUFzc2V0KHRoaXMuJG9wdGlvbnMsICdmaWx0ZXJzJywgaWQsIHRydWUpIHx8IGlkZW50aXR5Owp9CmZ1bmN0aW9uIGlzS2V5Tm90TWF0Y2goZXhwZWN0LCBhY3R1YWwpIHsKICBpZiAoaXNBcnJheShleHBlY3QpKSB7CiAgICByZXR1cm4gZXhwZWN0LmluZGV4T2YoYWN0dWFsKSA9PT0gLTE7CiAgfSBlbHNlIHsKICAgIHJldHVybiBleHBlY3QgIT09IGFjdHVhbDsKICB9Cn0KLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciBjaGVja2luZyBrZXlDb2RlcyBmcm9tIGNvbmZpZy4KICogZXhwb3NlZCBhcyBWdWUucHJvdG90eXBlLl9rCiAqIHBhc3NpbmcgaW4gZXZlbnRLZXlOYW1lIGFzIGxhc3QgYXJndW1lbnQgc2VwYXJhdGVseSBmb3IgYmFja3dhcmRzIGNvbXBhdAogKi8KZnVuY3Rpb24gY2hlY2tLZXlDb2RlcyhldmVudEtleUNvZGUsIGtleSwgYnVpbHRJbktleUNvZGUsIGV2ZW50S2V5TmFtZSwgYnVpbHRJbktleU5hbWUpIHsKICB2YXIgbWFwcGVkS2V5Q29kZSA9IGNvbmZpZy5rZXlDb2Rlc1trZXldIHx8IGJ1aWx0SW5LZXlDb2RlOwogIGlmIChidWlsdEluS2V5TmFtZSAmJiBldmVudEtleU5hbWUgJiYgIWNvbmZpZy5rZXlDb2Rlc1trZXldKSB7CiAgICByZXR1cm4gaXNLZXlOb3RNYXRjaChidWlsdEluS2V5TmFtZSwgZXZlbnRLZXlOYW1lKTsKICB9IGVsc2UgaWYgKG1hcHBlZEtleUNvZGUpIHsKICAgIHJldHVybiBpc0tleU5vdE1hdGNoKG1hcHBlZEtleUNvZGUsIGV2ZW50S2V5Q29kZSk7CiAgfSBlbHNlIGlmIChldmVudEtleU5hbWUpIHsKICAgIHJldHVybiBoeXBoZW5hdGUoZXZlbnRLZXlOYW1lKSAhPT0ga2V5OwogIH0KICByZXR1cm4gZXZlbnRLZXlDb2RlID09PSB1bmRlZmluZWQ7Cn0KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgbWVyZ2luZyB2LWJpbmQ9Im9iamVjdCIgaW50byBhIFZOb2RlJ3MgZGF0YS4KICovCmZ1bmN0aW9uIGJpbmRPYmplY3RQcm9wcyhkYXRhLCB0YWcsIHZhbHVlLCBhc1Byb3AsIGlzU3luYykgewogIGlmICh2YWx1ZSkgewogICAgaWYgKCFpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCd2LWJpbmQgd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCBvciBBcnJheSB2YWx1ZScsIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgdmFsdWUgPSB0b09iamVjdCh2YWx1ZSk7CiAgICAgIH0KICAgICAgdmFyIGhhc2ggPSB2b2lkIDA7CiAgICAgIHZhciBfbG9vcF8xID0gZnVuY3Rpb24gX2xvb3BfMShrZXkpIHsKICAgICAgICBpZiAoa2V5ID09PSAnY2xhc3MnIHx8IGtleSA9PT0gJ3N0eWxlJyB8fCBpc1Jlc2VydmVkQXR0cmlidXRlKGtleSkpIHsKICAgICAgICAgIGhhc2ggPSBkYXRhOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgdHlwZSA9IGRhdGEuYXR0cnMgJiYgZGF0YS5hdHRycy50eXBlOwogICAgICAgICAgaGFzaCA9IGFzUHJvcCB8fCBjb25maWcubXVzdFVzZVByb3AodGFnLCB0eXBlLCBrZXkpID8gZGF0YS5kb21Qcm9wcyB8fCAoZGF0YS5kb21Qcm9wcyA9IHt9KSA6IGRhdGEuYXR0cnMgfHwgKGRhdGEuYXR0cnMgPSB7fSk7CiAgICAgICAgfQogICAgICAgIHZhciBjYW1lbGl6ZWRLZXkgPSBjYW1lbGl6ZShrZXkpOwogICAgICAgIHZhciBoeXBoZW5hdGVkS2V5ID0gaHlwaGVuYXRlKGtleSk7CiAgICAgICAgaWYgKCEoY2FtZWxpemVkS2V5IGluIGhhc2gpICYmICEoaHlwaGVuYXRlZEtleSBpbiBoYXNoKSkgewogICAgICAgICAgaGFzaFtrZXldID0gdmFsdWVba2V5XTsKICAgICAgICAgIGlmIChpc1N5bmMpIHsKICAgICAgICAgICAgdmFyIG9uID0gZGF0YS5vbiB8fCAoZGF0YS5vbiA9IHt9KTsKICAgICAgICAgICAgb25bInVwZGF0ZToiLmNvbmNhdChrZXkpXSA9IGZ1bmN0aW9uICgkZXZlbnQpIHsKICAgICAgICAgICAgICB2YWx1ZVtrZXldID0gJGV2ZW50OwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICAgICAgX2xvb3BfMShrZXkpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBkYXRhOwp9CgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyBzdGF0aWMgdHJlZXMuCiAqLwpmdW5jdGlvbiByZW5kZXJTdGF0aWMoaW5kZXgsIGlzSW5Gb3IpIHsKICB2YXIgY2FjaGVkID0gdGhpcy5fc3RhdGljVHJlZXMgfHwgKHRoaXMuX3N0YXRpY1RyZWVzID0gW10pOwogIHZhciB0cmVlID0gY2FjaGVkW2luZGV4XTsKICAvLyBpZiBoYXMgYWxyZWFkeS1yZW5kZXJlZCBzdGF0aWMgdHJlZSBhbmQgbm90IGluc2lkZSB2LWZvciwKICAvLyB3ZSBjYW4gcmV1c2UgdGhlIHNhbWUgdHJlZS4KICBpZiAodHJlZSAmJiAhaXNJbkZvcikgewogICAgcmV0dXJuIHRyZWU7CiAgfQogIC8vIG90aGVyd2lzZSwgcmVuZGVyIGEgZnJlc2ggdHJlZS4KICB0cmVlID0gY2FjaGVkW2luZGV4XSA9IHRoaXMuJG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zW2luZGV4XS5jYWxsKHRoaXMuX3JlbmRlclByb3h5LCB0aGlzLl9jLCB0aGlzIC8vIGZvciByZW5kZXIgZm5zIGdlbmVyYXRlZCBmb3IgZnVuY3Rpb25hbCBjb21wb25lbnQgdGVtcGxhdGVzCiAgKTsKCiAgbWFya1N0YXRpYyh0cmVlLCAiX19zdGF0aWNfXyIuY29uY2F0KGluZGV4KSwgZmFsc2UpOwogIHJldHVybiB0cmVlOwp9Ci8qKgogKiBSdW50aW1lIGhlbHBlciBmb3Igdi1vbmNlLgogKiBFZmZlY3RpdmVseSBpdCBtZWFucyBtYXJraW5nIHRoZSBub2RlIGFzIHN0YXRpYyB3aXRoIGEgdW5pcXVlIGtleS4KICovCmZ1bmN0aW9uIG1hcmtPbmNlKHRyZWUsIGluZGV4LCBrZXkpIHsKICBtYXJrU3RhdGljKHRyZWUsICJfX29uY2VfXyIuY29uY2F0KGluZGV4KS5jb25jYXQoa2V5ID8gIl8iLmNvbmNhdChrZXkpIDogIiIpLCB0cnVlKTsKICByZXR1cm4gdHJlZTsKfQpmdW5jdGlvbiBtYXJrU3RhdGljKHRyZWUsIGtleSwgaXNPbmNlKSB7CiAgaWYgKGlzQXJyYXkodHJlZSkpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHJlZS5sZW5ndGg7IGkrKykgewogICAgICBpZiAodHJlZVtpXSAmJiB0eXBlb2YgdHJlZVtpXSAhPT0gJ3N0cmluZycpIHsKICAgICAgICBtYXJrU3RhdGljTm9kZSh0cmVlW2ldLCAiIi5jb25jYXQoa2V5LCAiXyIpLmNvbmNhdChpKSwgaXNPbmNlKTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBtYXJrU3RhdGljTm9kZSh0cmVlLCBrZXksIGlzT25jZSk7CiAgfQp9CmZ1bmN0aW9uIG1hcmtTdGF0aWNOb2RlKG5vZGUsIGtleSwgaXNPbmNlKSB7CiAgbm9kZS5pc1N0YXRpYyA9IHRydWU7CiAgbm9kZS5rZXkgPSBrZXk7CiAgbm9kZS5pc09uY2UgPSBpc09uY2U7Cn0KZnVuY3Rpb24gYmluZE9iamVjdExpc3RlbmVycyhkYXRhLCB2YWx1ZSkgewogIGlmICh2YWx1ZSkgewogICAgaWYgKCFpc1BsYWluT2JqZWN0KHZhbHVlKSkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ3Ytb24gd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCB2YWx1ZScsIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG9uID0gZGF0YS5vbiA9IGRhdGEub24gPyBleHRlbmQoe30sIGRhdGEub24pIDoge307CiAgICAgIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgewogICAgICAgIHZhciBleGlzdGluZyA9IG9uW2tleV07CiAgICAgICAgdmFyIG91cnMgPSB2YWx1ZVtrZXldOwogICAgICAgIG9uW2tleV0gPSBleGlzdGluZyA/IFtdLmNvbmNhdChleGlzdGluZywgb3VycykgOiBvdXJzOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBkYXRhOwp9CmZ1bmN0aW9uIHJlc29sdmVTY29wZWRTbG90cyhmbnMsIHJlcywKLy8gdGhlIGZvbGxvd2luZyBhcmUgYWRkZWQgaW4gMi42Cmhhc0R5bmFtaWNLZXlzLCBjb250ZW50SGFzaEtleSkgewogIHJlcyA9IHJlcyB8fCB7CiAgICAkc3RhYmxlOiAhaGFzRHluYW1pY0tleXMKICB9OwogIGZvciAodmFyIGkgPSAwOyBpIDwgZm5zLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgc2xvdCA9IGZuc1tpXTsKICAgIGlmIChpc0FycmF5KHNsb3QpKSB7CiAgICAgIHJlc29sdmVTY29wZWRTbG90cyhzbG90LCByZXMsIGhhc0R5bmFtaWNLZXlzKTsKICAgIH0gZWxzZSBpZiAoc2xvdCkgewogICAgICAvLyBtYXJrZXIgZm9yIHJldmVyc2UgcHJveHlpbmcgdi1zbG90IHdpdGhvdXQgc2NvcGUgb24gdGhpcy4kc2xvdHMKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvcgogICAgICBpZiAoc2xvdC5wcm94eSkgewogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgICAgICBzbG90LmZuLnByb3h5ID0gdHJ1ZTsKICAgICAgfQogICAgICByZXNbc2xvdC5rZXldID0gc2xvdC5mbjsKICAgIH0KICB9CiAgaWYgKGNvbnRlbnRIYXNoS2V5KSB7CiAgICByZXMuJGtleSA9IGNvbnRlbnRIYXNoS2V5OwogIH0KICByZXR1cm4gcmVzOwp9CgovLyBoZWxwZXIgdG8gcHJvY2VzcyBkeW5hbWljIGtleXMgZm9yIGR5bmFtaWMgYXJndW1lbnRzIGluIHYtYmluZCBhbmQgdi1vbi4KZnVuY3Rpb24gYmluZER5bmFtaWNLZXlzKGJhc2VPYmosIHZhbHVlcykgewogIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSArPSAyKSB7CiAgICB2YXIga2V5ID0gdmFsdWVzW2ldOwogICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmIGtleSkgewogICAgICBiYXNlT2JqW3ZhbHVlc1tpXV0gPSB2YWx1ZXNbaSArIDFdOwogICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGtleSAhPT0gJycgJiYga2V5ICE9PSBudWxsKSB7CiAgICAgIC8vIG51bGwgaXMgYSBzcGVjaWFsIHZhbHVlIGZvciBleHBsaWNpdGx5IHJlbW92aW5nIGEgYmluZGluZwogICAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBkeW5hbWljIGRpcmVjdGl2ZSBhcmd1bWVudCAoZXhwZWN0ZWQgc3RyaW5nIG9yIG51bGwpOiAiLmNvbmNhdChrZXkpLCB0aGlzKTsKICAgIH0KICB9CiAgcmV0dXJuIGJhc2VPYmo7Cn0KLy8gaGVscGVyIHRvIGR5bmFtaWNhbGx5IGFwcGVuZCBtb2RpZmllciBydW50aW1lIG1hcmtlcnMgdG8gZXZlbnQgbmFtZXMuCi8vIGVuc3VyZSBvbmx5IGFwcGVuZCB3aGVuIHZhbHVlIGlzIGFscmVhZHkgc3RyaW5nLCBvdGhlcndpc2UgaXQgd2lsbCBiZSBjYXN0Ci8vIHRvIHN0cmluZyBhbmQgY2F1c2UgdGhlIHR5cGUgY2hlY2sgdG8gbWlzcy4KZnVuY3Rpb24gcHJlcGVuZE1vZGlmaWVyKHZhbHVlLCBzeW1ib2wpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHN5bWJvbCArIHZhbHVlIDogdmFsdWU7Cn0KZnVuY3Rpb24gaW5zdGFsbFJlbmRlckhlbHBlcnModGFyZ2V0KSB7CiAgdGFyZ2V0Ll9vID0gbWFya09uY2U7CiAgdGFyZ2V0Ll9uID0gdG9OdW1iZXI7CiAgdGFyZ2V0Ll9zID0gdG9TdHJpbmc7CiAgdGFyZ2V0Ll9sID0gcmVuZGVyTGlzdDsKICB0YXJnZXQuX3QgPSByZW5kZXJTbG90OwogIHRhcmdldC5fcSA9IGxvb3NlRXF1YWw7CiAgdGFyZ2V0Ll9pID0gbG9vc2VJbmRleE9mOwogIHRhcmdldC5fbSA9IHJlbmRlclN0YXRpYzsKICB0YXJnZXQuX2YgPSByZXNvbHZlRmlsdGVyOwogIHRhcmdldC5fayA9IGNoZWNrS2V5Q29kZXM7CiAgdGFyZ2V0Ll9iID0gYmluZE9iamVjdFByb3BzOwogIHRhcmdldC5fdiA9IGNyZWF0ZVRleHRWTm9kZTsKICB0YXJnZXQuX2UgPSBjcmVhdGVFbXB0eVZOb2RlOwogIHRhcmdldC5fdSA9IHJlc29sdmVTY29wZWRTbG90czsKICB0YXJnZXQuX2cgPSBiaW5kT2JqZWN0TGlzdGVuZXJzOwogIHRhcmdldC5fZCA9IGJpbmREeW5hbWljS2V5czsKICB0YXJnZXQuX3AgPSBwcmVwZW5kTW9kaWZpZXI7Cn0KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVzb2x2aW5nIHJhdyBjaGlsZHJlbiBWTm9kZXMgaW50byBhIHNsb3Qgb2JqZWN0LgogKi8KZnVuY3Rpb24gcmVzb2x2ZVNsb3RzKGNoaWxkcmVuLCBjb250ZXh0KSB7CiAgaWYgKCFjaGlsZHJlbiB8fCAhY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICByZXR1cm4ge307CiAgfQogIHZhciBzbG90cyA9IHt9OwogIGZvciAodmFyIGkgPSAwLCBsID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICB2YXIgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgIHZhciBkYXRhID0gY2hpbGQuZGF0YTsKICAgIC8vIHJlbW92ZSBzbG90IGF0dHJpYnV0ZSBpZiB0aGUgbm9kZSBpcyByZXNvbHZlZCBhcyBhIFZ1ZSBzbG90IG5vZGUKICAgIGlmIChkYXRhICYmIGRhdGEuYXR0cnMgJiYgZGF0YS5hdHRycy5zbG90KSB7CiAgICAgIGRlbGV0ZSBkYXRhLmF0dHJzLnNsb3Q7CiAgICB9CiAgICAvLyBuYW1lZCBzbG90cyBzaG91bGQgb25seSBiZSByZXNwZWN0ZWQgaWYgdGhlIHZub2RlIHdhcyByZW5kZXJlZCBpbiB0aGUKICAgIC8vIHNhbWUgY29udGV4dC4KICAgIGlmICgoY2hpbGQuY29udGV4dCA9PT0gY29udGV4dCB8fCBjaGlsZC5mbkNvbnRleHQgPT09IGNvbnRleHQpICYmIGRhdGEgJiYgZGF0YS5zbG90ICE9IG51bGwpIHsKICAgICAgdmFyIG5hbWVfMSA9IGRhdGEuc2xvdDsKICAgICAgdmFyIHNsb3QgPSBzbG90c1tuYW1lXzFdIHx8IChzbG90c1tuYW1lXzFdID0gW10pOwogICAgICBpZiAoY2hpbGQudGFnID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgc2xvdC5wdXNoLmFwcGx5KHNsb3QsIGNoaWxkLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzbG90LnB1c2goY2hpbGQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAoc2xvdHMuZGVmYXVsdCB8fCAoc2xvdHMuZGVmYXVsdCA9IFtdKSkucHVzaChjaGlsZCk7CiAgICB9CiAgfQogIC8vIGlnbm9yZSBzbG90cyB0aGF0IGNvbnRhaW5zIG9ubHkgd2hpdGVzcGFjZQogIGZvciAodmFyIG5hbWVfMiBpbiBzbG90cykgewogICAgaWYgKHNsb3RzW25hbWVfMl0uZXZlcnkoaXNXaGl0ZXNwYWNlKSkgewogICAgICBkZWxldGUgc2xvdHNbbmFtZV8yXTsKICAgIH0KICB9CiAgcmV0dXJuIHNsb3RzOwp9CmZ1bmN0aW9uIGlzV2hpdGVzcGFjZShub2RlKSB7CiAgcmV0dXJuIG5vZGUuaXNDb21tZW50ICYmICFub2RlLmFzeW5jRmFjdG9yeSB8fCBub2RlLnRleHQgPT09ICcgJzsKfQpmdW5jdGlvbiBpc0FzeW5jUGxhY2Vob2xkZXIobm9kZSkgewogIC8vIEB0cy1leHBlY3QtZXJyb3Igbm90IHJlYWxseSBib29sZWFuIHR5cGUKICByZXR1cm4gbm9kZS5pc0NvbW1lbnQgJiYgbm9kZS5hc3luY0ZhY3Rvcnk7Cn0KZnVuY3Rpb24gbm9ybWFsaXplU2NvcGVkU2xvdHMob3duZXJWbSwgc2NvcGVkU2xvdHMsIG5vcm1hbFNsb3RzLCBwcmV2U2NvcGVkU2xvdHMpIHsKICB2YXIgcmVzOwogIHZhciBoYXNOb3JtYWxTbG90cyA9IE9iamVjdC5rZXlzKG5vcm1hbFNsb3RzKS5sZW5ndGggPiAwOwogIHZhciBpc1N0YWJsZSA9IHNjb3BlZFNsb3RzID8gISFzY29wZWRTbG90cy4kc3RhYmxlIDogIWhhc05vcm1hbFNsb3RzOwogIHZhciBrZXkgPSBzY29wZWRTbG90cyAmJiBzY29wZWRTbG90cy4ka2V5OwogIGlmICghc2NvcGVkU2xvdHMpIHsKICAgIHJlcyA9IHt9OwogIH0gZWxzZSBpZiAoc2NvcGVkU2xvdHMuX25vcm1hbGl6ZWQpIHsKICAgIC8vIGZhc3QgcGF0aCAxOiBjaGlsZCBjb21wb25lbnQgcmUtcmVuZGVyIG9ubHksIHBhcmVudCBkaWQgbm90IGNoYW5nZQogICAgcmV0dXJuIHNjb3BlZFNsb3RzLl9ub3JtYWxpemVkOwogIH0gZWxzZSBpZiAoaXNTdGFibGUgJiYgcHJldlNjb3BlZFNsb3RzICYmIHByZXZTY29wZWRTbG90cyAhPT0gZW1wdHlPYmplY3QgJiYga2V5ID09PSBwcmV2U2NvcGVkU2xvdHMuJGtleSAmJiAhaGFzTm9ybWFsU2xvdHMgJiYgIXByZXZTY29wZWRTbG90cy4kaGFzTm9ybWFsKSB7CiAgICAvLyBmYXN0IHBhdGggMjogc3RhYmxlIHNjb3BlZCBzbG90cyB3LyBubyBub3JtYWwgc2xvdHMgdG8gcHJveHksCiAgICAvLyBvbmx5IG5lZWQgdG8gbm9ybWFsaXplIG9uY2UKICAgIHJldHVybiBwcmV2U2NvcGVkU2xvdHM7CiAgfSBlbHNlIHsKICAgIHJlcyA9IHt9OwogICAgZm9yICh2YXIga2V5XzEgaW4gc2NvcGVkU2xvdHMpIHsKICAgICAgaWYgKHNjb3BlZFNsb3RzW2tleV8xXSAmJiBrZXlfMVswXSAhPT0gJyQnKSB7CiAgICAgICAgcmVzW2tleV8xXSA9IG5vcm1hbGl6ZVNjb3BlZFNsb3Qob3duZXJWbSwgbm9ybWFsU2xvdHMsIGtleV8xLCBzY29wZWRTbG90c1trZXlfMV0pOwogICAgICB9CiAgICB9CiAgfQogIC8vIGV4cG9zZSBub3JtYWwgc2xvdHMgb24gc2NvcGVkU2xvdHMKICBmb3IgKHZhciBrZXlfMiBpbiBub3JtYWxTbG90cykgewogICAgaWYgKCEoa2V5XzIgaW4gcmVzKSkgewogICAgICByZXNba2V5XzJdID0gcHJveHlOb3JtYWxTbG90KG5vcm1hbFNsb3RzLCBrZXlfMik7CiAgICB9CiAgfQogIC8vIGF2b3JpYXogc2VlbXMgdG8gbW9jayBhIG5vbi1leHRlbnNpYmxlICRzY29wZWRTbG90cyBvYmplY3QKICAvLyBhbmQgd2hlbiB0aGF0IGlzIHBhc3NlZCBkb3duIHRoaXMgd291bGQgY2F1c2UgYW4gZXJyb3IKICBpZiAoc2NvcGVkU2xvdHMgJiYgT2JqZWN0LmlzRXh0ZW5zaWJsZShzY29wZWRTbG90cykpIHsKICAgIHNjb3BlZFNsb3RzLl9ub3JtYWxpemVkID0gcmVzOwogIH0KICBkZWYocmVzLCAnJHN0YWJsZScsIGlzU3RhYmxlKTsKICBkZWYocmVzLCAnJGtleScsIGtleSk7CiAgZGVmKHJlcywgJyRoYXNOb3JtYWwnLCBoYXNOb3JtYWxTbG90cyk7CiAgcmV0dXJuIHJlczsKfQpmdW5jdGlvbiBub3JtYWxpemVTY29wZWRTbG90KHZtLCBub3JtYWxTbG90cywga2V5LCBmbikgewogIHZhciBub3JtYWxpemVkID0gZnVuY3Rpb24gbm9ybWFsaXplZCgpIHsKICAgIHZhciBjdXIgPSBjdXJyZW50SW5zdGFuY2U7CiAgICBzZXRDdXJyZW50SW5zdGFuY2Uodm0pOwogICAgdmFyIHJlcyA9IGFyZ3VtZW50cy5sZW5ndGggPyBmbi5hcHBseShudWxsLCBhcmd1bWVudHMpIDogZm4oe30pOwogICAgcmVzID0gcmVzICYmIHR5cGVvZiByZXMgPT09ICdvYmplY3QnICYmICFpc0FycmF5KHJlcykgPyBbcmVzXSAvLyBzaW5nbGUgdm5vZGUKICAgIDogbm9ybWFsaXplQ2hpbGRyZW4ocmVzKTsKICAgIHZhciB2bm9kZSA9IHJlcyAmJiByZXNbMF07CiAgICBzZXRDdXJyZW50SW5zdGFuY2UoY3VyKTsKICAgIHJldHVybiByZXMgJiYgKCF2bm9kZSB8fCByZXMubGVuZ3RoID09PSAxICYmIHZub2RlLmlzQ29tbWVudCAmJiAhaXNBc3luY1BsYWNlaG9sZGVyKHZub2RlKSkgLy8gIzk2NTgsICMxMDM5MQogICAgPyB1bmRlZmluZWQgOiByZXM7CiAgfTsKICAvLyB0aGlzIGlzIGEgc2xvdCB1c2luZyB0aGUgbmV3IHYtc2xvdCBzeW50YXggd2l0aG91dCBzY29wZS4gYWx0aG91Z2ggaXQgaXMKICAvLyBjb21waWxlZCBhcyBhIHNjb3BlZCBzbG90LCByZW5kZXIgZm4gdXNlcnMgd291bGQgZXhwZWN0IGl0IHRvIGJlIHByZXNlbnQKICAvLyBvbiB0aGlzLiRzbG90cyBiZWNhdXNlIHRoZSB1c2FnZSBpcyBzZW1hbnRpY2FsbHkgYSBub3JtYWwgc2xvdC4KICBpZiAoZm4ucHJveHkpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub3JtYWxTbG90cywga2V5LCB7CiAgICAgIGdldDogbm9ybWFsaXplZCwKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICB9KTsKICB9CiAgcmV0dXJuIG5vcm1hbGl6ZWQ7Cn0KZnVuY3Rpb24gcHJveHlOb3JtYWxTbG90KHNsb3RzLCBrZXkpIHsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHNsb3RzW2tleV07CiAgfTsKfQpmdW5jdGlvbiBpbml0U2V0dXAodm0pIHsKICB2YXIgb3B0aW9ucyA9IHZtLiRvcHRpb25zOwogIHZhciBzZXR1cCA9IG9wdGlvbnMuc2V0dXA7CiAgaWYgKHNldHVwKSB7CiAgICB2YXIgY3R4ID0gdm0uX3NldHVwQ29udGV4dCA9IGNyZWF0ZVNldHVwQ29udGV4dCh2bSk7CiAgICBzZXRDdXJyZW50SW5zdGFuY2Uodm0pOwogICAgcHVzaFRhcmdldCgpOwogICAgdmFyIHNldHVwUmVzdWx0ID0gaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoc2V0dXAsIG51bGwsIFt2bS5fcHJvcHMgfHwgc2hhbGxvd1JlYWN0aXZlKHt9KSwgY3R4XSwgdm0sICJzZXR1cCIpOwogICAgcG9wVGFyZ2V0KCk7CiAgICBzZXRDdXJyZW50SW5zdGFuY2UoKTsKICAgIGlmIChpc0Z1bmN0aW9uKHNldHVwUmVzdWx0KSkgewogICAgICAvLyByZW5kZXIgZnVuY3Rpb24KICAgICAgLy8gQHRzLWlnbm9yZQogICAgICBvcHRpb25zLnJlbmRlciA9IHNldHVwUmVzdWx0OwogICAgfSBlbHNlIGlmIChpc09iamVjdChzZXR1cFJlc3VsdCkpIHsKICAgICAgLy8gYmluZGluZ3MKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgc2V0dXBSZXN1bHQgaW5zdGFuY2VvZiBWTm9kZSkgewogICAgICAgIHdhcm4oInNldHVwKCkgc2hvdWxkIG5vdCByZXR1cm4gVk5vZGVzIGRpcmVjdGx5IC0gIiArICJyZXR1cm4gYSByZW5kZXIgZnVuY3Rpb24gaW5zdGVhZC4iKTsKICAgICAgfQogICAgICB2bS5fc2V0dXBTdGF0ZSA9IHNldHVwUmVzdWx0OwogICAgICAvLyBfX3NmYyBpbmRpY2F0ZXMgY29tcGlsZWQgYmluZGluZ3MgZnJvbSA8c2NyaXB0IHNldHVwPgogICAgICBpZiAoIXNldHVwUmVzdWx0Ll9fc2ZjKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHNldHVwUmVzdWx0KSB7CiAgICAgICAgICBpZiAoIWlzUmVzZXJ2ZWQoa2V5KSkgewogICAgICAgICAgICBwcm94eVdpdGhSZWZVbndyYXAodm0sIHNldHVwUmVzdWx0LCBrZXkpOwogICAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICAgIHdhcm4oIkF2b2lkIHVzaW5nIHZhcmlhYmxlcyB0aGF0IHN0YXJ0IHdpdGggXyBvciAkIGluIHNldHVwKCkuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIGV4cG9zZWQgZm9yIGNvbXBpbGVkIHJlbmRlciBmbgogICAgICAgIHZhciBwcm94eSA9IHZtLl9zZXR1cFByb3h5ID0ge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIHNldHVwUmVzdWx0KSB7CiAgICAgICAgICBpZiAoa2V5ICE9PSAnX19zZmMnKSB7CiAgICAgICAgICAgIHByb3h5V2l0aFJlZlVud3JhcChwcm94eSwgc2V0dXBSZXN1bHQsIGtleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgc2V0dXBSZXN1bHQgIT09IHVuZGVmaW5lZCkgewogICAgICB3YXJuKCJzZXR1cCgpIHNob3VsZCByZXR1cm4gYW4gb2JqZWN0LiBSZWNlaXZlZDogIi5jb25jYXQoc2V0dXBSZXN1bHQgPT09IG51bGwgPyAnbnVsbCcgOiB0eXBlb2Ygc2V0dXBSZXN1bHQpKTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gY3JlYXRlU2V0dXBDb250ZXh0KHZtKSB7CiAgdmFyIGV4cG9zZUNhbGxlZCA9IGZhbHNlOwogIHJldHVybiB7CiAgICBnZXQgYXR0cnMoKSB7CiAgICAgIGlmICghdm0uX2F0dHJzUHJveHkpIHsKICAgICAgICB2YXIgcHJveHkgPSB2bS5fYXR0cnNQcm94eSA9IHt9OwogICAgICAgIGRlZihwcm94eSwgJ192X2F0dHJfcHJveHknLCB0cnVlKTsKICAgICAgICBzeW5jU2V0dXBQcm94eShwcm94eSwgdm0uJGF0dHJzLCBlbXB0eU9iamVjdCwgdm0sICckYXR0cnMnKTsKICAgICAgfQogICAgICByZXR1cm4gdm0uX2F0dHJzUHJveHk7CiAgICB9LAogICAgZ2V0IGxpc3RlbmVycygpIHsKICAgICAgaWYgKCF2bS5fbGlzdGVuZXJzUHJveHkpIHsKICAgICAgICB2YXIgcHJveHkgPSB2bS5fbGlzdGVuZXJzUHJveHkgPSB7fTsKICAgICAgICBzeW5jU2V0dXBQcm94eShwcm94eSwgdm0uJGxpc3RlbmVycywgZW1wdHlPYmplY3QsIHZtLCAnJGxpc3RlbmVycycpOwogICAgICB9CiAgICAgIHJldHVybiB2bS5fbGlzdGVuZXJzUHJveHk7CiAgICB9LAogICAgZ2V0IHNsb3RzKCkgewogICAgICByZXR1cm4gaW5pdFNsb3RzUHJveHkodm0pOwogICAgfSwKICAgIGVtaXQ6IGJpbmQodm0uJGVtaXQsIHZtKSwKICAgIGV4cG9zZTogZnVuY3Rpb24gZXhwb3NlKGV4cG9zZWQpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBpZiAoZXhwb3NlQ2FsbGVkKSB7CiAgICAgICAgICB3YXJuKCJleHBvc2UoKSBzaG91bGQgYmUgY2FsbGVkIG9ubHkgb25jZSBwZXIgc2V0dXAoKS4iLCB2bSk7CiAgICAgICAgfQogICAgICAgIGV4cG9zZUNhbGxlZCA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGV4cG9zZWQpIHsKICAgICAgICBPYmplY3Qua2V5cyhleHBvc2VkKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHJldHVybiBwcm94eVdpdGhSZWZVbndyYXAodm0sIGV4cG9zZWQsIGtleSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9Owp9CmZ1bmN0aW9uIHN5bmNTZXR1cFByb3h5KHRvLCBmcm9tLCBwcmV2LCBpbnN0YW5jZSwgdHlwZSkgewogIHZhciBjaGFuZ2VkID0gZmFsc2U7CiAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgIGlmICghKGtleSBpbiB0bykpIHsKICAgICAgY2hhbmdlZCA9IHRydWU7CiAgICAgIGRlZmluZVByb3h5QXR0cih0bywga2V5LCBpbnN0YW5jZSwgdHlwZSk7CiAgICB9IGVsc2UgaWYgKGZyb21ba2V5XSAhPT0gcHJldltrZXldKSB7CiAgICAgIGNoYW5nZWQgPSB0cnVlOwogICAgfQogIH0KICBmb3IgKHZhciBrZXkgaW4gdG8pIHsKICAgIGlmICghKGtleSBpbiBmcm9tKSkgewogICAgICBjaGFuZ2VkID0gdHJ1ZTsKICAgICAgZGVsZXRlIHRvW2tleV07CiAgICB9CiAgfQogIHJldHVybiBjaGFuZ2VkOwp9CmZ1bmN0aW9uIGRlZmluZVByb3h5QXR0cihwcm94eSwga2V5LCBpbnN0YW5jZSwgdHlwZSkgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm94eSwga2V5LCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBpbnN0YW5jZVt0eXBlXVtrZXldOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGluaXRTbG90c1Byb3h5KHZtKSB7CiAgaWYgKCF2bS5fc2xvdHNQcm94eSkgewogICAgc3luY1NldHVwU2xvdHModm0uX3Nsb3RzUHJveHkgPSB7fSwgdm0uJHNjb3BlZFNsb3RzKTsKICB9CiAgcmV0dXJuIHZtLl9zbG90c1Byb3h5Owp9CmZ1bmN0aW9uIHN5bmNTZXR1cFNsb3RzKHRvLCBmcm9tKSB7CiAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgIHRvW2tleV0gPSBmcm9tW2tleV07CiAgfQogIGZvciAodmFyIGtleSBpbiB0bykgewogICAgaWYgKCEoa2V5IGluIGZyb20pKSB7CiAgICAgIGRlbGV0ZSB0b1trZXldOwogICAgfQogIH0KfQovKioKICogQGludGVybmFsIHVzZSBtYW51YWwgdHlwZSBkZWYgYmVjYXVzZSBwdWJsaWMgc2V0dXAgY29udGV4dCB0eXBlIHJlbGllcyBvbgogKiBsZWdhY3kgVk5vZGUgdHlwZXMKICovCmZ1bmN0aW9uIHVzZVNsb3RzKCkgewogIHJldHVybiBnZXRDb250ZXh0KCkuc2xvdHM7Cn0KLyoqCiAqIEBpbnRlcm5hbCB1c2UgbWFudWFsIHR5cGUgZGVmIGJlY2F1c2UgcHVibGljIHNldHVwIGNvbnRleHQgdHlwZSByZWxpZXMgb24KICogbGVnYWN5IFZOb2RlIHR5cGVzCiAqLwpmdW5jdGlvbiB1c2VBdHRycygpIHsKICByZXR1cm4gZ2V0Q29udGV4dCgpLmF0dHJzOwp9Ci8qKgogKiBWdWUgMiBvbmx5CiAqIEBpbnRlcm5hbCB1c2UgbWFudWFsIHR5cGUgZGVmIGJlY2F1c2UgcHVibGljIHNldHVwIGNvbnRleHQgdHlwZSByZWxpZXMgb24KICogbGVnYWN5IFZOb2RlIHR5cGVzCiAqLwpmdW5jdGlvbiB1c2VMaXN0ZW5lcnMoKSB7CiAgcmV0dXJuIGdldENvbnRleHQoKS5saXN0ZW5lcnM7Cn0KZnVuY3Rpb24gZ2V0Q29udGV4dCgpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhY3VycmVudEluc3RhbmNlKSB7CiAgICB3YXJuKCJ1c2VDb250ZXh0KCkgY2FsbGVkIHdpdGhvdXQgYWN0aXZlIGluc3RhbmNlLiIpOwogIH0KICB2YXIgdm0gPSBjdXJyZW50SW5zdGFuY2U7CiAgcmV0dXJuIHZtLl9zZXR1cENvbnRleHQgfHwgKHZtLl9zZXR1cENvbnRleHQgPSBjcmVhdGVTZXR1cENvbnRleHQodm0pKTsKfQovKioKICogUnVudGltZSBoZWxwZXIgZm9yIG1lcmdpbmcgZGVmYXVsdCBkZWNsYXJhdGlvbnMuIEltcG9ydGVkIGJ5IGNvbXBpbGVkIGNvZGUKICogb25seS4KICogQGludGVybmFsCiAqLwpmdW5jdGlvbiBtZXJnZURlZmF1bHRzKHJhdywgZGVmYXVsdHMpIHsKICB2YXIgcHJvcHMgPSBpc0FycmF5KHJhdykgPyByYXcucmVkdWNlKGZ1bmN0aW9uIChub3JtYWxpemVkLCBwKSB7CiAgICByZXR1cm4gbm9ybWFsaXplZFtwXSA9IHt9LCBub3JtYWxpemVkOwogIH0sIHt9KSA6IHJhdzsKICBmb3IgKHZhciBrZXkgaW4gZGVmYXVsdHMpIHsKICAgIHZhciBvcHQgPSBwcm9wc1trZXldOwogICAgaWYgKG9wdCkgewogICAgICBpZiAoaXNBcnJheShvcHQpIHx8IGlzRnVuY3Rpb24ob3B0KSkgewogICAgICAgIHByb3BzW2tleV0gPSB7CiAgICAgICAgICB0eXBlOiBvcHQsCiAgICAgICAgICBkZWZhdWx0OiBkZWZhdWx0c1trZXldCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvcHQuZGVmYXVsdCA9IGRlZmF1bHRzW2tleV07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob3B0ID09PSBudWxsKSB7CiAgICAgIHByb3BzW2tleV0gPSB7CiAgICAgICAgZGVmYXVsdDogZGVmYXVsdHNba2V5XQogICAgICB9OwogICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHdhcm4oInByb3BzIGRlZmF1bHQga2V5IFwiIi5jb25jYXQoa2V5LCAiXCIgaGFzIG5vIGNvcnJlc3BvbmRpbmcgZGVjbGFyYXRpb24uIikpOwogICAgfQogIH0KICByZXR1cm4gcHJvcHM7Cn0KZnVuY3Rpb24gaW5pdFJlbmRlcih2bSkgewogIHZtLl92bm9kZSA9IG51bGw7IC8vIHRoZSByb290IG9mIHRoZSBjaGlsZCB0cmVlCiAgdm0uX3N0YXRpY1RyZWVzID0gbnVsbDsgLy8gdi1vbmNlIGNhY2hlZCB0cmVlcwogIHZhciBvcHRpb25zID0gdm0uJG9wdGlvbnM7CiAgdmFyIHBhcmVudFZub2RlID0gdm0uJHZub2RlID0gb3B0aW9ucy5fcGFyZW50Vm5vZGU7IC8vIHRoZSBwbGFjZWhvbGRlciBub2RlIGluIHBhcmVudCB0cmVlCiAgdmFyIHJlbmRlckNvbnRleHQgPSBwYXJlbnRWbm9kZSAmJiBwYXJlbnRWbm9kZS5jb250ZXh0OwogIHZtLiRzbG90cyA9IHJlc29sdmVTbG90cyhvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiwgcmVuZGVyQ29udGV4dCk7CiAgdm0uJHNjb3BlZFNsb3RzID0gcGFyZW50Vm5vZGUgPyBub3JtYWxpemVTY29wZWRTbG90cyh2bS4kcGFyZW50LCBwYXJlbnRWbm9kZS5kYXRhLnNjb3BlZFNsb3RzLCB2bS4kc2xvdHMpIDogZW1wdHlPYmplY3Q7CiAgLy8gYmluZCB0aGUgY3JlYXRlRWxlbWVudCBmbiB0byB0aGlzIGluc3RhbmNlCiAgLy8gc28gdGhhdCB3ZSBnZXQgcHJvcGVyIHJlbmRlciBjb250ZXh0IGluc2lkZSBpdC4KICAvLyBhcmdzIG9yZGVyOiB0YWcsIGRhdGEsIGNoaWxkcmVuLCBub3JtYWxpemF0aW9uVHlwZSwgYWx3YXlzTm9ybWFsaXplCiAgLy8gaW50ZXJuYWwgdmVyc2lvbiBpcyB1c2VkIGJ5IHJlbmRlciBmdW5jdGlvbnMgY29tcGlsZWQgZnJvbSB0ZW1wbGF0ZXMKICAvLyBAdHMtZXhwZWN0LWVycm9yCiAgdm0uX2MgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQkMSh2bSwgYSwgYiwgYywgZCwgZmFsc2UpOwogIH07CiAgLy8gbm9ybWFsaXphdGlvbiBpcyBhbHdheXMgYXBwbGllZCBmb3IgdGhlIHB1YmxpYyB2ZXJzaW9uLCB1c2VkIGluCiAgLy8gdXNlci13cml0dGVuIHJlbmRlciBmdW5jdGlvbnMuCiAgLy8gQHRzLWV4cGVjdC1lcnJvcgogIHZtLiRjcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQpIHsKICAgIHJldHVybiBjcmVhdGVFbGVtZW50JDEodm0sIGEsIGIsIGMsIGQsIHRydWUpOwogIH07CiAgLy8gJGF0dHJzICYgJGxpc3RlbmVycyBhcmUgZXhwb3NlZCBmb3IgZWFzaWVyIEhPQyBjcmVhdGlvbi4KICAvLyB0aGV5IG5lZWQgdG8gYmUgcmVhY3RpdmUgc28gdGhhdCBIT0NzIHVzaW5nIHRoZW0gYXJlIGFsd2F5cyB1cGRhdGVkCiAgdmFyIHBhcmVudERhdGEgPSBwYXJlbnRWbm9kZSAmJiBwYXJlbnRWbm9kZS5kYXRhOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGRlZmluZVJlYWN0aXZlKHZtLCAnJGF0dHJzJywgcGFyZW50RGF0YSAmJiBwYXJlbnREYXRhLmF0dHJzIHx8IGVtcHR5T2JqZWN0LCBmdW5jdGlvbiAoKSB7CiAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGF0dHJzIGlzIHJlYWRvbmx5LiIsIHZtKTsKICAgIH0sIHRydWUpOwogICAgZGVmaW5lUmVhY3RpdmUodm0sICckbGlzdGVuZXJzJywgb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0LCBmdW5jdGlvbiAoKSB7CiAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGxpc3RlbmVycyBpcyByZWFkb25seS4iLCB2bSk7CiAgICB9LCB0cnVlKTsKICB9IGVsc2UgewogICAgZGVmaW5lUmVhY3RpdmUodm0sICckYXR0cnMnLCBwYXJlbnREYXRhICYmIHBhcmVudERhdGEuYXR0cnMgfHwgZW1wdHlPYmplY3QsIG51bGwsIHRydWUpOwogICAgZGVmaW5lUmVhY3RpdmUodm0sICckbGlzdGVuZXJzJywgb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0LCBudWxsLCB0cnVlKTsKICB9Cn0KdmFyIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IG51bGw7CmZ1bmN0aW9uIHJlbmRlck1peGluKFZ1ZSkgewogIC8vIGluc3RhbGwgcnVudGltZSBjb252ZW5pZW5jZSBoZWxwZXJzCiAgaW5zdGFsbFJlbmRlckhlbHBlcnMoVnVlLnByb3RvdHlwZSk7CiAgVnVlLnByb3RvdHlwZS4kbmV4dFRpY2sgPSBmdW5jdGlvbiAoZm4pIHsKICAgIHJldHVybiBuZXh0VGljayhmbiwgdGhpcyk7CiAgfTsKICBWdWUucHJvdG90eXBlLl9yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdm0gPSB0aGlzOwogICAgdmFyIF9hID0gdm0uJG9wdGlvbnMsCiAgICAgIHJlbmRlciA9IF9hLnJlbmRlciwKICAgICAgX3BhcmVudFZub2RlID0gX2EuX3BhcmVudFZub2RlOwogICAgaWYgKF9wYXJlbnRWbm9kZSAmJiB2bS5faXNNb3VudGVkKSB7CiAgICAgIHZtLiRzY29wZWRTbG90cyA9IG5vcm1hbGl6ZVNjb3BlZFNsb3RzKHZtLiRwYXJlbnQsIF9wYXJlbnRWbm9kZS5kYXRhLnNjb3BlZFNsb3RzLCB2bS4kc2xvdHMsIHZtLiRzY29wZWRTbG90cyk7CiAgICAgIGlmICh2bS5fc2xvdHNQcm94eSkgewogICAgICAgIHN5bmNTZXR1cFNsb3RzKHZtLl9zbG90c1Byb3h5LCB2bS4kc2NvcGVkU2xvdHMpOwogICAgICB9CiAgICB9CiAgICAvLyBzZXQgcGFyZW50IHZub2RlLiB0aGlzIGFsbG93cyByZW5kZXIgZnVuY3Rpb25zIHRvIGhhdmUgYWNjZXNzCiAgICAvLyB0byB0aGUgZGF0YSBvbiB0aGUgcGxhY2Vob2xkZXIgbm9kZS4KICAgIHZtLiR2bm9kZSA9IF9wYXJlbnRWbm9kZTsKICAgIC8vIHJlbmRlciBzZWxmCiAgICB2YXIgdm5vZGU7CiAgICB0cnkgewogICAgICAvLyBUaGVyZSdzIG5vIG5lZWQgdG8gbWFpbnRhaW4gYSBzdGFjayBiZWNhdXNlIGFsbCByZW5kZXIgZm5zIGFyZSBjYWxsZWQKICAgICAgLy8gc2VwYXJhdGVseSBmcm9tIG9uZSBhbm90aGVyLiBOZXN0ZWQgY29tcG9uZW50J3MgcmVuZGVyIGZucyBhcmUgY2FsbGVkCiAgICAgIC8vIHdoZW4gcGFyZW50IGNvbXBvbmVudCBpcyBwYXRjaGVkLgogICAgICBzZXRDdXJyZW50SW5zdGFuY2Uodm0pOwogICAgICBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgPSB2bTsKICAgICAgdm5vZGUgPSByZW5kZXIuY2FsbCh2bS5fcmVuZGVyUHJveHksIHZtLiRjcmVhdGVFbGVtZW50KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICJyZW5kZXIiKTsKICAgICAgLy8gcmV0dXJuIGVycm9yIHJlbmRlciByZXN1bHQsCiAgICAgIC8vIG9yIHByZXZpb3VzIHZub2RlIHRvIHByZXZlbnQgcmVuZGVyIGVycm9yIGNhdXNpbmcgYmxhbmsgY29tcG9uZW50CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHZtLiRvcHRpb25zLnJlbmRlckVycm9yKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZub2RlID0gdm0uJG9wdGlvbnMucmVuZGVyRXJyb3IuY2FsbCh2bS5fcmVuZGVyUHJveHksIHZtLiRjcmVhdGVFbGVtZW50LCBlKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBoYW5kbGVFcnJvcihlLCB2bSwgInJlbmRlckVycm9yIik7CiAgICAgICAgICB2bm9kZSA9IHZtLl92bm9kZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdm5vZGUgPSB2bS5fdm5vZGU7CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IG51bGw7CiAgICAgIHNldEN1cnJlbnRJbnN0YW5jZSgpOwogICAgfQogICAgLy8gaWYgdGhlIHJldHVybmVkIGFycmF5IGNvbnRhaW5zIG9ubHkgYSBzaW5nbGUgbm9kZSwgYWxsb3cgaXQKICAgIGlmIChpc0FycmF5KHZub2RlKSAmJiB2bm9kZS5sZW5ndGggPT09IDEpIHsKICAgICAgdm5vZGUgPSB2bm9kZVswXTsKICAgIH0KICAgIC8vIHJldHVybiBlbXB0eSB2bm9kZSBpbiBjYXNlIHRoZSByZW5kZXIgZnVuY3Rpb24gZXJyb3JlZCBvdXQKICAgIGlmICghKHZub2RlIGluc3RhbmNlb2YgVk5vZGUpKSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGlzQXJyYXkodm5vZGUpKSB7CiAgICAgICAgd2FybignTXVsdGlwbGUgcm9vdCBub2RlcyByZXR1cm5lZCBmcm9tIHJlbmRlciBmdW5jdGlvbi4gUmVuZGVyIGZ1bmN0aW9uICcgKyAnc2hvdWxkIHJldHVybiBhIHNpbmdsZSByb290IG5vZGUuJywgdm0pOwogICAgICB9CiAgICAgIHZub2RlID0gY3JlYXRlRW1wdHlWTm9kZSgpOwogICAgfQogICAgLy8gc2V0IHBhcmVudAogICAgdm5vZGUucGFyZW50ID0gX3BhcmVudFZub2RlOwogICAgcmV0dXJuIHZub2RlOwogIH07Cn0KZnVuY3Rpb24gZW5zdXJlQ3Rvcihjb21wLCBiYXNlKSB7CiAgaWYgKGNvbXAuX19lc01vZHVsZSB8fCBoYXNTeW1ib2wgJiYgY29tcFtTeW1ib2wudG9TdHJpbmdUYWddID09PSAnTW9kdWxlJykgewogICAgY29tcCA9IGNvbXAuZGVmYXVsdDsKICB9CiAgcmV0dXJuIGlzT2JqZWN0KGNvbXApID8gYmFzZS5leHRlbmQoY29tcCkgOiBjb21wOwp9CmZ1bmN0aW9uIGNyZWF0ZUFzeW5jUGxhY2Vob2xkZXIoZmFjdG9yeSwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZykgewogIHZhciBub2RlID0gY3JlYXRlRW1wdHlWTm9kZSgpOwogIG5vZGUuYXN5bmNGYWN0b3J5ID0gZmFjdG9yeTsKICBub2RlLmFzeW5jTWV0YSA9IHsKICAgIGRhdGE6IGRhdGEsCiAgICBjb250ZXh0OiBjb250ZXh0LAogICAgY2hpbGRyZW46IGNoaWxkcmVuLAogICAgdGFnOiB0YWcKICB9OwogIHJldHVybiBub2RlOwp9CmZ1bmN0aW9uIHJlc29sdmVBc3luY0NvbXBvbmVudChmYWN0b3J5LCBiYXNlQ3RvcikgewogIGlmIChpc1RydWUoZmFjdG9yeS5lcnJvcikgJiYgaXNEZWYoZmFjdG9yeS5lcnJvckNvbXApKSB7CiAgICByZXR1cm4gZmFjdG9yeS5lcnJvckNvbXA7CiAgfQogIGlmIChpc0RlZihmYWN0b3J5LnJlc29sdmVkKSkgewogICAgcmV0dXJuIGZhY3RvcnkucmVzb2x2ZWQ7CiAgfQogIHZhciBvd25lciA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsKICBpZiAob3duZXIgJiYgaXNEZWYoZmFjdG9yeS5vd25lcnMpICYmIGZhY3Rvcnkub3duZXJzLmluZGV4T2Yob3duZXIpID09PSAtMSkgewogICAgLy8gYWxyZWFkeSBwZW5kaW5nCiAgICBmYWN0b3J5Lm93bmVycy5wdXNoKG93bmVyKTsKICB9CiAgaWYgKGlzVHJ1ZShmYWN0b3J5LmxvYWRpbmcpICYmIGlzRGVmKGZhY3RvcnkubG9hZGluZ0NvbXApKSB7CiAgICByZXR1cm4gZmFjdG9yeS5sb2FkaW5nQ29tcDsKICB9CiAgaWYgKG93bmVyICYmICFpc0RlZihmYWN0b3J5Lm93bmVycykpIHsKICAgIHZhciBvd25lcnNfMSA9IGZhY3Rvcnkub3duZXJzID0gW293bmVyXTsKICAgIHZhciBzeW5jXzEgPSB0cnVlOwogICAgdmFyIHRpbWVyTG9hZGluZ18xID0gbnVsbDsKICAgIHZhciB0aW1lclRpbWVvdXRfMSA9IG51bGw7CiAgICBvd25lci4kb24oJ2hvb2s6ZGVzdHJveWVkJywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcmVtb3ZlJDIob3duZXJzXzEsIG93bmVyKTsKICAgIH0pOwogICAgdmFyIGZvcmNlUmVuZGVyXzEgPSBmdW5jdGlvbiBmb3JjZVJlbmRlcl8xKHJlbmRlckNvbXBsZXRlZCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG93bmVyc18xLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG93bmVyc18xW2ldLiRmb3JjZVVwZGF0ZSgpOwogICAgICB9CiAgICAgIGlmIChyZW5kZXJDb21wbGV0ZWQpIHsKICAgICAgICBvd25lcnNfMS5sZW5ndGggPSAwOwogICAgICAgIGlmICh0aW1lckxvYWRpbmdfMSAhPT0gbnVsbCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyTG9hZGluZ18xKTsKICAgICAgICAgIHRpbWVyTG9hZGluZ18xID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKHRpbWVyVGltZW91dF8xICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJUaW1lb3V0XzEpOwogICAgICAgICAgdGltZXJUaW1lb3V0XzEgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHZhciByZXNvbHZlID0gb25jZShmdW5jdGlvbiAocmVzKSB7CiAgICAgIC8vIGNhY2hlIHJlc29sdmVkCiAgICAgIGZhY3RvcnkucmVzb2x2ZWQgPSBlbnN1cmVDdG9yKHJlcywgYmFzZUN0b3IpOwogICAgICAvLyBpbnZva2UgY2FsbGJhY2tzIG9ubHkgaWYgdGhpcyBpcyBub3QgYSBzeW5jaHJvbm91cyByZXNvbHZlCiAgICAgIC8vIChhc3luYyByZXNvbHZlcyBhcmUgc2hpbW1lZCBhcyBzeW5jaHJvbm91cyBkdXJpbmcgU1NSKQogICAgICBpZiAoIXN5bmNfMSkgewogICAgICAgIGZvcmNlUmVuZGVyXzEodHJ1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3duZXJzXzEubGVuZ3RoID0gMDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVqZWN0XzEgPSBvbmNlKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJGYWlsZWQgdG8gcmVzb2x2ZSBhc3luYyBjb21wb25lbnQ6ICIuY29uY2F0KFN0cmluZyhmYWN0b3J5KSkgKyAocmVhc29uID8gIlxuUmVhc29uOiAiLmNvbmNhdChyZWFzb24pIDogJycpKTsKICAgICAgaWYgKGlzRGVmKGZhY3RvcnkuZXJyb3JDb21wKSkgewogICAgICAgIGZhY3RvcnkuZXJyb3IgPSB0cnVlOwogICAgICAgIGZvcmNlUmVuZGVyXzEodHJ1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlc18xID0gZmFjdG9yeShyZXNvbHZlLCByZWplY3RfMSk7CiAgICBpZiAoaXNPYmplY3QocmVzXzEpKSB7CiAgICAgIGlmIChpc1Byb21pc2UocmVzXzEpKSB7CiAgICAgICAgLy8gKCkgPT4gUHJvbWlzZQogICAgICAgIGlmIChpc1VuZGVmKGZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICAgICAgICByZXNfMS50aGVuKHJlc29sdmUsIHJlamVjdF8xKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNQcm9taXNlKHJlc18xLmNvbXBvbmVudCkpIHsKICAgICAgICByZXNfMS5jb21wb25lbnQudGhlbihyZXNvbHZlLCByZWplY3RfMSk7CiAgICAgICAgaWYgKGlzRGVmKHJlc18xLmVycm9yKSkgewogICAgICAgICAgZmFjdG9yeS5lcnJvckNvbXAgPSBlbnN1cmVDdG9yKHJlc18xLmVycm9yLCBiYXNlQ3Rvcik7CiAgICAgICAgfQogICAgICAgIGlmIChpc0RlZihyZXNfMS5sb2FkaW5nKSkgewogICAgICAgICAgZmFjdG9yeS5sb2FkaW5nQ29tcCA9IGVuc3VyZUN0b3IocmVzXzEubG9hZGluZywgYmFzZUN0b3IpOwogICAgICAgICAgaWYgKHJlc18xLmRlbGF5ID09PSAwKSB7CiAgICAgICAgICAgIGZhY3RvcnkubG9hZGluZyA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIE5vZGVKUyB0aW1lb3V0IHR5cGUKICAgICAgICAgICAgdGltZXJMb2FkaW5nXzEgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aW1lckxvYWRpbmdfMSA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkgJiYgaXNVbmRlZihmYWN0b3J5LmVycm9yKSkgewogICAgICAgICAgICAgICAgZmFjdG9yeS5sb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZvcmNlUmVuZGVyXzEoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgcmVzXzEuZGVsYXkgfHwgMjAwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzRGVmKHJlc18xLnRpbWVvdXQpKSB7CiAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIE5vZGVKUyB0aW1lb3V0IHR5cGUKICAgICAgICAgIHRpbWVyVGltZW91dF8xID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRpbWVyVGltZW91dF8xID0gbnVsbDsKICAgICAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgICAgICAgICAgICByZWplY3RfMShwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gInRpbWVvdXQgKCIuY29uY2F0KHJlc18xLnRpbWVvdXQsICJtcykiKSA6IG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCByZXNfMS50aW1lb3V0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHN5bmNfMSA9IGZhbHNlOwogICAgLy8gcmV0dXJuIGluIGNhc2UgcmVzb2x2ZWQgc3luY2hyb25vdXNseQogICAgcmV0dXJuIGZhY3RvcnkubG9hZGluZyA/IGZhY3RvcnkubG9hZGluZ0NvbXAgOiBmYWN0b3J5LnJlc29sdmVkOwogIH0KfQpmdW5jdGlvbiBnZXRGaXJzdENvbXBvbmVudENoaWxkKGNoaWxkcmVuKSB7CiAgaWYgKGlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBjID0gY2hpbGRyZW5baV07CiAgICAgIGlmIChpc0RlZihjKSAmJiAoaXNEZWYoYy5jb21wb25lbnRPcHRpb25zKSB8fCBpc0FzeW5jUGxhY2Vob2xkZXIoYykpKSB7CiAgICAgICAgcmV0dXJuIGM7CiAgICAgIH0KICAgIH0KICB9Cn0KdmFyIFNJTVBMRV9OT1JNQUxJWkUgPSAxOwp2YXIgQUxXQVlTX05PUk1BTElaRSA9IDI7Ci8vIHdyYXBwZXIgZnVuY3Rpb24gZm9yIHByb3ZpZGluZyBhIG1vcmUgZmxleGlibGUgaW50ZXJmYWNlCi8vIHdpdGhvdXQgZ2V0dGluZyB5ZWxsZWQgYXQgYnkgZmxvdwpmdW5jdGlvbiBjcmVhdGVFbGVtZW50JDEoY29udGV4dCwgdGFnLCBkYXRhLCBjaGlsZHJlbiwgbm9ybWFsaXphdGlvblR5cGUsIGFsd2F5c05vcm1hbGl6ZSkgewogIGlmIChpc0FycmF5KGRhdGEpIHx8IGlzUHJpbWl0aXZlKGRhdGEpKSB7CiAgICBub3JtYWxpemF0aW9uVHlwZSA9IGNoaWxkcmVuOwogICAgY2hpbGRyZW4gPSBkYXRhOwogICAgZGF0YSA9IHVuZGVmaW5lZDsKICB9CiAgaWYgKGlzVHJ1ZShhbHdheXNOb3JtYWxpemUpKSB7CiAgICBub3JtYWxpemF0aW9uVHlwZSA9IEFMV0FZU19OT1JNQUxJWkU7CiAgfQogIHJldHVybiBfY3JlYXRlRWxlbWVudChjb250ZXh0LCB0YWcsIGRhdGEsIGNoaWxkcmVuLCBub3JtYWxpemF0aW9uVHlwZSk7Cn0KZnVuY3Rpb24gX2NyZWF0ZUVsZW1lbnQoY29udGV4dCwgdGFnLCBkYXRhLCBjaGlsZHJlbiwgbm9ybWFsaXphdGlvblR5cGUpIHsKICBpZiAoaXNEZWYoZGF0YSkgJiYgaXNEZWYoZGF0YS5fX29iX18pKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkF2b2lkIHVzaW5nIG9ic2VydmVkIGRhdGEgb2JqZWN0IGFzIHZub2RlIGRhdGE6ICIuY29uY2F0KEpTT04uc3RyaW5naWZ5KGRhdGEpLCAiXG4iKSArICdBbHdheXMgY3JlYXRlIGZyZXNoIHZub2RlIGRhdGEgb2JqZWN0cyBpbiBlYWNoIHJlbmRlciEnLCBjb250ZXh0KTsKICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgfQogIC8vIG9iamVjdCBzeW50YXggaW4gdi1iaW5kCiAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEuaXMpKSB7CiAgICB0YWcgPSBkYXRhLmlzOwogIH0KICBpZiAoIXRhZykgewogICAgLy8gaW4gY2FzZSBvZiBjb21wb25lbnQgOmlzIHNldCB0byBmYWxzeSB2YWx1ZQogICAgcmV0dXJuIGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICB9CiAgLy8gd2FybiBhZ2FpbnN0IG5vbi1wcmltaXRpdmUga2V5CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNEZWYoZGF0YSkgJiYgaXNEZWYoZGF0YS5rZXkpICYmICFpc1ByaW1pdGl2ZShkYXRhLmtleSkpIHsKICAgIHdhcm4oJ0F2b2lkIHVzaW5nIG5vbi1wcmltaXRpdmUgdmFsdWUgYXMga2V5LCAnICsgJ3VzZSBzdHJpbmcvbnVtYmVyIHZhbHVlIGluc3RlYWQuJywgY29udGV4dCk7CiAgfQogIC8vIHN1cHBvcnQgc2luZ2xlIGZ1bmN0aW9uIGNoaWxkcmVuIGFzIGRlZmF1bHQgc2NvcGVkIHNsb3QKICBpZiAoaXNBcnJheShjaGlsZHJlbikgJiYgaXNGdW5jdGlvbihjaGlsZHJlblswXSkpIHsKICAgIGRhdGEgPSBkYXRhIHx8IHt9OwogICAgZGF0YS5zY29wZWRTbG90cyA9IHsKICAgICAgZGVmYXVsdDogY2hpbGRyZW5bMF0KICAgIH07CiAgICBjaGlsZHJlbi5sZW5ndGggPSAwOwogIH0KICBpZiAobm9ybWFsaXphdGlvblR5cGUgPT09IEFMV0FZU19OT1JNQUxJWkUpIHsKICAgIGNoaWxkcmVuID0gbm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pOwogIH0gZWxzZSBpZiAobm9ybWFsaXphdGlvblR5cGUgPT09IFNJTVBMRV9OT1JNQUxJWkUpIHsKICAgIGNoaWxkcmVuID0gc2ltcGxlTm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pOwogIH0KICB2YXIgdm5vZGUsIG5zOwogIGlmICh0eXBlb2YgdGFnID09PSAnc3RyaW5nJykgewogICAgdmFyIEN0b3IgPSB2b2lkIDA7CiAgICBucyA9IGNvbnRleHQuJHZub2RlICYmIGNvbnRleHQuJHZub2RlLm5zIHx8IGNvbmZpZy5nZXRUYWdOYW1lc3BhY2UodGFnKTsKICAgIGlmIChjb25maWcuaXNSZXNlcnZlZFRhZyh0YWcpKSB7CiAgICAgIC8vIHBsYXRmb3JtIGJ1aWx0LWluIGVsZW1lbnRzCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEubmF0aXZlT24pICYmIGRhdGEudGFnICE9PSAnY29tcG9uZW50JykgewogICAgICAgIHdhcm4oIlRoZSAubmF0aXZlIG1vZGlmaWVyIGZvciB2LW9uIGlzIG9ubHkgdmFsaWQgb24gY29tcG9uZW50cyBidXQgaXQgd2FzIHVzZWQgb24gPCIuY29uY2F0KHRhZywgIj4uIiksIGNvbnRleHQpOwogICAgICB9CiAgICAgIHZub2RlID0gbmV3IFZOb2RlKGNvbmZpZy5wYXJzZVBsYXRmb3JtVGFnTmFtZSh0YWcpLCBkYXRhLCBjaGlsZHJlbiwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmICgoIWRhdGEgfHwgIWRhdGEucHJlKSAmJiBpc0RlZihDdG9yID0gcmVzb2x2ZUFzc2V0KGNvbnRleHQuJG9wdGlvbnMsICdjb21wb25lbnRzJywgdGFnKSkpIHsKICAgICAgLy8gY29tcG9uZW50CiAgICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KEN0b3IsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpOwogICAgfSBlbHNlIHsKICAgICAgLy8gdW5rbm93biBvciB1bmxpc3RlZCBuYW1lc3BhY2VkIGVsZW1lbnRzCiAgICAgIC8vIGNoZWNrIGF0IHJ1bnRpbWUgYmVjYXVzZSBpdCBtYXkgZ2V0IGFzc2lnbmVkIGEgbmFtZXNwYWNlIHdoZW4gaXRzCiAgICAgIC8vIHBhcmVudCBub3JtYWxpemVzIGNoaWxkcmVuCiAgICAgIHZub2RlID0gbmV3IFZOb2RlKHRhZywgZGF0YSwgY2hpbGRyZW4sIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZXh0KTsKICAgIH0KICB9IGVsc2UgewogICAgLy8gZGlyZWN0IGNvbXBvbmVudCBvcHRpb25zIC8gY29uc3RydWN0b3IKICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KHRhZywgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4pOwogIH0KICBpZiAoaXNBcnJheSh2bm9kZSkpIHsKICAgIHJldHVybiB2bm9kZTsKICB9IGVsc2UgaWYgKGlzRGVmKHZub2RlKSkgewogICAgaWYgKGlzRGVmKG5zKSkgYXBwbHlOUyh2bm9kZSwgbnMpOwogICAgaWYgKGlzRGVmKGRhdGEpKSByZWdpc3RlckRlZXBCaW5kaW5ncyhkYXRhKTsKICAgIHJldHVybiB2bm9kZTsKICB9IGVsc2UgewogICAgcmV0dXJuIGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICB9Cn0KZnVuY3Rpb24gYXBwbHlOUyh2bm9kZSwgbnMsIGZvcmNlKSB7CiAgdm5vZGUubnMgPSBuczsKICBpZiAodm5vZGUudGFnID09PSAnZm9yZWlnbk9iamVjdCcpIHsKICAgIC8vIHVzZSBkZWZhdWx0IG5hbWVzcGFjZSBpbnNpZGUgZm9yZWlnbk9iamVjdAogICAgbnMgPSB1bmRlZmluZWQ7CiAgICBmb3JjZSA9IHRydWU7CiAgfQogIGlmIChpc0RlZih2bm9kZS5jaGlsZHJlbikpIHsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gdm5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBjaGlsZCA9IHZub2RlLmNoaWxkcmVuW2ldOwogICAgICBpZiAoaXNEZWYoY2hpbGQudGFnKSAmJiAoaXNVbmRlZihjaGlsZC5ucykgfHwgaXNUcnVlKGZvcmNlKSAmJiBjaGlsZC50YWcgIT09ICdzdmcnKSkgewogICAgICAgIGFwcGx5TlMoY2hpbGQsIG5zLCBmb3JjZSk7CiAgICAgIH0KICAgIH0KICB9Cn0KLy8gcmVmICM1MzE4Ci8vIG5lY2Vzc2FyeSB0byBlbnN1cmUgcGFyZW50IHJlLXJlbmRlciB3aGVuIGRlZXAgYmluZGluZ3MgbGlrZSA6c3R5bGUgYW5kCi8vIDpjbGFzcyBhcmUgdXNlZCBvbiBzbG90IG5vZGVzCmZ1bmN0aW9uIHJlZ2lzdGVyRGVlcEJpbmRpbmdzKGRhdGEpIHsKICBpZiAoaXNPYmplY3QoZGF0YS5zdHlsZSkpIHsKICAgIHRyYXZlcnNlKGRhdGEuc3R5bGUpOwogIH0KICBpZiAoaXNPYmplY3QoZGF0YS5jbGFzcykpIHsKICAgIHRyYXZlcnNlKGRhdGEuY2xhc3MpOwogIH0KfQoKLyoqCiAqIEBpbnRlcm5hbCB0aGlzIGZ1bmN0aW9uIG5lZWRzIG1hbnVhbCBwdWJsaWMgdHlwZSBkZWNsYXJhdGlvbiBiZWNhdXNlIGl0IHJlbGllcwogKiBvbiBwcmV2aW91c2x5IG1hbnVhbGx5IGF1dGhvcmVkIHR5cGVzIGZyb20gVnVlIDIKICovCmZ1bmN0aW9uIGgodHlwZSwgcHJvcHMsIGNoaWxkcmVuKSB7CiAgaWYgKCFjdXJyZW50SW5zdGFuY2UpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiZ2xvYmFsbHkgaW1wb3J0ZWQgaCgpIGNhbiBvbmx5IGJlIGludm9rZWQgd2hlbiB0aGVyZSBpcyBhbiBhY3RpdmUgIiArICJjb21wb25lbnQgaW5zdGFuY2UsIGUuZy4gc3luY2hyb25vdXNseSBpbiBhIGNvbXBvbmVudCdzIHJlbmRlciBvciBzZXR1cCBmdW5jdGlvbi4iKTsKICB9CiAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQkMShjdXJyZW50SW5zdGFuY2UsIHR5cGUsIHByb3BzLCBjaGlsZHJlbiwgMiwgdHJ1ZSk7Cn0KZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyLCB2bSwgaW5mbykgewogIC8vIERlYWN0aXZhdGUgZGVwcyB0cmFja2luZyB3aGlsZSBwcm9jZXNzaW5nIGVycm9yIGhhbmRsZXIgdG8gYXZvaWQgcG9zc2libGUgaW5maW5pdGUgcmVuZGVyaW5nLgogIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL3Z1ZXgvaXNzdWVzLzE1MDUKICBwdXNoVGFyZ2V0KCk7CiAgdHJ5IHsKICAgIGlmICh2bSkgewogICAgICB2YXIgY3VyID0gdm07CiAgICAgIHdoaWxlIChjdXIgPSBjdXIuJHBhcmVudCkgewogICAgICAgIHZhciBob29rcyA9IGN1ci4kb3B0aW9ucy5lcnJvckNhcHR1cmVkOwogICAgICAgIGlmIChob29rcykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBjYXB0dXJlID0gaG9va3NbaV0uY2FsbChjdXIsIGVyciwgdm0sIGluZm8pID09PSBmYWxzZTsKICAgICAgICAgICAgICBpZiAoY2FwdHVyZSkgcmV0dXJuOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgZ2xvYmFsSGFuZGxlRXJyb3IoZSwgY3VyLCAnZXJyb3JDYXB0dXJlZCBob29rJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGdsb2JhbEhhbmRsZUVycm9yKGVyciwgdm0sIGluZm8pOwogIH0gZmluYWxseSB7CiAgICBwb3BUYXJnZXQoKTsKICB9Cn0KZnVuY3Rpb24gaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoaGFuZGxlciwgY29udGV4dCwgYXJncywgdm0sIGluZm8pIHsKICB2YXIgcmVzOwogIHRyeSB7CiAgICByZXMgPSBhcmdzID8gaGFuZGxlci5hcHBseShjb250ZXh0LCBhcmdzKSA6IGhhbmRsZXIuY2FsbChjb250ZXh0KTsKICAgIGlmIChyZXMgJiYgIXJlcy5faXNWdWUgJiYgaXNQcm9taXNlKHJlcykgJiYgIXJlcy5faGFuZGxlZCkgewogICAgICByZXMuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gaGFuZGxlRXJyb3IoZSwgdm0sIGluZm8gKyAiIChQcm9taXNlL2FzeW5jKSIpOwogICAgICB9KTsKICAgICAgcmVzLl9oYW5kbGVkID0gdHJ1ZTsKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICBoYW5kbGVFcnJvcihlLCB2bSwgaW5mbyk7CiAgfQogIHJldHVybiByZXM7Cn0KZnVuY3Rpb24gZ2xvYmFsSGFuZGxlRXJyb3IoZXJyLCB2bSwgaW5mbykgewogIGlmIChjb25maWcuZXJyb3JIYW5kbGVyKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gY29uZmlnLmVycm9ySGFuZGxlci5jYWxsKG51bGwsIGVyciwgdm0sIGluZm8pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAvLyBpZiB0aGUgdXNlciBpbnRlbnRpb25hbGx5IHRocm93cyB0aGUgb3JpZ2luYWwgZXJyb3IgaW4gdGhlIGhhbmRsZXIsCiAgICAgIC8vIGRvIG5vdCBsb2cgaXQgdHdpY2UKICAgICAgaWYgKGUgIT09IGVycikgewogICAgICAgIGxvZ0Vycm9yKGUsIG51bGwsICdjb25maWcuZXJyb3JIYW5kbGVyJyk7CiAgICAgIH0KICAgIH0KICB9CiAgbG9nRXJyb3IoZXJyLCB2bSwgaW5mbyk7Cn0KZnVuY3Rpb24gbG9nRXJyb3IoZXJyLCB2bSwgaW5mbykgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXJuKCJFcnJvciBpbiAiLmNvbmNhdChpbmZvLCAiOiBcIiIpLmNvbmNhdChlcnIudG9TdHJpbmcoKSwgIlwiIiksIHZtKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICBpZiAoaW5Ccm93c2VyICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgY29uc29sZS5lcnJvcihlcnIpOwogIH0gZWxzZSB7CiAgICB0aHJvdyBlcnI7CiAgfQp9CgovKiBnbG9iYWxzIE11dGF0aW9uT2JzZXJ2ZXIgKi8KdmFyIGlzVXNpbmdNaWNyb1Rhc2sgPSBmYWxzZTsKdmFyIGNhbGxiYWNrcyA9IFtdOwp2YXIgcGVuZGluZyA9IGZhbHNlOwpmdW5jdGlvbiBmbHVzaENhbGxiYWNrcygpIHsKICBwZW5kaW5nID0gZmFsc2U7CiAgdmFyIGNvcGllcyA9IGNhbGxiYWNrcy5zbGljZSgwKTsKICBjYWxsYmFja3MubGVuZ3RoID0gMDsKICBmb3IgKHZhciBpID0gMDsgaSA8IGNvcGllcy5sZW5ndGg7IGkrKykgewogICAgY29waWVzW2ldKCk7CiAgfQp9Ci8vIEhlcmUgd2UgaGF2ZSBhc3luYyBkZWZlcnJpbmcgd3JhcHBlcnMgdXNpbmcgbWljcm90YXNrcy4KLy8gSW4gMi41IHdlIHVzZWQgKG1hY3JvKSB0YXNrcyAoaW4gY29tYmluYXRpb24gd2l0aCBtaWNyb3Rhc2tzKS4KLy8gSG93ZXZlciwgaXQgaGFzIHN1YnRsZSBwcm9ibGVtcyB3aGVuIHN0YXRlIGlzIGNoYW5nZWQgcmlnaHQgYmVmb3JlIHJlcGFpbnQKLy8gKGUuZy4gIzY4MTMsIG91dC1pbiB0cmFuc2l0aW9ucykuCi8vIEFsc28sIHVzaW5nIChtYWNybykgdGFza3MgaW4gZXZlbnQgaGFuZGxlciB3b3VsZCBjYXVzZSBzb21lIHdlaXJkIGJlaGF2aW9ycwovLyB0aGF0IGNhbm5vdCBiZSBjaXJjdW12ZW50ZWQgKGUuZy4gIzcxMDksICM3MTUzLCAjNzU0NiwgIzc4MzQsICM4MTA5KS4KLy8gU28gd2Ugbm93IHVzZSBtaWNyb3Rhc2tzIGV2ZXJ5d2hlcmUsIGFnYWluLgovLyBBIG1ham9yIGRyYXdiYWNrIG9mIHRoaXMgdHJhZGVvZmYgaXMgdGhhdCB0aGVyZSBhcmUgc29tZSBzY2VuYXJpb3MKLy8gd2hlcmUgbWljcm90YXNrcyBoYXZlIHRvbyBoaWdoIGEgcHJpb3JpdHkgYW5kIGZpcmUgaW4gYmV0d2VlbiBzdXBwb3NlZGx5Ci8vIHNlcXVlbnRpYWwgZXZlbnRzIChlLmcuICM0NTIxLCAjNjY5MCwgd2hpY2ggaGF2ZSB3b3JrYXJvdW5kcykKLy8gb3IgZXZlbiBiZXR3ZWVuIGJ1YmJsaW5nIG9mIHRoZSBzYW1lIGV2ZW50ICgjNjU2NikuCnZhciB0aW1lckZ1bmM7Ci8vIFRoZSBuZXh0VGljayBiZWhhdmlvciBsZXZlcmFnZXMgdGhlIG1pY3JvdGFzayBxdWV1ZSwgd2hpY2ggY2FuIGJlIGFjY2Vzc2VkCi8vIHZpYSBlaXRoZXIgbmF0aXZlIFByb21pc2UudGhlbiBvciBNdXRhdGlvbk9ic2VydmVyLgovLyBNdXRhdGlvbk9ic2VydmVyIGhhcyB3aWRlciBzdXBwb3J0LCBob3dldmVyIGl0IGlzIHNlcmlvdXNseSBidWdnZWQgaW4KLy8gVUlXZWJWaWV3IGluIGlPUyA+PSA5LjMuMyB3aGVuIHRyaWdnZXJlZCBpbiB0b3VjaCBldmVudCBoYW5kbGVycy4gSXQKLy8gY29tcGxldGVseSBzdG9wcyB3b3JraW5nIGFmdGVyIHRyaWdnZXJpbmcgYSBmZXcgdGltZXMuLi4gc28sIGlmIG5hdGl2ZQovLyBQcm9taXNlIGlzIGF2YWlsYWJsZSwgd2Ugd2lsbCB1c2UgaXQ6Ci8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0LCAkZmxvdy1kaXNhYmxlLWxpbmUgKi8KaWYgKHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShQcm9taXNlKSkgewogIHZhciBwXzEgPSBQcm9taXNlLnJlc29sdmUoKTsKICB0aW1lckZ1bmMgPSBmdW5jdGlvbiB0aW1lckZ1bmMoKSB7CiAgICBwXzEudGhlbihmbHVzaENhbGxiYWNrcyk7CiAgICAvLyBJbiBwcm9ibGVtYXRpYyBVSVdlYlZpZXdzLCBQcm9taXNlLnRoZW4gZG9lc24ndCBjb21wbGV0ZWx5IGJyZWFrLCBidXQKICAgIC8vIGl0IGNhbiBnZXQgc3R1Y2sgaW4gYSB3ZWlyZCBzdGF0ZSB3aGVyZSBjYWxsYmFja3MgYXJlIHB1c2hlZCBpbnRvIHRoZQogICAgLy8gbWljcm90YXNrIHF1ZXVlIGJ1dCB0aGUgcXVldWUgaXNuJ3QgYmVpbmcgZmx1c2hlZCwgdW50aWwgdGhlIGJyb3dzZXIKICAgIC8vIG5lZWRzIHRvIGRvIHNvbWUgb3RoZXIgd29yaywgZS5nLiBoYW5kbGUgYSB0aW1lci4gVGhlcmVmb3JlIHdlIGNhbgogICAgLy8gImZvcmNlIiB0aGUgbWljcm90YXNrIHF1ZXVlIHRvIGJlIGZsdXNoZWQgYnkgYWRkaW5nIGFuIGVtcHR5IHRpbWVyLgogICAgaWYgKGlzSU9TKSBzZXRUaW1lb3V0KG5vb3ApOwogIH07CiAgaXNVc2luZ01pY3JvVGFzayA9IHRydWU7Cn0gZWxzZSBpZiAoIWlzSUUgJiYgdHlwZW9mIE11dGF0aW9uT2JzZXJ2ZXIgIT09ICd1bmRlZmluZWQnICYmIChpc05hdGl2ZShNdXRhdGlvbk9ic2VydmVyKSB8fAovLyBQaGFudG9tSlMgYW5kIGlPUyA3LngKTXV0YXRpb25PYnNlcnZlci50b1N0cmluZygpID09PSAnW29iamVjdCBNdXRhdGlvbk9ic2VydmVyQ29uc3RydWN0b3JdJykpIHsKICAvLyBVc2UgTXV0YXRpb25PYnNlcnZlciB3aGVyZSBuYXRpdmUgUHJvbWlzZSBpcyBub3QgYXZhaWxhYmxlLAogIC8vIGUuZy4gUGhhbnRvbUpTLCBpT1M3LCBBbmRyb2lkIDQuNAogIC8vICgjNjQ2NiBNdXRhdGlvbk9ic2VydmVyIGlzIHVucmVsaWFibGUgaW4gSUUxMSkKICB2YXIgY291bnRlcl8xID0gMTsKICB2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmbHVzaENhbGxiYWNrcyk7CiAgdmFyIHRleHROb2RlXzEgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShTdHJpbmcoY291bnRlcl8xKSk7CiAgb2JzZXJ2ZXIub2JzZXJ2ZSh0ZXh0Tm9kZV8xLCB7CiAgICBjaGFyYWN0ZXJEYXRhOiB0cnVlCiAgfSk7CiAgdGltZXJGdW5jID0gZnVuY3Rpb24gdGltZXJGdW5jKCkgewogICAgY291bnRlcl8xID0gKGNvdW50ZXJfMSArIDEpICUgMjsKICAgIHRleHROb2RlXzEuZGF0YSA9IFN0cmluZyhjb3VudGVyXzEpOwogIH07CiAgaXNVc2luZ01pY3JvVGFzayA9IHRydWU7Cn0gZWxzZSBpZiAodHlwZW9mIHNldEltbWVkaWF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoc2V0SW1tZWRpYXRlKSkgewogIC8vIEZhbGxiYWNrIHRvIHNldEltbWVkaWF0ZS4KICAvLyBUZWNobmljYWxseSBpdCBsZXZlcmFnZXMgdGhlIChtYWNybykgdGFzayBxdWV1ZSwKICAvLyBidXQgaXQgaXMgc3RpbGwgYSBiZXR0ZXIgY2hvaWNlIHRoYW4gc2V0VGltZW91dC4KICB0aW1lckZ1bmMgPSBmdW5jdGlvbiB0aW1lckZ1bmMoKSB7CiAgICBzZXRJbW1lZGlhdGUoZmx1c2hDYWxsYmFja3MpOwogIH07Cn0gZWxzZSB7CiAgLy8gRmFsbGJhY2sgdG8gc2V0VGltZW91dC4KICB0aW1lckZ1bmMgPSBmdW5jdGlvbiB0aW1lckZ1bmMoKSB7CiAgICBzZXRUaW1lb3V0KGZsdXNoQ2FsbGJhY2tzLCAwKTsKICB9Owp9Ci8qKgogKiBAaW50ZXJuYWwKICovCmZ1bmN0aW9uIG5leHRUaWNrKGNiLCBjdHgpIHsKICB2YXIgX3Jlc29sdmU7CiAgY2FsbGJhY2tzLnB1c2goZnVuY3Rpb24gKCkgewogICAgaWYgKGNiKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY2IuY2FsbChjdHgpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaGFuZGxlRXJyb3IoZSwgY3R4LCAnbmV4dFRpY2snKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChfcmVzb2x2ZSkgewogICAgICBfcmVzb2x2ZShjdHgpOwogICAgfQogIH0pOwogIGlmICghcGVuZGluZykgewogICAgcGVuZGluZyA9IHRydWU7CiAgICB0aW1lckZ1bmMoKTsKICB9CiAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgaWYgKCFjYiAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICBfcmVzb2x2ZSA9IHJlc29sdmU7CiAgICB9KTsKICB9Cn0KZnVuY3Rpb24gdXNlQ3NzTW9kdWxlKG5hbWUpIHsKICBpZiAobmFtZSA9PT0gdm9pZCAwKSB7CiAgICBuYW1lID0gJyRzdHlsZSc7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgewogICAgaWYgKCFjdXJyZW50SW5zdGFuY2UpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJ1c2VDc3NNb2R1bGUgbXVzdCBiZSBjYWxsZWQgaW5zaWRlIHNldHVwKCkiKTsKICAgICAgcmV0dXJuIGVtcHR5T2JqZWN0OwogICAgfQogICAgdmFyIG1vZCA9IGN1cnJlbnRJbnN0YW5jZVtuYW1lXTsKICAgIGlmICghbW9kKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiQ3VycmVudCBpbnN0YW5jZSBkb2VzIG5vdCBoYXZlIENTUyBtb2R1bGUgbmFtZWQgXCIiLmNvbmNhdChuYW1lLCAiXCIuIikpOwogICAgICByZXR1cm4gZW1wdHlPYmplY3Q7CiAgICB9CiAgICByZXR1cm4gbW9kOwogIH0KfQoKLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciBTRkMncyBDU1MgdmFyaWFibGUgaW5qZWN0aW9uIGZlYXR1cmUuCiAqIEBwcml2YXRlCiAqLwpmdW5jdGlvbiB1c2VDc3NWYXJzKGdldHRlcikgewogIGlmICghaW5Ccm93c2VyICYmICFmYWxzZSkgcmV0dXJuOwogIHZhciBpbnN0YW5jZSA9IGN1cnJlbnRJbnN0YW5jZTsKICBpZiAoIWluc3RhbmNlKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oInVzZUNzc1ZhcnMgaXMgY2FsbGVkIHdpdGhvdXQgY3VycmVudCBhY3RpdmUgY29tcG9uZW50IGluc3RhbmNlLiIpOwogICAgcmV0dXJuOwogIH0KICB3YXRjaFBvc3RFZmZlY3QoZnVuY3Rpb24gKCkgewogICAgdmFyIGVsID0gaW5zdGFuY2UuJGVsOwogICAgdmFyIHZhcnMgPSBnZXR0ZXIoaW5zdGFuY2UsIGluc3RhbmNlLl9zZXR1cFByb3h5KTsKICAgIGlmIChlbCAmJiBlbC5ub2RlVHlwZSA9PT0gMSkgewogICAgICB2YXIgc3R5bGUgPSBlbC5zdHlsZTsKICAgICAgZm9yICh2YXIga2V5IGluIHZhcnMpIHsKICAgICAgICBzdHlsZS5zZXRQcm9wZXJ0eSgiLS0iLmNvbmNhdChrZXkpLCB2YXJzW2tleV0pOwogICAgICB9CiAgICB9CiAgfSk7Cn0KCi8qKgogKiB2My1jb21wYXRpYmxlIGFzeW5jIGNvbXBvbmVudCBBUEkuCiAqIEBpbnRlcm5hbCB0aGUgdHlwZSBpcyBtYW51YWxseSBkZWNsYXJlZCBpbiA8cm9vdD4vdHlwZXMvdjMtZGVmaW5lLWFzeW5jLWNvbXBvbmVudC5kLnRzCiAqIGJlY2F1c2UgaXQgcmVsaWVzIG9uIGV4aXN0aW5nIG1hbnVhbCB0eXBlcwogKi8KZnVuY3Rpb24gZGVmaW5lQXN5bmNDb21wb25lbnQoc291cmNlKSB7CiAgaWYgKGlzRnVuY3Rpb24oc291cmNlKSkgewogICAgc291cmNlID0gewogICAgICBsb2FkZXI6IHNvdXJjZQogICAgfTsKICB9CiAgdmFyIGxvYWRlciA9IHNvdXJjZS5sb2FkZXIsCiAgICBsb2FkaW5nQ29tcG9uZW50ID0gc291cmNlLmxvYWRpbmdDb21wb25lbnQsCiAgICBlcnJvckNvbXBvbmVudCA9IHNvdXJjZS5lcnJvckNvbXBvbmVudCwKICAgIF9hID0gc291cmNlLmRlbGF5LAogICAgZGVsYXkgPSBfYSA9PT0gdm9pZCAwID8gMjAwIDogX2EsCiAgICB0aW1lb3V0ID0gc291cmNlLnRpbWVvdXQsCiAgICAvLyB1bmRlZmluZWQgPSBuZXZlciB0aW1lcyBvdXQKICAgIF9iID0gc291cmNlLnN1c3BlbnNpYmxlLAogICAgLy8gdW5kZWZpbmVkID0gbmV2ZXIgdGltZXMgb3V0CiAgICBzdXNwZW5zaWJsZSA9IF9iID09PSB2b2lkIDAgPyBmYWxzZSA6IF9iLAogICAgLy8gaW4gVnVlIDMgZGVmYXVsdCBpcyB0cnVlCiAgICB1c2VyT25FcnJvciA9IHNvdXJjZS5vbkVycm9yOwogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHN1c3BlbnNpYmxlKSB7CiAgICB3YXJuKCJUaGUgc3VzcGVuc2libGJlIG9wdGlvbiBmb3IgYXN5bmMgY29tcG9uZW50cyBpcyBub3Qgc3VwcG9ydGVkIGluIFZ1ZTIuIEl0IGlzIGlnbm9yZWQuIik7CiAgfQogIHZhciBwZW5kaW5nUmVxdWVzdCA9IG51bGw7CiAgdmFyIHJldHJpZXMgPSAwOwogIHZhciByZXRyeSA9IGZ1bmN0aW9uIHJldHJ5KCkgewogICAgcmV0cmllcysrOwogICAgcGVuZGluZ1JlcXVlc3QgPSBudWxsOwogICAgcmV0dXJuIGxvYWQoKTsKICB9OwogIHZhciBsb2FkID0gZnVuY3Rpb24gbG9hZCgpIHsKICAgIHZhciB0aGlzUmVxdWVzdDsKICAgIHJldHVybiBwZW5kaW5nUmVxdWVzdCB8fCAodGhpc1JlcXVlc3QgPSBwZW5kaW5nUmVxdWVzdCA9IGxvYWRlcigpLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgZXJyID0gZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIgOiBuZXcgRXJyb3IoU3RyaW5nKGVycikpOwogICAgICBpZiAodXNlck9uRXJyb3IpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgdmFyIHVzZXJSZXRyeSA9IGZ1bmN0aW9uIHVzZXJSZXRyeSgpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmV0cnkoKSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHVzZXJGYWlsID0gZnVuY3Rpb24gdXNlckZhaWwoKSB7CiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTsKICAgICAgICAgIH07CiAgICAgICAgICB1c2VyT25FcnJvcihlcnIsIHVzZXJSZXRyeSwgdXNlckZhaWwsIHJldHJpZXMgKyAxKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBlcnI7CiAgICAgIH0KICAgIH0pLnRoZW4oZnVuY3Rpb24gKGNvbXApIHsKICAgICAgaWYgKHRoaXNSZXF1ZXN0ICE9PSBwZW5kaW5nUmVxdWVzdCAmJiBwZW5kaW5nUmVxdWVzdCkgewogICAgICAgIHJldHVybiBwZW5kaW5nUmVxdWVzdDsKICAgICAgfQogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhY29tcCkgewogICAgICAgIHdhcm4oIkFzeW5jIGNvbXBvbmVudCBsb2FkZXIgcmVzb2x2ZWQgdG8gdW5kZWZpbmVkLiAiICsgIklmIHlvdSBhcmUgdXNpbmcgcmV0cnkoKSwgbWFrZSBzdXJlIHRvIHJldHVybiBpdHMgcmV0dXJuIHZhbHVlLiIpOwogICAgICB9CiAgICAgIC8vIGludGVyb3AgbW9kdWxlIGRlZmF1bHQKICAgICAgaWYgKGNvbXAgJiYgKGNvbXAuX19lc01vZHVsZSB8fCBjb21wW1N5bWJvbC50b1N0cmluZ1RhZ10gPT09ICdNb2R1bGUnKSkgewogICAgICAgIGNvbXAgPSBjb21wLmRlZmF1bHQ7CiAgICAgIH0KICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29tcCAmJiAhaXNPYmplY3QoY29tcCkgJiYgIWlzRnVuY3Rpb24oY29tcCkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgYXN5bmMgY29tcG9uZW50IGxvYWQgcmVzdWx0OiAiLmNvbmNhdChjb21wKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbXA7CiAgICB9KSk7CiAgfTsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbXBvbmVudCA9IGxvYWQoKTsKICAgIHJldHVybiB7CiAgICAgIGNvbXBvbmVudDogY29tcG9uZW50LAogICAgICBkZWxheTogZGVsYXksCiAgICAgIHRpbWVvdXQ6IHRpbWVvdXQsCiAgICAgIGVycm9yOiBlcnJvckNvbXBvbmVudCwKICAgICAgbG9hZGluZzogbG9hZGluZ0NvbXBvbmVudAogICAgfTsKICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZUxpZmVDeWNsZShob29rTmFtZSkgewogIHJldHVybiBmdW5jdGlvbiAoZm4sIHRhcmdldCkgewogICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgIHRhcmdldCA9IGN1cnJlbnRJbnN0YW5jZTsKICAgIH0KICAgIGlmICghdGFyZ2V0KSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiIi5jb25jYXQoZm9ybWF0TmFtZShob29rTmFtZSksICIgaXMgY2FsbGVkIHdoZW4gdGhlcmUgaXMgbm8gYWN0aXZlIGNvbXBvbmVudCBpbnN0YW5jZSB0byBiZSAiKSArICJhc3NvY2lhdGVkIHdpdGguICIgKyAiTGlmZWN5Y2xlIGluamVjdGlvbiBBUElzIGNhbiBvbmx5IGJlIHVzZWQgZHVyaW5nIGV4ZWN1dGlvbiBvZiBzZXR1cCgpLiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gaW5qZWN0SG9vayh0YXJnZXQsIGhvb2tOYW1lLCBmbik7CiAgfTsKfQpmdW5jdGlvbiBmb3JtYXROYW1lKG5hbWUpIHsKICBpZiAobmFtZSA9PT0gJ2JlZm9yZURlc3Ryb3knKSB7CiAgICBuYW1lID0gJ2JlZm9yZVVubW91bnQnOwogIH0gZWxzZSBpZiAobmFtZSA9PT0gJ2Rlc3Ryb3llZCcpIHsKICAgIG5hbWUgPSAndW5tb3VudGVkJzsKICB9CiAgcmV0dXJuICJvbiIuY29uY2F0KG5hbWVbMF0udG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwp9CmZ1bmN0aW9uIGluamVjdEhvb2soaW5zdGFuY2UsIGhvb2tOYW1lLCBmbikgewogIHZhciBvcHRpb25zID0gaW5zdGFuY2UuJG9wdGlvbnM7CiAgb3B0aW9uc1tob29rTmFtZV0gPSBtZXJnZUxpZmVjeWNsZUhvb2sob3B0aW9uc1tob29rTmFtZV0sIGZuKTsKfQp2YXIgb25CZWZvcmVNb3VudCA9IGNyZWF0ZUxpZmVDeWNsZSgnYmVmb3JlTW91bnQnKTsKdmFyIG9uTW91bnRlZCA9IGNyZWF0ZUxpZmVDeWNsZSgnbW91bnRlZCcpOwp2YXIgb25CZWZvcmVVcGRhdGUgPSBjcmVhdGVMaWZlQ3ljbGUoJ2JlZm9yZVVwZGF0ZScpOwp2YXIgb25VcGRhdGVkID0gY3JlYXRlTGlmZUN5Y2xlKCd1cGRhdGVkJyk7CnZhciBvbkJlZm9yZVVubW91bnQgPSBjcmVhdGVMaWZlQ3ljbGUoJ2JlZm9yZURlc3Ryb3knKTsKdmFyIG9uVW5tb3VudGVkID0gY3JlYXRlTGlmZUN5Y2xlKCdkZXN0cm95ZWQnKTsKdmFyIG9uQWN0aXZhdGVkID0gY3JlYXRlTGlmZUN5Y2xlKCdhY3RpdmF0ZWQnKTsKdmFyIG9uRGVhY3RpdmF0ZWQgPSBjcmVhdGVMaWZlQ3ljbGUoJ2RlYWN0aXZhdGVkJyk7CnZhciBvblNlcnZlclByZWZldGNoID0gY3JlYXRlTGlmZUN5Y2xlKCdzZXJ2ZXJQcmVmZXRjaCcpOwp2YXIgb25SZW5kZXJUcmFja2VkID0gY3JlYXRlTGlmZUN5Y2xlKCdyZW5kZXJUcmFja2VkJyk7CnZhciBvblJlbmRlclRyaWdnZXJlZCA9IGNyZWF0ZUxpZmVDeWNsZSgncmVuZGVyVHJpZ2dlcmVkJyk7CnZhciBpbmplY3RFcnJvckNhcHR1cmVkSG9vayA9IGNyZWF0ZUxpZmVDeWNsZSgnZXJyb3JDYXB0dXJlZCcpOwpmdW5jdGlvbiBvbkVycm9yQ2FwdHVyZWQoaG9vaywgdGFyZ2V0KSB7CiAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICB0YXJnZXQgPSBjdXJyZW50SW5zdGFuY2U7CiAgfQogIGluamVjdEVycm9yQ2FwdHVyZWRIb29rKGhvb2ssIHRhcmdldCk7Cn0KCi8qKgogKiBOb3RlOiBhbHNvIHVwZGF0ZSBkaXN0L3Z1ZS5ydW50aW1lLm1qcyB3aGVuIGFkZGluZyBuZXcgZXhwb3J0cyB0byB0aGlzIGZpbGUuCiAqLwp2YXIgdmVyc2lvbiA9ICcyLjcuMTQnOwovKioKICogQGludGVybmFsIHR5cGUgaXMgbWFudWFsbHkgZGVjbGFyZWQgaW4gPHJvb3Q+L3R5cGVzL3YzLWRlZmluZS1jb21wb25lbnQuZC50cwogKi8KZnVuY3Rpb24gZGVmaW5lQ29tcG9uZW50KG9wdGlvbnMpIHsKICByZXR1cm4gb3B0aW9uczsKfQp2YXIgc2Vlbk9iamVjdHMgPSBuZXcgX1NldCgpOwovKioKICogUmVjdXJzaXZlbHkgdHJhdmVyc2UgYW4gb2JqZWN0IHRvIGV2b2tlIGFsbCBjb252ZXJ0ZWQKICogZ2V0dGVycywgc28gdGhhdCBldmVyeSBuZXN0ZWQgcHJvcGVydHkgaW5zaWRlIHRoZSBvYmplY3QKICogaXMgY29sbGVjdGVkIGFzIGEgImRlZXAiIGRlcGVuZGVuY3kuCiAqLwpmdW5jdGlvbiB0cmF2ZXJzZSh2YWwpIHsKICBfdHJhdmVyc2UodmFsLCBzZWVuT2JqZWN0cyk7CiAgc2Vlbk9iamVjdHMuY2xlYXIoKTsKICByZXR1cm4gdmFsOwp9CmZ1bmN0aW9uIF90cmF2ZXJzZSh2YWwsIHNlZW4pIHsKICB2YXIgaSwga2V5czsKICB2YXIgaXNBID0gaXNBcnJheSh2YWwpOwogIGlmICghaXNBICYmICFpc09iamVjdCh2YWwpIHx8IHZhbC5fX3Zfc2tpcCAvKiBSZWFjdGl2ZUZsYWdzLlNLSVAgKi8gfHwgT2JqZWN0LmlzRnJvemVuKHZhbCkgfHwgdmFsIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKHZhbC5fX29iX18pIHsKICAgIHZhciBkZXBJZCA9IHZhbC5fX29iX18uZGVwLmlkOwogICAgaWYgKHNlZW4uaGFzKGRlcElkKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzZWVuLmFkZChkZXBJZCk7CiAgfQogIGlmIChpc0EpIHsKICAgIGkgPSB2YWwubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgX3RyYXZlcnNlKHZhbFtpXSwgc2Vlbik7CiAgfSBlbHNlIGlmIChpc1JlZih2YWwpKSB7CiAgICBfdHJhdmVyc2UodmFsLnZhbHVlLCBzZWVuKTsKICB9IGVsc2UgewogICAga2V5cyA9IE9iamVjdC5rZXlzKHZhbCk7CiAgICBpID0ga2V5cy5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSBfdHJhdmVyc2UodmFsW2tleXNbaV1dLCBzZWVuKTsKICB9Cn0KdmFyIHVpZCQxID0gMDsKLyoqCiAqIEEgd2F0Y2hlciBwYXJzZXMgYW4gZXhwcmVzc2lvbiwgY29sbGVjdHMgZGVwZW5kZW5jaWVzLAogKiBhbmQgZmlyZXMgY2FsbGJhY2sgd2hlbiB0aGUgZXhwcmVzc2lvbiB2YWx1ZSBjaGFuZ2VzLgogKiBUaGlzIGlzIHVzZWQgZm9yIGJvdGggdGhlICR3YXRjaCgpIGFwaSBhbmQgZGlyZWN0aXZlcy4KICogQGludGVybmFsCiAqLwp2YXIgV2F0Y2hlciA9IC8qKiBAY2xhc3MgKi9mdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gV2F0Y2hlcih2bSwgZXhwT3JGbiwgY2IsIG9wdGlvbnMsIGlzUmVuZGVyV2F0Y2hlcikgewogICAgcmVjb3JkRWZmZWN0U2NvcGUodGhpcywKICAgIC8vIGlmIHRoZSBhY3RpdmUgZWZmZWN0IHNjb3BlIGlzIG1hbnVhbGx5IGNyZWF0ZWQgKG5vdCBhIGNvbXBvbmVudCBzY29wZSksCiAgICAvLyBwcmlvcml0aXplIGl0CiAgICBhY3RpdmVFZmZlY3RTY29wZSAmJiAhYWN0aXZlRWZmZWN0U2NvcGUuX3ZtID8gYWN0aXZlRWZmZWN0U2NvcGUgOiB2bSA/IHZtLl9zY29wZSA6IHVuZGVmaW5lZCk7CiAgICBpZiAoKHRoaXMudm0gPSB2bSkgJiYgaXNSZW5kZXJXYXRjaGVyKSB7CiAgICAgIHZtLl93YXRjaGVyID0gdGhpczsKICAgIH0KICAgIC8vIG9wdGlvbnMKICAgIGlmIChvcHRpb25zKSB7CiAgICAgIHRoaXMuZGVlcCA9ICEhb3B0aW9ucy5kZWVwOwogICAgICB0aGlzLnVzZXIgPSAhIW9wdGlvbnMudXNlcjsKICAgICAgdGhpcy5sYXp5ID0gISFvcHRpb25zLmxhenk7CiAgICAgIHRoaXMuc3luYyA9ICEhb3B0aW9ucy5zeW5jOwogICAgICB0aGlzLmJlZm9yZSA9IG9wdGlvbnMuYmVmb3JlOwogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIHRoaXMub25UcmFjayA9IG9wdGlvbnMub25UcmFjazsKICAgICAgICB0aGlzLm9uVHJpZ2dlciA9IG9wdGlvbnMub25UcmlnZ2VyOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLmRlZXAgPSB0aGlzLnVzZXIgPSB0aGlzLmxhenkgPSB0aGlzLnN5bmMgPSBmYWxzZTsKICAgIH0KICAgIHRoaXMuY2IgPSBjYjsKICAgIHRoaXMuaWQgPSArK3VpZCQxOyAvLyB1aWQgZm9yIGJhdGNoaW5nCiAgICB0aGlzLmFjdGl2ZSA9IHRydWU7CiAgICB0aGlzLnBvc3QgPSBmYWxzZTsKICAgIHRoaXMuZGlydHkgPSB0aGlzLmxhenk7IC8vIGZvciBsYXp5IHdhdGNoZXJzCiAgICB0aGlzLmRlcHMgPSBbXTsKICAgIHRoaXMubmV3RGVwcyA9IFtdOwogICAgdGhpcy5kZXBJZHMgPSBuZXcgX1NldCgpOwogICAgdGhpcy5uZXdEZXBJZHMgPSBuZXcgX1NldCgpOwogICAgdGhpcy5leHByZXNzaW9uID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IGV4cE9yRm4udG9TdHJpbmcoKSA6ICcnOwogICAgLy8gcGFyc2UgZXhwcmVzc2lvbiBmb3IgZ2V0dGVyCiAgICBpZiAoaXNGdW5jdGlvbihleHBPckZuKSkgewogICAgICB0aGlzLmdldHRlciA9IGV4cE9yRm47CiAgICB9IGVsc2UgewogICAgICB0aGlzLmdldHRlciA9IHBhcnNlUGF0aChleHBPckZuKTsKICAgICAgaWYgKCF0aGlzLmdldHRlcikgewogICAgICAgIHRoaXMuZ2V0dGVyID0gbm9vcDsKICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkZhaWxlZCB3YXRjaGluZyBwYXRoOiBcIiIuY29uY2F0KGV4cE9yRm4sICJcIiAiKSArICdXYXRjaGVyIG9ubHkgYWNjZXB0cyBzaW1wbGUgZG90LWRlbGltaXRlZCBwYXRocy4gJyArICdGb3IgZnVsbCBjb250cm9sLCB1c2UgYSBmdW5jdGlvbiBpbnN0ZWFkLicsIHZtKTsKICAgICAgfQogICAgfQogICAgdGhpcy52YWx1ZSA9IHRoaXMubGF6eSA/IHVuZGVmaW5lZCA6IHRoaXMuZ2V0KCk7CiAgfQogIC8qKgogICAqIEV2YWx1YXRlIHRoZSBnZXR0ZXIsIGFuZCByZS1jb2xsZWN0IGRlcGVuZGVuY2llcy4KICAgKi8KICBXYXRjaGVyLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAoKSB7CiAgICBwdXNoVGFyZ2V0KHRoaXMpOwogICAgdmFyIHZhbHVlOwogICAgdmFyIHZtID0gdGhpcy52bTsKICAgIHRyeSB7CiAgICAgIHZhbHVlID0gdGhpcy5nZXR0ZXIuY2FsbCh2bSwgdm0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICBpZiAodGhpcy51c2VyKSB7CiAgICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICJnZXR0ZXIgZm9yIHdhdGNoZXIgXCIiLmNvbmNhdCh0aGlzLmV4cHJlc3Npb24sICJcIiIpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBlOwogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICAvLyAidG91Y2giIGV2ZXJ5IHByb3BlcnR5IHNvIHRoZXkgYXJlIGFsbCB0cmFja2VkIGFzCiAgICAgIC8vIGRlcGVuZGVuY2llcyBmb3IgZGVlcCB3YXRjaGluZwogICAgICBpZiAodGhpcy5kZWVwKSB7CiAgICAgICAgdHJhdmVyc2UodmFsdWUpOwogICAgICB9CiAgICAgIHBvcFRhcmdldCgpOwogICAgICB0aGlzLmNsZWFudXBEZXBzKCk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICAvKioKICAgKiBBZGQgYSBkZXBlbmRlbmN5IHRvIHRoaXMgZGlyZWN0aXZlLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLmFkZERlcCA9IGZ1bmN0aW9uIChkZXApIHsKICAgIHZhciBpZCA9IGRlcC5pZDsKICAgIGlmICghdGhpcy5uZXdEZXBJZHMuaGFzKGlkKSkgewogICAgICB0aGlzLm5ld0RlcElkcy5hZGQoaWQpOwogICAgICB0aGlzLm5ld0RlcHMucHVzaChkZXApOwogICAgICBpZiAoIXRoaXMuZGVwSWRzLmhhcyhpZCkpIHsKICAgICAgICBkZXAuYWRkU3ViKHRoaXMpOwogICAgICB9CiAgICB9CiAgfTsKICAvKioKICAgKiBDbGVhbiB1cCBmb3IgZGVwZW5kZW5jeSBjb2xsZWN0aW9uLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLmNsZWFudXBEZXBzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGkgPSB0aGlzLmRlcHMubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICB2YXIgZGVwID0gdGhpcy5kZXBzW2ldOwogICAgICBpZiAoIXRoaXMubmV3RGVwSWRzLmhhcyhkZXAuaWQpKSB7CiAgICAgICAgZGVwLnJlbW92ZVN1Yih0aGlzKTsKICAgICAgfQogICAgfQogICAgdmFyIHRtcCA9IHRoaXMuZGVwSWRzOwogICAgdGhpcy5kZXBJZHMgPSB0aGlzLm5ld0RlcElkczsKICAgIHRoaXMubmV3RGVwSWRzID0gdG1wOwogICAgdGhpcy5uZXdEZXBJZHMuY2xlYXIoKTsKICAgIHRtcCA9IHRoaXMuZGVwczsKICAgIHRoaXMuZGVwcyA9IHRoaXMubmV3RGVwczsKICAgIHRoaXMubmV3RGVwcyA9IHRtcDsKICAgIHRoaXMubmV3RGVwcy5sZW5ndGggPSAwOwogIH07CiAgLyoqCiAgICogU3Vic2NyaWJlciBpbnRlcmZhY2UuCiAgICogV2lsbCBiZSBjYWxsZWQgd2hlbiBhIGRlcGVuZGVuY3kgY2hhbmdlcy4KICAgKi8KICBXYXRjaGVyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgaWYgKHRoaXMubGF6eSkgewogICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAodGhpcy5zeW5jKSB7CiAgICAgIHRoaXMucnVuKCk7CiAgICB9IGVsc2UgewogICAgICBxdWV1ZVdhdGNoZXIodGhpcyk7CiAgICB9CiAgfTsKICAvKioKICAgKiBTY2hlZHVsZXIgam9iIGludGVyZmFjZS4KICAgKiBXaWxsIGJlIGNhbGxlZCBieSB0aGUgc2NoZWR1bGVyLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmFjdGl2ZSkgewogICAgICB2YXIgdmFsdWUgPSB0aGlzLmdldCgpOwogICAgICBpZiAodmFsdWUgIT09IHRoaXMudmFsdWUgfHwKICAgICAgLy8gRGVlcCB3YXRjaGVycyBhbmQgd2F0Y2hlcnMgb24gT2JqZWN0L0FycmF5cyBzaG91bGQgZmlyZSBldmVuCiAgICAgIC8vIHdoZW4gdGhlIHZhbHVlIGlzIHRoZSBzYW1lLCBiZWNhdXNlIHRoZSB2YWx1ZSBtYXkKICAgICAgLy8gaGF2ZSBtdXRhdGVkLgogICAgICBpc09iamVjdCh2YWx1ZSkgfHwgdGhpcy5kZWVwKSB7CiAgICAgICAgLy8gc2V0IG5ldyB2YWx1ZQogICAgICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMudmFsdWU7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIGlmICh0aGlzLnVzZXIpIHsKICAgICAgICAgIHZhciBpbmZvID0gImNhbGxiYWNrIGZvciB3YXRjaGVyIFwiIi5jb25jYXQodGhpcy5leHByZXNzaW9uLCAiXCIiKTsKICAgICAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKHRoaXMuY2IsIHRoaXMudm0sIFt2YWx1ZSwgb2xkVmFsdWVdLCB0aGlzLnZtLCBpbmZvKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5jYi5jYWxsKHRoaXMudm0sIHZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKICAvKioKICAgKiBFdmFsdWF0ZSB0aGUgdmFsdWUgb2YgdGhlIHdhdGNoZXIuCiAgICogVGhpcyBvbmx5IGdldHMgY2FsbGVkIGZvciBsYXp5IHdhdGNoZXJzLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLmV2YWx1YXRlID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy52YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CiAgfTsKICAvKioKICAgKiBEZXBlbmQgb24gYWxsIGRlcHMgY29sbGVjdGVkIGJ5IHRoaXMgd2F0Y2hlci4KICAgKi8KICBXYXRjaGVyLnByb3RvdHlwZS5kZXBlbmQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgaSA9IHRoaXMuZGVwcy5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHRoaXMuZGVwc1tpXS5kZXBlbmQoKTsKICAgIH0KICB9OwogIC8qKgogICAqIFJlbW92ZSBzZWxmIGZyb20gYWxsIGRlcGVuZGVuY2llcycgc3Vic2NyaWJlciBsaXN0LgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMudm0gJiYgIXRoaXMudm0uX2lzQmVpbmdEZXN0cm95ZWQpIHsKICAgICAgcmVtb3ZlJDIodGhpcy52bS5fc2NvcGUuZWZmZWN0cywgdGhpcyk7CiAgICB9CiAgICBpZiAodGhpcy5hY3RpdmUpIHsKICAgICAgdmFyIGkgPSB0aGlzLmRlcHMubGVuZ3RoOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgdGhpcy5kZXBzW2ldLnJlbW92ZVN1Yih0aGlzKTsKICAgICAgfQogICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgICBpZiAodGhpcy5vblN0b3ApIHsKICAgICAgICB0aGlzLm9uU3RvcCgpOwogICAgICB9CiAgICB9CiAgfTsKICByZXR1cm4gV2F0Y2hlcjsKfSgpOwp2YXIgbWFyazsKdmFyIG1lYXN1cmU7CmlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgdmFyIHBlcmZfMSA9IGluQnJvd3NlciAmJiB3aW5kb3cucGVyZm9ybWFuY2U7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKHBlcmZfMSAmJgogIC8vIEB0cy1pZ25vcmUKICBwZXJmXzEubWFyayAmJgogIC8vIEB0cy1pZ25vcmUKICBwZXJmXzEubWVhc3VyZSAmJgogIC8vIEB0cy1pZ25vcmUKICBwZXJmXzEuY2xlYXJNYXJrcyAmJgogIC8vIEB0cy1pZ25vcmUKICBwZXJmXzEuY2xlYXJNZWFzdXJlcykgewogICAgbWFyayA9IGZ1bmN0aW9uIG1hcmsodGFnKSB7CiAgICAgIHJldHVybiBwZXJmXzEubWFyayh0YWcpOwogICAgfTsKICAgIG1lYXN1cmUgPSBmdW5jdGlvbiBtZWFzdXJlKG5hbWUsIHN0YXJ0VGFnLCBlbmRUYWcpIHsKICAgICAgcGVyZl8xLm1lYXN1cmUobmFtZSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICAgIHBlcmZfMS5jbGVhck1hcmtzKHN0YXJ0VGFnKTsKICAgICAgcGVyZl8xLmNsZWFyTWFya3MoZW5kVGFnKTsKICAgICAgLy8gcGVyZi5jbGVhck1lYXN1cmVzKG5hbWUpCiAgICB9OwogIH0KfQoKZnVuY3Rpb24gaW5pdEV2ZW50cyh2bSkgewogIHZtLl9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIHZtLl9oYXNIb29rRXZlbnQgPSBmYWxzZTsKICAvLyBpbml0IHBhcmVudCBhdHRhY2hlZCBldmVudHMKICB2YXIgbGlzdGVuZXJzID0gdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczsKICBpZiAobGlzdGVuZXJzKSB7CiAgICB1cGRhdGVDb21wb25lbnRMaXN0ZW5lcnModm0sIGxpc3RlbmVycyk7CiAgfQp9CnZhciB0YXJnZXQkMTsKZnVuY3Rpb24gYWRkJDEoZXZlbnQsIGZuKSB7CiAgdGFyZ2V0JDEuJG9uKGV2ZW50LCBmbik7Cn0KZnVuY3Rpb24gcmVtb3ZlJDEoZXZlbnQsIGZuKSB7CiAgdGFyZ2V0JDEuJG9mZihldmVudCwgZm4pOwp9CmZ1bmN0aW9uIGNyZWF0ZU9uY2VIYW5kbGVyJDEoZXZlbnQsIGZuKSB7CiAgdmFyIF90YXJnZXQgPSB0YXJnZXQkMTsKICByZXR1cm4gZnVuY3Rpb24gb25jZUhhbmRsZXIoKSB7CiAgICB2YXIgcmVzID0gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgIGlmIChyZXMgIT09IG51bGwpIHsKICAgICAgX3RhcmdldC4kb2ZmKGV2ZW50LCBvbmNlSGFuZGxlcik7CiAgICB9CiAgfTsKfQpmdW5jdGlvbiB1cGRhdGVDb21wb25lbnRMaXN0ZW5lcnModm0sIGxpc3RlbmVycywgb2xkTGlzdGVuZXJzKSB7CiAgdGFyZ2V0JDEgPSB2bTsKICB1cGRhdGVMaXN0ZW5lcnMobGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMgfHwge30sIGFkZCQxLCByZW1vdmUkMSwgY3JlYXRlT25jZUhhbmRsZXIkMSwgdm0pOwogIHRhcmdldCQxID0gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGV2ZW50c01peGluKFZ1ZSkgewogIHZhciBob29rUkUgPSAvXmhvb2s6LzsKICBWdWUucHJvdG90eXBlLiRvbiA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICBpZiAoaXNBcnJheShldmVudCkpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBldmVudC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2bS4kb24oZXZlbnRbaV0sIGZuKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgKHZtLl9ldmVudHNbZXZlbnRdIHx8ICh2bS5fZXZlbnRzW2V2ZW50XSA9IFtdKSkucHVzaChmbik7CiAgICAgIC8vIG9wdGltaXplIGhvb2s6ZXZlbnQgY29zdCBieSB1c2luZyBhIGJvb2xlYW4gZmxhZyBtYXJrZWQgYXQgcmVnaXN0cmF0aW9uCiAgICAgIC8vIGluc3RlYWQgb2YgYSBoYXNoIGxvb2t1cAogICAgICBpZiAoaG9va1JFLnRlc3QoZXZlbnQpKSB7CiAgICAgICAgdm0uX2hhc0hvb2tFdmVudCA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2bTsKICB9OwogIFZ1ZS5wcm90b3R5cGUuJG9uY2UgPSBmdW5jdGlvbiAoZXZlbnQsIGZuKSB7CiAgICB2YXIgdm0gPSB0aGlzOwogICAgZnVuY3Rpb24gb24oKSB7CiAgICAgIHZtLiRvZmYoZXZlbnQsIG9uKTsKICAgICAgZm4uYXBwbHkodm0sIGFyZ3VtZW50cyk7CiAgICB9CiAgICBvbi5mbiA9IGZuOwogICAgdm0uJG9uKGV2ZW50LCBvbik7CiAgICByZXR1cm4gdm07CiAgfTsKICBWdWUucHJvdG90eXBlLiRvZmYgPSBmdW5jdGlvbiAoZXZlbnQsIGZuKSB7CiAgICB2YXIgdm0gPSB0aGlzOwogICAgLy8gYWxsCiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgdm0uX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHJldHVybiB2bTsKICAgIH0KICAgIC8vIGFycmF5IG9mIGV2ZW50cwogICAgaWYgKGlzQXJyYXkoZXZlbnQpKSB7CiAgICAgIGZvciAodmFyIGlfMSA9IDAsIGwgPSBldmVudC5sZW5ndGg7IGlfMSA8IGw7IGlfMSsrKSB7CiAgICAgICAgdm0uJG9mZihldmVudFtpXzFdLCBmbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHZtOwogICAgfQogICAgLy8gc3BlY2lmaWMgZXZlbnQKICAgIHZhciBjYnMgPSB2bS5fZXZlbnRzW2V2ZW50XTsKICAgIGlmICghY2JzKSB7CiAgICAgIHJldHVybiB2bTsKICAgIH0KICAgIGlmICghZm4pIHsKICAgICAgdm0uX2V2ZW50c1tldmVudF0gPSBudWxsOwogICAgICByZXR1cm4gdm07CiAgICB9CiAgICAvLyBzcGVjaWZpYyBoYW5kbGVyCiAgICB2YXIgY2I7CiAgICB2YXIgaSA9IGNicy5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIGNiID0gY2JzW2ldOwogICAgICBpZiAoY2IgPT09IGZuIHx8IGNiLmZuID09PSBmbikgewogICAgICAgIGNicy5zcGxpY2UoaSwgMSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2bTsKICB9OwogIFZ1ZS5wcm90b3R5cGUuJGVtaXQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB2YXIgbG93ZXJDYXNlRXZlbnQgPSBldmVudC50b0xvd2VyQ2FzZSgpOwogICAgICBpZiAobG93ZXJDYXNlRXZlbnQgIT09IGV2ZW50ICYmIHZtLl9ldmVudHNbbG93ZXJDYXNlRXZlbnRdKSB7CiAgICAgICAgdGlwKCJFdmVudCBcIiIuY29uY2F0KGxvd2VyQ2FzZUV2ZW50LCAiXCIgaXMgZW1pdHRlZCBpbiBjb21wb25lbnQgIikgKyAiIi5jb25jYXQoZm9ybWF0Q29tcG9uZW50TmFtZSh2bSksICIgYnV0IHRoZSBoYW5kbGVyIGlzIHJlZ2lzdGVyZWQgZm9yIFwiIikuY29uY2F0KGV2ZW50LCAiXCIuICIpICsgIk5vdGUgdGhhdCBIVE1MIGF0dHJpYnV0ZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUgYW5kIHlvdSBjYW5ub3QgdXNlICIgKyAidi1vbiB0byBsaXN0ZW4gdG8gY2FtZWxDYXNlIGV2ZW50cyB3aGVuIHVzaW5nIGluLURPTSB0ZW1wbGF0ZXMuICIgKyAiWW91IHNob3VsZCBwcm9iYWJseSB1c2UgXCIiLmNvbmNhdChoeXBoZW5hdGUoZXZlbnQpLCAiXCIgaW5zdGVhZCBvZiBcIiIpLmNvbmNhdChldmVudCwgIlwiLiIpKTsKICAgICAgfQogICAgfQogICAgdmFyIGNicyA9IHZtLl9ldmVudHNbZXZlbnRdOwogICAgaWYgKGNicykgewogICAgICBjYnMgPSBjYnMubGVuZ3RoID4gMSA/IHRvQXJyYXkoY2JzKSA6IGNiczsKICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cywgMSk7CiAgICAgIHZhciBpbmZvID0gImV2ZW50IGhhbmRsZXIgZm9yIFwiIi5jb25jYXQoZXZlbnQsICJcIiIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNicy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhjYnNbaV0sIHZtLCBhcmdzLCB2bSwgaW5mbyk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2bTsKICB9Owp9CnZhciBhY3RpdmVJbnN0YW5jZSA9IG51bGw7CnZhciBpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgPSBmYWxzZTsKZnVuY3Rpb24gc2V0QWN0aXZlSW5zdGFuY2Uodm0pIHsKICB2YXIgcHJldkFjdGl2ZUluc3RhbmNlID0gYWN0aXZlSW5zdGFuY2U7CiAgYWN0aXZlSW5zdGFuY2UgPSB2bTsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgYWN0aXZlSW5zdGFuY2UgPSBwcmV2QWN0aXZlSW5zdGFuY2U7CiAgfTsKfQpmdW5jdGlvbiBpbml0TGlmZWN5Y2xlKHZtKSB7CiAgdmFyIG9wdGlvbnMgPSB2bS4kb3B0aW9uczsKICAvLyBsb2NhdGUgZmlyc3Qgbm9uLWFic3RyYWN0IHBhcmVudAogIHZhciBwYXJlbnQgPSBvcHRpb25zLnBhcmVudDsKICBpZiAocGFyZW50ICYmICFvcHRpb25zLmFic3RyYWN0KSB7CiAgICB3aGlsZSAocGFyZW50LiRvcHRpb25zLmFic3RyYWN0ICYmIHBhcmVudC4kcGFyZW50KSB7CiAgICAgIHBhcmVudCA9IHBhcmVudC4kcGFyZW50OwogICAgfQogICAgcGFyZW50LiRjaGlsZHJlbi5wdXNoKHZtKTsKICB9CiAgdm0uJHBhcmVudCA9IHBhcmVudDsKICB2bS4kcm9vdCA9IHBhcmVudCA/IHBhcmVudC4kcm9vdCA6IHZtOwogIHZtLiRjaGlsZHJlbiA9IFtdOwogIHZtLiRyZWZzID0ge307CiAgdm0uX3Byb3ZpZGVkID0gcGFyZW50ID8gcGFyZW50Ll9wcm92aWRlZCA6IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdm0uX3dhdGNoZXIgPSBudWxsOwogIHZtLl9pbmFjdGl2ZSA9IG51bGw7CiAgdm0uX2RpcmVjdEluYWN0aXZlID0gZmFsc2U7CiAgdm0uX2lzTW91bnRlZCA9IGZhbHNlOwogIHZtLl9pc0Rlc3Ryb3llZCA9IGZhbHNlOwogIHZtLl9pc0JlaW5nRGVzdHJveWVkID0gZmFsc2U7Cn0KZnVuY3Rpb24gbGlmZWN5Y2xlTWl4aW4oVnVlKSB7CiAgVnVlLnByb3RvdHlwZS5fdXBkYXRlID0gZnVuY3Rpb24gKHZub2RlLCBoeWRyYXRpbmcpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB2YXIgcHJldkVsID0gdm0uJGVsOwogICAgdmFyIHByZXZWbm9kZSA9IHZtLl92bm9kZTsKICAgIHZhciByZXN0b3JlQWN0aXZlSW5zdGFuY2UgPSBzZXRBY3RpdmVJbnN0YW5jZSh2bSk7CiAgICB2bS5fdm5vZGUgPSB2bm9kZTsKICAgIC8vIFZ1ZS5wcm90b3R5cGUuX19wYXRjaF9fIGlzIGluamVjdGVkIGluIGVudHJ5IHBvaW50cwogICAgLy8gYmFzZWQgb24gdGhlIHJlbmRlcmluZyBiYWNrZW5kIHVzZWQuCiAgICBpZiAoIXByZXZWbm9kZSkgewogICAgICAvLyBpbml0aWFsIHJlbmRlcgogICAgICB2bS4kZWwgPSB2bS5fX3BhdGNoX18odm0uJGVsLCB2bm9kZSwgaHlkcmF0aW5nLCBmYWxzZSAvKiByZW1vdmVPbmx5ICovKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHVwZGF0ZXMKICAgICAgdm0uJGVsID0gdm0uX19wYXRjaF9fKHByZXZWbm9kZSwgdm5vZGUpOwogICAgfQogICAgcmVzdG9yZUFjdGl2ZUluc3RhbmNlKCk7CiAgICAvLyB1cGRhdGUgX192dWVfXyByZWZlcmVuY2UKICAgIGlmIChwcmV2RWwpIHsKICAgICAgcHJldkVsLl9fdnVlX18gPSBudWxsOwogICAgfQogICAgaWYgKHZtLiRlbCkgewogICAgICB2bS4kZWwuX192dWVfXyA9IHZtOwogICAgfQogICAgLy8gaWYgcGFyZW50IGlzIGFuIEhPQywgdXBkYXRlIGl0cyAkZWwgYXMgd2VsbAogICAgdmFyIHdyYXBwZXIgPSB2bTsKICAgIHdoaWxlICh3cmFwcGVyICYmIHdyYXBwZXIuJHZub2RlICYmIHdyYXBwZXIuJHBhcmVudCAmJiB3cmFwcGVyLiR2bm9kZSA9PT0gd3JhcHBlci4kcGFyZW50Ll92bm9kZSkgewogICAgICB3cmFwcGVyLiRwYXJlbnQuJGVsID0gd3JhcHBlci4kZWw7CiAgICAgIHdyYXBwZXIgPSB3cmFwcGVyLiRwYXJlbnQ7CiAgICB9CiAgICAvLyB1cGRhdGVkIGhvb2sgaXMgY2FsbGVkIGJ5IHRoZSBzY2hlZHVsZXIgdG8gZW5zdXJlIHRoYXQgY2hpbGRyZW4gYXJlCiAgICAvLyB1cGRhdGVkIGluIGEgcGFyZW50J3MgdXBkYXRlZCBob29rLgogIH07CgogIFZ1ZS5wcm90b3R5cGUuJGZvcmNlVXBkYXRlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZtID0gdGhpczsKICAgIGlmICh2bS5fd2F0Y2hlcikgewogICAgICB2bS5fd2F0Y2hlci51cGRhdGUoKTsKICAgIH0KICB9OwogIFZ1ZS5wcm90b3R5cGUuJGRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdm0gPSB0aGlzOwogICAgaWYgKHZtLl9pc0JlaW5nRGVzdHJveWVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNhbGxIb29rJDEodm0sICdiZWZvcmVEZXN0cm95Jyk7CiAgICB2bS5faXNCZWluZ0Rlc3Ryb3llZCA9IHRydWU7CiAgICAvLyByZW1vdmUgc2VsZiBmcm9tIHBhcmVudAogICAgdmFyIHBhcmVudCA9IHZtLiRwYXJlbnQ7CiAgICBpZiAocGFyZW50ICYmICFwYXJlbnQuX2lzQmVpbmdEZXN0cm95ZWQgJiYgIXZtLiRvcHRpb25zLmFic3RyYWN0KSB7CiAgICAgIHJlbW92ZSQyKHBhcmVudC4kY2hpbGRyZW4sIHZtKTsKICAgIH0KICAgIC8vIHRlYXJkb3duIHNjb3BlLiB0aGlzIGluY2x1ZGVzIGJvdGggdGhlIHJlbmRlciB3YXRjaGVyIGFuZCBvdGhlcgogICAgLy8gd2F0Y2hlcnMgY3JlYXRlZAogICAgdm0uX3Njb3BlLnN0b3AoKTsKICAgIC8vIHJlbW92ZSByZWZlcmVuY2UgZnJvbSBkYXRhIG9iCiAgICAvLyBmcm96ZW4gb2JqZWN0IG1heSBub3QgaGF2ZSBvYnNlcnZlci4KICAgIGlmICh2bS5fZGF0YS5fX29iX18pIHsKICAgICAgdm0uX2RhdGEuX19vYl9fLnZtQ291bnQtLTsKICAgIH0KICAgIC8vIGNhbGwgdGhlIGxhc3QgaG9vay4uLgogICAgdm0uX2lzRGVzdHJveWVkID0gdHJ1ZTsKICAgIC8vIGludm9rZSBkZXN0cm95IGhvb2tzIG9uIGN1cnJlbnQgcmVuZGVyZWQgdHJlZQogICAgdm0uX19wYXRjaF9fKHZtLl92bm9kZSwgbnVsbCk7CiAgICAvLyBmaXJlIGRlc3Ryb3llZCBob29rCiAgICBjYWxsSG9vayQxKHZtLCAnZGVzdHJveWVkJyk7CiAgICAvLyB0dXJuIG9mZiBhbGwgaW5zdGFuY2UgbGlzdGVuZXJzLgogICAgdm0uJG9mZigpOwogICAgLy8gcmVtb3ZlIF9fdnVlX18gcmVmZXJlbmNlCiAgICBpZiAodm0uJGVsKSB7CiAgICAgIHZtLiRlbC5fX3Z1ZV9fID0gbnVsbDsKICAgIH0KICAgIC8vIHJlbGVhc2UgY2lyY3VsYXIgcmVmZXJlbmNlICgjNjc1OSkKICAgIGlmICh2bS4kdm5vZGUpIHsKICAgICAgdm0uJHZub2RlLnBhcmVudCA9IG51bGw7CiAgICB9CiAgfTsKfQpmdW5jdGlvbiBtb3VudENvbXBvbmVudCh2bSwgZWwsIGh5ZHJhdGluZykgewogIHZtLiRlbCA9IGVsOwogIGlmICghdm0uJG9wdGlvbnMucmVuZGVyKSB7CiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGludmFsaWQgdHlwZQogICAgdm0uJG9wdGlvbnMucmVuZGVyID0gY3JlYXRlRW1wdHlWTm9kZTsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAodm0uJG9wdGlvbnMudGVtcGxhdGUgJiYgdm0uJG9wdGlvbnMudGVtcGxhdGUuY2hhckF0KDApICE9PSAnIycgfHwgdm0uJG9wdGlvbnMuZWwgfHwgZWwpIHsKICAgICAgICB3YXJuKCdZb3UgYXJlIHVzaW5nIHRoZSBydW50aW1lLW9ubHkgYnVpbGQgb2YgVnVlIHdoZXJlIHRoZSB0ZW1wbGF0ZSAnICsgJ2NvbXBpbGVyIGlzIG5vdCBhdmFpbGFibGUuIEVpdGhlciBwcmUtY29tcGlsZSB0aGUgdGVtcGxhdGVzIGludG8gJyArICdyZW5kZXIgZnVuY3Rpb25zLCBvciB1c2UgdGhlIGNvbXBpbGVyLWluY2x1ZGVkIGJ1aWxkLicsIHZtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3YXJuKCdGYWlsZWQgdG8gbW91bnQgY29tcG9uZW50OiB0ZW1wbGF0ZSBvciByZW5kZXIgZnVuY3Rpb24gbm90IGRlZmluZWQuJywgdm0pOwogICAgICB9CiAgICB9CiAgfQogIGNhbGxIb29rJDEodm0sICdiZWZvcmVNb3VudCcpOwogIHZhciB1cGRhdGVDb21wb25lbnQ7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgIHVwZGF0ZUNvbXBvbmVudCA9IGZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudCgpIHsKICAgICAgdmFyIG5hbWUgPSB2bS5fbmFtZTsKICAgICAgdmFyIGlkID0gdm0uX3VpZDsKICAgICAgdmFyIHN0YXJ0VGFnID0gInZ1ZS1wZXJmLXN0YXJ0OiIuY29uY2F0KGlkKTsKICAgICAgdmFyIGVuZFRhZyA9ICJ2dWUtcGVyZi1lbmQ6Ii5jb25jYXQoaWQpOwogICAgICBtYXJrKHN0YXJ0VGFnKTsKICAgICAgdmFyIHZub2RlID0gdm0uX3JlbmRlcigpOwogICAgICBtYXJrKGVuZFRhZyk7CiAgICAgIG1lYXN1cmUoInZ1ZSAiLmNvbmNhdChuYW1lLCAiIHJlbmRlciIpLCBzdGFydFRhZywgZW5kVGFnKTsKICAgICAgbWFyayhzdGFydFRhZyk7CiAgICAgIHZtLl91cGRhdGUodm5vZGUsIGh5ZHJhdGluZyk7CiAgICAgIG1hcmsoZW5kVGFnKTsKICAgICAgbWVhc3VyZSgidnVlICIuY29uY2F0KG5hbWUsICIgcGF0Y2giKSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICB9OwogIH0gZWxzZSB7CiAgICB1cGRhdGVDb21wb25lbnQgPSBmdW5jdGlvbiB1cGRhdGVDb21wb25lbnQoKSB7CiAgICAgIHZtLl91cGRhdGUodm0uX3JlbmRlcigpLCBoeWRyYXRpbmcpOwogICAgfTsKICB9CiAgdmFyIHdhdGNoZXJPcHRpb25zID0gewogICAgYmVmb3JlOiBmdW5jdGlvbiBiZWZvcmUoKSB7CiAgICAgIGlmICh2bS5faXNNb3VudGVkICYmICF2bS5faXNEZXN0cm95ZWQpIHsKICAgICAgICBjYWxsSG9vayQxKHZtLCAnYmVmb3JlVXBkYXRlJyk7CiAgICAgIH0KICAgIH0KICB9OwogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXRjaGVyT3B0aW9ucy5vblRyYWNrID0gZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIGNhbGxIb29rJDEodm0sICdyZW5kZXJUcmFja2VkJywgW2VdKTsKICAgIH07CiAgICB3YXRjaGVyT3B0aW9ucy5vblRyaWdnZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICByZXR1cm4gY2FsbEhvb2skMSh2bSwgJ3JlbmRlclRyaWdnZXJlZCcsIFtlXSk7CiAgICB9OwogIH0KICAvLyB3ZSBzZXQgdGhpcyB0byB2bS5fd2F0Y2hlciBpbnNpZGUgdGhlIHdhdGNoZXIncyBjb25zdHJ1Y3RvcgogIC8vIHNpbmNlIHRoZSB3YXRjaGVyJ3MgaW5pdGlhbCBwYXRjaCBtYXkgY2FsbCAkZm9yY2VVcGRhdGUgKGUuZy4gaW5zaWRlIGNoaWxkCiAgLy8gY29tcG9uZW50J3MgbW91bnRlZCBob29rKSwgd2hpY2ggcmVsaWVzIG9uIHZtLl93YXRjaGVyIGJlaW5nIGFscmVhZHkgZGVmaW5lZAogIG5ldyBXYXRjaGVyKHZtLCB1cGRhdGVDb21wb25lbnQsIG5vb3AsIHdhdGNoZXJPcHRpb25zLCB0cnVlIC8qIGlzUmVuZGVyV2F0Y2hlciAqLyk7CiAgaHlkcmF0aW5nID0gZmFsc2U7CiAgLy8gZmx1c2ggYnVmZmVyIGZvciBmbHVzaDogInByZSIgd2F0Y2hlcnMgcXVldWVkIGluIHNldHVwKCkKICB2YXIgcHJlV2F0Y2hlcnMgPSB2bS5fcHJlV2F0Y2hlcnM7CiAgaWYgKHByZVdhdGNoZXJzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByZVdhdGNoZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHByZVdhdGNoZXJzW2ldLnJ1bigpOwogICAgfQogIH0KICAvLyBtYW51YWxseSBtb3VudGVkIGluc3RhbmNlLCBjYWxsIG1vdW50ZWQgb24gc2VsZgogIC8vIG1vdW50ZWQgaXMgY2FsbGVkIGZvciByZW5kZXItY3JlYXRlZCBjaGlsZCBjb21wb25lbnRzIGluIGl0cyBpbnNlcnRlZCBob29rCiAgaWYgKHZtLiR2bm9kZSA9PSBudWxsKSB7CiAgICB2bS5faXNNb3VudGVkID0gdHJ1ZTsKICAgIGNhbGxIb29rJDEodm0sICdtb3VudGVkJyk7CiAgfQogIHJldHVybiB2bTsKfQpmdW5jdGlvbiB1cGRhdGVDaGlsZENvbXBvbmVudCh2bSwgcHJvcHNEYXRhLCBsaXN0ZW5lcnMsIHBhcmVudFZub2RlLCByZW5kZXJDaGlsZHJlbikgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgPSB0cnVlOwogIH0KICAvLyBkZXRlcm1pbmUgd2hldGhlciBjb21wb25lbnQgaGFzIHNsb3QgY2hpbGRyZW4KICAvLyB3ZSBuZWVkIHRvIGRvIHRoaXMgYmVmb3JlIG92ZXJ3cml0aW5nICRvcHRpb25zLl9yZW5kZXJDaGlsZHJlbi4KICAvLyBjaGVjayBpZiB0aGVyZSBhcmUgZHluYW1pYyBzY29wZWRTbG90cyAoaGFuZC13cml0dGVuIG9yIGNvbXBpbGVkIGJ1dCB3aXRoCiAgLy8gZHluYW1pYyBzbG90IG5hbWVzKS4gU3RhdGljIHNjb3BlZCBzbG90cyBjb21waWxlZCBmcm9tIHRlbXBsYXRlIGhhcyB0aGUKICAvLyAiJHN0YWJsZSIgbWFya2VyLgogIHZhciBuZXdTY29wZWRTbG90cyA9IHBhcmVudFZub2RlLmRhdGEuc2NvcGVkU2xvdHM7CiAgdmFyIG9sZFNjb3BlZFNsb3RzID0gdm0uJHNjb3BlZFNsb3RzOwogIHZhciBoYXNEeW5hbWljU2NvcGVkU2xvdCA9ICEhKG5ld1Njb3BlZFNsb3RzICYmICFuZXdTY29wZWRTbG90cy4kc3RhYmxlIHx8IG9sZFNjb3BlZFNsb3RzICE9PSBlbXB0eU9iamVjdCAmJiAhb2xkU2NvcGVkU2xvdHMuJHN0YWJsZSB8fCBuZXdTY29wZWRTbG90cyAmJiB2bS4kc2NvcGVkU2xvdHMuJGtleSAhPT0gbmV3U2NvcGVkU2xvdHMuJGtleSB8fCAhbmV3U2NvcGVkU2xvdHMgJiYgdm0uJHNjb3BlZFNsb3RzLiRrZXkpOwogIC8vIEFueSBzdGF0aWMgc2xvdCBjaGlsZHJlbiBmcm9tIHRoZSBwYXJlbnQgbWF5IGhhdmUgY2hhbmdlZCBkdXJpbmcgcGFyZW50J3MKICAvLyB1cGRhdGUuIER5bmFtaWMgc2NvcGVkIHNsb3RzIG1heSBhbHNvIGhhdmUgY2hhbmdlZC4gSW4gc3VjaCBjYXNlcywgYSBmb3JjZWQKICAvLyB1cGRhdGUgaXMgbmVjZXNzYXJ5IHRvIGVuc3VyZSBjb3JyZWN0bmVzcy4KICB2YXIgbmVlZHNGb3JjZVVwZGF0ZSA9ICEhKHJlbmRlckNoaWxkcmVuIHx8CiAgLy8gaGFzIG5ldyBzdGF0aWMgc2xvdHMKICB2bS4kb3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW4gfHwKICAvLyBoYXMgb2xkIHN0YXRpYyBzbG90cwogIGhhc0R5bmFtaWNTY29wZWRTbG90KTsKICB2YXIgcHJldlZOb2RlID0gdm0uJHZub2RlOwogIHZtLiRvcHRpb25zLl9wYXJlbnRWbm9kZSA9IHBhcmVudFZub2RlOwogIHZtLiR2bm9kZSA9IHBhcmVudFZub2RlOyAvLyB1cGRhdGUgdm0ncyBwbGFjZWhvbGRlciBub2RlIHdpdGhvdXQgcmUtcmVuZGVyCiAgaWYgKHZtLl92bm9kZSkgewogICAgLy8gdXBkYXRlIGNoaWxkIHRyZWUncyBwYXJlbnQKICAgIHZtLl92bm9kZS5wYXJlbnQgPSBwYXJlbnRWbm9kZTsKICB9CiAgdm0uJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuID0gcmVuZGVyQ2hpbGRyZW47CiAgLy8gdXBkYXRlICRhdHRycyBhbmQgJGxpc3RlbmVycyBoYXNoCiAgLy8gdGhlc2UgYXJlIGFsc28gcmVhY3RpdmUgc28gdGhleSBtYXkgdHJpZ2dlciBjaGlsZCB1cGRhdGUgaWYgdGhlIGNoaWxkCiAgLy8gdXNlZCB0aGVtIGR1cmluZyByZW5kZXIKICB2YXIgYXR0cnMgPSBwYXJlbnRWbm9kZS5kYXRhLmF0dHJzIHx8IGVtcHR5T2JqZWN0OwogIGlmICh2bS5fYXR0cnNQcm94eSkgewogICAgLy8gZm9yY2UgdXBkYXRlIGlmIGF0dHJzIGFyZSBhY2Nlc3NlZCBhbmQgaGFzIGNoYW5nZWQgc2luY2UgaXQgbWF5IGJlCiAgICAvLyBwYXNzZWQgdG8gYSBjaGlsZCBjb21wb25lbnQuCiAgICBpZiAoc3luY1NldHVwUHJveHkodm0uX2F0dHJzUHJveHksIGF0dHJzLCBwcmV2Vk5vZGUuZGF0YSAmJiBwcmV2Vk5vZGUuZGF0YS5hdHRycyB8fCBlbXB0eU9iamVjdCwgdm0sICckYXR0cnMnKSkgewogICAgICBuZWVkc0ZvcmNlVXBkYXRlID0gdHJ1ZTsKICAgIH0KICB9CiAgdm0uJGF0dHJzID0gYXR0cnM7CiAgLy8gdXBkYXRlIGxpc3RlbmVycwogIGxpc3RlbmVycyA9IGxpc3RlbmVycyB8fCBlbXB0eU9iamVjdDsKICB2YXIgcHJldkxpc3RlbmVycyA9IHZtLiRvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CiAgaWYgKHZtLl9saXN0ZW5lcnNQcm94eSkgewogICAgc3luY1NldHVwUHJveHkodm0uX2xpc3RlbmVyc1Byb3h5LCBsaXN0ZW5lcnMsIHByZXZMaXN0ZW5lcnMgfHwgZW1wdHlPYmplY3QsIHZtLCAnJGxpc3RlbmVycycpOwogIH0KICB2bS4kbGlzdGVuZXJzID0gdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyA9IGxpc3RlbmVyczsKICB1cGRhdGVDb21wb25lbnRMaXN0ZW5lcnModm0sIGxpc3RlbmVycywgcHJldkxpc3RlbmVycyk7CiAgLy8gdXBkYXRlIHByb3BzCiAgaWYgKHByb3BzRGF0YSAmJiB2bS4kb3B0aW9ucy5wcm9wcykgewogICAgdG9nZ2xlT2JzZXJ2aW5nKGZhbHNlKTsKICAgIHZhciBwcm9wcyA9IHZtLl9wcm9wczsKICAgIHZhciBwcm9wS2V5cyA9IHZtLiRvcHRpb25zLl9wcm9wS2V5cyB8fCBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcEtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGtleSA9IHByb3BLZXlzW2ldOwogICAgICB2YXIgcHJvcE9wdGlvbnMgPSB2bS4kb3B0aW9ucy5wcm9wczsgLy8gd3RmIGZsb3c/CiAgICAgIHByb3BzW2tleV0gPSB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wT3B0aW9ucywgcHJvcHNEYXRhLCB2bSk7CiAgICB9CiAgICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7CiAgICAvLyBrZWVwIGEgY29weSBvZiByYXcgcHJvcHNEYXRhCiAgICB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgPSBwcm9wc0RhdGE7CiAgfQogIC8vIHJlc29sdmUgc2xvdHMgKyBmb3JjZSB1cGRhdGUgaWYgaGFzIGNoaWxkcmVuCiAgaWYgKG5lZWRzRm9yY2VVcGRhdGUpIHsKICAgIHZtLiRzbG90cyA9IHJlc29sdmVTbG90cyhyZW5kZXJDaGlsZHJlbiwgcGFyZW50Vm5vZGUuY29udGV4dCk7CiAgICB2bS4kZm9yY2VVcGRhdGUoKTsKICB9CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCA9IGZhbHNlOwogIH0KfQpmdW5jdGlvbiBpc0luSW5hY3RpdmVUcmVlKHZtKSB7CiAgd2hpbGUgKHZtICYmICh2bSA9IHZtLiRwYXJlbnQpKSB7CiAgICBpZiAodm0uX2luYWN0aXZlKSByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGFjdGl2YXRlQ2hpbGRDb21wb25lbnQodm0sIGRpcmVjdCkgewogIGlmIChkaXJlY3QpIHsKICAgIHZtLl9kaXJlY3RJbmFjdGl2ZSA9IGZhbHNlOwogICAgaWYgKGlzSW5JbmFjdGl2ZVRyZWUodm0pKSB7CiAgICAgIHJldHVybjsKICAgIH0KICB9IGVsc2UgaWYgKHZtLl9kaXJlY3RJbmFjdGl2ZSkgewogICAgcmV0dXJuOwogIH0KICBpZiAodm0uX2luYWN0aXZlIHx8IHZtLl9pbmFjdGl2ZSA9PT0gbnVsbCkgewogICAgdm0uX2luYWN0aXZlID0gZmFsc2U7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZtLiRjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLiRjaGlsZHJlbltpXSk7CiAgICB9CiAgICBjYWxsSG9vayQxKHZtLCAnYWN0aXZhdGVkJyk7CiAgfQp9CmZ1bmN0aW9uIGRlYWN0aXZhdGVDaGlsZENvbXBvbmVudCh2bSwgZGlyZWN0KSB7CiAgaWYgKGRpcmVjdCkgewogICAgdm0uX2RpcmVjdEluYWN0aXZlID0gdHJ1ZTsKICAgIGlmIChpc0luSW5hY3RpdmVUcmVlKHZtKSkgewogICAgICByZXR1cm47CiAgICB9CiAgfQogIGlmICghdm0uX2luYWN0aXZlKSB7CiAgICB2bS5faW5hY3RpdmUgPSB0cnVlOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bS4kY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgZGVhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLiRjaGlsZHJlbltpXSk7CiAgICB9CiAgICBjYWxsSG9vayQxKHZtLCAnZGVhY3RpdmF0ZWQnKTsKICB9Cn0KZnVuY3Rpb24gY2FsbEhvb2skMSh2bSwgaG9vaywgYXJncywgc2V0Q29udGV4dCkgewogIGlmIChzZXRDb250ZXh0ID09PSB2b2lkIDApIHsKICAgIHNldENvbnRleHQgPSB0cnVlOwogIH0KICAvLyAjNzU3MyBkaXNhYmxlIGRlcCBjb2xsZWN0aW9uIHdoZW4gaW52b2tpbmcgbGlmZWN5Y2xlIGhvb2tzCiAgcHVzaFRhcmdldCgpOwogIHZhciBwcmV2ID0gY3VycmVudEluc3RhbmNlOwogIHNldENvbnRleHQgJiYgc2V0Q3VycmVudEluc3RhbmNlKHZtKTsKICB2YXIgaGFuZGxlcnMgPSB2bS4kb3B0aW9uc1tob29rXTsKICB2YXIgaW5mbyA9ICIiLmNvbmNhdChob29rLCAiIGhvb2siKTsKICBpZiAoaGFuZGxlcnMpIHsKICAgIGZvciAodmFyIGkgPSAwLCBqID0gaGFuZGxlcnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGhhbmRsZXJzW2ldLCB2bSwgYXJncyB8fCBudWxsLCB2bSwgaW5mbyk7CiAgICB9CiAgfQogIGlmICh2bS5faGFzSG9va0V2ZW50KSB7CiAgICB2bS4kZW1pdCgnaG9vazonICsgaG9vayk7CiAgfQogIHNldENvbnRleHQgJiYgc2V0Q3VycmVudEluc3RhbmNlKHByZXYpOwogIHBvcFRhcmdldCgpOwp9CnZhciBNQVhfVVBEQVRFX0NPVU5UID0gMTAwOwp2YXIgcXVldWUgPSBbXTsKdmFyIGFjdGl2YXRlZENoaWxkcmVuID0gW107CnZhciBoYXMgPSB7fTsKdmFyIGNpcmN1bGFyID0ge307CnZhciB3YWl0aW5nID0gZmFsc2U7CnZhciBmbHVzaGluZyA9IGZhbHNlOwp2YXIgaW5kZXggPSAwOwovKioKICogUmVzZXQgdGhlIHNjaGVkdWxlcidzIHN0YXRlLgogKi8KZnVuY3Rpb24gcmVzZXRTY2hlZHVsZXJTdGF0ZSgpIHsKICBpbmRleCA9IHF1ZXVlLmxlbmd0aCA9IGFjdGl2YXRlZENoaWxkcmVuLmxlbmd0aCA9IDA7CiAgaGFzID0ge307CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGNpcmN1bGFyID0ge307CiAgfQogIHdhaXRpbmcgPSBmbHVzaGluZyA9IGZhbHNlOwp9Ci8vIEFzeW5jIGVkZ2UgY2FzZSAjNjU2NiByZXF1aXJlcyBzYXZpbmcgdGhlIHRpbWVzdGFtcCB3aGVuIGV2ZW50IGxpc3RlbmVycyBhcmUKLy8gYXR0YWNoZWQuIEhvd2V2ZXIsIGNhbGxpbmcgcGVyZm9ybWFuY2Uubm93KCkgaGFzIGEgcGVyZiBvdmVyaGVhZCBlc3BlY2lhbGx5Ci8vIGlmIHRoZSBwYWdlIGhhcyB0aG91c2FuZHMgb2YgZXZlbnQgbGlzdGVuZXJzLiBJbnN0ZWFkLCB3ZSB0YWtlIGEgdGltZXN0YW1wCi8vIGV2ZXJ5IHRpbWUgdGhlIHNjaGVkdWxlciBmbHVzaGVzIGFuZCB1c2UgdGhhdCBmb3IgYWxsIGV2ZW50IGxpc3RlbmVycwovLyBhdHRhY2hlZCBkdXJpbmcgdGhhdCBmbHVzaC4KdmFyIGN1cnJlbnRGbHVzaFRpbWVzdGFtcCA9IDA7Ci8vIEFzeW5jIGVkZ2UgY2FzZSBmaXggcmVxdWlyZXMgc3RvcmluZyBhbiBldmVudCBsaXN0ZW5lcidzIGF0dGFjaCB0aW1lc3RhbXAuCnZhciBnZXROb3cgPSBEYXRlLm5vdzsKLy8gRGV0ZXJtaW5lIHdoYXQgZXZlbnQgdGltZXN0YW1wIHRoZSBicm93c2VyIGlzIHVzaW5nLiBBbm5veWluZ2x5LCB0aGUKLy8gdGltZXN0YW1wIGNhbiBlaXRoZXIgYmUgaGktcmVzIChyZWxhdGl2ZSB0byBwYWdlIGxvYWQpIG9yIGxvdy1yZXMKLy8gKHJlbGF0aXZlIHRvIFVOSVggZXBvY2gpLCBzbyBpbiBvcmRlciB0byBjb21wYXJlIHRpbWUgd2UgaGF2ZSB0byB1c2UgdGhlCi8vIHNhbWUgdGltZXN0YW1wIHR5cGUgd2hlbiBzYXZpbmcgdGhlIGZsdXNoIHRpbWVzdGFtcC4KLy8gQWxsIElFIHZlcnNpb25zIHVzZSBsb3ctcmVzIGV2ZW50IHRpbWVzdGFtcHMsIGFuZCBoYXZlIHByb2JsZW1hdGljIGNsb2NrCi8vIGltcGxlbWVudGF0aW9ucyAoIzk2MzIpCmlmIChpbkJyb3dzZXIgJiYgIWlzSUUpIHsKICB2YXIgcGVyZm9ybWFuY2VfMSA9IHdpbmRvdy5wZXJmb3JtYW5jZTsKICBpZiAocGVyZm9ybWFuY2VfMSAmJiB0eXBlb2YgcGVyZm9ybWFuY2VfMS5ub3cgPT09ICdmdW5jdGlvbicgJiYgZ2V0Tm93KCkgPiBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnQnKS50aW1lU3RhbXApIHsKICAgIC8vIGlmIHRoZSBldmVudCB0aW1lc3RhbXAsIGFsdGhvdWdoIGV2YWx1YXRlZCBBRlRFUiB0aGUgRGF0ZS5ub3coKSwgaXMKICAgIC8vIHNtYWxsZXIgdGhhbiBpdCwgaXQgbWVhbnMgdGhlIGV2ZW50IGlzIHVzaW5nIGEgaGktcmVzIHRpbWVzdGFtcCwKICAgIC8vIGFuZCB3ZSBuZWVkIHRvIHVzZSB0aGUgaGktcmVzIHZlcnNpb24gZm9yIGV2ZW50IGxpc3RlbmVyIHRpbWVzdGFtcHMgYXMKICAgIC8vIHdlbGwuCiAgICBnZXROb3cgPSBmdW5jdGlvbiBnZXROb3coKSB7CiAgICAgIHJldHVybiBwZXJmb3JtYW5jZV8xLm5vdygpOwogICAgfTsKICB9Cn0KdmFyIHNvcnRDb21wYXJlRm4gPSBmdW5jdGlvbiBzb3J0Q29tcGFyZUZuKGEsIGIpIHsKICBpZiAoYS5wb3N0KSB7CiAgICBpZiAoIWIucG9zdCkgcmV0dXJuIDE7CiAgfSBlbHNlIGlmIChiLnBvc3QpIHsKICAgIHJldHVybiAtMTsKICB9CiAgcmV0dXJuIGEuaWQgLSBiLmlkOwp9OwovKioKICogRmx1c2ggYm90aCBxdWV1ZXMgYW5kIHJ1biB0aGUgd2F0Y2hlcnMuCiAqLwpmdW5jdGlvbiBmbHVzaFNjaGVkdWxlclF1ZXVlKCkgewogIGN1cnJlbnRGbHVzaFRpbWVzdGFtcCA9IGdldE5vdygpOwogIGZsdXNoaW5nID0gdHJ1ZTsKICB2YXIgd2F0Y2hlciwgaWQ7CiAgLy8gU29ydCBxdWV1ZSBiZWZvcmUgZmx1c2guCiAgLy8gVGhpcyBlbnN1cmVzIHRoYXQ6CiAgLy8gMS4gQ29tcG9uZW50cyBhcmUgdXBkYXRlZCBmcm9tIHBhcmVudCB0byBjaGlsZC4gKGJlY2F1c2UgcGFyZW50IGlzIGFsd2F5cwogIC8vICAgIGNyZWF0ZWQgYmVmb3JlIHRoZSBjaGlsZCkKICAvLyAyLiBBIGNvbXBvbmVudCdzIHVzZXIgd2F0Y2hlcnMgYXJlIHJ1biBiZWZvcmUgaXRzIHJlbmRlciB3YXRjaGVyIChiZWNhdXNlCiAgLy8gICAgdXNlciB3YXRjaGVycyBhcmUgY3JlYXRlZCBiZWZvcmUgdGhlIHJlbmRlciB3YXRjaGVyKQogIC8vIDMuIElmIGEgY29tcG9uZW50IGlzIGRlc3Ryb3llZCBkdXJpbmcgYSBwYXJlbnQgY29tcG9uZW50J3Mgd2F0Y2hlciBydW4sCiAgLy8gICAgaXRzIHdhdGNoZXJzIGNhbiBiZSBza2lwcGVkLgogIHF1ZXVlLnNvcnQoc29ydENvbXBhcmVGbik7CiAgLy8gZG8gbm90IGNhY2hlIGxlbmd0aCBiZWNhdXNlIG1vcmUgd2F0Y2hlcnMgbWlnaHQgYmUgcHVzaGVkCiAgLy8gYXMgd2UgcnVuIGV4aXN0aW5nIHdhdGNoZXJzCiAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgcXVldWUubGVuZ3RoOyBpbmRleCsrKSB7CiAgICB3YXRjaGVyID0gcXVldWVbaW5kZXhdOwogICAgaWYgKHdhdGNoZXIuYmVmb3JlKSB7CiAgICAgIHdhdGNoZXIuYmVmb3JlKCk7CiAgICB9CiAgICBpZCA9IHdhdGNoZXIuaWQ7CiAgICBoYXNbaWRdID0gbnVsbDsKICAgIHdhdGNoZXIucnVuKCk7CiAgICAvLyBpbiBkZXYgYnVpbGQsIGNoZWNrIGFuZCBzdG9wIGNpcmN1bGFyIHVwZGF0ZXMuCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBoYXNbaWRdICE9IG51bGwpIHsKICAgICAgY2lyY3VsYXJbaWRdID0gKGNpcmN1bGFyW2lkXSB8fCAwKSArIDE7CiAgICAgIGlmIChjaXJjdWxhcltpZF0gPiBNQVhfVVBEQVRFX0NPVU5UKSB7CiAgICAgICAgd2FybignWW91IG1heSBoYXZlIGFuIGluZmluaXRlIHVwZGF0ZSBsb29wICcgKyAod2F0Y2hlci51c2VyID8gImluIHdhdGNoZXIgd2l0aCBleHByZXNzaW9uIFwiIi5jb25jYXQod2F0Y2hlci5leHByZXNzaW9uLCAiXCIiKSA6ICJpbiBhIGNvbXBvbmVudCByZW5kZXIgZnVuY3Rpb24uIiksIHdhdGNoZXIudm0pOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfQogIC8vIGtlZXAgY29waWVzIG9mIHBvc3QgcXVldWVzIGJlZm9yZSByZXNldHRpbmcgc3RhdGUKICB2YXIgYWN0aXZhdGVkUXVldWUgPSBhY3RpdmF0ZWRDaGlsZHJlbi5zbGljZSgpOwogIHZhciB1cGRhdGVkUXVldWUgPSBxdWV1ZS5zbGljZSgpOwogIHJlc2V0U2NoZWR1bGVyU3RhdGUoKTsKICAvLyBjYWxsIGNvbXBvbmVudCB1cGRhdGVkIGFuZCBhY3RpdmF0ZWQgaG9va3MKICBjYWxsQWN0aXZhdGVkSG9va3MoYWN0aXZhdGVkUXVldWUpOwogIGNhbGxVcGRhdGVkSG9va3ModXBkYXRlZFF1ZXVlKTsKICBjbGVhbnVwRGVwcygpOwogIC8vIGRldnRvb2wgaG9vawogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChkZXZ0b29scyAmJiBjb25maWcuZGV2dG9vbHMpIHsKICAgIGRldnRvb2xzLmVtaXQoJ2ZsdXNoJyk7CiAgfQp9CmZ1bmN0aW9uIGNhbGxVcGRhdGVkSG9va3MocXVldWUpIHsKICB2YXIgaSA9IHF1ZXVlLmxlbmd0aDsKICB3aGlsZSAoaS0tKSB7CiAgICB2YXIgd2F0Y2hlciA9IHF1ZXVlW2ldOwogICAgdmFyIHZtID0gd2F0Y2hlci52bTsKICAgIGlmICh2bSAmJiB2bS5fd2F0Y2hlciA9PT0gd2F0Y2hlciAmJiB2bS5faXNNb3VudGVkICYmICF2bS5faXNEZXN0cm95ZWQpIHsKICAgICAgY2FsbEhvb2skMSh2bSwgJ3VwZGF0ZWQnKTsKICAgIH0KICB9Cn0KLyoqCiAqIFF1ZXVlIGEga2VwdC1hbGl2ZSBjb21wb25lbnQgdGhhdCB3YXMgYWN0aXZhdGVkIGR1cmluZyBwYXRjaC4KICogVGhlIHF1ZXVlIHdpbGwgYmUgcHJvY2Vzc2VkIGFmdGVyIHRoZSBlbnRpcmUgdHJlZSBoYXMgYmVlbiBwYXRjaGVkLgogKi8KZnVuY3Rpb24gcXVldWVBY3RpdmF0ZWRDb21wb25lbnQodm0pIHsKICAvLyBzZXR0aW5nIF9pbmFjdGl2ZSB0byBmYWxzZSBoZXJlIHNvIHRoYXQgYSByZW5kZXIgZnVuY3Rpb24gY2FuCiAgLy8gcmVseSBvbiBjaGVja2luZyB3aGV0aGVyIGl0J3MgaW4gYW4gaW5hY3RpdmUgdHJlZSAoZS5nLiByb3V0ZXItdmlldykKICB2bS5faW5hY3RpdmUgPSBmYWxzZTsKICBhY3RpdmF0ZWRDaGlsZHJlbi5wdXNoKHZtKTsKfQpmdW5jdGlvbiBjYWxsQWN0aXZhdGVkSG9va3MocXVldWUpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICBxdWV1ZVtpXS5faW5hY3RpdmUgPSB0cnVlOwogICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudChxdWV1ZVtpXSwgdHJ1ZSAvKiB0cnVlICovKTsKICB9Cn0KLyoqCiAqIFB1c2ggYSB3YXRjaGVyIGludG8gdGhlIHdhdGNoZXIgcXVldWUuCiAqIEpvYnMgd2l0aCBkdXBsaWNhdGUgSURzIHdpbGwgYmUgc2tpcHBlZCB1bmxlc3MgaXQncwogKiBwdXNoZWQgd2hlbiB0aGUgcXVldWUgaXMgYmVpbmcgZmx1c2hlZC4KICovCmZ1bmN0aW9uIHF1ZXVlV2F0Y2hlcih3YXRjaGVyKSB7CiAgdmFyIGlkID0gd2F0Y2hlci5pZDsKICBpZiAoaGFzW2lkXSAhPSBudWxsKSB7CiAgICByZXR1cm47CiAgfQogIGlmICh3YXRjaGVyID09PSBEZXAudGFyZ2V0ICYmIHdhdGNoZXIubm9SZWN1cnNlKSB7CiAgICByZXR1cm47CiAgfQogIGhhc1tpZF0gPSB0cnVlOwogIGlmICghZmx1c2hpbmcpIHsKICAgIHF1ZXVlLnB1c2god2F0Y2hlcik7CiAgfSBlbHNlIHsKICAgIC8vIGlmIGFscmVhZHkgZmx1c2hpbmcsIHNwbGljZSB0aGUgd2F0Y2hlciBiYXNlZCBvbiBpdHMgaWQKICAgIC8vIGlmIGFscmVhZHkgcGFzdCBpdHMgaWQsIGl0IHdpbGwgYmUgcnVuIG5leHQgaW1tZWRpYXRlbHkuCiAgICB2YXIgaSA9IHF1ZXVlLmxlbmd0aCAtIDE7CiAgICB3aGlsZSAoaSA+IGluZGV4ICYmIHF1ZXVlW2ldLmlkID4gd2F0Y2hlci5pZCkgewogICAgICBpLS07CiAgICB9CiAgICBxdWV1ZS5zcGxpY2UoaSArIDEsIDAsIHdhdGNoZXIpOwogIH0KICAvLyBxdWV1ZSB0aGUgZmx1c2gKICBpZiAoIXdhaXRpbmcpIHsKICAgIHdhaXRpbmcgPSB0cnVlOwogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIWNvbmZpZy5hc3luYykgewogICAgICBmbHVzaFNjaGVkdWxlclF1ZXVlKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIG5leHRUaWNrKGZsdXNoU2NoZWR1bGVyUXVldWUpOwogIH0KfQpmdW5jdGlvbiBpbml0UHJvdmlkZSh2bSkgewogIHZhciBwcm92aWRlT3B0aW9uID0gdm0uJG9wdGlvbnMucHJvdmlkZTsKICBpZiAocHJvdmlkZU9wdGlvbikgewogICAgdmFyIHByb3ZpZGVkID0gaXNGdW5jdGlvbihwcm92aWRlT3B0aW9uKSA/IHByb3ZpZGVPcHRpb24uY2FsbCh2bSkgOiBwcm92aWRlT3B0aW9uOwogICAgaWYgKCFpc09iamVjdChwcm92aWRlZCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHNvdXJjZSA9IHJlc29sdmVQcm92aWRlZCh2bSk7CiAgICAvLyBJRTkgZG9lc24ndCBzdXBwb3J0IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzIHNvIHdlIGhhdmUgdG8KICAgIC8vIGl0ZXJhdGUgdGhlIGtleXMgb3Vyc2VsdmVzLgogICAgdmFyIGtleXMgPSBoYXNTeW1ib2wgPyBSZWZsZWN0Lm93bktleXMocHJvdmlkZWQpIDogT2JqZWN0LmtleXMocHJvdmlkZWQpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc291cmNlLCBrZXksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvdmlkZWQsIGtleSkpOwogICAgfQogIH0KfQpmdW5jdGlvbiBpbml0SW5qZWN0aW9ucyh2bSkgewogIHZhciByZXN1bHQgPSByZXNvbHZlSW5qZWN0KHZtLiRvcHRpb25zLmluamVjdCwgdm0pOwogIGlmIChyZXN1bHQpIHsKICAgIHRvZ2dsZU9ic2VydmluZyhmYWxzZSk7CiAgICBPYmplY3Qua2V5cyhyZXN1bHQpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGRlZmluZVJlYWN0aXZlKHZtLCBrZXksIHJlc3VsdFtrZXldLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB3YXJuKCJBdm9pZCBtdXRhdGluZyBhbiBpbmplY3RlZCB2YWx1ZSBkaXJlY3RseSBzaW5jZSB0aGUgY2hhbmdlcyB3aWxsIGJlICIgKyAib3ZlcndyaXR0ZW4gd2hlbmV2ZXIgdGhlIHByb3ZpZGVkIGNvbXBvbmVudCByZS1yZW5kZXJzLiAiICsgImluamVjdGlvbiBiZWluZyBtdXRhdGVkOiBcIiIuY29uY2F0KGtleSwgIlwiIiksIHZtKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWZpbmVSZWFjdGl2ZSh2bSwga2V5LCByZXN1bHRba2V5XSk7CiAgICAgIH0KICAgIH0pOwogICAgdG9nZ2xlT2JzZXJ2aW5nKHRydWUpOwogIH0KfQpmdW5jdGlvbiByZXNvbHZlSW5qZWN0KGluamVjdCwgdm0pIHsKICBpZiAoaW5qZWN0KSB7CiAgICAvLyBpbmplY3QgaXMgOmFueSBiZWNhdXNlIGZsb3cgaXMgbm90IHNtYXJ0IGVub3VnaCB0byBmaWd1cmUgb3V0IGNhY2hlZAogICAgdmFyIHJlc3VsdCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB2YXIga2V5cyA9IGhhc1N5bWJvbCA/IFJlZmxlY3Qub3duS2V5cyhpbmplY3QpIDogT2JqZWN0LmtleXMoaW5qZWN0KTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgLy8gIzY1NzQgaW4gY2FzZSB0aGUgaW5qZWN0IG9iamVjdCBpcyBvYnNlcnZlZC4uLgogICAgICBpZiAoa2V5ID09PSAnX19vYl9fJykgY29udGludWU7CiAgICAgIHZhciBwcm92aWRlS2V5ID0gaW5qZWN0W2tleV0uZnJvbTsKICAgICAgaWYgKHByb3ZpZGVLZXkgaW4gdm0uX3Byb3ZpZGVkKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSB2bS5fcHJvdmlkZWRbcHJvdmlkZUtleV07CiAgICAgIH0gZWxzZSBpZiAoJ2RlZmF1bHQnIGluIGluamVjdFtrZXldKSB7CiAgICAgICAgdmFyIHByb3ZpZGVEZWZhdWx0ID0gaW5qZWN0W2tleV0uZGVmYXVsdDsKICAgICAgICByZXN1bHRba2V5XSA9IGlzRnVuY3Rpb24ocHJvdmlkZURlZmF1bHQpID8gcHJvdmlkZURlZmF1bHQuY2FsbCh2bSkgOiBwcm92aWRlRGVmYXVsdDsKICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgd2FybigiSW5qZWN0aW9uIFwiIi5jb25jYXQoa2V5LCAiXCIgbm90IGZvdW5kIiksIHZtKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9Cn0KZnVuY3Rpb24gRnVuY3Rpb25hbFJlbmRlckNvbnRleHQoZGF0YSwgcHJvcHMsIGNoaWxkcmVuLCBwYXJlbnQsIEN0b3IpIHsKICB2YXIgX3RoaXMgPSB0aGlzOwogIHZhciBvcHRpb25zID0gQ3Rvci5vcHRpb25zOwogIC8vIGVuc3VyZSB0aGUgY3JlYXRlRWxlbWVudCBmdW5jdGlvbiBpbiBmdW5jdGlvbmFsIGNvbXBvbmVudHMKICAvLyBnZXRzIGEgdW5pcXVlIGNvbnRleHQgLSB0aGlzIGlzIG5lY2Vzc2FyeSBmb3IgY29ycmVjdCBuYW1lZCBzbG90IGNoZWNrCiAgdmFyIGNvbnRleHRWbTsKICBpZiAoaGFzT3duKHBhcmVudCwgJ191aWQnKSkgewogICAgY29udGV4dFZtID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQpOwogICAgY29udGV4dFZtLl9vcmlnaW5hbCA9IHBhcmVudDsKICB9IGVsc2UgewogICAgLy8gdGhlIGNvbnRleHQgdm0gcGFzc2VkIGluIGlzIGEgZnVuY3Rpb25hbCBjb250ZXh0IGFzIHdlbGwuCiAgICAvLyBpbiB0aGlzIGNhc2Ugd2Ugd2FudCB0byBtYWtlIHN1cmUgd2UgYXJlIGFibGUgdG8gZ2V0IGEgaG9sZCB0byB0aGUKICAgIC8vIHJlYWwgY29udGV4dCBpbnN0YW5jZS4KICAgIGNvbnRleHRWbSA9IHBhcmVudDsKICAgIC8vIEB0cy1pZ25vcmUKICAgIHBhcmVudCA9IHBhcmVudC5fb3JpZ2luYWw7CiAgfQogIHZhciBpc0NvbXBpbGVkID0gaXNUcnVlKG9wdGlvbnMuX2NvbXBpbGVkKTsKICB2YXIgbmVlZE5vcm1hbGl6YXRpb24gPSAhaXNDb21waWxlZDsKICB0aGlzLmRhdGEgPSBkYXRhOwogIHRoaXMucHJvcHMgPSBwcm9wczsKICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgdGhpcy5saXN0ZW5lcnMgPSBkYXRhLm9uIHx8IGVtcHR5T2JqZWN0OwogIHRoaXMuaW5qZWN0aW9ucyA9IHJlc29sdmVJbmplY3Qob3B0aW9ucy5pbmplY3QsIHBhcmVudCk7CiAgdGhpcy5zbG90cyA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghX3RoaXMuJHNsb3RzKSB7CiAgICAgIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKHBhcmVudCwgZGF0YS5zY29wZWRTbG90cywgX3RoaXMuJHNsb3RzID0gcmVzb2x2ZVNsb3RzKGNoaWxkcmVuLCBwYXJlbnQpKTsKICAgIH0KICAgIHJldHVybiBfdGhpcy4kc2xvdHM7CiAgfTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ3Njb3BlZFNsb3RzJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gbm9ybWFsaXplU2NvcGVkU2xvdHMocGFyZW50LCBkYXRhLnNjb3BlZFNsb3RzLCB0aGlzLnNsb3RzKCkpOwogICAgfQogIH0pOwogIC8vIHN1cHBvcnQgZm9yIGNvbXBpbGVkIGZ1bmN0aW9uYWwgdGVtcGxhdGUKICBpZiAoaXNDb21waWxlZCkgewogICAgLy8gZXhwb3NpbmcgJG9wdGlvbnMgZm9yIHJlbmRlclN0YXRpYygpCiAgICB0aGlzLiRvcHRpb25zID0gb3B0aW9uczsKICAgIC8vIHByZS1yZXNvbHZlIHNsb3RzIGZvciByZW5kZXJTbG90KCkKICAgIHRoaXMuJHNsb3RzID0gdGhpcy5zbG90cygpOwogICAgdGhpcy4kc2NvcGVkU2xvdHMgPSBub3JtYWxpemVTY29wZWRTbG90cyhwYXJlbnQsIGRhdGEuc2NvcGVkU2xvdHMsIHRoaXMuJHNsb3RzKTsKICB9CiAgaWYgKG9wdGlvbnMuX3Njb3BlSWQpIHsKICAgIHRoaXMuX2MgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgICB2YXIgdm5vZGUgPSBjcmVhdGVFbGVtZW50JDEoY29udGV4dFZtLCBhLCBiLCBjLCBkLCBuZWVkTm9ybWFsaXphdGlvbik7CiAgICAgIGlmICh2bm9kZSAmJiAhaXNBcnJheSh2bm9kZSkpIHsKICAgICAgICB2bm9kZS5mblNjb3BlSWQgPSBvcHRpb25zLl9zY29wZUlkOwogICAgICAgIHZub2RlLmZuQ29udGV4dCA9IHBhcmVudDsKICAgICAgfQogICAgICByZXR1cm4gdm5vZGU7CiAgICB9OwogIH0gZWxzZSB7CiAgICB0aGlzLl9jID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQkMShjb250ZXh0Vm0sIGEsIGIsIGMsIGQsIG5lZWROb3JtYWxpemF0aW9uKTsKICAgIH07CiAgfQp9Cmluc3RhbGxSZW5kZXJIZWxwZXJzKEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0LnByb3RvdHlwZSk7CmZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uYWxDb21wb25lbnQoQ3RvciwgcHJvcHNEYXRhLCBkYXRhLCBjb250ZXh0Vm0sIGNoaWxkcmVuKSB7CiAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CiAgdmFyIHByb3BzID0ge307CiAgdmFyIHByb3BPcHRpb25zID0gb3B0aW9ucy5wcm9wczsKICBpZiAoaXNEZWYocHJvcE9wdGlvbnMpKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gcHJvcE9wdGlvbnMpIHsKICAgICAgcHJvcHNba2V5XSA9IHZhbGlkYXRlUHJvcChrZXksIHByb3BPcHRpb25zLCBwcm9wc0RhdGEgfHwgZW1wdHlPYmplY3QpOwogICAgfQogIH0gZWxzZSB7CiAgICBpZiAoaXNEZWYoZGF0YS5hdHRycykpIG1lcmdlUHJvcHMocHJvcHMsIGRhdGEuYXR0cnMpOwogICAgaWYgKGlzRGVmKGRhdGEucHJvcHMpKSBtZXJnZVByb3BzKHByb3BzLCBkYXRhLnByb3BzKTsKICB9CiAgdmFyIHJlbmRlckNvbnRleHQgPSBuZXcgRnVuY3Rpb25hbFJlbmRlckNvbnRleHQoZGF0YSwgcHJvcHMsIGNoaWxkcmVuLCBjb250ZXh0Vm0sIEN0b3IpOwogIHZhciB2bm9kZSA9IG9wdGlvbnMucmVuZGVyLmNhbGwobnVsbCwgcmVuZGVyQ29udGV4dC5fYywgcmVuZGVyQ29udGV4dCk7CiAgaWYgKHZub2RlIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgIHJldHVybiBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2RlLCBkYXRhLCByZW5kZXJDb250ZXh0LnBhcmVudCwgb3B0aW9ucywgcmVuZGVyQ29udGV4dCk7CiAgfSBlbHNlIGlmIChpc0FycmF5KHZub2RlKSkgewogICAgdmFyIHZub2RlcyA9IG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlKSB8fCBbXTsKICAgIHZhciByZXMgPSBuZXcgQXJyYXkodm5vZGVzLmxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICByZXNbaV0gPSBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2Rlc1tpXSwgZGF0YSwgcmVuZGVyQ29udGV4dC5wYXJlbnQsIG9wdGlvbnMsIHJlbmRlckNvbnRleHQpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9Cn0KZnVuY3Rpb24gY2xvbmVBbmRNYXJrRnVuY3Rpb25hbFJlc3VsdCh2bm9kZSwgZGF0YSwgY29udGV4dFZtLCBvcHRpb25zLCByZW5kZXJDb250ZXh0KSB7CiAgLy8gIzc4MTcgY2xvbmUgbm9kZSBiZWZvcmUgc2V0dGluZyBmbkNvbnRleHQsIG90aGVyd2lzZSBpZiB0aGUgbm9kZSBpcyByZXVzZWQKICAvLyAoZS5nLiBpdCB3YXMgZnJvbSBhIGNhY2hlZCBub3JtYWwgc2xvdCkgdGhlIGZuQ29udGV4dCBjYXVzZXMgbmFtZWQgc2xvdHMKICAvLyB0aGF0IHNob3VsZCBub3QgYmUgbWF0Y2hlZCB0byBtYXRjaC4KICB2YXIgY2xvbmUgPSBjbG9uZVZOb2RlKHZub2RlKTsKICBjbG9uZS5mbkNvbnRleHQgPSBjb250ZXh0Vm07CiAgY2xvbmUuZm5PcHRpb25zID0gb3B0aW9uczsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgKGNsb25lLmRldnRvb2xzTWV0YSA9IGNsb25lLmRldnRvb2xzTWV0YSB8fCB7fSkucmVuZGVyQ29udGV4dCA9IHJlbmRlckNvbnRleHQ7CiAgfQogIGlmIChkYXRhLnNsb3QpIHsKICAgIChjbG9uZS5kYXRhIHx8IChjbG9uZS5kYXRhID0ge30pKS5zbG90ID0gZGF0YS5zbG90OwogIH0KICByZXR1cm4gY2xvbmU7Cn0KZnVuY3Rpb24gbWVyZ2VQcm9wcyh0bywgZnJvbSkgewogIGZvciAodmFyIGtleSBpbiBmcm9tKSB7CiAgICB0b1tjYW1lbGl6ZShrZXkpXSA9IGZyb21ba2V5XTsKICB9Cn0KZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZShvcHRpb25zKSB7CiAgcmV0dXJuIG9wdGlvbnMubmFtZSB8fCBvcHRpb25zLl9fbmFtZSB8fCBvcHRpb25zLl9jb21wb25lbnRUYWc7Cn0KLy8gaW5saW5lIGhvb2tzIHRvIGJlIGludm9rZWQgb24gY29tcG9uZW50IFZOb2RlcyBkdXJpbmcgcGF0Y2gKdmFyIGNvbXBvbmVudFZOb2RlSG9va3MgPSB7CiAgaW5pdDogZnVuY3Rpb24gaW5pdCh2bm9kZSwgaHlkcmF0aW5nKSB7CiAgICBpZiAodm5vZGUuY29tcG9uZW50SW5zdGFuY2UgJiYgIXZub2RlLmNvbXBvbmVudEluc3RhbmNlLl9pc0Rlc3Ryb3llZCAmJiB2bm9kZS5kYXRhLmtlZXBBbGl2ZSkgewogICAgICAvLyBrZXB0LWFsaXZlIGNvbXBvbmVudHMsIHRyZWF0IGFzIGEgcGF0Y2gKICAgICAgdmFyIG1vdW50ZWROb2RlID0gdm5vZGU7IC8vIHdvcmsgYXJvdW5kIGZsb3cKICAgICAgY29tcG9uZW50Vk5vZGVIb29rcy5wcmVwYXRjaChtb3VudGVkTm9kZSwgbW91bnRlZE5vZGUpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNoaWxkID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBjcmVhdGVDb21wb25lbnRJbnN0YW5jZUZvclZub2RlKHZub2RlLCBhY3RpdmVJbnN0YW5jZSk7CiAgICAgIGNoaWxkLiRtb3VudChoeWRyYXRpbmcgPyB2bm9kZS5lbG0gOiB1bmRlZmluZWQsIGh5ZHJhdGluZyk7CiAgICB9CiAgfSwKICBwcmVwYXRjaDogZnVuY3Rpb24gcHJlcGF0Y2gob2xkVm5vZGUsIHZub2RlKSB7CiAgICB2YXIgb3B0aW9ucyA9IHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CiAgICB2YXIgY2hpbGQgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSA9IG9sZFZub2RlLmNvbXBvbmVudEluc3RhbmNlOwogICAgdXBkYXRlQ2hpbGRDb21wb25lbnQoY2hpbGQsIG9wdGlvbnMucHJvcHNEYXRhLAogICAgLy8gdXBkYXRlZCBwcm9wcwogICAgb3B0aW9ucy5saXN0ZW5lcnMsCiAgICAvLyB1cGRhdGVkIGxpc3RlbmVycwogICAgdm5vZGUsCiAgICAvLyBuZXcgcGFyZW50IHZub2RlCiAgICBvcHRpb25zLmNoaWxkcmVuIC8vIG5ldyBjaGlsZHJlbgogICAgKTsKICB9LAoKICBpbnNlcnQ6IGZ1bmN0aW9uIGluc2VydCh2bm9kZSkgewogICAgdmFyIGNvbnRleHQgPSB2bm9kZS5jb250ZXh0LAogICAgICBjb21wb25lbnRJbnN0YW5jZSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlOwogICAgaWYgKCFjb21wb25lbnRJbnN0YW5jZS5faXNNb3VudGVkKSB7CiAgICAgIGNvbXBvbmVudEluc3RhbmNlLl9pc01vdW50ZWQgPSB0cnVlOwogICAgICBjYWxsSG9vayQxKGNvbXBvbmVudEluc3RhbmNlLCAnbW91bnRlZCcpOwogICAgfQogICAgaWYgKHZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgIGlmIChjb250ZXh0Ll9pc01vdW50ZWQpIHsKICAgICAgICAvLyB2dWUtcm91dGVyIzEyMTIKICAgICAgICAvLyBEdXJpbmcgdXBkYXRlcywgYSBrZXB0LWFsaXZlIGNvbXBvbmVudCdzIGNoaWxkIGNvbXBvbmVudHMgbWF5CiAgICAgICAgLy8gY2hhbmdlLCBzbyBkaXJlY3RseSB3YWxraW5nIHRoZSB0cmVlIGhlcmUgbWF5IGNhbGwgYWN0aXZhdGVkIGhvb2tzCiAgICAgICAgLy8gb24gaW5jb3JyZWN0IGNoaWxkcmVuLiBJbnN0ZWFkIHdlIHB1c2ggdGhlbSBpbnRvIGEgcXVldWUgd2hpY2ggd2lsbAogICAgICAgIC8vIGJlIHByb2Nlc3NlZCBhZnRlciB0aGUgd2hvbGUgcGF0Y2ggcHJvY2VzcyBlbmRlZC4KICAgICAgICBxdWV1ZUFjdGl2YXRlZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSwgdHJ1ZSAvKiBkaXJlY3QgKi8pOwogICAgICB9CiAgICB9CiAgfSwKCiAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSh2bm9kZSkgewogICAgdmFyIGNvbXBvbmVudEluc3RhbmNlID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICBpZiAoIWNvbXBvbmVudEluc3RhbmNlLl9pc0Rlc3Ryb3llZCkgewogICAgICBpZiAoIXZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgICAgY29tcG9uZW50SW5zdGFuY2UuJGRlc3Ryb3koKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQoY29tcG9uZW50SW5zdGFuY2UsIHRydWUgLyogZGlyZWN0ICovKTsKICAgICAgfQogICAgfQogIH0KfTsKCnZhciBob29rc1RvTWVyZ2UgPSBPYmplY3Qua2V5cyhjb21wb25lbnRWTm9kZUhvb2tzKTsKZnVuY3Rpb24gY3JlYXRlQ29tcG9uZW50KEN0b3IsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpIHsKICBpZiAoaXNVbmRlZihDdG9yKSkgewogICAgcmV0dXJuOwogIH0KICB2YXIgYmFzZUN0b3IgPSBjb250ZXh0LiRvcHRpb25zLl9iYXNlOwogIC8vIHBsYWluIG9wdGlvbnMgb2JqZWN0OiB0dXJuIGl0IGludG8gYSBjb25zdHJ1Y3RvcgogIGlmIChpc09iamVjdChDdG9yKSkgewogICAgQ3RvciA9IGJhc2VDdG9yLmV4dGVuZChDdG9yKTsKICB9CiAgLy8gaWYgYXQgdGhpcyBzdGFnZSBpdCdzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIGFuIGFzeW5jIGNvbXBvbmVudCBmYWN0b3J5LAogIC8vIHJlamVjdC4KICBpZiAodHlwZW9mIEN0b3IgIT09ICdmdW5jdGlvbicpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHdhcm4oIkludmFsaWQgQ29tcG9uZW50IGRlZmluaXRpb246ICIuY29uY2F0KFN0cmluZyhDdG9yKSksIGNvbnRleHQpOwogICAgfQogICAgcmV0dXJuOwogIH0KICAvLyBhc3luYyBjb21wb25lbnQKICB2YXIgYXN5bmNGYWN0b3J5OwogIC8vIEB0cy1leHBlY3QtZXJyb3IKICBpZiAoaXNVbmRlZihDdG9yLmNpZCkpIHsKICAgIGFzeW5jRmFjdG9yeSA9IEN0b3I7CiAgICBDdG9yID0gcmVzb2x2ZUFzeW5jQ29tcG9uZW50KGFzeW5jRmFjdG9yeSwgYmFzZUN0b3IpOwogICAgaWYgKEN0b3IgPT09IHVuZGVmaW5lZCkgewogICAgICAvLyByZXR1cm4gYSBwbGFjZWhvbGRlciBub2RlIGZvciBhc3luYyBjb21wb25lbnQsIHdoaWNoIGlzIHJlbmRlcmVkCiAgICAgIC8vIGFzIGEgY29tbWVudCBub2RlIGJ1dCBwcmVzZXJ2ZXMgYWxsIHRoZSByYXcgaW5mb3JtYXRpb24gZm9yIHRoZSBub2RlLgogICAgICAvLyB0aGUgaW5mb3JtYXRpb24gd2lsbCBiZSB1c2VkIGZvciBhc3luYyBzZXJ2ZXItcmVuZGVyaW5nIGFuZCBoeWRyYXRpb24uCiAgICAgIHJldHVybiBjcmVhdGVBc3luY1BsYWNlaG9sZGVyKGFzeW5jRmFjdG9yeSwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZyk7CiAgICB9CiAgfQogIGRhdGEgPSBkYXRhIHx8IHt9OwogIC8vIHJlc29sdmUgY29uc3RydWN0b3Igb3B0aW9ucyBpbiBjYXNlIGdsb2JhbCBtaXhpbnMgYXJlIGFwcGxpZWQgYWZ0ZXIKICAvLyBjb21wb25lbnQgY29uc3RydWN0b3IgY3JlYXRpb24KICByZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKEN0b3IpOwogIC8vIHRyYW5zZm9ybSBjb21wb25lbnQgdi1tb2RlbCBkYXRhIGludG8gcHJvcHMgJiBldmVudHMKICBpZiAoaXNEZWYoZGF0YS5tb2RlbCkpIHsKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgIHRyYW5zZm9ybU1vZGVsKEN0b3Iub3B0aW9ucywgZGF0YSk7CiAgfQogIC8vIGV4dHJhY3QgcHJvcHMKICAvLyBAdHMtZXhwZWN0LWVycm9yCiAgdmFyIHByb3BzRGF0YSA9IGV4dHJhY3RQcm9wc0Zyb21WTm9kZURhdGEoZGF0YSwgQ3RvciwgdGFnKTsKICAvLyBmdW5jdGlvbmFsIGNvbXBvbmVudAogIC8vIEB0cy1leHBlY3QtZXJyb3IKICBpZiAoaXNUcnVlKEN0b3Iub3B0aW9ucy5mdW5jdGlvbmFsKSkgewogICAgcmV0dXJuIGNyZWF0ZUZ1bmN0aW9uYWxDb21wb25lbnQoQ3RvciwgcHJvcHNEYXRhLCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbik7CiAgfQogIC8vIGV4dHJhY3QgbGlzdGVuZXJzLCBzaW5jZSB0aGVzZSBuZWVkcyB0byBiZSB0cmVhdGVkIGFzCiAgLy8gY2hpbGQgY29tcG9uZW50IGxpc3RlbmVycyBpbnN0ZWFkIG9mIERPTSBsaXN0ZW5lcnMKICB2YXIgbGlzdGVuZXJzID0gZGF0YS5vbjsKICAvLyByZXBsYWNlIHdpdGggbGlzdGVuZXJzIHdpdGggLm5hdGl2ZSBtb2RpZmllcgogIC8vIHNvIGl0IGdldHMgcHJvY2Vzc2VkIGR1cmluZyBwYXJlbnQgY29tcG9uZW50IHBhdGNoLgogIGRhdGEub24gPSBkYXRhLm5hdGl2ZU9uOwogIC8vIEB0cy1leHBlY3QtZXJyb3IKICBpZiAoaXNUcnVlKEN0b3Iub3B0aW9ucy5hYnN0cmFjdCkpIHsKICAgIC8vIGFic3RyYWN0IGNvbXBvbmVudHMgZG8gbm90IGtlZXAgYW55dGhpbmcKICAgIC8vIG90aGVyIHRoYW4gcHJvcHMgJiBsaXN0ZW5lcnMgJiBzbG90CiAgICAvLyB3b3JrIGFyb3VuZCBmbG93CiAgICB2YXIgc2xvdCA9IGRhdGEuc2xvdDsKICAgIGRhdGEgPSB7fTsKICAgIGlmIChzbG90KSB7CiAgICAgIGRhdGEuc2xvdCA9IHNsb3Q7CiAgICB9CiAgfQogIC8vIGluc3RhbGwgY29tcG9uZW50IG1hbmFnZW1lbnQgaG9va3Mgb250byB0aGUgcGxhY2Vob2xkZXIgbm9kZQogIGluc3RhbGxDb21wb25lbnRIb29rcyhkYXRhKTsKICAvLyByZXR1cm4gYSBwbGFjZWhvbGRlciB2bm9kZQogIC8vIEB0cy1leHBlY3QtZXJyb3IKICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWUoQ3Rvci5vcHRpb25zKSB8fCB0YWc7CiAgdmFyIHZub2RlID0gbmV3IFZOb2RlKAogIC8vIEB0cy1leHBlY3QtZXJyb3IKICAidnVlLWNvbXBvbmVudC0iLmNvbmNhdChDdG9yLmNpZCkuY29uY2F0KG5hbWUgPyAiLSIuY29uY2F0KG5hbWUpIDogJycpLCBkYXRhLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZXh0LAogIC8vIEB0cy1leHBlY3QtZXJyb3IKICB7CiAgICBDdG9yOiBDdG9yLAogICAgcHJvcHNEYXRhOiBwcm9wc0RhdGEsCiAgICBsaXN0ZW5lcnM6IGxpc3RlbmVycywKICAgIHRhZzogdGFnLAogICAgY2hpbGRyZW46IGNoaWxkcmVuCiAgfSwgYXN5bmNGYWN0b3J5KTsKICByZXR1cm4gdm5vZGU7Cn0KZnVuY3Rpb24gY3JlYXRlQ29tcG9uZW50SW5zdGFuY2VGb3JWbm9kZSgKLy8gd2Uga25vdyBpdCdzIE1vdW50ZWRDb21wb25lbnRWTm9kZSBidXQgZmxvdyBkb2Vzbid0CnZub2RlLAovLyBhY3RpdmVJbnN0YW5jZSBpbiBsaWZlY3ljbGUgc3RhdGUKcGFyZW50KSB7CiAgdmFyIG9wdGlvbnMgPSB7CiAgICBfaXNDb21wb25lbnQ6IHRydWUsCiAgICBfcGFyZW50Vm5vZGU6IHZub2RlLAogICAgcGFyZW50OiBwYXJlbnQKICB9OwogIC8vIGNoZWNrIGlubGluZS10ZW1wbGF0ZSByZW5kZXIgZnVuY3Rpb25zCiAgdmFyIGlubGluZVRlbXBsYXRlID0gdm5vZGUuZGF0YS5pbmxpbmVUZW1wbGF0ZTsKICBpZiAoaXNEZWYoaW5saW5lVGVtcGxhdGUpKSB7CiAgICBvcHRpb25zLnJlbmRlciA9IGlubGluZVRlbXBsYXRlLnJlbmRlcjsKICAgIG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zID0gaW5saW5lVGVtcGxhdGUuc3RhdGljUmVuZGVyRm5zOwogIH0KICByZXR1cm4gbmV3IHZub2RlLmNvbXBvbmVudE9wdGlvbnMuQ3RvcihvcHRpb25zKTsKfQpmdW5jdGlvbiBpbnN0YWxsQ29tcG9uZW50SG9va3MoZGF0YSkgewogIHZhciBob29rcyA9IGRhdGEuaG9vayB8fCAoZGF0YS5ob29rID0ge30pOwogIGZvciAodmFyIGkgPSAwOyBpIDwgaG9va3NUb01lcmdlLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIga2V5ID0gaG9va3NUb01lcmdlW2ldOwogICAgdmFyIGV4aXN0aW5nID0gaG9va3Nba2V5XTsKICAgIHZhciB0b01lcmdlID0gY29tcG9uZW50Vk5vZGVIb29rc1trZXldOwogICAgLy8gQHRzLWV4cGVjdC1lcnJvcgogICAgaWYgKGV4aXN0aW5nICE9PSB0b01lcmdlICYmICEoZXhpc3RpbmcgJiYgZXhpc3RpbmcuX21lcmdlZCkpIHsKICAgICAgaG9va3Nba2V5XSA9IGV4aXN0aW5nID8gbWVyZ2VIb29rKHRvTWVyZ2UsIGV4aXN0aW5nKSA6IHRvTWVyZ2U7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIG1lcmdlSG9vayhmMSwgZjIpIHsKICB2YXIgbWVyZ2VkID0gZnVuY3Rpb24gbWVyZ2VkKGEsIGIpIHsKICAgIC8vIGZsb3cgY29tcGxhaW5zIGFib3V0IGV4dHJhIGFyZ3Mgd2hpY2ggaXMgd2h5IHdlIHVzZSBhbnkKICAgIGYxKGEsIGIpOwogICAgZjIoYSwgYik7CiAgfTsKICBtZXJnZWQuX21lcmdlZCA9IHRydWU7CiAgcmV0dXJuIG1lcmdlZDsKfQovLyB0cmFuc2Zvcm0gY29tcG9uZW50IHYtbW9kZWwgaW5mbyAodmFsdWUgYW5kIGNhbGxiYWNrKSBpbnRvCi8vIHByb3AgYW5kIGV2ZW50IGhhbmRsZXIgcmVzcGVjdGl2ZWx5LgpmdW5jdGlvbiB0cmFuc2Zvcm1Nb2RlbChvcHRpb25zLCBkYXRhKSB7CiAgdmFyIHByb3AgPSBvcHRpb25zLm1vZGVsICYmIG9wdGlvbnMubW9kZWwucHJvcCB8fCAndmFsdWUnOwogIHZhciBldmVudCA9IG9wdGlvbnMubW9kZWwgJiYgb3B0aW9ucy5tb2RlbC5ldmVudCB8fCAnaW5wdXQnOwogIChkYXRhLmF0dHJzIHx8IChkYXRhLmF0dHJzID0ge30pKVtwcm9wXSA9IGRhdGEubW9kZWwudmFsdWU7CiAgdmFyIG9uID0gZGF0YS5vbiB8fCAoZGF0YS5vbiA9IHt9KTsKICB2YXIgZXhpc3RpbmcgPSBvbltldmVudF07CiAgdmFyIGNhbGxiYWNrID0gZGF0YS5tb2RlbC5jYWxsYmFjazsKICBpZiAoaXNEZWYoZXhpc3RpbmcpKSB7CiAgICBpZiAoaXNBcnJheShleGlzdGluZykgPyBleGlzdGluZy5pbmRleE9mKGNhbGxiYWNrKSA9PT0gLTEgOiBleGlzdGluZyAhPT0gY2FsbGJhY2spIHsKICAgICAgb25bZXZlbnRdID0gW2NhbGxiYWNrXS5jb25jYXQoZXhpc3RpbmcpOwogICAgfQogIH0gZWxzZSB7CiAgICBvbltldmVudF0gPSBjYWxsYmFjazsKICB9Cn0KdmFyIHdhcm4gPSBub29wOwp2YXIgdGlwID0gbm9vcDsKdmFyIGdlbmVyYXRlQ29tcG9uZW50VHJhY2U7IC8vIHdvcmsgYXJvdW5kIGZsb3cgY2hlY2sKdmFyIGZvcm1hdENvbXBvbmVudE5hbWU7CmlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgdmFyIGhhc0NvbnNvbGVfMSA9IHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJzsKICB2YXIgY2xhc3NpZnlSRV8xID0gLyg/Ol58Wy1fXSkoXHcpL2c7CiAgdmFyIGNsYXNzaWZ5XzEgPSBmdW5jdGlvbiBjbGFzc2lmeV8xKHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNsYXNzaWZ5UkVfMSwgZnVuY3Rpb24gKGMpIHsKICAgICAgcmV0dXJuIGMudG9VcHBlckNhc2UoKTsKICAgIH0pLnJlcGxhY2UoL1stX10vZywgJycpOwogIH07CiAgd2FybiA9IGZ1bmN0aW9uIHdhcm4obXNnLCB2bSkgewogICAgaWYgKHZtID09PSB2b2lkIDApIHsKICAgICAgdm0gPSBjdXJyZW50SW5zdGFuY2U7CiAgICB9CiAgICB2YXIgdHJhY2UgPSB2bSA/IGdlbmVyYXRlQ29tcG9uZW50VHJhY2Uodm0pIDogJyc7CiAgICBpZiAoY29uZmlnLndhcm5IYW5kbGVyKSB7CiAgICAgIGNvbmZpZy53YXJuSGFuZGxlci5jYWxsKG51bGwsIG1zZywgdm0sIHRyYWNlKTsKICAgIH0gZWxzZSBpZiAoaGFzQ29uc29sZV8xICYmICFjb25maWcuc2lsZW50KSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIltWdWUgd2Fybl06ICIuY29uY2F0KG1zZykuY29uY2F0KHRyYWNlKSk7CiAgICB9CiAgfTsKICB0aXAgPSBmdW5jdGlvbiB0aXAobXNnLCB2bSkgewogICAgaWYgKGhhc0NvbnNvbGVfMSAmJiAhY29uZmlnLnNpbGVudCkgewogICAgICBjb25zb2xlLndhcm4oIltWdWUgdGlwXTogIi5jb25jYXQobXNnKSArICh2bSA/IGdlbmVyYXRlQ29tcG9uZW50VHJhY2Uodm0pIDogJycpKTsKICAgIH0KICB9OwogIGZvcm1hdENvbXBvbmVudE5hbWUgPSBmdW5jdGlvbiBmb3JtYXRDb21wb25lbnROYW1lKHZtLCBpbmNsdWRlRmlsZSkgewogICAgaWYgKHZtLiRyb290ID09PSB2bSkgewogICAgICByZXR1cm4gJzxSb290Pic7CiAgICB9CiAgICB2YXIgb3B0aW9ucyA9IGlzRnVuY3Rpb24odm0pICYmIHZtLmNpZCAhPSBudWxsID8gdm0ub3B0aW9ucyA6IHZtLl9pc1Z1ZSA/IHZtLiRvcHRpb25zIHx8IHZtLmNvbnN0cnVjdG9yLm9wdGlvbnMgOiB2bTsKICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZShvcHRpb25zKTsKICAgIHZhciBmaWxlID0gb3B0aW9ucy5fX2ZpbGU7CiAgICBpZiAoIW5hbWUgJiYgZmlsZSkgewogICAgICB2YXIgbWF0Y2ggPSBmaWxlLm1hdGNoKC8oW14vXFxdKylcLnZ1ZSQvKTsKICAgICAgbmFtZSA9IG1hdGNoICYmIG1hdGNoWzFdOwogICAgfQogICAgcmV0dXJuIChuYW1lID8gIjwiLmNvbmNhdChjbGFzc2lmeV8xKG5hbWUpLCAiPiIpIDogIjxBbm9ueW1vdXM+IikgKyAoZmlsZSAmJiBpbmNsdWRlRmlsZSAhPT0gZmFsc2UgPyAiIGF0ICIuY29uY2F0KGZpbGUpIDogJycpOwogIH07CiAgdmFyIHJlcGVhdF8xID0gZnVuY3Rpb24gcmVwZWF0XzEoc3RyLCBuKSB7CiAgICB2YXIgcmVzID0gJyc7CiAgICB3aGlsZSAobikgewogICAgICBpZiAobiAlIDIgPT09IDEpIHJlcyArPSBzdHI7CiAgICAgIGlmIChuID4gMSkgc3RyICs9IHN0cjsKICAgICAgbiA+Pj0gMTsKICAgIH0KICAgIHJldHVybiByZXM7CiAgfTsKICBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlID0gZnVuY3Rpb24gZ2VuZXJhdGVDb21wb25lbnRUcmFjZSh2bSkgewogICAgaWYgKHZtLl9pc1Z1ZSAmJiB2bS4kcGFyZW50KSB7CiAgICAgIHZhciB0cmVlID0gW107CiAgICAgIHZhciBjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2UgPSAwOwogICAgICB3aGlsZSAodm0pIHsKICAgICAgICBpZiAodHJlZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgbGFzdCA9IHRyZWVbdHJlZS5sZW5ndGggLSAxXTsKICAgICAgICAgIGlmIChsYXN0LmNvbnN0cnVjdG9yID09PSB2bS5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICBjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2UrKzsKICAgICAgICAgICAgdm0gPSB2bS4kcGFyZW50OwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlID4gMCkgewogICAgICAgICAgICB0cmVlW3RyZWUubGVuZ3RoIC0gMV0gPSBbbGFzdCwgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlXTsKICAgICAgICAgICAgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdHJlZS5wdXNoKHZtKTsKICAgICAgICB2bSA9IHZtLiRwYXJlbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuICdcblxuZm91bmQgaW5cblxuJyArIHRyZWUubWFwKGZ1bmN0aW9uICh2bSwgaSkgewogICAgICAgIHJldHVybiAiIi5jb25jYXQoaSA9PT0gMCA/ICctLS0+ICcgOiByZXBlYXRfMSgnICcsIDUgKyBpICogMikpLmNvbmNhdChpc0FycmF5KHZtKSA/ICIiLmNvbmNhdChmb3JtYXRDb21wb25lbnROYW1lKHZtWzBdKSwgIi4uLiAoIikuY29uY2F0KHZtWzFdLCAiIHJlY3Vyc2l2ZSBjYWxscykiKSA6IGZvcm1hdENvbXBvbmVudE5hbWUodm0pKTsKICAgICAgfSkuam9pbignXG4nKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAiXG5cbihmb3VuZCBpbiAiLmNvbmNhdChmb3JtYXRDb21wb25lbnROYW1lKHZtKSwgIikiKTsKICAgIH0KICB9Owp9CgovKioKICogT3B0aW9uIG92ZXJ3cml0aW5nIHN0cmF0ZWdpZXMgYXJlIGZ1bmN0aW9ucyB0aGF0IGhhbmRsZQogKiBob3cgdG8gbWVyZ2UgYSBwYXJlbnQgb3B0aW9uIHZhbHVlIGFuZCBhIGNoaWxkIG9wdGlvbgogKiB2YWx1ZSBpbnRvIHRoZSBmaW5hbCB2YWx1ZS4KICovCnZhciBzdHJhdHMgPSBjb25maWcub3B0aW9uTWVyZ2VTdHJhdGVnaWVzOwovKioKICogT3B0aW9ucyB3aXRoIHJlc3RyaWN0aW9ucwogKi8KaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICBzdHJhdHMuZWwgPSBzdHJhdHMucHJvcHNEYXRhID0gZnVuY3Rpb24gKHBhcmVudCwgY2hpbGQsIHZtLCBrZXkpIHsKICAgIGlmICghdm0pIHsKICAgICAgd2Fybigib3B0aW9uIFwiIi5jb25jYXQoa2V5LCAiXCIgY2FuIG9ubHkgYmUgdXNlZCBkdXJpbmcgaW5zdGFuY2UgIikgKyAnY3JlYXRpb24gd2l0aCB0aGUgYG5ld2Aga2V5d29yZC4nKTsKICAgIH0KICAgIHJldHVybiBkZWZhdWx0U3RyYXQocGFyZW50LCBjaGlsZCk7CiAgfTsKfQovKioKICogSGVscGVyIHRoYXQgcmVjdXJzaXZlbHkgbWVyZ2VzIHR3byBkYXRhIG9iamVjdHMgdG9nZXRoZXIuCiAqLwpmdW5jdGlvbiBtZXJnZURhdGEodG8sIGZyb20sIHJlY3Vyc2l2ZSkgewogIGlmIChyZWN1cnNpdmUgPT09IHZvaWQgMCkgewogICAgcmVjdXJzaXZlID0gdHJ1ZTsKICB9CiAgaWYgKCFmcm9tKSByZXR1cm4gdG87CiAgdmFyIGtleSwgdG9WYWwsIGZyb21WYWw7CiAgdmFyIGtleXMgPSBoYXNTeW1ib2wgPyBSZWZsZWN0Lm93bktleXMoZnJvbSkgOiBPYmplY3Qua2V5cyhmcm9tKTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIGtleSA9IGtleXNbaV07CiAgICAvLyBpbiBjYXNlIHRoZSBvYmplY3QgaXMgYWxyZWFkeSBvYnNlcnZlZC4uLgogICAgaWYgKGtleSA9PT0gJ19fb2JfXycpIGNvbnRpbnVlOwogICAgdG9WYWwgPSB0b1trZXldOwogICAgZnJvbVZhbCA9IGZyb21ba2V5XTsKICAgIGlmICghcmVjdXJzaXZlIHx8ICFoYXNPd24odG8sIGtleSkpIHsKICAgICAgc2V0KHRvLCBrZXksIGZyb21WYWwpOwogICAgfSBlbHNlIGlmICh0b1ZhbCAhPT0gZnJvbVZhbCAmJiBpc1BsYWluT2JqZWN0KHRvVmFsKSAmJiBpc1BsYWluT2JqZWN0KGZyb21WYWwpKSB7CiAgICAgIG1lcmdlRGF0YSh0b1ZhbCwgZnJvbVZhbCk7CiAgICB9CiAgfQogIHJldHVybiB0bzsKfQovKioKICogRGF0YQogKi8KZnVuY3Rpb24gbWVyZ2VEYXRhT3JGbihwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSkgewogIGlmICghdm0pIHsKICAgIC8vIGluIGEgVnVlLmV4dGVuZCBtZXJnZSwgYm90aCBzaG91bGQgYmUgZnVuY3Rpb25zCiAgICBpZiAoIWNoaWxkVmFsKSB7CiAgICAgIHJldHVybiBwYXJlbnRWYWw7CiAgICB9CiAgICBpZiAoIXBhcmVudFZhbCkgewogICAgICByZXR1cm4gY2hpbGRWYWw7CiAgICB9CiAgICAvLyB3aGVuIHBhcmVudFZhbCAmIGNoaWxkVmFsIGFyZSBib3RoIHByZXNlbnQsCiAgICAvLyB3ZSBuZWVkIHRvIHJldHVybiBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUKICAgIC8vIG1lcmdlZCByZXN1bHQgb2YgYm90aCBmdW5jdGlvbnMuLi4gbm8gbmVlZCB0bwogICAgLy8gY2hlY2sgaWYgcGFyZW50VmFsIGlzIGEgZnVuY3Rpb24gaGVyZSBiZWNhdXNlCiAgICAvLyBpdCBoYXMgdG8gYmUgYSBmdW5jdGlvbiB0byBwYXNzIHByZXZpb3VzIG1lcmdlcy4KICAgIHJldHVybiBmdW5jdGlvbiBtZXJnZWREYXRhRm4oKSB7CiAgICAgIHJldHVybiBtZXJnZURhdGEoaXNGdW5jdGlvbihjaGlsZFZhbCkgPyBjaGlsZFZhbC5jYWxsKHRoaXMsIHRoaXMpIDogY2hpbGRWYWwsIGlzRnVuY3Rpb24ocGFyZW50VmFsKSA/IHBhcmVudFZhbC5jYWxsKHRoaXMsIHRoaXMpIDogcGFyZW50VmFsKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIHJldHVybiBmdW5jdGlvbiBtZXJnZWRJbnN0YW5jZURhdGFGbigpIHsKICAgICAgLy8gaW5zdGFuY2UgbWVyZ2UKICAgICAgdmFyIGluc3RhbmNlRGF0YSA9IGlzRnVuY3Rpb24oY2hpbGRWYWwpID8gY2hpbGRWYWwuY2FsbCh2bSwgdm0pIDogY2hpbGRWYWw7CiAgICAgIHZhciBkZWZhdWx0RGF0YSA9IGlzRnVuY3Rpb24ocGFyZW50VmFsKSA/IHBhcmVudFZhbC5jYWxsKHZtLCB2bSkgOiBwYXJlbnRWYWw7CiAgICAgIGlmIChpbnN0YW5jZURhdGEpIHsKICAgICAgICByZXR1cm4gbWVyZ2VEYXRhKGluc3RhbmNlRGF0YSwgZGVmYXVsdERhdGEpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkZWZhdWx0RGF0YTsKICAgICAgfQogICAgfTsKICB9Cn0Kc3RyYXRzLmRhdGEgPSBmdW5jdGlvbiAocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0pIHsKICBpZiAoIXZtKSB7CiAgICBpZiAoY2hpbGRWYWwgJiYgdHlwZW9mIGNoaWxkVmFsICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybignVGhlICJkYXRhIiBvcHRpb24gc2hvdWxkIGJlIGEgZnVuY3Rpb24gJyArICd0aGF0IHJldHVybnMgYSBwZXItaW5zdGFuY2UgdmFsdWUgaW4gY29tcG9uZW50ICcgKyAnZGVmaW5pdGlvbnMuJywgdm0pOwogICAgICByZXR1cm4gcGFyZW50VmFsOwogICAgfQogICAgcmV0dXJuIG1lcmdlRGF0YU9yRm4ocGFyZW50VmFsLCBjaGlsZFZhbCk7CiAgfQogIHJldHVybiBtZXJnZURhdGFPckZuKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtKTsKfTsKLyoqCiAqIEhvb2tzIGFuZCBwcm9wcyBhcmUgbWVyZ2VkIGFzIGFycmF5cy4KICovCmZ1bmN0aW9uIG1lcmdlTGlmZWN5Y2xlSG9vayhwYXJlbnRWYWwsIGNoaWxkVmFsKSB7CiAgdmFyIHJlcyA9IGNoaWxkVmFsID8gcGFyZW50VmFsID8gcGFyZW50VmFsLmNvbmNhdChjaGlsZFZhbCkgOiBpc0FycmF5KGNoaWxkVmFsKSA/IGNoaWxkVmFsIDogW2NoaWxkVmFsXSA6IHBhcmVudFZhbDsKICByZXR1cm4gcmVzID8gZGVkdXBlSG9va3MocmVzKSA6IHJlczsKfQpmdW5jdGlvbiBkZWR1cGVIb29rcyhob29rcykgewogIHZhciByZXMgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAocmVzLmluZGV4T2YoaG9va3NbaV0pID09PSAtMSkgewogICAgICByZXMucHVzaChob29rc1tpXSk7CiAgICB9CiAgfQogIHJldHVybiByZXM7Cn0KTElGRUNZQ0xFX0hPT0tTLmZvckVhY2goZnVuY3Rpb24gKGhvb2spIHsKICBzdHJhdHNbaG9va10gPSBtZXJnZUxpZmVjeWNsZUhvb2s7Cn0pOwovKioKICogQXNzZXRzCiAqCiAqIFdoZW4gYSB2bSBpcyBwcmVzZW50IChpbnN0YW5jZSBjcmVhdGlvbiksIHdlIG5lZWQgdG8gZG8KICogYSB0aHJlZS13YXkgbWVyZ2UgYmV0d2VlbiBjb25zdHJ1Y3RvciBvcHRpb25zLCBpbnN0YW5jZQogKiBvcHRpb25zIGFuZCBwYXJlbnQgb3B0aW9ucy4KICovCmZ1bmN0aW9uIG1lcmdlQXNzZXRzKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtLCBrZXkpIHsKICB2YXIgcmVzID0gT2JqZWN0LmNyZWF0ZShwYXJlbnRWYWwgfHwgbnVsbCk7CiAgaWYgKGNoaWxkVmFsKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGFzc2VydE9iamVjdFR5cGUoa2V5LCBjaGlsZFZhbCwgdm0pOwogICAgcmV0dXJuIGV4dGVuZChyZXMsIGNoaWxkVmFsKTsKICB9IGVsc2UgewogICAgcmV0dXJuIHJlczsKICB9Cn0KQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogIHN0cmF0c1t0eXBlICsgJ3MnXSA9IG1lcmdlQXNzZXRzOwp9KTsKLyoqCiAqIFdhdGNoZXJzLgogKgogKiBXYXRjaGVycyBoYXNoZXMgc2hvdWxkIG5vdCBvdmVyd3JpdGUgb25lCiAqIGFub3RoZXIsIHNvIHdlIG1lcmdlIHRoZW0gYXMgYXJyYXlzLgogKi8Kc3RyYXRzLndhdGNoID0gZnVuY3Rpb24gKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtLCBrZXkpIHsKICAvLyB3b3JrIGFyb3VuZCBGaXJlZm94J3MgT2JqZWN0LnByb3RvdHlwZS53YXRjaC4uLgogIC8vQHRzLWV4cGVjdC1lcnJvciB3b3JrIGFyb3VuZAogIGlmIChwYXJlbnRWYWwgPT09IG5hdGl2ZVdhdGNoKSBwYXJlbnRWYWwgPSB1bmRlZmluZWQ7CiAgLy9AdHMtZXhwZWN0LWVycm9yIHdvcmsgYXJvdW5kCiAgaWYgKGNoaWxkVmFsID09PSBuYXRpdmVXYXRjaCkgY2hpbGRWYWwgPSB1bmRlZmluZWQ7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFjaGlsZFZhbCkgcmV0dXJuIE9iamVjdC5jcmVhdGUocGFyZW50VmFsIHx8IG51bGwpOwogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBhc3NlcnRPYmplY3RUeXBlKGtleSwgY2hpbGRWYWwsIHZtKTsKICB9CiAgaWYgKCFwYXJlbnRWYWwpIHJldHVybiBjaGlsZFZhbDsKICB2YXIgcmV0ID0ge307CiAgZXh0ZW5kKHJldCwgcGFyZW50VmFsKTsKICBmb3IgKHZhciBrZXlfMSBpbiBjaGlsZFZhbCkgewogICAgdmFyIHBhcmVudF8xID0gcmV0W2tleV8xXTsKICAgIHZhciBjaGlsZCA9IGNoaWxkVmFsW2tleV8xXTsKICAgIGlmIChwYXJlbnRfMSAmJiAhaXNBcnJheShwYXJlbnRfMSkpIHsKICAgICAgcGFyZW50XzEgPSBbcGFyZW50XzFdOwogICAgfQogICAgcmV0W2tleV8xXSA9IHBhcmVudF8xID8gcGFyZW50XzEuY29uY2F0KGNoaWxkKSA6IGlzQXJyYXkoY2hpbGQpID8gY2hpbGQgOiBbY2hpbGRdOwogIH0KICByZXR1cm4gcmV0Owp9OwovKioKICogT3RoZXIgb2JqZWN0IGhhc2hlcy4KICovCnN0cmF0cy5wcm9wcyA9IHN0cmF0cy5tZXRob2RzID0gc3RyYXRzLmluamVjdCA9IHN0cmF0cy5jb21wdXRlZCA9IGZ1bmN0aW9uIChwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSwga2V5KSB7CiAgaWYgKGNoaWxkVmFsICYmIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGFzc2VydE9iamVjdFR5cGUoa2V5LCBjaGlsZFZhbCwgdm0pOwogIH0KICBpZiAoIXBhcmVudFZhbCkgcmV0dXJuIGNoaWxkVmFsOwogIHZhciByZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIGV4dGVuZChyZXQsIHBhcmVudFZhbCk7CiAgaWYgKGNoaWxkVmFsKSBleHRlbmQocmV0LCBjaGlsZFZhbCk7CiAgcmV0dXJuIHJldDsKfTsKc3RyYXRzLnByb3ZpZGUgPSBmdW5jdGlvbiAocGFyZW50VmFsLCBjaGlsZFZhbCkgewogIGlmICghcGFyZW50VmFsKSByZXR1cm4gY2hpbGRWYWw7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHZhciByZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgbWVyZ2VEYXRhKHJldCwgaXNGdW5jdGlvbihwYXJlbnRWYWwpID8gcGFyZW50VmFsLmNhbGwodGhpcykgOiBwYXJlbnRWYWwpOwogICAgaWYgKGNoaWxkVmFsKSB7CiAgICAgIG1lcmdlRGF0YShyZXQsIGlzRnVuY3Rpb24oY2hpbGRWYWwpID8gY2hpbGRWYWwuY2FsbCh0aGlzKSA6IGNoaWxkVmFsLCBmYWxzZSAvLyBub24tcmVjdXJzaXZlCiAgICAgICk7CiAgICB9CgogICAgcmV0dXJuIHJldDsKICB9Owp9OwovKioKICogRGVmYXVsdCBzdHJhdGVneS4KICovCnZhciBkZWZhdWx0U3RyYXQgPSBmdW5jdGlvbiBkZWZhdWx0U3RyYXQocGFyZW50VmFsLCBjaGlsZFZhbCkgewogIHJldHVybiBjaGlsZFZhbCA9PT0gdW5kZWZpbmVkID8gcGFyZW50VmFsIDogY2hpbGRWYWw7Cn07Ci8qKgogKiBWYWxpZGF0ZSBjb21wb25lbnQgbmFtZXMKICovCmZ1bmN0aW9uIGNoZWNrQ29tcG9uZW50cyhvcHRpb25zKSB7CiAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMuY29tcG9uZW50cykgewogICAgdmFsaWRhdGVDb21wb25lbnROYW1lKGtleSk7CiAgfQp9CmZ1bmN0aW9uIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lKSB7CiAgaWYgKCFuZXcgUmVnRXhwKCJeW2EtekEtWl1bXFwtXFwuMC05XyIuY29uY2F0KHVuaWNvZGVSZWdFeHAuc291cmNlLCAiXSokIikpLnRlc3QobmFtZSkpIHsKICAgIHdhcm4oJ0ludmFsaWQgY29tcG9uZW50IG5hbWU6ICInICsgbmFtZSArICciLiBDb21wb25lbnQgbmFtZXMgJyArICdzaG91bGQgY29uZm9ybSB0byB2YWxpZCBjdXN0b20gZWxlbWVudCBuYW1lIGluIGh0bWw1IHNwZWNpZmljYXRpb24uJyk7CiAgfQogIGlmIChpc0J1aWx0SW5UYWcobmFtZSkgfHwgY29uZmlnLmlzUmVzZXJ2ZWRUYWcobmFtZSkpIHsKICAgIHdhcm4oJ0RvIG5vdCB1c2UgYnVpbHQtaW4gb3IgcmVzZXJ2ZWQgSFRNTCBlbGVtZW50cyBhcyBjb21wb25lbnQgJyArICdpZDogJyArIG5hbWUpOwogIH0KfQovKioKICogRW5zdXJlIGFsbCBwcm9wcyBvcHRpb24gc3ludGF4IGFyZSBub3JtYWxpemVkIGludG8gdGhlCiAqIE9iamVjdC1iYXNlZCBmb3JtYXQuCiAqLwpmdW5jdGlvbiBub3JtYWxpemVQcm9wcyhvcHRpb25zLCB2bSkgewogIHZhciBwcm9wcyA9IG9wdGlvbnMucHJvcHM7CiAgaWYgKCFwcm9wcykgcmV0dXJuOwogIHZhciByZXMgPSB7fTsKICB2YXIgaSwgdmFsLCBuYW1lOwogIGlmIChpc0FycmF5KHByb3BzKSkgewogICAgaSA9IHByb3BzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdmFsID0gcHJvcHNbaV07CiAgICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgICAgIG5hbWUgPSBjYW1lbGl6ZSh2YWwpOwogICAgICAgIHJlc1tuYW1lXSA9IHsKICAgICAgICAgIHR5cGU6IG51bGwKICAgICAgICB9OwogICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICB3YXJuKCdwcm9wcyBtdXN0IGJlIHN0cmluZ3Mgd2hlbiB1c2luZyBhcnJheSBzeW50YXguJyk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QocHJvcHMpKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgdmFsID0gcHJvcHNba2V5XTsKICAgICAgbmFtZSA9IGNhbWVsaXplKGtleSk7CiAgICAgIHJlc1tuYW1lXSA9IGlzUGxhaW5PYmplY3QodmFsKSA/IHZhbCA6IHsKICAgICAgICB0eXBlOiB2YWwKICAgICAgfTsKICAgIH0KICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcInByb3BzXCI6IGV4cGVjdGVkIGFuIEFycmF5IG9yIGFuIE9iamVjdCwgIiArICJidXQgZ290ICIuY29uY2F0KHRvUmF3VHlwZShwcm9wcyksICIuIiksIHZtKTsKICB9CiAgb3B0aW9ucy5wcm9wcyA9IHJlczsKfQovKioKICogTm9ybWFsaXplIGFsbCBpbmplY3Rpb25zIGludG8gT2JqZWN0LWJhc2VkIGZvcm1hdAogKi8KZnVuY3Rpb24gbm9ybWFsaXplSW5qZWN0KG9wdGlvbnMsIHZtKSB7CiAgdmFyIGluamVjdCA9IG9wdGlvbnMuaW5qZWN0OwogIGlmICghaW5qZWN0KSByZXR1cm47CiAgdmFyIG5vcm1hbGl6ZWQgPSBvcHRpb25zLmluamVjdCA9IHt9OwogIGlmIChpc0FycmF5KGluamVjdCkpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5qZWN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIG5vcm1hbGl6ZWRbaW5qZWN0W2ldXSA9IHsKICAgICAgICBmcm9tOiBpbmplY3RbaV0KICAgICAgfTsKICAgIH0KICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QoaW5qZWN0KSkgewogICAgZm9yICh2YXIga2V5IGluIGluamVjdCkgewogICAgICB2YXIgdmFsID0gaW5qZWN0W2tleV07CiAgICAgIG5vcm1hbGl6ZWRba2V5XSA9IGlzUGxhaW5PYmplY3QodmFsKSA/IGV4dGVuZCh7CiAgICAgICAgZnJvbToga2V5CiAgICAgIH0sIHZhbCkgOiB7CiAgICAgICAgZnJvbTogdmFsCiAgICAgIH07CiAgICB9CiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCJpbmplY3RcIjogZXhwZWN0ZWQgYW4gQXJyYXkgb3IgYW4gT2JqZWN0LCAiICsgImJ1dCBnb3QgIi5jb25jYXQodG9SYXdUeXBlKGluamVjdCksICIuIiksIHZtKTsKICB9Cn0KLyoqCiAqIE5vcm1hbGl6ZSByYXcgZnVuY3Rpb24gZGlyZWN0aXZlcyBpbnRvIG9iamVjdCBmb3JtYXQuCiAqLwpmdW5jdGlvbiBub3JtYWxpemVEaXJlY3RpdmVzJDEob3B0aW9ucykgewogIHZhciBkaXJzID0gb3B0aW9ucy5kaXJlY3RpdmVzOwogIGlmIChkaXJzKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gZGlycykgewogICAgICB2YXIgZGVmID0gZGlyc1trZXldOwogICAgICBpZiAoaXNGdW5jdGlvbihkZWYpKSB7CiAgICAgICAgZGlyc1trZXldID0gewogICAgICAgICAgYmluZDogZGVmLAogICAgICAgICAgdXBkYXRlOiBkZWYKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGFzc2VydE9iamVjdFR5cGUobmFtZSwgdmFsdWUsIHZtKSB7CiAgaWYgKCFpc1BsYWluT2JqZWN0KHZhbHVlKSkgewogICAgd2FybigiSW52YWxpZCB2YWx1ZSBmb3Igb3B0aW9uIFwiIi5jb25jYXQobmFtZSwgIlwiOiBleHBlY3RlZCBhbiBPYmplY3QsICIpICsgImJ1dCBnb3QgIi5jb25jYXQodG9SYXdUeXBlKHZhbHVlKSwgIi4iKSwgdm0pOwogIH0KfQovKioKICogTWVyZ2UgdHdvIG9wdGlvbiBvYmplY3RzIGludG8gYSBuZXcgb25lLgogKiBDb3JlIHV0aWxpdHkgdXNlZCBpbiBib3RoIGluc3RhbnRpYXRpb24gYW5kIGluaGVyaXRhbmNlLgogKi8KZnVuY3Rpb24gbWVyZ2VPcHRpb25zKHBhcmVudCwgY2hpbGQsIHZtKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGNoZWNrQ29tcG9uZW50cyhjaGlsZCk7CiAgfQogIGlmIChpc0Z1bmN0aW9uKGNoaWxkKSkgewogICAgLy8gQHRzLWV4cGVjdC1lcnJvcgogICAgY2hpbGQgPSBjaGlsZC5vcHRpb25zOwogIH0KICBub3JtYWxpemVQcm9wcyhjaGlsZCwgdm0pOwogIG5vcm1hbGl6ZUluamVjdChjaGlsZCwgdm0pOwogIG5vcm1hbGl6ZURpcmVjdGl2ZXMkMShjaGlsZCk7CiAgLy8gQXBwbHkgZXh0ZW5kcyBhbmQgbWl4aW5zIG9uIHRoZSBjaGlsZCBvcHRpb25zLAogIC8vIGJ1dCBvbmx5IGlmIGl0IGlzIGEgcmF3IG9wdGlvbnMgb2JqZWN0IHRoYXQgaXNuJ3QKICAvLyB0aGUgcmVzdWx0IG9mIGFub3RoZXIgbWVyZ2VPcHRpb25zIGNhbGwuCiAgLy8gT25seSBtZXJnZWQgb3B0aW9ucyBoYXMgdGhlIF9iYXNlIHByb3BlcnR5LgogIGlmICghY2hpbGQuX2Jhc2UpIHsKICAgIGlmIChjaGlsZC5leHRlbmRzKSB7CiAgICAgIHBhcmVudCA9IG1lcmdlT3B0aW9ucyhwYXJlbnQsIGNoaWxkLmV4dGVuZHMsIHZtKTsKICAgIH0KICAgIGlmIChjaGlsZC5taXhpbnMpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGlsZC5taXhpbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgcGFyZW50ID0gbWVyZ2VPcHRpb25zKHBhcmVudCwgY2hpbGQubWl4aW5zW2ldLCB2bSk7CiAgICAgIH0KICAgIH0KICB9CiAgdmFyIG9wdGlvbnMgPSB7fTsKICB2YXIga2V5OwogIGZvciAoa2V5IGluIHBhcmVudCkgewogICAgbWVyZ2VGaWVsZChrZXkpOwogIH0KICBmb3IgKGtleSBpbiBjaGlsZCkgewogICAgaWYgKCFoYXNPd24ocGFyZW50LCBrZXkpKSB7CiAgICAgIG1lcmdlRmllbGQoa2V5KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gbWVyZ2VGaWVsZChrZXkpIHsKICAgIHZhciBzdHJhdCA9IHN0cmF0c1trZXldIHx8IGRlZmF1bHRTdHJhdDsKICAgIG9wdGlvbnNba2V5XSA9IHN0cmF0KHBhcmVudFtrZXldLCBjaGlsZFtrZXldLCB2bSwga2V5KTsKICB9CiAgcmV0dXJuIG9wdGlvbnM7Cn0KLyoqCiAqIFJlc29sdmUgYW4gYXNzZXQuCiAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBiZWNhdXNlIGNoaWxkIGluc3RhbmNlcyBuZWVkIGFjY2VzcwogKiB0byBhc3NldHMgZGVmaW5lZCBpbiBpdHMgYW5jZXN0b3IgY2hhaW4uCiAqLwpmdW5jdGlvbiByZXNvbHZlQXNzZXQob3B0aW9ucywgdHlwZSwgaWQsIHdhcm5NaXNzaW5nKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKHR5cGVvZiBpZCAhPT0gJ3N0cmluZycpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGFzc2V0cyA9IG9wdGlvbnNbdHlwZV07CiAgLy8gY2hlY2sgbG9jYWwgcmVnaXN0cmF0aW9uIHZhcmlhdGlvbnMgZmlyc3QKICBpZiAoaGFzT3duKGFzc2V0cywgaWQpKSByZXR1cm4gYXNzZXRzW2lkXTsKICB2YXIgY2FtZWxpemVkSWQgPSBjYW1lbGl6ZShpZCk7CiAgaWYgKGhhc093bihhc3NldHMsIGNhbWVsaXplZElkKSkgcmV0dXJuIGFzc2V0c1tjYW1lbGl6ZWRJZF07CiAgdmFyIFBhc2NhbENhc2VJZCA9IGNhcGl0YWxpemUoY2FtZWxpemVkSWQpOwogIGlmIChoYXNPd24oYXNzZXRzLCBQYXNjYWxDYXNlSWQpKSByZXR1cm4gYXNzZXRzW1Bhc2NhbENhc2VJZF07CiAgLy8gZmFsbGJhY2sgdG8gcHJvdG90eXBlIGNoYWluCiAgdmFyIHJlcyA9IGFzc2V0c1tpZF0gfHwgYXNzZXRzW2NhbWVsaXplZElkXSB8fCBhc3NldHNbUGFzY2FsQ2FzZUlkXTsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuTWlzc2luZyAmJiAhcmVzKSB7CiAgICB3YXJuKCdGYWlsZWQgdG8gcmVzb2x2ZSAnICsgdHlwZS5zbGljZSgwLCAtMSkgKyAnOiAnICsgaWQpOwogIH0KICByZXR1cm4gcmVzOwp9CmZ1bmN0aW9uIHZhbGlkYXRlUHJvcChrZXksIHByb3BPcHRpb25zLCBwcm9wc0RhdGEsIHZtKSB7CiAgdmFyIHByb3AgPSBwcm9wT3B0aW9uc1trZXldOwogIHZhciBhYnNlbnQgPSAhaGFzT3duKHByb3BzRGF0YSwga2V5KTsKICB2YXIgdmFsdWUgPSBwcm9wc0RhdGFba2V5XTsKICAvLyBib29sZWFuIGNhc3RpbmcKICB2YXIgYm9vbGVhbkluZGV4ID0gZ2V0VHlwZUluZGV4KEJvb2xlYW4sIHByb3AudHlwZSk7CiAgaWYgKGJvb2xlYW5JbmRleCA+IC0xKSB7CiAgICBpZiAoYWJzZW50ICYmICFoYXNPd24ocHJvcCwgJ2RlZmF1bHQnKSkgewogICAgICB2YWx1ZSA9IGZhbHNlOwogICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IGh5cGhlbmF0ZShrZXkpKSB7CiAgICAgIC8vIG9ubHkgY2FzdCBlbXB0eSBzdHJpbmcgLyBzYW1lIG5hbWUgdG8gYm9vbGVhbiBpZgogICAgICAvLyBib29sZWFuIGhhcyBoaWdoZXIgcHJpb3JpdHkKICAgICAgdmFyIHN0cmluZ0luZGV4ID0gZ2V0VHlwZUluZGV4KFN0cmluZywgcHJvcC50eXBlKTsKICAgICAgaWYgKHN0cmluZ0luZGV4IDwgMCB8fCBib29sZWFuSW5kZXggPCBzdHJpbmdJbmRleCkgewogICAgICAgIHZhbHVlID0gdHJ1ZTsKICAgICAgfQogICAgfQogIH0KICAvLyBjaGVjayBkZWZhdWx0IHZhbHVlCiAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgIHZhbHVlID0gZ2V0UHJvcERlZmF1bHRWYWx1ZSh2bSwgcHJvcCwga2V5KTsKICAgIC8vIHNpbmNlIHRoZSBkZWZhdWx0IHZhbHVlIGlzIGEgZnJlc2ggY29weSwKICAgIC8vIG1ha2Ugc3VyZSB0byBvYnNlcnZlIGl0LgogICAgdmFyIHByZXZTaG91bGRPYnNlcnZlID0gc2hvdWxkT2JzZXJ2ZTsKICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKICAgIG9ic2VydmUodmFsdWUpOwogICAgdG9nZ2xlT2JzZXJ2aW5nKHByZXZTaG91bGRPYnNlcnZlKTsKICB9CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGFzc2VydFByb3AocHJvcCwga2V5LCB2YWx1ZSwgdm0sIGFic2VudCk7CiAgfQogIHJldHVybiB2YWx1ZTsKfQovKioKICogR2V0IHRoZSBkZWZhdWx0IHZhbHVlIG9mIGEgcHJvcC4KICovCmZ1bmN0aW9uIGdldFByb3BEZWZhdWx0VmFsdWUodm0sIHByb3AsIGtleSkgewogIC8vIG5vIGRlZmF1bHQsIHJldHVybiB1bmRlZmluZWQKICBpZiAoIWhhc093bihwcm9wLCAnZGVmYXVsdCcpKSB7CiAgICByZXR1cm4gdW5kZWZpbmVkOwogIH0KICB2YXIgZGVmID0gcHJvcC5kZWZhdWx0OwogIC8vIHdhcm4gYWdhaW5zdCBub24tZmFjdG9yeSBkZWZhdWx0cyBmb3IgT2JqZWN0ICYgQXJyYXkKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBpc09iamVjdChkZWYpKSB7CiAgICB3YXJuKCdJbnZhbGlkIGRlZmF1bHQgdmFsdWUgZm9yIHByb3AgIicgKyBrZXkgKyAnIjogJyArICdQcm9wcyB3aXRoIHR5cGUgT2JqZWN0L0FycmF5IG11c3QgdXNlIGEgZmFjdG9yeSBmdW5jdGlvbiAnICsgJ3RvIHJldHVybiB0aGUgZGVmYXVsdCB2YWx1ZS4nLCB2bSk7CiAgfQogIC8vIHRoZSByYXcgcHJvcCB2YWx1ZSB3YXMgYWxzbyB1bmRlZmluZWQgZnJvbSBwcmV2aW91cyByZW5kZXIsCiAgLy8gcmV0dXJuIHByZXZpb3VzIGRlZmF1bHQgdmFsdWUgdG8gYXZvaWQgdW5uZWNlc3Nhcnkgd2F0Y2hlciB0cmlnZ2VyCiAgaWYgKHZtICYmIHZtLiRvcHRpb25zLnByb3BzRGF0YSAmJiB2bS4kb3B0aW9ucy5wcm9wc0RhdGFba2V5XSA9PT0gdW5kZWZpbmVkICYmIHZtLl9wcm9wc1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgIHJldHVybiB2bS5fcHJvcHNba2V5XTsKICB9CiAgLy8gY2FsbCBmYWN0b3J5IGZ1bmN0aW9uIGZvciBub24tRnVuY3Rpb24gdHlwZXMKICAvLyBhIHZhbHVlIGlzIEZ1bmN0aW9uIGlmIGl0cyBwcm90b3R5cGUgaXMgZnVuY3Rpb24gZXZlbiBhY3Jvc3MgZGlmZmVyZW50IGV4ZWN1dGlvbiBjb250ZXh0CiAgcmV0dXJuIGlzRnVuY3Rpb24oZGVmKSAmJiBnZXRUeXBlKHByb3AudHlwZSkgIT09ICdGdW5jdGlvbicgPyBkZWYuY2FsbCh2bSkgOiBkZWY7Cn0KLyoqCiAqIEFzc2VydCB3aGV0aGVyIGEgcHJvcCBpcyB2YWxpZC4KICovCmZ1bmN0aW9uIGFzc2VydFByb3AocHJvcCwgbmFtZSwgdmFsdWUsIHZtLCBhYnNlbnQpIHsKICBpZiAocHJvcC5yZXF1aXJlZCAmJiBhYnNlbnQpIHsKICAgIHdhcm4oJ01pc3NpbmcgcmVxdWlyZWQgcHJvcDogIicgKyBuYW1lICsgJyInLCB2bSk7CiAgICByZXR1cm47CiAgfQogIGlmICh2YWx1ZSA9PSBudWxsICYmICFwcm9wLnJlcXVpcmVkKSB7CiAgICByZXR1cm47CiAgfQogIHZhciB0eXBlID0gcHJvcC50eXBlOwogIHZhciB2YWxpZCA9ICF0eXBlIHx8IHR5cGUgPT09IHRydWU7CiAgdmFyIGV4cGVjdGVkVHlwZXMgPSBbXTsKICBpZiAodHlwZSkgewogICAgaWYgKCFpc0FycmF5KHR5cGUpKSB7CiAgICAgIHR5cGUgPSBbdHlwZV07CiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHR5cGUubGVuZ3RoICYmICF2YWxpZDsgaSsrKSB7CiAgICAgIHZhciBhc3NlcnRlZFR5cGUgPSBhc3NlcnRUeXBlKHZhbHVlLCB0eXBlW2ldLCB2bSk7CiAgICAgIGV4cGVjdGVkVHlwZXMucHVzaChhc3NlcnRlZFR5cGUuZXhwZWN0ZWRUeXBlIHx8ICcnKTsKICAgICAgdmFsaWQgPSBhc3NlcnRlZFR5cGUudmFsaWQ7CiAgICB9CiAgfQogIHZhciBoYXZlRXhwZWN0ZWRUeXBlcyA9IGV4cGVjdGVkVHlwZXMuc29tZShmdW5jdGlvbiAodCkgewogICAgcmV0dXJuIHQ7CiAgfSk7CiAgaWYgKCF2YWxpZCAmJiBoYXZlRXhwZWN0ZWRUeXBlcykgewogICAgd2FybihnZXRJbnZhbGlkVHlwZU1lc3NhZ2UobmFtZSwgdmFsdWUsIGV4cGVjdGVkVHlwZXMpLCB2bSk7CiAgICByZXR1cm47CiAgfQogIHZhciB2YWxpZGF0b3IgPSBwcm9wLnZhbGlkYXRvcjsKICBpZiAodmFsaWRhdG9yKSB7CiAgICBpZiAoIXZhbGlkYXRvcih2YWx1ZSkpIHsKICAgICAgd2FybignSW52YWxpZCBwcm9wOiBjdXN0b20gdmFsaWRhdG9yIGNoZWNrIGZhaWxlZCBmb3IgcHJvcCAiJyArIG5hbWUgKyAnIi4nLCB2bSk7CiAgICB9CiAgfQp9CnZhciBzaW1wbGVDaGVja1JFID0gL14oU3RyaW5nfE51bWJlcnxCb29sZWFufEZ1bmN0aW9ufFN5bWJvbHxCaWdJbnQpJC87CmZ1bmN0aW9uIGFzc2VydFR5cGUodmFsdWUsIHR5cGUsIHZtKSB7CiAgdmFyIHZhbGlkOwogIHZhciBleHBlY3RlZFR5cGUgPSBnZXRUeXBlKHR5cGUpOwogIGlmIChzaW1wbGVDaGVja1JFLnRlc3QoZXhwZWN0ZWRUeXBlKSkgewogICAgdmFyIHQgPSB0eXBlb2YgdmFsdWU7CiAgICB2YWxpZCA9IHQgPT09IGV4cGVjdGVkVHlwZS50b0xvd2VyQ2FzZSgpOwogICAgLy8gZm9yIHByaW1pdGl2ZSB3cmFwcGVyIG9iamVjdHMKICAgIGlmICghdmFsaWQgJiYgdCA9PT0gJ29iamVjdCcpIHsKICAgICAgdmFsaWQgPSB2YWx1ZSBpbnN0YW5jZW9mIHR5cGU7CiAgICB9CiAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICdPYmplY3QnKSB7CiAgICB2YWxpZCA9IGlzUGxhaW5PYmplY3QodmFsdWUpOwogIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAnQXJyYXknKSB7CiAgICB2YWxpZCA9IGlzQXJyYXkodmFsdWUpOwogIH0gZWxzZSB7CiAgICB0cnkgewogICAgICB2YWxpZCA9IHZhbHVlIGluc3RhbmNlb2YgdHlwZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgd2FybignSW52YWxpZCBwcm9wIHR5cGU6ICInICsgU3RyaW5nKHR5cGUpICsgJyIgaXMgbm90IGEgY29uc3RydWN0b3InLCB2bSk7CiAgICAgIHZhbGlkID0gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB7CiAgICB2YWxpZDogdmFsaWQsCiAgICBleHBlY3RlZFR5cGU6IGV4cGVjdGVkVHlwZQogIH07Cn0KdmFyIGZ1bmN0aW9uVHlwZUNoZWNrUkUgPSAvXlxzKmZ1bmN0aW9uIChcdyspLzsKLyoqCiAqIFVzZSBmdW5jdGlvbiBzdHJpbmcgbmFtZSB0byBjaGVjayBidWlsdC1pbiB0eXBlcywKICogYmVjYXVzZSBhIHNpbXBsZSBlcXVhbGl0eSBjaGVjayB3aWxsIGZhaWwgd2hlbiBydW5uaW5nCiAqIGFjcm9zcyBkaWZmZXJlbnQgdm1zIC8gaWZyYW1lcy4KICovCmZ1bmN0aW9uIGdldFR5cGUoZm4pIHsKICB2YXIgbWF0Y2ggPSBmbiAmJiBmbi50b1N0cmluZygpLm1hdGNoKGZ1bmN0aW9uVHlwZUNoZWNrUkUpOwogIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7Cn0KZnVuY3Rpb24gaXNTYW1lVHlwZShhLCBiKSB7CiAgcmV0dXJuIGdldFR5cGUoYSkgPT09IGdldFR5cGUoYik7Cn0KZnVuY3Rpb24gZ2V0VHlwZUluZGV4KHR5cGUsIGV4cGVjdGVkVHlwZXMpIHsKICBpZiAoIWlzQXJyYXkoZXhwZWN0ZWRUeXBlcykpIHsKICAgIHJldHVybiBpc1NhbWVUeXBlKGV4cGVjdGVkVHlwZXMsIHR5cGUpID8gMCA6IC0xOwogIH0KICBmb3IgKHZhciBpID0gMCwgbGVuID0gZXhwZWN0ZWRUeXBlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgaWYgKGlzU2FtZVR5cGUoZXhwZWN0ZWRUeXBlc1tpXSwgdHlwZSkpIHsKICAgICAgcmV0dXJuIGk7CiAgICB9CiAgfQogIHJldHVybiAtMTsKfQpmdW5jdGlvbiBnZXRJbnZhbGlkVHlwZU1lc3NhZ2UobmFtZSwgdmFsdWUsIGV4cGVjdGVkVHlwZXMpIHsKICB2YXIgbWVzc2FnZSA9ICJJbnZhbGlkIHByb3A6IHR5cGUgY2hlY2sgZmFpbGVkIGZvciBwcm9wIFwiIi5jb25jYXQobmFtZSwgIlwiLiIpICsgIiBFeHBlY3RlZCAiLmNvbmNhdChleHBlY3RlZFR5cGVzLm1hcChjYXBpdGFsaXplKS5qb2luKCcsICcpKTsKICB2YXIgZXhwZWN0ZWRUeXBlID0gZXhwZWN0ZWRUeXBlc1swXTsKICB2YXIgcmVjZWl2ZWRUeXBlID0gdG9SYXdUeXBlKHZhbHVlKTsKICAvLyBjaGVjayBpZiB3ZSBuZWVkIHRvIHNwZWNpZnkgZXhwZWN0ZWQgdmFsdWUKICBpZiAoZXhwZWN0ZWRUeXBlcy5sZW5ndGggPT09IDEgJiYgaXNFeHBsaWNhYmxlKGV4cGVjdGVkVHlwZSkgJiYgaXNFeHBsaWNhYmxlKHR5cGVvZiB2YWx1ZSkgJiYgIWlzQm9vbGVhbihleHBlY3RlZFR5cGUsIHJlY2VpdmVkVHlwZSkpIHsKICAgIG1lc3NhZ2UgKz0gIiB3aXRoIHZhbHVlICIuY29uY2F0KHN0eWxlVmFsdWUodmFsdWUsIGV4cGVjdGVkVHlwZSkpOwogIH0KICBtZXNzYWdlICs9ICIsIGdvdCAiLmNvbmNhdChyZWNlaXZlZFR5cGUsICIgIik7CiAgLy8gY2hlY2sgaWYgd2UgbmVlZCB0byBzcGVjaWZ5IHJlY2VpdmVkIHZhbHVlCiAgaWYgKGlzRXhwbGljYWJsZShyZWNlaXZlZFR5cGUpKSB7CiAgICBtZXNzYWdlICs9ICJ3aXRoIHZhbHVlICIuY29uY2F0KHN0eWxlVmFsdWUodmFsdWUsIHJlY2VpdmVkVHlwZSksICIuIik7CiAgfQogIHJldHVybiBtZXNzYWdlOwp9CmZ1bmN0aW9uIHN0eWxlVmFsdWUodmFsdWUsIHR5cGUpIHsKICBpZiAodHlwZSA9PT0gJ1N0cmluZycpIHsKICAgIHJldHVybiAiXCIiLmNvbmNhdCh2YWx1ZSwgIlwiIik7CiAgfSBlbHNlIGlmICh0eXBlID09PSAnTnVtYmVyJykgewogICAgcmV0dXJuICIiLmNvbmNhdChOdW1iZXIodmFsdWUpKTsKICB9IGVsc2UgewogICAgcmV0dXJuICIiLmNvbmNhdCh2YWx1ZSk7CiAgfQp9CnZhciBFWFBMSUNBQkxFX1RZUEVTID0gWydzdHJpbmcnLCAnbnVtYmVyJywgJ2Jvb2xlYW4nXTsKZnVuY3Rpb24gaXNFeHBsaWNhYmxlKHZhbHVlKSB7CiAgcmV0dXJuIEVYUExJQ0FCTEVfVFlQRVMuc29tZShmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIHZhbHVlLnRvTG93ZXJDYXNlKCkgPT09IGVsZW07CiAgfSk7Cn0KZnVuY3Rpb24gaXNCb29sZWFuKCkgewogIHZhciBhcmdzID0gW107CiAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHsKICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pXTsKICB9CiAgcmV0dXJuIGFyZ3Muc29tZShmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIGVsZW0udG9Mb3dlckNhc2UoKSA9PT0gJ2Jvb2xlYW4nOwogIH0pOwp9CgovKiBub3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgcGxheSB3ZWxsIHdpdGggUHJveHkgKi8KdmFyIGluaXRQcm94eTsKaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICB2YXIgYWxsb3dlZEdsb2JhbHNfMSA9IG1ha2VNYXAoJ0luZmluaXR5LHVuZGVmaW5lZCxOYU4saXNGaW5pdGUsaXNOYU4sJyArICdwYXJzZUZsb2F0LHBhcnNlSW50LGRlY29kZVVSSSxkZWNvZGVVUklDb21wb25lbnQsZW5jb2RlVVJJLGVuY29kZVVSSUNvbXBvbmVudCwnICsgJ01hdGgsTnVtYmVyLERhdGUsQXJyYXksT2JqZWN0LEJvb2xlYW4sU3RyaW5nLFJlZ0V4cCxNYXAsU2V0LEpTT04sSW50bCxCaWdJbnQsJyArICdyZXF1aXJlJyAvLyBmb3IgV2VicGFjay9Ccm93c2VyaWZ5CiAgKTsKCiAgdmFyIHdhcm5Ob25QcmVzZW50XzEgPSBmdW5jdGlvbiB3YXJuTm9uUHJlc2VudF8xKHRhcmdldCwga2V5KSB7CiAgICB3YXJuKCJQcm9wZXJ0eSBvciBtZXRob2QgXCIiLmNvbmNhdChrZXksICJcIiBpcyBub3QgZGVmaW5lZCBvbiB0aGUgaW5zdGFuY2UgYnV0ICIpICsgJ3JlZmVyZW5jZWQgZHVyaW5nIHJlbmRlci4gTWFrZSBzdXJlIHRoYXQgdGhpcyBwcm9wZXJ0eSBpcyByZWFjdGl2ZSwgJyArICdlaXRoZXIgaW4gdGhlIGRhdGEgb3B0aW9uLCBvciBmb3IgY2xhc3MtYmFzZWQgY29tcG9uZW50cywgYnkgJyArICdpbml0aWFsaXppbmcgdGhlIHByb3BlcnR5LiAnICsgJ1NlZTogaHR0cHM6Ly92Mi52dWVqcy5vcmcvdjIvZ3VpZGUvcmVhY3Rpdml0eS5odG1sI0RlY2xhcmluZy1SZWFjdGl2ZS1Qcm9wZXJ0aWVzLicsIHRhcmdldCk7CiAgfTsKICB2YXIgd2FyblJlc2VydmVkUHJlZml4XzEgPSBmdW5jdGlvbiB3YXJuUmVzZXJ2ZWRQcmVmaXhfMSh0YXJnZXQsIGtleSkgewogICAgd2FybigiUHJvcGVydHkgXCIiLmNvbmNhdChrZXksICJcIiBtdXN0IGJlIGFjY2Vzc2VkIHdpdGggXCIkZGF0YS4iKS5jb25jYXQoa2V5LCAiXCIgYmVjYXVzZSAiKSArICdwcm9wZXJ0aWVzIHN0YXJ0aW5nIHdpdGggIiQiIG9yICJfIiBhcmUgbm90IHByb3hpZWQgaW4gdGhlIFZ1ZSBpbnN0YW5jZSB0byAnICsgJ3ByZXZlbnQgY29uZmxpY3RzIHdpdGggVnVlIGludGVybmFscy4gJyArICdTZWU6IGh0dHBzOi8vdjIudnVlanMub3JnL3YyL2FwaS8jZGF0YScsIHRhcmdldCk7CiAgfTsKICB2YXIgaGFzUHJveHlfMSA9IHR5cGVvZiBQcm94eSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoUHJveHkpOwogIGlmIChoYXNQcm94eV8xKSB7CiAgICB2YXIgaXNCdWlsdEluTW9kaWZpZXJfMSA9IG1ha2VNYXAoJ3N0b3AscHJldmVudCxzZWxmLGN0cmwsc2hpZnQsYWx0LG1ldGEsZXhhY3QnKTsKICAgIGNvbmZpZy5rZXlDb2RlcyA9IG5ldyBQcm94eShjb25maWcua2V5Q29kZXMsIHsKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodGFyZ2V0LCBrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGlzQnVpbHRJbk1vZGlmaWVyXzEoa2V5KSkgewogICAgICAgICAgd2FybigiQXZvaWQgb3ZlcndyaXRpbmcgYnVpbHQtaW4gbW9kaWZpZXIgaW4gY29uZmlnLmtleUNvZGVzOiAuIi5jb25jYXQoa2V5KSk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRhcmdldFtrZXldID0gdmFsdWU7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICB2YXIgaGFzSGFuZGxlcl8xID0gewogICAgaGFzOiBmdW5jdGlvbiBoYXModGFyZ2V0LCBrZXkpIHsKICAgICAgdmFyIGhhcyA9IChrZXkgaW4gdGFyZ2V0KTsKICAgICAgdmFyIGlzQWxsb3dlZCA9IGFsbG93ZWRHbG9iYWxzXzEoa2V5KSB8fCB0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiBrZXkuY2hhckF0KDApID09PSAnXycgJiYgIShrZXkgaW4gdGFyZ2V0LiRkYXRhKTsKICAgICAgaWYgKCFoYXMgJiYgIWlzQWxsb3dlZCkgewogICAgICAgIGlmIChrZXkgaW4gdGFyZ2V0LiRkYXRhKSB3YXJuUmVzZXJ2ZWRQcmVmaXhfMSh0YXJnZXQsIGtleSk7ZWxzZSB3YXJuTm9uUHJlc2VudF8xKHRhcmdldCwga2V5KTsKICAgICAgfQogICAgICByZXR1cm4gaGFzIHx8ICFpc0FsbG93ZWQ7CiAgICB9CiAgfTsKICB2YXIgZ2V0SGFuZGxlcl8xID0gewogICAgZ2V0OiBmdW5jdGlvbiBnZXQodGFyZ2V0LCBrZXkpIHsKICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmICEoa2V5IGluIHRhcmdldCkpIHsKICAgICAgICBpZiAoa2V5IGluIHRhcmdldC4kZGF0YSkgd2FyblJlc2VydmVkUHJlZml4XzEodGFyZ2V0LCBrZXkpO2Vsc2Ugd2Fybk5vblByZXNlbnRfMSh0YXJnZXQsIGtleSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRhcmdldFtrZXldOwogICAgfQogIH07CiAgaW5pdFByb3h5ID0gZnVuY3Rpb24gaW5pdFByb3h5KHZtKSB7CiAgICBpZiAoaGFzUHJveHlfMSkgewogICAgICAvLyBkZXRlcm1pbmUgd2hpY2ggcHJveHkgaGFuZGxlciB0byB1c2UKICAgICAgdmFyIG9wdGlvbnMgPSB2bS4kb3B0aW9uczsKICAgICAgdmFyIGhhbmRsZXJzID0gb3B0aW9ucy5yZW5kZXIgJiYgb3B0aW9ucy5yZW5kZXIuX3dpdGhTdHJpcHBlZCA/IGdldEhhbmRsZXJfMSA6IGhhc0hhbmRsZXJfMTsKICAgICAgdm0uX3JlbmRlclByb3h5ID0gbmV3IFByb3h5KHZtLCBoYW5kbGVycyk7CiAgICB9IGVsc2UgewogICAgICB2bS5fcmVuZGVyUHJveHkgPSB2bTsKICAgIH0KICB9Owp9CnZhciBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24gPSB7CiAgZW51bWVyYWJsZTogdHJ1ZSwKICBjb25maWd1cmFibGU6IHRydWUsCiAgZ2V0OiBub29wLAogIHNldDogbm9vcAp9OwpmdW5jdGlvbiBwcm94eSh0YXJnZXQsIHNvdXJjZUtleSwga2V5KSB7CiAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLmdldCA9IGZ1bmN0aW9uIHByb3h5R2V0dGVyKCkgewogICAgcmV0dXJuIHRoaXNbc291cmNlS2V5XVtrZXldOwogIH07CiAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IGZ1bmN0aW9uIHByb3h5U2V0dGVyKHZhbCkgewogICAgdGhpc1tzb3VyY2VLZXldW2tleV0gPSB2YWw7CiAgfTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbik7Cn0KZnVuY3Rpb24gaW5pdFN0YXRlKHZtKSB7CiAgdmFyIG9wdHMgPSB2bS4kb3B0aW9uczsKICBpZiAob3B0cy5wcm9wcykgaW5pdFByb3BzJDEodm0sIG9wdHMucHJvcHMpOwogIC8vIENvbXBvc2l0aW9uIEFQSQogIGluaXRTZXR1cCh2bSk7CiAgaWYgKG9wdHMubWV0aG9kcykgaW5pdE1ldGhvZHModm0sIG9wdHMubWV0aG9kcyk7CiAgaWYgKG9wdHMuZGF0YSkgewogICAgaW5pdERhdGEodm0pOwogIH0gZWxzZSB7CiAgICB2YXIgb2IgPSBvYnNlcnZlKHZtLl9kYXRhID0ge30pOwogICAgb2IgJiYgb2Iudm1Db3VudCsrOwogIH0KICBpZiAob3B0cy5jb21wdXRlZCkgaW5pdENvbXB1dGVkJDEodm0sIG9wdHMuY29tcHV0ZWQpOwogIGlmIChvcHRzLndhdGNoICYmIG9wdHMud2F0Y2ggIT09IG5hdGl2ZVdhdGNoKSB7CiAgICBpbml0V2F0Y2godm0sIG9wdHMud2F0Y2gpOwogIH0KfQpmdW5jdGlvbiBpbml0UHJvcHMkMSh2bSwgcHJvcHNPcHRpb25zKSB7CiAgdmFyIHByb3BzRGF0YSA9IHZtLiRvcHRpb25zLnByb3BzRGF0YSB8fCB7fTsKICB2YXIgcHJvcHMgPSB2bS5fcHJvcHMgPSBzaGFsbG93UmVhY3RpdmUoe30pOwogIC8vIGNhY2hlIHByb3Aga2V5cyBzbyB0aGF0IGZ1dHVyZSBwcm9wcyB1cGRhdGVzIGNhbiBpdGVyYXRlIHVzaW5nIEFycmF5CiAgLy8gaW5zdGVhZCBvZiBkeW5hbWljIG9iamVjdCBrZXkgZW51bWVyYXRpb24uCiAgdmFyIGtleXMgPSB2bS4kb3B0aW9ucy5fcHJvcEtleXMgPSBbXTsKICB2YXIgaXNSb290ID0gIXZtLiRwYXJlbnQ7CiAgLy8gcm9vdCBpbnN0YW5jZSBwcm9wcyBzaG91bGQgYmUgY29udmVydGVkCiAgaWYgKCFpc1Jvb3QpIHsKICAgIHRvZ2dsZU9ic2VydmluZyhmYWxzZSk7CiAgfQogIHZhciBfbG9vcF8xID0gZnVuY3Rpb24gX2xvb3BfMShrZXkpIHsKICAgIGtleXMucHVzaChrZXkpOwogICAgdmFyIHZhbHVlID0gdmFsaWRhdGVQcm9wKGtleSwgcHJvcHNPcHRpb25zLCBwcm9wc0RhdGEsIHZtKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB2YXIgaHlwaGVuYXRlZEtleSA9IGh5cGhlbmF0ZShrZXkpOwogICAgICBpZiAoaXNSZXNlcnZlZEF0dHJpYnV0ZShoeXBoZW5hdGVkS2V5KSB8fCBjb25maWcuaXNSZXNlcnZlZEF0dHIoaHlwaGVuYXRlZEtleSkpIHsKICAgICAgICB3YXJuKCJcIiIuY29uY2F0KGh5cGhlbmF0ZWRLZXksICJcIiBpcyBhIHJlc2VydmVkIGF0dHJpYnV0ZSBhbmQgY2Fubm90IGJlIHVzZWQgYXMgY29tcG9uZW50IHByb3AuIiksIHZtKTsKICAgICAgfQogICAgICBkZWZpbmVSZWFjdGl2ZShwcm9wcywga2V5LCB2YWx1ZSwgZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghaXNSb290ICYmICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQpIHsKICAgICAgICAgIHdhcm4oIkF2b2lkIG11dGF0aW5nIGEgcHJvcCBkaXJlY3RseSBzaW5jZSB0aGUgdmFsdWUgd2lsbCBiZSAiICsgIm92ZXJ3cml0dGVuIHdoZW5ldmVyIHRoZSBwYXJlbnQgY29tcG9uZW50IHJlLXJlbmRlcnMuICIgKyAiSW5zdGVhZCwgdXNlIGEgZGF0YSBvciBjb21wdXRlZCBwcm9wZXJ0eSBiYXNlZCBvbiB0aGUgcHJvcCdzICIgKyAidmFsdWUuIFByb3AgYmVpbmcgbXV0YXRlZDogXCIiLmNvbmNhdChrZXksICJcIiIpLCB2bSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGRlZmluZVJlYWN0aXZlKHByb3BzLCBrZXksIHZhbHVlKTsKICAgIH0KICAgIC8vIHN0YXRpYyBwcm9wcyBhcmUgYWxyZWFkeSBwcm94aWVkIG9uIHRoZSBjb21wb25lbnQncyBwcm90b3R5cGUKICAgIC8vIGR1cmluZyBWdWUuZXh0ZW5kKCkuIFdlIG9ubHkgbmVlZCB0byBwcm94eSBwcm9wcyBkZWZpbmVkIGF0CiAgICAvLyBpbnN0YW50aWF0aW9uIGhlcmUuCiAgICBpZiAoIShrZXkgaW4gdm0pKSB7CiAgICAgIHByb3h5KHZtLCAiX3Byb3BzIiwga2V5KTsKICAgIH0KICB9OwogIGZvciAodmFyIGtleSBpbiBwcm9wc09wdGlvbnMpIHsKICAgIF9sb29wXzEoa2V5KTsKICB9CiAgdG9nZ2xlT2JzZXJ2aW5nKHRydWUpOwp9CmZ1bmN0aW9uIGluaXREYXRhKHZtKSB7CiAgdmFyIGRhdGEgPSB2bS4kb3B0aW9ucy5kYXRhOwogIGRhdGEgPSB2bS5fZGF0YSA9IGlzRnVuY3Rpb24oZGF0YSkgPyBnZXREYXRhKGRhdGEsIHZtKSA6IGRhdGEgfHwge307CiAgaWYgKCFpc1BsYWluT2JqZWN0KGRhdGEpKSB7CiAgICBkYXRhID0ge307CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ2RhdGEgZnVuY3Rpb25zIHNob3VsZCByZXR1cm4gYW4gb2JqZWN0OlxuJyArICdodHRwczovL3YyLnZ1ZWpzLm9yZy92Mi9ndWlkZS9jb21wb25lbnRzLmh0bWwjZGF0YS1NdXN0LUJlLWEtRnVuY3Rpb24nLCB2bSk7CiAgfQogIC8vIHByb3h5IGRhdGEgb24gaW5zdGFuY2UKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRhdGEpOwogIHZhciBwcm9wcyA9IHZtLiRvcHRpb25zLnByb3BzOwogIHZhciBtZXRob2RzID0gdm0uJG9wdGlvbnMubWV0aG9kczsKICB2YXIgaSA9IGtleXMubGVuZ3RoOwogIHdoaWxlIChpLS0pIHsKICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKG1ldGhvZHMgJiYgaGFzT3duKG1ldGhvZHMsIGtleSkpIHsKICAgICAgICB3YXJuKCJNZXRob2QgXCIiLmNvbmNhdChrZXksICJcIiBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQgYXMgYSBkYXRhIHByb3BlcnR5LiIpLCB2bSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChwcm9wcyAmJiBoYXNPd24ocHJvcHMsIGtleSkpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJUaGUgZGF0YSBwcm9wZXJ0eSBcIiIuY29uY2F0KGtleSwgIlwiIGlzIGFscmVhZHkgZGVjbGFyZWQgYXMgYSBwcm9wLiAiKSArICJVc2UgcHJvcCBkZWZhdWx0IHZhbHVlIGluc3RlYWQuIiwgdm0pOwogICAgfSBlbHNlIGlmICghaXNSZXNlcnZlZChrZXkpKSB7CiAgICAgIHByb3h5KHZtLCAiX2RhdGEiLCBrZXkpOwogICAgfQogIH0KICAvLyBvYnNlcnZlIGRhdGEKICB2YXIgb2IgPSBvYnNlcnZlKGRhdGEpOwogIG9iICYmIG9iLnZtQ291bnQrKzsKfQpmdW5jdGlvbiBnZXREYXRhKGRhdGEsIHZtKSB7CiAgLy8gIzc1NzMgZGlzYWJsZSBkZXAgY29sbGVjdGlvbiB3aGVuIGludm9raW5nIGRhdGEgZ2V0dGVycwogIHB1c2hUYXJnZXQoKTsKICB0cnkgewogICAgcmV0dXJuIGRhdGEuY2FsbCh2bSwgdm0pOwogIH0gY2F0Y2ggKGUpIHsKICAgIGhhbmRsZUVycm9yKGUsIHZtLCAiZGF0YSgpIik7CiAgICByZXR1cm4ge307CiAgfSBmaW5hbGx5IHsKICAgIHBvcFRhcmdldCgpOwogIH0KfQp2YXIgY29tcHV0ZWRXYXRjaGVyT3B0aW9ucyA9IHsKICBsYXp5OiB0cnVlCn07CmZ1bmN0aW9uIGluaXRDb21wdXRlZCQxKHZtLCBjb21wdXRlZCkgewogIC8vICRmbG93LWRpc2FibGUtbGluZQogIHZhciB3YXRjaGVycyA9IHZtLl9jb21wdXRlZFdhdGNoZXJzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAvLyBjb21wdXRlZCBwcm9wZXJ0aWVzIGFyZSBqdXN0IGdldHRlcnMgZHVyaW5nIFNTUgogIHZhciBpc1NTUiA9IGlzU2VydmVyUmVuZGVyaW5nKCk7CiAgZm9yICh2YXIga2V5IGluIGNvbXB1dGVkKSB7CiAgICB2YXIgdXNlckRlZiA9IGNvbXB1dGVkW2tleV07CiAgICB2YXIgZ2V0dGVyID0gaXNGdW5jdGlvbih1c2VyRGVmKSA/IHVzZXJEZWYgOiB1c2VyRGVmLmdldDsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGdldHRlciA9PSBudWxsKSB7CiAgICAgIHdhcm4oIkdldHRlciBpcyBtaXNzaW5nIGZvciBjb21wdXRlZCBwcm9wZXJ0eSBcIiIuY29uY2F0KGtleSwgIlwiLiIpLCB2bSk7CiAgICB9CiAgICBpZiAoIWlzU1NSKSB7CiAgICAgIC8vIGNyZWF0ZSBpbnRlcm5hbCB3YXRjaGVyIGZvciB0aGUgY29tcHV0ZWQgcHJvcGVydHkuCiAgICAgIHdhdGNoZXJzW2tleV0gPSBuZXcgV2F0Y2hlcih2bSwgZ2V0dGVyIHx8IG5vb3AsIG5vb3AsIGNvbXB1dGVkV2F0Y2hlck9wdGlvbnMpOwogICAgfQogICAgLy8gY29tcG9uZW50LWRlZmluZWQgY29tcHV0ZWQgcHJvcGVydGllcyBhcmUgYWxyZWFkeSBkZWZpbmVkIG9uIHRoZQogICAgLy8gY29tcG9uZW50IHByb3RvdHlwZS4gV2Ugb25seSBuZWVkIHRvIGRlZmluZSBjb21wdXRlZCBwcm9wZXJ0aWVzIGRlZmluZWQKICAgIC8vIGF0IGluc3RhbnRpYXRpb24gaGVyZS4KICAgIGlmICghKGtleSBpbiB2bSkpIHsKICAgICAgZGVmaW5lQ29tcHV0ZWQodm0sIGtleSwgdXNlckRlZik7CiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKGtleSBpbiB2bS4kZGF0YSkgewogICAgICAgIHdhcm4oIlRoZSBjb21wdXRlZCBwcm9wZXJ0eSBcIiIuY29uY2F0KGtleSwgIlwiIGlzIGFscmVhZHkgZGVmaW5lZCBpbiBkYXRhLiIpLCB2bSk7CiAgICAgIH0gZWxzZSBpZiAodm0uJG9wdGlvbnMucHJvcHMgJiYga2V5IGluIHZtLiRvcHRpb25zLnByb3BzKSB7CiAgICAgICAgd2FybigiVGhlIGNvbXB1dGVkIHByb3BlcnR5IFwiIi5jb25jYXQoa2V5LCAiXCIgaXMgYWxyZWFkeSBkZWZpbmVkIGFzIGEgcHJvcC4iKSwgdm0pOwogICAgICB9IGVsc2UgaWYgKHZtLiRvcHRpb25zLm1ldGhvZHMgJiYga2V5IGluIHZtLiRvcHRpb25zLm1ldGhvZHMpIHsKICAgICAgICB3YXJuKCJUaGUgY29tcHV0ZWQgcHJvcGVydHkgXCIiLmNvbmNhdChrZXksICJcIiBpcyBhbHJlYWR5IGRlZmluZWQgYXMgYSBtZXRob2QuIiksIHZtKTsKICAgICAgfQogICAgfQogIH0KfQpmdW5jdGlvbiBkZWZpbmVDb21wdXRlZCh0YXJnZXQsIGtleSwgdXNlckRlZikgewogIHZhciBzaG91bGRDYWNoZSA9ICFpc1NlcnZlclJlbmRlcmluZygpOwogIGlmIChpc0Z1bmN0aW9uKHVzZXJEZWYpKSB7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uZ2V0ID0gc2hvdWxkQ2FjaGUgPyBjcmVhdGVDb21wdXRlZEdldHRlcihrZXkpIDogY3JlYXRlR2V0dGVySW52b2tlcih1c2VyRGVmKTsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSBub29wOwogIH0gZWxzZSB7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uZ2V0ID0gdXNlckRlZi5nZXQgPyBzaG91bGRDYWNoZSAmJiB1c2VyRGVmLmNhY2hlICE9PSBmYWxzZSA/IGNyZWF0ZUNvbXB1dGVkR2V0dGVyKGtleSkgOiBjcmVhdGVHZXR0ZXJJbnZva2VyKHVzZXJEZWYuZ2V0KSA6IG5vb3A7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gdXNlckRlZi5zZXQgfHwgbm9vcDsKICB9CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9PT0gbm9vcCkgewogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybigiQ29tcHV0ZWQgcHJvcGVydHkgXCIiLmNvbmNhdChrZXksICJcIiB3YXMgYXNzaWduZWQgdG8gYnV0IGl0IGhhcyBubyBzZXR0ZXIuIiksIHRoaXMpOwogICAgfTsKICB9CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24pOwp9CmZ1bmN0aW9uIGNyZWF0ZUNvbXB1dGVkR2V0dGVyKGtleSkgewogIHJldHVybiBmdW5jdGlvbiBjb21wdXRlZEdldHRlcigpIHsKICAgIHZhciB3YXRjaGVyID0gdGhpcy5fY29tcHV0ZWRXYXRjaGVycyAmJiB0aGlzLl9jb21wdXRlZFdhdGNoZXJzW2tleV07CiAgICBpZiAod2F0Y2hlcikgewogICAgICBpZiAod2F0Y2hlci5kaXJ0eSkgewogICAgICAgIHdhdGNoZXIuZXZhbHVhdGUoKTsKICAgICAgfQogICAgICBpZiAoRGVwLnRhcmdldCkgewogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIERlcC50YXJnZXQub25UcmFjaykgewogICAgICAgICAgRGVwLnRhcmdldC5vblRyYWNrKHsKICAgICAgICAgICAgZWZmZWN0OiBEZXAudGFyZ2V0LAogICAgICAgICAgICB0YXJnZXQ6IHRoaXMsCiAgICAgICAgICAgIHR5cGU6ICJnZXQiIC8qIFRyYWNrT3BUeXBlcy5HRVQgKi8sCiAgICAgICAgICAgIGtleToga2V5CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgd2F0Y2hlci5kZXBlbmQoKTsKICAgICAgfQogICAgICByZXR1cm4gd2F0Y2hlci52YWx1ZTsKICAgIH0KICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZUdldHRlckludm9rZXIoZm4pIHsKICByZXR1cm4gZnVuY3Rpb24gY29tcHV0ZWRHZXR0ZXIoKSB7CiAgICByZXR1cm4gZm4uY2FsbCh0aGlzLCB0aGlzKTsKICB9Owp9CmZ1bmN0aW9uIGluaXRNZXRob2RzKHZtLCBtZXRob2RzKSB7CiAgdmFyIHByb3BzID0gdm0uJG9wdGlvbnMucHJvcHM7CiAgZm9yICh2YXIga2V5IGluIG1ldGhvZHMpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmICh0eXBlb2YgbWV0aG9kc1trZXldICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgd2FybigiTWV0aG9kIFwiIi5jb25jYXQoa2V5LCAiXCIgaGFzIHR5cGUgXCIiKS5jb25jYXQodHlwZW9mIG1ldGhvZHNba2V5XSwgIlwiIGluIHRoZSBjb21wb25lbnQgZGVmaW5pdGlvbi4gIikgKyAiRGlkIHlvdSByZWZlcmVuY2UgdGhlIGZ1bmN0aW9uIGNvcnJlY3RseT8iLCB2bSk7CiAgICAgIH0KICAgICAgaWYgKHByb3BzICYmIGhhc093bihwcm9wcywga2V5KSkgewogICAgICAgIHdhcm4oIk1ldGhvZCBcIiIuY29uY2F0KGtleSwgIlwiIGhhcyBhbHJlYWR5IGJlZW4gZGVmaW5lZCBhcyBhIHByb3AuIiksIHZtKTsKICAgICAgfQogICAgICBpZiAoa2V5IGluIHZtICYmIGlzUmVzZXJ2ZWQoa2V5KSkgewogICAgICAgIHdhcm4oIk1ldGhvZCBcIiIuY29uY2F0KGtleSwgIlwiIGNvbmZsaWN0cyB3aXRoIGFuIGV4aXN0aW5nIFZ1ZSBpbnN0YW5jZSBtZXRob2QuICIpICsgIkF2b2lkIGRlZmluaW5nIGNvbXBvbmVudCBtZXRob2RzIHRoYXQgc3RhcnQgd2l0aCBfIG9yICQuIik7CiAgICAgIH0KICAgIH0KICAgIHZtW2tleV0gPSB0eXBlb2YgbWV0aG9kc1trZXldICE9PSAnZnVuY3Rpb24nID8gbm9vcCA6IGJpbmQobWV0aG9kc1trZXldLCB2bSk7CiAgfQp9CmZ1bmN0aW9uIGluaXRXYXRjaCh2bSwgd2F0Y2gpIHsKICBmb3IgKHZhciBrZXkgaW4gd2F0Y2gpIHsKICAgIHZhciBoYW5kbGVyID0gd2F0Y2hba2V5XTsKICAgIGlmIChpc0FycmF5KGhhbmRsZXIpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlci5sZW5ndGg7IGkrKykgewogICAgICAgIGNyZWF0ZVdhdGNoZXIodm0sIGtleSwgaGFuZGxlcltpXSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNyZWF0ZVdhdGNoZXIodm0sIGtleSwgaGFuZGxlcik7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGNyZWF0ZVdhdGNoZXIodm0sIGV4cE9yRm4sIGhhbmRsZXIsIG9wdGlvbnMpIHsKICBpZiAoaXNQbGFpbk9iamVjdChoYW5kbGVyKSkgewogICAgb3B0aW9ucyA9IGhhbmRsZXI7CiAgICBoYW5kbGVyID0gaGFuZGxlci5oYW5kbGVyOwogIH0KICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdzdHJpbmcnKSB7CiAgICBoYW5kbGVyID0gdm1baGFuZGxlcl07CiAgfQogIHJldHVybiB2bS4kd2F0Y2goZXhwT3JGbiwgaGFuZGxlciwgb3B0aW9ucyk7Cn0KZnVuY3Rpb24gc3RhdGVNaXhpbihWdWUpIHsKICAvLyBmbG93IHNvbWVob3cgaGFzIHByb2JsZW1zIHdpdGggZGlyZWN0bHkgZGVjbGFyZWQgZGVmaW5pdGlvbiBvYmplY3QKICAvLyB3aGVuIHVzaW5nIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSwgc28gd2UgaGF2ZSB0byBwcm9jZWR1cmFsbHkgYnVpbGQgdXAKICAvLyB0aGUgb2JqZWN0IGhlcmUuCiAgdmFyIGRhdGFEZWYgPSB7fTsKICBkYXRhRGVmLmdldCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9kYXRhOwogIH07CiAgdmFyIHByb3BzRGVmID0ge307CiAgcHJvcHNEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3Byb3BzOwogIH07CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGRhdGFEZWYuc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCdBdm9pZCByZXBsYWNpbmcgaW5zdGFuY2Ugcm9vdCAkZGF0YS4gJyArICdVc2UgbmVzdGVkIGRhdGEgcHJvcGVydGllcyBpbnN0ZWFkLicsIHRoaXMpOwogICAgfTsKICAgIHByb3BzRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybigiJHByb3BzIGlzIHJlYWRvbmx5LiIsIHRoaXMpOwogICAgfTsKICB9CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZS5wcm90b3R5cGUsICckZGF0YScsIGRhdGFEZWYpOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJHByb3BzJywgcHJvcHNEZWYpOwogIFZ1ZS5wcm90b3R5cGUuJHNldCA9IHNldDsKICBWdWUucHJvdG90eXBlLiRkZWxldGUgPSBkZWw7CiAgVnVlLnByb3RvdHlwZS4kd2F0Y2ggPSBmdW5jdGlvbiAoZXhwT3JGbiwgY2IsIG9wdGlvbnMpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICBpZiAoaXNQbGFpbk9iamVjdChjYikpIHsKICAgICAgcmV0dXJuIGNyZWF0ZVdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zKTsKICAgIH0KICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgb3B0aW9ucy51c2VyID0gdHJ1ZTsKICAgIHZhciB3YXRjaGVyID0gbmV3IFdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zKTsKICAgIGlmIChvcHRpb25zLmltbWVkaWF0ZSkgewogICAgICB2YXIgaW5mbyA9ICJjYWxsYmFjayBmb3IgaW1tZWRpYXRlIHdhdGNoZXIgXCIiLmNvbmNhdCh3YXRjaGVyLmV4cHJlc3Npb24sICJcIiIpOwogICAgICBwdXNoVGFyZ2V0KCk7CiAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGNiLCB2bSwgW3dhdGNoZXIudmFsdWVdLCB2bSwgaW5mbyk7CiAgICAgIHBvcFRhcmdldCgpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uIHVud2F0Y2hGbigpIHsKICAgICAgd2F0Y2hlci50ZWFyZG93bigpOwogICAgfTsKICB9Owp9CnZhciB1aWQgPSAwOwpmdW5jdGlvbiBpbml0TWl4aW4kMShWdWUpIHsKICBWdWUucHJvdG90eXBlLl9pbml0ID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICAvLyBhIHVpZAogICAgdm0uX3VpZCA9IHVpZCsrOwogICAgdmFyIHN0YXJ0VGFnLCBlbmRUYWc7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGNvbmZpZy5wZXJmb3JtYW5jZSAmJiBtYXJrKSB7CiAgICAgIHN0YXJ0VGFnID0gInZ1ZS1wZXJmLXN0YXJ0OiIuY29uY2F0KHZtLl91aWQpOwogICAgICBlbmRUYWcgPSAidnVlLXBlcmYtZW5kOiIuY29uY2F0KHZtLl91aWQpOwogICAgICBtYXJrKHN0YXJ0VGFnKTsKICAgIH0KICAgIC8vIGEgZmxhZyB0byBtYXJrIHRoaXMgYXMgYSBWdWUgaW5zdGFuY2Ugd2l0aG91dCBoYXZpbmcgdG8gZG8gaW5zdGFuY2VvZgogICAgLy8gY2hlY2sKICAgIHZtLl9pc1Z1ZSA9IHRydWU7CiAgICAvLyBhdm9pZCBpbnN0YW5jZXMgZnJvbSBiZWluZyBvYnNlcnZlZAogICAgdm0uX192X3NraXAgPSB0cnVlOwogICAgLy8gZWZmZWN0IHNjb3BlCiAgICB2bS5fc2NvcGUgPSBuZXcgRWZmZWN0U2NvcGUodHJ1ZSAvKiBkZXRhY2hlZCAqLyk7CiAgICB2bS5fc2NvcGUuX3ZtID0gdHJ1ZTsKICAgIC8vIG1lcmdlIG9wdGlvbnMKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuX2lzQ29tcG9uZW50KSB7CiAgICAgIC8vIG9wdGltaXplIGludGVybmFsIGNvbXBvbmVudCBpbnN0YW50aWF0aW9uCiAgICAgIC8vIHNpbmNlIGR5bmFtaWMgb3B0aW9ucyBtZXJnaW5nIGlzIHByZXR0eSBzbG93LCBhbmQgbm9uZSBvZiB0aGUKICAgICAgLy8gaW50ZXJuYWwgY29tcG9uZW50IG9wdGlvbnMgbmVlZHMgc3BlY2lhbCB0cmVhdG1lbnQuCiAgICAgIGluaXRJbnRlcm5hbENvbXBvbmVudCh2bSwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICB2bS4kb3B0aW9ucyA9IG1lcmdlT3B0aW9ucyhyZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKHZtLmNvbnN0cnVjdG9yKSwgb3B0aW9ucyB8fCB7fSwgdm0pOwogICAgfQogICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGluaXRQcm94eSh2bSk7CiAgICB9IGVsc2UgewogICAgICB2bS5fcmVuZGVyUHJveHkgPSB2bTsKICAgIH0KICAgIC8vIGV4cG9zZSByZWFsIHNlbGYKICAgIHZtLl9zZWxmID0gdm07CiAgICBpbml0TGlmZWN5Y2xlKHZtKTsKICAgIGluaXRFdmVudHModm0pOwogICAgaW5pdFJlbmRlcih2bSk7CiAgICBjYWxsSG9vayQxKHZtLCAnYmVmb3JlQ3JlYXRlJywgdW5kZWZpbmVkLCBmYWxzZSAvKiBzZXRDb250ZXh0ICovKTsKICAgIGluaXRJbmplY3Rpb25zKHZtKTsgLy8gcmVzb2x2ZSBpbmplY3Rpb25zIGJlZm9yZSBkYXRhL3Byb3BzCiAgICBpbml0U3RhdGUodm0pOwogICAgaW5pdFByb3ZpZGUodm0pOyAvLyByZXNvbHZlIHByb3ZpZGUgYWZ0ZXIgZGF0YS9wcm9wcwogICAgY2FsbEhvb2skMSh2bSwgJ2NyZWF0ZWQnKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgICAgdm0uX25hbWUgPSBmb3JtYXRDb21wb25lbnROYW1lKHZtLCBmYWxzZSk7CiAgICAgIG1hcmsoZW5kVGFnKTsKICAgICAgbWVhc3VyZSgidnVlICIuY29uY2F0KHZtLl9uYW1lLCAiIGluaXQiKSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICB9CiAgICBpZiAodm0uJG9wdGlvbnMuZWwpIHsKICAgICAgdm0uJG1vdW50KHZtLiRvcHRpb25zLmVsKTsKICAgIH0KICB9Owp9CmZ1bmN0aW9uIGluaXRJbnRlcm5hbENvbXBvbmVudCh2bSwgb3B0aW9ucykgewogIHZhciBvcHRzID0gdm0uJG9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKHZtLmNvbnN0cnVjdG9yLm9wdGlvbnMpOwogIC8vIGRvaW5nIHRoaXMgYmVjYXVzZSBpdCdzIGZhc3RlciB0aGFuIGR5bmFtaWMgZW51bWVyYXRpb24uCiAgdmFyIHBhcmVudFZub2RlID0gb3B0aW9ucy5fcGFyZW50Vm5vZGU7CiAgb3B0cy5wYXJlbnQgPSBvcHRpb25zLnBhcmVudDsKICBvcHRzLl9wYXJlbnRWbm9kZSA9IHBhcmVudFZub2RlOwogIHZhciB2bm9kZUNvbXBvbmVudE9wdGlvbnMgPSBwYXJlbnRWbm9kZS5jb21wb25lbnRPcHRpb25zOwogIG9wdHMucHJvcHNEYXRhID0gdm5vZGVDb21wb25lbnRPcHRpb25zLnByb3BzRGF0YTsKICBvcHRzLl9wYXJlbnRMaXN0ZW5lcnMgPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMubGlzdGVuZXJzOwogIG9wdHMuX3JlbmRlckNoaWxkcmVuID0gdm5vZGVDb21wb25lbnRPcHRpb25zLmNoaWxkcmVuOwogIG9wdHMuX2NvbXBvbmVudFRhZyA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy50YWc7CiAgaWYgKG9wdGlvbnMucmVuZGVyKSB7CiAgICBvcHRzLnJlbmRlciA9IG9wdGlvbnMucmVuZGVyOwogICAgb3B0cy5zdGF0aWNSZW5kZXJGbnMgPSBvcHRpb25zLnN0YXRpY1JlbmRlckZuczsKICB9Cn0KZnVuY3Rpb24gcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyhDdG9yKSB7CiAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CiAgaWYgKEN0b3Iuc3VwZXIpIHsKICAgIHZhciBzdXBlck9wdGlvbnMgPSByZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKEN0b3Iuc3VwZXIpOwogICAgdmFyIGNhY2hlZFN1cGVyT3B0aW9ucyA9IEN0b3Iuc3VwZXJPcHRpb25zOwogICAgaWYgKHN1cGVyT3B0aW9ucyAhPT0gY2FjaGVkU3VwZXJPcHRpb25zKSB7CiAgICAgIC8vIHN1cGVyIG9wdGlvbiBjaGFuZ2VkLAogICAgICAvLyBuZWVkIHRvIHJlc29sdmUgbmV3IG9wdGlvbnMuCiAgICAgIEN0b3Iuc3VwZXJPcHRpb25zID0gc3VwZXJPcHRpb25zOwogICAgICAvLyBjaGVjayBpZiB0aGVyZSBhcmUgYW55IGxhdGUtbW9kaWZpZWQvYXR0YWNoZWQgb3B0aW9ucyAoIzQ5NzYpCiAgICAgIHZhciBtb2RpZmllZE9wdGlvbnMgPSByZXNvbHZlTW9kaWZpZWRPcHRpb25zKEN0b3IpOwogICAgICAvLyB1cGRhdGUgYmFzZSBleHRlbmQgb3B0aW9ucwogICAgICBpZiAobW9kaWZpZWRPcHRpb25zKSB7CiAgICAgICAgZXh0ZW5kKEN0b3IuZXh0ZW5kT3B0aW9ucywgbW9kaWZpZWRPcHRpb25zKTsKICAgICAgfQogICAgICBvcHRpb25zID0gQ3Rvci5vcHRpb25zID0gbWVyZ2VPcHRpb25zKHN1cGVyT3B0aW9ucywgQ3Rvci5leHRlbmRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMubmFtZSkgewogICAgICAgIG9wdGlvbnMuY29tcG9uZW50c1tvcHRpb25zLm5hbWVdID0gQ3RvcjsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gb3B0aW9uczsKfQpmdW5jdGlvbiByZXNvbHZlTW9kaWZpZWRPcHRpb25zKEN0b3IpIHsKICB2YXIgbW9kaWZpZWQ7CiAgdmFyIGxhdGVzdCA9IEN0b3Iub3B0aW9uczsKICB2YXIgc2VhbGVkID0gQ3Rvci5zZWFsZWRPcHRpb25zOwogIGZvciAodmFyIGtleSBpbiBsYXRlc3QpIHsKICAgIGlmIChsYXRlc3Rba2V5XSAhPT0gc2VhbGVkW2tleV0pIHsKICAgICAgaWYgKCFtb2RpZmllZCkgbW9kaWZpZWQgPSB7fTsKICAgICAgbW9kaWZpZWRba2V5XSA9IGxhdGVzdFtrZXldOwogICAgfQogIH0KICByZXR1cm4gbW9kaWZpZWQ7Cn0KZnVuY3Rpb24gVnVlKG9wdGlvbnMpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhKHRoaXMgaW5zdGFuY2VvZiBWdWUpKSB7CiAgICB3YXJuKCdWdWUgaXMgYSBjb25zdHJ1Y3RvciBhbmQgc2hvdWxkIGJlIGNhbGxlZCB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkJyk7CiAgfQogIHRoaXMuX2luaXQob3B0aW9ucyk7Cn0KLy9AdHMtZXhwZWN0LWVycm9yIFZ1ZSBoYXMgZnVuY3Rpb24gdHlwZQppbml0TWl4aW4kMShWdWUpOwovL0B0cy1leHBlY3QtZXJyb3IgVnVlIGhhcyBmdW5jdGlvbiB0eXBlCnN0YXRlTWl4aW4oVnVlKTsKLy9AdHMtZXhwZWN0LWVycm9yIFZ1ZSBoYXMgZnVuY3Rpb24gdHlwZQpldmVudHNNaXhpbihWdWUpOwovL0B0cy1leHBlY3QtZXJyb3IgVnVlIGhhcyBmdW5jdGlvbiB0eXBlCmxpZmVjeWNsZU1peGluKFZ1ZSk7Ci8vQHRzLWV4cGVjdC1lcnJvciBWdWUgaGFzIGZ1bmN0aW9uIHR5cGUKcmVuZGVyTWl4aW4oVnVlKTsKZnVuY3Rpb24gaW5pdFVzZShWdWUpIHsKICBWdWUudXNlID0gZnVuY3Rpb24gKHBsdWdpbikgewogICAgdmFyIGluc3RhbGxlZFBsdWdpbnMgPSB0aGlzLl9pbnN0YWxsZWRQbHVnaW5zIHx8ICh0aGlzLl9pbnN0YWxsZWRQbHVnaW5zID0gW10pOwogICAgaWYgKGluc3RhbGxlZFBsdWdpbnMuaW5kZXhPZihwbHVnaW4pID4gLTEpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvLyBhZGRpdGlvbmFsIHBhcmFtZXRlcnMKICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMsIDEpOwogICAgYXJncy51bnNoaWZ0KHRoaXMpOwogICAgaWYgKGlzRnVuY3Rpb24ocGx1Z2luLmluc3RhbGwpKSB7CiAgICAgIHBsdWdpbi5pbnN0YWxsLmFwcGx5KHBsdWdpbiwgYXJncyk7CiAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24ocGx1Z2luKSkgewogICAgICBwbHVnaW4uYXBwbHkobnVsbCwgYXJncyk7CiAgICB9CiAgICBpbnN0YWxsZWRQbHVnaW5zLnB1c2gocGx1Z2luKTsKICAgIHJldHVybiB0aGlzOwogIH07Cn0KZnVuY3Rpb24gaW5pdE1peGluKFZ1ZSkgewogIFZ1ZS5taXhpbiA9IGZ1bmN0aW9uIChtaXhpbikgewogICAgdGhpcy5vcHRpb25zID0gbWVyZ2VPcHRpb25zKHRoaXMub3B0aW9ucywgbWl4aW4pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKfQpmdW5jdGlvbiBpbml0RXh0ZW5kKFZ1ZSkgewogIC8qKgogICAqIEVhY2ggaW5zdGFuY2UgY29uc3RydWN0b3IsIGluY2x1ZGluZyBWdWUsIGhhcyBhIHVuaXF1ZQogICAqIGNpZC4gVGhpcyBlbmFibGVzIHVzIHRvIGNyZWF0ZSB3cmFwcGVkICJjaGlsZAogICAqIGNvbnN0cnVjdG9ycyIgZm9yIHByb3RvdHlwYWwgaW5oZXJpdGFuY2UgYW5kIGNhY2hlIHRoZW0uCiAgICovCiAgVnVlLmNpZCA9IDA7CiAgdmFyIGNpZCA9IDE7CiAgLyoqCiAgICogQ2xhc3MgaW5oZXJpdGFuY2UKICAgKi8KICBWdWUuZXh0ZW5kID0gZnVuY3Rpb24gKGV4dGVuZE9wdGlvbnMpIHsKICAgIGV4dGVuZE9wdGlvbnMgPSBleHRlbmRPcHRpb25zIHx8IHt9OwogICAgdmFyIFN1cGVyID0gdGhpczsKICAgIHZhciBTdXBlcklkID0gU3VwZXIuY2lkOwogICAgdmFyIGNhY2hlZEN0b3JzID0gZXh0ZW5kT3B0aW9ucy5fQ3RvciB8fCAoZXh0ZW5kT3B0aW9ucy5fQ3RvciA9IHt9KTsKICAgIGlmIChjYWNoZWRDdG9yc1tTdXBlcklkXSkgewogICAgICByZXR1cm4gY2FjaGVkQ3RvcnNbU3VwZXJJZF07CiAgICB9CiAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWUoZXh0ZW5kT3B0aW9ucykgfHwgZ2V0Q29tcG9uZW50TmFtZShTdXBlci5vcHRpb25zKTsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIG5hbWUpIHsKICAgICAgdmFsaWRhdGVDb21wb25lbnROYW1lKG5hbWUpOwogICAgfQogICAgdmFyIFN1YiA9IGZ1bmN0aW9uIFZ1ZUNvbXBvbmVudChvcHRpb25zKSB7CiAgICAgIHRoaXMuX2luaXQob3B0aW9ucyk7CiAgICB9OwogICAgU3ViLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3VwZXIucHJvdG90eXBlKTsKICAgIFN1Yi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBTdWI7CiAgICBTdWIuY2lkID0gY2lkKys7CiAgICBTdWIub3B0aW9ucyA9IG1lcmdlT3B0aW9ucyhTdXBlci5vcHRpb25zLCBleHRlbmRPcHRpb25zKTsKICAgIFN1Ylsnc3VwZXInXSA9IFN1cGVyOwogICAgLy8gRm9yIHByb3BzIGFuZCBjb21wdXRlZCBwcm9wZXJ0aWVzLCB3ZSBkZWZpbmUgdGhlIHByb3h5IGdldHRlcnMgb24KICAgIC8vIHRoZSBWdWUgaW5zdGFuY2VzIGF0IGV4dGVuc2lvbiB0aW1lLCBvbiB0aGUgZXh0ZW5kZWQgcHJvdG90eXBlLiBUaGlzCiAgICAvLyBhdm9pZHMgT2JqZWN0LmRlZmluZVByb3BlcnR5IGNhbGxzIGZvciBlYWNoIGluc3RhbmNlIGNyZWF0ZWQuCiAgICBpZiAoU3ViLm9wdGlvbnMucHJvcHMpIHsKICAgICAgaW5pdFByb3BzKFN1Yik7CiAgICB9CiAgICBpZiAoU3ViLm9wdGlvbnMuY29tcHV0ZWQpIHsKICAgICAgaW5pdENvbXB1dGVkKFN1Yik7CiAgICB9CiAgICAvLyBhbGxvdyBmdXJ0aGVyIGV4dGVuc2lvbi9taXhpbi9wbHVnaW4gdXNhZ2UKICAgIFN1Yi5leHRlbmQgPSBTdXBlci5leHRlbmQ7CiAgICBTdWIubWl4aW4gPSBTdXBlci5taXhpbjsKICAgIFN1Yi51c2UgPSBTdXBlci51c2U7CiAgICAvLyBjcmVhdGUgYXNzZXQgcmVnaXN0ZXJzLCBzbyBleHRlbmRlZCBjbGFzc2VzCiAgICAvLyBjYW4gaGF2ZSB0aGVpciBwcml2YXRlIGFzc2V0cyB0b28uCiAgICBBU1NFVF9UWVBFUy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIFN1Ylt0eXBlXSA9IFN1cGVyW3R5cGVdOwogICAgfSk7CiAgICAvLyBlbmFibGUgcmVjdXJzaXZlIHNlbGYtbG9va3VwCiAgICBpZiAobmFtZSkgewogICAgICBTdWIub3B0aW9ucy5jb21wb25lbnRzW25hbWVdID0gU3ViOwogICAgfQogICAgLy8ga2VlcCBhIHJlZmVyZW5jZSB0byB0aGUgc3VwZXIgb3B0aW9ucyBhdCBleHRlbnNpb24gdGltZS4KICAgIC8vIGxhdGVyIGF0IGluc3RhbnRpYXRpb24gd2UgY2FuIGNoZWNrIGlmIFN1cGVyJ3Mgb3B0aW9ucyBoYXZlCiAgICAvLyBiZWVuIHVwZGF0ZWQuCiAgICBTdWIuc3VwZXJPcHRpb25zID0gU3VwZXIub3B0aW9uczsKICAgIFN1Yi5leHRlbmRPcHRpb25zID0gZXh0ZW5kT3B0aW9uczsKICAgIFN1Yi5zZWFsZWRPcHRpb25zID0gZXh0ZW5kKHt9LCBTdWIub3B0aW9ucyk7CiAgICAvLyBjYWNoZSBjb25zdHJ1Y3RvcgogICAgY2FjaGVkQ3RvcnNbU3VwZXJJZF0gPSBTdWI7CiAgICByZXR1cm4gU3ViOwogIH07Cn0KZnVuY3Rpb24gaW5pdFByb3BzKENvbXApIHsKICB2YXIgcHJvcHMgPSBDb21wLm9wdGlvbnMucHJvcHM7CiAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICBwcm94eShDb21wLnByb3RvdHlwZSwgIl9wcm9wcyIsIGtleSk7CiAgfQp9CmZ1bmN0aW9uIGluaXRDb21wdXRlZChDb21wKSB7CiAgdmFyIGNvbXB1dGVkID0gQ29tcC5vcHRpb25zLmNvbXB1dGVkOwogIGZvciAodmFyIGtleSBpbiBjb21wdXRlZCkgewogICAgZGVmaW5lQ29tcHV0ZWQoQ29tcC5wcm90b3R5cGUsIGtleSwgY29tcHV0ZWRba2V5XSk7CiAgfQp9CmZ1bmN0aW9uIGluaXRBc3NldFJlZ2lzdGVycyhWdWUpIHsKICAvKioKICAgKiBDcmVhdGUgYXNzZXQgcmVnaXN0cmF0aW9uIG1ldGhvZHMuCiAgICovCiAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgLy8gQHRzLWV4cGVjdC1lcnJvciBmdW5jdGlvbiBpcyBub3QgZXhhY3Qgc2FtZSB0eXBlCiAgICBWdWVbdHlwZV0gPSBmdW5jdGlvbiAoaWQsIGRlZmluaXRpb24pIHsKICAgICAgaWYgKCFkZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9uc1t0eXBlICsgJ3MnXVtpZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgdHlwZSA9PT0gJ2NvbXBvbmVudCcpIHsKICAgICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShpZCk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlID09PSAnY29tcG9uZW50JyAmJiBpc1BsYWluT2JqZWN0KGRlZmluaXRpb24pKSB7CiAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yCiAgICAgICAgICBkZWZpbml0aW9uLm5hbWUgPSBkZWZpbml0aW9uLm5hbWUgfHwgaWQ7CiAgICAgICAgICBkZWZpbml0aW9uID0gdGhpcy5vcHRpb25zLl9iYXNlLmV4dGVuZChkZWZpbml0aW9uKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGUgPT09ICdkaXJlY3RpdmUnICYmIGlzRnVuY3Rpb24oZGVmaW5pdGlvbikpIHsKICAgICAgICAgIGRlZmluaXRpb24gPSB7CiAgICAgICAgICAgIGJpbmQ6IGRlZmluaXRpb24sCiAgICAgICAgICAgIHVwZGF0ZTogZGVmaW5pdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdGhpcy5vcHRpb25zW3R5cGUgKyAncyddW2lkXSA9IGRlZmluaXRpb247CiAgICAgICAgcmV0dXJuIGRlZmluaXRpb247CiAgICAgIH0KICAgIH07CiAgfSk7Cn0KZnVuY3Rpb24gX2dldENvbXBvbmVudE5hbWUob3B0cykgewogIHJldHVybiBvcHRzICYmIChnZXRDb21wb25lbnROYW1lKG9wdHMuQ3Rvci5vcHRpb25zKSB8fCBvcHRzLnRhZyk7Cn0KZnVuY3Rpb24gbWF0Y2hlcyhwYXR0ZXJuLCBuYW1lKSB7CiAgaWYgKGlzQXJyYXkocGF0dGVybikpIHsKICAgIHJldHVybiBwYXR0ZXJuLmluZGV4T2YobmFtZSkgPiAtMTsKICB9IGVsc2UgaWYgKHR5cGVvZiBwYXR0ZXJuID09PSAnc3RyaW5nJykgewogICAgcmV0dXJuIHBhdHRlcm4uc3BsaXQoJywnKS5pbmRleE9mKG5hbWUpID4gLTE7CiAgfSBlbHNlIGlmIChpc1JlZ0V4cChwYXR0ZXJuKSkgewogICAgcmV0dXJuIHBhdHRlcm4udGVzdChuYW1lKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gcHJ1bmVDYWNoZShrZWVwQWxpdmVJbnN0YW5jZSwgZmlsdGVyKSB7CiAgdmFyIGNhY2hlID0ga2VlcEFsaXZlSW5zdGFuY2UuY2FjaGUsCiAgICBrZXlzID0ga2VlcEFsaXZlSW5zdGFuY2Uua2V5cywKICAgIF92bm9kZSA9IGtlZXBBbGl2ZUluc3RhbmNlLl92bm9kZTsKICBmb3IgKHZhciBrZXkgaW4gY2FjaGUpIHsKICAgIHZhciBlbnRyeSA9IGNhY2hlW2tleV07CiAgICBpZiAoZW50cnkpIHsKICAgICAgdmFyIG5hbWVfMSA9IGVudHJ5Lm5hbWU7CiAgICAgIGlmIChuYW1lXzEgJiYgIWZpbHRlcihuYW1lXzEpKSB7CiAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXksIGtleXMsIF92bm9kZSk7CiAgICAgIH0KICAgIH0KICB9Cn0KZnVuY3Rpb24gcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXksIGtleXMsIGN1cnJlbnQpIHsKICB2YXIgZW50cnkgPSBjYWNoZVtrZXldOwogIGlmIChlbnRyeSAmJiAoIWN1cnJlbnQgfHwgZW50cnkudGFnICE9PSBjdXJyZW50LnRhZykpIHsKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgY2FuIGJlIHVuZGVmaW5lZAogICAgZW50cnkuY29tcG9uZW50SW5zdGFuY2UuJGRlc3Ryb3koKTsKICB9CiAgY2FjaGVba2V5XSA9IG51bGw7CiAgcmVtb3ZlJDIoa2V5cywga2V5KTsKfQp2YXIgcGF0dGVyblR5cGVzID0gW1N0cmluZywgUmVnRXhwLCBBcnJheV07Ci8vIFRPRE8gZGVmaW5lQ29tcG9uZW50CnZhciBLZWVwQWxpdmUgPSB7CiAgbmFtZTogJ2tlZXAtYWxpdmUnLAogIGFic3RyYWN0OiB0cnVlLAogIHByb3BzOiB7CiAgICBpbmNsdWRlOiBwYXR0ZXJuVHlwZXMsCiAgICBleGNsdWRlOiBwYXR0ZXJuVHlwZXMsCiAgICBtYXg6IFtTdHJpbmcsIE51bWJlcl0KICB9LAogIG1ldGhvZHM6IHsKICAgIGNhY2hlVk5vZGU6IGZ1bmN0aW9uIGNhY2hlVk5vZGUoKSB7CiAgICAgIHZhciBfYSA9IHRoaXMsCiAgICAgICAgY2FjaGUgPSBfYS5jYWNoZSwKICAgICAgICBrZXlzID0gX2Eua2V5cywKICAgICAgICB2bm9kZVRvQ2FjaGUgPSBfYS52bm9kZVRvQ2FjaGUsCiAgICAgICAga2V5VG9DYWNoZSA9IF9hLmtleVRvQ2FjaGU7CiAgICAgIGlmICh2bm9kZVRvQ2FjaGUpIHsKICAgICAgICB2YXIgdGFnID0gdm5vZGVUb0NhY2hlLnRhZywKICAgICAgICAgIGNvbXBvbmVudEluc3RhbmNlID0gdm5vZGVUb0NhY2hlLmNvbXBvbmVudEluc3RhbmNlLAogICAgICAgICAgY29tcG9uZW50T3B0aW9ucyA9IHZub2RlVG9DYWNoZS5jb21wb25lbnRPcHRpb25zOwogICAgICAgIGNhY2hlW2tleVRvQ2FjaGVdID0gewogICAgICAgICAgbmFtZTogX2dldENvbXBvbmVudE5hbWUoY29tcG9uZW50T3B0aW9ucyksCiAgICAgICAgICB0YWc6IHRhZywKICAgICAgICAgIGNvbXBvbmVudEluc3RhbmNlOiBjb21wb25lbnRJbnN0YW5jZQogICAgICAgIH07CiAgICAgICAga2V5cy5wdXNoKGtleVRvQ2FjaGUpOwogICAgICAgIC8vIHBydW5lIG9sZGVzdCBlbnRyeQogICAgICAgIGlmICh0aGlzLm1heCAmJiBrZXlzLmxlbmd0aCA+IHBhcnNlSW50KHRoaXMubWF4KSkgewogICAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXlzWzBdLCBrZXlzLCB0aGlzLl92bm9kZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMudm5vZGVUb0NhY2hlID0gbnVsbDsKICAgICAgfQogICAgfQogIH0sCiAgY3JlYXRlZDogZnVuY3Rpb24gY3JlYXRlZCgpIHsKICAgIHRoaXMuY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5rZXlzID0gW107CiAgfSwKICBkZXN0cm95ZWQ6IGZ1bmN0aW9uIGRlc3Ryb3llZCgpIHsKICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmNhY2hlKSB7CiAgICAgIHBydW5lQ2FjaGVFbnRyeSh0aGlzLmNhY2hlLCBrZXksIHRoaXMua2V5cyk7CiAgICB9CiAgfSwKICBtb3VudGVkOiBmdW5jdGlvbiBtb3VudGVkKCkgewogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHRoaXMuY2FjaGVWTm9kZSgpOwogICAgdGhpcy4kd2F0Y2goJ2luY2x1ZGUnLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgIHBydW5lQ2FjaGUoX3RoaXMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIG1hdGNoZXModmFsLCBuYW1lKTsKICAgICAgfSk7CiAgICB9KTsKICAgIHRoaXMuJHdhdGNoKCdleGNsdWRlJywgZnVuY3Rpb24gKHZhbCkgewogICAgICBwcnVuZUNhY2hlKF90aGlzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiAhbWF0Y2hlcyh2YWwsIG5hbWUpOwogICAgICB9KTsKICAgIH0pOwogIH0sCiAgdXBkYXRlZDogZnVuY3Rpb24gdXBkYXRlZCgpIHsKICAgIHRoaXMuY2FjaGVWTm9kZSgpOwogIH0sCiAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICB2YXIgc2xvdCA9IHRoaXMuJHNsb3RzLmRlZmF1bHQ7CiAgICB2YXIgdm5vZGUgPSBnZXRGaXJzdENvbXBvbmVudENoaWxkKHNsb3QpOwogICAgdmFyIGNvbXBvbmVudE9wdGlvbnMgPSB2bm9kZSAmJiB2bm9kZS5jb21wb25lbnRPcHRpb25zOwogICAgaWYgKGNvbXBvbmVudE9wdGlvbnMpIHsKICAgICAgLy8gY2hlY2sgcGF0dGVybgogICAgICB2YXIgbmFtZV8yID0gX2dldENvbXBvbmVudE5hbWUoY29tcG9uZW50T3B0aW9ucyk7CiAgICAgIHZhciBfYSA9IHRoaXMsCiAgICAgICAgaW5jbHVkZSA9IF9hLmluY2x1ZGUsCiAgICAgICAgZXhjbHVkZSA9IF9hLmV4Y2x1ZGU7CiAgICAgIGlmICgKICAgICAgLy8gbm90IGluY2x1ZGVkCiAgICAgIGluY2x1ZGUgJiYgKCFuYW1lXzIgfHwgIW1hdGNoZXMoaW5jbHVkZSwgbmFtZV8yKSkgfHwKICAgICAgLy8gZXhjbHVkZWQKICAgICAgZXhjbHVkZSAmJiBuYW1lXzIgJiYgbWF0Y2hlcyhleGNsdWRlLCBuYW1lXzIpKSB7CiAgICAgICAgcmV0dXJuIHZub2RlOwogICAgICB9CiAgICAgIHZhciBfYiA9IHRoaXMsCiAgICAgICAgY2FjaGUgPSBfYi5jYWNoZSwKICAgICAgICBrZXlzID0gX2Iua2V5czsKICAgICAgdmFyIGtleSA9IHZub2RlLmtleSA9PSBudWxsID8KICAgICAgLy8gc2FtZSBjb25zdHJ1Y3RvciBtYXkgZ2V0IHJlZ2lzdGVyZWQgYXMgZGlmZmVyZW50IGxvY2FsIGNvbXBvbmVudHMKICAgICAgLy8gc28gY2lkIGFsb25lIGlzIG5vdCBlbm91Z2ggKCMzMjY5KQogICAgICBjb21wb25lbnRPcHRpb25zLkN0b3IuY2lkICsgKGNvbXBvbmVudE9wdGlvbnMudGFnID8gIjo6Ii5jb25jYXQoY29tcG9uZW50T3B0aW9ucy50YWcpIDogJycpIDogdm5vZGUua2V5OwogICAgICBpZiAoY2FjaGVba2V5XSkgewogICAgICAgIHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gY2FjaGVba2V5XS5jb21wb25lbnRJbnN0YW5jZTsKICAgICAgICAvLyBtYWtlIGN1cnJlbnQga2V5IGZyZXNoZXN0CiAgICAgICAgcmVtb3ZlJDIoa2V5cywga2V5KTsKICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBkZWxheSBzZXR0aW5nIHRoZSBjYWNoZSB1bnRpbCB1cGRhdGUKICAgICAgICB0aGlzLnZub2RlVG9DYWNoZSA9IHZub2RlOwogICAgICAgIHRoaXMua2V5VG9DYWNoZSA9IGtleTsKICAgICAgfQogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGNhbiB2bm9kZS5kYXRhIGNhbiBiZSB1bmRlZmluZWQKICAgICAgdm5vZGUuZGF0YS5rZWVwQWxpdmUgPSB0cnVlOwogICAgfQogICAgcmV0dXJuIHZub2RlIHx8IHNsb3QgJiYgc2xvdFswXTsKICB9Cn07CnZhciBidWlsdEluQ29tcG9uZW50cyA9IHsKICBLZWVwQWxpdmU6IEtlZXBBbGl2ZQp9OwpmdW5jdGlvbiBpbml0R2xvYmFsQVBJKFZ1ZSkgewogIC8vIGNvbmZpZwogIHZhciBjb25maWdEZWYgPSB7fTsKICBjb25maWdEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbmZpZzsKICB9OwogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBjb25maWdEZWYuc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCdEbyBub3QgcmVwbGFjZSB0aGUgVnVlLmNvbmZpZyBvYmplY3QsIHNldCBpbmRpdmlkdWFsIGZpZWxkcyBpbnN0ZWFkLicpOwogICAgfTsKICB9CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZSwgJ2NvbmZpZycsIGNvbmZpZ0RlZik7CiAgLy8gZXhwb3NlZCB1dGlsIG1ldGhvZHMuCiAgLy8gTk9URTogdGhlc2UgYXJlIG5vdCBjb25zaWRlcmVkIHBhcnQgb2YgdGhlIHB1YmxpYyBBUEkgLSBhdm9pZCByZWx5aW5nIG9uCiAgLy8gdGhlbSB1bmxlc3MgeW91IGFyZSBhd2FyZSBvZiB0aGUgcmlzay4KICBWdWUudXRpbCA9IHsKICAgIHdhcm46IHdhcm4sCiAgICBleHRlbmQ6IGV4dGVuZCwKICAgIG1lcmdlT3B0aW9uczogbWVyZ2VPcHRpb25zLAogICAgZGVmaW5lUmVhY3RpdmU6IGRlZmluZVJlYWN0aXZlCiAgfTsKICBWdWUuc2V0ID0gc2V0OwogIFZ1ZS5kZWxldGUgPSBkZWw7CiAgVnVlLm5leHRUaWNrID0gbmV4dFRpY2s7CiAgLy8gMi42IGV4cGxpY2l0IG9ic2VydmFibGUgQVBJCiAgVnVlLm9ic2VydmFibGUgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBvYnNlcnZlKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CiAgVnVlLm9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIEFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICAgIFZ1ZS5vcHRpb25zW3R5cGUgKyAncyddID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9KTsKICAvLyB0aGlzIGlzIHVzZWQgdG8gaWRlbnRpZnkgdGhlICJiYXNlIiBjb25zdHJ1Y3RvciB0byBleHRlbmQgYWxsIHBsYWluLW9iamVjdAogIC8vIGNvbXBvbmVudHMgd2l0aCBpbiBXZWV4J3MgbXVsdGktaW5zdGFuY2Ugc2NlbmFyaW9zLgogIFZ1ZS5vcHRpb25zLl9iYXNlID0gVnVlOwogIGV4dGVuZChWdWUub3B0aW9ucy5jb21wb25lbnRzLCBidWlsdEluQ29tcG9uZW50cyk7CiAgaW5pdFVzZShWdWUpOwogIGluaXRNaXhpbihWdWUpOwogIGluaXRFeHRlbmQoVnVlKTsKICBpbml0QXNzZXRSZWdpc3RlcnMoVnVlKTsKfQppbml0R2xvYmFsQVBJKFZ1ZSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJGlzU2VydmVyJywgewogIGdldDogaXNTZXJ2ZXJSZW5kZXJpbmcKfSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJHNzckNvbnRleHQnLCB7CiAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgcmV0dXJuIHRoaXMuJHZub2RlICYmIHRoaXMuJHZub2RlLnNzckNvbnRleHQ7CiAgfQp9KTsKLy8gZXhwb3NlIEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0IGZvciBzc3IgcnVudGltZSBoZWxwZXIgaW5zdGFsbGF0aW9uCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUsICdGdW5jdGlvbmFsUmVuZGVyQ29udGV4dCcsIHsKICB2YWx1ZTogRnVuY3Rpb25hbFJlbmRlckNvbnRleHQKfSk7ClZ1ZS52ZXJzaW9uID0gdmVyc2lvbjsKCi8vIHRoZXNlIGFyZSByZXNlcnZlZCBmb3Igd2ViIGJlY2F1c2UgdGhleSBhcmUgZGlyZWN0bHkgY29tcGlsZWQgYXdheQovLyBkdXJpbmcgdGVtcGxhdGUgY29tcGlsYXRpb24KdmFyIGlzUmVzZXJ2ZWRBdHRyID0gbWFrZU1hcCgnc3R5bGUsY2xhc3MnKTsKLy8gYXR0cmlidXRlcyB0aGF0IHNob3VsZCBiZSB1c2luZyBwcm9wcyBmb3IgYmluZGluZwp2YXIgYWNjZXB0VmFsdWUgPSBtYWtlTWFwKCdpbnB1dCx0ZXh0YXJlYSxvcHRpb24sc2VsZWN0LHByb2dyZXNzJyk7CnZhciBtdXN0VXNlUHJvcCA9IGZ1bmN0aW9uIG11c3RVc2VQcm9wKHRhZywgdHlwZSwgYXR0cikgewogIHJldHVybiBhdHRyID09PSAndmFsdWUnICYmIGFjY2VwdFZhbHVlKHRhZykgJiYgdHlwZSAhPT0gJ2J1dHRvbicgfHwgYXR0ciA9PT0gJ3NlbGVjdGVkJyAmJiB0YWcgPT09ICdvcHRpb24nIHx8IGF0dHIgPT09ICdjaGVja2VkJyAmJiB0YWcgPT09ICdpbnB1dCcgfHwgYXR0ciA9PT0gJ211dGVkJyAmJiB0YWcgPT09ICd2aWRlbyc7Cn07CnZhciBpc0VudW1lcmF0ZWRBdHRyID0gbWFrZU1hcCgnY29udGVudGVkaXRhYmxlLGRyYWdnYWJsZSxzcGVsbGNoZWNrJyk7CnZhciBpc1ZhbGlkQ29udGVudEVkaXRhYmxlVmFsdWUgPSBtYWtlTWFwKCdldmVudHMsY2FyZXQsdHlwaW5nLHBsYWludGV4dC1vbmx5Jyk7CnZhciBjb252ZXJ0RW51bWVyYXRlZFZhbHVlID0gZnVuY3Rpb24gY29udmVydEVudW1lcmF0ZWRWYWx1ZShrZXksIHZhbHVlKSB7CiAgcmV0dXJuIGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpIHx8IHZhbHVlID09PSAnZmFsc2UnID8gJ2ZhbHNlJyA6CiAgLy8gYWxsb3cgYXJiaXRyYXJ5IHN0cmluZyB2YWx1ZSBmb3IgY29udGVudGVkaXRhYmxlCiAga2V5ID09PSAnY29udGVudGVkaXRhYmxlJyAmJiBpc1ZhbGlkQ29udGVudEVkaXRhYmxlVmFsdWUodmFsdWUpID8gdmFsdWUgOiAndHJ1ZSc7Cn07CnZhciBpc0Jvb2xlYW5BdHRyID0gbWFrZU1hcCgnYWxsb3dmdWxsc2NyZWVuLGFzeW5jLGF1dG9mb2N1cyxhdXRvcGxheSxjaGVja2VkLGNvbXBhY3QsY29udHJvbHMsZGVjbGFyZSwnICsgJ2RlZmF1bHQsZGVmYXVsdGNoZWNrZWQsZGVmYXVsdG11dGVkLGRlZmF1bHRzZWxlY3RlZCxkZWZlcixkaXNhYmxlZCwnICsgJ2VuYWJsZWQsZm9ybW5vdmFsaWRhdGUsaGlkZGVuLGluZGV0ZXJtaW5hdGUsaW5lcnQsaXNtYXAsaXRlbXNjb3BlLGxvb3AsbXVsdGlwbGUsJyArICdtdXRlZCxub2hyZWYsbm9yZXNpemUsbm9zaGFkZSxub3ZhbGlkYXRlLG5vd3JhcCxvcGVuLHBhdXNlb25leGl0LHJlYWRvbmx5LCcgKyAncmVxdWlyZWQscmV2ZXJzZWQsc2NvcGVkLHNlYW1sZXNzLHNlbGVjdGVkLHNvcnRhYmxlLCcgKyAndHJ1ZXNwZWVkLHR5cGVtdXN0bWF0Y2gsdmlzaWJsZScpOwp2YXIgeGxpbmtOUyA9ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJzsKdmFyIGlzWGxpbmsgPSBmdW5jdGlvbiBpc1hsaW5rKG5hbWUpIHsKICByZXR1cm4gbmFtZS5jaGFyQXQoNSkgPT09ICc6JyAmJiBuYW1lLnNsaWNlKDAsIDUpID09PSAneGxpbmsnOwp9Owp2YXIgZ2V0WGxpbmtQcm9wID0gZnVuY3Rpb24gZ2V0WGxpbmtQcm9wKG5hbWUpIHsKICByZXR1cm4gaXNYbGluayhuYW1lKSA/IG5hbWUuc2xpY2UoNiwgbmFtZS5sZW5ndGgpIDogJyc7Cn07CnZhciBpc0ZhbHN5QXR0clZhbHVlID0gZnVuY3Rpb24gaXNGYWxzeUF0dHJWYWx1ZSh2YWwpIHsKICByZXR1cm4gdmFsID09IG51bGwgfHwgdmFsID09PSBmYWxzZTsKfTsKZnVuY3Rpb24gZ2VuQ2xhc3NGb3JWbm9kZSh2bm9kZSkgewogIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICB2YXIgcGFyZW50Tm9kZSA9IHZub2RlOwogIHZhciBjaGlsZE5vZGUgPSB2bm9kZTsKICB3aGlsZSAoaXNEZWYoY2hpbGROb2RlLmNvbXBvbmVudEluc3RhbmNlKSkgewogICAgY2hpbGROb2RlID0gY2hpbGROb2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKICAgIGlmIChjaGlsZE5vZGUgJiYgY2hpbGROb2RlLmRhdGEpIHsKICAgICAgZGF0YSA9IG1lcmdlQ2xhc3NEYXRhKGNoaWxkTm9kZS5kYXRhLCBkYXRhKTsKICAgIH0KICB9CiAgLy8gQHRzLWV4cGVjdC1lcnJvciBwYXJlbnROb2RlLnBhcmVudCBub3QgVk5vZGVXaXRoRGF0YQogIHdoaWxlIChpc0RlZihwYXJlbnROb2RlID0gcGFyZW50Tm9kZS5wYXJlbnQpKSB7CiAgICBpZiAocGFyZW50Tm9kZSAmJiBwYXJlbnROb2RlLmRhdGEpIHsKICAgICAgZGF0YSA9IG1lcmdlQ2xhc3NEYXRhKGRhdGEsIHBhcmVudE5vZGUuZGF0YSk7CiAgICB9CiAgfQogIHJldHVybiByZW5kZXJDbGFzcyhkYXRhLnN0YXRpY0NsYXNzLCBkYXRhLmNsYXNzKTsKfQpmdW5jdGlvbiBtZXJnZUNsYXNzRGF0YShjaGlsZCwgcGFyZW50KSB7CiAgcmV0dXJuIHsKICAgIHN0YXRpY0NsYXNzOiBjb25jYXQoY2hpbGQuc3RhdGljQ2xhc3MsIHBhcmVudC5zdGF0aWNDbGFzcyksCiAgICBjbGFzczogaXNEZWYoY2hpbGQuY2xhc3MpID8gW2NoaWxkLmNsYXNzLCBwYXJlbnQuY2xhc3NdIDogcGFyZW50LmNsYXNzCiAgfTsKfQpmdW5jdGlvbiByZW5kZXJDbGFzcyhzdGF0aWNDbGFzcywgZHluYW1pY0NsYXNzKSB7CiAgaWYgKGlzRGVmKHN0YXRpY0NsYXNzKSB8fCBpc0RlZihkeW5hbWljQ2xhc3MpKSB7CiAgICByZXR1cm4gY29uY2F0KHN0YXRpY0NsYXNzLCBzdHJpbmdpZnlDbGFzcyhkeW5hbWljQ2xhc3MpKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICByZXR1cm4gJyc7Cn0KZnVuY3Rpb24gY29uY2F0KGEsIGIpIHsKICByZXR1cm4gYSA/IGIgPyBhICsgJyAnICsgYiA6IGEgOiBiIHx8ICcnOwp9CmZ1bmN0aW9uIHN0cmluZ2lmeUNsYXNzKHZhbHVlKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICByZXR1cm4gc3RyaW5naWZ5QXJyYXkodmFsdWUpOwogIH0KICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICByZXR1cm4gc3RyaW5naWZ5T2JqZWN0KHZhbHVlKTsKICB9CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICByZXR1cm4gJyc7Cn0KZnVuY3Rpb24gc3RyaW5naWZ5QXJyYXkodmFsdWUpIHsKICB2YXIgcmVzID0gJyc7CiAgdmFyIHN0cmluZ2lmaWVkOwogIGZvciAodmFyIGkgPSAwLCBsID0gdmFsdWUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBpZiAoaXNEZWYoc3RyaW5naWZpZWQgPSBzdHJpbmdpZnlDbGFzcyh2YWx1ZVtpXSkpICYmIHN0cmluZ2lmaWVkICE9PSAnJykgewogICAgICBpZiAocmVzKSByZXMgKz0gJyAnOwogICAgICByZXMgKz0gc3RyaW5naWZpZWQ7CiAgICB9CiAgfQogIHJldHVybiByZXM7Cn0KZnVuY3Rpb24gc3RyaW5naWZ5T2JqZWN0KHZhbHVlKSB7CiAgdmFyIHJlcyA9ICcnOwogIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgewogICAgaWYgKHZhbHVlW2tleV0pIHsKICAgICAgaWYgKHJlcykgcmVzICs9ICcgJzsKICAgICAgcmVzICs9IGtleTsKICAgIH0KICB9CiAgcmV0dXJuIHJlczsKfQp2YXIgbmFtZXNwYWNlTWFwID0gewogIHN2ZzogJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJywKICBtYXRoOiAnaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCcKfTsKdmFyIGlzSFRNTFRhZyA9IG1ha2VNYXAoJ2h0bWwsYm9keSxiYXNlLGhlYWQsbGluayxtZXRhLHN0eWxlLHRpdGxlLCcgKyAnYWRkcmVzcyxhcnRpY2xlLGFzaWRlLGZvb3RlcixoZWFkZXIsaDEsaDIsaDMsaDQsaDUsaDYsaGdyb3VwLG5hdixzZWN0aW9uLCcgKyAnZGl2LGRkLGRsLGR0LGZpZ2NhcHRpb24sZmlndXJlLHBpY3R1cmUsaHIsaW1nLGxpLG1haW4sb2wscCxwcmUsdWwsJyArICdhLGIsYWJicixiZGksYmRvLGJyLGNpdGUsY29kZSxkYXRhLGRmbixlbSxpLGtiZCxtYXJrLHEscnAscnQscnRjLHJ1YnksJyArICdzLHNhbXAsc21hbGwsc3BhbixzdHJvbmcsc3ViLHN1cCx0aW1lLHUsdmFyLHdicixhcmVhLGF1ZGlvLG1hcCx0cmFjayx2aWRlbywnICsgJ2VtYmVkLG9iamVjdCxwYXJhbSxzb3VyY2UsY2FudmFzLHNjcmlwdCxub3NjcmlwdCxkZWwsaW5zLCcgKyAnY2FwdGlvbixjb2wsY29sZ3JvdXAsdGFibGUsdGhlYWQsdGJvZHksdGQsdGgsdHIsJyArICdidXR0b24sZGF0YWxpc3QsZmllbGRzZXQsZm9ybSxpbnB1dCxsYWJlbCxsZWdlbmQsbWV0ZXIsb3B0Z3JvdXAsb3B0aW9uLCcgKyAnb3V0cHV0LHByb2dyZXNzLHNlbGVjdCx0ZXh0YXJlYSwnICsgJ2RldGFpbHMsZGlhbG9nLG1lbnUsbWVudWl0ZW0sc3VtbWFyeSwnICsgJ2NvbnRlbnQsZWxlbWVudCxzaGFkb3csdGVtcGxhdGUsYmxvY2txdW90ZSxpZnJhbWUsdGZvb3QnKTsKLy8gdGhpcyBtYXAgaXMgaW50ZW50aW9uYWxseSBzZWxlY3RpdmUsIG9ubHkgY292ZXJpbmcgU1ZHIGVsZW1lbnRzIHRoYXQgbWF5Ci8vIGNvbnRhaW4gY2hpbGQgZWxlbWVudHMuCnZhciBpc1NWRyA9IG1ha2VNYXAoJ3N2ZyxhbmltYXRlLGNpcmNsZSxjbGlwcGF0aCxjdXJzb3IsZGVmcyxkZXNjLGVsbGlwc2UsZmlsdGVyLGZvbnQtZmFjZSwnICsgJ2ZvcmVpZ25vYmplY3QsZyxnbHlwaCxpbWFnZSxsaW5lLG1hcmtlcixtYXNrLG1pc3NpbmctZ2x5cGgscGF0aCxwYXR0ZXJuLCcgKyAncG9seWdvbixwb2x5bGluZSxyZWN0LHN3aXRjaCxzeW1ib2wsdGV4dCx0ZXh0cGF0aCx0c3Bhbix1c2UsdmlldycsIHRydWUpOwp2YXIgaXNSZXNlcnZlZFRhZyA9IGZ1bmN0aW9uIGlzUmVzZXJ2ZWRUYWcodGFnKSB7CiAgcmV0dXJuIGlzSFRNTFRhZyh0YWcpIHx8IGlzU1ZHKHRhZyk7Cn07CmZ1bmN0aW9uIGdldFRhZ05hbWVzcGFjZSh0YWcpIHsKICBpZiAoaXNTVkcodGFnKSkgewogICAgcmV0dXJuICdzdmcnOwogIH0KICAvLyBiYXNpYyBzdXBwb3J0IGZvciBNYXRoTUwKICAvLyBub3RlIGl0IGRvZXNuJ3Qgc3VwcG9ydCBvdGhlciBNYXRoTUwgZWxlbWVudHMgYmVpbmcgY29tcG9uZW50IHJvb3RzCiAgaWYgKHRhZyA9PT0gJ21hdGgnKSB7CiAgICByZXR1cm4gJ21hdGgnOwogIH0KfQp2YXIgdW5rbm93bkVsZW1lbnRDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CmZ1bmN0aW9uIGlzVW5rbm93bkVsZW1lbnQodGFnKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFpbkJyb3dzZXIpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBpZiAoaXNSZXNlcnZlZFRhZyh0YWcpKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHRhZyA9IHRhZy50b0xvd2VyQ2FzZSgpOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmICh1bmtub3duRWxlbWVudENhY2hlW3RhZ10gIT0gbnVsbCkgewogICAgcmV0dXJuIHVua25vd25FbGVtZW50Q2FjaGVbdGFnXTsKICB9CiAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWcpOwogIGlmICh0YWcuaW5kZXhPZignLScpID4gLTEpIHsKICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzI4MjEwMzY0LzEwNzAyNDQKICAgIHJldHVybiB1bmtub3duRWxlbWVudENhY2hlW3RhZ10gPSBlbC5jb25zdHJ1Y3RvciA9PT0gd2luZG93LkhUTUxVbmtub3duRWxlbWVudCB8fCBlbC5jb25zdHJ1Y3RvciA9PT0gd2luZG93LkhUTUxFbGVtZW50OwogIH0gZWxzZSB7CiAgICByZXR1cm4gdW5rbm93bkVsZW1lbnRDYWNoZVt0YWddID0gL0hUTUxVbmtub3duRWxlbWVudC8udGVzdChlbC50b1N0cmluZygpKTsKICB9Cn0KdmFyIGlzVGV4dElucHV0VHlwZSA9IG1ha2VNYXAoJ3RleHQsbnVtYmVyLHBhc3N3b3JkLHNlYXJjaCxlbWFpbCx0ZWwsdXJsJyk7CgovKioKICogUXVlcnkgYW4gZWxlbWVudCBzZWxlY3RvciBpZiBpdCdzIG5vdCBhbiBlbGVtZW50IGFscmVhZHkuCiAqLwpmdW5jdGlvbiBxdWVyeShlbCkgewogIGlmICh0eXBlb2YgZWwgPT09ICdzdHJpbmcnKSB7CiAgICB2YXIgc2VsZWN0ZWQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGVsKTsKICAgIGlmICghc2VsZWN0ZWQpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdDYW5ub3QgZmluZCBlbGVtZW50OiAnICsgZWwpOwogICAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICB9CiAgICByZXR1cm4gc2VsZWN0ZWQ7CiAgfSBlbHNlIHsKICAgIHJldHVybiBlbDsKICB9Cn0KZnVuY3Rpb24gY3JlYXRlRWxlbWVudCh0YWdOYW1lLCB2bm9kZSkgewogIHZhciBlbG0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwogIGlmICh0YWdOYW1lICE9PSAnc2VsZWN0JykgewogICAgcmV0dXJuIGVsbTsKICB9CiAgLy8gZmFsc2Ugb3IgbnVsbCB3aWxsIHJlbW92ZSB0aGUgYXR0cmlidXRlIGJ1dCB1bmRlZmluZWQgd2lsbCBub3QKICBpZiAodm5vZGUuZGF0YSAmJiB2bm9kZS5kYXRhLmF0dHJzICYmIHZub2RlLmRhdGEuYXR0cnMubXVsdGlwbGUgIT09IHVuZGVmaW5lZCkgewogICAgZWxtLnNldEF0dHJpYnV0ZSgnbXVsdGlwbGUnLCAnbXVsdGlwbGUnKTsKICB9CiAgcmV0dXJuIGVsbTsKfQpmdW5jdGlvbiBjcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlLCB0YWdOYW1lKSB7CiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VNYXBbbmFtZXNwYWNlXSwgdGFnTmFtZSk7Cn0KZnVuY3Rpb24gY3JlYXRlVGV4dE5vZGUodGV4dCkgewogIHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKfQpmdW5jdGlvbiBjcmVhdGVDb21tZW50KHRleHQpIHsKICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlQ29tbWVudCh0ZXh0KTsKfQpmdW5jdGlvbiBpbnNlcnRCZWZvcmUocGFyZW50Tm9kZSwgbmV3Tm9kZSwgcmVmZXJlbmNlTm9kZSkgewogIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5ld05vZGUsIHJlZmVyZW5jZU5vZGUpOwp9CmZ1bmN0aW9uIHJlbW92ZUNoaWxkKG5vZGUsIGNoaWxkKSB7CiAgbm9kZS5yZW1vdmVDaGlsZChjaGlsZCk7Cn0KZnVuY3Rpb24gYXBwZW5kQ2hpbGQobm9kZSwgY2hpbGQpIHsKICBub2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKfQpmdW5jdGlvbiBwYXJlbnROb2RlKG5vZGUpIHsKICByZXR1cm4gbm9kZS5wYXJlbnROb2RlOwp9CmZ1bmN0aW9uIG5leHRTaWJsaW5nKG5vZGUpIHsKICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKfQpmdW5jdGlvbiB0YWdOYW1lKG5vZGUpIHsKICByZXR1cm4gbm9kZS50YWdOYW1lOwp9CmZ1bmN0aW9uIHNldFRleHRDb250ZW50KG5vZGUsIHRleHQpIHsKICBub2RlLnRleHRDb250ZW50ID0gdGV4dDsKfQpmdW5jdGlvbiBzZXRTdHlsZVNjb3BlKG5vZGUsIHNjb3BlSWQpIHsKICBub2RlLnNldEF0dHJpYnV0ZShzY29wZUlkLCAnJyk7Cn0KdmFyIG5vZGVPcHMgPSAvKiNfX1BVUkVfXyovT2JqZWN0LmZyZWV6ZSh7CiAgX19wcm90b19fOiBudWxsLAogIGNyZWF0ZUVsZW1lbnQ6IGNyZWF0ZUVsZW1lbnQsCiAgY3JlYXRlRWxlbWVudE5TOiBjcmVhdGVFbGVtZW50TlMsCiAgY3JlYXRlVGV4dE5vZGU6IGNyZWF0ZVRleHROb2RlLAogIGNyZWF0ZUNvbW1lbnQ6IGNyZWF0ZUNvbW1lbnQsCiAgaW5zZXJ0QmVmb3JlOiBpbnNlcnRCZWZvcmUsCiAgcmVtb3ZlQ2hpbGQ6IHJlbW92ZUNoaWxkLAogIGFwcGVuZENoaWxkOiBhcHBlbmRDaGlsZCwKICBwYXJlbnROb2RlOiBwYXJlbnROb2RlLAogIG5leHRTaWJsaW5nOiBuZXh0U2libGluZywKICB0YWdOYW1lOiB0YWdOYW1lLAogIHNldFRleHRDb250ZW50OiBzZXRUZXh0Q29udGVudCwKICBzZXRTdHlsZVNjb3BlOiBzZXRTdHlsZVNjb3BlCn0pOwp2YXIgcmVmID0gewogIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKF8sIHZub2RlKSB7CiAgICByZWdpc3RlclJlZih2bm9kZSk7CiAgfSwKICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShvbGRWbm9kZSwgdm5vZGUpIHsKICAgIGlmIChvbGRWbm9kZS5kYXRhLnJlZiAhPT0gdm5vZGUuZGF0YS5yZWYpIHsKICAgICAgcmVnaXN0ZXJSZWYob2xkVm5vZGUsIHRydWUpOwogICAgICByZWdpc3RlclJlZih2bm9kZSk7CiAgICB9CiAgfSwKICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KHZub2RlKSB7CiAgICByZWdpc3RlclJlZih2bm9kZSwgdHJ1ZSk7CiAgfQp9OwpmdW5jdGlvbiByZWdpc3RlclJlZih2bm9kZSwgaXNSZW1vdmFsKSB7CiAgdmFyIHJlZiA9IHZub2RlLmRhdGEucmVmOwogIGlmICghaXNEZWYocmVmKSkgcmV0dXJuOwogIHZhciB2bSA9IHZub2RlLmNvbnRleHQ7CiAgdmFyIHJlZlZhbHVlID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgfHwgdm5vZGUuZWxtOwogIHZhciB2YWx1ZSA9IGlzUmVtb3ZhbCA/IG51bGwgOiByZWZWYWx1ZTsKICB2YXIgJHJlZnNWYWx1ZSA9IGlzUmVtb3ZhbCA/IHVuZGVmaW5lZCA6IHJlZlZhbHVlOwogIGlmIChpc0Z1bmN0aW9uKHJlZikpIHsKICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKHJlZiwgdm0sIFt2YWx1ZV0sIHZtLCAidGVtcGxhdGUgcmVmIGZ1bmN0aW9uIik7CiAgICByZXR1cm47CiAgfQogIHZhciBpc0ZvciA9IHZub2RlLmRhdGEucmVmSW5Gb3I7CiAgdmFyIF9pc1N0cmluZyA9IHR5cGVvZiByZWYgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiByZWYgPT09ICdudW1iZXInOwogIHZhciBfaXNSZWYgPSBpc1JlZihyZWYpOwogIHZhciByZWZzID0gdm0uJHJlZnM7CiAgaWYgKF9pc1N0cmluZyB8fCBfaXNSZWYpIHsKICAgIGlmIChpc0ZvcikgewogICAgICB2YXIgZXhpc3RpbmcgPSBfaXNTdHJpbmcgPyByZWZzW3JlZl0gOiByZWYudmFsdWU7CiAgICAgIGlmIChpc1JlbW92YWwpIHsKICAgICAgICBpc0FycmF5KGV4aXN0aW5nKSAmJiByZW1vdmUkMihleGlzdGluZywgcmVmVmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghaXNBcnJheShleGlzdGluZykpIHsKICAgICAgICAgIGlmIChfaXNTdHJpbmcpIHsKICAgICAgICAgICAgcmVmc1tyZWZdID0gW3JlZlZhbHVlXTsKICAgICAgICAgICAgc2V0U2V0dXBSZWYodm0sIHJlZiwgcmVmc1tyZWZdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlZi52YWx1ZSA9IFtyZWZWYWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICghZXhpc3RpbmcuaW5jbHVkZXMocmVmVmFsdWUpKSB7CiAgICAgICAgICBleGlzdGluZy5wdXNoKHJlZlZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoX2lzU3RyaW5nKSB7CiAgICAgIGlmIChpc1JlbW92YWwgJiYgcmVmc1tyZWZdICE9PSByZWZWYWx1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICByZWZzW3JlZl0gPSAkcmVmc1ZhbHVlOwogICAgICBzZXRTZXR1cFJlZih2bSwgcmVmLCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKF9pc1JlZikgewogICAgICBpZiAoaXNSZW1vdmFsICYmIHJlZi52YWx1ZSAhPT0gcmVmVmFsdWUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmVmLnZhbHVlID0gdmFsdWU7CiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgd2FybigiSW52YWxpZCB0ZW1wbGF0ZSByZWYgdHlwZTogIi5jb25jYXQodHlwZW9mIHJlZikpOwogICAgfQogIH0KfQpmdW5jdGlvbiBzZXRTZXR1cFJlZihfYSwga2V5LCB2YWwpIHsKICB2YXIgX3NldHVwU3RhdGUgPSBfYS5fc2V0dXBTdGF0ZTsKICBpZiAoX3NldHVwU3RhdGUgJiYgaGFzT3duKF9zZXR1cFN0YXRlLCBrZXkpKSB7CiAgICBpZiAoaXNSZWYoX3NldHVwU3RhdGVba2V5XSkpIHsKICAgICAgX3NldHVwU3RhdGVba2V5XS52YWx1ZSA9IHZhbDsKICAgIH0gZWxzZSB7CiAgICAgIF9zZXR1cFN0YXRlW2tleV0gPSB2YWw7CiAgICB9CiAgfQp9CgovKioKICogVmlydHVhbCBET00gcGF0Y2hpbmcgYWxnb3JpdGhtIGJhc2VkIG9uIFNuYWJiZG9tIGJ5CiAqIFNpbW9uIEZyaWlzIFZpbmR1bSAoQHBhbGRlcGluZCkKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9wYWxkZXBpbmQvc25hYmJkb20vYmxvYi9tYXN0ZXIvTElDRU5TRQogKgogKiBtb2RpZmllZCBieSBFdmFuIFlvdSAoQHl5eDk5MDgwMykKICoKICogTm90IHR5cGUtY2hlY2tpbmcgdGhpcyBiZWNhdXNlIHRoaXMgZmlsZSBpcyBwZXJmLWNyaXRpY2FsIGFuZCB0aGUgY29zdAogKiBvZiBtYWtpbmcgZmxvdyB1bmRlcnN0YW5kIGl0IGlzIG5vdCB3b3J0aCBpdC4KICovCnZhciBlbXB0eU5vZGUgPSBuZXcgVk5vZGUoJycsIHt9LCBbXSk7CnZhciBob29rcyA9IFsnY3JlYXRlJywgJ2FjdGl2YXRlJywgJ3VwZGF0ZScsICdyZW1vdmUnLCAnZGVzdHJveSddOwpmdW5jdGlvbiBzYW1lVm5vZGUoYSwgYikgewogIHJldHVybiBhLmtleSA9PT0gYi5rZXkgJiYgYS5hc3luY0ZhY3RvcnkgPT09IGIuYXN5bmNGYWN0b3J5ICYmIChhLnRhZyA9PT0gYi50YWcgJiYgYS5pc0NvbW1lbnQgPT09IGIuaXNDb21tZW50ICYmIGlzRGVmKGEuZGF0YSkgPT09IGlzRGVmKGIuZGF0YSkgJiYgc2FtZUlucHV0VHlwZShhLCBiKSB8fCBpc1RydWUoYS5pc0FzeW5jUGxhY2Vob2xkZXIpICYmIGlzVW5kZWYoYi5hc3luY0ZhY3RvcnkuZXJyb3IpKTsKfQpmdW5jdGlvbiBzYW1lSW5wdXRUeXBlKGEsIGIpIHsKICBpZiAoYS50YWcgIT09ICdpbnB1dCcpIHJldHVybiB0cnVlOwogIHZhciBpOwogIHZhciB0eXBlQSA9IGlzRGVmKGkgPSBhLmRhdGEpICYmIGlzRGVmKGkgPSBpLmF0dHJzKSAmJiBpLnR5cGU7CiAgdmFyIHR5cGVCID0gaXNEZWYoaSA9IGIuZGF0YSkgJiYgaXNEZWYoaSA9IGkuYXR0cnMpICYmIGkudHlwZTsKICByZXR1cm4gdHlwZUEgPT09IHR5cGVCIHx8IGlzVGV4dElucHV0VHlwZSh0eXBlQSkgJiYgaXNUZXh0SW5wdXRUeXBlKHR5cGVCKTsKfQpmdW5jdGlvbiBjcmVhdGVLZXlUb09sZElkeChjaGlsZHJlbiwgYmVnaW5JZHgsIGVuZElkeCkgewogIHZhciBpLCBrZXk7CiAgdmFyIG1hcCA9IHt9OwogIGZvciAoaSA9IGJlZ2luSWR4OyBpIDw9IGVuZElkeDsgKytpKSB7CiAgICBrZXkgPSBjaGlsZHJlbltpXS5rZXk7CiAgICBpZiAoaXNEZWYoa2V5KSkgbWFwW2tleV0gPSBpOwogIH0KICByZXR1cm4gbWFwOwp9CmZ1bmN0aW9uIGNyZWF0ZVBhdGNoRnVuY3Rpb24oYmFja2VuZCkgewogIHZhciBpLCBqOwogIHZhciBjYnMgPSB7fTsKICB2YXIgbW9kdWxlcyA9IGJhY2tlbmQubW9kdWxlcywKICAgIG5vZGVPcHMgPSBiYWNrZW5kLm5vZGVPcHM7CiAgZm9yIChpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgKytpKSB7CiAgICBjYnNbaG9va3NbaV1dID0gW107CiAgICBmb3IgKGogPSAwOyBqIDwgbW9kdWxlcy5sZW5ndGg7ICsraikgewogICAgICBpZiAoaXNEZWYobW9kdWxlc1tqXVtob29rc1tpXV0pKSB7CiAgICAgICAgY2JzW2hvb2tzW2ldXS5wdXNoKG1vZHVsZXNbal1baG9va3NbaV1dKTsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBlbXB0eU5vZGVBdChlbG0pIHsKICAgIHJldHVybiBuZXcgVk5vZGUobm9kZU9wcy50YWdOYW1lKGVsbSkudG9Mb3dlckNhc2UoKSwge30sIFtdLCB1bmRlZmluZWQsIGVsbSk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVJtQ2IoY2hpbGRFbG0sIGxpc3RlbmVycykgewogICAgZnVuY3Rpb24gcmVtb3ZlKCkgewogICAgICBpZiAoLS1yZW1vdmUubGlzdGVuZXJzID09PSAwKSB7CiAgICAgICAgcmVtb3ZlTm9kZShjaGlsZEVsbSk7CiAgICAgIH0KICAgIH0KICAgIHJlbW92ZS5saXN0ZW5lcnMgPSBsaXN0ZW5lcnM7CiAgICByZXR1cm4gcmVtb3ZlOwogIH0KICBmdW5jdGlvbiByZW1vdmVOb2RlKGVsKSB7CiAgICB2YXIgcGFyZW50ID0gbm9kZU9wcy5wYXJlbnROb2RlKGVsKTsKICAgIC8vIGVsZW1lbnQgbWF5IGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQgZHVlIHRvIHYtaHRtbCAvIHYtdGV4dAogICAgaWYgKGlzRGVmKHBhcmVudCkpIHsKICAgICAgbm9kZU9wcy5yZW1vdmVDaGlsZChwYXJlbnQsIGVsKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gaXNVbmtub3duRWxlbWVudCh2bm9kZSwgaW5WUHJlKSB7CiAgICByZXR1cm4gIWluVlByZSAmJiAhdm5vZGUubnMgJiYgIShjb25maWcuaWdub3JlZEVsZW1lbnRzLmxlbmd0aCAmJiBjb25maWcuaWdub3JlZEVsZW1lbnRzLnNvbWUoZnVuY3Rpb24gKGlnbm9yZSkgewogICAgICByZXR1cm4gaXNSZWdFeHAoaWdub3JlKSA/IGlnbm9yZS50ZXN0KHZub2RlLnRhZykgOiBpZ25vcmUgPT09IHZub2RlLnRhZzsKICAgIH0pKSAmJiBjb25maWcuaXNVbmtub3duRWxlbWVudCh2bm9kZS50YWcpOwogIH0KICB2YXIgY3JlYXRpbmdFbG1JblZQcmUgPSAwOwogIGZ1bmN0aW9uIGNyZWF0ZUVsbSh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSwgbmVzdGVkLCBvd25lckFycmF5LCBpbmRleCkgewogICAgaWYgKGlzRGVmKHZub2RlLmVsbSkgJiYgaXNEZWYob3duZXJBcnJheSkpIHsKICAgICAgLy8gVGhpcyB2bm9kZSB3YXMgdXNlZCBpbiBhIHByZXZpb3VzIHJlbmRlciEKICAgICAgLy8gbm93IGl0J3MgdXNlZCBhcyBhIG5ldyBub2RlLCBvdmVyd3JpdGluZyBpdHMgZWxtIHdvdWxkIGNhdXNlCiAgICAgIC8vIHBvdGVudGlhbCBwYXRjaCBlcnJvcnMgZG93biB0aGUgcm9hZCB3aGVuIGl0J3MgdXNlZCBhcyBhbiBpbnNlcnRpb24KICAgICAgLy8gcmVmZXJlbmNlIG5vZGUuIEluc3RlYWQsIHdlIGNsb25lIHRoZSBub2RlIG9uLWRlbWFuZCBiZWZvcmUgY3JlYXRpbmcKICAgICAgLy8gYXNzb2NpYXRlZCBET00gZWxlbWVudCBmb3IgaXQuCiAgICAgIHZub2RlID0gb3duZXJBcnJheVtpbmRleF0gPSBjbG9uZVZOb2RlKHZub2RlKTsKICAgIH0KICAgIHZub2RlLmlzUm9vdEluc2VydCA9ICFuZXN0ZWQ7IC8vIGZvciB0cmFuc2l0aW9uIGVudGVyIGNoZWNrCiAgICBpZiAoY3JlYXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICB2YXIgY2hpbGRyZW4gPSB2bm9kZS5jaGlsZHJlbjsKICAgIHZhciB0YWcgPSB2bm9kZS50YWc7CiAgICBpZiAoaXNEZWYodGFnKSkgewogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGlmIChkYXRhICYmIGRhdGEucHJlKSB7CiAgICAgICAgICBjcmVhdGluZ0VsbUluVlByZSsrOwogICAgICAgIH0KICAgICAgICBpZiAoaXNVbmtub3duRWxlbWVudCh2bm9kZSwgY3JlYXRpbmdFbG1JblZQcmUpKSB7CiAgICAgICAgICB3YXJuKCdVbmtub3duIGN1c3RvbSBlbGVtZW50OiA8JyArIHRhZyArICc+IC0gZGlkIHlvdSAnICsgJ3JlZ2lzdGVyIHRoZSBjb21wb25lbnQgY29ycmVjdGx5PyBGb3IgcmVjdXJzaXZlIGNvbXBvbmVudHMsICcgKyAnbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhlICJuYW1lIiBvcHRpb24uJywgdm5vZGUuY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZub2RlLmVsbSA9IHZub2RlLm5zID8gbm9kZU9wcy5jcmVhdGVFbGVtZW50TlModm5vZGUubnMsIHRhZykgOiBub2RlT3BzLmNyZWF0ZUVsZW1lbnQodGFnLCB2bm9kZSk7CiAgICAgIHNldFNjb3BlKHZub2RlKTsKICAgICAgY3JlYXRlQ2hpbGRyZW4odm5vZGUsIGNoaWxkcmVuLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgICBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgfQogICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGRhdGEgJiYgZGF0YS5wcmUpIHsKICAgICAgICBjcmVhdGluZ0VsbUluVlByZS0tOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzVHJ1ZSh2bm9kZS5pc0NvbW1lbnQpKSB7CiAgICAgIHZub2RlLmVsbSA9IG5vZGVPcHMuY3JlYXRlQ29tbWVudCh2bm9kZS50ZXh0KTsKICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogICAgfSBlbHNlIHsKICAgICAgdm5vZGUuZWxtID0gbm9kZU9wcy5jcmVhdGVUZXh0Tm9kZSh2bm9kZS50ZXh0KTsKICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogICAgfQogIH0KICBmdW5jdGlvbiBjcmVhdGVDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pIHsKICAgIHZhciBpID0gdm5vZGUuZGF0YTsKICAgIGlmIChpc0RlZihpKSkgewogICAgICB2YXIgaXNSZWFjdGl2YXRlZCA9IGlzRGVmKHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSAmJiBpLmtlZXBBbGl2ZTsKICAgICAgaWYgKGlzRGVmKGkgPSBpLmhvb2spICYmIGlzRGVmKGkgPSBpLmluaXQpKSB7CiAgICAgICAgaSh2bm9kZSwgZmFsc2UgLyogaHlkcmF0aW5nICovKTsKICAgICAgfQogICAgICAvLyBhZnRlciBjYWxsaW5nIHRoZSBpbml0IGhvb2ssIGlmIHRoZSB2bm9kZSBpcyBhIGNoaWxkIGNvbXBvbmVudAogICAgICAvLyBpdCBzaG91bGQndmUgY3JlYXRlZCBhIGNoaWxkIGluc3RhbmNlIGFuZCBtb3VudGVkIGl0LiB0aGUgY2hpbGQKICAgICAgLy8gY29tcG9uZW50IGFsc28gaGFzIHNldCB0aGUgcGxhY2Vob2xkZXIgdm5vZGUncyBlbG0uCiAgICAgIC8vIGluIHRoYXQgY2FzZSB3ZSBjYW4ganVzdCByZXR1cm4gdGhlIGVsZW1lbnQgYW5kIGJlIGRvbmUuCiAgICAgIGlmIChpc0RlZih2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkpIHsKICAgICAgICBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgICAgICBpZiAoaXNUcnVlKGlzUmVhY3RpdmF0ZWQpKSB7CiAgICAgICAgICByZWFjdGl2YXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gaW5pdENvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBpZiAoaXNEZWYodm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0KSkgewogICAgICBpbnNlcnRlZFZub2RlUXVldWUucHVzaC5hcHBseShpbnNlcnRlZFZub2RlUXVldWUsIHZub2RlLmRhdGEucGVuZGluZ0luc2VydCk7CiAgICAgIHZub2RlLmRhdGEucGVuZGluZ0luc2VydCA9IG51bGw7CiAgICB9CiAgICB2bm9kZS5lbG0gPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZS4kZWw7CiAgICBpZiAoaXNQYXRjaGFibGUodm5vZGUpKSB7CiAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICBzZXRTY29wZSh2bm9kZSk7CiAgICB9IGVsc2UgewogICAgICAvLyBlbXB0eSBjb21wb25lbnQgcm9vdC4KICAgICAgLy8gc2tpcCBhbGwgZWxlbWVudC1yZWxhdGVkIG1vZHVsZXMgZXhjZXB0IGZvciByZWYgKCMzNDU1KQogICAgICByZWdpc3RlclJlZih2bm9kZSk7CiAgICAgIC8vIG1ha2Ugc3VyZSB0byBpbnZva2UgdGhlIGluc2VydCBob29rCiAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoKHZub2RlKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcmVhY3RpdmF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSkgewogICAgdmFyIGk7CiAgICAvLyBoYWNrIGZvciAjNDMzOTogYSByZWFjdGl2YXRlZCBjb21wb25lbnQgd2l0aCBpbm5lciB0cmFuc2l0aW9uCiAgICAvLyBkb2VzIG5vdCB0cmlnZ2VyIGJlY2F1c2UgdGhlIGlubmVyIG5vZGUncyBjcmVhdGVkIGhvb2tzIGFyZSBub3QgY2FsbGVkCiAgICAvLyBhZ2Fpbi4gSXQncyBub3QgaWRlYWwgdG8gaW52b2x2ZSBtb2R1bGUtc3BlY2lmaWMgbG9naWMgaW4gaGVyZSBidXQKICAgIC8vIHRoZXJlIGRvZXNuJ3Qgc2VlbSB0byBiZSBhIGJldHRlciB3YXkgdG8gZG8gaXQuCiAgICB2YXIgaW5uZXJOb2RlID0gdm5vZGU7CiAgICB3aGlsZSAoaW5uZXJOb2RlLmNvbXBvbmVudEluc3RhbmNlKSB7CiAgICAgIGlubmVyTm9kZSA9IGlubmVyTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CiAgICAgIGlmIChpc0RlZihpID0gaW5uZXJOb2RlLmRhdGEpICYmIGlzRGVmKGkgPSBpLnRyYW5zaXRpb24pKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5hY3RpdmF0ZS5sZW5ndGg7ICsraSkgewogICAgICAgICAgY2JzLmFjdGl2YXRlW2ldKGVtcHR5Tm9kZSwgaW5uZXJOb2RlKTsKICAgICAgICB9CiAgICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2goaW5uZXJOb2RlKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgLy8gdW5saWtlIGEgbmV3bHkgY3JlYXRlZCBjb21wb25lbnQsCiAgICAvLyBhIHJlYWN0aXZhdGVkIGtlZXAtYWxpdmUgY29tcG9uZW50IGRvZXNuJ3QgaW5zZXJ0IGl0c2VsZgogICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogIH0KICBmdW5jdGlvbiBpbnNlcnQocGFyZW50LCBlbG0sIHJlZikgewogICAgaWYgKGlzRGVmKHBhcmVudCkpIHsKICAgICAgaWYgKGlzRGVmKHJlZikpIHsKICAgICAgICBpZiAobm9kZU9wcy5wYXJlbnROb2RlKHJlZikgPT09IHBhcmVudCkgewogICAgICAgICAgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50LCBlbG0sIHJlZik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG5vZGVPcHMuYXBwZW5kQ2hpbGQocGFyZW50LCBlbG0pOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbiwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBjaGVja0R1cGxpY2F0ZUtleXMoY2hpbGRyZW4pOwogICAgICB9CiAgICAgIGZvciAodmFyIGlfMSA9IDA7IGlfMSA8IGNoaWxkcmVuLmxlbmd0aDsgKytpXzEpIHsKICAgICAgICBjcmVhdGVFbG0oY2hpbGRyZW5baV8xXSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCB2bm9kZS5lbG0sIG51bGwsIHRydWUsIGNoaWxkcmVuLCBpXzEpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzUHJpbWl0aXZlKHZub2RlLnRleHQpKSB7CiAgICAgIG5vZGVPcHMuYXBwZW5kQ2hpbGQodm5vZGUuZWxtLCBub2RlT3BzLmNyZWF0ZVRleHROb2RlKFN0cmluZyh2bm9kZS50ZXh0KSkpOwogICAgfQogIH0KICBmdW5jdGlvbiBpc1BhdGNoYWJsZSh2bm9kZSkgewogICAgd2hpbGUgKHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSB7CiAgICAgIHZub2RlID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlOwogICAgfQogICAgcmV0dXJuIGlzRGVmKHZub2RlLnRhZyk7CiAgfQogIGZ1bmN0aW9uIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgIGZvciAodmFyIGlfMiA9IDA7IGlfMiA8IGNicy5jcmVhdGUubGVuZ3RoOyArK2lfMikgewogICAgICBjYnMuY3JlYXRlW2lfMl0oZW1wdHlOb2RlLCB2bm9kZSk7CiAgICB9CiAgICBpID0gdm5vZGUuZGF0YS5ob29rOyAvLyBSZXVzZSB2YXJpYWJsZQogICAgaWYgKGlzRGVmKGkpKSB7CiAgICAgIGlmIChpc0RlZihpLmNyZWF0ZSkpIGkuY3JlYXRlKGVtcHR5Tm9kZSwgdm5vZGUpOwogICAgICBpZiAoaXNEZWYoaS5pbnNlcnQpKSBpbnNlcnRlZFZub2RlUXVldWUucHVzaCh2bm9kZSk7CiAgICB9CiAgfQogIC8vIHNldCBzY29wZSBpZCBhdHRyaWJ1dGUgZm9yIHNjb3BlZCBDU1MuCiAgLy8gdGhpcyBpcyBpbXBsZW1lbnRlZCBhcyBhIHNwZWNpYWwgY2FzZSB0byBhdm9pZCB0aGUgb3ZlcmhlYWQKICAvLyBvZiBnb2luZyB0aHJvdWdoIHRoZSBub3JtYWwgYXR0cmlidXRlIHBhdGNoaW5nIHByb2Nlc3MuCiAgZnVuY3Rpb24gc2V0U2NvcGUodm5vZGUpIHsKICAgIHZhciBpOwogICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5mblNjb3BlSWQpKSB7CiAgICAgIG5vZGVPcHMuc2V0U3R5bGVTY29wZSh2bm9kZS5lbG0sIGkpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGFuY2VzdG9yID0gdm5vZGU7CiAgICAgIHdoaWxlIChhbmNlc3RvcikgewogICAgICAgIGlmIChpc0RlZihpID0gYW5jZXN0b3IuY29udGV4dCkgJiYgaXNEZWYoaSA9IGkuJG9wdGlvbnMuX3Njb3BlSWQpKSB7CiAgICAgICAgICBub2RlT3BzLnNldFN0eWxlU2NvcGUodm5vZGUuZWxtLCBpKTsKICAgICAgICB9CiAgICAgICAgYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnQ7CiAgICAgIH0KICAgIH0KICAgIC8vIGZvciBzbG90IGNvbnRlbnQgdGhleSBzaG91bGQgYWxzbyBnZXQgdGhlIHNjb3BlSWQgZnJvbSB0aGUgaG9zdCBpbnN0YW5jZS4KICAgIGlmIChpc0RlZihpID0gYWN0aXZlSW5zdGFuY2UpICYmIGkgIT09IHZub2RlLmNvbnRleHQgJiYgaSAhPT0gdm5vZGUuZm5Db250ZXh0ICYmIGlzRGVmKGkgPSBpLiRvcHRpb25zLl9zY29wZUlkKSkgewogICAgICBub2RlT3BzLnNldFN0eWxlU2NvcGUodm5vZGUuZWxtLCBpKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWRkVm5vZGVzKHBhcmVudEVsbSwgcmVmRWxtLCB2bm9kZXMsIHN0YXJ0SWR4LCBlbmRJZHgsIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgZm9yICg7IHN0YXJ0SWR4IDw9IGVuZElkeDsgKytzdGFydElkeCkgewogICAgICBjcmVhdGVFbG0odm5vZGVzW3N0YXJ0SWR4XSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSwgZmFsc2UsIHZub2Rlcywgc3RhcnRJZHgpOwogICAgfQogIH0KICBmdW5jdGlvbiBpbnZva2VEZXN0cm95SG9vayh2bm9kZSkgewogICAgdmFyIGksIGo7CiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLmRlc3Ryb3kpKSBpKHZub2RlKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5kZXN0cm95Lmxlbmd0aDsgKytpKSBjYnMuZGVzdHJveVtpXSh2bm9kZSk7CiAgICB9CiAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNoaWxkcmVuKSkgewogICAgICBmb3IgKGogPSAwOyBqIDwgdm5vZGUuY2hpbGRyZW4ubGVuZ3RoOyArK2opIHsKICAgICAgICBpbnZva2VEZXN0cm95SG9vayh2bm9kZS5jaGlsZHJlbltqXSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gcmVtb3ZlVm5vZGVzKHZub2Rlcywgc3RhcnRJZHgsIGVuZElkeCkgewogICAgZm9yICg7IHN0YXJ0SWR4IDw9IGVuZElkeDsgKytzdGFydElkeCkgewogICAgICB2YXIgY2ggPSB2bm9kZXNbc3RhcnRJZHhdOwogICAgICBpZiAoaXNEZWYoY2gpKSB7CiAgICAgICAgaWYgKGlzRGVmKGNoLnRhZykpIHsKICAgICAgICAgIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2soY2gpOwogICAgICAgICAgaW52b2tlRGVzdHJveUhvb2soY2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBUZXh0IG5vZGUKICAgICAgICAgIHJlbW92ZU5vZGUoY2guZWxtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gcmVtb3ZlQW5kSW52b2tlUmVtb3ZlSG9vayh2bm9kZSwgcm0pIHsKICAgIGlmIChpc0RlZihybSkgfHwgaXNEZWYodm5vZGUuZGF0YSkpIHsKICAgICAgdmFyIGlfMzsKICAgICAgdmFyIGxpc3RlbmVycyA9IGNicy5yZW1vdmUubGVuZ3RoICsgMTsKICAgICAgaWYgKGlzRGVmKHJtKSkgewogICAgICAgIC8vIHdlIGhhdmUgYSByZWN1cnNpdmVseSBwYXNzZWQgZG93biBybSBjYWxsYmFjawogICAgICAgIC8vIGluY3JlYXNlIHRoZSBsaXN0ZW5lcnMgY291bnQKICAgICAgICBybS5saXN0ZW5lcnMgKz0gbGlzdGVuZXJzOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGRpcmVjdGx5IHJlbW92aW5nCiAgICAgICAgcm0gPSBjcmVhdGVSbUNiKHZub2RlLmVsbSwgbGlzdGVuZXJzKTsKICAgICAgfQogICAgICAvLyByZWN1cnNpdmVseSBpbnZva2UgaG9va3Mgb24gY2hpbGQgY29tcG9uZW50IHJvb3Qgbm9kZQogICAgICBpZiAoaXNEZWYoaV8zID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UpICYmIGlzRGVmKGlfMyA9IGlfMy5fdm5vZGUpICYmIGlzRGVmKGlfMy5kYXRhKSkgewogICAgICAgIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2soaV8zLCBybSk7CiAgICAgIH0KICAgICAgZm9yIChpXzMgPSAwOyBpXzMgPCBjYnMucmVtb3ZlLmxlbmd0aDsgKytpXzMpIHsKICAgICAgICBjYnMucmVtb3ZlW2lfM10odm5vZGUsIHJtKTsKICAgICAgfQogICAgICBpZiAoaXNEZWYoaV8zID0gdm5vZGUuZGF0YS5ob29rKSAmJiBpc0RlZihpXzMgPSBpXzMucmVtb3ZlKSkgewogICAgICAgIGlfMyh2bm9kZSwgcm0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJtKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlbW92ZU5vZGUodm5vZGUuZWxtKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdXBkYXRlQ2hpbGRyZW4ocGFyZW50RWxtLCBvbGRDaCwgbmV3Q2gsIGluc2VydGVkVm5vZGVRdWV1ZSwgcmVtb3ZlT25seSkgewogICAgdmFyIG9sZFN0YXJ0SWR4ID0gMDsKICAgIHZhciBuZXdTdGFydElkeCA9IDA7CiAgICB2YXIgb2xkRW5kSWR4ID0gb2xkQ2gubGVuZ3RoIC0gMTsKICAgIHZhciBvbGRTdGFydFZub2RlID0gb2xkQ2hbMF07CiAgICB2YXIgb2xkRW5kVm5vZGUgPSBvbGRDaFtvbGRFbmRJZHhdOwogICAgdmFyIG5ld0VuZElkeCA9IG5ld0NoLmxlbmd0aCAtIDE7CiAgICB2YXIgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWzBdOwogICAgdmFyIG5ld0VuZFZub2RlID0gbmV3Q2hbbmV3RW5kSWR4XTsKICAgIHZhciBvbGRLZXlUb0lkeCwgaWR4SW5PbGQsIHZub2RlVG9Nb3ZlLCByZWZFbG07CiAgICAvLyByZW1vdmVPbmx5IGlzIGEgc3BlY2lhbCBmbGFnIHVzZWQgb25seSBieSA8dHJhbnNpdGlvbi1ncm91cD4KICAgIC8vIHRvIGVuc3VyZSByZW1vdmVkIGVsZW1lbnRzIHN0YXkgaW4gY29ycmVjdCByZWxhdGl2ZSBwb3NpdGlvbnMKICAgIC8vIGR1cmluZyBsZWF2aW5nIHRyYW5zaXRpb25zCiAgICB2YXIgY2FuTW92ZSA9ICFyZW1vdmVPbmx5OwogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgY2hlY2tEdXBsaWNhdGVLZXlzKG5ld0NoKTsKICAgIH0KICAgIHdoaWxlIChvbGRTdGFydElkeCA8PSBvbGRFbmRJZHggJiYgbmV3U3RhcnRJZHggPD0gbmV3RW5kSWR4KSB7CiAgICAgIGlmIChpc1VuZGVmKG9sZFN0YXJ0Vm5vZGUpKSB7CiAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOyAvLyBWbm9kZSBoYXMgYmVlbiBtb3ZlZCBsZWZ0CiAgICAgIH0gZWxzZSBpZiAoaXNVbmRlZihvbGRFbmRWbm9kZSkpIHsKICAgICAgICBvbGRFbmRWbm9kZSA9IG9sZENoWy0tb2xkRW5kSWR4XTsKICAgICAgfSBlbHNlIGlmIChzYW1lVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICBwYXRjaFZub2RlKG9sZFN0YXJ0Vm5vZGUsIG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld1N0YXJ0SWR4KTsKICAgICAgICBvbGRTdGFydFZub2RlID0gb2xkQ2hbKytvbGRTdGFydElkeF07CiAgICAgICAgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWysrbmV3U3RhcnRJZHhdOwogICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRFbmRWbm9kZSwgbmV3RW5kVm5vZGUpKSB7CiAgICAgICAgcGF0Y2hWbm9kZShvbGRFbmRWbm9kZSwgbmV3RW5kVm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld0VuZElkeCk7CiAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgbmV3RW5kVm5vZGUgPSBuZXdDaFstLW5ld0VuZElkeF07CiAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZFN0YXJ0Vm5vZGUsIG5ld0VuZFZub2RlKSkgewogICAgICAgIC8vIFZub2RlIG1vdmVkIHJpZ2h0CiAgICAgICAgcGF0Y2hWbm9kZShvbGRTdGFydFZub2RlLCBuZXdFbmRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3RW5kSWR4KTsKICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIG5vZGVPcHMubmV4dFNpYmxpbmcob2xkRW5kVm5vZGUuZWxtKSk7CiAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOwogICAgICAgIG5ld0VuZFZub2RlID0gbmV3Q2hbLS1uZXdFbmRJZHhdOwogICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICAvLyBWbm9kZSBtb3ZlZCBsZWZ0CiAgICAgICAgcGF0Y2hWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgIGNhbk1vdmUgJiYgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50RWxtLCBvbGRFbmRWbm9kZS5lbG0sIG9sZFN0YXJ0Vm5vZGUuZWxtKTsKICAgICAgICBvbGRFbmRWbm9kZSA9IG9sZENoWy0tb2xkRW5kSWR4XTsKICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzVW5kZWYob2xkS2V5VG9JZHgpKSBvbGRLZXlUb0lkeCA9IGNyZWF0ZUtleVRvT2xkSWR4KG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKICAgICAgICBpZHhJbk9sZCA9IGlzRGVmKG5ld1N0YXJ0Vm5vZGUua2V5KSA/IG9sZEtleVRvSWR4W25ld1N0YXJ0Vm5vZGUua2V5XSA6IGZpbmRJZHhJbk9sZChuZXdTdGFydFZub2RlLCBvbGRDaCwgb2xkU3RhcnRJZHgsIG9sZEVuZElkeCk7CiAgICAgICAgaWYgKGlzVW5kZWYoaWR4SW5PbGQpKSB7CiAgICAgICAgICAvLyBOZXcgZWxlbWVudAogICAgICAgICAgY3JlYXRlRWxtKG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCBvbGRTdGFydFZub2RlLmVsbSwgZmFsc2UsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZub2RlVG9Nb3ZlID0gb2xkQ2hbaWR4SW5PbGRdOwogICAgICAgICAgaWYgKHNhbWVWbm9kZSh2bm9kZVRvTW92ZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICAgICAgcGF0Y2hWbm9kZSh2bm9kZVRvTW92ZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgICBvbGRDaFtpZHhJbk9sZF0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGNhbk1vdmUgJiYgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50RWxtLCB2bm9kZVRvTW92ZS5lbG0sIG9sZFN0YXJ0Vm5vZGUuZWxtKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHNhbWUga2V5IGJ1dCBkaWZmZXJlbnQgZWxlbWVudC4gdHJlYXQgYXMgbmV3IGVsZW1lbnQKICAgICAgICAgICAgY3JlYXRlRWxtKG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCBvbGRTdGFydFZub2RlLmVsbSwgZmFsc2UsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG5ld1N0YXJ0Vm5vZGUgPSBuZXdDaFsrK25ld1N0YXJ0SWR4XTsKICAgICAgfQogICAgfQogICAgaWYgKG9sZFN0YXJ0SWR4ID4gb2xkRW5kSWR4KSB7CiAgICAgIHJlZkVsbSA9IGlzVW5kZWYobmV3Q2hbbmV3RW5kSWR4ICsgMV0pID8gbnVsbCA6IG5ld0NoW25ld0VuZElkeCArIDFdLmVsbTsKICAgICAgYWRkVm5vZGVzKHBhcmVudEVsbSwgcmVmRWxtLCBuZXdDaCwgbmV3U3RhcnRJZHgsIG5ld0VuZElkeCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgIH0gZWxzZSBpZiAobmV3U3RhcnRJZHggPiBuZXdFbmRJZHgpIHsKICAgICAgcmVtb3ZlVm5vZGVzKG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gY2hlY2tEdXBsaWNhdGVLZXlzKGNoaWxkcmVuKSB7CiAgICB2YXIgc2VlbktleXMgPSB7fTsKICAgIGZvciAodmFyIGlfNCA9IDA7IGlfNCA8IGNoaWxkcmVuLmxlbmd0aDsgaV80KyspIHsKICAgICAgdmFyIHZub2RlID0gY2hpbGRyZW5baV80XTsKICAgICAgdmFyIGtleSA9IHZub2RlLmtleTsKICAgICAgaWYgKGlzRGVmKGtleSkpIHsKICAgICAgICBpZiAoc2VlbktleXNba2V5XSkgewogICAgICAgICAgd2FybigiRHVwbGljYXRlIGtleXMgZGV0ZWN0ZWQ6ICciLmNvbmNhdChrZXksICInLiBUaGlzIG1heSBjYXVzZSBhbiB1cGRhdGUgZXJyb3IuIiksIHZub2RlLmNvbnRleHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWVuS2V5c1trZXldID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZmluZElkeEluT2xkKG5vZGUsIG9sZENoLCBzdGFydCwgZW5kKSB7CiAgICBmb3IgKHZhciBpXzUgPSBzdGFydDsgaV81IDwgZW5kOyBpXzUrKykgewogICAgICB2YXIgYyA9IG9sZENoW2lfNV07CiAgICAgIGlmIChpc0RlZihjKSAmJiBzYW1lVm5vZGUobm9kZSwgYykpIHJldHVybiBpXzU7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHBhdGNoVm5vZGUob2xkVm5vZGUsIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG93bmVyQXJyYXksIGluZGV4LCByZW1vdmVPbmx5KSB7CiAgICBpZiAob2xkVm5vZGUgPT09IHZub2RlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpc0RlZih2bm9kZS5lbG0pICYmIGlzRGVmKG93bmVyQXJyYXkpKSB7CiAgICAgIC8vIGNsb25lIHJldXNlZCB2bm9kZQogICAgICB2bm9kZSA9IG93bmVyQXJyYXlbaW5kZXhdID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICB9CiAgICB2YXIgZWxtID0gdm5vZGUuZWxtID0gb2xkVm5vZGUuZWxtOwogICAgaWYgKGlzVHJ1ZShvbGRWbm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIpKSB7CiAgICAgIGlmIChpc0RlZih2bm9kZS5hc3luY0ZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICAgICAgaHlkcmF0ZShvbGRWbm9kZS5lbG0sIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHZub2RlLmlzQXN5bmNQbGFjZWhvbGRlciA9IHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gcmV1c2UgZWxlbWVudCBmb3Igc3RhdGljIHRyZWVzLgogICAgLy8gbm90ZSB3ZSBvbmx5IGRvIHRoaXMgaWYgdGhlIHZub2RlIGlzIGNsb25lZCAtCiAgICAvLyBpZiB0aGUgbmV3IG5vZGUgaXMgbm90IGNsb25lZCBpdCBtZWFucyB0aGUgcmVuZGVyIGZ1bmN0aW9ucyBoYXZlIGJlZW4KICAgIC8vIHJlc2V0IGJ5IHRoZSBob3QtcmVsb2FkLWFwaSBhbmQgd2UgbmVlZCB0byBkbyBhIHByb3BlciByZS1yZW5kZXIuCiAgICBpZiAoaXNUcnVlKHZub2RlLmlzU3RhdGljKSAmJiBpc1RydWUob2xkVm5vZGUuaXNTdGF0aWMpICYmIHZub2RlLmtleSA9PT0gb2xkVm5vZGUua2V5ICYmIChpc1RydWUodm5vZGUuaXNDbG9uZWQpIHx8IGlzVHJ1ZSh2bm9kZS5pc09uY2UpKSkgewogICAgICB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSA9IG9sZFZub2RlLmNvbXBvbmVudEluc3RhbmNlOwogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgaTsKICAgIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICAgIGlmIChpc0RlZihkYXRhKSAmJiBpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5wcmVwYXRjaCkpIHsKICAgICAgaShvbGRWbm9kZSwgdm5vZGUpOwogICAgfQogICAgdmFyIG9sZENoID0gb2xkVm5vZGUuY2hpbGRyZW47CiAgICB2YXIgY2ggPSB2bm9kZS5jaGlsZHJlbjsKICAgIGlmIChpc0RlZihkYXRhKSAmJiBpc1BhdGNoYWJsZSh2bm9kZSkpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGNicy51cGRhdGUubGVuZ3RoOyArK2kpIGNicy51cGRhdGVbaV0ob2xkVm5vZGUsIHZub2RlKTsKICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLnVwZGF0ZSkpIGkob2xkVm5vZGUsIHZub2RlKTsKICAgIH0KICAgIGlmIChpc1VuZGVmKHZub2RlLnRleHQpKSB7CiAgICAgIGlmIChpc0RlZihvbGRDaCkgJiYgaXNEZWYoY2gpKSB7CiAgICAgICAgaWYgKG9sZENoICE9PSBjaCkgdXBkYXRlQ2hpbGRyZW4oZWxtLCBvbGRDaCwgY2gsIGluc2VydGVkVm5vZGVRdWV1ZSwgcmVtb3ZlT25seSk7CiAgICAgIH0gZWxzZSBpZiAoaXNEZWYoY2gpKSB7CiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIGNoZWNrRHVwbGljYXRlS2V5cyhjaCk7CiAgICAgICAgfQogICAgICAgIGlmIChpc0RlZihvbGRWbm9kZS50ZXh0KSkgbm9kZU9wcy5zZXRUZXh0Q29udGVudChlbG0sICcnKTsKICAgICAgICBhZGRWbm9kZXMoZWxtLCBudWxsLCBjaCwgMCwgY2gubGVuZ3RoIC0gMSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgfSBlbHNlIGlmIChpc0RlZihvbGRDaCkpIHsKICAgICAgICByZW1vdmVWbm9kZXMob2xkQ2gsIDAsIG9sZENoLmxlbmd0aCAtIDEpOwogICAgICB9IGVsc2UgaWYgKGlzRGVmKG9sZFZub2RlLnRleHQpKSB7CiAgICAgICAgbm9kZU9wcy5zZXRUZXh0Q29udGVudChlbG0sICcnKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChvbGRWbm9kZS50ZXh0ICE9PSB2bm9kZS50ZXh0KSB7CiAgICAgIG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCB2bm9kZS50ZXh0KTsKICAgIH0KICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkucG9zdHBhdGNoKSkgaShvbGRWbm9kZSwgdm5vZGUpOwogICAgfQogIH0KICBmdW5jdGlvbiBpbnZva2VJbnNlcnRIb29rKHZub2RlLCBxdWV1ZSwgaW5pdGlhbCkgewogICAgLy8gZGVsYXkgaW5zZXJ0IGhvb2tzIGZvciBjb21wb25lbnQgcm9vdCBub2RlcywgaW52b2tlIHRoZW0gYWZ0ZXIgdGhlCiAgICAvLyBlbGVtZW50IGlzIHJlYWxseSBpbnNlcnRlZAogICAgaWYgKGlzVHJ1ZShpbml0aWFsKSAmJiBpc0RlZih2bm9kZS5wYXJlbnQpKSB7CiAgICAgIHZub2RlLnBhcmVudC5kYXRhLnBlbmRpbmdJbnNlcnQgPSBxdWV1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAodmFyIGlfNiA9IDA7IGlfNiA8IHF1ZXVlLmxlbmd0aDsgKytpXzYpIHsKICAgICAgICBxdWV1ZVtpXzZdLmRhdGEuaG9vay5pbnNlcnQocXVldWVbaV82XSk7CiAgICAgIH0KICAgIH0KICB9CiAgdmFyIGh5ZHJhdGlvbkJhaWxlZCA9IGZhbHNlOwogIC8vIGxpc3Qgb2YgbW9kdWxlcyB0aGF0IGNhbiBza2lwIGNyZWF0ZSBob29rIGR1cmluZyBoeWRyYXRpb24gYmVjYXVzZSB0aGV5CiAgLy8gYXJlIGFscmVhZHkgcmVuZGVyZWQgb24gdGhlIGNsaWVudCBvciBoYXMgbm8gbmVlZCBmb3IgaW5pdGlhbGl6YXRpb24KICAvLyBOb3RlOiBzdHlsZSBpcyBleGNsdWRlZCBiZWNhdXNlIGl0IHJlbGllcyBvbiBpbml0aWFsIGNsb25lIGZvciBmdXR1cmUKICAvLyBkZWVwIHVwZGF0ZXMgKCM3MDYzKS4KICB2YXIgaXNSZW5kZXJlZE1vZHVsZSA9IG1ha2VNYXAoJ2F0dHJzLGNsYXNzLHN0YXRpY0NsYXNzLHN0YXRpY1N0eWxlLGtleScpOwogIC8vIE5vdGU6IHRoaXMgaXMgYSBicm93c2VyLW9ubHkgZnVuY3Rpb24gc28gd2UgY2FuIGFzc3VtZSBlbG1zIGFyZSBET00gbm9kZXMuCiAgZnVuY3Rpb24gaHlkcmF0ZShlbG0sIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIGluVlByZSkgewogICAgdmFyIGk7CiAgICB2YXIgdGFnID0gdm5vZGUudGFnLAogICAgICBkYXRhID0gdm5vZGUuZGF0YSwKICAgICAgY2hpbGRyZW4gPSB2bm9kZS5jaGlsZHJlbjsKICAgIGluVlByZSA9IGluVlByZSB8fCBkYXRhICYmIGRhdGEucHJlOwogICAgdm5vZGUuZWxtID0gZWxtOwogICAgaWYgKGlzVHJ1ZSh2bm9kZS5pc0NvbW1lbnQpICYmIGlzRGVmKHZub2RlLmFzeW5jRmFjdG9yeSkpIHsKICAgICAgdm5vZGUuaXNBc3luY1BsYWNlaG9sZGVyID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBhc3NlcnQgbm9kZSBtYXRjaAogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKCFhc3NlcnROb2RlTWF0Y2goZWxtLCB2bm9kZSwgaW5WUHJlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5pbml0KSkgaSh2bm9kZSwgdHJ1ZSAvKiBoeWRyYXRpbmcgKi8pOwogICAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSkgewogICAgICAgIC8vIGNoaWxkIGNvbXBvbmVudC4gaXQgc2hvdWxkIGhhdmUgaHlkcmF0ZWQgaXRzIG93biB0cmVlLgogICAgICAgIGluaXRDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAgIGlmIChpc0RlZih0YWcpKSB7CiAgICAgIGlmIChpc0RlZihjaGlsZHJlbikpIHsKICAgICAgICAvLyBlbXB0eSBlbGVtZW50LCBhbGxvdyBjbGllbnQgdG8gcGljayB1cCBhbmQgcG9wdWxhdGUgY2hpbGRyZW4KICAgICAgICBpZiAoIWVsbS5oYXNDaGlsZE5vZGVzKCkpIHsKICAgICAgICAgIGNyZWF0ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbiwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gdi1odG1sIGFuZCBkb21Qcm9wczogaW5uZXJIVE1MCiAgICAgICAgICBpZiAoaXNEZWYoaSA9IGRhdGEpICYmIGlzRGVmKGkgPSBpLmRvbVByb3BzKSAmJiBpc0RlZihpID0gaS5pbm5lckhUTUwpKSB7CiAgICAgICAgICAgIGlmIChpICE9PSBlbG0uaW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmICFoeWRyYXRpb25CYWlsZWQpIHsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvbkJhaWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BhcmVudDogJywgZWxtKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybignc2VydmVyIGlubmVySFRNTDogJywgaSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ2NsaWVudCBpbm5lckhUTUw6ICcsIGVsbS5pbm5lckhUTUwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGl0ZXJhdGUgYW5kIGNvbXBhcmUgY2hpbGRyZW4gbGlzdHMKICAgICAgICAgICAgdmFyIGNoaWxkcmVuTWF0Y2ggPSB0cnVlOwogICAgICAgICAgICB2YXIgY2hpbGROb2RlID0gZWxtLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGZvciAodmFyIGlfNyA9IDA7IGlfNyA8IGNoaWxkcmVuLmxlbmd0aDsgaV83KyspIHsKICAgICAgICAgICAgICBpZiAoIWNoaWxkTm9kZSB8fCAhaHlkcmF0ZShjaGlsZE5vZGUsIGNoaWxkcmVuW2lfN10sIGluc2VydGVkVm5vZGVRdWV1ZSwgaW5WUHJlKSkgewogICAgICAgICAgICAgICAgY2hpbGRyZW5NYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBpZiBjaGlsZE5vZGUgaXMgbm90IG51bGwsIGl0IG1lYW5zIHRoZSBhY3R1YWwgY2hpbGROb2RlcyBsaXN0IGlzCiAgICAgICAgICAgIC8vIGxvbmdlciB0aGFuIHRoZSB2aXJ0dWFsIGNoaWxkcmVuIGxpc3QuCiAgICAgICAgICAgIGlmICghY2hpbGRyZW5NYXRjaCB8fCBjaGlsZE5vZGUpIHsKICAgICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWh5ZHJhdGlvbkJhaWxlZCkgewogICAgICAgICAgICAgICAgaHlkcmF0aW9uQmFpbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignUGFyZW50OiAnLCBlbG0pOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdNaXNtYXRjaGluZyBjaGlsZE5vZGVzIHZzLiBWTm9kZXM6ICcsIGVsbS5jaGlsZE5vZGVzLCBjaGlsZHJlbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgICB2YXIgZnVsbEludm9rZSA9IGZhbHNlOwogICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICBpZiAoIWlzUmVuZGVyZWRNb2R1bGUoa2V5KSkgewogICAgICAgICAgICBmdWxsSW52b2tlID0gdHJ1ZTsKICAgICAgICAgICAgaW52b2tlQ3JlYXRlSG9va3Modm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWZ1bGxJbnZva2UgJiYgZGF0YVsnY2xhc3MnXSkgewogICAgICAgICAgLy8gZW5zdXJlIGNvbGxlY3RpbmcgZGVwcyBmb3IgZGVlcCBjbGFzcyBiaW5kaW5ncyBmb3IgZnV0dXJlIHVwZGF0ZXMKICAgICAgICAgIHRyYXZlcnNlKGRhdGFbJ2NsYXNzJ10pOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChlbG0uZGF0YSAhPT0gdm5vZGUudGV4dCkgewogICAgICBlbG0uZGF0YSA9IHZub2RlLnRleHQ7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gYXNzZXJ0Tm9kZU1hdGNoKG5vZGUsIHZub2RlLCBpblZQcmUpIHsKICAgIGlmIChpc0RlZih2bm9kZS50YWcpKSB7CiAgICAgIHJldHVybiB2bm9kZS50YWcuaW5kZXhPZigndnVlLWNvbXBvbmVudCcpID09PSAwIHx8ICFpc1Vua25vd25FbGVtZW50KHZub2RlLCBpblZQcmUpICYmIHZub2RlLnRhZy50b0xvd2VyQ2FzZSgpID09PSAobm9kZS50YWdOYW1lICYmIG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSAodm5vZGUuaXNDb21tZW50ID8gOCA6IDMpOwogICAgfQogIH0KICByZXR1cm4gZnVuY3Rpb24gcGF0Y2gob2xkVm5vZGUsIHZub2RlLCBoeWRyYXRpbmcsIHJlbW92ZU9ubHkpIHsKICAgIGlmIChpc1VuZGVmKHZub2RlKSkgewogICAgICBpZiAoaXNEZWYob2xkVm5vZGUpKSBpbnZva2VEZXN0cm95SG9vayhvbGRWbm9kZSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBpc0luaXRpYWxQYXRjaCA9IGZhbHNlOwogICAgdmFyIGluc2VydGVkVm5vZGVRdWV1ZSA9IFtdOwogICAgaWYgKGlzVW5kZWYob2xkVm5vZGUpKSB7CiAgICAgIC8vIGVtcHR5IG1vdW50IChsaWtlbHkgYXMgY29tcG9uZW50KSwgY3JlYXRlIG5ldyByb290IGVsZW1lbnQKICAgICAgaXNJbml0aWFsUGF0Y2ggPSB0cnVlOwogICAgICBjcmVhdGVFbG0odm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgaXNSZWFsRWxlbWVudCA9IGlzRGVmKG9sZFZub2RlLm5vZGVUeXBlKTsKICAgICAgaWYgKCFpc1JlYWxFbGVtZW50ICYmIHNhbWVWbm9kZShvbGRWbm9kZSwgdm5vZGUpKSB7CiAgICAgICAgLy8gcGF0Y2ggZXhpc3Rpbmcgcm9vdCBub2RlCiAgICAgICAgcGF0Y2hWbm9kZShvbGRWbm9kZSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbnVsbCwgbnVsbCwgcmVtb3ZlT25seSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzUmVhbEVsZW1lbnQpIHsKICAgICAgICAgIC8vIG1vdW50aW5nIHRvIGEgcmVhbCBlbGVtZW50CiAgICAgICAgICAvLyBjaGVjayBpZiB0aGlzIGlzIHNlcnZlci1yZW5kZXJlZCBjb250ZW50IGFuZCBpZiB3ZSBjYW4gcGVyZm9ybQogICAgICAgICAgLy8gYSBzdWNjZXNzZnVsIGh5ZHJhdGlvbi4KICAgICAgICAgIGlmIChvbGRWbm9kZS5ub2RlVHlwZSA9PT0gMSAmJiBvbGRWbm9kZS5oYXNBdHRyaWJ1dGUoU1NSX0FUVFIpKSB7CiAgICAgICAgICAgIG9sZFZub2RlLnJlbW92ZUF0dHJpYnV0ZShTU1JfQVRUUik7CiAgICAgICAgICAgIGh5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNUcnVlKGh5ZHJhdGluZykpIHsKICAgICAgICAgICAgaWYgKGh5ZHJhdGUob2xkVm5vZGUsIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpKSB7CiAgICAgICAgICAgICAgaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCB0cnVlKTsKICAgICAgICAgICAgICByZXR1cm4gb2xkVm5vZGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgICAgIHdhcm4oJ1RoZSBjbGllbnQtc2lkZSByZW5kZXJlZCB2aXJ0dWFsIERPTSB0cmVlIGlzIG5vdCBtYXRjaGluZyAnICsgJ3NlcnZlci1yZW5kZXJlZCBjb250ZW50LiBUaGlzIGlzIGxpa2VseSBjYXVzZWQgYnkgaW5jb3JyZWN0ICcgKyAnSFRNTCBtYXJrdXAsIGZvciBleGFtcGxlIG5lc3RpbmcgYmxvY2stbGV2ZWwgZWxlbWVudHMgaW5zaWRlICcgKyAnPHA+LCBvciBtaXNzaW5nIDx0Ym9keT4uIEJhaWxpbmcgaHlkcmF0aW9uIGFuZCBwZXJmb3JtaW5nICcgKyAnZnVsbCBjbGllbnQtc2lkZSByZW5kZXIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIGVpdGhlciBub3Qgc2VydmVyLXJlbmRlcmVkLCBvciBoeWRyYXRpb24gZmFpbGVkLgogICAgICAgICAgLy8gY3JlYXRlIGFuIGVtcHR5IG5vZGUgYW5kIHJlcGxhY2UgaXQKICAgICAgICAgIG9sZFZub2RlID0gZW1wdHlOb2RlQXQob2xkVm5vZGUpOwogICAgICAgIH0KICAgICAgICAvLyByZXBsYWNpbmcgZXhpc3RpbmcgZWxlbWVudAogICAgICAgIHZhciBvbGRFbG0gPSBvbGRWbm9kZS5lbG07CiAgICAgICAgdmFyIHBhcmVudEVsbSA9IG5vZGVPcHMucGFyZW50Tm9kZShvbGRFbG0pOwogICAgICAgIC8vIGNyZWF0ZSBuZXcgbm9kZQogICAgICAgIGNyZWF0ZUVsbSh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLAogICAgICAgIC8vIGV4dHJlbWVseSByYXJlIGVkZ2UgY2FzZTogZG8gbm90IGluc2VydCBpZiBvbGQgZWxlbWVudCBpcyBpbiBhCiAgICAgICAgLy8gbGVhdmluZyB0cmFuc2l0aW9uLiBPbmx5IGhhcHBlbnMgd2hlbiBjb21iaW5pbmcgdHJhbnNpdGlvbiArCiAgICAgICAgLy8ga2VlcC1hbGl2ZSArIEhPQ3MuICgjNDU5MCkKICAgICAgICBvbGRFbG0uX2xlYXZlQ2IgPyBudWxsIDogcGFyZW50RWxtLCBub2RlT3BzLm5leHRTaWJsaW5nKG9sZEVsbSkpOwogICAgICAgIC8vIHVwZGF0ZSBwYXJlbnQgcGxhY2Vob2xkZXIgbm9kZSBlbGVtZW50LCByZWN1cnNpdmVseQogICAgICAgIGlmIChpc0RlZih2bm9kZS5wYXJlbnQpKSB7CiAgICAgICAgICB2YXIgYW5jZXN0b3IgPSB2bm9kZS5wYXJlbnQ7CiAgICAgICAgICB2YXIgcGF0Y2hhYmxlID0gaXNQYXRjaGFibGUodm5vZGUpOwogICAgICAgICAgd2hpbGUgKGFuY2VzdG9yKSB7CiAgICAgICAgICAgIGZvciAodmFyIGlfOCA9IDA7IGlfOCA8IGNicy5kZXN0cm95Lmxlbmd0aDsgKytpXzgpIHsKICAgICAgICAgICAgICBjYnMuZGVzdHJveVtpXzhdKGFuY2VzdG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhbmNlc3Rvci5lbG0gPSB2bm9kZS5lbG07CiAgICAgICAgICAgIGlmIChwYXRjaGFibGUpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpXzkgPSAwOyBpXzkgPCBjYnMuY3JlYXRlLmxlbmd0aDsgKytpXzkpIHsKICAgICAgICAgICAgICAgIGNicy5jcmVhdGVbaV85XShlbXB0eU5vZGUsIGFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gIzY1MTMKICAgICAgICAgICAgICAvLyBpbnZva2UgaW5zZXJ0IGhvb2tzIHRoYXQgbWF5IGhhdmUgYmVlbiBtZXJnZWQgYnkgY3JlYXRlIGhvb2tzLgogICAgICAgICAgICAgIC8vIGUuZy4gZm9yIGRpcmVjdGl2ZXMgdGhhdCB1c2VzIHRoZSAiaW5zZXJ0ZWQiIGhvb2suCiAgICAgICAgICAgICAgdmFyIGluc2VydF8xID0gYW5jZXN0b3IuZGF0YS5ob29rLmluc2VydDsKICAgICAgICAgICAgICBpZiAoaW5zZXJ0XzEubWVyZ2VkKSB7CiAgICAgICAgICAgICAgICAvLyBzdGFydCBhdCBpbmRleCAxIHRvIGF2b2lkIHJlLWludm9raW5nIGNvbXBvbmVudCBtb3VudGVkIGhvb2sKICAgICAgICAgICAgICAgIGZvciAodmFyIGlfMTAgPSAxOyBpXzEwIDwgaW5zZXJ0XzEuZm5zLmxlbmd0aDsgaV8xMCsrKSB7CiAgICAgICAgICAgICAgICAgIGluc2VydF8xLmZuc1tpXzEwXSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWdpc3RlclJlZihhbmNlc3Rvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIGRlc3Ryb3kgb2xkIG5vZGUKICAgICAgICBpZiAoaXNEZWYocGFyZW50RWxtKSkgewogICAgICAgICAgcmVtb3ZlVm5vZGVzKFtvbGRWbm9kZV0sIDAsIDApOwogICAgICAgIH0gZWxzZSBpZiAoaXNEZWYob2xkVm5vZGUudGFnKSkgewogICAgICAgICAgaW52b2tlRGVzdHJveUhvb2sob2xkVm5vZGUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBpc0luaXRpYWxQYXRjaCk7CiAgICByZXR1cm4gdm5vZGUuZWxtOwogIH07Cn0KdmFyIGRpcmVjdGl2ZXMgPSB7CiAgY3JlYXRlOiB1cGRhdGVEaXJlY3RpdmVzLAogIHVwZGF0ZTogdXBkYXRlRGlyZWN0aXZlcywKICBkZXN0cm95OiBmdW5jdGlvbiB1bmJpbmREaXJlY3RpdmVzKHZub2RlKSB7CiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGVtcHR5Tm9kZSBpcyBub3QgVk5vZGVXaXRoRGF0YQogICAgdXBkYXRlRGlyZWN0aXZlcyh2bm9kZSwgZW1wdHlOb2RlKTsKICB9Cn07CmZ1bmN0aW9uIHVwZGF0ZURpcmVjdGl2ZXMob2xkVm5vZGUsIHZub2RlKSB7CiAgaWYgKG9sZFZub2RlLmRhdGEuZGlyZWN0aXZlcyB8fCB2bm9kZS5kYXRhLmRpcmVjdGl2ZXMpIHsKICAgIF91cGRhdGUob2xkVm5vZGUsIHZub2RlKTsKICB9Cn0KZnVuY3Rpb24gX3VwZGF0ZShvbGRWbm9kZSwgdm5vZGUpIHsKICB2YXIgaXNDcmVhdGUgPSBvbGRWbm9kZSA9PT0gZW1wdHlOb2RlOwogIHZhciBpc0Rlc3Ryb3kgPSB2bm9kZSA9PT0gZW1wdHlOb2RlOwogIHZhciBvbGREaXJzID0gbm9ybWFsaXplRGlyZWN0aXZlcyhvbGRWbm9kZS5kYXRhLmRpcmVjdGl2ZXMsIG9sZFZub2RlLmNvbnRleHQpOwogIHZhciBuZXdEaXJzID0gbm9ybWFsaXplRGlyZWN0aXZlcyh2bm9kZS5kYXRhLmRpcmVjdGl2ZXMsIHZub2RlLmNvbnRleHQpOwogIHZhciBkaXJzV2l0aEluc2VydCA9IFtdOwogIHZhciBkaXJzV2l0aFBvc3RwYXRjaCA9IFtdOwogIHZhciBrZXksIG9sZERpciwgZGlyOwogIGZvciAoa2V5IGluIG5ld0RpcnMpIHsKICAgIG9sZERpciA9IG9sZERpcnNba2V5XTsKICAgIGRpciA9IG5ld0RpcnNba2V5XTsKICAgIGlmICghb2xkRGlyKSB7CiAgICAgIC8vIG5ldyBkaXJlY3RpdmUsIGJpbmQKICAgICAgY2FsbEhvb2soZGlyLCAnYmluZCcsIHZub2RlLCBvbGRWbm9kZSk7CiAgICAgIGlmIChkaXIuZGVmICYmIGRpci5kZWYuaW5zZXJ0ZWQpIHsKICAgICAgICBkaXJzV2l0aEluc2VydC5wdXNoKGRpcik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIGV4aXN0aW5nIGRpcmVjdGl2ZSwgdXBkYXRlCiAgICAgIGRpci5vbGRWYWx1ZSA9IG9sZERpci52YWx1ZTsKICAgICAgZGlyLm9sZEFyZyA9IG9sZERpci5hcmc7CiAgICAgIGNhbGxIb29rKGRpciwgJ3VwZGF0ZScsIHZub2RlLCBvbGRWbm9kZSk7CiAgICAgIGlmIChkaXIuZGVmICYmIGRpci5kZWYuY29tcG9uZW50VXBkYXRlZCkgewogICAgICAgIGRpcnNXaXRoUG9zdHBhdGNoLnB1c2goZGlyKTsKICAgICAgfQogICAgfQogIH0KICBpZiAoZGlyc1dpdGhJbnNlcnQubGVuZ3RoKSB7CiAgICB2YXIgY2FsbEluc2VydCA9IGZ1bmN0aW9uIGNhbGxJbnNlcnQoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlyc1dpdGhJbnNlcnQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjYWxsSG9vayhkaXJzV2l0aEluc2VydFtpXSwgJ2luc2VydGVkJywgdm5vZGUsIG9sZFZub2RlKTsKICAgICAgfQogICAgfTsKICAgIGlmIChpc0NyZWF0ZSkgewogICAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ2luc2VydCcsIGNhbGxJbnNlcnQpOwogICAgfSBlbHNlIHsKICAgICAgY2FsbEluc2VydCgpOwogICAgfQogIH0KICBpZiAoZGlyc1dpdGhQb3N0cGF0Y2gubGVuZ3RoKSB7CiAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ3Bvc3RwYXRjaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXJzV2l0aFBvc3RwYXRjaC5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxIb29rKGRpcnNXaXRoUG9zdHBhdGNoW2ldLCAnY29tcG9uZW50VXBkYXRlZCcsIHZub2RlLCBvbGRWbm9kZSk7CiAgICAgIH0KICAgIH0pOwogIH0KICBpZiAoIWlzQ3JlYXRlKSB7CiAgICBmb3IgKGtleSBpbiBvbGREaXJzKSB7CiAgICAgIGlmICghbmV3RGlyc1trZXldKSB7CiAgICAgICAgLy8gbm8gbG9uZ2VyIHByZXNlbnQsIHVuYmluZAogICAgICAgIGNhbGxIb29rKG9sZERpcnNba2V5XSwgJ3VuYmluZCcsIG9sZFZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KTsKICAgICAgfQogICAgfQogIH0KfQp2YXIgZW1wdHlNb2RpZmllcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwpmdW5jdGlvbiBub3JtYWxpemVEaXJlY3RpdmVzKGRpcnMsIHZtKSB7CiAgdmFyIHJlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgaWYgKCFkaXJzKSB7CiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIHJldHVybiByZXM7CiAgfQogIHZhciBpLCBkaXI7CiAgZm9yIChpID0gMDsgaSA8IGRpcnMubGVuZ3RoOyBpKyspIHsKICAgIGRpciA9IGRpcnNbaV07CiAgICBpZiAoIWRpci5tb2RpZmllcnMpIHsKICAgICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICAgIGRpci5tb2RpZmllcnMgPSBlbXB0eU1vZGlmaWVyczsKICAgIH0KICAgIHJlc1tnZXRSYXdEaXJOYW1lKGRpcildID0gZGlyOwogICAgaWYgKHZtLl9zZXR1cFN0YXRlICYmIHZtLl9zZXR1cFN0YXRlLl9fc2ZjKSB7CiAgICAgIHZhciBzZXR1cERlZiA9IGRpci5kZWYgfHwgcmVzb2x2ZUFzc2V0KHZtLCAnX3NldHVwU3RhdGUnLCAndi0nICsgZGlyLm5hbWUpOwogICAgICBpZiAodHlwZW9mIHNldHVwRGVmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgZGlyLmRlZiA9IHsKICAgICAgICAgIGJpbmQ6IHNldHVwRGVmLAogICAgICAgICAgdXBkYXRlOiBzZXR1cERlZgogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGlyLmRlZiA9IHNldHVwRGVmOwogICAgICB9CiAgICB9CiAgICBkaXIuZGVmID0gZGlyLmRlZiB8fCByZXNvbHZlQXNzZXQodm0uJG9wdGlvbnMsICdkaXJlY3RpdmVzJywgZGlyLm5hbWUsIHRydWUpOwogIH0KICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICByZXR1cm4gcmVzOwp9CmZ1bmN0aW9uIGdldFJhd0Rpck5hbWUoZGlyKSB7CiAgcmV0dXJuIGRpci5yYXdOYW1lIHx8ICIiLmNvbmNhdChkaXIubmFtZSwgIi4iKS5jb25jYXQoT2JqZWN0LmtleXMoZGlyLm1vZGlmaWVycyB8fCB7fSkuam9pbignLicpKTsKfQpmdW5jdGlvbiBjYWxsSG9vayhkaXIsIGhvb2ssIHZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KSB7CiAgdmFyIGZuID0gZGlyLmRlZiAmJiBkaXIuZGVmW2hvb2tdOwogIGlmIChmbikgewogICAgdHJ5IHsKICAgICAgZm4odm5vZGUuZWxtLCBkaXIsIHZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaGFuZGxlRXJyb3IoZSwgdm5vZGUuY29udGV4dCwgImRpcmVjdGl2ZSAiLmNvbmNhdChkaXIubmFtZSwgIiAiKS5jb25jYXQoaG9vaywgIiBob29rIikpOwogICAgfQogIH0KfQp2YXIgYmFzZU1vZHVsZXMgPSBbcmVmLCBkaXJlY3RpdmVzXTsKZnVuY3Rpb24gdXBkYXRlQXR0cnMob2xkVm5vZGUsIHZub2RlKSB7CiAgdmFyIG9wdHMgPSB2bm9kZS5jb21wb25lbnRPcHRpb25zOwogIGlmIChpc0RlZihvcHRzKSAmJiBvcHRzLkN0b3Iub3B0aW9ucy5pbmhlcml0QXR0cnMgPT09IGZhbHNlKSB7CiAgICByZXR1cm47CiAgfQogIGlmIChpc1VuZGVmKG9sZFZub2RlLmRhdGEuYXR0cnMpICYmIGlzVW5kZWYodm5vZGUuZGF0YS5hdHRycykpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGtleSwgY3VyLCBvbGQ7CiAgdmFyIGVsbSA9IHZub2RlLmVsbTsKICB2YXIgb2xkQXR0cnMgPSBvbGRWbm9kZS5kYXRhLmF0dHJzIHx8IHt9OwogIHZhciBhdHRycyA9IHZub2RlLmRhdGEuYXR0cnMgfHwge307CiAgLy8gY2xvbmUgb2JzZXJ2ZWQgb2JqZWN0cywgYXMgdGhlIHVzZXIgcHJvYmFibHkgd2FudHMgdG8gbXV0YXRlIGl0CiAgaWYgKGlzRGVmKGF0dHJzLl9fb2JfXykgfHwgaXNUcnVlKGF0dHJzLl92X2F0dHJfcHJveHkpKSB7CiAgICBhdHRycyA9IHZub2RlLmRhdGEuYXR0cnMgPSBleHRlbmQoe30sIGF0dHJzKTsKICB9CiAgZm9yIChrZXkgaW4gYXR0cnMpIHsKICAgIGN1ciA9IGF0dHJzW2tleV07CiAgICBvbGQgPSBvbGRBdHRyc1trZXldOwogICAgaWYgKG9sZCAhPT0gY3VyKSB7CiAgICAgIHNldEF0dHIoZWxtLCBrZXksIGN1ciwgdm5vZGUuZGF0YS5wcmUpOwogICAgfQogIH0KICAvLyAjNDM5MTogaW4gSUU5LCBzZXR0aW5nIHR5cGUgY2FuIHJlc2V0IHZhbHVlIGZvciBpbnB1dFt0eXBlPXJhZGlvXQogIC8vICM2NjY2OiBJRS9FZGdlIGZvcmNlcyBwcm9ncmVzcyB2YWx1ZSBkb3duIHRvIDEgYmVmb3JlIHNldHRpbmcgYSBtYXgKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoKGlzSUUgfHwgaXNFZGdlKSAmJiBhdHRycy52YWx1ZSAhPT0gb2xkQXR0cnMudmFsdWUpIHsKICAgIHNldEF0dHIoZWxtLCAndmFsdWUnLCBhdHRycy52YWx1ZSk7CiAgfQogIGZvciAoa2V5IGluIG9sZEF0dHJzKSB7CiAgICBpZiAoaXNVbmRlZihhdHRyc1trZXldKSkgewogICAgICBpZiAoaXNYbGluayhrZXkpKSB7CiAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZU5TKHhsaW5rTlMsIGdldFhsaW5rUHJvcChrZXkpKTsKICAgICAgfSBlbHNlIGlmICghaXNFbnVtZXJhdGVkQXR0cihrZXkpKSB7CiAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgICB9CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHNldEF0dHIoZWwsIGtleSwgdmFsdWUsIGlzSW5QcmUpIHsKICBpZiAoaXNJblByZSB8fCBlbC50YWdOYW1lLmluZGV4T2YoJy0nKSA+IC0xKSB7CiAgICBiYXNlU2V0QXR0cihlbCwga2V5LCB2YWx1ZSk7CiAgfSBlbHNlIGlmIChpc0Jvb2xlYW5BdHRyKGtleSkpIHsKICAgIC8vIHNldCBhdHRyaWJ1dGUgZm9yIGJsYW5rIHZhbHVlCiAgICAvLyBlLmcuIDxvcHRpb24gZGlzYWJsZWQ+U2VsZWN0IG9uZTwvb3B0aW9uPgogICAgaWYgKGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpKSB7CiAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgfSBlbHNlIHsKICAgICAgLy8gdGVjaG5pY2FsbHkgYWxsb3dmdWxsc2NyZWVuIGlzIGEgYm9vbGVhbiBhdHRyaWJ1dGUgZm9yIDxpZnJhbWU+LAogICAgICAvLyBidXQgRmxhc2ggZXhwZWN0cyBhIHZhbHVlIG9mICJ0cnVlIiB3aGVuIHVzZWQgb24gPGVtYmVkPiB0YWcKICAgICAgdmFsdWUgPSBrZXkgPT09ICdhbGxvd2Z1bGxzY3JlZW4nICYmIGVsLnRhZ05hbWUgPT09ICdFTUJFRCcgPyAndHJ1ZScgOiBrZXk7CiAgICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIHZhbHVlKTsKICAgIH0KICB9IGVsc2UgaWYgKGlzRW51bWVyYXRlZEF0dHIoa2V5KSkgewogICAgZWwuc2V0QXR0cmlidXRlKGtleSwgY29udmVydEVudW1lcmF0ZWRWYWx1ZShrZXksIHZhbHVlKSk7CiAgfSBlbHNlIGlmIChpc1hsaW5rKGtleSkpIHsKICAgIGlmIChpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSkgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGVOUyh4bGlua05TLCBnZXRYbGlua1Byb3Aoa2V5KSk7CiAgICB9IGVsc2UgewogICAgICBlbC5zZXRBdHRyaWJ1dGVOUyh4bGlua05TLCBrZXksIHZhbHVlKTsKICAgIH0KICB9IGVsc2UgewogICAgYmFzZVNldEF0dHIoZWwsIGtleSwgdmFsdWUpOwogIH0KfQpmdW5jdGlvbiBiYXNlU2V0QXR0cihlbCwga2V5LCB2YWx1ZSkgewogIGlmIChpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSkgewogICAgZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7CiAgfSBlbHNlIHsKICAgIC8vICM3MTM4OiBJRTEwICYgMTEgZmlyZXMgaW5wdXQgZXZlbnQgd2hlbiBzZXR0aW5nIHBsYWNlaG9sZGVyIG9uCiAgICAvLyA8dGV4dGFyZWE+Li4uIGJsb2NrIHRoZSBmaXJzdCBpbnB1dCBldmVudCBhbmQgcmVtb3ZlIHRoZSBibG9ja2VyCiAgICAvLyBpbW1lZGlhdGVseS4KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzSUUgJiYgIWlzSUU5ICYmIGVsLnRhZ05hbWUgPT09ICdURVhUQVJFQScgJiYga2V5ID09PSAncGxhY2Vob2xkZXInICYmIHZhbHVlICE9PSAnJyAmJiAhZWwuX19pZXBoKSB7CiAgICAgIHZhciBibG9ja2VyXzEgPSBmdW5jdGlvbiBibG9ja2VyXzEoZSkgewogICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBibG9ja2VyXzEpOwogICAgICB9OwogICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIGJsb2NrZXJfMSk7CiAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICBlbC5fX2llcGggPSB0cnVlOyAvKiBJRSBwbGFjZWhvbGRlciBwYXRjaGVkICovCiAgICB9CgogICAgZWwuc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpOwogIH0KfQp2YXIgYXR0cnMgPSB7CiAgY3JlYXRlOiB1cGRhdGVBdHRycywKICB1cGRhdGU6IHVwZGF0ZUF0dHJzCn07CmZ1bmN0aW9uIHVwZGF0ZUNsYXNzKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBlbCA9IHZub2RlLmVsbTsKICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgdmFyIG9sZERhdGEgPSBvbGRWbm9kZS5kYXRhOwogIGlmIChpc1VuZGVmKGRhdGEuc3RhdGljQ2xhc3MpICYmIGlzVW5kZWYoZGF0YS5jbGFzcykgJiYgKGlzVW5kZWYob2xkRGF0YSkgfHwgaXNVbmRlZihvbGREYXRhLnN0YXRpY0NsYXNzKSAmJiBpc1VuZGVmKG9sZERhdGEuY2xhc3MpKSkgewogICAgcmV0dXJuOwogIH0KICB2YXIgY2xzID0gZ2VuQ2xhc3NGb3JWbm9kZSh2bm9kZSk7CiAgLy8gaGFuZGxlIHRyYW5zaXRpb24gY2xhc3NlcwogIHZhciB0cmFuc2l0aW9uQ2xhc3MgPSBlbC5fdHJhbnNpdGlvbkNsYXNzZXM7CiAgaWYgKGlzRGVmKHRyYW5zaXRpb25DbGFzcykpIHsKICAgIGNscyA9IGNvbmNhdChjbHMsIHN0cmluZ2lmeUNsYXNzKHRyYW5zaXRpb25DbGFzcykpOwogIH0KICAvLyBzZXQgdGhlIGNsYXNzCiAgaWYgKGNscyAhPT0gZWwuX3ByZXZDbGFzcykgewogICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsIGNscyk7CiAgICBlbC5fcHJldkNsYXNzID0gY2xzOwogIH0KfQp2YXIga2xhc3MgPSB7CiAgY3JlYXRlOiB1cGRhdGVDbGFzcywKICB1cGRhdGU6IHVwZGF0ZUNsYXNzCn07CgovLyBpbiBzb21lIGNhc2VzLCB0aGUgZXZlbnQgdXNlZCBoYXMgdG8gYmUgZGV0ZXJtaW5lZCBhdCBydW50aW1lCi8vIHNvIHdlIHVzZWQgc29tZSByZXNlcnZlZCB0b2tlbnMgZHVyaW5nIGNvbXBpbGUuCnZhciBSQU5HRV9UT0tFTiA9ICdfX3InOwp2YXIgQ0hFQ0tCT1hfUkFESU9fVE9LRU4gPSAnX19jJzsKCi8vIG5vcm1hbGl6ZSB2LW1vZGVsIGV2ZW50IHRva2VucyB0aGF0IGNhbiBvbmx5IGJlIGRldGVybWluZWQgYXQgcnVudGltZS4KLy8gaXQncyBpbXBvcnRhbnQgdG8gcGxhY2UgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBpbiB0aGUgYXJyYXkgYmVjYXVzZQovLyB0aGUgd2hvbGUgcG9pbnQgaXMgZW5zdXJpbmcgdGhlIHYtbW9kZWwgY2FsbGJhY2sgZ2V0cyBjYWxsZWQgYmVmb3JlCi8vIHVzZXItYXR0YWNoZWQgaGFuZGxlcnMuCmZ1bmN0aW9uIG5vcm1hbGl6ZUV2ZW50cyhvbikgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChpc0RlZihvbltSQU5HRV9UT0tFTl0pKSB7CiAgICAvLyBJRSBpbnB1dFt0eXBlPXJhbmdlXSBvbmx5IHN1cHBvcnRzIGBjaGFuZ2VgIGV2ZW50CiAgICB2YXIgZXZlbnRfMSA9IGlzSUUgPyAnY2hhbmdlJyA6ICdpbnB1dCc7CiAgICBvbltldmVudF8xXSA9IFtdLmNvbmNhdChvbltSQU5HRV9UT0tFTl0sIG9uW2V2ZW50XzFdIHx8IFtdKTsKICAgIGRlbGV0ZSBvbltSQU5HRV9UT0tFTl07CiAgfQogIC8vIFRoaXMgd2FzIG9yaWdpbmFsbHkgaW50ZW5kZWQgdG8gZml4ICM0NTIxIGJ1dCBubyBsb25nZXIgbmVjZXNzYXJ5CiAgLy8gYWZ0ZXIgMi41LiBLZWVwaW5nIGl0IGZvciBiYWNrd2FyZHMgY29tcGF0IHdpdGggZ2VuZXJhdGVkIGNvZGUgZnJvbSA8IDIuNAogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChpc0RlZihvbltDSEVDS0JPWF9SQURJT19UT0tFTl0pKSB7CiAgICBvbi5jaGFuZ2UgPSBbXS5jb25jYXQob25bQ0hFQ0tCT1hfUkFESU9fVE9LRU5dLCBvbi5jaGFuZ2UgfHwgW10pOwogICAgZGVsZXRlIG9uW0NIRUNLQk9YX1JBRElPX1RPS0VOXTsKICB9Cn0KdmFyIHRhcmdldDsKZnVuY3Rpb24gY3JlYXRlT25jZUhhbmRsZXIoZXZlbnQsIGhhbmRsZXIsIGNhcHR1cmUpIHsKICB2YXIgX3RhcmdldCA9IHRhcmdldDsgLy8gc2F2ZSBjdXJyZW50IHRhcmdldCBlbGVtZW50IGluIGNsb3N1cmUKICByZXR1cm4gZnVuY3Rpb24gb25jZUhhbmRsZXIoKSB7CiAgICB2YXIgcmVzID0gaGFuZGxlci5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgaWYgKHJlcyAhPT0gbnVsbCkgewogICAgICByZW1vdmUoZXZlbnQsIG9uY2VIYW5kbGVyLCBjYXB0dXJlLCBfdGFyZ2V0KTsKICAgIH0KICB9Owp9Ci8vICM5NDQ2OiBGaXJlZm94IDw9IDUzIChpbiBwYXJ0aWN1bGFyLCBFU1IgNTIpIGhhcyBpbmNvcnJlY3QgRXZlbnQudGltZVN0YW1wCi8vIGltcGxlbWVudGF0aW9uIGFuZCBkb2VzIG5vdCBmaXJlIG1pY3JvdGFza3MgaW4gYmV0d2VlbiBldmVudCBwcm9wYWdhdGlvbiwgc28KLy8gc2FmZSB0byBleGNsdWRlLgp2YXIgdXNlTWljcm90YXNrRml4ID0gaXNVc2luZ01pY3JvVGFzayAmJiAhKGlzRkYgJiYgTnVtYmVyKGlzRkZbMV0pIDw9IDUzKTsKZnVuY3Rpb24gYWRkKG5hbWUsIGhhbmRsZXIsIGNhcHR1cmUsIHBhc3NpdmUpIHsKICAvLyBhc3luYyBlZGdlIGNhc2UgIzY1NjY6IGlubmVyIGNsaWNrIGV2ZW50IHRyaWdnZXJzIHBhdGNoLCBldmVudCBoYW5kbGVyCiAgLy8gYXR0YWNoZWQgdG8gb3V0ZXIgZWxlbWVudCBkdXJpbmcgcGF0Y2gsIGFuZCB0cmlnZ2VyZWQgYWdhaW4uIFRoaXMKICAvLyBoYXBwZW5zIGJlY2F1c2UgYnJvd3NlcnMgZmlyZSBtaWNyb3Rhc2sgdGlja3MgYmV0d2VlbiBldmVudCBwcm9wYWdhdGlvbi4KICAvLyB0aGUgc29sdXRpb24gaXMgc2ltcGxlOiB3ZSBzYXZlIHRoZSB0aW1lc3RhbXAgd2hlbiBhIGhhbmRsZXIgaXMgYXR0YWNoZWQsCiAgLy8gYW5kIHRoZSBoYW5kbGVyIHdvdWxkIG9ubHkgZmlyZSBpZiB0aGUgZXZlbnQgcGFzc2VkIHRvIGl0IHdhcyBmaXJlZAogIC8vIEFGVEVSIGl0IHdhcyBhdHRhY2hlZC4KICBpZiAodXNlTWljcm90YXNrRml4KSB7CiAgICB2YXIgYXR0YWNoZWRUaW1lc3RhbXBfMSA9IGN1cnJlbnRGbHVzaFRpbWVzdGFtcDsKICAgIHZhciBvcmlnaW5hbF8xID0gaGFuZGxlcjsKICAgIC8vQHRzLWV4cGVjdC1lcnJvcgogICAgaGFuZGxlciA9IG9yaWdpbmFsXzEuX3dyYXBwZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoCiAgICAgIC8vIG5vIGJ1YmJsaW5nLCBzaG91bGQgYWx3YXlzIGZpcmUuCiAgICAgIC8vIHRoaXMgaXMganVzdCBhIHNhZmV0eSBuZXQgaW4gY2FzZSBldmVudC50aW1lU3RhbXAgaXMgdW5yZWxpYWJsZSBpbgogICAgICAvLyBjZXJ0YWluIHdlaXJkIGVudmlyb25tZW50cy4uLgogICAgICBlLnRhcmdldCA9PT0gZS5jdXJyZW50VGFyZ2V0IHx8CiAgICAgIC8vIGV2ZW50IGlzIGZpcmVkIGFmdGVyIGhhbmRsZXIgYXR0YWNobWVudAogICAgICBlLnRpbWVTdGFtcCA+PSBhdHRhY2hlZFRpbWVzdGFtcF8xIHx8CiAgICAgIC8vIGJhaWwgZm9yIGVudmlyb25tZW50cyB0aGF0IGhhdmUgYnVnZ3kgZXZlbnQudGltZVN0YW1wIGltcGxlbWVudGF0aW9ucwogICAgICAvLyAjOTQ2MiBpT1MgOSBidWc6IGV2ZW50LnRpbWVTdGFtcCBpcyAwIGFmdGVyIGhpc3RvcnkucHVzaFN0YXRlCiAgICAgIC8vICM5NjgxIFF0V2ViRW5naW5lIGV2ZW50LnRpbWVTdGFtcCBpcyBuZWdhdGl2ZSB2YWx1ZQogICAgICBlLnRpbWVTdGFtcCA8PSAwIHx8CiAgICAgIC8vICM5NDQ4IGJhaWwgaWYgZXZlbnQgaXMgZmlyZWQgaW4gYW5vdGhlciBkb2N1bWVudCBpbiBhIG11bHRpLXBhZ2UKICAgICAgLy8gZWxlY3Ryb24vbncuanMgYXBwLCBzaW5jZSBldmVudC50aW1lU3RhbXAgd2lsbCBiZSB1c2luZyBhIGRpZmZlcmVudAogICAgICAvLyBzdGFydGluZyByZWZlcmVuY2UKICAgICAgZS50YXJnZXQub3duZXJEb2N1bWVudCAhPT0gZG9jdW1lbnQpIHsKICAgICAgICByZXR1cm4gb3JpZ2luYWxfMS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihuYW1lLCBoYW5kbGVyLCBzdXBwb3J0c1Bhc3NpdmUgPyB7CiAgICBjYXB0dXJlOiBjYXB0dXJlLAogICAgcGFzc2l2ZTogcGFzc2l2ZQogIH0gOiBjYXB0dXJlKTsKfQpmdW5jdGlvbiByZW1vdmUobmFtZSwgaGFuZGxlciwgY2FwdHVyZSwgX3RhcmdldCkgewogIChfdGFyZ2V0IHx8IHRhcmdldCkucmVtb3ZlRXZlbnRMaXN0ZW5lcihuYW1lLAogIC8vQHRzLWV4cGVjdC1lcnJvcgogIGhhbmRsZXIuX3dyYXBwZXIgfHwgaGFuZGxlciwgY2FwdHVyZSk7Cn0KZnVuY3Rpb24gdXBkYXRlRE9NTGlzdGVuZXJzKG9sZFZub2RlLCB2bm9kZSkgewogIGlmIChpc1VuZGVmKG9sZFZub2RlLmRhdGEub24pICYmIGlzVW5kZWYodm5vZGUuZGF0YS5vbikpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIG9uID0gdm5vZGUuZGF0YS5vbiB8fCB7fTsKICB2YXIgb2xkT24gPSBvbGRWbm9kZS5kYXRhLm9uIHx8IHt9OwogIC8vIHZub2RlIGlzIGVtcHR5IHdoZW4gcmVtb3ZpbmcgYWxsIGxpc3RlbmVycywKICAvLyBhbmQgdXNlIG9sZCB2bm9kZSBkb20gZWxlbWVudAogIHRhcmdldCA9IHZub2RlLmVsbSB8fCBvbGRWbm9kZS5lbG07CiAgbm9ybWFsaXplRXZlbnRzKG9uKTsKICB1cGRhdGVMaXN0ZW5lcnMob24sIG9sZE9uLCBhZGQsIHJlbW92ZSwgY3JlYXRlT25jZUhhbmRsZXIsIHZub2RlLmNvbnRleHQpOwogIHRhcmdldCA9IHVuZGVmaW5lZDsKfQp2YXIgZXZlbnRzID0gewogIGNyZWF0ZTogdXBkYXRlRE9NTGlzdGVuZXJzLAogIHVwZGF0ZTogdXBkYXRlRE9NTGlzdGVuZXJzLAogIC8vIEB0cy1leHBlY3QtZXJyb3IgZW1wdHlOb2RlIGhhcyBhY3R1YWxseSBkYXRhCiAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSh2bm9kZSkgewogICAgcmV0dXJuIHVwZGF0ZURPTUxpc3RlbmVycyh2bm9kZSwgZW1wdHlOb2RlKTsKICB9Cn07CnZhciBzdmdDb250YWluZXI7CmZ1bmN0aW9uIHVwZGF0ZURPTVByb3BzKG9sZFZub2RlLCB2bm9kZSkgewogIGlmIChpc1VuZGVmKG9sZFZub2RlLmRhdGEuZG9tUHJvcHMpICYmIGlzVW5kZWYodm5vZGUuZGF0YS5kb21Qcm9wcykpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGtleSwgY3VyOwogIHZhciBlbG0gPSB2bm9kZS5lbG07CiAgdmFyIG9sZFByb3BzID0gb2xkVm5vZGUuZGF0YS5kb21Qcm9wcyB8fCB7fTsKICB2YXIgcHJvcHMgPSB2bm9kZS5kYXRhLmRvbVByb3BzIHx8IHt9OwogIC8vIGNsb25lIG9ic2VydmVkIG9iamVjdHMsIGFzIHRoZSB1c2VyIHByb2JhYmx5IHdhbnRzIHRvIG11dGF0ZSBpdAogIGlmIChpc0RlZihwcm9wcy5fX29iX18pIHx8IGlzVHJ1ZShwcm9wcy5fdl9hdHRyX3Byb3h5KSkgewogICAgcHJvcHMgPSB2bm9kZS5kYXRhLmRvbVByb3BzID0gZXh0ZW5kKHt9LCBwcm9wcyk7CiAgfQogIGZvciAoa2V5IGluIG9sZFByb3BzKSB7CiAgICBpZiAoIShrZXkgaW4gcHJvcHMpKSB7CiAgICAgIGVsbVtrZXldID0gJyc7CiAgICB9CiAgfQogIGZvciAoa2V5IGluIHByb3BzKSB7CiAgICBjdXIgPSBwcm9wc1trZXldOwogICAgLy8gaWdub3JlIGNoaWxkcmVuIGlmIHRoZSBub2RlIGhhcyB0ZXh0Q29udGVudCBvciBpbm5lckhUTUwsCiAgICAvLyBhcyB0aGVzZSB3aWxsIHRocm93IGF3YXkgZXhpc3RpbmcgRE9NIG5vZGVzIGFuZCBjYXVzZSByZW1vdmFsIGVycm9ycwogICAgLy8gb24gc3Vic2VxdWVudCBwYXRjaGVzICgjMzM2MCkKICAgIGlmIChrZXkgPT09ICd0ZXh0Q29udGVudCcgfHwga2V5ID09PSAnaW5uZXJIVE1MJykgewogICAgICBpZiAodm5vZGUuY2hpbGRyZW4pIHZub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICAgIGlmIChjdXIgPT09IG9sZFByb3BzW2tleV0pIGNvbnRpbnVlOwogICAgICAvLyAjNjYwMSB3b3JrIGFyb3VuZCBDaHJvbWUgdmVyc2lvbiA8PSA1NSBidWcgd2hlcmUgc2luZ2xlIHRleHROb2RlCiAgICAgIC8vIHJlcGxhY2VkIGJ5IGlubmVySFRNTC90ZXh0Q29udGVudCByZXRhaW5zIGl0cyBwYXJlbnROb2RlIHByb3BlcnR5CiAgICAgIGlmIChlbG0uY2hpbGROb2Rlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICBlbG0ucmVtb3ZlQ2hpbGQoZWxtLmNoaWxkTm9kZXNbMF0pOwogICAgICB9CiAgICB9CiAgICBpZiAoa2V5ID09PSAndmFsdWUnICYmIGVsbS50YWdOYW1lICE9PSAnUFJPR1JFU1MnKSB7CiAgICAgIC8vIHN0b3JlIHZhbHVlIGFzIF92YWx1ZSBhcyB3ZWxsIHNpbmNlCiAgICAgIC8vIG5vbi1zdHJpbmcgdmFsdWVzIHdpbGwgYmUgc3RyaW5naWZpZWQKICAgICAgZWxtLl92YWx1ZSA9IGN1cjsKICAgICAgLy8gYXZvaWQgcmVzZXR0aW5nIGN1cnNvciBwb3NpdGlvbiB3aGVuIHZhbHVlIGlzIHRoZSBzYW1lCiAgICAgIHZhciBzdHJDdXIgPSBpc1VuZGVmKGN1cikgPyAnJyA6IFN0cmluZyhjdXIpOwogICAgICBpZiAoc2hvdWxkVXBkYXRlVmFsdWUoZWxtLCBzdHJDdXIpKSB7CiAgICAgICAgZWxtLnZhbHVlID0gc3RyQ3VyOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ2lubmVySFRNTCcgJiYgaXNTVkcoZWxtLnRhZ05hbWUpICYmIGlzVW5kZWYoZWxtLmlubmVySFRNTCkpIHsKICAgICAgLy8gSUUgZG9lc24ndCBzdXBwb3J0IGlubmVySFRNTCBmb3IgU1ZHIGVsZW1lbnRzCiAgICAgIHN2Z0NvbnRhaW5lciA9IHN2Z0NvbnRhaW5lciB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgc3ZnQ29udGFpbmVyLmlubmVySFRNTCA9ICI8c3ZnPiIuY29uY2F0KGN1ciwgIjwvc3ZnPiIpOwogICAgICB2YXIgc3ZnID0gc3ZnQ29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgICAgIHdoaWxlIChlbG0uZmlyc3RDaGlsZCkgewogICAgICAgIGVsbS5yZW1vdmVDaGlsZChlbG0uZmlyc3RDaGlsZCk7CiAgICAgIH0KICAgICAgd2hpbGUgKHN2Zy5maXJzdENoaWxkKSB7CiAgICAgICAgZWxtLmFwcGVuZENoaWxkKHN2Zy5maXJzdENoaWxkKTsKICAgICAgfQogICAgfSBlbHNlIGlmICgKICAgIC8vIHNraXAgdGhlIHVwZGF0ZSBpZiBvbGQgYW5kIG5ldyBWRE9NIHN0YXRlIGlzIHRoZSBzYW1lLgogICAgLy8gYHZhbHVlYCBpcyBoYW5kbGVkIHNlcGFyYXRlbHkgYmVjYXVzZSB0aGUgRE9NIHZhbHVlIG1heSBiZSB0ZW1wb3JhcmlseQogICAgLy8gb3V0IG9mIHN5bmMgd2l0aCBWRE9NIHN0YXRlIGR1ZSB0byBmb2N1cywgY29tcG9zaXRpb24gYW5kIG1vZGlmaWVycy4KICAgIC8vIFRoaXMgICM0NTIxIGJ5IHNraXBwaW5nIHRoZSB1bm5lY2Vzc2FyeSBgY2hlY2tlZGAgdXBkYXRlLgogICAgY3VyICE9PSBvbGRQcm9wc1trZXldKSB7CiAgICAgIC8vIHNvbWUgcHJvcGVydHkgdXBkYXRlcyBjYW4gdGhyb3cKICAgICAgLy8gZS5nLiBgdmFsdWVgIG9uIDxwcm9ncmVzcz4gdy8gbm9uLWZpbml0ZSB2YWx1ZQogICAgICB0cnkgewogICAgICAgIGVsbVtrZXldID0gY3VyOwogICAgICB9IGNhdGNoIChlKSB7fQogICAgfQogIH0KfQpmdW5jdGlvbiBzaG91bGRVcGRhdGVWYWx1ZShlbG0sIGNoZWNrVmFsKSB7CiAgcmV0dXJuICgKICAgIC8vQHRzLWV4cGVjdC1lcnJvcgogICAgIWVsbS5jb21wb3NpbmcgJiYgKGVsbS50YWdOYW1lID09PSAnT1BUSU9OJyB8fCBpc05vdEluRm9jdXNBbmREaXJ0eShlbG0sIGNoZWNrVmFsKSB8fCBpc0RpcnR5V2l0aE1vZGlmaWVycyhlbG0sIGNoZWNrVmFsKSkKICApOwp9CmZ1bmN0aW9uIGlzTm90SW5Gb2N1c0FuZERpcnR5KGVsbSwgY2hlY2tWYWwpIHsKICAvLyByZXR1cm4gdHJ1ZSB3aGVuIHRleHRib3ggKC5udW1iZXIgYW5kIC50cmltKSBsb3NlcyBmb2N1cyBhbmQgaXRzIHZhbHVlIGlzCiAgLy8gbm90IGVxdWFsIHRvIHRoZSB1cGRhdGVkIHZhbHVlCiAgdmFyIG5vdEluRm9jdXMgPSB0cnVlOwogIC8vICM2MTU3CiAgLy8gd29yayBhcm91bmQgSUUgYnVnIHdoZW4gYWNjZXNzaW5nIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaW4gYW4gaWZyYW1lCiAgdHJ5IHsKICAgIG5vdEluRm9jdXMgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICE9PSBlbG07CiAgfSBjYXRjaCAoZSkge30KICByZXR1cm4gbm90SW5Gb2N1cyAmJiBlbG0udmFsdWUgIT09IGNoZWNrVmFsOwp9CmZ1bmN0aW9uIGlzRGlydHlXaXRoTW9kaWZpZXJzKGVsbSwgbmV3VmFsKSB7CiAgdmFyIHZhbHVlID0gZWxtLnZhbHVlOwogIHZhciBtb2RpZmllcnMgPSBlbG0uX3ZNb2RpZmllcnM7IC8vIGluamVjdGVkIGJ5IHYtbW9kZWwgcnVudGltZQogIGlmIChpc0RlZihtb2RpZmllcnMpKSB7CiAgICBpZiAobW9kaWZpZXJzLm51bWJlcikgewogICAgICByZXR1cm4gdG9OdW1iZXIodmFsdWUpICE9PSB0b051bWJlcihuZXdWYWwpOwogICAgfQogICAgaWYgKG1vZGlmaWVycy50cmltKSB7CiAgICAgIHJldHVybiB2YWx1ZS50cmltKCkgIT09IG5ld1ZhbC50cmltKCk7CiAgICB9CiAgfQogIHJldHVybiB2YWx1ZSAhPT0gbmV3VmFsOwp9CnZhciBkb21Qcm9wcyA9IHsKICBjcmVhdGU6IHVwZGF0ZURPTVByb3BzLAogIHVwZGF0ZTogdXBkYXRlRE9NUHJvcHMKfTsKdmFyIHBhcnNlU3R5bGVUZXh0ID0gY2FjaGVkKGZ1bmN0aW9uIChjc3NUZXh0KSB7CiAgdmFyIHJlcyA9IHt9OwogIHZhciBsaXN0RGVsaW1pdGVyID0gLzsoPyFbXihdKlwpKS9nOwogIHZhciBwcm9wZXJ0eURlbGltaXRlciA9IC86KC4rKS87CiAgY3NzVGV4dC5zcGxpdChsaXN0RGVsaW1pdGVyKS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICBpZiAoaXRlbSkgewogICAgICB2YXIgdG1wID0gaXRlbS5zcGxpdChwcm9wZXJ0eURlbGltaXRlcik7CiAgICAgIHRtcC5sZW5ndGggPiAxICYmIChyZXNbdG1wWzBdLnRyaW0oKV0gPSB0bXBbMV0udHJpbSgpKTsKICAgIH0KICB9KTsKICByZXR1cm4gcmVzOwp9KTsKLy8gbWVyZ2Ugc3RhdGljIGFuZCBkeW5hbWljIHN0eWxlIGRhdGEgb24gdGhlIHNhbWUgdm5vZGUKZnVuY3Rpb24gbm9ybWFsaXplU3R5bGVEYXRhKGRhdGEpIHsKICB2YXIgc3R5bGUgPSBub3JtYWxpemVTdHlsZUJpbmRpbmcoZGF0YS5zdHlsZSk7CiAgLy8gc3RhdGljIHN0eWxlIGlzIHByZS1wcm9jZXNzZWQgaW50byBhbiBvYmplY3QgZHVyaW5nIGNvbXBpbGF0aW9uCiAgLy8gYW5kIGlzIGFsd2F5cyBhIGZyZXNoIG9iamVjdCwgc28gaXQncyBzYWZlIHRvIG1lcmdlIGludG8gaXQKICByZXR1cm4gZGF0YS5zdGF0aWNTdHlsZSA/IGV4dGVuZChkYXRhLnN0YXRpY1N0eWxlLCBzdHlsZSkgOiBzdHlsZTsKfQovLyBub3JtYWxpemUgcG9zc2libGUgYXJyYXkgLyBzdHJpbmcgdmFsdWVzIGludG8gT2JqZWN0CmZ1bmN0aW9uIG5vcm1hbGl6ZVN0eWxlQmluZGluZyhiaW5kaW5nU3R5bGUpIHsKICBpZiAoQXJyYXkuaXNBcnJheShiaW5kaW5nU3R5bGUpKSB7CiAgICByZXR1cm4gdG9PYmplY3QoYmluZGluZ1N0eWxlKTsKICB9CiAgaWYgKHR5cGVvZiBiaW5kaW5nU3R5bGUgPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gcGFyc2VTdHlsZVRleHQoYmluZGluZ1N0eWxlKTsKICB9CiAgcmV0dXJuIGJpbmRpbmdTdHlsZTsKfQovKioKICogcGFyZW50IGNvbXBvbmVudCBzdHlsZSBzaG91bGQgYmUgYWZ0ZXIgY2hpbGQncwogKiBzbyB0aGF0IHBhcmVudCBjb21wb25lbnQncyBzdHlsZSBjb3VsZCBvdmVycmlkZSBpdAogKi8KZnVuY3Rpb24gZ2V0U3R5bGUodm5vZGUsIGNoZWNrQ2hpbGQpIHsKICB2YXIgcmVzID0ge307CiAgdmFyIHN0eWxlRGF0YTsKICBpZiAoY2hlY2tDaGlsZCkgewogICAgdmFyIGNoaWxkTm9kZSA9IHZub2RlOwogICAgd2hpbGUgKGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZSkgewogICAgICBjaGlsZE5vZGUgPSBjaGlsZE5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlOwogICAgICBpZiAoY2hpbGROb2RlICYmIGNoaWxkTm9kZS5kYXRhICYmIChzdHlsZURhdGEgPSBub3JtYWxpemVTdHlsZURhdGEoY2hpbGROb2RlLmRhdGEpKSkgewogICAgICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgICAgIH0KICAgIH0KICB9CiAgaWYgKHN0eWxlRGF0YSA9IG5vcm1hbGl6ZVN0eWxlRGF0YSh2bm9kZS5kYXRhKSkgewogICAgZXh0ZW5kKHJlcywgc3R5bGVEYXRhKTsKICB9CiAgdmFyIHBhcmVudE5vZGUgPSB2bm9kZTsKICAvLyBAdHMtZXhwZWN0LWVycm9yIHBhcmVudE5vZGUucGFyZW50IG5vdCBWTm9kZVdpdGhEYXRhCiAgd2hpbGUgKHBhcmVudE5vZGUgPSBwYXJlbnROb2RlLnBhcmVudCkgewogICAgaWYgKHBhcmVudE5vZGUuZGF0YSAmJiAoc3R5bGVEYXRhID0gbm9ybWFsaXplU3R5bGVEYXRhKHBhcmVudE5vZGUuZGF0YSkpKSB7CiAgICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgICB9CiAgfQogIHJldHVybiByZXM7Cn0KdmFyIGNzc1ZhclJFID0gL14tLS87CnZhciBpbXBvcnRhbnRSRSA9IC9ccyohaW1wb3J0YW50JC87CnZhciBzZXRQcm9wID0gZnVuY3Rpb24gc2V0UHJvcChlbCwgbmFtZSwgdmFsKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKGNzc1ZhclJFLnRlc3QobmFtZSkpIHsKICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsIHZhbCk7CiAgfSBlbHNlIGlmIChpbXBvcnRhbnRSRS50ZXN0KHZhbCkpIHsKICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KGh5cGhlbmF0ZShuYW1lKSwgdmFsLnJlcGxhY2UoaW1wb3J0YW50UkUsICcnKSwgJ2ltcG9ydGFudCcpOwogIH0gZWxzZSB7CiAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSBub3JtYWxpemUobmFtZSk7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICAgIC8vIFN1cHBvcnQgdmFsdWVzIGFycmF5IGNyZWF0ZWQgYnkgYXV0b3ByZWZpeGVyLCBlLmcuCiAgICAgIC8vIHtkaXNwbGF5OiBbIi13ZWJraXQtYm94IiwgIi1tcy1mbGV4Ym94IiwgImZsZXgiXX0KICAgICAgLy8gU2V0IHRoZW0gb25lIGJ5IG9uZSwgYW5kIHRoZSBicm93c2VyIHdpbGwgb25seSBzZXQgdGhvc2UgaXQgY2FuIHJlY29nbml6ZQogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdmFsLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgZWwuc3R5bGVbbm9ybWFsaXplZE5hbWVdID0gdmFsW2ldOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZVtub3JtYWxpemVkTmFtZV0gPSB2YWw7CiAgICB9CiAgfQp9Owp2YXIgdmVuZG9yTmFtZXMgPSBbJ1dlYmtpdCcsICdNb3onLCAnbXMnXTsKdmFyIGVtcHR5U3R5bGU7CnZhciBub3JtYWxpemUgPSBjYWNoZWQoZnVuY3Rpb24gKHByb3ApIHsKICBlbXB0eVN0eWxlID0gZW1wdHlTdHlsZSB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5zdHlsZTsKICBwcm9wID0gY2FtZWxpemUocHJvcCk7CiAgaWYgKHByb3AgIT09ICdmaWx0ZXInICYmIHByb3AgaW4gZW1wdHlTdHlsZSkgewogICAgcmV0dXJuIHByb3A7CiAgfQogIHZhciBjYXBOYW1lID0gcHJvcC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHByb3Auc2xpY2UoMSk7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB2ZW5kb3JOYW1lcy5sZW5ndGg7IGkrKykgewogICAgdmFyIG5hbWVfMSA9IHZlbmRvck5hbWVzW2ldICsgY2FwTmFtZTsKICAgIGlmIChuYW1lXzEgaW4gZW1wdHlTdHlsZSkgewogICAgICByZXR1cm4gbmFtZV8xOwogICAgfQogIH0KfSk7CmZ1bmN0aW9uIHVwZGF0ZVN0eWxlKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICB2YXIgb2xkRGF0YSA9IG9sZFZub2RlLmRhdGE7CiAgaWYgKGlzVW5kZWYoZGF0YS5zdGF0aWNTdHlsZSkgJiYgaXNVbmRlZihkYXRhLnN0eWxlKSAmJiBpc1VuZGVmKG9sZERhdGEuc3RhdGljU3R5bGUpICYmIGlzVW5kZWYob2xkRGF0YS5zdHlsZSkpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGN1ciwgbmFtZTsKICB2YXIgZWwgPSB2bm9kZS5lbG07CiAgdmFyIG9sZFN0YXRpY1N0eWxlID0gb2xkRGF0YS5zdGF0aWNTdHlsZTsKICB2YXIgb2xkU3R5bGVCaW5kaW5nID0gb2xkRGF0YS5ub3JtYWxpemVkU3R5bGUgfHwgb2xkRGF0YS5zdHlsZSB8fCB7fTsKICAvLyBpZiBzdGF0aWMgc3R5bGUgZXhpc3RzLCBzdHlsZWJpbmRpbmcgYWxyZWFkeSBtZXJnZWQgaW50byBpdCB3aGVuIGRvaW5nIG5vcm1hbGl6ZVN0eWxlRGF0YQogIHZhciBvbGRTdHlsZSA9IG9sZFN0YXRpY1N0eWxlIHx8IG9sZFN0eWxlQmluZGluZzsKICB2YXIgc3R5bGUgPSBub3JtYWxpemVTdHlsZUJpbmRpbmcodm5vZGUuZGF0YS5zdHlsZSkgfHwge307CiAgLy8gc3RvcmUgbm9ybWFsaXplZCBzdHlsZSB1bmRlciBhIGRpZmZlcmVudCBrZXkgZm9yIG5leHQgZGlmZgogIC8vIG1ha2Ugc3VyZSB0byBjbG9uZSBpdCBpZiBpdCdzIHJlYWN0aXZlLCBzaW5jZSB0aGUgdXNlciBsaWtlbHkgd2FudHMKICAvLyB0byBtdXRhdGUgaXQuCiAgdm5vZGUuZGF0YS5ub3JtYWxpemVkU3R5bGUgPSBpc0RlZihzdHlsZS5fX29iX18pID8gZXh0ZW5kKHt9LCBzdHlsZSkgOiBzdHlsZTsKICB2YXIgbmV3U3R5bGUgPSBnZXRTdHlsZSh2bm9kZSwgdHJ1ZSk7CiAgZm9yIChuYW1lIGluIG9sZFN0eWxlKSB7CiAgICBpZiAoaXNVbmRlZihuZXdTdHlsZVtuYW1lXSkpIHsKICAgICAgc2V0UHJvcChlbCwgbmFtZSwgJycpOwogICAgfQogIH0KICBmb3IgKG5hbWUgaW4gbmV3U3R5bGUpIHsKICAgIGN1ciA9IG5ld1N0eWxlW25hbWVdOwogICAgaWYgKGN1ciAhPT0gb2xkU3R5bGVbbmFtZV0pIHsKICAgICAgLy8gaWU5IHNldHRpbmcgdG8gbnVsbCBoYXMgbm8gZWZmZWN0LCBtdXN0IHVzZSBlbXB0eSBzdHJpbmcKICAgICAgc2V0UHJvcChlbCwgbmFtZSwgY3VyID09IG51bGwgPyAnJyA6IGN1cik7CiAgICB9CiAgfQp9CnZhciBzdHlsZSA9IHsKICBjcmVhdGU6IHVwZGF0ZVN0eWxlLAogIHVwZGF0ZTogdXBkYXRlU3R5bGUKfTsKdmFyIHdoaXRlc3BhY2VSRSA9IC9ccysvOwovKioKICogQWRkIGNsYXNzIHdpdGggY29tcGF0aWJpbGl0eSBmb3IgU1ZHIHNpbmNlIGNsYXNzTGlzdCBpcyBub3Qgc3VwcG9ydGVkIG9uCiAqIFNWRyBlbGVtZW50cyBpbiBJRQogKi8KZnVuY3Rpb24gYWRkQ2xhc3MoZWwsIGNscykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmICghY2xzIHx8ICEoY2xzID0gY2xzLnRyaW0oKSkpIHsKICAgIHJldHVybjsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICBpZiAoY2xzLmluZGV4T2YoJyAnKSA+IC0xKSB7CiAgICAgIGNscy5zcGxpdCh3aGl0ZXNwYWNlUkUpLmZvckVhY2goZnVuY3Rpb24gKGMpIHsKICAgICAgICByZXR1cm4gZWwuY2xhc3NMaXN0LmFkZChjKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBlbC5jbGFzc0xpc3QuYWRkKGNscyk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBjdXIgPSAiICIuY29uY2F0KGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJywgIiAiKTsKICAgIGlmIChjdXIuaW5kZXhPZignICcgKyBjbHMgKyAnICcpIDwgMCkgewogICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgKGN1ciArIGNscykudHJpbSgpKTsKICAgIH0KICB9Cn0KLyoqCiAqIFJlbW92ZSBjbGFzcyB3aXRoIGNvbXBhdGliaWxpdHkgZm9yIFNWRyBzaW5jZSBjbGFzc0xpc3QgaXMgbm90IHN1cHBvcnRlZCBvbgogKiBTVkcgZWxlbWVudHMgaW4gSUUKICovCmZ1bmN0aW9uIHJlbW92ZUNsYXNzKGVsLCBjbHMpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoIWNscyB8fCAhKGNscyA9IGNscy50cmltKCkpKSB7CiAgICByZXR1cm47CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgaWYgKGNscy5pbmRleE9mKCcgJykgPiAtMSkgewogICAgICBjbHMuc3BsaXQod2hpdGVzcGFjZVJFKS5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgcmV0dXJuIGVsLmNsYXNzTGlzdC5yZW1vdmUoYyk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjbHMpOwogICAgfQogICAgaWYgKCFlbC5jbGFzc0xpc3QubGVuZ3RoKSB7CiAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZSgnY2xhc3MnKTsKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGN1ciA9ICIgIi5jb25jYXQoZWwuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnLCAiICIpOwogICAgdmFyIHRhciA9ICcgJyArIGNscyArICcgJzsKICAgIHdoaWxlIChjdXIuaW5kZXhPZih0YXIpID49IDApIHsKICAgICAgY3VyID0gY3VyLnJlcGxhY2UodGFyLCAnICcpOwogICAgfQogICAgY3VyID0gY3VyLnRyaW0oKTsKICAgIGlmIChjdXIpIHsKICAgICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsIGN1cik7CiAgICB9IGVsc2UgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2NsYXNzJyk7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHJlc29sdmVUcmFuc2l0aW9uKGRlZikgewogIGlmICghZGVmKSB7CiAgICByZXR1cm47CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgaWYgKHR5cGVvZiBkZWYgPT09ICdvYmplY3QnKSB7CiAgICB2YXIgcmVzID0ge307CiAgICBpZiAoZGVmLmNzcyAhPT0gZmFsc2UpIHsKICAgICAgZXh0ZW5kKHJlcywgYXV0b0Nzc1RyYW5zaXRpb24oZGVmLm5hbWUgfHwgJ3YnKSk7CiAgICB9CiAgICBleHRlbmQocmVzLCBkZWYpOwogICAgcmV0dXJuIHJlczsKICB9IGVsc2UgaWYgKHR5cGVvZiBkZWYgPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gYXV0b0Nzc1RyYW5zaXRpb24oZGVmKTsKICB9Cn0KdmFyIGF1dG9Dc3NUcmFuc2l0aW9uID0gY2FjaGVkKGZ1bmN0aW9uIChuYW1lKSB7CiAgcmV0dXJuIHsKICAgIGVudGVyQ2xhc3M6ICIiLmNvbmNhdChuYW1lLCAiLWVudGVyIiksCiAgICBlbnRlclRvQ2xhc3M6ICIiLmNvbmNhdChuYW1lLCAiLWVudGVyLXRvIiksCiAgICBlbnRlckFjdGl2ZUNsYXNzOiAiIi5jb25jYXQobmFtZSwgIi1lbnRlci1hY3RpdmUiKSwKICAgIGxlYXZlQ2xhc3M6ICIiLmNvbmNhdChuYW1lLCAiLWxlYXZlIiksCiAgICBsZWF2ZVRvQ2xhc3M6ICIiLmNvbmNhdChuYW1lLCAiLWxlYXZlLXRvIiksCiAgICBsZWF2ZUFjdGl2ZUNsYXNzOiAiIi5jb25jYXQobmFtZSwgIi1sZWF2ZS1hY3RpdmUiKQogIH07Cn0pOwp2YXIgaGFzVHJhbnNpdGlvbiA9IGluQnJvd3NlciAmJiAhaXNJRTk7CnZhciBUUkFOU0lUSU9OID0gJ3RyYW5zaXRpb24nOwp2YXIgQU5JTUFUSU9OID0gJ2FuaW1hdGlvbic7Ci8vIFRyYW5zaXRpb24gcHJvcGVydHkvZXZlbnQgc25pZmZpbmcKdmFyIHRyYW5zaXRpb25Qcm9wID0gJ3RyYW5zaXRpb24nOwp2YXIgdHJhbnNpdGlvbkVuZEV2ZW50ID0gJ3RyYW5zaXRpb25lbmQnOwp2YXIgYW5pbWF0aW9uUHJvcCA9ICdhbmltYXRpb24nOwp2YXIgYW5pbWF0aW9uRW5kRXZlbnQgPSAnYW5pbWF0aW9uZW5kJzsKaWYgKGhhc1RyYW5zaXRpb24pIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAod2luZG93Lm9udHJhbnNpdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdHRyYW5zaXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgdHJhbnNpdGlvblByb3AgPSAnV2Via2l0VHJhbnNpdGlvbic7CiAgICB0cmFuc2l0aW9uRW5kRXZlbnQgPSAnd2Via2l0VHJhbnNpdGlvbkVuZCc7CiAgfQogIGlmICh3aW5kb3cub25hbmltYXRpb25lbmQgPT09IHVuZGVmaW5lZCAmJiB3aW5kb3cub253ZWJraXRhbmltYXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgYW5pbWF0aW9uUHJvcCA9ICdXZWJraXRBbmltYXRpb24nOwogICAgYW5pbWF0aW9uRW5kRXZlbnQgPSAnd2Via2l0QW5pbWF0aW9uRW5kJzsKICB9Cn0KLy8gYmluZGluZyB0byB3aW5kb3cgaXMgbmVjZXNzYXJ5IHRvIG1ha2UgaG90IHJlbG9hZCB3b3JrIGluIElFIGluIHN0cmljdCBtb2RlCnZhciByYWYgPSBpbkJyb3dzZXIgPyB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS5iaW5kKHdpbmRvdykgOiBzZXRUaW1lb3V0IDogLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9mdW5jdGlvbiAoIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovZm4pIHsKICByZXR1cm4gZm4oKTsKfTsKZnVuY3Rpb24gbmV4dEZyYW1lKGZuKSB7CiAgcmFmKGZ1bmN0aW9uICgpIHsKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgIHJhZihmbik7CiAgfSk7Cn0KZnVuY3Rpb24gYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBjbHMpIHsKICB2YXIgdHJhbnNpdGlvbkNsYXNzZXMgPSBlbC5fdHJhbnNpdGlvbkNsYXNzZXMgfHwgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcyA9IFtdKTsKICBpZiAodHJhbnNpdGlvbkNsYXNzZXMuaW5kZXhPZihjbHMpIDwgMCkgewogICAgdHJhbnNpdGlvbkNsYXNzZXMucHVzaChjbHMpOwogICAgYWRkQ2xhc3MoZWwsIGNscyk7CiAgfQp9CmZ1bmN0aW9uIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgY2xzKSB7CiAgaWYgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcykgewogICAgcmVtb3ZlJDIoZWwuX3RyYW5zaXRpb25DbGFzc2VzLCBjbHMpOwogIH0KICByZW1vdmVDbGFzcyhlbCwgY2xzKTsKfQpmdW5jdGlvbiB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIGV4cGVjdGVkVHlwZSwgY2IpIHsKICB2YXIgX2EgPSBnZXRUcmFuc2l0aW9uSW5mbyhlbCwgZXhwZWN0ZWRUeXBlKSwKICAgIHR5cGUgPSBfYS50eXBlLAogICAgdGltZW91dCA9IF9hLnRpbWVvdXQsCiAgICBwcm9wQ291bnQgPSBfYS5wcm9wQ291bnQ7CiAgaWYgKCF0eXBlKSByZXR1cm4gY2IoKTsKICB2YXIgZXZlbnQgPSB0eXBlID09PSBUUkFOU0lUSU9OID8gdHJhbnNpdGlvbkVuZEV2ZW50IDogYW5pbWF0aW9uRW5kRXZlbnQ7CiAgdmFyIGVuZGVkID0gMDsKICB2YXIgZW5kID0gZnVuY3Rpb24gZW5kKCkgewogICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudCwgb25FbmQpOwogICAgY2IoKTsKICB9OwogIHZhciBvbkVuZCA9IGZ1bmN0aW9uIG9uRW5kKGUpIHsKICAgIGlmIChlLnRhcmdldCA9PT0gZWwpIHsKICAgICAgaWYgKCsrZW5kZWQgPj0gcHJvcENvdW50KSB7CiAgICAgICAgZW5kKCk7CiAgICAgIH0KICAgIH0KICB9OwogIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgaWYgKGVuZGVkIDwgcHJvcENvdW50KSB7CiAgICAgIGVuZCgpOwogICAgfQogIH0sIHRpbWVvdXQgKyAxKTsKICBlbC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBvbkVuZCk7Cn0KdmFyIHRyYW5zZm9ybVJFID0gL1xiKHRyYW5zZm9ybXxhbGwpKCx8JCkvOwpmdW5jdGlvbiBnZXRUcmFuc2l0aW9uSW5mbyhlbCwgZXhwZWN0ZWRUeXBlKSB7CiAgdmFyIHN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKTsKICAvLyBKU0RPTSBtYXkgcmV0dXJuIHVuZGVmaW5lZCBmb3IgdHJhbnNpdGlvbiBwcm9wZXJ0aWVzCiAgdmFyIHRyYW5zaXRpb25EZWxheXMgPSAoc3R5bGVzW3RyYW5zaXRpb25Qcm9wICsgJ0RlbGF5J10gfHwgJycpLnNwbGl0KCcsICcpOwogIHZhciB0cmFuc2l0aW9uRHVyYXRpb25zID0gKHN0eWxlc1t0cmFuc2l0aW9uUHJvcCArICdEdXJhdGlvbiddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICB2YXIgdHJhbnNpdGlvblRpbWVvdXQgPSBnZXRUaW1lb3V0KHRyYW5zaXRpb25EZWxheXMsIHRyYW5zaXRpb25EdXJhdGlvbnMpOwogIHZhciBhbmltYXRpb25EZWxheXMgPSAoc3R5bGVzW2FuaW1hdGlvblByb3AgKyAnRGVsYXknXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgdmFyIGFuaW1hdGlvbkR1cmF0aW9ucyA9IChzdHlsZXNbYW5pbWF0aW9uUHJvcCArICdEdXJhdGlvbiddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICB2YXIgYW5pbWF0aW9uVGltZW91dCA9IGdldFRpbWVvdXQoYW5pbWF0aW9uRGVsYXlzLCBhbmltYXRpb25EdXJhdGlvbnMpOwogIHZhciB0eXBlOwogIHZhciB0aW1lb3V0ID0gMDsKICB2YXIgcHJvcENvdW50ID0gMDsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoZXhwZWN0ZWRUeXBlID09PSBUUkFOU0lUSU9OKSB7CiAgICBpZiAodHJhbnNpdGlvblRpbWVvdXQgPiAwKSB7CiAgICAgIHR5cGUgPSBUUkFOU0lUSU9OOwogICAgICB0aW1lb3V0ID0gdHJhbnNpdGlvblRpbWVvdXQ7CiAgICAgIHByb3BDb3VudCA9IHRyYW5zaXRpb25EdXJhdGlvbnMubGVuZ3RoOwogICAgfQogIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSBBTklNQVRJT04pIHsKICAgIGlmIChhbmltYXRpb25UaW1lb3V0ID4gMCkgewogICAgICB0eXBlID0gQU5JTUFUSU9OOwogICAgICB0aW1lb3V0ID0gYW5pbWF0aW9uVGltZW91dDsKICAgICAgcHJvcENvdW50ID0gYW5pbWF0aW9uRHVyYXRpb25zLmxlbmd0aDsKICAgIH0KICB9IGVsc2UgewogICAgdGltZW91dCA9IE1hdGgubWF4KHRyYW5zaXRpb25UaW1lb3V0LCBhbmltYXRpb25UaW1lb3V0KTsKICAgIHR5cGUgPSB0aW1lb3V0ID4gMCA/IHRyYW5zaXRpb25UaW1lb3V0ID4gYW5pbWF0aW9uVGltZW91dCA/IFRSQU5TSVRJT04gOiBBTklNQVRJT04gOiBudWxsOwogICAgcHJvcENvdW50ID0gdHlwZSA/IHR5cGUgPT09IFRSQU5TSVRJT04gPyB0cmFuc2l0aW9uRHVyYXRpb25zLmxlbmd0aCA6IGFuaW1hdGlvbkR1cmF0aW9ucy5sZW5ndGggOiAwOwogIH0KICB2YXIgaGFzVHJhbnNmb3JtID0gdHlwZSA9PT0gVFJBTlNJVElPTiAmJiB0cmFuc2Zvcm1SRS50ZXN0KHN0eWxlc1t0cmFuc2l0aW9uUHJvcCArICdQcm9wZXJ0eSddKTsKICByZXR1cm4gewogICAgdHlwZTogdHlwZSwKICAgIHRpbWVvdXQ6IHRpbWVvdXQsCiAgICBwcm9wQ291bnQ6IHByb3BDb3VudCwKICAgIGhhc1RyYW5zZm9ybTogaGFzVHJhbnNmb3JtCiAgfTsKfQpmdW5jdGlvbiBnZXRUaW1lb3V0KGRlbGF5cywgZHVyYXRpb25zKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICB3aGlsZSAoZGVsYXlzLmxlbmd0aCA8IGR1cmF0aW9ucy5sZW5ndGgpIHsKICAgIGRlbGF5cyA9IGRlbGF5cy5jb25jYXQoZGVsYXlzKTsKICB9CiAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KG51bGwsIGR1cmF0aW9ucy5tYXAoZnVuY3Rpb24gKGQsIGkpIHsKICAgIHJldHVybiB0b01zKGQpICsgdG9NcyhkZWxheXNbaV0pOwogIH0pKTsKfQovLyBPbGQgdmVyc2lvbnMgb2YgQ2hyb21pdW0gKGJlbG93IDYxLjAuMzE2My4xMDApIGZvcm1hdHMgZmxvYXRpbmcgcG9pbnRlciBudW1iZXJzCi8vIGluIGEgbG9jYWxlLWRlcGVuZGVudCB3YXksIHVzaW5nIGEgY29tbWEgaW5zdGVhZCBvZiBhIGRvdC4KLy8gSWYgY29tbWEgaXMgbm90IHJlcGxhY2VkIHdpdGggYSBkb3QsIHRoZSBpbnB1dCB3aWxsIGJlIHJvdW5kZWQgZG93biAoaS5lLiBhY3RpbmcKLy8gYXMgYSBmbG9vciBmdW5jdGlvbikgY2F1c2luZyB1bmV4cGVjdGVkIGJlaGF2aW9ycwpmdW5jdGlvbiB0b01zKHMpIHsKICByZXR1cm4gTnVtYmVyKHMuc2xpY2UoMCwgLTEpLnJlcGxhY2UoJywnLCAnLicpKSAqIDEwMDA7Cn0KZnVuY3Rpb24gZW50ZXIodm5vZGUsIHRvZ2dsZURpc3BsYXkpIHsKICB2YXIgZWwgPSB2bm9kZS5lbG07CiAgLy8gY2FsbCBsZWF2ZSBjYWxsYmFjayBub3cKICBpZiAoaXNEZWYoZWwuX2xlYXZlQ2IpKSB7CiAgICBlbC5fbGVhdmVDYi5jYW5jZWxsZWQgPSB0cnVlOwogICAgZWwuX2xlYXZlQ2IoKTsKICB9CiAgdmFyIGRhdGEgPSByZXNvbHZlVHJhbnNpdGlvbih2bm9kZS5kYXRhLnRyYW5zaXRpb24pOwogIGlmIChpc1VuZGVmKGRhdGEpKSB7CiAgICByZXR1cm47CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChpc0RlZihlbC5fZW50ZXJDYikgfHwgZWwubm9kZVR5cGUgIT09IDEpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGNzcyA9IGRhdGEuY3NzLAogICAgdHlwZSA9IGRhdGEudHlwZSwKICAgIGVudGVyQ2xhc3MgPSBkYXRhLmVudGVyQ2xhc3MsCiAgICBlbnRlclRvQ2xhc3MgPSBkYXRhLmVudGVyVG9DbGFzcywKICAgIGVudGVyQWN0aXZlQ2xhc3MgPSBkYXRhLmVudGVyQWN0aXZlQ2xhc3MsCiAgICBhcHBlYXJDbGFzcyA9IGRhdGEuYXBwZWFyQ2xhc3MsCiAgICBhcHBlYXJUb0NsYXNzID0gZGF0YS5hcHBlYXJUb0NsYXNzLAogICAgYXBwZWFyQWN0aXZlQ2xhc3MgPSBkYXRhLmFwcGVhckFjdGl2ZUNsYXNzLAogICAgYmVmb3JlRW50ZXIgPSBkYXRhLmJlZm9yZUVudGVyLAogICAgZW50ZXIgPSBkYXRhLmVudGVyLAogICAgYWZ0ZXJFbnRlciA9IGRhdGEuYWZ0ZXJFbnRlciwKICAgIGVudGVyQ2FuY2VsbGVkID0gZGF0YS5lbnRlckNhbmNlbGxlZCwKICAgIGJlZm9yZUFwcGVhciA9IGRhdGEuYmVmb3JlQXBwZWFyLAogICAgYXBwZWFyID0gZGF0YS5hcHBlYXIsCiAgICBhZnRlckFwcGVhciA9IGRhdGEuYWZ0ZXJBcHBlYXIsCiAgICBhcHBlYXJDYW5jZWxsZWQgPSBkYXRhLmFwcGVhckNhbmNlbGxlZCwKICAgIGR1cmF0aW9uID0gZGF0YS5kdXJhdGlvbjsKICAvLyBhY3RpdmVJbnN0YW5jZSB3aWxsIGFsd2F5cyBiZSB0aGUgPHRyYW5zaXRpb24+IGNvbXBvbmVudCBtYW5hZ2luZyB0aGlzCiAgLy8gdHJhbnNpdGlvbi4gT25lIGVkZ2UgY2FzZSB0byBjaGVjayBpcyB3aGVuIHRoZSA8dHJhbnNpdGlvbj4gaXMgcGxhY2VkCiAgLy8gYXMgdGhlIHJvb3Qgbm9kZSBvZiBhIGNoaWxkIGNvbXBvbmVudC4gSW4gdGhhdCBjYXNlIHdlIG5lZWQgdG8gY2hlY2sKICAvLyA8dHJhbnNpdGlvbj4ncyBwYXJlbnQgZm9yIGFwcGVhciBjaGVjay4KICB2YXIgY29udGV4dCA9IGFjdGl2ZUluc3RhbmNlOwogIHZhciB0cmFuc2l0aW9uTm9kZSA9IGFjdGl2ZUluc3RhbmNlLiR2bm9kZTsKICB3aGlsZSAodHJhbnNpdGlvbk5vZGUgJiYgdHJhbnNpdGlvbk5vZGUucGFyZW50KSB7CiAgICBjb250ZXh0ID0gdHJhbnNpdGlvbk5vZGUuY29udGV4dDsKICAgIHRyYW5zaXRpb25Ob2RlID0gdHJhbnNpdGlvbk5vZGUucGFyZW50OwogIH0KICB2YXIgaXNBcHBlYXIgPSAhY29udGV4dC5faXNNb3VudGVkIHx8ICF2bm9kZS5pc1Jvb3RJbnNlcnQ7CiAgaWYgKGlzQXBwZWFyICYmICFhcHBlYXIgJiYgYXBwZWFyICE9PSAnJykgewogICAgcmV0dXJuOwogIH0KICB2YXIgc3RhcnRDbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhckNsYXNzID8gYXBwZWFyQ2xhc3MgOiBlbnRlckNsYXNzOwogIHZhciBhY3RpdmVDbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhckFjdGl2ZUNsYXNzID8gYXBwZWFyQWN0aXZlQ2xhc3MgOiBlbnRlckFjdGl2ZUNsYXNzOwogIHZhciB0b0NsYXNzID0gaXNBcHBlYXIgJiYgYXBwZWFyVG9DbGFzcyA/IGFwcGVhclRvQ2xhc3MgOiBlbnRlclRvQ2xhc3M7CiAgdmFyIGJlZm9yZUVudGVySG9vayA9IGlzQXBwZWFyID8gYmVmb3JlQXBwZWFyIHx8IGJlZm9yZUVudGVyIDogYmVmb3JlRW50ZXI7CiAgdmFyIGVudGVySG9vayA9IGlzQXBwZWFyID8gaXNGdW5jdGlvbihhcHBlYXIpID8gYXBwZWFyIDogZW50ZXIgOiBlbnRlcjsKICB2YXIgYWZ0ZXJFbnRlckhvb2sgPSBpc0FwcGVhciA/IGFmdGVyQXBwZWFyIHx8IGFmdGVyRW50ZXIgOiBhZnRlckVudGVyOwogIHZhciBlbnRlckNhbmNlbGxlZEhvb2sgPSBpc0FwcGVhciA/IGFwcGVhckNhbmNlbGxlZCB8fCBlbnRlckNhbmNlbGxlZCA6IGVudGVyQ2FuY2VsbGVkOwogIHZhciBleHBsaWNpdEVudGVyRHVyYXRpb24gPSB0b051bWJlcihpc09iamVjdChkdXJhdGlvbikgPyBkdXJhdGlvbi5lbnRlciA6IGR1cmF0aW9uKTsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBleHBsaWNpdEVudGVyRHVyYXRpb24gIT0gbnVsbCkgewogICAgY2hlY2tEdXJhdGlvbihleHBsaWNpdEVudGVyRHVyYXRpb24sICdlbnRlcicsIHZub2RlKTsKICB9CiAgdmFyIGV4cGVjdHNDU1MgPSBjc3MgIT09IGZhbHNlICYmICFpc0lFOTsKICB2YXIgdXNlcldhbnRzQ29udHJvbCA9IGdldEhvb2tBcmd1bWVudHNMZW5ndGgoZW50ZXJIb29rKTsKICB2YXIgY2IgPSBlbC5fZW50ZXJDYiA9IG9uY2UoZnVuY3Rpb24gKCkgewogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCB0b0NsYXNzKTsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBhY3RpdmVDbGFzcyk7CiAgICB9CiAgICAvLyBAdHMtZXhwZWN0LWVycm9yCiAgICBpZiAoY2IuY2FuY2VsbGVkKSB7CiAgICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBzdGFydENsYXNzKTsKICAgICAgfQogICAgICBlbnRlckNhbmNlbGxlZEhvb2sgJiYgZW50ZXJDYW5jZWxsZWRIb29rKGVsKTsKICAgIH0gZWxzZSB7CiAgICAgIGFmdGVyRW50ZXJIb29rICYmIGFmdGVyRW50ZXJIb29rKGVsKTsKICAgIH0KICAgIGVsLl9lbnRlckNiID0gbnVsbDsKICB9KTsKICBpZiAoIXZub2RlLmRhdGEuc2hvdykgewogICAgLy8gcmVtb3ZlIHBlbmRpbmcgbGVhdmUgZWxlbWVudCBvbiBlbnRlciBieSBpbmplY3RpbmcgYW4gaW5zZXJ0IGhvb2sKICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAnaW5zZXJ0JywgZnVuY3Rpb24gKCkgewogICAgICB2YXIgcGFyZW50ID0gZWwucGFyZW50Tm9kZTsKICAgICAgdmFyIHBlbmRpbmdOb2RlID0gcGFyZW50ICYmIHBhcmVudC5fcGVuZGluZyAmJiBwYXJlbnQuX3BlbmRpbmdbdm5vZGUua2V5XTsKICAgICAgaWYgKHBlbmRpbmdOb2RlICYmIHBlbmRpbmdOb2RlLnRhZyA9PT0gdm5vZGUudGFnICYmIHBlbmRpbmdOb2RlLmVsbS5fbGVhdmVDYikgewogICAgICAgIHBlbmRpbmdOb2RlLmVsbS5fbGVhdmVDYigpOwogICAgICB9CiAgICAgIGVudGVySG9vayAmJiBlbnRlckhvb2soZWwsIGNiKTsKICAgIH0pOwogIH0KICAvLyBzdGFydCBlbnRlciB0cmFuc2l0aW9uCiAgYmVmb3JlRW50ZXJIb29rICYmIGJlZm9yZUVudGVySG9vayhlbCk7CiAgaWYgKGV4cGVjdHNDU1MpIHsKICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgc3RhcnRDbGFzcyk7CiAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGFjdGl2ZUNsYXNzKTsKICAgIG5leHRGcmFtZShmdW5jdGlvbiAoKSB7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgc3RhcnRDbGFzcyk7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgICAgaWYgKCFjYi5jYW5jZWxsZWQpIHsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIHRvQ2xhc3MpOwogICAgICAgIGlmICghdXNlcldhbnRzQ29udHJvbCkgewogICAgICAgICAgaWYgKGlzVmFsaWREdXJhdGlvbihleHBsaWNpdEVudGVyRHVyYXRpb24pKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoY2IsIGV4cGxpY2l0RW50ZXJEdXJhdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIHR5cGUsIGNiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICBpZiAodm5vZGUuZGF0YS5zaG93KSB7CiAgICB0b2dnbGVEaXNwbGF5ICYmIHRvZ2dsZURpc3BsYXkoKTsKICAgIGVudGVySG9vayAmJiBlbnRlckhvb2soZWwsIGNiKTsKICB9CiAgaWYgKCFleHBlY3RzQ1NTICYmICF1c2VyV2FudHNDb250cm9sKSB7CiAgICBjYigpOwogIH0KfQpmdW5jdGlvbiBsZWF2ZSh2bm9kZSwgcm0pIHsKICB2YXIgZWwgPSB2bm9kZS5lbG07CiAgLy8gY2FsbCBlbnRlciBjYWxsYmFjayBub3cKICBpZiAoaXNEZWYoZWwuX2VudGVyQ2IpKSB7CiAgICBlbC5fZW50ZXJDYi5jYW5jZWxsZWQgPSB0cnVlOwogICAgZWwuX2VudGVyQ2IoKTsKICB9CiAgdmFyIGRhdGEgPSByZXNvbHZlVHJhbnNpdGlvbih2bm9kZS5kYXRhLnRyYW5zaXRpb24pOwogIGlmIChpc1VuZGVmKGRhdGEpIHx8IGVsLm5vZGVUeXBlICE9PSAxKSB7CiAgICByZXR1cm4gcm0oKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKGlzRGVmKGVsLl9sZWF2ZUNiKSkgewogICAgcmV0dXJuOwogIH0KICB2YXIgY3NzID0gZGF0YS5jc3MsCiAgICB0eXBlID0gZGF0YS50eXBlLAogICAgbGVhdmVDbGFzcyA9IGRhdGEubGVhdmVDbGFzcywKICAgIGxlYXZlVG9DbGFzcyA9IGRhdGEubGVhdmVUb0NsYXNzLAogICAgbGVhdmVBY3RpdmVDbGFzcyA9IGRhdGEubGVhdmVBY3RpdmVDbGFzcywKICAgIGJlZm9yZUxlYXZlID0gZGF0YS5iZWZvcmVMZWF2ZSwKICAgIGxlYXZlID0gZGF0YS5sZWF2ZSwKICAgIGFmdGVyTGVhdmUgPSBkYXRhLmFmdGVyTGVhdmUsCiAgICBsZWF2ZUNhbmNlbGxlZCA9IGRhdGEubGVhdmVDYW5jZWxsZWQsCiAgICBkZWxheUxlYXZlID0gZGF0YS5kZWxheUxlYXZlLAogICAgZHVyYXRpb24gPSBkYXRhLmR1cmF0aW9uOwogIHZhciBleHBlY3RzQ1NTID0gY3NzICE9PSBmYWxzZSAmJiAhaXNJRTk7CiAgdmFyIHVzZXJXYW50c0NvbnRyb2wgPSBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKGxlYXZlKTsKICB2YXIgZXhwbGljaXRMZWF2ZUR1cmF0aW9uID0gdG9OdW1iZXIoaXNPYmplY3QoZHVyYXRpb24pID8gZHVyYXRpb24ubGVhdmUgOiBkdXJhdGlvbik7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNEZWYoZXhwbGljaXRMZWF2ZUR1cmF0aW9uKSkgewogICAgY2hlY2tEdXJhdGlvbihleHBsaWNpdExlYXZlRHVyYXRpb24sICdsZWF2ZScsIHZub2RlKTsKICB9CiAgdmFyIGNiID0gZWwuX2xlYXZlQ2IgPSBvbmNlKGZ1bmN0aW9uICgpIHsKICAgIGlmIChlbC5wYXJlbnROb2RlICYmIGVsLnBhcmVudE5vZGUuX3BlbmRpbmcpIHsKICAgICAgZWwucGFyZW50Tm9kZS5fcGVuZGluZ1t2bm9kZS5rZXldID0gbnVsbDsKICAgIH0KICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVUb0NsYXNzKTsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUFjdGl2ZUNsYXNzKTsKICAgIH0KICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgIGlmIChjYi5jYW5jZWxsZWQpIHsKICAgICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOwogICAgICB9CiAgICAgIGxlYXZlQ2FuY2VsbGVkICYmIGxlYXZlQ2FuY2VsbGVkKGVsKTsKICAgIH0gZWxzZSB7CiAgICAgIHJtKCk7CiAgICAgIGFmdGVyTGVhdmUgJiYgYWZ0ZXJMZWF2ZShlbCk7CiAgICB9CiAgICBlbC5fbGVhdmVDYiA9IG51bGw7CiAgfSk7CiAgaWYgKGRlbGF5TGVhdmUpIHsKICAgIGRlbGF5TGVhdmUocGVyZm9ybUxlYXZlKTsKICB9IGVsc2UgewogICAgcGVyZm9ybUxlYXZlKCk7CiAgfQogIGZ1bmN0aW9uIHBlcmZvcm1MZWF2ZSgpIHsKICAgIC8vIHRoZSBkZWxheWVkIGxlYXZlIG1heSBoYXZlIGFscmVhZHkgYmVlbiBjYW5jZWxsZWQKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgIGlmIChjYi5jYW5jZWxsZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gcmVjb3JkIGxlYXZpbmcgZWxlbWVudAogICAgaWYgKCF2bm9kZS5kYXRhLnNob3cgJiYgZWwucGFyZW50Tm9kZSkgewogICAgICAoZWwucGFyZW50Tm9kZS5fcGVuZGluZyB8fCAoZWwucGFyZW50Tm9kZS5fcGVuZGluZyA9IHt9KSlbdm5vZGUua2V5XSA9IHZub2RlOwogICAgfQogICAgYmVmb3JlTGVhdmUgJiYgYmVmb3JlTGVhdmUoZWwpOwogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUNsYXNzKTsKICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUFjdGl2ZUNsYXNzKTsKICAgICAgbmV4dEZyYW1lKGZ1bmN0aW9uICgpIHsKICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOwogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgICAgICBpZiAoIWNiLmNhbmNlbGxlZCkgewogICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZVRvQ2xhc3MpOwogICAgICAgICAgaWYgKCF1c2VyV2FudHNDb250cm9sKSB7CiAgICAgICAgICAgIGlmIChpc1ZhbGlkRHVyYXRpb24oZXhwbGljaXRMZWF2ZUR1cmF0aW9uKSkgewogICAgICAgICAgICAgIHNldFRpbWVvdXQoY2IsIGV4cGxpY2l0TGVhdmVEdXJhdGlvbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBjYik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgbGVhdmUgJiYgbGVhdmUoZWwsIGNiKTsKICAgIGlmICghZXhwZWN0c0NTUyAmJiAhdXNlcldhbnRzQ29udHJvbCkgewogICAgICBjYigpOwogICAgfQogIH0KfQovLyBvbmx5IHVzZWQgaW4gZGV2IG1vZGUKZnVuY3Rpb24gY2hlY2tEdXJhdGlvbih2YWwsIG5hbWUsIHZub2RlKSB7CiAgaWYgKHR5cGVvZiB2YWwgIT09ICdudW1iZXInKSB7CiAgICB3YXJuKCI8dHJhbnNpdGlvbj4gZXhwbGljaXQgIi5jb25jYXQobmFtZSwgIiBkdXJhdGlvbiBpcyBub3QgYSB2YWxpZCBudW1iZXIgLSAiKSArICJnb3QgIi5jb25jYXQoSlNPTi5zdHJpbmdpZnkodmFsKSwgIi4iKSwgdm5vZGUuY29udGV4dCk7CiAgfSBlbHNlIGlmIChpc05hTih2YWwpKSB7CiAgICB3YXJuKCI8dHJhbnNpdGlvbj4gZXhwbGljaXQgIi5jb25jYXQobmFtZSwgIiBkdXJhdGlvbiBpcyBOYU4gLSAiKSArICd0aGUgZHVyYXRpb24gZXhwcmVzc2lvbiBtaWdodCBiZSBpbmNvcnJlY3QuJywgdm5vZGUuY29udGV4dCk7CiAgfQp9CmZ1bmN0aW9uIGlzVmFsaWREdXJhdGlvbih2YWwpIHsKICByZXR1cm4gdHlwZW9mIHZhbCA9PT0gJ251bWJlcicgJiYgIWlzTmFOKHZhbCk7Cn0KLyoqCiAqIE5vcm1hbGl6ZSBhIHRyYW5zaXRpb24gaG9vaydzIGFyZ3VtZW50IGxlbmd0aC4gVGhlIGhvb2sgbWF5IGJlOgogKiAtIGEgbWVyZ2VkIGhvb2sgKGludm9rZXIpIHdpdGggdGhlIG9yaWdpbmFsIGluIC5mbnMKICogLSBhIHdyYXBwZWQgY29tcG9uZW50IG1ldGhvZCAoY2hlY2sgLl9sZW5ndGgpCiAqIC0gYSBwbGFpbiBmdW5jdGlvbiAoLmxlbmd0aCkKICovCmZ1bmN0aW9uIGdldEhvb2tBcmd1bWVudHNMZW5ndGgoZm4pIHsKICBpZiAoaXNVbmRlZihmbikpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgLy8gQHRzLWV4cGVjdC1lcnJvcgogIHZhciBpbnZva2VyRm5zID0gZm4uZm5zOwogIGlmIChpc0RlZihpbnZva2VyRm5zKSkgewogICAgLy8gaW52b2tlcgogICAgcmV0dXJuIGdldEhvb2tBcmd1bWVudHNMZW5ndGgoQXJyYXkuaXNBcnJheShpbnZva2VyRm5zKSA/IGludm9rZXJGbnNbMF0gOiBpbnZva2VyRm5zKTsKICB9IGVsc2UgewogICAgLy8gQHRzLWV4cGVjdC1lcnJvcgogICAgcmV0dXJuIChmbi5fbGVuZ3RoIHx8IGZuLmxlbmd0aCkgPiAxOwogIH0KfQpmdW5jdGlvbiBfZW50ZXIoXywgdm5vZGUpIHsKICBpZiAodm5vZGUuZGF0YS5zaG93ICE9PSB0cnVlKSB7CiAgICBlbnRlcih2bm9kZSk7CiAgfQp9CnZhciB0cmFuc2l0aW9uID0gaW5Ccm93c2VyID8gewogIGNyZWF0ZTogX2VudGVyLAogIGFjdGl2YXRlOiBfZW50ZXIsCiAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUodm5vZGUsIHJtKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgaWYgKHZub2RlLmRhdGEuc2hvdyAhPT0gdHJ1ZSkgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yCiAgICAgIGxlYXZlKHZub2RlLCBybSk7CiAgICB9IGVsc2UgewogICAgICBybSgpOwogICAgfQogIH0KfSA6IHt9Owp2YXIgcGxhdGZvcm1Nb2R1bGVzID0gW2F0dHJzLCBrbGFzcywgZXZlbnRzLCBkb21Qcm9wcywgc3R5bGUsIHRyYW5zaXRpb25dOwoKLy8gdGhlIGRpcmVjdGl2ZSBtb2R1bGUgc2hvdWxkIGJlIGFwcGxpZWQgbGFzdCwgYWZ0ZXIgYWxsCi8vIGJ1aWx0LWluIG1vZHVsZXMgaGF2ZSBiZWVuIGFwcGxpZWQuCnZhciBtb2R1bGVzID0gcGxhdGZvcm1Nb2R1bGVzLmNvbmNhdChiYXNlTW9kdWxlcyk7CnZhciBwYXRjaCA9IGNyZWF0ZVBhdGNoRnVuY3Rpb24oewogIG5vZGVPcHM6IG5vZGVPcHMsCiAgbW9kdWxlczogbW9kdWxlcwp9KTsKCi8qKgogKiBOb3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgbGlrZSBhdHRhY2hpbmcKICogcHJvcGVydGllcyB0byBFbGVtZW50cy4KICovCi8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwppZiAoaXNJRTkpIHsKICAvLyBodHRwOi8vd3d3Lm1hdHRzNDExLmNvbS9wb3N0L2ludGVybmV0LWV4cGxvcmVyLTktb25pbnB1dC8KICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZWwgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgLy8gQHRzLWV4cGVjdC1lcnJvcgogICAgaWYgKGVsICYmIGVsLnZtb2RlbCkgewogICAgICB0cmlnZ2VyKGVsLCAnaW5wdXQnKTsKICAgIH0KICB9KTsKfQp2YXIgZGlyZWN0aXZlID0gewogIGluc2VydGVkOiBmdW5jdGlvbiBpbnNlcnRlZChlbCwgYmluZGluZywgdm5vZGUsIG9sZFZub2RlKSB7CiAgICBpZiAodm5vZGUudGFnID09PSAnc2VsZWN0JykgewogICAgICAvLyAjNjkwMwogICAgICBpZiAob2xkVm5vZGUuZWxtICYmICFvbGRWbm9kZS5lbG0uX3ZPcHRpb25zKSB7CiAgICAgICAgbWVyZ2VWTm9kZUhvb2sodm5vZGUsICdwb3N0cGF0Y2gnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkaXJlY3RpdmUuY29tcG9uZW50VXBkYXRlZChlbCwgYmluZGluZywgdm5vZGUpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bm9kZS5jb250ZXh0KTsKICAgICAgfQogICAgICBlbC5fdk9wdGlvbnMgPSBbXS5tYXAuY2FsbChlbC5vcHRpb25zLCBnZXRWYWx1ZSk7CiAgICB9IGVsc2UgaWYgKHZub2RlLnRhZyA9PT0gJ3RleHRhcmVhJyB8fCBpc1RleHRJbnB1dFR5cGUoZWwudHlwZSkpIHsKICAgICAgZWwuX3ZNb2RpZmllcnMgPSBiaW5kaW5nLm1vZGlmaWVyczsKICAgICAgaWYgKCFiaW5kaW5nLm1vZGlmaWVycy5sYXp5KSB7CiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY29tcG9zaXRpb25zdGFydCcsIG9uQ29tcG9zaXRpb25TdGFydCk7CiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY29tcG9zaXRpb25lbmQnLCBvbkNvbXBvc2l0aW9uRW5kKTsKICAgICAgICAvLyBTYWZhcmkgPCAxMC4yICYgVUlXZWJWaWV3IGRvZXNuJ3QgZmlyZSBjb21wb3NpdGlvbmVuZCB3aGVuCiAgICAgICAgLy8gc3dpdGNoaW5nIGZvY3VzIGJlZm9yZSBjb25maXJtaW5nIGNvbXBvc2l0aW9uIGNob2ljZQogICAgICAgIC8vIHRoaXMgYWxzbyBmaXhlcyB0aGUgaXNzdWUgd2hlcmUgc29tZSBicm93c2VycyBlLmcuIGlPUyBDaHJvbWUKICAgICAgICAvLyBmaXJlcyAiY2hhbmdlIiBpbnN0ZWFkIG9mICJpbnB1dCIgb24gYXV0b2NvbXBsZXRlLgogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIG9uQ29tcG9zaXRpb25FbmQpOwogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgIGlmIChpc0lFOSkgewogICAgICAgICAgZWwudm1vZGVsID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LAogIGNvbXBvbmVudFVwZGF0ZWQ6IGZ1bmN0aW9uIGNvbXBvbmVudFVwZGF0ZWQoZWwsIGJpbmRpbmcsIHZub2RlKSB7CiAgICBpZiAodm5vZGUudGFnID09PSAnc2VsZWN0JykgewogICAgICBzZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm5vZGUuY29udGV4dCk7CiAgICAgIC8vIGluIGNhc2UgdGhlIG9wdGlvbnMgcmVuZGVyZWQgYnkgdi1mb3IgaGF2ZSBjaGFuZ2VkLAogICAgICAvLyBpdCdzIHBvc3NpYmxlIHRoYXQgdGhlIHZhbHVlIGlzIG91dC1vZi1zeW5jIHdpdGggdGhlIHJlbmRlcmVkIG9wdGlvbnMuCiAgICAgIC8vIGRldGVjdCBzdWNoIGNhc2VzIGFuZCBmaWx0ZXIgb3V0IHZhbHVlcyB0aGF0IG5vIGxvbmdlciBoYXMgYSBtYXRjaGluZwogICAgICAvLyBvcHRpb24gaW4gdGhlIERPTS4KICAgICAgdmFyIHByZXZPcHRpb25zXzEgPSBlbC5fdk9wdGlvbnM7CiAgICAgIHZhciBjdXJPcHRpb25zXzEgPSBlbC5fdk9wdGlvbnMgPSBbXS5tYXAuY2FsbChlbC5vcHRpb25zLCBnZXRWYWx1ZSk7CiAgICAgIGlmIChjdXJPcHRpb25zXzEuc29tZShmdW5jdGlvbiAobywgaSkgewogICAgICAgIHJldHVybiAhbG9vc2VFcXVhbChvLCBwcmV2T3B0aW9uc18xW2ldKTsKICAgICAgfSkpIHsKICAgICAgICAvLyB0cmlnZ2VyIGNoYW5nZSBldmVudCBpZgogICAgICAgIC8vIG5vIG1hdGNoaW5nIG9wdGlvbiBmb3VuZCBmb3IgYXQgbGVhc3Qgb25lIHZhbHVlCiAgICAgICAgdmFyIG5lZWRSZXNldCA9IGVsLm11bHRpcGxlID8gYmluZGluZy52YWx1ZS5zb21lKGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICByZXR1cm4gaGFzTm9NYXRjaGluZ09wdGlvbih2LCBjdXJPcHRpb25zXzEpOwogICAgICAgIH0pIDogYmluZGluZy52YWx1ZSAhPT0gYmluZGluZy5vbGRWYWx1ZSAmJiBoYXNOb01hdGNoaW5nT3B0aW9uKGJpbmRpbmcudmFsdWUsIGN1ck9wdGlvbnNfMSk7CiAgICAgICAgaWYgKG5lZWRSZXNldCkgewogICAgICAgICAgdHJpZ2dlcihlbCwgJ2NoYW5nZScpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KfTsKZnVuY3Rpb24gc2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKSB7CiAgYWN0dWFsbHlTZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm0pOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChpc0lFIHx8IGlzRWRnZSkgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGFjdHVhbGx5U2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKTsKICAgIH0sIDApOwogIH0KfQpmdW5jdGlvbiBhY3R1YWxseVNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bSkgewogIHZhciB2YWx1ZSA9IGJpbmRpbmcudmFsdWU7CiAgdmFyIGlzTXVsdGlwbGUgPSBlbC5tdWx0aXBsZTsKICBpZiAoaXNNdWx0aXBsZSAmJiAhQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiPHNlbGVjdCBtdWx0aXBsZSB2LW1vZGVsPVwiIi5jb25jYXQoYmluZGluZy5leHByZXNzaW9uLCAiXCI+ICIpICsgImV4cGVjdHMgYW4gQXJyYXkgdmFsdWUgZm9yIGl0cyBiaW5kaW5nLCBidXQgZ290ICIuY29uY2F0KE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpKSwgdm0pOwogICAgcmV0dXJuOwogIH0KICB2YXIgc2VsZWN0ZWQsIG9wdGlvbjsKICBmb3IgKHZhciBpID0gMCwgbCA9IGVsLm9wdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBvcHRpb24gPSBlbC5vcHRpb25zW2ldOwogICAgaWYgKGlzTXVsdGlwbGUpIHsKICAgICAgc2VsZWN0ZWQgPSBsb29zZUluZGV4T2YodmFsdWUsIGdldFZhbHVlKG9wdGlvbikpID4gLTE7CiAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQgIT09IHNlbGVjdGVkKSB7CiAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gc2VsZWN0ZWQ7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChsb29zZUVxdWFsKGdldFZhbHVlKG9wdGlvbiksIHZhbHVlKSkgewogICAgICAgIGlmIChlbC5zZWxlY3RlZEluZGV4ICE9PSBpKSB7CiAgICAgICAgICBlbC5zZWxlY3RlZEluZGV4ID0gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfQogIGlmICghaXNNdWx0aXBsZSkgewogICAgZWwuc2VsZWN0ZWRJbmRleCA9IC0xOwogIH0KfQpmdW5jdGlvbiBoYXNOb01hdGNoaW5nT3B0aW9uKHZhbHVlLCBvcHRpb25zKSB7CiAgcmV0dXJuIG9wdGlvbnMuZXZlcnkoZnVuY3Rpb24gKG8pIHsKICAgIHJldHVybiAhbG9vc2VFcXVhbChvLCB2YWx1ZSk7CiAgfSk7Cn0KZnVuY3Rpb24gZ2V0VmFsdWUob3B0aW9uKSB7CiAgcmV0dXJuICdfdmFsdWUnIGluIG9wdGlvbiA/IG9wdGlvbi5fdmFsdWUgOiBvcHRpb24udmFsdWU7Cn0KZnVuY3Rpb24gb25Db21wb3NpdGlvblN0YXJ0KGUpIHsKICBlLnRhcmdldC5jb21wb3NpbmcgPSB0cnVlOwp9CmZ1bmN0aW9uIG9uQ29tcG9zaXRpb25FbmQoZSkgewogIC8vIHByZXZlbnQgdHJpZ2dlcmluZyBhbiBpbnB1dCBldmVudCBmb3Igbm8gcmVhc29uCiAgaWYgKCFlLnRhcmdldC5jb21wb3NpbmcpIHJldHVybjsKICBlLnRhcmdldC5jb21wb3NpbmcgPSBmYWxzZTsKICB0cmlnZ2VyKGUudGFyZ2V0LCAnaW5wdXQnKTsKfQpmdW5jdGlvbiB0cmlnZ2VyKGVsLCB0eXBlKSB7CiAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogIGUuaW5pdEV2ZW50KHR5cGUsIHRydWUsIHRydWUpOwogIGVsLmRpc3BhdGNoRXZlbnQoZSk7Cn0KCi8vIHJlY3Vyc2l2ZWx5IHNlYXJjaCBmb3IgcG9zc2libGUgdHJhbnNpdGlvbiBkZWZpbmVkIGluc2lkZSB0aGUgY29tcG9uZW50IHJvb3QKZnVuY3Rpb24gbG9jYXRlTm9kZSh2bm9kZSkgewogIC8vIEB0cy1leHBlY3QtZXJyb3IKICByZXR1cm4gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgJiYgKCF2bm9kZS5kYXRhIHx8ICF2bm9kZS5kYXRhLnRyYW5zaXRpb24pID8gbG9jYXRlTm9kZSh2bm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGUpIDogdm5vZGU7Cn0KdmFyIHNob3cgPSB7CiAgYmluZDogZnVuY3Rpb24gYmluZChlbCwgX2EsIHZub2RlKSB7CiAgICB2YXIgdmFsdWUgPSBfYS52YWx1ZTsKICAgIHZub2RlID0gbG9jYXRlTm9kZSh2bm9kZSk7CiAgICB2YXIgdHJhbnNpdGlvbiA9IHZub2RlLmRhdGEgJiYgdm5vZGUuZGF0YS50cmFuc2l0aW9uOwogICAgdmFyIG9yaWdpbmFsRGlzcGxheSA9IGVsLl9fdk9yaWdpbmFsRGlzcGxheSA9IGVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyA/ICcnIDogZWwuc3R5bGUuZGlzcGxheTsKICAgIGlmICh2YWx1ZSAmJiB0cmFuc2l0aW9uKSB7CiAgICAgIHZub2RlLmRhdGEuc2hvdyA9IHRydWU7CiAgICAgIGVudGVyKHZub2RlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IG9yaWdpbmFsRGlzcGxheTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gdmFsdWUgPyBvcmlnaW5hbERpc3BsYXkgOiAnbm9uZSc7CiAgICB9CiAgfSwKICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShlbCwgX2EsIHZub2RlKSB7CiAgICB2YXIgdmFsdWUgPSBfYS52YWx1ZSwKICAgICAgb2xkVmFsdWUgPSBfYS5vbGRWYWx1ZTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKCF2YWx1ZSA9PT0gIW9sZFZhbHVlKSByZXR1cm47CiAgICB2bm9kZSA9IGxvY2F0ZU5vZGUodm5vZGUpOwogICAgdmFyIHRyYW5zaXRpb24gPSB2bm9kZS5kYXRhICYmIHZub2RlLmRhdGEudHJhbnNpdGlvbjsKICAgIGlmICh0cmFuc2l0aW9uKSB7CiAgICAgIHZub2RlLmRhdGEuc2hvdyA9IHRydWU7CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIGVudGVyKHZub2RlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gZWwuX192T3JpZ2luYWxEaXNwbGF5OwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGxlYXZlKHZub2RlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gdmFsdWUgPyBlbC5fX3ZPcmlnaW5hbERpc3BsYXkgOiAnbm9uZSc7CiAgICB9CiAgfSwKICB1bmJpbmQ6IGZ1bmN0aW9uIHVuYmluZChlbCwgYmluZGluZywgdm5vZGUsIG9sZFZub2RlLCBpc0Rlc3Ryb3kpIHsKICAgIGlmICghaXNEZXN0cm95KSB7CiAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBlbC5fX3ZPcmlnaW5hbERpc3BsYXk7CiAgICB9CiAgfQp9Owp2YXIgcGxhdGZvcm1EaXJlY3RpdmVzID0gewogIG1vZGVsOiBkaXJlY3RpdmUsCiAgc2hvdzogc2hvdwp9OwoKLy8gUHJvdmlkZXMgdHJhbnNpdGlvbiBzdXBwb3J0IGZvciBhIHNpbmdsZSBlbGVtZW50L2NvbXBvbmVudC4KdmFyIHRyYW5zaXRpb25Qcm9wcyA9IHsKICBuYW1lOiBTdHJpbmcsCiAgYXBwZWFyOiBCb29sZWFuLAogIGNzczogQm9vbGVhbiwKICBtb2RlOiBTdHJpbmcsCiAgdHlwZTogU3RyaW5nLAogIGVudGVyQ2xhc3M6IFN0cmluZywKICBsZWF2ZUNsYXNzOiBTdHJpbmcsCiAgZW50ZXJUb0NsYXNzOiBTdHJpbmcsCiAgbGVhdmVUb0NsYXNzOiBTdHJpbmcsCiAgZW50ZXJBY3RpdmVDbGFzczogU3RyaW5nLAogIGxlYXZlQWN0aXZlQ2xhc3M6IFN0cmluZywKICBhcHBlYXJDbGFzczogU3RyaW5nLAogIGFwcGVhckFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgYXBwZWFyVG9DbGFzczogU3RyaW5nLAogIGR1cmF0aW9uOiBbTnVtYmVyLCBTdHJpbmcsIE9iamVjdF0KfTsKLy8gaW4gY2FzZSB0aGUgY2hpbGQgaXMgYWxzbyBhbiBhYnN0cmFjdCBjb21wb25lbnQsIGUuZy4gPGtlZXAtYWxpdmU+Ci8vIHdlIHdhbnQgdG8gcmVjdXJzaXZlbHkgcmV0cmlldmUgdGhlIHJlYWwgY29tcG9uZW50IHRvIGJlIHJlbmRlcmVkCmZ1bmN0aW9uIGdldFJlYWxDaGlsZCh2bm9kZSkgewogIHZhciBjb21wT3B0aW9ucyA9IHZub2RlICYmIHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CiAgaWYgKGNvbXBPcHRpb25zICYmIGNvbXBPcHRpb25zLkN0b3Iub3B0aW9ucy5hYnN0cmFjdCkgewogICAgcmV0dXJuIGdldFJlYWxDaGlsZChnZXRGaXJzdENvbXBvbmVudENoaWxkKGNvbXBPcHRpb25zLmNoaWxkcmVuKSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiB2bm9kZTsKICB9Cn0KZnVuY3Rpb24gZXh0cmFjdFRyYW5zaXRpb25EYXRhKGNvbXApIHsKICB2YXIgZGF0YSA9IHt9OwogIHZhciBvcHRpb25zID0gY29tcC4kb3B0aW9uczsKICAvLyBwcm9wcwogIGZvciAodmFyIGtleSBpbiBvcHRpb25zLnByb3BzRGF0YSkgewogICAgZGF0YVtrZXldID0gY29tcFtrZXldOwogIH0KICAvLyBldmVudHMuCiAgLy8gZXh0cmFjdCBsaXN0ZW5lcnMgYW5kIHBhc3MgdGhlbSBkaXJlY3RseSB0byB0aGUgdHJhbnNpdGlvbiBtZXRob2RzCiAgdmFyIGxpc3RlbmVycyA9IG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczsKICBmb3IgKHZhciBrZXkgaW4gbGlzdGVuZXJzKSB7CiAgICBkYXRhW2NhbWVsaXplKGtleSldID0gbGlzdGVuZXJzW2tleV07CiAgfQogIHJldHVybiBkYXRhOwp9CmZ1bmN0aW9uIHBsYWNlaG9sZGVyKGgsIHJhd0NoaWxkKSB7CiAgLy8gQHRzLWV4cGVjdC1lcnJvcgogIGlmICgvXGQta2VlcC1hbGl2ZSQvLnRlc3QocmF3Q2hpbGQudGFnKSkgewogICAgcmV0dXJuIGgoJ2tlZXAtYWxpdmUnLCB7CiAgICAgIHByb3BzOiByYXdDaGlsZC5jb21wb25lbnRPcHRpb25zLnByb3BzRGF0YQogICAgfSk7CiAgfQp9CmZ1bmN0aW9uIGhhc1BhcmVudFRyYW5zaXRpb24odm5vZGUpIHsKICB3aGlsZSAodm5vZGUgPSB2bm9kZS5wYXJlbnQpIHsKICAgIGlmICh2bm9kZS5kYXRhLnRyYW5zaXRpb24pIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGlzU2FtZUNoaWxkKGNoaWxkLCBvbGRDaGlsZCkgewogIHJldHVybiBvbGRDaGlsZC5rZXkgPT09IGNoaWxkLmtleSAmJiBvbGRDaGlsZC50YWcgPT09IGNoaWxkLnRhZzsKfQp2YXIgaXNOb3RUZXh0Tm9kZSA9IGZ1bmN0aW9uIGlzTm90VGV4dE5vZGUoYykgewogIHJldHVybiBjLnRhZyB8fCBpc0FzeW5jUGxhY2Vob2xkZXIoYyk7Cn07CnZhciBpc1ZTaG93RGlyZWN0aXZlID0gZnVuY3Rpb24gaXNWU2hvd0RpcmVjdGl2ZShkKSB7CiAgcmV0dXJuIGQubmFtZSA9PT0gJ3Nob3cnOwp9Owp2YXIgVHJhbnNpdGlvbiA9IHsKICBuYW1lOiAndHJhbnNpdGlvbicsCiAgcHJvcHM6IHRyYW5zaXRpb25Qcm9wcywKICBhYnN0cmFjdDogdHJ1ZSwKICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcihoKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgdmFyIGNoaWxkcmVuID0gdGhpcy4kc2xvdHMuZGVmYXVsdDsKICAgIGlmICghY2hpbGRyZW4pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gZmlsdGVyIG91dCB0ZXh0IG5vZGVzIChwb3NzaWJsZSB3aGl0ZXNwYWNlcykKICAgIGNoaWxkcmVuID0gY2hpbGRyZW4uZmlsdGVyKGlzTm90VGV4dE5vZGUpOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoIWNoaWxkcmVuLmxlbmd0aCkgewogICAgICByZXR1cm47CiAgICB9CiAgICAvLyB3YXJuIG11bHRpcGxlIGVsZW1lbnRzCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgIHdhcm4oJzx0cmFuc2l0aW9uPiBjYW4gb25seSBiZSB1c2VkIG9uIGEgc2luZ2xlIGVsZW1lbnQuIFVzZSAnICsgJzx0cmFuc2l0aW9uLWdyb3VwPiBmb3IgbGlzdHMuJywgdGhpcy4kcGFyZW50KTsKICAgIH0KICAgIHZhciBtb2RlID0gdGhpcy5tb2RlOwogICAgLy8gd2FybiBpbnZhbGlkIG1vZGUKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIG1vZGUgJiYgbW9kZSAhPT0gJ2luLW91dCcgJiYgbW9kZSAhPT0gJ291dC1pbicpIHsKICAgICAgd2FybignaW52YWxpZCA8dHJhbnNpdGlvbj4gbW9kZTogJyArIG1vZGUsIHRoaXMuJHBhcmVudCk7CiAgICB9CiAgICB2YXIgcmF3Q2hpbGQgPSBjaGlsZHJlblswXTsKICAgIC8vIGlmIHRoaXMgaXMgYSBjb21wb25lbnQgcm9vdCBub2RlIGFuZCB0aGUgY29tcG9uZW50J3MKICAgIC8vIHBhcmVudCBjb250YWluZXIgbm9kZSBhbHNvIGhhcyB0cmFuc2l0aW9uLCBza2lwLgogICAgaWYgKGhhc1BhcmVudFRyYW5zaXRpb24odGhpcy4kdm5vZGUpKSB7CiAgICAgIHJldHVybiByYXdDaGlsZDsKICAgIH0KICAgIC8vIGFwcGx5IHRyYW5zaXRpb24gZGF0YSB0byBjaGlsZAogICAgLy8gdXNlIGdldFJlYWxDaGlsZCgpIHRvIGlnbm9yZSBhYnN0cmFjdCBjb21wb25lbnRzIGUuZy4ga2VlcC1hbGl2ZQogICAgdmFyIGNoaWxkID0gZ2V0UmVhbENoaWxkKHJhd0NoaWxkKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKCFjaGlsZCkgewogICAgICByZXR1cm4gcmF3Q2hpbGQ7CiAgICB9CiAgICBpZiAodGhpcy5fbGVhdmluZykgewogICAgICByZXR1cm4gcGxhY2Vob2xkZXIoaCwgcmF3Q2hpbGQpOwogICAgfQogICAgLy8gZW5zdXJlIGEga2V5IHRoYXQgaXMgdW5pcXVlIHRvIHRoZSB2bm9kZSB0eXBlIGFuZCB0byB0aGlzIHRyYW5zaXRpb24KICAgIC8vIGNvbXBvbmVudCBpbnN0YW5jZS4gVGhpcyBrZXkgd2lsbCBiZSB1c2VkIHRvIHJlbW92ZSBwZW5kaW5nIGxlYXZpbmcgbm9kZXMKICAgIC8vIGR1cmluZyBlbnRlcmluZy4KICAgIHZhciBpZCA9ICJfX3RyYW5zaXRpb24tIi5jb25jYXQodGhpcy5fdWlkLCAiLSIpOwogICAgY2hpbGQua2V5ID0gY2hpbGQua2V5ID09IG51bGwgPyBjaGlsZC5pc0NvbW1lbnQgPyBpZCArICdjb21tZW50JyA6IGlkICsgY2hpbGQudGFnIDogaXNQcmltaXRpdmUoY2hpbGQua2V5KSA/IFN0cmluZyhjaGlsZC5rZXkpLmluZGV4T2YoaWQpID09PSAwID8gY2hpbGQua2V5IDogaWQgKyBjaGlsZC5rZXkgOiBjaGlsZC5rZXk7CiAgICB2YXIgZGF0YSA9IChjaGlsZC5kYXRhIHx8IChjaGlsZC5kYXRhID0ge30pKS50cmFuc2l0aW9uID0gZXh0cmFjdFRyYW5zaXRpb25EYXRhKHRoaXMpOwogICAgdmFyIG9sZFJhd0NoaWxkID0gdGhpcy5fdm5vZGU7CiAgICB2YXIgb2xkQ2hpbGQgPSBnZXRSZWFsQ2hpbGQob2xkUmF3Q2hpbGQpOwogICAgLy8gbWFyayB2LXNob3cKICAgIC8vIHNvIHRoYXQgdGhlIHRyYW5zaXRpb24gbW9kdWxlIGNhbiBoYW5kIG92ZXIgdGhlIGNvbnRyb2wgdG8gdGhlIGRpcmVjdGl2ZQogICAgaWYgKGNoaWxkLmRhdGEuZGlyZWN0aXZlcyAmJiBjaGlsZC5kYXRhLmRpcmVjdGl2ZXMuc29tZShpc1ZTaG93RGlyZWN0aXZlKSkgewogICAgICBjaGlsZC5kYXRhLnNob3cgPSB0cnVlOwogICAgfQogICAgaWYgKG9sZENoaWxkICYmIG9sZENoaWxkLmRhdGEgJiYgIWlzU2FtZUNoaWxkKGNoaWxkLCBvbGRDaGlsZCkgJiYgIWlzQXN5bmNQbGFjZWhvbGRlcihvbGRDaGlsZCkgJiYKICAgIC8vICM2Njg3IGNvbXBvbmVudCByb290IGlzIGEgY29tbWVudCBub2RlCiAgICAhKG9sZENoaWxkLmNvbXBvbmVudEluc3RhbmNlICYmIG9sZENoaWxkLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZS5pc0NvbW1lbnQpKSB7CiAgICAgIC8vIHJlcGxhY2Ugb2xkIGNoaWxkIHRyYW5zaXRpb24gZGF0YSB3aXRoIGZyZXNoIG9uZQogICAgICAvLyBpbXBvcnRhbnQgZm9yIGR5bmFtaWMgdHJhbnNpdGlvbnMhCiAgICAgIHZhciBvbGREYXRhID0gb2xkQ2hpbGQuZGF0YS50cmFuc2l0aW9uID0gZXh0ZW5kKHt9LCBkYXRhKTsKICAgICAgLy8gaGFuZGxlIHRyYW5zaXRpb24gbW9kZQogICAgICBpZiAobW9kZSA9PT0gJ291dC1pbicpIHsKICAgICAgICAvLyByZXR1cm4gcGxhY2Vob2xkZXIgbm9kZSBhbmQgcXVldWUgdXBkYXRlIHdoZW4gbGVhdmUgZmluaXNoZXMKICAgICAgICB0aGlzLl9sZWF2aW5nID0gdHJ1ZTsKICAgICAgICBtZXJnZVZOb2RlSG9vayhvbGREYXRhLCAnYWZ0ZXJMZWF2ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzLl9sZWF2aW5nID0gZmFsc2U7CiAgICAgICAgICBfdGhpcy4kZm9yY2VVcGRhdGUoKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcGxhY2Vob2xkZXIoaCwgcmF3Q2hpbGQpOwogICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdpbi1vdXQnKSB7CiAgICAgICAgaWYgKGlzQXN5bmNQbGFjZWhvbGRlcihjaGlsZCkpIHsKICAgICAgICAgIHJldHVybiBvbGRSYXdDaGlsZDsKICAgICAgICB9CiAgICAgICAgdmFyIGRlbGF5ZWRMZWF2ZV8xOwogICAgICAgIHZhciBwZXJmb3JtTGVhdmUgPSBmdW5jdGlvbiBwZXJmb3JtTGVhdmUoKSB7CiAgICAgICAgICBkZWxheWVkTGVhdmVfMSgpOwogICAgICAgIH07CiAgICAgICAgbWVyZ2VWTm9kZUhvb2soZGF0YSwgJ2FmdGVyRW50ZXInLCBwZXJmb3JtTGVhdmUpOwogICAgICAgIG1lcmdlVk5vZGVIb29rKGRhdGEsICdlbnRlckNhbmNlbGxlZCcsIHBlcmZvcm1MZWF2ZSk7CiAgICAgICAgbWVyZ2VWTm9kZUhvb2sob2xkRGF0YSwgJ2RlbGF5TGVhdmUnLCBmdW5jdGlvbiAobGVhdmUpIHsKICAgICAgICAgIGRlbGF5ZWRMZWF2ZV8xID0gbGVhdmU7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByYXdDaGlsZDsKICB9Cn07CgovLyBQcm92aWRlcyB0cmFuc2l0aW9uIHN1cHBvcnQgZm9yIGxpc3QgaXRlbXMuCnZhciBwcm9wcyA9IGV4dGVuZCh7CiAgdGFnOiBTdHJpbmcsCiAgbW92ZUNsYXNzOiBTdHJpbmcKfSwgdHJhbnNpdGlvblByb3BzKTsKZGVsZXRlIHByb3BzLm1vZGU7CnZhciBUcmFuc2l0aW9uR3JvdXAgPSB7CiAgcHJvcHM6IHByb3BzLAogIGJlZm9yZU1vdW50OiBmdW5jdGlvbiBiZWZvcmVNb3VudCgpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICB2YXIgdXBkYXRlID0gdGhpcy5fdXBkYXRlOwogICAgdGhpcy5fdXBkYXRlID0gZnVuY3Rpb24gKHZub2RlLCBoeWRyYXRpbmcpIHsKICAgICAgdmFyIHJlc3RvcmVBY3RpdmVJbnN0YW5jZSA9IHNldEFjdGl2ZUluc3RhbmNlKF90aGlzKTsKICAgICAgLy8gZm9yY2UgcmVtb3ZpbmcgcGFzcwogICAgICBfdGhpcy5fX3BhdGNoX18oX3RoaXMuX3Zub2RlLCBfdGhpcy5rZXB0LCBmYWxzZSwKICAgICAgLy8gaHlkcmF0aW5nCiAgICAgIHRydWUgLy8gcmVtb3ZlT25seSAoIWltcG9ydGFudCwgYXZvaWRzIHVubmVjZXNzYXJ5IG1vdmVzKQogICAgICApOwoKICAgICAgX3RoaXMuX3Zub2RlID0gX3RoaXMua2VwdDsKICAgICAgcmVzdG9yZUFjdGl2ZUluc3RhbmNlKCk7CiAgICAgIHVwZGF0ZS5jYWxsKF90aGlzLCB2bm9kZSwgaHlkcmF0aW5nKTsKICAgIH07CiAgfSwKICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcihoKSB7CiAgICB2YXIgdGFnID0gdGhpcy50YWcgfHwgdGhpcy4kdm5vZGUuZGF0YS50YWcgfHwgJ3NwYW4nOwogICAgdmFyIG1hcCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB2YXIgcHJldkNoaWxkcmVuID0gdGhpcy5wcmV2Q2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgdmFyIHJhd0NoaWxkcmVuID0gdGhpcy4kc2xvdHMuZGVmYXVsdCB8fCBbXTsKICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW4gPSBbXTsKICAgIHZhciB0cmFuc2l0aW9uRGF0YSA9IGV4dHJhY3RUcmFuc2l0aW9uRGF0YSh0aGlzKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmF3Q2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGMgPSByYXdDaGlsZHJlbltpXTsKICAgICAgaWYgKGMudGFnKSB7CiAgICAgICAgaWYgKGMua2V5ICE9IG51bGwgJiYgU3RyaW5nKGMua2V5KS5pbmRleE9mKCdfX3ZsaXN0JykgIT09IDApIHsKICAgICAgICAgIGNoaWxkcmVuLnB1c2goYyk7CiAgICAgICAgICBtYXBbYy5rZXldID0gYzsKICAgICAgICAgIChjLmRhdGEgfHwgKGMuZGF0YSA9IHt9KSkudHJhbnNpdGlvbiA9IHRyYW5zaXRpb25EYXRhOwogICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgdmFyIG9wdHMgPSBjLmNvbXBvbmVudE9wdGlvbnM7CiAgICAgICAgICB2YXIgbmFtZV8xID0gb3B0cyA/IGdldENvbXBvbmVudE5hbWUob3B0cy5DdG9yLm9wdGlvbnMpIHx8IG9wdHMudGFnIHx8ICcnIDogYy50YWc7CiAgICAgICAgICB3YXJuKCI8dHJhbnNpdGlvbi1ncm91cD4gY2hpbGRyZW4gbXVzdCBiZSBrZXllZDogPCIuY29uY2F0KG5hbWVfMSwgIj4iKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAocHJldkNoaWxkcmVuKSB7CiAgICAgIHZhciBrZXB0ID0gW107CiAgICAgIHZhciByZW1vdmVkID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJldkNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGMgPSBwcmV2Q2hpbGRyZW5baV07CiAgICAgICAgYy5kYXRhLnRyYW5zaXRpb24gPSB0cmFuc2l0aW9uRGF0YTsKICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIC5nZXRCb3VuZGluZ0NsaWVudFJlY3QgaXMgbm90IHR5cGVkIGluIE5vZGUKICAgICAgICBjLmRhdGEucG9zID0gYy5lbG0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgaWYgKG1hcFtjLmtleV0pIHsKICAgICAgICAgIGtlcHQucHVzaChjKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVtb3ZlZC5wdXNoKGMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLmtlcHQgPSBoKHRhZywgbnVsbCwga2VwdCk7CiAgICAgIHRoaXMucmVtb3ZlZCA9IHJlbW92ZWQ7CiAgICB9CiAgICByZXR1cm4gaCh0YWcsIG51bGwsIGNoaWxkcmVuKTsKICB9LAogIHVwZGF0ZWQ6IGZ1bmN0aW9uIHVwZGF0ZWQoKSB7CiAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLnByZXZDaGlsZHJlbjsKICAgIHZhciBtb3ZlQ2xhc3MgPSB0aGlzLm1vdmVDbGFzcyB8fCAodGhpcy5uYW1lIHx8ICd2JykgKyAnLW1vdmUnOwogICAgaWYgKCFjaGlsZHJlbi5sZW5ndGggfHwgIXRoaXMuaGFzTW92ZShjaGlsZHJlblswXS5lbG0sIG1vdmVDbGFzcykpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gd2UgZGl2aWRlIHRoZSB3b3JrIGludG8gdGhyZWUgbG9vcHMgdG8gYXZvaWQgbWl4aW5nIERPTSByZWFkcyBhbmQgd3JpdGVzCiAgICAvLyBpbiBlYWNoIGl0ZXJhdGlvbiAtIHdoaWNoIGhlbHBzIHByZXZlbnQgbGF5b3V0IHRocmFzaGluZy4KICAgIGNoaWxkcmVuLmZvckVhY2goY2FsbFBlbmRpbmdDYnMpOwogICAgY2hpbGRyZW4uZm9yRWFjaChyZWNvcmRQb3NpdGlvbik7CiAgICBjaGlsZHJlbi5mb3JFYWNoKGFwcGx5VHJhbnNsYXRpb24pOwogICAgLy8gZm9yY2UgcmVmbG93IHRvIHB1dCBldmVyeXRoaW5nIGluIHBvc2l0aW9uCiAgICAvLyBhc3NpZ24gdG8gdGhpcyB0byBhdm9pZCBiZWluZyByZW1vdmVkIGluIHRyZWUtc2hha2luZwogICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICB0aGlzLl9yZWZsb3cgPSBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodDsKICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGMpIHsKICAgICAgaWYgKGMuZGF0YS5tb3ZlZCkgewogICAgICAgIHZhciBlbF8xID0gYy5lbG07CiAgICAgICAgdmFyIHMgPSBlbF8xLnN0eWxlOwogICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbF8xLCBtb3ZlQ2xhc3MpOwogICAgICAgIHMudHJhbnNmb3JtID0gcy5XZWJraXRUcmFuc2Zvcm0gPSBzLnRyYW5zaXRpb25EdXJhdGlvbiA9ICcnOwogICAgICAgIGVsXzEuYWRkRXZlbnRMaXN0ZW5lcih0cmFuc2l0aW9uRW5kRXZlbnQsIGVsXzEuX21vdmVDYiA9IGZ1bmN0aW9uIGNiKGUpIHsKICAgICAgICAgIGlmIChlICYmIGUudGFyZ2V0ICE9PSBlbF8xKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghZSB8fCAvdHJhbnNmb3JtJC8udGVzdChlLnByb3BlcnR5TmFtZSkpIHsKICAgICAgICAgICAgZWxfMS5yZW1vdmVFdmVudExpc3RlbmVyKHRyYW5zaXRpb25FbmRFdmVudCwgY2IpOwogICAgICAgICAgICBlbF8xLl9tb3ZlQ2IgPSBudWxsOwogICAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWxfMSwgbW92ZUNsYXNzKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfSwKICBtZXRob2RzOiB7CiAgICBoYXNNb3ZlOiBmdW5jdGlvbiBoYXNNb3ZlKGVsLCBtb3ZlQ2xhc3MpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmICghaGFzVHJhbnNpdGlvbikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKHRoaXMuX2hhc01vdmUpIHsKICAgICAgICByZXR1cm4gdGhpcy5faGFzTW92ZTsKICAgICAgfQogICAgICAvLyBEZXRlY3Qgd2hldGhlciBhbiBlbGVtZW50IHdpdGggdGhlIG1vdmUgY2xhc3MgYXBwbGllZCBoYXMKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zLiBTaW5jZSB0aGUgZWxlbWVudCBtYXkgYmUgaW5zaWRlIGFuIGVudGVyaW5nCiAgICAgIC8vIHRyYW5zaXRpb24gYXQgdGhpcyB2ZXJ5IG1vbWVudCwgd2UgbWFrZSBhIGNsb25lIG9mIGl0IGFuZCByZW1vdmUKICAgICAgLy8gYWxsIG90aGVyIHRyYW5zaXRpb24gY2xhc3NlcyBhcHBsaWVkIHRvIGVuc3VyZSBvbmx5IHRoZSBtb3ZlIGNsYXNzCiAgICAgIC8vIGlzIGFwcGxpZWQuCiAgICAgIHZhciBjbG9uZSA9IGVsLmNsb25lTm9kZSgpOwogICAgICBpZiAoZWwuX3RyYW5zaXRpb25DbGFzc2VzKSB7CiAgICAgICAgZWwuX3RyYW5zaXRpb25DbGFzc2VzLmZvckVhY2goZnVuY3Rpb24gKGNscykgewogICAgICAgICAgcmVtb3ZlQ2xhc3MoY2xvbmUsIGNscyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgYWRkQ2xhc3MoY2xvbmUsIG1vdmVDbGFzcyk7CiAgICAgIGNsb25lLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIHRoaXMuJGVsLmFwcGVuZENoaWxkKGNsb25lKTsKICAgICAgdmFyIGluZm8gPSBnZXRUcmFuc2l0aW9uSW5mbyhjbG9uZSk7CiAgICAgIHRoaXMuJGVsLnJlbW92ZUNoaWxkKGNsb25lKTsKICAgICAgcmV0dXJuIHRoaXMuX2hhc01vdmUgPSBpbmZvLmhhc1RyYW5zZm9ybTsKICAgIH0KICB9Cn07CmZ1bmN0aW9uIGNhbGxQZW5kaW5nQ2JzKGMpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoYy5lbG0uX21vdmVDYikgewogICAgYy5lbG0uX21vdmVDYigpOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoYy5lbG0uX2VudGVyQ2IpIHsKICAgIGMuZWxtLl9lbnRlckNiKCk7CiAgfQp9CmZ1bmN0aW9uIHJlY29yZFBvc2l0aW9uKGMpIHsKICBjLmRhdGEubmV3UG9zID0gYy5lbG0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7Cn0KZnVuY3Rpb24gYXBwbHlUcmFuc2xhdGlvbihjKSB7CiAgdmFyIG9sZFBvcyA9IGMuZGF0YS5wb3M7CiAgdmFyIG5ld1BvcyA9IGMuZGF0YS5uZXdQb3M7CiAgdmFyIGR4ID0gb2xkUG9zLmxlZnQgLSBuZXdQb3MubGVmdDsKICB2YXIgZHkgPSBvbGRQb3MudG9wIC0gbmV3UG9zLnRvcDsKICBpZiAoZHggfHwgZHkpIHsKICAgIGMuZGF0YS5tb3ZlZCA9IHRydWU7CiAgICB2YXIgcyA9IGMuZWxtLnN0eWxlOwogICAgcy50cmFuc2Zvcm0gPSBzLldlYmtpdFRyYW5zZm9ybSA9ICJ0cmFuc2xhdGUoIi5jb25jYXQoZHgsICJweCwiKS5jb25jYXQoZHksICJweCkiKTsKICAgIHMudHJhbnNpdGlvbkR1cmF0aW9uID0gJzBzJzsKICB9Cn0KdmFyIHBsYXRmb3JtQ29tcG9uZW50cyA9IHsKICBUcmFuc2l0aW9uOiBUcmFuc2l0aW9uLAogIFRyYW5zaXRpb25Hcm91cDogVHJhbnNpdGlvbkdyb3VwCn07CgovLyBpbnN0YWxsIHBsYXRmb3JtIHNwZWNpZmljIHV0aWxzClZ1ZS5jb25maWcubXVzdFVzZVByb3AgPSBtdXN0VXNlUHJvcDsKVnVlLmNvbmZpZy5pc1Jlc2VydmVkVGFnID0gaXNSZXNlcnZlZFRhZzsKVnVlLmNvbmZpZy5pc1Jlc2VydmVkQXR0ciA9IGlzUmVzZXJ2ZWRBdHRyOwpWdWUuY29uZmlnLmdldFRhZ05hbWVzcGFjZSA9IGdldFRhZ05hbWVzcGFjZTsKVnVlLmNvbmZpZy5pc1Vua25vd25FbGVtZW50ID0gaXNVbmtub3duRWxlbWVudDsKLy8gaW5zdGFsbCBwbGF0Zm9ybSBydW50aW1lIGRpcmVjdGl2ZXMgJiBjb21wb25lbnRzCmV4dGVuZChWdWUub3B0aW9ucy5kaXJlY3RpdmVzLCBwbGF0Zm9ybURpcmVjdGl2ZXMpOwpleHRlbmQoVnVlLm9wdGlvbnMuY29tcG9uZW50cywgcGxhdGZvcm1Db21wb25lbnRzKTsKLy8gaW5zdGFsbCBwbGF0Zm9ybSBwYXRjaCBmdW5jdGlvbgpWdWUucHJvdG90eXBlLl9fcGF0Y2hfXyA9IGluQnJvd3NlciA/IHBhdGNoIDogbm9vcDsKLy8gcHVibGljIG1vdW50IG1ldGhvZApWdWUucHJvdG90eXBlLiRtb3VudCA9IGZ1bmN0aW9uIChlbCwgaHlkcmF0aW5nKSB7CiAgZWwgPSBlbCAmJiBpbkJyb3dzZXIgPyBxdWVyeShlbCkgOiB1bmRlZmluZWQ7CiAgcmV0dXJuIG1vdW50Q29tcG9uZW50KHRoaXMsIGVsLCBoeWRyYXRpbmcpOwp9OwovLyBkZXZ0b29scyBnbG9iYWwgaG9vawovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwppZiAoaW5Ccm93c2VyKSB7CiAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICBpZiAoY29uZmlnLmRldnRvb2xzKSB7CiAgICAgIGlmIChkZXZ0b29scykgewogICAgICAgIGRldnRvb2xzLmVtaXQoJ2luaXQnLCBWdWUpOwogICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0JykgewogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgICAgICBjb25zb2xlW2NvbnNvbGUuaW5mbyA/ICdpbmZvJyA6ICdsb2cnXSgnRG93bmxvYWQgdGhlIFZ1ZSBEZXZ0b29scyBleHRlbnNpb24gZm9yIGEgYmV0dGVyIGRldmVsb3BtZW50IGV4cGVyaWVuY2U6XG4nICsgJ2h0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWUtZGV2dG9vbHMnKTsKICAgICAgfQogICAgfQogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0JyAmJiBjb25maWcucHJvZHVjdGlvblRpcCAhPT0gZmFsc2UgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgICAgY29uc29sZVtjb25zb2xlLmluZm8gPyAnaW5mbycgOiAnbG9nJ10oIllvdSBhcmUgcnVubmluZyBWdWUgaW4gZGV2ZWxvcG1lbnQgbW9kZS5cbiIgKyAiTWFrZSBzdXJlIHRvIHR1cm4gb24gcHJvZHVjdGlvbiBtb2RlIHdoZW4gZGVwbG95aW5nIGZvciBwcm9kdWN0aW9uLlxuIiArICJTZWUgbW9yZSB0aXBzIGF0IGh0dHBzOi8vdnVlanMub3JnL2d1aWRlL2RlcGxveW1lbnQuaHRtbCIpOwogICAgfQogIH0sIDApOwp9CmV4cG9ydCB7IEVmZmVjdFNjb3BlLCBjb21wdXRlZCwgY3VzdG9tUmVmLCBWdWUgYXMgZGVmYXVsdCwgZGVmaW5lQXN5bmNDb21wb25lbnQsIGRlZmluZUNvbXBvbmVudCwgZGVsLCBlZmZlY3RTY29wZSwgZ2V0Q3VycmVudEluc3RhbmNlLCBnZXRDdXJyZW50U2NvcGUsIGgsIGluamVjdCwgaXNQcm94eSwgaXNSZWFjdGl2ZSwgaXNSZWFkb25seSwgaXNSZWYsIGlzU2hhbGxvdywgbWFya1JhdywgbWVyZ2VEZWZhdWx0cywgbmV4dFRpY2ssIG9uQWN0aXZhdGVkLCBvbkJlZm9yZU1vdW50LCBvbkJlZm9yZVVubW91bnQsIG9uQmVmb3JlVXBkYXRlLCBvbkRlYWN0aXZhdGVkLCBvbkVycm9yQ2FwdHVyZWQsIG9uTW91bnRlZCwgb25SZW5kZXJUcmFja2VkLCBvblJlbmRlclRyaWdnZXJlZCwgb25TY29wZURpc3Bvc2UsIG9uU2VydmVyUHJlZmV0Y2gsIG9uVW5tb3VudGVkLCBvblVwZGF0ZWQsIHByb3ZpZGUsIHByb3h5UmVmcywgcmVhY3RpdmUsIHJlYWRvbmx5LCByZWYkMSBhcyByZWYsIHNldCwgc2hhbGxvd1JlYWN0aXZlLCBzaGFsbG93UmVhZG9ubHksIHNoYWxsb3dSZWYsIHRvUmF3LCB0b1JlZiwgdG9SZWZzLCB0cmlnZ2VyUmVmLCB1bnJlZiwgdXNlQXR0cnMsIHVzZUNzc01vZHVsZSwgdXNlQ3NzVmFycywgdXNlTGlzdGVuZXJzLCB1c2VTbG90cywgdmVyc2lvbiwgd2F0Y2gsIHdhdGNoRWZmZWN0LCB3YXRjaFBvc3RFZmZlY3QsIHdhdGNoU3luY0VmZmVjdCB9Ow=="},null]}