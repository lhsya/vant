{"remainingRequest":"/Users/adamliu/works/vant/node_modules/babel-loader/lib/index.js!/Users/adamliu/works/vant/node_modules/vue-router/dist/vue-router.esm.js","dependencies":[{"path":"/Users/adamliu/works/vant/node_modules/vue-router/dist/vue-router.esm.js","mtime":1694509796046},{"path":"/Users/adamliu/works/vant/babel.config.js","mtime":1694509704583},{"path":"/Users/adamliu/works/vant/node_modules/cache-loader/dist/cjs.js","mtime":1694509793427},{"path":"/Users/adamliu/works/vant/node_modules/babel-loader/lib/index.js","mtime":1694509794381}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:LyohCiAgKiB2dWUtcm91dGVyIHYzLjYuNQogICogKGMpIDIwMjIgRXZhbiBZb3UKICAqIEBsaWNlbnNlIE1JVAogICovCi8qICAqLwoKZnVuY3Rpb24gYXNzZXJ0KGNvbmRpdGlvbiwgbWVzc2FnZSkgewogIGlmICghY29uZGl0aW9uKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIlt2dWUtcm91dGVyXSAiICsgbWVzc2FnZSk7CiAgfQp9CmZ1bmN0aW9uIHdhcm4oY29uZGl0aW9uLCBtZXNzYWdlKSB7CiAgaWYgKCFjb25kaXRpb24pIHsKICAgIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJyAmJiBjb25zb2xlLndhcm4oIlt2dWUtcm91dGVyXSAiICsgbWVzc2FnZSk7CiAgfQp9CmZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7CiAgZm9yICh2YXIga2V5IGluIGIpIHsKICAgIGFba2V5XSA9IGJba2V5XTsKICB9CiAgcmV0dXJuIGE7Cn0KCi8qICAqLwoKdmFyIGVuY29kZVJlc2VydmVSRSA9IC9bIScoKSpdL2c7CnZhciBlbmNvZGVSZXNlcnZlUmVwbGFjZXIgPSBmdW5jdGlvbiBlbmNvZGVSZXNlcnZlUmVwbGFjZXIoYykgewogIHJldHVybiAnJScgKyBjLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpOwp9Owp2YXIgY29tbWFSRSA9IC8lMkMvZzsKCi8vIGZpeGVkIGVuY29kZVVSSUNvbXBvbmVudCB3aGljaCBpcyBtb3JlIGNvbmZvcm1hbnQgdG8gUkZDMzk4NjoKLy8gLSBlc2NhcGVzIFshJygpKl0KLy8gLSBwcmVzZXJ2ZSBjb21tYXMKdmFyIGVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShzdHIpIHsKICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cikucmVwbGFjZShlbmNvZGVSZXNlcnZlUkUsIGVuY29kZVJlc2VydmVSZXBsYWNlcikucmVwbGFjZShjb21tYVJFLCAnLCcpOwp9OwpmdW5jdGlvbiBkZWNvZGUoc3RyKSB7CiAgdHJ5IHsKICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoc3RyKTsKICB9IGNhdGNoIChlcnIpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHdhcm4oZmFsc2UsICJFcnJvciBkZWNvZGluZyBcIiIgKyBzdHIgKyAiXCIuIExlYXZpbmcgaXQgaW50YWN0LiIpOwogICAgfQogIH0KICByZXR1cm4gc3RyOwp9CmZ1bmN0aW9uIHJlc29sdmVRdWVyeShxdWVyeSwgZXh0cmFRdWVyeSwgX3BhcnNlUXVlcnkpIHsKICBpZiAoZXh0cmFRdWVyeSA9PT0gdm9pZCAwKSBleHRyYVF1ZXJ5ID0ge307CiAgdmFyIHBhcnNlID0gX3BhcnNlUXVlcnkgfHwgcGFyc2VRdWVyeTsKICB2YXIgcGFyc2VkUXVlcnk7CiAgdHJ5IHsKICAgIHBhcnNlZFF1ZXJ5ID0gcGFyc2UocXVlcnkgfHwgJycpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybihmYWxzZSwgZS5tZXNzYWdlKTsKICAgIHBhcnNlZFF1ZXJ5ID0ge307CiAgfQogIGZvciAodmFyIGtleSBpbiBleHRyYVF1ZXJ5KSB7CiAgICB2YXIgdmFsdWUgPSBleHRyYVF1ZXJ5W2tleV07CiAgICBwYXJzZWRRdWVyeVtrZXldID0gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZS5tYXAoY2FzdFF1ZXJ5UGFyYW1WYWx1ZSkgOiBjYXN0UXVlcnlQYXJhbVZhbHVlKHZhbHVlKTsKICB9CiAgcmV0dXJuIHBhcnNlZFF1ZXJ5Owp9CnZhciBjYXN0UXVlcnlQYXJhbVZhbHVlID0gZnVuY3Rpb24gY2FzdFF1ZXJ5UGFyYW1WYWx1ZSh2YWx1ZSkgewogIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgPyB2YWx1ZSA6IFN0cmluZyh2YWx1ZSk7Cn07CmZ1bmN0aW9uIHBhcnNlUXVlcnkocXVlcnkpIHsKICB2YXIgcmVzID0ge307CiAgcXVlcnkgPSBxdWVyeS50cmltKCkucmVwbGFjZSgvXihcP3wjfCYpLywgJycpOwogIGlmICghcXVlcnkpIHsKICAgIHJldHVybiByZXM7CiAgfQogIHF1ZXJ5LnNwbGl0KCcmJykuZm9yRWFjaChmdW5jdGlvbiAocGFyYW0pIHsKICAgIHZhciBwYXJ0cyA9IHBhcmFtLnJlcGxhY2UoL1wrL2csICcgJykuc3BsaXQoJz0nKTsKICAgIHZhciBrZXkgPSBkZWNvZGUocGFydHMuc2hpZnQoKSk7CiAgICB2YXIgdmFsID0gcGFydHMubGVuZ3RoID4gMCA/IGRlY29kZShwYXJ0cy5qb2luKCc9JykpIDogbnVsbDsKICAgIGlmIChyZXNba2V5XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHJlc1trZXldID0gdmFsOwogICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc1trZXldKSkgewogICAgICByZXNba2V5XS5wdXNoKHZhbCk7CiAgICB9IGVsc2UgewogICAgICByZXNba2V5XSA9IFtyZXNba2V5XSwgdmFsXTsKICAgIH0KICB9KTsKICByZXR1cm4gcmVzOwp9CmZ1bmN0aW9uIHN0cmluZ2lmeVF1ZXJ5KG9iaikgewogIHZhciByZXMgPSBvYmogPyBPYmplY3Qua2V5cyhvYmopLm1hcChmdW5jdGlvbiAoa2V5KSB7CiAgICB2YXIgdmFsID0gb2JqW2tleV07CiAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuICcnOwogICAgfQogICAgaWYgKHZhbCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gZW5jb2RlKGtleSk7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgdmFsLmZvckVhY2goZnVuY3Rpb24gKHZhbDIpIHsKICAgICAgICBpZiAodmFsMiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh2YWwyID09PSBudWxsKSB7CiAgICAgICAgICByZXN1bHQucHVzaChlbmNvZGUoa2V5KSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKGVuY29kZShrZXkpICsgJz0nICsgZW5jb2RlKHZhbDIpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0LmpvaW4oJyYnKTsKICAgIH0KICAgIHJldHVybiBlbmNvZGUoa2V5KSArICc9JyArIGVuY29kZSh2YWwpOwogIH0pLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgcmV0dXJuIHgubGVuZ3RoID4gMDsKICB9KS5qb2luKCcmJykgOiBudWxsOwogIHJldHVybiByZXMgPyAiPyIgKyByZXMgOiAnJzsKfQoKLyogICovCgp2YXIgdHJhaWxpbmdTbGFzaFJFID0gL1wvPyQvOwpmdW5jdGlvbiBjcmVhdGVSb3V0ZShyZWNvcmQsIGxvY2F0aW9uLCByZWRpcmVjdGVkRnJvbSwgcm91dGVyKSB7CiAgdmFyIHN0cmluZ2lmeVF1ZXJ5ID0gcm91dGVyICYmIHJvdXRlci5vcHRpb25zLnN0cmluZ2lmeVF1ZXJ5OwogIHZhciBxdWVyeSA9IGxvY2F0aW9uLnF1ZXJ5IHx8IHt9OwogIHRyeSB7CiAgICBxdWVyeSA9IGNsb25lKHF1ZXJ5KTsKICB9IGNhdGNoIChlKSB7fQogIHZhciByb3V0ZSA9IHsKICAgIG5hbWU6IGxvY2F0aW9uLm5hbWUgfHwgcmVjb3JkICYmIHJlY29yZC5uYW1lLAogICAgbWV0YTogcmVjb3JkICYmIHJlY29yZC5tZXRhIHx8IHt9LAogICAgcGF0aDogbG9jYXRpb24ucGF0aCB8fCAnLycsCiAgICBoYXNoOiBsb2NhdGlvbi5oYXNoIHx8ICcnLAogICAgcXVlcnk6IHF1ZXJ5LAogICAgcGFyYW1zOiBsb2NhdGlvbi5wYXJhbXMgfHwge30sCiAgICBmdWxsUGF0aDogZ2V0RnVsbFBhdGgobG9jYXRpb24sIHN0cmluZ2lmeVF1ZXJ5KSwKICAgIG1hdGNoZWQ6IHJlY29yZCA/IGZvcm1hdE1hdGNoKHJlY29yZCkgOiBbXQogIH07CiAgaWYgKHJlZGlyZWN0ZWRGcm9tKSB7CiAgICByb3V0ZS5yZWRpcmVjdGVkRnJvbSA9IGdldEZ1bGxQYXRoKHJlZGlyZWN0ZWRGcm9tLCBzdHJpbmdpZnlRdWVyeSk7CiAgfQogIHJldHVybiBPYmplY3QuZnJlZXplKHJvdXRlKTsKfQpmdW5jdGlvbiBjbG9uZSh2YWx1ZSkgewogIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgcmV0dXJuIHZhbHVlLm1hcChjbG9uZSk7CiAgfSBlbHNlIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7CiAgICB2YXIgcmVzID0ge307CiAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHsKICAgICAgcmVzW2tleV0gPSBjbG9uZSh2YWx1ZVtrZXldKTsKICAgIH0KICAgIHJldHVybiByZXM7CiAgfSBlbHNlIHsKICAgIHJldHVybiB2YWx1ZTsKICB9Cn0KCi8vIHRoZSBzdGFydGluZyByb3V0ZSB0aGF0IHJlcHJlc2VudHMgdGhlIGluaXRpYWwgc3RhdGUKdmFyIFNUQVJUID0gY3JlYXRlUm91dGUobnVsbCwgewogIHBhdGg6ICcvJwp9KTsKZnVuY3Rpb24gZm9ybWF0TWF0Y2gocmVjb3JkKSB7CiAgdmFyIHJlcyA9IFtdOwogIHdoaWxlIChyZWNvcmQpIHsKICAgIHJlcy51bnNoaWZ0KHJlY29yZCk7CiAgICByZWNvcmQgPSByZWNvcmQucGFyZW50OwogIH0KICByZXR1cm4gcmVzOwp9CmZ1bmN0aW9uIGdldEZ1bGxQYXRoKHJlZiwgX3N0cmluZ2lmeVF1ZXJ5KSB7CiAgdmFyIHBhdGggPSByZWYucGF0aDsKICB2YXIgcXVlcnkgPSByZWYucXVlcnk7CiAgaWYgKHF1ZXJ5ID09PSB2b2lkIDApIHF1ZXJ5ID0ge307CiAgdmFyIGhhc2ggPSByZWYuaGFzaDsKICBpZiAoaGFzaCA9PT0gdm9pZCAwKSBoYXNoID0gJyc7CiAgdmFyIHN0cmluZ2lmeSA9IF9zdHJpbmdpZnlRdWVyeSB8fCBzdHJpbmdpZnlRdWVyeTsKICByZXR1cm4gKHBhdGggfHwgJy8nKSArIHN0cmluZ2lmeShxdWVyeSkgKyBoYXNoOwp9CmZ1bmN0aW9uIGlzU2FtZVJvdXRlKGEsIGIsIG9ubHlQYXRoKSB7CiAgaWYgKGIgPT09IFNUQVJUKSB7CiAgICByZXR1cm4gYSA9PT0gYjsKICB9IGVsc2UgaWYgKCFiKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfSBlbHNlIGlmIChhLnBhdGggJiYgYi5wYXRoKSB7CiAgICByZXR1cm4gYS5wYXRoLnJlcGxhY2UodHJhaWxpbmdTbGFzaFJFLCAnJykgPT09IGIucGF0aC5yZXBsYWNlKHRyYWlsaW5nU2xhc2hSRSwgJycpICYmIChvbmx5UGF0aCB8fCBhLmhhc2ggPT09IGIuaGFzaCAmJiBpc09iamVjdEVxdWFsKGEucXVlcnksIGIucXVlcnkpKTsKICB9IGVsc2UgaWYgKGEubmFtZSAmJiBiLm5hbWUpIHsKICAgIHJldHVybiBhLm5hbWUgPT09IGIubmFtZSAmJiAob25seVBhdGggfHwgYS5oYXNoID09PSBiLmhhc2ggJiYgaXNPYmplY3RFcXVhbChhLnF1ZXJ5LCBiLnF1ZXJ5KSAmJiBpc09iamVjdEVxdWFsKGEucGFyYW1zLCBiLnBhcmFtcykpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9CmZ1bmN0aW9uIGlzT2JqZWN0RXF1YWwoYSwgYikgewogIGlmIChhID09PSB2b2lkIDApIGEgPSB7fTsKICBpZiAoYiA9PT0gdm9pZCAwKSBiID0ge307CgogIC8vIGhhbmRsZSBudWxsIHZhbHVlICMxNTY2CiAgaWYgKCFhIHx8ICFiKSB7CiAgICByZXR1cm4gYSA9PT0gYjsKICB9CiAgdmFyIGFLZXlzID0gT2JqZWN0LmtleXMoYSkuc29ydCgpOwogIHZhciBiS2V5cyA9IE9iamVjdC5rZXlzKGIpLnNvcnQoKTsKICBpZiAoYUtleXMubGVuZ3RoICE9PSBiS2V5cy5sZW5ndGgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIGFLZXlzLmV2ZXJ5KGZ1bmN0aW9uIChrZXksIGkpIHsKICAgIHZhciBhVmFsID0gYVtrZXldOwogICAgdmFyIGJLZXkgPSBiS2V5c1tpXTsKICAgIGlmIChiS2V5ICE9PSBrZXkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdmFyIGJWYWwgPSBiW2tleV07CiAgICAvLyBxdWVyeSB2YWx1ZXMgY2FuIGJlIG51bGwgYW5kIHVuZGVmaW5lZAogICAgaWYgKGFWYWwgPT0gbnVsbCB8fCBiVmFsID09IG51bGwpIHsKICAgICAgcmV0dXJuIGFWYWwgPT09IGJWYWw7CiAgICB9CiAgICAvLyBjaGVjayBuZXN0ZWQgZXF1YWxpdHkKICAgIGlmICh0eXBlb2YgYVZhbCA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIGJWYWwgPT09ICdvYmplY3QnKSB7CiAgICAgIHJldHVybiBpc09iamVjdEVxdWFsKGFWYWwsIGJWYWwpOwogICAgfQogICAgcmV0dXJuIFN0cmluZyhhVmFsKSA9PT0gU3RyaW5nKGJWYWwpOwogIH0pOwp9CmZ1bmN0aW9uIGlzSW5jbHVkZWRSb3V0ZShjdXJyZW50LCB0YXJnZXQpIHsKICByZXR1cm4gY3VycmVudC5wYXRoLnJlcGxhY2UodHJhaWxpbmdTbGFzaFJFLCAnLycpLmluZGV4T2YodGFyZ2V0LnBhdGgucmVwbGFjZSh0cmFpbGluZ1NsYXNoUkUsICcvJykpID09PSAwICYmICghdGFyZ2V0Lmhhc2ggfHwgY3VycmVudC5oYXNoID09PSB0YXJnZXQuaGFzaCkgJiYgcXVlcnlJbmNsdWRlcyhjdXJyZW50LnF1ZXJ5LCB0YXJnZXQucXVlcnkpOwp9CmZ1bmN0aW9uIHF1ZXJ5SW5jbHVkZXMoY3VycmVudCwgdGFyZ2V0KSB7CiAgZm9yICh2YXIga2V5IGluIHRhcmdldCkgewogICAgaWYgKCEoa2V5IGluIGN1cnJlbnQpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gaGFuZGxlUm91dGVFbnRlcmVkKHJvdXRlKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCByb3V0ZS5tYXRjaGVkLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgcmVjb3JkID0gcm91dGUubWF0Y2hlZFtpXTsKICAgIGZvciAodmFyIG5hbWUgaW4gcmVjb3JkLmluc3RhbmNlcykgewogICAgICB2YXIgaW5zdGFuY2UgPSByZWNvcmQuaW5zdGFuY2VzW25hbWVdOwogICAgICB2YXIgY2JzID0gcmVjb3JkLmVudGVyZWRDYnNbbmFtZV07CiAgICAgIGlmICghaW5zdGFuY2UgfHwgIWNicykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGRlbGV0ZSByZWNvcmQuZW50ZXJlZENic1tuYW1lXTsKICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgY2JzLmxlbmd0aDsgaSQxKyspIHsKICAgICAgICBpZiAoIWluc3RhbmNlLl9pc0JlaW5nRGVzdHJveWVkKSB7CiAgICAgICAgICBjYnNbaSQxXShpbnN0YW5jZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9CnZhciBWaWV3ID0gewogIG5hbWU6ICdSb3V0ZXJWaWV3JywKICBmdW5jdGlvbmFsOiB0cnVlLAogIHByb3BzOiB7CiAgICBuYW1lOiB7CiAgICAgIHR5cGU6IFN0cmluZywKICAgICAgZGVmYXVsdDogJ2RlZmF1bHQnCiAgICB9CiAgfSwKICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcihfLCByZWYpIHsKICAgIHZhciBwcm9wcyA9IHJlZi5wcm9wczsKICAgIHZhciBjaGlsZHJlbiA9IHJlZi5jaGlsZHJlbjsKICAgIHZhciBwYXJlbnQgPSByZWYucGFyZW50OwogICAgdmFyIGRhdGEgPSByZWYuZGF0YTsKCiAgICAvLyB1c2VkIGJ5IGRldnRvb2xzIHRvIGRpc3BsYXkgYSByb3V0ZXItdmlldyBiYWRnZQogICAgZGF0YS5yb3V0ZXJWaWV3ID0gdHJ1ZTsKCiAgICAvLyBkaXJlY3RseSB1c2UgcGFyZW50IGNvbnRleHQncyBjcmVhdGVFbGVtZW50KCkgZnVuY3Rpb24KICAgIC8vIHNvIHRoYXQgY29tcG9uZW50cyByZW5kZXJlZCBieSByb3V0ZXItdmlldyBjYW4gcmVzb2x2ZSBuYW1lZCBzbG90cwogICAgdmFyIGggPSBwYXJlbnQuJGNyZWF0ZUVsZW1lbnQ7CiAgICB2YXIgbmFtZSA9IHByb3BzLm5hbWU7CiAgICB2YXIgcm91dGUgPSBwYXJlbnQuJHJvdXRlOwogICAgdmFyIGNhY2hlID0gcGFyZW50Ll9yb3V0ZXJWaWV3Q2FjaGUgfHwgKHBhcmVudC5fcm91dGVyVmlld0NhY2hlID0ge30pOwoKICAgIC8vIGRldGVybWluZSBjdXJyZW50IHZpZXcgZGVwdGgsIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0cmVlCiAgICAvLyBoYXMgYmVlbiB0b2dnbGVkIGluYWN0aXZlIGJ1dCBrZXB0LWFsaXZlLgogICAgdmFyIGRlcHRoID0gMDsKICAgIHZhciBpbmFjdGl2ZSA9IGZhbHNlOwogICAgd2hpbGUgKHBhcmVudCAmJiBwYXJlbnQuX3JvdXRlclJvb3QgIT09IHBhcmVudCkgewogICAgICB2YXIgdm5vZGVEYXRhID0gcGFyZW50LiR2bm9kZSA/IHBhcmVudC4kdm5vZGUuZGF0YSA6IHt9OwogICAgICBpZiAodm5vZGVEYXRhLnJvdXRlclZpZXcpIHsKICAgICAgICBkZXB0aCsrOwogICAgICB9CiAgICAgIGlmICh2bm9kZURhdGEua2VlcEFsaXZlICYmIHBhcmVudC5fZGlyZWN0SW5hY3RpdmUgJiYgcGFyZW50Ll9pbmFjdGl2ZSkgewogICAgICAgIGluYWN0aXZlID0gdHJ1ZTsKICAgICAgfQogICAgICBwYXJlbnQgPSBwYXJlbnQuJHBhcmVudDsKICAgIH0KICAgIGRhdGEucm91dGVyVmlld0RlcHRoID0gZGVwdGg7CgogICAgLy8gcmVuZGVyIHByZXZpb3VzIHZpZXcgaWYgdGhlIHRyZWUgaXMgaW5hY3RpdmUgYW5kIGtlcHQtYWxpdmUKICAgIGlmIChpbmFjdGl2ZSkgewogICAgICB2YXIgY2FjaGVkRGF0YSA9IGNhY2hlW25hbWVdOwogICAgICB2YXIgY2FjaGVkQ29tcG9uZW50ID0gY2FjaGVkRGF0YSAmJiBjYWNoZWREYXRhLmNvbXBvbmVudDsKICAgICAgaWYgKGNhY2hlZENvbXBvbmVudCkgewogICAgICAgIC8vICMyMzAxCiAgICAgICAgLy8gcGFzcyBwcm9wcwogICAgICAgIGlmIChjYWNoZWREYXRhLmNvbmZpZ1Byb3BzKSB7CiAgICAgICAgICBmaWxsUHJvcHNpbkRhdGEoY2FjaGVkQ29tcG9uZW50LCBkYXRhLCBjYWNoZWREYXRhLnJvdXRlLCBjYWNoZWREYXRhLmNvbmZpZ1Byb3BzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGgoY2FjaGVkQ29tcG9uZW50LCBkYXRhLCBjaGlsZHJlbik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gcmVuZGVyIHByZXZpb3VzIGVtcHR5IHZpZXcKICAgICAgICByZXR1cm4gaCgpOwogICAgICB9CiAgICB9CiAgICB2YXIgbWF0Y2hlZCA9IHJvdXRlLm1hdGNoZWRbZGVwdGhdOwogICAgdmFyIGNvbXBvbmVudCA9IG1hdGNoZWQgJiYgbWF0Y2hlZC5jb21wb25lbnRzW25hbWVdOwoKICAgIC8vIHJlbmRlciBlbXB0eSBub2RlIGlmIG5vIG1hdGNoZWQgcm91dGUgb3Igbm8gY29uZmlnIGNvbXBvbmVudAogICAgaWYgKCFtYXRjaGVkIHx8ICFjb21wb25lbnQpIHsKICAgICAgY2FjaGVbbmFtZV0gPSBudWxsOwogICAgICByZXR1cm4gaCgpOwogICAgfQoKICAgIC8vIGNhY2hlIGNvbXBvbmVudAogICAgY2FjaGVbbmFtZV0gPSB7CiAgICAgIGNvbXBvbmVudDogY29tcG9uZW50CiAgICB9OwoKICAgIC8vIGF0dGFjaCBpbnN0YW5jZSByZWdpc3RyYXRpb24gaG9vawogICAgLy8gdGhpcyB3aWxsIGJlIGNhbGxlZCBpbiB0aGUgaW5zdGFuY2UncyBpbmplY3RlZCBsaWZlY3ljbGUgaG9va3MKICAgIGRhdGEucmVnaXN0ZXJSb3V0ZUluc3RhbmNlID0gZnVuY3Rpb24gKHZtLCB2YWwpIHsKICAgICAgLy8gdmFsIGNvdWxkIGJlIHVuZGVmaW5lZCBmb3IgdW5yZWdpc3RyYXRpb24KICAgICAgdmFyIGN1cnJlbnQgPSBtYXRjaGVkLmluc3RhbmNlc1tuYW1lXTsKICAgICAgaWYgKHZhbCAmJiBjdXJyZW50ICE9PSB2bSB8fCAhdmFsICYmIGN1cnJlbnQgPT09IHZtKSB7CiAgICAgICAgbWF0Y2hlZC5pbnN0YW5jZXNbbmFtZV0gPSB2YWw7CiAgICAgIH0KICAgIH0KCiAgICAvLyBhbHNvIHJlZ2lzdGVyIGluc3RhbmNlIGluIHByZXBhdGNoIGhvb2sKICAgIC8vIGluIGNhc2UgdGhlIHNhbWUgY29tcG9uZW50IGluc3RhbmNlIGlzIHJldXNlZCBhY3Jvc3MgZGlmZmVyZW50IHJvdXRlcwogICAgOwogICAgKGRhdGEuaG9vayB8fCAoZGF0YS5ob29rID0ge30pKS5wcmVwYXRjaCA9IGZ1bmN0aW9uIChfLCB2bm9kZSkgewogICAgICBtYXRjaGVkLmluc3RhbmNlc1tuYW1lXSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlOwogICAgfTsKCiAgICAvLyByZWdpc3RlciBpbnN0YW5jZSBpbiBpbml0IGhvb2sKICAgIC8vIGluIGNhc2Uga2VwdC1hbGl2ZSBjb21wb25lbnQgYmUgYWN0aXZlZCB3aGVuIHJvdXRlcyBjaGFuZ2VkCiAgICBkYXRhLmhvb2suaW5pdCA9IGZ1bmN0aW9uICh2bm9kZSkgewogICAgICBpZiAodm5vZGUuZGF0YS5rZWVwQWxpdmUgJiYgdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgJiYgdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgIT09IG1hdGNoZWQuaW5zdGFuY2VzW25hbWVdKSB7CiAgICAgICAgbWF0Y2hlZC5pbnN0YW5jZXNbbmFtZV0gPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZTsKICAgICAgfQoKICAgICAgLy8gaWYgdGhlIHJvdXRlIHRyYW5zaXRpb24gaGFzIGFscmVhZHkgYmVlbiBjb25maXJtZWQgdGhlbiB3ZSB3ZXJlbid0CiAgICAgIC8vIGFibGUgdG8gY2FsbCB0aGUgY2JzIGR1cmluZyBjb25maXJtYXRpb24gYXMgdGhlIGNvbXBvbmVudCB3YXMgbm90CiAgICAgIC8vIHJlZ2lzdGVyZWQgeWV0LCBzbyB3ZSBjYWxsIGl0IGhlcmUuCiAgICAgIGhhbmRsZVJvdXRlRW50ZXJlZChyb3V0ZSk7CiAgICB9OwogICAgdmFyIGNvbmZpZ1Byb3BzID0gbWF0Y2hlZC5wcm9wcyAmJiBtYXRjaGVkLnByb3BzW25hbWVdOwogICAgLy8gc2F2ZSByb3V0ZSBhbmQgY29uZmlnUHJvcHMgaW4gY2FjaGUKICAgIGlmIChjb25maWdQcm9wcykgewogICAgICBleHRlbmQoY2FjaGVbbmFtZV0sIHsKICAgICAgICByb3V0ZTogcm91dGUsCiAgICAgICAgY29uZmlnUHJvcHM6IGNvbmZpZ1Byb3BzCiAgICAgIH0pOwogICAgICBmaWxsUHJvcHNpbkRhdGEoY29tcG9uZW50LCBkYXRhLCByb3V0ZSwgY29uZmlnUHJvcHMpOwogICAgfQogICAgcmV0dXJuIGgoY29tcG9uZW50LCBkYXRhLCBjaGlsZHJlbik7CiAgfQp9OwpmdW5jdGlvbiBmaWxsUHJvcHNpbkRhdGEoY29tcG9uZW50LCBkYXRhLCByb3V0ZSwgY29uZmlnUHJvcHMpIHsKICAvLyByZXNvbHZlIHByb3BzCiAgdmFyIHByb3BzVG9QYXNzID0gZGF0YS5wcm9wcyA9IHJlc29sdmVQcm9wcyhyb3V0ZSwgY29uZmlnUHJvcHMpOwogIGlmIChwcm9wc1RvUGFzcykgewogICAgLy8gY2xvbmUgdG8gcHJldmVudCBtdXRhdGlvbgogICAgcHJvcHNUb1Bhc3MgPSBkYXRhLnByb3BzID0gZXh0ZW5kKHt9LCBwcm9wc1RvUGFzcyk7CiAgICAvLyBwYXNzIG5vbi1kZWNsYXJlZCBwcm9wcyBhcyBhdHRycwogICAgdmFyIGF0dHJzID0gZGF0YS5hdHRycyA9IGRhdGEuYXR0cnMgfHwge307CiAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHNUb1Bhc3MpIHsKICAgICAgaWYgKCFjb21wb25lbnQucHJvcHMgfHwgIShrZXkgaW4gY29tcG9uZW50LnByb3BzKSkgewogICAgICAgIGF0dHJzW2tleV0gPSBwcm9wc1RvUGFzc1trZXldOwogICAgICAgIGRlbGV0ZSBwcm9wc1RvUGFzc1trZXldOwogICAgICB9CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHJlc29sdmVQcm9wcyhyb3V0ZSwgY29uZmlnKSB7CiAgc3dpdGNoICh0eXBlb2YgY29uZmlnKSB7CiAgICBjYXNlICd1bmRlZmluZWQnOgogICAgICByZXR1cm47CiAgICBjYXNlICdvYmplY3QnOgogICAgICByZXR1cm4gY29uZmlnOwogICAgY2FzZSAnZnVuY3Rpb24nOgogICAgICByZXR1cm4gY29uZmlnKHJvdXRlKTsKICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICByZXR1cm4gY29uZmlnID8gcm91dGUucGFyYW1zIDogdW5kZWZpbmVkOwogICAgZGVmYXVsdDoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICB3YXJuKGZhbHNlLCAicHJvcHMgaW4gXCIiICsgcm91dGUucGF0aCArICJcIiBpcyBhICIgKyB0eXBlb2YgY29uZmlnICsgIiwgIiArICJleHBlY3RpbmcgYW4gb2JqZWN0LCBmdW5jdGlvbiBvciBib29sZWFuLiIpOwogICAgICB9CiAgfQp9CgovKiAgKi8KCmZ1bmN0aW9uIHJlc29sdmVQYXRoKHJlbGF0aXZlLCBiYXNlLCBhcHBlbmQpIHsKICB2YXIgZmlyc3RDaGFyID0gcmVsYXRpdmUuY2hhckF0KDApOwogIGlmIChmaXJzdENoYXIgPT09ICcvJykgewogICAgcmV0dXJuIHJlbGF0aXZlOwogIH0KICBpZiAoZmlyc3RDaGFyID09PSAnPycgfHwgZmlyc3RDaGFyID09PSAnIycpIHsKICAgIHJldHVybiBiYXNlICsgcmVsYXRpdmU7CiAgfQogIHZhciBzdGFjayA9IGJhc2Uuc3BsaXQoJy8nKTsKCiAgLy8gcmVtb3ZlIHRyYWlsaW5nIHNlZ21lbnQgaWY6CiAgLy8gLSBub3QgYXBwZW5kaW5nCiAgLy8gLSBhcHBlbmRpbmcgdG8gdHJhaWxpbmcgc2xhc2ggKGxhc3Qgc2VnbWVudCBpcyBlbXB0eSkKICBpZiAoIWFwcGVuZCB8fCAhc3RhY2tbc3RhY2subGVuZ3RoIC0gMV0pIHsKICAgIHN0YWNrLnBvcCgpOwogIH0KCiAgLy8gcmVzb2x2ZSByZWxhdGl2ZSBwYXRoCiAgdmFyIHNlZ21lbnRzID0gcmVsYXRpdmUucmVwbGFjZSgvXlwvLywgJycpLnNwbGl0KCcvJyk7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWdtZW50cy5sZW5ndGg7IGkrKykgewogICAgdmFyIHNlZ21lbnQgPSBzZWdtZW50c1tpXTsKICAgIGlmIChzZWdtZW50ID09PSAnLi4nKSB7CiAgICAgIHN0YWNrLnBvcCgpOwogICAgfSBlbHNlIGlmIChzZWdtZW50ICE9PSAnLicpIHsKICAgICAgc3RhY2sucHVzaChzZWdtZW50KTsKICAgIH0KICB9CgogIC8vIGVuc3VyZSBsZWFkaW5nIHNsYXNoCiAgaWYgKHN0YWNrWzBdICE9PSAnJykgewogICAgc3RhY2sudW5zaGlmdCgnJyk7CiAgfQogIHJldHVybiBzdGFjay5qb2luKCcvJyk7Cn0KZnVuY3Rpb24gcGFyc2VQYXRoKHBhdGgpIHsKICB2YXIgaGFzaCA9ICcnOwogIHZhciBxdWVyeSA9ICcnOwogIHZhciBoYXNoSW5kZXggPSBwYXRoLmluZGV4T2YoJyMnKTsKICBpZiAoaGFzaEluZGV4ID49IDApIHsKICAgIGhhc2ggPSBwYXRoLnNsaWNlKGhhc2hJbmRleCk7CiAgICBwYXRoID0gcGF0aC5zbGljZSgwLCBoYXNoSW5kZXgpOwogIH0KICB2YXIgcXVlcnlJbmRleCA9IHBhdGguaW5kZXhPZignPycpOwogIGlmIChxdWVyeUluZGV4ID49IDApIHsKICAgIHF1ZXJ5ID0gcGF0aC5zbGljZShxdWVyeUluZGV4ICsgMSk7CiAgICBwYXRoID0gcGF0aC5zbGljZSgwLCBxdWVyeUluZGV4KTsKICB9CiAgcmV0dXJuIHsKICAgIHBhdGg6IHBhdGgsCiAgICBxdWVyeTogcXVlcnksCiAgICBoYXNoOiBoYXNoCiAgfTsKfQpmdW5jdGlvbiBjbGVhblBhdGgocGF0aCkgewogIHJldHVybiBwYXRoLnJlcGxhY2UoL1wvKD86XHMqXC8pKy9nLCAnLycpOwp9CnZhciBpc2FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoYXJyKSB7CiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChhcnIpID09ICdbb2JqZWN0IEFycmF5XSc7Cn07CgovKioKICogRXhwb3NlIGBwYXRoVG9SZWdleHBgLgogKi8KdmFyIHBhdGhUb1JlZ2V4cF8xID0gcGF0aFRvUmVnZXhwOwp2YXIgcGFyc2VfMSA9IHBhcnNlOwp2YXIgY29tcGlsZV8xID0gY29tcGlsZTsKdmFyIHRva2Vuc1RvRnVuY3Rpb25fMSA9IHRva2Vuc1RvRnVuY3Rpb247CnZhciB0b2tlbnNUb1JlZ0V4cF8xID0gdG9rZW5zVG9SZWdFeHA7CgovKioKICogVGhlIG1haW4gcGF0aCBtYXRjaGluZyByZWdleHAgdXRpbGl0eS4KICoKICogQHR5cGUge1JlZ0V4cH0KICovCnZhciBQQVRIX1JFR0VYUCA9IG5ldyBSZWdFeHAoWwovLyBNYXRjaCBlc2NhcGVkIGNoYXJhY3RlcnMgdGhhdCB3b3VsZCBvdGhlcndpc2UgYXBwZWFyIGluIGZ1dHVyZSBtYXRjaGVzLgovLyBUaGlzIGFsbG93cyB0aGUgdXNlciB0byBlc2NhcGUgc3BlY2lhbCBjaGFyYWN0ZXJzIHRoYXQgd29uJ3QgdHJhbnNmb3JtLgonKFxcXFwuKScsCi8vIE1hdGNoIEV4cHJlc3Mtc3R5bGUgcGFyYW1ldGVycyBhbmQgdW4tbmFtZWQgcGFyYW1ldGVycyB3aXRoIGEgcHJlZml4Ci8vIGFuZCBvcHRpb25hbCBzdWZmaXhlcy4gTWF0Y2hlcyBhcHBlYXIgYXM6Ci8vCi8vICIvOnRlc3QoXFxkKyk/IiA9PiBbIi8iLCAidGVzdCIsICJcZCsiLCB1bmRlZmluZWQsICI/IiwgdW5kZWZpbmVkXQovLyAiL3JvdXRlKFxcZCspIiAgPT4gW3VuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsICJcZCsiLCB1bmRlZmluZWQsIHVuZGVmaW5lZF0KLy8gIi8qIiAgICAgICAgICAgID0+IFsiLyIsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgIioiXQonKFtcXC8uXSk/KD86KD86XFw6KFxcdyspKD86XFwoKCg/OlxcXFwufFteXFxcXCgpXSkrKVxcKSk/fFxcKCgoPzpcXFxcLnxbXlxcXFwoKV0pKylcXCkpKFsrKj9dKT98KFxcKikpJ10uam9pbignfCcpLCAnZycpOwoKLyoqCiAqIFBhcnNlIGEgc3RyaW5nIGZvciB0aGUgcmF3IHRva2Vucy4KICoKICogQHBhcmFtICB7c3RyaW5nfSAgc3RyCiAqIEBwYXJhbSAge09iamVjdD19IG9wdGlvbnMKICogQHJldHVybiB7IUFycmF5fQogKi8KZnVuY3Rpb24gcGFyc2Uoc3RyLCBvcHRpb25zKSB7CiAgdmFyIHRva2VucyA9IFtdOwogIHZhciBrZXkgPSAwOwogIHZhciBpbmRleCA9IDA7CiAgdmFyIHBhdGggPSAnJzsKICB2YXIgZGVmYXVsdERlbGltaXRlciA9IG9wdGlvbnMgJiYgb3B0aW9ucy5kZWxpbWl0ZXIgfHwgJy8nOwogIHZhciByZXM7CiAgd2hpbGUgKChyZXMgPSBQQVRIX1JFR0VYUC5leGVjKHN0cikpICE9IG51bGwpIHsKICAgIHZhciBtID0gcmVzWzBdOwogICAgdmFyIGVzY2FwZWQgPSByZXNbMV07CiAgICB2YXIgb2Zmc2V0ID0gcmVzLmluZGV4OwogICAgcGF0aCArPSBzdHIuc2xpY2UoaW5kZXgsIG9mZnNldCk7CiAgICBpbmRleCA9IG9mZnNldCArIG0ubGVuZ3RoOwoKICAgIC8vIElnbm9yZSBhbHJlYWR5IGVzY2FwZWQgc2VxdWVuY2VzLgogICAgaWYgKGVzY2FwZWQpIHsKICAgICAgcGF0aCArPSBlc2NhcGVkWzFdOwogICAgICBjb250aW51ZTsKICAgIH0KICAgIHZhciBuZXh0ID0gc3RyW2luZGV4XTsKICAgIHZhciBwcmVmaXggPSByZXNbMl07CiAgICB2YXIgbmFtZSA9IHJlc1szXTsKICAgIHZhciBjYXB0dXJlID0gcmVzWzRdOwogICAgdmFyIGdyb3VwID0gcmVzWzVdOwogICAgdmFyIG1vZGlmaWVyID0gcmVzWzZdOwogICAgdmFyIGFzdGVyaXNrID0gcmVzWzddOwoKICAgIC8vIFB1c2ggdGhlIGN1cnJlbnQgcGF0aCBvbnRvIHRoZSB0b2tlbnMuCiAgICBpZiAocGF0aCkgewogICAgICB0b2tlbnMucHVzaChwYXRoKTsKICAgICAgcGF0aCA9ICcnOwogICAgfQogICAgdmFyIHBhcnRpYWwgPSBwcmVmaXggIT0gbnVsbCAmJiBuZXh0ICE9IG51bGwgJiYgbmV4dCAhPT0gcHJlZml4OwogICAgdmFyIHJlcGVhdCA9IG1vZGlmaWVyID09PSAnKycgfHwgbW9kaWZpZXIgPT09ICcqJzsKICAgIHZhciBvcHRpb25hbCA9IG1vZGlmaWVyID09PSAnPycgfHwgbW9kaWZpZXIgPT09ICcqJzsKICAgIHZhciBkZWxpbWl0ZXIgPSByZXNbMl0gfHwgZGVmYXVsdERlbGltaXRlcjsKICAgIHZhciBwYXR0ZXJuID0gY2FwdHVyZSB8fCBncm91cDsKICAgIHRva2Vucy5wdXNoKHsKICAgICAgbmFtZTogbmFtZSB8fCBrZXkrKywKICAgICAgcHJlZml4OiBwcmVmaXggfHwgJycsCiAgICAgIGRlbGltaXRlcjogZGVsaW1pdGVyLAogICAgICBvcHRpb25hbDogb3B0aW9uYWwsCiAgICAgIHJlcGVhdDogcmVwZWF0LAogICAgICBwYXJ0aWFsOiBwYXJ0aWFsLAogICAgICBhc3RlcmlzazogISFhc3RlcmlzaywKICAgICAgcGF0dGVybjogcGF0dGVybiA/IGVzY2FwZUdyb3VwKHBhdHRlcm4pIDogYXN0ZXJpc2sgPyAnLionIDogJ1teJyArIGVzY2FwZVN0cmluZyhkZWxpbWl0ZXIpICsgJ10rPycKICAgIH0pOwogIH0KCiAgLy8gTWF0Y2ggYW55IGNoYXJhY3RlcnMgc3RpbGwgcmVtYWluaW5nLgogIGlmIChpbmRleCA8IHN0ci5sZW5ndGgpIHsKICAgIHBhdGggKz0gc3RyLnN1YnN0cihpbmRleCk7CiAgfQoKICAvLyBJZiB0aGUgcGF0aCBleGlzdHMsIHB1c2ggaXQgb250byB0aGUgZW5kLgogIGlmIChwYXRoKSB7CiAgICB0b2tlbnMucHVzaChwYXRoKTsKICB9CiAgcmV0dXJuIHRva2VuczsKfQoKLyoqCiAqIENvbXBpbGUgYSBzdHJpbmcgdG8gYSB0ZW1wbGF0ZSBmdW5jdGlvbiBmb3IgdGhlIHBhdGguCiAqCiAqIEBwYXJhbSAge3N0cmluZ30gICAgICAgICAgICAgc3RyCiAqIEBwYXJhbSAge09iamVjdD19ICAgICAgICAgICAgb3B0aW9ucwogKiBAcmV0dXJuIHshZnVuY3Rpb24oT2JqZWN0PSwgT2JqZWN0PSl9CiAqLwpmdW5jdGlvbiBjb21waWxlKHN0ciwgb3B0aW9ucykgewogIHJldHVybiB0b2tlbnNUb0Z1bmN0aW9uKHBhcnNlKHN0ciwgb3B0aW9ucyksIG9wdGlvbnMpOwp9CgovKioKICogUHJldHRpZXIgZW5jb2Rpbmcgb2YgVVJJIHBhdGggc2VnbWVudHMuCiAqCiAqIEBwYXJhbSAge3N0cmluZ30KICogQHJldHVybiB7c3RyaW5nfQogKi8KZnVuY3Rpb24gZW5jb2RlVVJJQ29tcG9uZW50UHJldHR5KHN0cikgewogIHJldHVybiBlbmNvZGVVUkkoc3RyKS5yZXBsYWNlKC9bXC8/I10vZywgZnVuY3Rpb24gKGMpIHsKICAgIHJldHVybiAnJScgKyBjLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCk7CiAgfSk7Cn0KCi8qKgogKiBFbmNvZGUgdGhlIGFzdGVyaXNrIHBhcmFtZXRlci4gU2ltaWxhciB0byBgcHJldHR5YCwgYnV0IGFsbG93cyBzbGFzaGVzLgogKgogKiBAcGFyYW0gIHtzdHJpbmd9CiAqIEByZXR1cm4ge3N0cmluZ30KICovCmZ1bmN0aW9uIGVuY29kZUFzdGVyaXNrKHN0cikgewogIHJldHVybiBlbmNvZGVVUkkoc3RyKS5yZXBsYWNlKC9bPyNdL2csIGZ1bmN0aW9uIChjKSB7CiAgICByZXR1cm4gJyUnICsgYy5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOwogIH0pOwp9CgovKioKICogRXhwb3NlIGEgbWV0aG9kIGZvciB0cmFuc2Zvcm1pbmcgdG9rZW5zIGludG8gdGhlIHBhdGggZnVuY3Rpb24uCiAqLwpmdW5jdGlvbiB0b2tlbnNUb0Z1bmN0aW9uKHRva2Vucywgb3B0aW9ucykgewogIC8vIENvbXBpbGUgYWxsIHRoZSB0b2tlbnMgaW50byByZWdleHBzLgogIHZhciBtYXRjaGVzID0gbmV3IEFycmF5KHRva2Vucy5sZW5ndGgpOwoKICAvLyBDb21waWxlIGFsbCB0aGUgcGF0dGVybnMgYmVmb3JlIGNvbXBpbGF0aW9uLgogIGZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodHlwZW9mIHRva2Vuc1tpXSA9PT0gJ29iamVjdCcpIHsKICAgICAgbWF0Y2hlc1tpXSA9IG5ldyBSZWdFeHAoJ14oPzonICsgdG9rZW5zW2ldLnBhdHRlcm4gKyAnKSQnLCBmbGFncyhvcHRpb25zKSk7CiAgICB9CiAgfQogIHJldHVybiBmdW5jdGlvbiAob2JqLCBvcHRzKSB7CiAgICB2YXIgcGF0aCA9ICcnOwogICAgdmFyIGRhdGEgPSBvYmogfHwge307CiAgICB2YXIgb3B0aW9ucyA9IG9wdHMgfHwge307CiAgICB2YXIgZW5jb2RlID0gb3B0aW9ucy5wcmV0dHkgPyBlbmNvZGVVUklDb21wb25lbnRQcmV0dHkgOiBlbmNvZGVVUklDb21wb25lbnQ7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgdG9rZW4gPSB0b2tlbnNbaV07CiAgICAgIGlmICh0eXBlb2YgdG9rZW4gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcGF0aCArPSB0b2tlbjsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICB2YXIgdmFsdWUgPSBkYXRhW3Rva2VuLm5hbWVdOwogICAgICB2YXIgc2VnbWVudDsKICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICBpZiAodG9rZW4ub3B0aW9uYWwpIHsKICAgICAgICAgIC8vIFByZXBlbmQgcGFydGlhbCBzZWdtZW50IHByZWZpeGVzLgogICAgICAgICAgaWYgKHRva2VuLnBhcnRpYWwpIHsKICAgICAgICAgICAgcGF0aCArPSB0b2tlbi5wcmVmaXg7CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRXhwZWN0ZWQgIicgKyB0b2tlbi5uYW1lICsgJyIgdG8gYmUgZGVmaW5lZCcpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoaXNhcnJheSh2YWx1ZSkpIHsKICAgICAgICBpZiAoIXRva2VuLnJlcGVhdCkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRXhwZWN0ZWQgIicgKyB0b2tlbi5uYW1lICsgJyIgdG8gbm90IHJlcGVhdCwgYnV0IHJlY2VpdmVkIGAnICsgSlNPTi5zdHJpbmdpZnkodmFsdWUpICsgJ2AnKTsKICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgaWYgKHRva2VuLm9wdGlvbmFsKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRXhwZWN0ZWQgIicgKyB0b2tlbi5uYW1lICsgJyIgdG8gbm90IGJlIGVtcHR5Jyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdmFsdWUubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHNlZ21lbnQgPSBlbmNvZGUodmFsdWVbal0pOwogICAgICAgICAgaWYgKCFtYXRjaGVzW2ldLnRlc3Qoc2VnbWVudCkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRXhwZWN0ZWQgYWxsICInICsgdG9rZW4ubmFtZSArICciIHRvIG1hdGNoICInICsgdG9rZW4ucGF0dGVybiArICciLCBidXQgcmVjZWl2ZWQgYCcgKyBKU09OLnN0cmluZ2lmeShzZWdtZW50KSArICdgJyk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXRoICs9IChqID09PSAwID8gdG9rZW4ucHJlZml4IDogdG9rZW4uZGVsaW1pdGVyKSArIHNlZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHNlZ21lbnQgPSB0b2tlbi5hc3RlcmlzayA/IGVuY29kZUFzdGVyaXNrKHZhbHVlKSA6IGVuY29kZSh2YWx1ZSk7CiAgICAgIGlmICghbWF0Y2hlc1tpXS50ZXN0KHNlZ21lbnQpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRXhwZWN0ZWQgIicgKyB0b2tlbi5uYW1lICsgJyIgdG8gbWF0Y2ggIicgKyB0b2tlbi5wYXR0ZXJuICsgJyIsIGJ1dCByZWNlaXZlZCAiJyArIHNlZ21lbnQgKyAnIicpOwogICAgICB9CiAgICAgIHBhdGggKz0gdG9rZW4ucHJlZml4ICsgc2VnbWVudDsKICAgIH0KICAgIHJldHVybiBwYXRoOwogIH07Cn0KCi8qKgogKiBFc2NhcGUgYSByZWd1bGFyIGV4cHJlc3Npb24gc3RyaW5nLgogKgogKiBAcGFyYW0gIHtzdHJpbmd9IHN0cgogKiBAcmV0dXJuIHtzdHJpbmd9CiAqLwpmdW5jdGlvbiBlc2NhcGVTdHJpbmcoc3RyKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKC8oWy4rKj89XiE6JHt9KClbXF18XC9cXF0pL2csICdcXCQxJyk7Cn0KCi8qKgogKiBFc2NhcGUgdGhlIGNhcHR1cmluZyBncm91cCBieSBlc2NhcGluZyBzcGVjaWFsIGNoYXJhY3RlcnMgYW5kIG1lYW5pbmcuCiAqCiAqIEBwYXJhbSAge3N0cmluZ30gZ3JvdXAKICogQHJldHVybiB7c3RyaW5nfQogKi8KZnVuY3Rpb24gZXNjYXBlR3JvdXAoZ3JvdXApIHsKICByZXR1cm4gZ3JvdXAucmVwbGFjZSgvKFs9ITokXC8oKV0pL2csICdcXCQxJyk7Cn0KCi8qKgogKiBBdHRhY2ggdGhlIGtleXMgYXMgYSBwcm9wZXJ0eSBvZiB0aGUgcmVnZXhwLgogKgogKiBAcGFyYW0gIHshUmVnRXhwfSByZQogKiBAcGFyYW0gIHtBcnJheX0gICBrZXlzCiAqIEByZXR1cm4geyFSZWdFeHB9CiAqLwpmdW5jdGlvbiBhdHRhY2hLZXlzKHJlLCBrZXlzKSB7CiAgcmUua2V5cyA9IGtleXM7CiAgcmV0dXJuIHJlOwp9CgovKioKICogR2V0IHRoZSBmbGFncyBmb3IgYSByZWdleHAgZnJvbSB0aGUgb3B0aW9ucy4KICoKICogQHBhcmFtICB7T2JqZWN0fSBvcHRpb25zCiAqIEByZXR1cm4ge3N0cmluZ30KICovCmZ1bmN0aW9uIGZsYWdzKG9wdGlvbnMpIHsKICByZXR1cm4gb3B0aW9ucyAmJiBvcHRpb25zLnNlbnNpdGl2ZSA/ICcnIDogJ2knOwp9CgovKioKICogUHVsbCBvdXQga2V5cyBmcm9tIGEgcmVnZXhwLgogKgogKiBAcGFyYW0gIHshUmVnRXhwfSBwYXRoCiAqIEBwYXJhbSAgeyFBcnJheX0gIGtleXMKICogQHJldHVybiB7IVJlZ0V4cH0KICovCmZ1bmN0aW9uIHJlZ2V4cFRvUmVnZXhwKHBhdGgsIGtleXMpIHsKICAvLyBVc2UgYSBuZWdhdGl2ZSBsb29rYWhlYWQgdG8gbWF0Y2ggb25seSBjYXB0dXJpbmcgZ3JvdXBzLgogIHZhciBncm91cHMgPSBwYXRoLnNvdXJjZS5tYXRjaCgvXCgoPyFcPykvZyk7CiAgaWYgKGdyb3VwcykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cHMubGVuZ3RoOyBpKyspIHsKICAgICAga2V5cy5wdXNoKHsKICAgICAgICBuYW1lOiBpLAogICAgICAgIHByZWZpeDogbnVsbCwKICAgICAgICBkZWxpbWl0ZXI6IG51bGwsCiAgICAgICAgb3B0aW9uYWw6IGZhbHNlLAogICAgICAgIHJlcGVhdDogZmFsc2UsCiAgICAgICAgcGFydGlhbDogZmFsc2UsCiAgICAgICAgYXN0ZXJpc2s6IGZhbHNlLAogICAgICAgIHBhdHRlcm46IG51bGwKICAgICAgfSk7CiAgICB9CiAgfQogIHJldHVybiBhdHRhY2hLZXlzKHBhdGgsIGtleXMpOwp9CgovKioKICogVHJhbnNmb3JtIGFuIGFycmF5IGludG8gYSByZWdleHAuCiAqCiAqIEBwYXJhbSAgeyFBcnJheX0gIHBhdGgKICogQHBhcmFtICB7QXJyYXl9ICAga2V5cwogKiBAcGFyYW0gIHshT2JqZWN0fSBvcHRpb25zCiAqIEByZXR1cm4geyFSZWdFeHB9CiAqLwpmdW5jdGlvbiBhcnJheVRvUmVnZXhwKHBhdGgsIGtleXMsIG9wdGlvbnMpIHsKICB2YXIgcGFydHMgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGgubGVuZ3RoOyBpKyspIHsKICAgIHBhcnRzLnB1c2gocGF0aFRvUmVnZXhwKHBhdGhbaV0sIGtleXMsIG9wdGlvbnMpLnNvdXJjZSk7CiAgfQogIHZhciByZWdleHAgPSBuZXcgUmVnRXhwKCcoPzonICsgcGFydHMuam9pbignfCcpICsgJyknLCBmbGFncyhvcHRpb25zKSk7CiAgcmV0dXJuIGF0dGFjaEtleXMocmVnZXhwLCBrZXlzKTsKfQoKLyoqCiAqIENyZWF0ZSBhIHBhdGggcmVnZXhwIGZyb20gc3RyaW5nIGlucHV0LgogKgogKiBAcGFyYW0gIHtzdHJpbmd9ICBwYXRoCiAqIEBwYXJhbSAgeyFBcnJheX0gIGtleXMKICogQHBhcmFtICB7IU9iamVjdH0gb3B0aW9ucwogKiBAcmV0dXJuIHshUmVnRXhwfQogKi8KZnVuY3Rpb24gc3RyaW5nVG9SZWdleHAocGF0aCwga2V5cywgb3B0aW9ucykgewogIHJldHVybiB0b2tlbnNUb1JlZ0V4cChwYXJzZShwYXRoLCBvcHRpb25zKSwga2V5cywgb3B0aW9ucyk7Cn0KCi8qKgogKiBFeHBvc2UgYSBmdW5jdGlvbiBmb3IgdGFraW5nIHRva2VucyBhbmQgcmV0dXJuaW5nIGEgUmVnRXhwLgogKgogKiBAcGFyYW0gIHshQXJyYXl9ICAgICAgICAgIHRva2VucwogKiBAcGFyYW0gIHsoQXJyYXl8T2JqZWN0KT19IGtleXMKICogQHBhcmFtICB7T2JqZWN0PX0gICAgICAgICBvcHRpb25zCiAqIEByZXR1cm4geyFSZWdFeHB9CiAqLwpmdW5jdGlvbiB0b2tlbnNUb1JlZ0V4cCh0b2tlbnMsIGtleXMsIG9wdGlvbnMpIHsKICBpZiAoIWlzYXJyYXkoa2V5cykpIHsKICAgIG9wdGlvbnMgPSAvKiogQHR5cGUgeyFPYmplY3R9ICova2V5cyB8fCBvcHRpb25zOwogICAga2V5cyA9IFtdOwogIH0KICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICB2YXIgc3RyaWN0ID0gb3B0aW9ucy5zdHJpY3Q7CiAgdmFyIGVuZCA9IG9wdGlvbnMuZW5kICE9PSBmYWxzZTsKICB2YXIgcm91dGUgPSAnJzsKCiAgLy8gSXRlcmF0ZSBvdmVyIHRoZSB0b2tlbnMgYW5kIGNyZWF0ZSBvdXIgcmVnZXhwIHN0cmluZy4KICBmb3IgKHZhciBpID0gMDsgaSA8IHRva2Vucy5sZW5ndGg7IGkrKykgewogICAgdmFyIHRva2VuID0gdG9rZW5zW2ldOwogICAgaWYgKHR5cGVvZiB0b2tlbiA9PT0gJ3N0cmluZycpIHsKICAgICAgcm91dGUgKz0gZXNjYXBlU3RyaW5nKHRva2VuKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBwcmVmaXggPSBlc2NhcGVTdHJpbmcodG9rZW4ucHJlZml4KTsKICAgICAgdmFyIGNhcHR1cmUgPSAnKD86JyArIHRva2VuLnBhdHRlcm4gKyAnKSc7CiAgICAgIGtleXMucHVzaCh0b2tlbik7CiAgICAgIGlmICh0b2tlbi5yZXBlYXQpIHsKICAgICAgICBjYXB0dXJlICs9ICcoPzonICsgcHJlZml4ICsgY2FwdHVyZSArICcpKic7CiAgICAgIH0KICAgICAgaWYgKHRva2VuLm9wdGlvbmFsKSB7CiAgICAgICAgaWYgKCF0b2tlbi5wYXJ0aWFsKSB7CiAgICAgICAgICBjYXB0dXJlID0gJyg/OicgKyBwcmVmaXggKyAnKCcgKyBjYXB0dXJlICsgJykpPyc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhcHR1cmUgPSBwcmVmaXggKyAnKCcgKyBjYXB0dXJlICsgJyk/JzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FwdHVyZSA9IHByZWZpeCArICcoJyArIGNhcHR1cmUgKyAnKSc7CiAgICAgIH0KICAgICAgcm91dGUgKz0gY2FwdHVyZTsKICAgIH0KICB9CiAgdmFyIGRlbGltaXRlciA9IGVzY2FwZVN0cmluZyhvcHRpb25zLmRlbGltaXRlciB8fCAnLycpOwogIHZhciBlbmRzV2l0aERlbGltaXRlciA9IHJvdXRlLnNsaWNlKC1kZWxpbWl0ZXIubGVuZ3RoKSA9PT0gZGVsaW1pdGVyOwoKICAvLyBJbiBub24tc3RyaWN0IG1vZGUgd2UgYWxsb3cgYSBzbGFzaCBhdCB0aGUgZW5kIG9mIG1hdGNoLiBJZiB0aGUgcGF0aCB0bwogIC8vIG1hdGNoIGFscmVhZHkgZW5kcyB3aXRoIGEgc2xhc2gsIHdlIHJlbW92ZSBpdCBmb3IgY29uc2lzdGVuY3kuIFRoZSBzbGFzaAogIC8vIGlzIHZhbGlkIGF0IHRoZSBlbmQgb2YgYSBwYXRoIG1hdGNoLCBub3QgaW4gdGhlIG1pZGRsZS4gVGhpcyBpcyBpbXBvcnRhbnQKICAvLyBpbiBub24tZW5kaW5nIG1vZGUsIHdoZXJlICIvdGVzdC8iIHNob3VsZG4ndCBtYXRjaCAiL3Rlc3QvL3JvdXRlIi4KICBpZiAoIXN0cmljdCkgewogICAgcm91dGUgPSAoZW5kc1dpdGhEZWxpbWl0ZXIgPyByb3V0ZS5zbGljZSgwLCAtZGVsaW1pdGVyLmxlbmd0aCkgOiByb3V0ZSkgKyAnKD86JyArIGRlbGltaXRlciArICcoPz0kKSk/JzsKICB9CiAgaWYgKGVuZCkgewogICAgcm91dGUgKz0gJyQnOwogIH0gZWxzZSB7CiAgICAvLyBJbiBub24tZW5kaW5nIG1vZGUsIHdlIG5lZWQgdGhlIGNhcHR1cmluZyBncm91cHMgdG8gbWF0Y2ggYXMgbXVjaCBhcwogICAgLy8gcG9zc2libGUgYnkgdXNpbmcgYSBwb3NpdGl2ZSBsb29rYWhlYWQgdG8gdGhlIGVuZCBvciBuZXh0IHBhdGggc2VnbWVudC4KICAgIHJvdXRlICs9IHN0cmljdCAmJiBlbmRzV2l0aERlbGltaXRlciA/ICcnIDogJyg/PScgKyBkZWxpbWl0ZXIgKyAnfCQpJzsKICB9CiAgcmV0dXJuIGF0dGFjaEtleXMobmV3IFJlZ0V4cCgnXicgKyByb3V0ZSwgZmxhZ3Mob3B0aW9ucykpLCBrZXlzKTsKfQoKLyoqCiAqIE5vcm1hbGl6ZSB0aGUgZ2l2ZW4gcGF0aCBzdHJpbmcsIHJldHVybmluZyBhIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICoKICogQW4gZW1wdHkgYXJyYXkgY2FuIGJlIHBhc3NlZCBpbiBmb3IgdGhlIGtleXMsIHdoaWNoIHdpbGwgaG9sZCB0aGUKICogcGxhY2Vob2xkZXIga2V5IGRlc2NyaXB0aW9ucy4gRm9yIGV4YW1wbGUsIHVzaW5nIGAvdXNlci86aWRgLCBga2V5c2Agd2lsbAogKiBjb250YWluIGBbeyBuYW1lOiAnaWQnLCBkZWxpbWl0ZXI6ICcvJywgb3B0aW9uYWw6IGZhbHNlLCByZXBlYXQ6IGZhbHNlIH1dYC4KICoKICogQHBhcmFtICB7KHN0cmluZ3xSZWdFeHB8QXJyYXkpfSBwYXRoCiAqIEBwYXJhbSAgeyhBcnJheXxPYmplY3QpPX0gICAgICAga2V5cwogKiBAcGFyYW0gIHtPYmplY3Q9fSAgICAgICAgICAgICAgIG9wdGlvbnMKICogQHJldHVybiB7IVJlZ0V4cH0KICovCmZ1bmN0aW9uIHBhdGhUb1JlZ2V4cChwYXRoLCBrZXlzLCBvcHRpb25zKSB7CiAgaWYgKCFpc2FycmF5KGtleXMpKSB7CiAgICBvcHRpb25zID0gLyoqIEB0eXBlIHshT2JqZWN0fSAqL2tleXMgfHwgb3B0aW9uczsKICAgIGtleXMgPSBbXTsKICB9CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgaWYgKHBhdGggaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgIHJldHVybiByZWdleHBUb1JlZ2V4cChwYXRoLCAvKiogQHR5cGUgeyFBcnJheX0gKi9rZXlzKTsKICB9CiAgaWYgKGlzYXJyYXkocGF0aCkpIHsKICAgIHJldHVybiBhcnJheVRvUmVnZXhwKCAvKiogQHR5cGUgeyFBcnJheX0gKi9wYXRoLCAvKiogQHR5cGUgeyFBcnJheX0gKi9rZXlzLCBvcHRpb25zKTsKICB9CiAgcmV0dXJuIHN0cmluZ1RvUmVnZXhwKCAvKiogQHR5cGUge3N0cmluZ30gKi9wYXRoLCAvKiogQHR5cGUgeyFBcnJheX0gKi9rZXlzLCBvcHRpb25zKTsKfQpwYXRoVG9SZWdleHBfMS5wYXJzZSA9IHBhcnNlXzE7CnBhdGhUb1JlZ2V4cF8xLmNvbXBpbGUgPSBjb21waWxlXzE7CnBhdGhUb1JlZ2V4cF8xLnRva2Vuc1RvRnVuY3Rpb24gPSB0b2tlbnNUb0Z1bmN0aW9uXzE7CnBhdGhUb1JlZ2V4cF8xLnRva2Vuc1RvUmVnRXhwID0gdG9rZW5zVG9SZWdFeHBfMTsKCi8qICAqLwoKLy8gJGZsb3ctZGlzYWJsZS1saW5lCnZhciByZWdleHBDb21waWxlQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwpmdW5jdGlvbiBmaWxsUGFyYW1zKHBhdGgsIHBhcmFtcywgcm91dGVNc2cpIHsKICBwYXJhbXMgPSBwYXJhbXMgfHwge307CiAgdHJ5IHsKICAgIHZhciBmaWxsZXIgPSByZWdleHBDb21waWxlQ2FjaGVbcGF0aF0gfHwgKHJlZ2V4cENvbXBpbGVDYWNoZVtwYXRoXSA9IHBhdGhUb1JlZ2V4cF8xLmNvbXBpbGUocGF0aCkpOwoKICAgIC8vIEZpeCAjMjUwNSByZXNvbHZpbmcgYXN0ZXJpc2sgcm91dGVzIHsgbmFtZTogJ25vdC1mb3VuZCcsIHBhcmFtczogeyBwYXRoTWF0Y2g6ICcvbm90LWZvdW5kJyB9fQogICAgLy8gYW5kIGZpeCAjMzEwNiBzbyB0aGF0IHlvdSBjYW4gd29yayB3aXRoIGxvY2F0aW9uIGRlc2NyaXB0b3Igb2JqZWN0IGhhdmluZyBwYXJhbXMucGF0aE1hdGNoIGVxdWFsIHRvIGVtcHR5IHN0cmluZwogICAgaWYgKHR5cGVvZiBwYXJhbXMucGF0aE1hdGNoID09PSAnc3RyaW5nJykgewogICAgICBwYXJhbXNbMF0gPSBwYXJhbXMucGF0aE1hdGNoOwogICAgfQogICAgcmV0dXJuIGZpbGxlcihwYXJhbXMsIHsKICAgICAgcHJldHR5OiB0cnVlCiAgICB9KTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAvLyBGaXggIzMwNzIgbm8gd2FybiBpZiBgcGF0aE1hdGNoYCBpcyBzdHJpbmcKICAgICAgd2Fybih0eXBlb2YgcGFyYW1zLnBhdGhNYXRjaCA9PT0gJ3N0cmluZycsICJtaXNzaW5nIHBhcmFtIGZvciAiICsgcm91dGVNc2cgKyAiOiAiICsgZS5tZXNzYWdlKTsKICAgIH0KICAgIHJldHVybiAnJzsKICB9IGZpbmFsbHkgewogICAgLy8gZGVsZXRlIHRoZSAwIGlmIGl0IHdhcyBhZGRlZAogICAgZGVsZXRlIHBhcmFtc1swXTsKICB9Cn0KCi8qICAqLwoKZnVuY3Rpb24gbm9ybWFsaXplTG9jYXRpb24ocmF3LCBjdXJyZW50LCBhcHBlbmQsIHJvdXRlcikgewogIHZhciBuZXh0ID0gdHlwZW9mIHJhdyA9PT0gJ3N0cmluZycgPyB7CiAgICBwYXRoOiByYXcKICB9IDogcmF3OwogIC8vIG5hbWVkIHRhcmdldAogIGlmIChuZXh0Ll9ub3JtYWxpemVkKSB7CiAgICByZXR1cm4gbmV4dDsKICB9IGVsc2UgaWYgKG5leHQubmFtZSkgewogICAgbmV4dCA9IGV4dGVuZCh7fSwgcmF3KTsKICAgIHZhciBwYXJhbXMgPSBuZXh0LnBhcmFtczsKICAgIGlmIChwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gJ29iamVjdCcpIHsKICAgICAgbmV4dC5wYXJhbXMgPSBleHRlbmQoe30sIHBhcmFtcyk7CiAgICB9CiAgICByZXR1cm4gbmV4dDsKICB9CgogIC8vIHJlbGF0aXZlIHBhcmFtcwogIGlmICghbmV4dC5wYXRoICYmIG5leHQucGFyYW1zICYmIGN1cnJlbnQpIHsKICAgIG5leHQgPSBleHRlbmQoe30sIG5leHQpOwogICAgbmV4dC5fbm9ybWFsaXplZCA9IHRydWU7CiAgICB2YXIgcGFyYW1zJDEgPSBleHRlbmQoZXh0ZW5kKHt9LCBjdXJyZW50LnBhcmFtcyksIG5leHQucGFyYW1zKTsKICAgIGlmIChjdXJyZW50Lm5hbWUpIHsKICAgICAgbmV4dC5uYW1lID0gY3VycmVudC5uYW1lOwogICAgICBuZXh0LnBhcmFtcyA9IHBhcmFtcyQxOwogICAgfSBlbHNlIGlmIChjdXJyZW50Lm1hdGNoZWQubGVuZ3RoKSB7CiAgICAgIHZhciByYXdQYXRoID0gY3VycmVudC5tYXRjaGVkW2N1cnJlbnQubWF0Y2hlZC5sZW5ndGggLSAxXS5wYXRoOwogICAgICBuZXh0LnBhdGggPSBmaWxsUGFyYW1zKHJhd1BhdGgsIHBhcmFtcyQxLCAicGF0aCAiICsgY3VycmVudC5wYXRoKTsKICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB3YXJuKGZhbHNlLCAicmVsYXRpdmUgcGFyYW1zIG5hdmlnYXRpb24gcmVxdWlyZXMgYSBjdXJyZW50IHJvdXRlLiIpOwogICAgfQogICAgcmV0dXJuIG5leHQ7CiAgfQogIHZhciBwYXJzZWRQYXRoID0gcGFyc2VQYXRoKG5leHQucGF0aCB8fCAnJyk7CiAgdmFyIGJhc2VQYXRoID0gY3VycmVudCAmJiBjdXJyZW50LnBhdGggfHwgJy8nOwogIHZhciBwYXRoID0gcGFyc2VkUGF0aC5wYXRoID8gcmVzb2x2ZVBhdGgocGFyc2VkUGF0aC5wYXRoLCBiYXNlUGF0aCwgYXBwZW5kIHx8IG5leHQuYXBwZW5kKSA6IGJhc2VQYXRoOwogIHZhciBxdWVyeSA9IHJlc29sdmVRdWVyeShwYXJzZWRQYXRoLnF1ZXJ5LCBuZXh0LnF1ZXJ5LCByb3V0ZXIgJiYgcm91dGVyLm9wdGlvbnMucGFyc2VRdWVyeSk7CiAgdmFyIGhhc2ggPSBuZXh0Lmhhc2ggfHwgcGFyc2VkUGF0aC5oYXNoOwogIGlmIChoYXNoICYmIGhhc2guY2hhckF0KDApICE9PSAnIycpIHsKICAgIGhhc2ggPSAiIyIgKyBoYXNoOwogIH0KICByZXR1cm4gewogICAgX25vcm1hbGl6ZWQ6IHRydWUsCiAgICBwYXRoOiBwYXRoLAogICAgcXVlcnk6IHF1ZXJ5LAogICAgaGFzaDogaGFzaAogIH07Cn0KCi8qICAqLwoKLy8gd29yayBhcm91bmQgd2VpcmQgZmxvdyBidWcKdmFyIHRvVHlwZXMgPSBbU3RyaW5nLCBPYmplY3RdOwp2YXIgZXZlbnRUeXBlcyA9IFtTdHJpbmcsIEFycmF5XTsKdmFyIG5vb3AgPSBmdW5jdGlvbiBub29wKCkge307CnZhciB3YXJuZWRDdXN0b21TbG90Owp2YXIgd2FybmVkVGFnUHJvcDsKdmFyIHdhcm5lZEV2ZW50UHJvcDsKdmFyIExpbmsgPSB7CiAgbmFtZTogJ1JvdXRlckxpbmsnLAogIHByb3BzOiB7CiAgICB0bzogewogICAgICB0eXBlOiB0b1R5cGVzLAogICAgICByZXF1aXJlZDogdHJ1ZQogICAgfSwKICAgIHRhZzogewogICAgICB0eXBlOiBTdHJpbmcsCiAgICAgIGRlZmF1bHQ6ICdhJwogICAgfSwKICAgIGN1c3RvbTogQm9vbGVhbiwKICAgIGV4YWN0OiBCb29sZWFuLAogICAgZXhhY3RQYXRoOiBCb29sZWFuLAogICAgYXBwZW5kOiBCb29sZWFuLAogICAgcmVwbGFjZTogQm9vbGVhbiwKICAgIGFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgICBleGFjdEFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgICBhcmlhQ3VycmVudFZhbHVlOiB7CiAgICAgIHR5cGU6IFN0cmluZywKICAgICAgZGVmYXVsdDogJ3BhZ2UnCiAgICB9LAogICAgZXZlbnQ6IHsKICAgICAgdHlwZTogZXZlbnRUeXBlcywKICAgICAgZGVmYXVsdDogJ2NsaWNrJwogICAgfQogIH0sCiAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoaCkgewogICAgdmFyIHRoaXMkMSQxID0gdGhpczsKICAgIHZhciByb3V0ZXIgPSB0aGlzLiRyb3V0ZXI7CiAgICB2YXIgY3VycmVudCA9IHRoaXMuJHJvdXRlOwogICAgdmFyIHJlZiA9IHJvdXRlci5yZXNvbHZlKHRoaXMudG8sIGN1cnJlbnQsIHRoaXMuYXBwZW5kKTsKICAgIHZhciBsb2NhdGlvbiA9IHJlZi5sb2NhdGlvbjsKICAgIHZhciByb3V0ZSA9IHJlZi5yb3V0ZTsKICAgIHZhciBocmVmID0gcmVmLmhyZWY7CiAgICB2YXIgY2xhc3NlcyA9IHt9OwogICAgdmFyIGdsb2JhbEFjdGl2ZUNsYXNzID0gcm91dGVyLm9wdGlvbnMubGlua0FjdGl2ZUNsYXNzOwogICAgdmFyIGdsb2JhbEV4YWN0QWN0aXZlQ2xhc3MgPSByb3V0ZXIub3B0aW9ucy5saW5rRXhhY3RBY3RpdmVDbGFzczsKICAgIC8vIFN1cHBvcnQgZ2xvYmFsIGVtcHR5IGFjdGl2ZSBjbGFzcwogICAgdmFyIGFjdGl2ZUNsYXNzRmFsbGJhY2sgPSBnbG9iYWxBY3RpdmVDbGFzcyA9PSBudWxsID8gJ3JvdXRlci1saW5rLWFjdGl2ZScgOiBnbG9iYWxBY3RpdmVDbGFzczsKICAgIHZhciBleGFjdEFjdGl2ZUNsYXNzRmFsbGJhY2sgPSBnbG9iYWxFeGFjdEFjdGl2ZUNsYXNzID09IG51bGwgPyAncm91dGVyLWxpbmstZXhhY3QtYWN0aXZlJyA6IGdsb2JhbEV4YWN0QWN0aXZlQ2xhc3M7CiAgICB2YXIgYWN0aXZlQ2xhc3MgPSB0aGlzLmFjdGl2ZUNsYXNzID09IG51bGwgPyBhY3RpdmVDbGFzc0ZhbGxiYWNrIDogdGhpcy5hY3RpdmVDbGFzczsKICAgIHZhciBleGFjdEFjdGl2ZUNsYXNzID0gdGhpcy5leGFjdEFjdGl2ZUNsYXNzID09IG51bGwgPyBleGFjdEFjdGl2ZUNsYXNzRmFsbGJhY2sgOiB0aGlzLmV4YWN0QWN0aXZlQ2xhc3M7CiAgICB2YXIgY29tcGFyZVRhcmdldCA9IHJvdXRlLnJlZGlyZWN0ZWRGcm9tID8gY3JlYXRlUm91dGUobnVsbCwgbm9ybWFsaXplTG9jYXRpb24ocm91dGUucmVkaXJlY3RlZEZyb20pLCBudWxsLCByb3V0ZXIpIDogcm91dGU7CiAgICBjbGFzc2VzW2V4YWN0QWN0aXZlQ2xhc3NdID0gaXNTYW1lUm91dGUoY3VycmVudCwgY29tcGFyZVRhcmdldCwgdGhpcy5leGFjdFBhdGgpOwogICAgY2xhc3Nlc1thY3RpdmVDbGFzc10gPSB0aGlzLmV4YWN0IHx8IHRoaXMuZXhhY3RQYXRoID8gY2xhc3Nlc1tleGFjdEFjdGl2ZUNsYXNzXSA6IGlzSW5jbHVkZWRSb3V0ZShjdXJyZW50LCBjb21wYXJlVGFyZ2V0KTsKICAgIHZhciBhcmlhQ3VycmVudFZhbHVlID0gY2xhc3Nlc1tleGFjdEFjdGl2ZUNsYXNzXSA/IHRoaXMuYXJpYUN1cnJlbnRWYWx1ZSA6IG51bGw7CiAgICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uIGhhbmRsZXIoZSkgewogICAgICBpZiAoZ3VhcmRFdmVudChlKSkgewogICAgICAgIGlmICh0aGlzJDEkMS5yZXBsYWNlKSB7CiAgICAgICAgICByb3V0ZXIucmVwbGFjZShsb2NhdGlvbiwgbm9vcCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJvdXRlci5wdXNoKGxvY2F0aW9uLCBub29wKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgb24gPSB7CiAgICAgIGNsaWNrOiBndWFyZEV2ZW50CiAgICB9OwogICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5ldmVudCkpIHsKICAgICAgdGhpcy5ldmVudC5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgb25bZV0gPSBoYW5kbGVyOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIG9uW3RoaXMuZXZlbnRdID0gaGFuZGxlcjsKICAgIH0KICAgIHZhciBkYXRhID0gewogICAgICBjbGFzczogY2xhc3NlcwogICAgfTsKICAgIHZhciBzY29wZWRTbG90ID0gIXRoaXMuJHNjb3BlZFNsb3RzLiRoYXNOb3JtYWwgJiYgdGhpcy4kc2NvcGVkU2xvdHMuZGVmYXVsdCAmJiB0aGlzLiRzY29wZWRTbG90cy5kZWZhdWx0KHsKICAgICAgaHJlZjogaHJlZiwKICAgICAgcm91dGU6IHJvdXRlLAogICAgICBuYXZpZ2F0ZTogaGFuZGxlciwKICAgICAgaXNBY3RpdmU6IGNsYXNzZXNbYWN0aXZlQ2xhc3NdLAogICAgICBpc0V4YWN0QWN0aXZlOiBjbGFzc2VzW2V4YWN0QWN0aXZlQ2xhc3NdCiAgICB9KTsKICAgIGlmIChzY29wZWRTbG90KSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICF0aGlzLmN1c3RvbSkgewogICAgICAgICF3YXJuZWRDdXN0b21TbG90ICYmIHdhcm4oZmFsc2UsICdJbiBWdWUgUm91dGVyIDQsIHRoZSB2LXNsb3QgQVBJIHdpbGwgYnkgZGVmYXVsdCB3cmFwIGl0cyBjb250ZW50IHdpdGggYW4gPGE+IGVsZW1lbnQuIFVzZSB0aGUgY3VzdG9tIHByb3AgdG8gcmVtb3ZlIHRoaXMgd2FybmluZzpcbjxyb3V0ZXItbGluayB2LXNsb3Q9InsgbmF2aWdhdGUsIGhyZWYgfSIgY3VzdG9tPjwvcm91dGVyLWxpbms+XG4nKTsKICAgICAgICB3YXJuZWRDdXN0b21TbG90ID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoc2NvcGVkU2xvdC5sZW5ndGggPT09IDEpIHsKICAgICAgICByZXR1cm4gc2NvcGVkU2xvdFswXTsKICAgICAgfSBlbHNlIGlmIChzY29wZWRTbG90Lmxlbmd0aCA+IDEgfHwgIXNjb3BlZFNsb3QubGVuZ3RoKSB7CiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIHdhcm4oZmFsc2UsICI8cm91dGVyLWxpbms+IHdpdGggdG89XCIiICsgdGhpcy50byArICJcIiBpcyB0cnlpbmcgdG8gdXNlIGEgc2NvcGVkIHNsb3QgYnV0IGl0IGRpZG4ndCBwcm92aWRlIGV4YWN0bHkgb25lIGNoaWxkLiBXcmFwcGluZyB0aGUgY29udGVudCB3aXRoIGEgc3BhbiBlbGVtZW50LiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2NvcGVkU2xvdC5sZW5ndGggPT09IDAgPyBoKCkgOiBoKCdzcGFuJywge30sIHNjb3BlZFNsb3QpOwogICAgICB9CiAgICB9CiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpZiAoJ3RhZycgaW4gdGhpcy4kb3B0aW9ucy5wcm9wc0RhdGEgJiYgIXdhcm5lZFRhZ1Byb3ApIHsKICAgICAgICB3YXJuKGZhbHNlLCAiPHJvdXRlci1saW5rPidzIHRhZyBwcm9wIGlzIGRlcHJlY2F0ZWQgYW5kIGhhcyBiZWVuIHJlbW92ZWQgaW4gVnVlIFJvdXRlciA0LiBVc2UgdGhlIHYtc2xvdCBBUEkgdG8gcmVtb3ZlIHRoaXMgd2FybmluZzogaHR0cHM6Ly9uZXh0LnJvdXRlci52dWVqcy5vcmcvZ3VpZGUvbWlncmF0aW9uLyNyZW1vdmFsLW9mLWV2ZW50LWFuZC10YWctcHJvcHMtaW4tcm91dGVyLWxpbmsuIik7CiAgICAgICAgd2FybmVkVGFnUHJvcCA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKCdldmVudCcgaW4gdGhpcy4kb3B0aW9ucy5wcm9wc0RhdGEgJiYgIXdhcm5lZEV2ZW50UHJvcCkgewogICAgICAgIHdhcm4oZmFsc2UsICI8cm91dGVyLWxpbms+J3MgZXZlbnQgcHJvcCBpcyBkZXByZWNhdGVkIGFuZCBoYXMgYmVlbiByZW1vdmVkIGluIFZ1ZSBSb3V0ZXIgNC4gVXNlIHRoZSB2LXNsb3QgQVBJIHRvIHJlbW92ZSB0aGlzIHdhcm5pbmc6IGh0dHBzOi8vbmV4dC5yb3V0ZXIudnVlanMub3JnL2d1aWRlL21pZ3JhdGlvbi8jcmVtb3ZhbC1vZi1ldmVudC1hbmQtdGFnLXByb3BzLWluLXJvdXRlci1saW5rLiIpOwogICAgICAgIHdhcm5lZEV2ZW50UHJvcCA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLnRhZyA9PT0gJ2EnKSB7CiAgICAgIGRhdGEub24gPSBvbjsKICAgICAgZGF0YS5hdHRycyA9IHsKICAgICAgICBocmVmOiBocmVmLAogICAgICAgICdhcmlhLWN1cnJlbnQnOiBhcmlhQ3VycmVudFZhbHVlCiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAvLyBmaW5kIHRoZSBmaXJzdCA8YT4gY2hpbGQgYW5kIGFwcGx5IGxpc3RlbmVyIGFuZCBocmVmCiAgICAgIHZhciBhID0gZmluZEFuY2hvcih0aGlzLiRzbG90cy5kZWZhdWx0KTsKICAgICAgaWYgKGEpIHsKICAgICAgICAvLyBpbiBjYXNlIHRoZSA8YT4gaXMgYSBzdGF0aWMgbm9kZQogICAgICAgIGEuaXNTdGF0aWMgPSBmYWxzZTsKICAgICAgICB2YXIgYURhdGEgPSBhLmRhdGEgPSBleHRlbmQoe30sIGEuZGF0YSk7CiAgICAgICAgYURhdGEub24gPSBhRGF0YS5vbiB8fCB7fTsKICAgICAgICAvLyB0cmFuc2Zvcm0gZXhpc3RpbmcgZXZlbnRzIGluIGJvdGggb2JqZWN0cyBpbnRvIGFycmF5cyBzbyB3ZSBjYW4gcHVzaCBsYXRlcgogICAgICAgIGZvciAodmFyIGV2ZW50IGluIGFEYXRhLm9uKSB7CiAgICAgICAgICB2YXIgaGFuZGxlciQxID0gYURhdGEub25bZXZlbnRdOwogICAgICAgICAgaWYgKGV2ZW50IGluIG9uKSB7CiAgICAgICAgICAgIGFEYXRhLm9uW2V2ZW50XSA9IEFycmF5LmlzQXJyYXkoaGFuZGxlciQxKSA/IGhhbmRsZXIkMSA6IFtoYW5kbGVyJDFdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBhcHBlbmQgbmV3IGxpc3RlbmVycyBmb3Igcm91dGVyLWxpbmsKICAgICAgICBmb3IgKHZhciBldmVudCQxIGluIG9uKSB7CiAgICAgICAgICBpZiAoZXZlbnQkMSBpbiBhRGF0YS5vbikgewogICAgICAgICAgICAvLyBvbltldmVudF0gaXMgYWx3YXlzIGEgZnVuY3Rpb24KICAgICAgICAgICAgYURhdGEub25bZXZlbnQkMV0ucHVzaChvbltldmVudCQxXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhRGF0YS5vbltldmVudCQxXSA9IGhhbmRsZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhQXR0cnMgPSBhLmRhdGEuYXR0cnMgPSBleHRlbmQoe30sIGEuZGF0YS5hdHRycyk7CiAgICAgICAgYUF0dHJzLmhyZWYgPSBocmVmOwogICAgICAgIGFBdHRyc1snYXJpYS1jdXJyZW50J10gPSBhcmlhQ3VycmVudFZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGRvZXNuJ3QgaGF2ZSA8YT4gY2hpbGQsIGFwcGx5IGxpc3RlbmVyIHRvIHNlbGYKICAgICAgICBkYXRhLm9uID0gb247CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBoKHRoaXMudGFnLCBkYXRhLCB0aGlzLiRzbG90cy5kZWZhdWx0KTsKICB9Cn07CmZ1bmN0aW9uIGd1YXJkRXZlbnQoZSkgewogIC8vIGRvbid0IHJlZGlyZWN0IHdpdGggY29udHJvbCBrZXlzCiAgaWYgKGUubWV0YUtleSB8fCBlLmFsdEtleSB8fCBlLmN0cmxLZXkgfHwgZS5zaGlmdEtleSkgewogICAgcmV0dXJuOwogIH0KICAvLyBkb24ndCByZWRpcmVjdCB3aGVuIHByZXZlbnREZWZhdWx0IGNhbGxlZAogIGlmIChlLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgIHJldHVybjsKICB9CiAgLy8gZG9uJ3QgcmVkaXJlY3Qgb24gcmlnaHQgY2xpY2sKICBpZiAoZS5idXR0b24gIT09IHVuZGVmaW5lZCAmJiBlLmJ1dHRvbiAhPT0gMCkgewogICAgcmV0dXJuOwogIH0KICAvLyBkb24ndCByZWRpcmVjdCBpZiBgdGFyZ2V0PSJfYmxhbmsiYAogIGlmIChlLmN1cnJlbnRUYXJnZXQgJiYgZS5jdXJyZW50VGFyZ2V0LmdldEF0dHJpYnV0ZSkgewogICAgdmFyIHRhcmdldCA9IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoJ3RhcmdldCcpOwogICAgaWYgKC9cYl9ibGFua1xiL2kudGVzdCh0YXJnZXQpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICB9CiAgLy8gdGhpcyBtYXkgYmUgYSBXZWV4IGV2ZW50IHdoaWNoIGRvZXNuJ3QgaGF2ZSB0aGlzIG1ldGhvZAogIGlmIChlLnByZXZlbnREZWZhdWx0KSB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIGZpbmRBbmNob3IoY2hpbGRyZW4pIHsKICBpZiAoY2hpbGRyZW4pIHsKICAgIHZhciBjaGlsZDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gJ2EnKSB7CiAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICB9CiAgICAgIGlmIChjaGlsZC5jaGlsZHJlbiAmJiAoY2hpbGQgPSBmaW5kQW5jaG9yKGNoaWxkLmNoaWxkcmVuKSkpIHsKICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgIH0KICAgIH0KICB9Cn0KdmFyIF9WdWU7CmZ1bmN0aW9uIGluc3RhbGwoVnVlKSB7CiAgaWYgKGluc3RhbGwuaW5zdGFsbGVkICYmIF9WdWUgPT09IFZ1ZSkgewogICAgcmV0dXJuOwogIH0KICBpbnN0YWxsLmluc3RhbGxlZCA9IHRydWU7CiAgX1Z1ZSA9IFZ1ZTsKICB2YXIgaXNEZWYgPSBmdW5jdGlvbiBpc0RlZih2KSB7CiAgICByZXR1cm4gdiAhPT0gdW5kZWZpbmVkOwogIH07CiAgdmFyIHJlZ2lzdGVySW5zdGFuY2UgPSBmdW5jdGlvbiByZWdpc3Rlckluc3RhbmNlKHZtLCBjYWxsVmFsKSB7CiAgICB2YXIgaSA9IHZtLiRvcHRpb25zLl9wYXJlbnRWbm9kZTsKICAgIGlmIChpc0RlZihpKSAmJiBpc0RlZihpID0gaS5kYXRhKSAmJiBpc0RlZihpID0gaS5yZWdpc3RlclJvdXRlSW5zdGFuY2UpKSB7CiAgICAgIGkodm0sIGNhbGxWYWwpOwogICAgfQogIH07CiAgVnVlLm1peGluKHsKICAgIGJlZm9yZUNyZWF0ZTogZnVuY3Rpb24gYmVmb3JlQ3JlYXRlKCkgewogICAgICBpZiAoaXNEZWYodGhpcy4kb3B0aW9ucy5yb3V0ZXIpKSB7CiAgICAgICAgdGhpcy5fcm91dGVyUm9vdCA9IHRoaXM7CiAgICAgICAgdGhpcy5fcm91dGVyID0gdGhpcy4kb3B0aW9ucy5yb3V0ZXI7CiAgICAgICAgdGhpcy5fcm91dGVyLmluaXQodGhpcyk7CiAgICAgICAgVnVlLnV0aWwuZGVmaW5lUmVhY3RpdmUodGhpcywgJ19yb3V0ZScsIHRoaXMuX3JvdXRlci5oaXN0b3J5LmN1cnJlbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3JvdXRlclJvb3QgPSB0aGlzLiRwYXJlbnQgJiYgdGhpcy4kcGFyZW50Ll9yb3V0ZXJSb290IHx8IHRoaXM7CiAgICAgIH0KICAgICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCB0aGlzKTsKICAgIH0sCiAgICBkZXN0cm95ZWQ6IGZ1bmN0aW9uIGRlc3Ryb3llZCgpIHsKICAgICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzKTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRyb3V0ZXInLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JvdXRlclJvb3QuX3JvdXRlcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRyb3V0ZScsIHsKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fcm91dGVyUm9vdC5fcm91dGU7CiAgICB9CiAgfSk7CiAgVnVlLmNvbXBvbmVudCgnUm91dGVyVmlldycsIFZpZXcpOwogIFZ1ZS5jb21wb25lbnQoJ1JvdXRlckxpbmsnLCBMaW5rKTsKICB2YXIgc3RyYXRzID0gVnVlLmNvbmZpZy5vcHRpb25NZXJnZVN0cmF0ZWdpZXM7CiAgLy8gdXNlIHRoZSBzYW1lIGhvb2sgbWVyZ2luZyBzdHJhdGVneSBmb3Igcm91dGUgaG9va3MKICBzdHJhdHMuYmVmb3JlUm91dGVFbnRlciA9IHN0cmF0cy5iZWZvcmVSb3V0ZUxlYXZlID0gc3RyYXRzLmJlZm9yZVJvdXRlVXBkYXRlID0gc3RyYXRzLmNyZWF0ZWQ7Cn0KCi8qICAqLwoKdmFyIGluQnJvd3NlciA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnOwoKLyogICovCgpmdW5jdGlvbiBjcmVhdGVSb3V0ZU1hcChyb3V0ZXMsIG9sZFBhdGhMaXN0LCBvbGRQYXRoTWFwLCBvbGROYW1lTWFwLCBwYXJlbnRSb3V0ZSkgewogIC8vIHRoZSBwYXRoIGxpc3QgaXMgdXNlZCB0byBjb250cm9sIHBhdGggbWF0Y2hpbmcgcHJpb3JpdHkKICB2YXIgcGF0aExpc3QgPSBvbGRQYXRoTGlzdCB8fCBbXTsKICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICB2YXIgcGF0aE1hcCA9IG9sZFBhdGhNYXAgfHwgT2JqZWN0LmNyZWF0ZShudWxsKTsKICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICB2YXIgbmFtZU1hcCA9IG9sZE5hbWVNYXAgfHwgT2JqZWN0LmNyZWF0ZShudWxsKTsKICByb3V0ZXMuZm9yRWFjaChmdW5jdGlvbiAocm91dGUpIHsKICAgIGFkZFJvdXRlUmVjb3JkKHBhdGhMaXN0LCBwYXRoTWFwLCBuYW1lTWFwLCByb3V0ZSwgcGFyZW50Um91dGUpOwogIH0pOwoKICAvLyBlbnN1cmUgd2lsZGNhcmQgcm91dGVzIGFyZSBhbHdheXMgYXQgdGhlIGVuZAogIGZvciAodmFyIGkgPSAwLCBsID0gcGF0aExpc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBpZiAocGF0aExpc3RbaV0gPT09ICcqJykgewogICAgICBwYXRoTGlzdC5wdXNoKHBhdGhMaXN0LnNwbGljZShpLCAxKVswXSk7CiAgICAgIGwtLTsKICAgICAgaS0tOwogICAgfQogIH0KICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcpIHsKICAgIC8vIHdhcm4gaWYgcm91dGVzIGRvIG5vdCBpbmNsdWRlIGxlYWRpbmcgc2xhc2hlcwogICAgdmFyIGZvdW5kID0gcGF0aExpc3QKICAgIC8vIGNoZWNrIGZvciBtaXNzaW5nIGxlYWRpbmcgc2xhc2gKICAgIC5maWx0ZXIoZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgcmV0dXJuIHBhdGggJiYgcGF0aC5jaGFyQXQoMCkgIT09ICcqJyAmJiBwYXRoLmNoYXJBdCgwKSAhPT0gJy8nOwogICAgfSk7CiAgICBpZiAoZm91bmQubGVuZ3RoID4gMCkgewogICAgICB2YXIgcGF0aE5hbWVzID0gZm91bmQubWFwKGZ1bmN0aW9uIChwYXRoKSB7CiAgICAgICAgcmV0dXJuICItICIgKyBwYXRoOwogICAgICB9KS5qb2luKCdcbicpOwogICAgICB3YXJuKGZhbHNlLCAiTm9uLW5lc3RlZCByb3V0ZXMgbXVzdCBpbmNsdWRlIGEgbGVhZGluZyBzbGFzaCBjaGFyYWN0ZXIuIEZpeCB0aGUgZm9sbG93aW5nIHJvdXRlczogXG4iICsgcGF0aE5hbWVzKTsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHBhdGhMaXN0OiBwYXRoTGlzdCwKICAgIHBhdGhNYXA6IHBhdGhNYXAsCiAgICBuYW1lTWFwOiBuYW1lTWFwCiAgfTsKfQpmdW5jdGlvbiBhZGRSb3V0ZVJlY29yZChwYXRoTGlzdCwgcGF0aE1hcCwgbmFtZU1hcCwgcm91dGUsIHBhcmVudCwgbWF0Y2hBcykgewogIHZhciBwYXRoID0gcm91dGUucGF0aDsKICB2YXIgbmFtZSA9IHJvdXRlLm5hbWU7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGFzc2VydChwYXRoICE9IG51bGwsICJcInBhdGhcIiBpcyByZXF1aXJlZCBpbiBhIHJvdXRlIGNvbmZpZ3VyYXRpb24uIik7CiAgICBhc3NlcnQodHlwZW9mIHJvdXRlLmNvbXBvbmVudCAhPT0gJ3N0cmluZycsICJyb3V0ZSBjb25maWcgXCJjb21wb25lbnRcIiBmb3IgcGF0aDogIiArIFN0cmluZyhwYXRoIHx8IG5hbWUpICsgIiBjYW5ub3QgYmUgYSAiICsgInN0cmluZyBpZC4gVXNlIGFuIGFjdHVhbCBjb21wb25lbnQgaW5zdGVhZC4iKTsKICAgIHdhcm4oCiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29udHJvbC1yZWdleAogICAgIS9bXlx1MDAwMC1cdTAwN0ZdKy8udGVzdChwYXRoKSwgIlJvdXRlIHdpdGggcGF0aCBcIiIgKyBwYXRoICsgIlwiIGNvbnRhaW5zIHVuZW5jb2RlZCBjaGFyYWN0ZXJzLCBtYWtlIHN1cmUgIiArICJ5b3VyIHBhdGggaXMgY29ycmVjdGx5IGVuY29kZWQgYmVmb3JlIHBhc3NpbmcgaXQgdG8gdGhlIHJvdXRlci4gVXNlICIgKyAiZW5jb2RlVVJJIHRvIGVuY29kZSBzdGF0aWMgc2VnbWVudHMgb2YgeW91ciBwYXRoLiIpOwogIH0KICB2YXIgcGF0aFRvUmVnZXhwT3B0aW9ucyA9IHJvdXRlLnBhdGhUb1JlZ2V4cE9wdGlvbnMgfHwge307CiAgdmFyIG5vcm1hbGl6ZWRQYXRoID0gbm9ybWFsaXplUGF0aChwYXRoLCBwYXJlbnQsIHBhdGhUb1JlZ2V4cE9wdGlvbnMuc3RyaWN0KTsKICBpZiAodHlwZW9mIHJvdXRlLmNhc2VTZW5zaXRpdmUgPT09ICdib29sZWFuJykgewogICAgcGF0aFRvUmVnZXhwT3B0aW9ucy5zZW5zaXRpdmUgPSByb3V0ZS5jYXNlU2Vuc2l0aXZlOwogIH0KICB2YXIgcmVjb3JkID0gewogICAgcGF0aDogbm9ybWFsaXplZFBhdGgsCiAgICByZWdleDogY29tcGlsZVJvdXRlUmVnZXgobm9ybWFsaXplZFBhdGgsIHBhdGhUb1JlZ2V4cE9wdGlvbnMpLAogICAgY29tcG9uZW50czogcm91dGUuY29tcG9uZW50cyB8fCB7CiAgICAgIGRlZmF1bHQ6IHJvdXRlLmNvbXBvbmVudAogICAgfSwKICAgIGFsaWFzOiByb3V0ZS5hbGlhcyA/IHR5cGVvZiByb3V0ZS5hbGlhcyA9PT0gJ3N0cmluZycgPyBbcm91dGUuYWxpYXNdIDogcm91dGUuYWxpYXMgOiBbXSwKICAgIGluc3RhbmNlczoge30sCiAgICBlbnRlcmVkQ2JzOiB7fSwKICAgIG5hbWU6IG5hbWUsCiAgICBwYXJlbnQ6IHBhcmVudCwKICAgIG1hdGNoQXM6IG1hdGNoQXMsCiAgICByZWRpcmVjdDogcm91dGUucmVkaXJlY3QsCiAgICBiZWZvcmVFbnRlcjogcm91dGUuYmVmb3JlRW50ZXIsCiAgICBtZXRhOiByb3V0ZS5tZXRhIHx8IHt9LAogICAgcHJvcHM6IHJvdXRlLnByb3BzID09IG51bGwgPyB7fSA6IHJvdXRlLmNvbXBvbmVudHMgPyByb3V0ZS5wcm9wcyA6IHsKICAgICAgZGVmYXVsdDogcm91dGUucHJvcHMKICAgIH0KICB9OwogIGlmIChyb3V0ZS5jaGlsZHJlbikgewogICAgLy8gV2FybiBpZiByb3V0ZSBpcyBuYW1lZCwgZG9lcyBub3QgcmVkaXJlY3QgYW5kIGhhcyBhIGRlZmF1bHQgY2hpbGQgcm91dGUuCiAgICAvLyBJZiB1c2VycyBuYXZpZ2F0ZSB0byB0aGlzIHJvdXRlIGJ5IG5hbWUsIHRoZSBkZWZhdWx0IGNoaWxkIHdpbGwKICAgIC8vIG5vdCBiZSByZW5kZXJlZCAoR0ggSXNzdWUgIzYyOSkKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmIChyb3V0ZS5uYW1lICYmICFyb3V0ZS5yZWRpcmVjdCAmJiByb3V0ZS5jaGlsZHJlbi5zb21lKGZ1bmN0aW9uIChjaGlsZCkgewogICAgICAgIHJldHVybiAvXlwvPyQvLnRlc3QoY2hpbGQucGF0aCk7CiAgICAgIH0pKSB7CiAgICAgICAgd2FybihmYWxzZSwgIk5hbWVkIFJvdXRlICciICsgcm91dGUubmFtZSArICInIGhhcyBhIGRlZmF1bHQgY2hpbGQgcm91dGUuICIgKyAiV2hlbiBuYXZpZ2F0aW5nIHRvIHRoaXMgbmFtZWQgcm91dGUgKDp0bz1cIntuYW1lOiAnIiArIHJvdXRlLm5hbWUgKyAiJ31cIiksICIgKyAidGhlIGRlZmF1bHQgY2hpbGQgcm91dGUgd2lsbCBub3QgYmUgcmVuZGVyZWQuIFJlbW92ZSB0aGUgbmFtZSBmcm9tICIgKyAidGhpcyByb3V0ZSBhbmQgdXNlIHRoZSBuYW1lIG9mIHRoZSBkZWZhdWx0IGNoaWxkIHJvdXRlIGZvciBuYW1lZCAiICsgImxpbmtzIGluc3RlYWQuIik7CiAgICAgIH0KICAgIH0KICAgIHJvdXRlLmNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgIHZhciBjaGlsZE1hdGNoQXMgPSBtYXRjaEFzID8gY2xlYW5QYXRoKG1hdGNoQXMgKyAiLyIgKyBjaGlsZC5wYXRoKSA6IHVuZGVmaW5lZDsKICAgICAgYWRkUm91dGVSZWNvcmQocGF0aExpc3QsIHBhdGhNYXAsIG5hbWVNYXAsIGNoaWxkLCByZWNvcmQsIGNoaWxkTWF0Y2hBcyk7CiAgICB9KTsKICB9CiAgaWYgKCFwYXRoTWFwW3JlY29yZC5wYXRoXSkgewogICAgcGF0aExpc3QucHVzaChyZWNvcmQucGF0aCk7CiAgICBwYXRoTWFwW3JlY29yZC5wYXRoXSA9IHJlY29yZDsKICB9CiAgaWYgKHJvdXRlLmFsaWFzICE9PSB1bmRlZmluZWQpIHsKICAgIHZhciBhbGlhc2VzID0gQXJyYXkuaXNBcnJheShyb3V0ZS5hbGlhcykgPyByb3V0ZS5hbGlhcyA6IFtyb3V0ZS5hbGlhc107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFsaWFzZXMubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIGFsaWFzID0gYWxpYXNlc1tpXTsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgYWxpYXMgPT09IHBhdGgpIHsKICAgICAgICB3YXJuKGZhbHNlLCAiRm91bmQgYW4gYWxpYXMgd2l0aCB0aGUgc2FtZSB2YWx1ZSBhcyB0aGUgcGF0aDogXCIiICsgcGF0aCArICJcIi4gWW91IGhhdmUgdG8gcmVtb3ZlIHRoYXQgYWxpYXMuIEl0IHdpbGwgYmUgaWdub3JlZCBpbiBkZXZlbG9wbWVudC4iKTsKICAgICAgICAvLyBza2lwIGluIGRldiB0byBtYWtlIGl0IHdvcmsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICB2YXIgYWxpYXNSb3V0ZSA9IHsKICAgICAgICBwYXRoOiBhbGlhcywKICAgICAgICBjaGlsZHJlbjogcm91dGUuY2hpbGRyZW4KICAgICAgfTsKICAgICAgYWRkUm91dGVSZWNvcmQocGF0aExpc3QsIHBhdGhNYXAsIG5hbWVNYXAsIGFsaWFzUm91dGUsIHBhcmVudCwgcmVjb3JkLnBhdGggfHwgJy8nIC8vIG1hdGNoQXMKICAgICAgKTsKICAgIH0KICB9CgogIGlmIChuYW1lKSB7CiAgICBpZiAoIW5hbWVNYXBbbmFtZV0pIHsKICAgICAgbmFtZU1hcFtuYW1lXSA9IHJlY29yZDsKICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhbWF0Y2hBcykgewogICAgICB3YXJuKGZhbHNlLCAiRHVwbGljYXRlIG5hbWVkIHJvdXRlcyBkZWZpbml0aW9uOiAiICsgInsgbmFtZTogXCIiICsgbmFtZSArICJcIiwgcGF0aDogXCIiICsgcmVjb3JkLnBhdGggKyAiXCIgfSIpOwogICAgfQogIH0KfQpmdW5jdGlvbiBjb21waWxlUm91dGVSZWdleChwYXRoLCBwYXRoVG9SZWdleHBPcHRpb25zKSB7CiAgdmFyIHJlZ2V4ID0gcGF0aFRvUmVnZXhwXzEocGF0aCwgW10sIHBhdGhUb1JlZ2V4cE9wdGlvbnMpOwogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB2YXIga2V5cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICByZWdleC5rZXlzLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICB3YXJuKCFrZXlzW2tleS5uYW1lXSwgIkR1cGxpY2F0ZSBwYXJhbSBrZXlzIGluIHJvdXRlIHdpdGggcGF0aDogXCIiICsgcGF0aCArICJcIiIpOwogICAgICBrZXlzW2tleS5uYW1lXSA9IHRydWU7CiAgICB9KTsKICB9CiAgcmV0dXJuIHJlZ2V4Owp9CmZ1bmN0aW9uIG5vcm1hbGl6ZVBhdGgocGF0aCwgcGFyZW50LCBzdHJpY3QpIHsKICBpZiAoIXN0cmljdCkgewogICAgcGF0aCA9IHBhdGgucmVwbGFjZSgvXC8kLywgJycpOwogIH0KICBpZiAocGF0aFswXSA9PT0gJy8nKSB7CiAgICByZXR1cm4gcGF0aDsKICB9CiAgaWYgKHBhcmVudCA9PSBudWxsKSB7CiAgICByZXR1cm4gcGF0aDsKICB9CiAgcmV0dXJuIGNsZWFuUGF0aChwYXJlbnQucGF0aCArICIvIiArIHBhdGgpOwp9CgovKiAgKi8KCmZ1bmN0aW9uIGNyZWF0ZU1hdGNoZXIocm91dGVzLCByb3V0ZXIpIHsKICB2YXIgcmVmID0gY3JlYXRlUm91dGVNYXAocm91dGVzKTsKICB2YXIgcGF0aExpc3QgPSByZWYucGF0aExpc3Q7CiAgdmFyIHBhdGhNYXAgPSByZWYucGF0aE1hcDsKICB2YXIgbmFtZU1hcCA9IHJlZi5uYW1lTWFwOwogIGZ1bmN0aW9uIGFkZFJvdXRlcyhyb3V0ZXMpIHsKICAgIGNyZWF0ZVJvdXRlTWFwKHJvdXRlcywgcGF0aExpc3QsIHBhdGhNYXAsIG5hbWVNYXApOwogIH0KICBmdW5jdGlvbiBhZGRSb3V0ZShwYXJlbnRPclJvdXRlLCByb3V0ZSkgewogICAgdmFyIHBhcmVudCA9IHR5cGVvZiBwYXJlbnRPclJvdXRlICE9PSAnb2JqZWN0JyA/IG5hbWVNYXBbcGFyZW50T3JSb3V0ZV0gOiB1bmRlZmluZWQ7CiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIGNyZWF0ZVJvdXRlTWFwKFtyb3V0ZSB8fCBwYXJlbnRPclJvdXRlXSwgcGF0aExpc3QsIHBhdGhNYXAsIG5hbWVNYXAsIHBhcmVudCk7CgogICAgLy8gYWRkIGFsaWFzZXMgb2YgcGFyZW50CiAgICBpZiAocGFyZW50ICYmIHBhcmVudC5hbGlhcy5sZW5ndGgpIHsKICAgICAgY3JlYXRlUm91dGVNYXAoCiAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZSByb3V0ZSBpcyBkZWZpbmVkIGlmIHBhcmVudCBpcwogICAgICBwYXJlbnQuYWxpYXMubWFwKGZ1bmN0aW9uIChhbGlhcykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwYXRoOiBhbGlhcywKICAgICAgICAgIGNoaWxkcmVuOiBbcm91dGVdCiAgICAgICAgfTsKICAgICAgfSksIHBhdGhMaXN0LCBwYXRoTWFwLCBuYW1lTWFwLCBwYXJlbnQpOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRSb3V0ZXMoKSB7CiAgICByZXR1cm4gcGF0aExpc3QubWFwKGZ1bmN0aW9uIChwYXRoKSB7CiAgICAgIHJldHVybiBwYXRoTWFwW3BhdGhdOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIG1hdGNoKHJhdywgY3VycmVudFJvdXRlLCByZWRpcmVjdGVkRnJvbSkgewogICAgdmFyIGxvY2F0aW9uID0gbm9ybWFsaXplTG9jYXRpb24ocmF3LCBjdXJyZW50Um91dGUsIGZhbHNlLCByb3V0ZXIpOwogICAgdmFyIG5hbWUgPSBsb2NhdGlvbi5uYW1lOwogICAgaWYgKG5hbWUpIHsKICAgICAgdmFyIHJlY29yZCA9IG5hbWVNYXBbbmFtZV07CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgd2FybihyZWNvcmQsICJSb3V0ZSB3aXRoIG5hbWUgJyIgKyBuYW1lICsgIicgZG9lcyBub3QgZXhpc3QiKTsKICAgICAgfQogICAgICBpZiAoIXJlY29yZCkgewogICAgICAgIHJldHVybiBfY3JlYXRlUm91dGUobnVsbCwgbG9jYXRpb24pOwogICAgICB9CiAgICAgIHZhciBwYXJhbU5hbWVzID0gcmVjb3JkLnJlZ2V4LmtleXMuZmlsdGVyKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICByZXR1cm4gIWtleS5vcHRpb25hbDsKICAgICAgfSkubWFwKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICByZXR1cm4ga2V5Lm5hbWU7CiAgICAgIH0pOwogICAgICBpZiAodHlwZW9mIGxvY2F0aW9uLnBhcmFtcyAhPT0gJ29iamVjdCcpIHsKICAgICAgICBsb2NhdGlvbi5wYXJhbXMgPSB7fTsKICAgICAgfQogICAgICBpZiAoY3VycmVudFJvdXRlICYmIHR5cGVvZiBjdXJyZW50Um91dGUucGFyYW1zID09PSAnb2JqZWN0JykgewogICAgICAgIGZvciAodmFyIGtleSBpbiBjdXJyZW50Um91dGUucGFyYW1zKSB7CiAgICAgICAgICBpZiAoIShrZXkgaW4gbG9jYXRpb24ucGFyYW1zKSAmJiBwYXJhbU5hbWVzLmluZGV4T2Yoa2V5KSA+IC0xKSB7CiAgICAgICAgICAgIGxvY2F0aW9uLnBhcmFtc1trZXldID0gY3VycmVudFJvdXRlLnBhcmFtc1trZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBsb2NhdGlvbi5wYXRoID0gZmlsbFBhcmFtcyhyZWNvcmQucGF0aCwgbG9jYXRpb24ucGFyYW1zLCAibmFtZWQgcm91dGUgXCIiICsgbmFtZSArICJcIiIpOwogICAgICByZXR1cm4gX2NyZWF0ZVJvdXRlKHJlY29yZCwgbG9jYXRpb24sIHJlZGlyZWN0ZWRGcm9tKTsKICAgIH0gZWxzZSBpZiAobG9jYXRpb24ucGF0aCkgewogICAgICBsb2NhdGlvbi5wYXJhbXMgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBwYXRoID0gcGF0aExpc3RbaV07CiAgICAgICAgdmFyIHJlY29yZCQxID0gcGF0aE1hcFtwYXRoXTsKICAgICAgICBpZiAobWF0Y2hSb3V0ZShyZWNvcmQkMS5yZWdleCwgbG9jYXRpb24ucGF0aCwgbG9jYXRpb24ucGFyYW1zKSkgewogICAgICAgICAgcmV0dXJuIF9jcmVhdGVSb3V0ZShyZWNvcmQkMSwgbG9jYXRpb24sIHJlZGlyZWN0ZWRGcm9tKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIG5vIG1hdGNoCiAgICByZXR1cm4gX2NyZWF0ZVJvdXRlKG51bGwsIGxvY2F0aW9uKTsKICB9CiAgZnVuY3Rpb24gcmVkaXJlY3QocmVjb3JkLCBsb2NhdGlvbikgewogICAgdmFyIG9yaWdpbmFsUmVkaXJlY3QgPSByZWNvcmQucmVkaXJlY3Q7CiAgICB2YXIgcmVkaXJlY3QgPSB0eXBlb2Ygb3JpZ2luYWxSZWRpcmVjdCA9PT0gJ2Z1bmN0aW9uJyA/IG9yaWdpbmFsUmVkaXJlY3QoY3JlYXRlUm91dGUocmVjb3JkLCBsb2NhdGlvbiwgbnVsbCwgcm91dGVyKSkgOiBvcmlnaW5hbFJlZGlyZWN0OwogICAgaWYgKHR5cGVvZiByZWRpcmVjdCA9PT0gJ3N0cmluZycpIHsKICAgICAgcmVkaXJlY3QgPSB7CiAgICAgICAgcGF0aDogcmVkaXJlY3QKICAgICAgfTsKICAgIH0KICAgIGlmICghcmVkaXJlY3QgfHwgdHlwZW9mIHJlZGlyZWN0ICE9PSAnb2JqZWN0JykgewogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIHdhcm4oZmFsc2UsICJpbnZhbGlkIHJlZGlyZWN0IG9wdGlvbjogIiArIEpTT04uc3RyaW5naWZ5KHJlZGlyZWN0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIF9jcmVhdGVSb3V0ZShudWxsLCBsb2NhdGlvbik7CiAgICB9CiAgICB2YXIgcmUgPSByZWRpcmVjdDsKICAgIHZhciBuYW1lID0gcmUubmFtZTsKICAgIHZhciBwYXRoID0gcmUucGF0aDsKICAgIHZhciBxdWVyeSA9IGxvY2F0aW9uLnF1ZXJ5OwogICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogICAgdmFyIHBhcmFtcyA9IGxvY2F0aW9uLnBhcmFtczsKICAgIHF1ZXJ5ID0gcmUuaGFzT3duUHJvcGVydHkoJ3F1ZXJ5JykgPyByZS5xdWVyeSA6IHF1ZXJ5OwogICAgaGFzaCA9IHJlLmhhc093blByb3BlcnR5KCdoYXNoJykgPyByZS5oYXNoIDogaGFzaDsKICAgIHBhcmFtcyA9IHJlLmhhc093blByb3BlcnR5KCdwYXJhbXMnKSA/IHJlLnBhcmFtcyA6IHBhcmFtczsKICAgIGlmIChuYW1lKSB7CiAgICAgIC8vIHJlc29sdmVkIG5hbWVkIGRpcmVjdAogICAgICB2YXIgdGFyZ2V0UmVjb3JkID0gbmFtZU1hcFtuYW1lXTsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBhc3NlcnQodGFyZ2V0UmVjb3JkLCAicmVkaXJlY3QgZmFpbGVkOiBuYW1lZCByb3V0ZSBcIiIgKyBuYW1lICsgIlwiIG5vdCBmb3VuZC4iKTsKICAgICAgfQogICAgICByZXR1cm4gbWF0Y2goewogICAgICAgIF9ub3JtYWxpemVkOiB0cnVlLAogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgcXVlcnk6IHF1ZXJ5LAogICAgICAgIGhhc2g6IGhhc2gsCiAgICAgICAgcGFyYW1zOiBwYXJhbXMKICAgICAgfSwgdW5kZWZpbmVkLCBsb2NhdGlvbik7CiAgICB9IGVsc2UgaWYgKHBhdGgpIHsKICAgICAgLy8gMS4gcmVzb2x2ZSByZWxhdGl2ZSByZWRpcmVjdAogICAgICB2YXIgcmF3UGF0aCA9IHJlc29sdmVSZWNvcmRQYXRoKHBhdGgsIHJlY29yZCk7CiAgICAgIC8vIDIuIHJlc29sdmUgcGFyYW1zCiAgICAgIHZhciByZXNvbHZlZFBhdGggPSBmaWxsUGFyYW1zKHJhd1BhdGgsIHBhcmFtcywgInJlZGlyZWN0IHJvdXRlIHdpdGggcGF0aCBcIiIgKyByYXdQYXRoICsgIlwiIik7CiAgICAgIC8vIDMuIHJlbWF0Y2ggd2l0aCBleGlzdGluZyBxdWVyeSBhbmQgaGFzaAogICAgICByZXR1cm4gbWF0Y2goewogICAgICAgIF9ub3JtYWxpemVkOiB0cnVlLAogICAgICAgIHBhdGg6IHJlc29sdmVkUGF0aCwKICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgaGFzaDogaGFzaAogICAgICB9LCB1bmRlZmluZWQsIGxvY2F0aW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgd2FybihmYWxzZSwgImludmFsaWQgcmVkaXJlY3Qgb3B0aW9uOiAiICsgSlNPTi5zdHJpbmdpZnkocmVkaXJlY3QpKTsKICAgICAgfQogICAgICByZXR1cm4gX2NyZWF0ZVJvdXRlKG51bGwsIGxvY2F0aW9uKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWxpYXMocmVjb3JkLCBsb2NhdGlvbiwgbWF0Y2hBcykgewogICAgdmFyIGFsaWFzZWRQYXRoID0gZmlsbFBhcmFtcyhtYXRjaEFzLCBsb2NhdGlvbi5wYXJhbXMsICJhbGlhc2VkIHJvdXRlIHdpdGggcGF0aCBcIiIgKyBtYXRjaEFzICsgIlwiIik7CiAgICB2YXIgYWxpYXNlZE1hdGNoID0gbWF0Y2goewogICAgICBfbm9ybWFsaXplZDogdHJ1ZSwKICAgICAgcGF0aDogYWxpYXNlZFBhdGgKICAgIH0pOwogICAgaWYgKGFsaWFzZWRNYXRjaCkgewogICAgICB2YXIgbWF0Y2hlZCA9IGFsaWFzZWRNYXRjaC5tYXRjaGVkOwogICAgICB2YXIgYWxpYXNlZFJlY29yZCA9IG1hdGNoZWRbbWF0Y2hlZC5sZW5ndGggLSAxXTsKICAgICAgbG9jYXRpb24ucGFyYW1zID0gYWxpYXNlZE1hdGNoLnBhcmFtczsKICAgICAgcmV0dXJuIF9jcmVhdGVSb3V0ZShhbGlhc2VkUmVjb3JkLCBsb2NhdGlvbik7CiAgICB9CiAgICByZXR1cm4gX2NyZWF0ZVJvdXRlKG51bGwsIGxvY2F0aW9uKTsKICB9CiAgZnVuY3Rpb24gX2NyZWF0ZVJvdXRlKHJlY29yZCwgbG9jYXRpb24sIHJlZGlyZWN0ZWRGcm9tKSB7CiAgICBpZiAocmVjb3JkICYmIHJlY29yZC5yZWRpcmVjdCkgewogICAgICByZXR1cm4gcmVkaXJlY3QocmVjb3JkLCByZWRpcmVjdGVkRnJvbSB8fCBsb2NhdGlvbik7CiAgICB9CiAgICBpZiAocmVjb3JkICYmIHJlY29yZC5tYXRjaEFzKSB7CiAgICAgIHJldHVybiBhbGlhcyhyZWNvcmQsIGxvY2F0aW9uLCByZWNvcmQubWF0Y2hBcyk7CiAgICB9CiAgICByZXR1cm4gY3JlYXRlUm91dGUocmVjb3JkLCBsb2NhdGlvbiwgcmVkaXJlY3RlZEZyb20sIHJvdXRlcik7CiAgfQogIHJldHVybiB7CiAgICBtYXRjaDogbWF0Y2gsCiAgICBhZGRSb3V0ZTogYWRkUm91dGUsCiAgICBnZXRSb3V0ZXM6IGdldFJvdXRlcywKICAgIGFkZFJvdXRlczogYWRkUm91dGVzCiAgfTsKfQpmdW5jdGlvbiBtYXRjaFJvdXRlKHJlZ2V4LCBwYXRoLCBwYXJhbXMpIHsKICB2YXIgbSA9IHBhdGgubWF0Y2gocmVnZXgpOwogIGlmICghbSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0gZWxzZSBpZiAoIXBhcmFtcykgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGZvciAodmFyIGkgPSAxLCBsZW4gPSBtLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICB2YXIga2V5ID0gcmVnZXgua2V5c1tpIC0gMV07CiAgICBpZiAoa2V5KSB7CiAgICAgIC8vIEZpeCAjMTk5NDogdXNpbmcgKiB3aXRoIHByb3BzOiB0cnVlIGdlbmVyYXRlcyBhIHBhcmFtIG5hbWVkIDAKICAgICAgcGFyYW1zW2tleS5uYW1lIHx8ICdwYXRoTWF0Y2gnXSA9IHR5cGVvZiBtW2ldID09PSAnc3RyaW5nJyA/IGRlY29kZShtW2ldKSA6IG1baV07CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIHJlc29sdmVSZWNvcmRQYXRoKHBhdGgsIHJlY29yZCkgewogIHJldHVybiByZXNvbHZlUGF0aChwYXRoLCByZWNvcmQucGFyZW50ID8gcmVjb3JkLnBhcmVudC5wYXRoIDogJy8nLCB0cnVlKTsKfQoKLyogICovCgovLyB1c2UgVXNlciBUaW1pbmcgYXBpIChpZiBwcmVzZW50KSBmb3IgbW9yZSBhY2N1cmF0ZSBrZXkgcHJlY2lzaW9uCnZhciBUaW1lID0gaW5Ccm93c2VyICYmIHdpbmRvdy5wZXJmb3JtYW5jZSAmJiB3aW5kb3cucGVyZm9ybWFuY2Uubm93ID8gd2luZG93LnBlcmZvcm1hbmNlIDogRGF0ZTsKZnVuY3Rpb24gZ2VuU3RhdGVLZXkoKSB7CiAgcmV0dXJuIFRpbWUubm93KCkudG9GaXhlZCgzKTsKfQp2YXIgX2tleSA9IGdlblN0YXRlS2V5KCk7CmZ1bmN0aW9uIGdldFN0YXRlS2V5KCkgewogIHJldHVybiBfa2V5Owp9CmZ1bmN0aW9uIHNldFN0YXRlS2V5KGtleSkgewogIHJldHVybiBfa2V5ID0ga2V5Owp9CgovKiAgKi8KCnZhciBwb3NpdGlvblN0b3JlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKZnVuY3Rpb24gc2V0dXBTY3JvbGwoKSB7CiAgLy8gUHJldmVudCBicm93c2VyIHNjcm9sbCBiZWhhdmlvciBvbiBIaXN0b3J5IHBvcHN0YXRlCiAgaWYgKCdzY3JvbGxSZXN0b3JhdGlvbicgaW4gd2luZG93Lmhpc3RvcnkpIHsKICAgIHdpbmRvdy5oaXN0b3J5LnNjcm9sbFJlc3RvcmF0aW9uID0gJ21hbnVhbCc7CiAgfQogIC8vIEZpeCBmb3IgIzE1ODUgZm9yIEZpcmVmb3gKICAvLyBGaXggZm9yICMyMTk1IEFkZCBvcHRpb25hbCB0aGlyZCBhdHRyaWJ1dGUgdG8gd29ya2Fyb3VuZCBhIGJ1ZyBpbiBzYWZhcmkgaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTE4MjY3OAogIC8vIEZpeCBmb3IgIzI3NzQgU3VwcG9ydCBmb3IgYXBwcyBsb2FkZWQgZnJvbSBXaW5kb3dzIGZpbGUgc2hhcmVzIG5vdCBtYXBwZWQgdG8gbmV0d29yayBkcml2ZXM6IHJlcGxhY2VkIGxvY2F0aW9uLm9yaWdpbiB3aXRoCiAgLy8gd2luZG93LmxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIHdpbmRvdy5sb2NhdGlvbi5ob3N0CiAgLy8gbG9jYXRpb24uaG9zdCBjb250YWlucyB0aGUgcG9ydCBhbmQgbG9jYXRpb24uaG9zdG5hbWUgZG9lc24ndAogIHZhciBwcm90b2NvbEFuZFBhdGggPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgd2luZG93LmxvY2F0aW9uLmhvc3Q7CiAgdmFyIGFic29sdXRlUGF0aCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnJlcGxhY2UocHJvdG9jb2xBbmRQYXRoLCAnJyk7CiAgLy8gcHJlc2VydmUgZXhpc3RpbmcgaGlzdG9yeSBzdGF0ZSBhcyBpdCBjb3VsZCBiZSBvdmVycmlkZW4gYnkgdGhlIHVzZXIKICB2YXIgc3RhdGVDb3B5ID0gZXh0ZW5kKHt9LCB3aW5kb3cuaGlzdG9yeS5zdGF0ZSk7CiAgc3RhdGVDb3B5LmtleSA9IGdldFN0YXRlS2V5KCk7CiAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHN0YXRlQ29weSwgJycsIGFic29sdXRlUGF0aCk7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgaGFuZGxlUG9wU3RhdGUpOwogIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCBoYW5kbGVQb3BTdGF0ZSk7CiAgfTsKfQpmdW5jdGlvbiBoYW5kbGVTY3JvbGwocm91dGVyLCB0bywgZnJvbSwgaXNQb3ApIHsKICBpZiAoIXJvdXRlci5hcHApIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGJlaGF2aW9yID0gcm91dGVyLm9wdGlvbnMuc2Nyb2xsQmVoYXZpb3I7CiAgaWYgKCFiZWhhdmlvcikgewogICAgcmV0dXJuOwogIH0KICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgYXNzZXJ0KHR5cGVvZiBiZWhhdmlvciA9PT0gJ2Z1bmN0aW9uJywgInNjcm9sbEJlaGF2aW9yIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogIH0KCiAgLy8gd2FpdCB1bnRpbCByZS1yZW5kZXIgZmluaXNoZXMgYmVmb3JlIHNjcm9sbGluZwogIHJvdXRlci5hcHAuJG5leHRUaWNrKGZ1bmN0aW9uICgpIHsKICAgIHZhciBwb3NpdGlvbiA9IGdldFNjcm9sbFBvc2l0aW9uKCk7CiAgICB2YXIgc2hvdWxkU2Nyb2xsID0gYmVoYXZpb3IuY2FsbChyb3V0ZXIsIHRvLCBmcm9tLCBpc1BvcCA/IHBvc2l0aW9uIDogbnVsbCk7CiAgICBpZiAoIXNob3VsZFNjcm9sbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodHlwZW9mIHNob3VsZFNjcm9sbC50aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHNob3VsZFNjcm9sbC50aGVuKGZ1bmN0aW9uIChzaG91bGRTY3JvbGwpIHsKICAgICAgICBzY3JvbGxUb1Bvc2l0aW9uKHNob3VsZFNjcm9sbCwgcG9zaXRpb24pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIGFzc2VydChmYWxzZSwgZXJyLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBzY3JvbGxUb1Bvc2l0aW9uKHNob3VsZFNjcm9sbCwgcG9zaXRpb24pOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIHNhdmVTY3JvbGxQb3NpdGlvbigpIHsKICB2YXIga2V5ID0gZ2V0U3RhdGVLZXkoKTsKICBpZiAoa2V5KSB7CiAgICBwb3NpdGlvblN0b3JlW2tleV0gPSB7CiAgICAgIHg6IHdpbmRvdy5wYWdlWE9mZnNldCwKICAgICAgeTogd2luZG93LnBhZ2VZT2Zmc2V0CiAgICB9OwogIH0KfQpmdW5jdGlvbiBoYW5kbGVQb3BTdGF0ZShlKSB7CiAgc2F2ZVNjcm9sbFBvc2l0aW9uKCk7CiAgaWYgKGUuc3RhdGUgJiYgZS5zdGF0ZS5rZXkpIHsKICAgIHNldFN0YXRlS2V5KGUuc3RhdGUua2V5KTsKICB9Cn0KZnVuY3Rpb24gZ2V0U2Nyb2xsUG9zaXRpb24oKSB7CiAgdmFyIGtleSA9IGdldFN0YXRlS2V5KCk7CiAgaWYgKGtleSkgewogICAgcmV0dXJuIHBvc2l0aW9uU3RvcmVba2V5XTsKICB9Cn0KZnVuY3Rpb24gZ2V0RWxlbWVudFBvc2l0aW9uKGVsLCBvZmZzZXQpIHsKICB2YXIgZG9jRWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgdmFyIGRvY1JlY3QgPSBkb2NFbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICB2YXIgZWxSZWN0ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgcmV0dXJuIHsKICAgIHg6IGVsUmVjdC5sZWZ0IC0gZG9jUmVjdC5sZWZ0IC0gb2Zmc2V0LngsCiAgICB5OiBlbFJlY3QudG9wIC0gZG9jUmVjdC50b3AgLSBvZmZzZXQueQogIH07Cn0KZnVuY3Rpb24gaXNWYWxpZFBvc2l0aW9uKG9iaikgewogIHJldHVybiBpc051bWJlcihvYmoueCkgfHwgaXNOdW1iZXIob2JqLnkpOwp9CmZ1bmN0aW9uIG5vcm1hbGl6ZVBvc2l0aW9uKG9iaikgewogIHJldHVybiB7CiAgICB4OiBpc051bWJlcihvYmoueCkgPyBvYmoueCA6IHdpbmRvdy5wYWdlWE9mZnNldCwKICAgIHk6IGlzTnVtYmVyKG9iai55KSA/IG9iai55IDogd2luZG93LnBhZ2VZT2Zmc2V0CiAgfTsKfQpmdW5jdGlvbiBub3JtYWxpemVPZmZzZXQob2JqKSB7CiAgcmV0dXJuIHsKICAgIHg6IGlzTnVtYmVyKG9iai54KSA/IG9iai54IDogMCwKICAgIHk6IGlzTnVtYmVyKG9iai55KSA/IG9iai55IDogMAogIH07Cn0KZnVuY3Rpb24gaXNOdW1iZXIodikgewogIHJldHVybiB0eXBlb2YgdiA9PT0gJ251bWJlcic7Cn0KdmFyIGhhc2hTdGFydHNXaXRoTnVtYmVyUkUgPSAvXiNcZC87CmZ1bmN0aW9uIHNjcm9sbFRvUG9zaXRpb24oc2hvdWxkU2Nyb2xsLCBwb3NpdGlvbikgewogIHZhciBpc09iamVjdCA9IHR5cGVvZiBzaG91bGRTY3JvbGwgPT09ICdvYmplY3QnOwogIGlmIChpc09iamVjdCAmJiB0eXBlb2Ygc2hvdWxkU2Nyb2xsLnNlbGVjdG9yID09PSAnc3RyaW5nJykgewogICAgLy8gZ2V0RWxlbWVudEJ5SWQgd291bGQgc3RpbGwgZmFpbCBpZiB0aGUgc2VsZWN0b3IgY29udGFpbnMgYSBtb3JlIGNvbXBsaWNhdGVkIHF1ZXJ5IGxpa2UgI21haW5bZGF0YS1hdHRyXQogICAgLy8gYnV0IGF0IHRoZSBzYW1lIHRpbWUsIGl0IGRvZXNuJ3QgbWFrZSBtdWNoIHNlbnNlIHRvIHNlbGVjdCBhbiBlbGVtZW50IHdpdGggYW4gaWQgYW5kIGFuIGV4dHJhIHNlbGVjdG9yCiAgICB2YXIgZWwgPSBoYXNoU3RhcnRzV2l0aE51bWJlclJFLnRlc3Qoc2hvdWxkU2Nyb2xsLnNlbGVjdG9yKSAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc2hvdWxkU2Nyb2xsLnNlbGVjdG9yLnNsaWNlKDEpKSAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzaG91bGRTY3JvbGwuc2VsZWN0b3IpOwogICAgaWYgKGVsKSB7CiAgICAgIHZhciBvZmZzZXQgPSBzaG91bGRTY3JvbGwub2Zmc2V0ICYmIHR5cGVvZiBzaG91bGRTY3JvbGwub2Zmc2V0ID09PSAnb2JqZWN0JyA/IHNob3VsZFNjcm9sbC5vZmZzZXQgOiB7fTsKICAgICAgb2Zmc2V0ID0gbm9ybWFsaXplT2Zmc2V0KG9mZnNldCk7CiAgICAgIHBvc2l0aW9uID0gZ2V0RWxlbWVudFBvc2l0aW9uKGVsLCBvZmZzZXQpOwogICAgfSBlbHNlIGlmIChpc1ZhbGlkUG9zaXRpb24oc2hvdWxkU2Nyb2xsKSkgewogICAgICBwb3NpdGlvbiA9IG5vcm1hbGl6ZVBvc2l0aW9uKHNob3VsZFNjcm9sbCk7CiAgICB9CiAgfSBlbHNlIGlmIChpc09iamVjdCAmJiBpc1ZhbGlkUG9zaXRpb24oc2hvdWxkU2Nyb2xsKSkgewogICAgcG9zaXRpb24gPSBub3JtYWxpemVQb3NpdGlvbihzaG91bGRTY3JvbGwpOwogIH0KICBpZiAocG9zaXRpb24pIHsKICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgaWYgKCdzY3JvbGxCZWhhdmlvcicgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlKSB7CiAgICAgIHdpbmRvdy5zY3JvbGxUbyh7CiAgICAgICAgbGVmdDogcG9zaXRpb24ueCwKICAgICAgICB0b3A6IHBvc2l0aW9uLnksCiAgICAgICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICAgICAgYmVoYXZpb3I6IHNob3VsZFNjcm9sbC5iZWhhdmlvcgogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHdpbmRvdy5zY3JvbGxUbyhwb3NpdGlvbi54LCBwb3NpdGlvbi55KTsKICAgIH0KICB9Cn0KCi8qICAqLwoKdmFyIHN1cHBvcnRzUHVzaFN0YXRlID0gaW5Ccm93c2VyICYmIGZ1bmN0aW9uICgpIHsKICB2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKICBpZiAoKHVhLmluZGV4T2YoJ0FuZHJvaWQgMi4nKSAhPT0gLTEgfHwgdWEuaW5kZXhPZignQW5kcm9pZCA0LjAnKSAhPT0gLTEpICYmIHVhLmluZGV4T2YoJ01vYmlsZSBTYWZhcmknKSAhPT0gLTEgJiYgdWEuaW5kZXhPZignQ2hyb21lJykgPT09IC0xICYmIHVhLmluZGV4T2YoJ1dpbmRvd3MgUGhvbmUnKSA9PT0gLTEpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHdpbmRvdy5oaXN0b3J5ICYmIHR5cGVvZiB3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUgPT09ICdmdW5jdGlvbic7Cn0oKTsKZnVuY3Rpb24gcHVzaFN0YXRlKHVybCwgcmVwbGFjZSkgewogIHNhdmVTY3JvbGxQb3NpdGlvbigpOwogIC8vIHRyeS4uLmNhdGNoIHRoZSBwdXNoU3RhdGUgY2FsbCB0byBnZXQgYXJvdW5kIFNhZmFyaQogIC8vIERPTSBFeGNlcHRpb24gMTggd2hlcmUgaXQgbGltaXRzIHRvIDEwMCBwdXNoU3RhdGUgY2FsbHMKICB2YXIgaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogIHRyeSB7CiAgICBpZiAocmVwbGFjZSkgewogICAgICAvLyBwcmVzZXJ2ZSBleGlzdGluZyBoaXN0b3J5IHN0YXRlIGFzIGl0IGNvdWxkIGJlIG92ZXJyaWRlbiBieSB0aGUgdXNlcgogICAgICB2YXIgc3RhdGVDb3B5ID0gZXh0ZW5kKHt9LCBoaXN0b3J5LnN0YXRlKTsKICAgICAgc3RhdGVDb3B5LmtleSA9IGdldFN0YXRlS2V5KCk7CiAgICAgIGhpc3RvcnkucmVwbGFjZVN0YXRlKHN0YXRlQ29weSwgJycsIHVybCk7CiAgICB9IGVsc2UgewogICAgICBoaXN0b3J5LnB1c2hTdGF0ZSh7CiAgICAgICAga2V5OiBzZXRTdGF0ZUtleShnZW5TdGF0ZUtleSgpKQogICAgICB9LCAnJywgdXJsKTsKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICB3aW5kb3cubG9jYXRpb25bcmVwbGFjZSA/ICdyZXBsYWNlJyA6ICdhc3NpZ24nXSh1cmwpOwogIH0KfQpmdW5jdGlvbiByZXBsYWNlU3RhdGUodXJsKSB7CiAgcHVzaFN0YXRlKHVybCwgdHJ1ZSk7Cn0KCi8vIFdoZW4gY2hhbmdpbmcgdGhpbmcsIGFsc28gZWRpdCByb3V0ZXIuZC50cwp2YXIgTmF2aWdhdGlvbkZhaWx1cmVUeXBlID0gewogIHJlZGlyZWN0ZWQ6IDIsCiAgYWJvcnRlZDogNCwKICBjYW5jZWxsZWQ6IDgsCiAgZHVwbGljYXRlZDogMTYKfTsKZnVuY3Rpb24gY3JlYXRlTmF2aWdhdGlvblJlZGlyZWN0ZWRFcnJvcihmcm9tLCB0bykgewogIHJldHVybiBjcmVhdGVSb3V0ZXJFcnJvcihmcm9tLCB0bywgTmF2aWdhdGlvbkZhaWx1cmVUeXBlLnJlZGlyZWN0ZWQsICJSZWRpcmVjdGVkIHdoZW4gZ29pbmcgZnJvbSBcIiIgKyBmcm9tLmZ1bGxQYXRoICsgIlwiIHRvIFwiIiArIHN0cmluZ2lmeVJvdXRlKHRvKSArICJcIiB2aWEgYSBuYXZpZ2F0aW9uIGd1YXJkLiIpOwp9CmZ1bmN0aW9uIGNyZWF0ZU5hdmlnYXRpb25EdXBsaWNhdGVkRXJyb3IoZnJvbSwgdG8pIHsKICB2YXIgZXJyb3IgPSBjcmVhdGVSb3V0ZXJFcnJvcihmcm9tLCB0bywgTmF2aWdhdGlvbkZhaWx1cmVUeXBlLmR1cGxpY2F0ZWQsICJBdm9pZGVkIHJlZHVuZGFudCBuYXZpZ2F0aW9uIHRvIGN1cnJlbnQgbG9jYXRpb246IFwiIiArIGZyb20uZnVsbFBhdGggKyAiXCIuIik7CiAgLy8gYmFja3dhcmRzIGNvbXBhdGlibGUgd2l0aCB0aGUgZmlyc3QgaW50cm9kdWN0aW9uIG9mIEVycm9ycwogIGVycm9yLm5hbWUgPSAnTmF2aWdhdGlvbkR1cGxpY2F0ZWQnOwogIHJldHVybiBlcnJvcjsKfQpmdW5jdGlvbiBjcmVhdGVOYXZpZ2F0aW9uQ2FuY2VsbGVkRXJyb3IoZnJvbSwgdG8pIHsKICByZXR1cm4gY3JlYXRlUm91dGVyRXJyb3IoZnJvbSwgdG8sIE5hdmlnYXRpb25GYWlsdXJlVHlwZS5jYW5jZWxsZWQsICJOYXZpZ2F0aW9uIGNhbmNlbGxlZCBmcm9tIFwiIiArIGZyb20uZnVsbFBhdGggKyAiXCIgdG8gXCIiICsgdG8uZnVsbFBhdGggKyAiXCIgd2l0aCBhIG5ldyBuYXZpZ2F0aW9uLiIpOwp9CmZ1bmN0aW9uIGNyZWF0ZU5hdmlnYXRpb25BYm9ydGVkRXJyb3IoZnJvbSwgdG8pIHsKICByZXR1cm4gY3JlYXRlUm91dGVyRXJyb3IoZnJvbSwgdG8sIE5hdmlnYXRpb25GYWlsdXJlVHlwZS5hYm9ydGVkLCAiTmF2aWdhdGlvbiBhYm9ydGVkIGZyb20gXCIiICsgZnJvbS5mdWxsUGF0aCArICJcIiB0byBcIiIgKyB0by5mdWxsUGF0aCArICJcIiB2aWEgYSBuYXZpZ2F0aW9uIGd1YXJkLiIpOwp9CmZ1bmN0aW9uIGNyZWF0ZVJvdXRlckVycm9yKGZyb20sIHRvLCB0eXBlLCBtZXNzYWdlKSB7CiAgdmFyIGVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpOwogIGVycm9yLl9pc1JvdXRlciA9IHRydWU7CiAgZXJyb3IuZnJvbSA9IGZyb207CiAgZXJyb3IudG8gPSB0bzsKICBlcnJvci50eXBlID0gdHlwZTsKICByZXR1cm4gZXJyb3I7Cn0KdmFyIHByb3BlcnRpZXNUb0xvZyA9IFsncGFyYW1zJywgJ3F1ZXJ5JywgJ2hhc2gnXTsKZnVuY3Rpb24gc3RyaW5naWZ5Um91dGUodG8pIHsKICBpZiAodHlwZW9mIHRvID09PSAnc3RyaW5nJykgewogICAgcmV0dXJuIHRvOwogIH0KICBpZiAoJ3BhdGgnIGluIHRvKSB7CiAgICByZXR1cm4gdG8ucGF0aDsKICB9CiAgdmFyIGxvY2F0aW9uID0ge307CiAgcHJvcGVydGllc1RvTG9nLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgaWYgKGtleSBpbiB0bykgewogICAgICBsb2NhdGlvbltrZXldID0gdG9ba2V5XTsKICAgIH0KICB9KTsKICByZXR1cm4gSlNPTi5zdHJpbmdpZnkobG9jYXRpb24sIG51bGwsIDIpOwp9CmZ1bmN0aW9uIGlzRXJyb3IoZXJyKSB7CiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChlcnIpLmluZGV4T2YoJ0Vycm9yJykgPiAtMTsKfQpmdW5jdGlvbiBpc05hdmlnYXRpb25GYWlsdXJlKGVyciwgZXJyb3JUeXBlKSB7CiAgcmV0dXJuIGlzRXJyb3IoZXJyKSAmJiBlcnIuX2lzUm91dGVyICYmIChlcnJvclR5cGUgPT0gbnVsbCB8fCBlcnIudHlwZSA9PT0gZXJyb3JUeXBlKTsKfQoKLyogICovCgpmdW5jdGlvbiBydW5RdWV1ZShxdWV1ZSwgZm4sIGNiKSB7CiAgdmFyIHN0ZXAgPSBmdW5jdGlvbiBzdGVwKGluZGV4KSB7CiAgICBpZiAoaW5kZXggPj0gcXVldWUubGVuZ3RoKSB7CiAgICAgIGNiKCk7CiAgICB9IGVsc2UgewogICAgICBpZiAocXVldWVbaW5kZXhdKSB7CiAgICAgICAgZm4ocXVldWVbaW5kZXhdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzdGVwKGluZGV4ICsgMSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RlcChpbmRleCArIDEpOwogICAgICB9CiAgICB9CiAgfTsKICBzdGVwKDApOwp9CgovKiAgKi8KCmZ1bmN0aW9uIHJlc29sdmVBc3luY0NvbXBvbmVudHMobWF0Y2hlZCkgewogIHJldHVybiBmdW5jdGlvbiAodG8sIGZyb20sIG5leHQpIHsKICAgIHZhciBoYXNBc3luYyA9IGZhbHNlOwogICAgdmFyIHBlbmRpbmcgPSAwOwogICAgdmFyIGVycm9yID0gbnVsbDsKICAgIGZsYXRNYXBDb21wb25lbnRzKG1hdGNoZWQsIGZ1bmN0aW9uIChkZWYsIF8sIG1hdGNoLCBrZXkpIHsKICAgICAgLy8gaWYgaXQncyBhIGZ1bmN0aW9uIGFuZCBkb2Vzbid0IGhhdmUgY2lkIGF0dGFjaGVkLAogICAgICAvLyBhc3N1bWUgaXQncyBhbiBhc3luYyBjb21wb25lbnQgcmVzb2x2ZSBmdW5jdGlvbi4KICAgICAgLy8gd2UgYXJlIG5vdCB1c2luZyBWdWUncyBkZWZhdWx0IGFzeW5jIHJlc29sdmluZyBtZWNoYW5pc20gYmVjYXVzZQogICAgICAvLyB3ZSB3YW50IHRvIGhhbHQgdGhlIG5hdmlnYXRpb24gdW50aWwgdGhlIGluY29taW5nIGNvbXBvbmVudCBoYXMgYmVlbgogICAgICAvLyByZXNvbHZlZC4KICAgICAgaWYgKHR5cGVvZiBkZWYgPT09ICdmdW5jdGlvbicgJiYgZGVmLmNpZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaGFzQXN5bmMgPSB0cnVlOwogICAgICAgIHBlbmRpbmcrKzsKICAgICAgICB2YXIgcmVzb2x2ZSA9IG9uY2UoZnVuY3Rpb24gKHJlc29sdmVkRGVmKSB7CiAgICAgICAgICBpZiAoaXNFU01vZHVsZShyZXNvbHZlZERlZikpIHsKICAgICAgICAgICAgcmVzb2x2ZWREZWYgPSByZXNvbHZlZERlZi5kZWZhdWx0OwogICAgICAgICAgfQogICAgICAgICAgLy8gc2F2ZSByZXNvbHZlZCBvbiBhc3luYyBmYWN0b3J5IGluIGNhc2UgaXQncyB1c2VkIGVsc2V3aGVyZQogICAgICAgICAgZGVmLnJlc29sdmVkID0gdHlwZW9mIHJlc29sdmVkRGVmID09PSAnZnVuY3Rpb24nID8gcmVzb2x2ZWREZWYgOiBfVnVlLmV4dGVuZChyZXNvbHZlZERlZik7CiAgICAgICAgICBtYXRjaC5jb21wb25lbnRzW2tleV0gPSByZXNvbHZlZERlZjsKICAgICAgICAgIHBlbmRpbmctLTsKICAgICAgICAgIGlmIChwZW5kaW5nIDw9IDApIHsKICAgICAgICAgICAgbmV4dCgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciByZWplY3QgPSBvbmNlKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIHZhciBtc2cgPSAiRmFpbGVkIHRvIHJlc29sdmUgYXN5bmMgY29tcG9uZW50ICIgKyBrZXkgKyAiOiAiICsgcmVhc29uOwogICAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKGZhbHNlLCBtc2cpOwogICAgICAgICAgaWYgKCFlcnJvcikgewogICAgICAgICAgICBlcnJvciA9IGlzRXJyb3IocmVhc29uKSA/IHJlYXNvbiA6IG5ldyBFcnJvcihtc2cpOwogICAgICAgICAgICBuZXh0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgcmVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXMgPSBkZWYocmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgfQogICAgICAgIGlmIChyZXMpIHsKICAgICAgICAgIGlmICh0eXBlb2YgcmVzLnRoZW4gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgcmVzLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIG5ldyBzeW50YXggaW4gVnVlIDIuMwogICAgICAgICAgICB2YXIgY29tcCA9IHJlcy5jb21wb25lbnQ7CiAgICAgICAgICAgIGlmIChjb21wICYmIHR5cGVvZiBjb21wLnRoZW4gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICBjb21wLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBpZiAoIWhhc0FzeW5jKSB7CiAgICAgIG5leHQoKTsKICAgIH0KICB9Owp9CmZ1bmN0aW9uIGZsYXRNYXBDb21wb25lbnRzKG1hdGNoZWQsIGZuKSB7CiAgcmV0dXJuIGZsYXR0ZW4obWF0Y2hlZC5tYXAoZnVuY3Rpb24gKG0pIHsKICAgIHJldHVybiBPYmplY3Qua2V5cyhtLmNvbXBvbmVudHMpLm1hcChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHJldHVybiBmbihtLmNvbXBvbmVudHNba2V5XSwgbS5pbnN0YW5jZXNba2V5XSwgbSwga2V5KTsKICAgIH0pOwogIH0pKTsKfQpmdW5jdGlvbiBmbGF0dGVuKGFycikgewogIHJldHVybiBBcnJheS5wcm90b3R5cGUuY29uY2F0LmFwcGx5KFtdLCBhcnIpOwp9CnZhciBoYXNTeW1ib2wgPSB0eXBlb2YgU3ltYm9sID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBTeW1ib2wudG9TdHJpbmdUYWcgPT09ICdzeW1ib2wnOwpmdW5jdGlvbiBpc0VTTW9kdWxlKG9iaikgewogIHJldHVybiBvYmouX19lc01vZHVsZSB8fCBoYXNTeW1ib2wgJiYgb2JqW1N5bWJvbC50b1N0cmluZ1RhZ10gPT09ICdNb2R1bGUnOwp9CgovLyBpbiBXZWJwYWNrIDIsIHJlcXVpcmUuZW5zdXJlIG5vdyBhbHNvIHJldHVybnMgYSBQcm9taXNlCi8vIHNvIHRoZSByZXNvbHZlL3JlamVjdCBmdW5jdGlvbnMgbWF5IGdldCBjYWxsZWQgYW4gZXh0cmEgdGltZQovLyBpZiB0aGUgdXNlciB1c2VzIGFuIGFycm93IGZ1bmN0aW9uIHNob3J0aGFuZCB0aGF0IGhhcHBlbnMgdG8KLy8gcmV0dXJuIHRoYXQgUHJvbWlzZS4KZnVuY3Rpb24gb25jZShmbikgewogIHZhciBjYWxsZWQgPSBmYWxzZTsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgIHdoaWxlIChsZW4tLSkgYXJnc1tsZW5dID0gYXJndW1lbnRzW2xlbl07CiAgICBpZiAoY2FsbGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNhbGxlZCA9IHRydWU7CiAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJncyk7CiAgfTsKfQoKLyogICovCgp2YXIgSGlzdG9yeSA9IGZ1bmN0aW9uIEhpc3Rvcnkocm91dGVyLCBiYXNlKSB7CiAgdGhpcy5yb3V0ZXIgPSByb3V0ZXI7CiAgdGhpcy5iYXNlID0gbm9ybWFsaXplQmFzZShiYXNlKTsKICAvLyBzdGFydCB3aXRoIGEgcm91dGUgb2JqZWN0IHRoYXQgc3RhbmRzIGZvciAibm93aGVyZSIKICB0aGlzLmN1cnJlbnQgPSBTVEFSVDsKICB0aGlzLnBlbmRpbmcgPSBudWxsOwogIHRoaXMucmVhZHkgPSBmYWxzZTsKICB0aGlzLnJlYWR5Q2JzID0gW107CiAgdGhpcy5yZWFkeUVycm9yQ2JzID0gW107CiAgdGhpcy5lcnJvckNicyA9IFtdOwogIHRoaXMubGlzdGVuZXJzID0gW107Cn07Ckhpc3RvcnkucHJvdG90eXBlLmxpc3RlbiA9IGZ1bmN0aW9uIGxpc3RlbihjYikgewogIHRoaXMuY2IgPSBjYjsKfTsKSGlzdG9yeS5wcm90b3R5cGUub25SZWFkeSA9IGZ1bmN0aW9uIG9uUmVhZHkoY2IsIGVycm9yQ2IpIHsKICBpZiAodGhpcy5yZWFkeSkgewogICAgY2IoKTsKICB9IGVsc2UgewogICAgdGhpcy5yZWFkeUNicy5wdXNoKGNiKTsKICAgIGlmIChlcnJvckNiKSB7CiAgICAgIHRoaXMucmVhZHlFcnJvckNicy5wdXNoKGVycm9yQ2IpOwogICAgfQogIH0KfTsKSGlzdG9yeS5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIG9uRXJyb3IoZXJyb3JDYikgewogIHRoaXMuZXJyb3JDYnMucHVzaChlcnJvckNiKTsKfTsKSGlzdG9yeS5wcm90b3R5cGUudHJhbnNpdGlvblRvID0gZnVuY3Rpb24gdHJhbnNpdGlvblRvKGxvY2F0aW9uLCBvbkNvbXBsZXRlLCBvbkFib3J0KSB7CiAgdmFyIHRoaXMkMSQxID0gdGhpczsKICB2YXIgcm91dGU7CiAgLy8gY2F0Y2ggcmVkaXJlY3Qgb3B0aW9uIGh0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWUtcm91dGVyL2lzc3Vlcy8zMjAxCiAgdHJ5IHsKICAgIHJvdXRlID0gdGhpcy5yb3V0ZXIubWF0Y2gobG9jYXRpb24sIHRoaXMuY3VycmVudCk7CiAgfSBjYXRjaCAoZSkgewogICAgdGhpcy5lcnJvckNicy5mb3JFYWNoKGZ1bmN0aW9uIChjYikgewogICAgICBjYihlKTsKICAgIH0pOwogICAgLy8gRXhjZXB0aW9uIHNob3VsZCBzdGlsbCBiZSB0aHJvd24KICAgIHRocm93IGU7CiAgfQogIHZhciBwcmV2ID0gdGhpcy5jdXJyZW50OwogIHRoaXMuY29uZmlybVRyYW5zaXRpb24ocm91dGUsIGZ1bmN0aW9uICgpIHsKICAgIHRoaXMkMSQxLnVwZGF0ZVJvdXRlKHJvdXRlKTsKICAgIG9uQ29tcGxldGUgJiYgb25Db21wbGV0ZShyb3V0ZSk7CiAgICB0aGlzJDEkMS5lbnN1cmVVUkwoKTsKICAgIHRoaXMkMSQxLnJvdXRlci5hZnRlckhvb2tzLmZvckVhY2goZnVuY3Rpb24gKGhvb2spIHsKICAgICAgaG9vayAmJiBob29rKHJvdXRlLCBwcmV2KTsKICAgIH0pOwoKICAgIC8vIGZpcmUgcmVhZHkgY2JzIG9uY2UKICAgIGlmICghdGhpcyQxJDEucmVhZHkpIHsKICAgICAgdGhpcyQxJDEucmVhZHkgPSB0cnVlOwogICAgICB0aGlzJDEkMS5yZWFkeUNicy5mb3JFYWNoKGZ1bmN0aW9uIChjYikgewogICAgICAgIGNiKHJvdXRlKTsKICAgICAgfSk7CiAgICB9CiAgfSwgZnVuY3Rpb24gKGVycikgewogICAgaWYgKG9uQWJvcnQpIHsKICAgICAgb25BYm9ydChlcnIpOwogICAgfQogICAgaWYgKGVyciAmJiAhdGhpcyQxJDEucmVhZHkpIHsKICAgICAgLy8gSW5pdGlhbCByZWRpcmVjdGlvbiBzaG91bGQgbm90IG1hcmsgdGhlIGhpc3RvcnkgYXMgcmVhZHkgeWV0CiAgICAgIC8vIGJlY2F1c2UgaXQncyB0cmlnZ2VyZWQgYnkgdGhlIHJlZGlyZWN0aW9uIGluc3RlYWQKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL3Z1ZS1yb3V0ZXIvaXNzdWVzLzMyMjUKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL3Z1ZS1yb3V0ZXIvaXNzdWVzLzMzMzEKICAgICAgaWYgKCFpc05hdmlnYXRpb25GYWlsdXJlKGVyciwgTmF2aWdhdGlvbkZhaWx1cmVUeXBlLnJlZGlyZWN0ZWQpIHx8IHByZXYgIT09IFNUQVJUKSB7CiAgICAgICAgdGhpcyQxJDEucmVhZHkgPSB0cnVlOwogICAgICAgIHRoaXMkMSQxLnJlYWR5RXJyb3JDYnMuZm9yRWFjaChmdW5jdGlvbiAoY2IpIHsKICAgICAgICAgIGNiKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9KTsKfTsKSGlzdG9yeS5wcm90b3R5cGUuY29uZmlybVRyYW5zaXRpb24gPSBmdW5jdGlvbiBjb25maXJtVHJhbnNpdGlvbihyb3V0ZSwgb25Db21wbGV0ZSwgb25BYm9ydCkgewogIHZhciB0aGlzJDEkMSA9IHRoaXM7CiAgdmFyIGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQ7CiAgdGhpcy5wZW5kaW5nID0gcm91dGU7CiAgdmFyIGFib3J0ID0gZnVuY3Rpb24gYWJvcnQoZXJyKSB7CiAgICAvLyBjaGFuZ2VkIGFmdGVyIGFkZGluZyBlcnJvcnMgd2l0aAogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL3Z1ZS1yb3V0ZXIvcHVsbC8zMDQ3IGJlZm9yZSB0aGF0IGNoYW5nZSwKICAgIC8vIHJlZGlyZWN0IGFuZCBhYm9ydGVkIG5hdmlnYXRpb24gd291bGQgcHJvZHVjZSBhbiBlcnIgPT0gbnVsbAogICAgaWYgKCFpc05hdmlnYXRpb25GYWlsdXJlKGVycikgJiYgaXNFcnJvcihlcnIpKSB7CiAgICAgIGlmICh0aGlzJDEkMS5lcnJvckNicy5sZW5ndGgpIHsKICAgICAgICB0aGlzJDEkMS5lcnJvckNicy5mb3JFYWNoKGZ1bmN0aW9uIChjYikgewogICAgICAgICAgY2IoZXJyKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgd2FybihmYWxzZSwgJ3VuY2F1Z2h0IGVycm9yIGR1cmluZyByb3V0ZSBuYXZpZ2F0aW9uOicpOwogICAgICAgIH0KICAgICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgIH0KICAgIH0KICAgIG9uQWJvcnQgJiYgb25BYm9ydChlcnIpOwogIH07CiAgdmFyIGxhc3RSb3V0ZUluZGV4ID0gcm91dGUubWF0Y2hlZC5sZW5ndGggLSAxOwogIHZhciBsYXN0Q3VycmVudEluZGV4ID0gY3VycmVudC5tYXRjaGVkLmxlbmd0aCAtIDE7CiAgaWYgKGlzU2FtZVJvdXRlKHJvdXRlLCBjdXJyZW50KSAmJgogIC8vIGluIHRoZSBjYXNlIHRoZSByb3V0ZSBtYXAgaGFzIGJlZW4gZHluYW1pY2FsbHkgYXBwZW5kZWQgdG8KICBsYXN0Um91dGVJbmRleCA9PT0gbGFzdEN1cnJlbnRJbmRleCAmJiByb3V0ZS5tYXRjaGVkW2xhc3RSb3V0ZUluZGV4XSA9PT0gY3VycmVudC5tYXRjaGVkW2xhc3RDdXJyZW50SW5kZXhdKSB7CiAgICB0aGlzLmVuc3VyZVVSTCgpOwogICAgaWYgKHJvdXRlLmhhc2gpIHsKICAgICAgaGFuZGxlU2Nyb2xsKHRoaXMucm91dGVyLCBjdXJyZW50LCByb3V0ZSwgZmFsc2UpOwogICAgfQogICAgcmV0dXJuIGFib3J0KGNyZWF0ZU5hdmlnYXRpb25EdXBsaWNhdGVkRXJyb3IoY3VycmVudCwgcm91dGUpKTsKICB9CiAgdmFyIHJlZiA9IHJlc29sdmVRdWV1ZSh0aGlzLmN1cnJlbnQubWF0Y2hlZCwgcm91dGUubWF0Y2hlZCk7CiAgdmFyIHVwZGF0ZWQgPSByZWYudXBkYXRlZDsKICB2YXIgZGVhY3RpdmF0ZWQgPSByZWYuZGVhY3RpdmF0ZWQ7CiAgdmFyIGFjdGl2YXRlZCA9IHJlZi5hY3RpdmF0ZWQ7CiAgdmFyIHF1ZXVlID0gW10uY29uY2F0KAogIC8vIGluLWNvbXBvbmVudCBsZWF2ZSBndWFyZHMKICBleHRyYWN0TGVhdmVHdWFyZHMoZGVhY3RpdmF0ZWQpLAogIC8vIGdsb2JhbCBiZWZvcmUgaG9va3MKICB0aGlzLnJvdXRlci5iZWZvcmVIb29rcywKICAvLyBpbi1jb21wb25lbnQgdXBkYXRlIGhvb2tzCiAgZXh0cmFjdFVwZGF0ZUhvb2tzKHVwZGF0ZWQpLAogIC8vIGluLWNvbmZpZyBlbnRlciBndWFyZHMKICBhY3RpdmF0ZWQubWFwKGZ1bmN0aW9uIChtKSB7CiAgICByZXR1cm4gbS5iZWZvcmVFbnRlcjsKICB9KSwKICAvLyBhc3luYyBjb21wb25lbnRzCiAgcmVzb2x2ZUFzeW5jQ29tcG9uZW50cyhhY3RpdmF0ZWQpKTsKICB2YXIgaXRlcmF0b3IgPSBmdW5jdGlvbiBpdGVyYXRvcihob29rLCBuZXh0KSB7CiAgICBpZiAodGhpcyQxJDEucGVuZGluZyAhPT0gcm91dGUpIHsKICAgICAgcmV0dXJuIGFib3J0KGNyZWF0ZU5hdmlnYXRpb25DYW5jZWxsZWRFcnJvcihjdXJyZW50LCByb3V0ZSkpOwogICAgfQogICAgdHJ5IHsKICAgICAgaG9vayhyb3V0ZSwgY3VycmVudCwgZnVuY3Rpb24gKHRvKSB7CiAgICAgICAgaWYgKHRvID09PSBmYWxzZSkgewogICAgICAgICAgLy8gbmV4dChmYWxzZSkgLT4gYWJvcnQgbmF2aWdhdGlvbiwgZW5zdXJlIGN1cnJlbnQgVVJMCiAgICAgICAgICB0aGlzJDEkMS5lbnN1cmVVUkwodHJ1ZSk7CiAgICAgICAgICBhYm9ydChjcmVhdGVOYXZpZ2F0aW9uQWJvcnRlZEVycm9yKGN1cnJlbnQsIHJvdXRlKSk7CiAgICAgICAgfSBlbHNlIGlmIChpc0Vycm9yKHRvKSkgewogICAgICAgICAgdGhpcyQxJDEuZW5zdXJlVVJMKHRydWUpOwogICAgICAgICAgYWJvcnQodG8pOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRvID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdG8gPT09ICdvYmplY3QnICYmICh0eXBlb2YgdG8ucGF0aCA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHRvLm5hbWUgPT09ICdzdHJpbmcnKSkgewogICAgICAgICAgLy8gbmV4dCgnLycpIG9yIG5leHQoeyBwYXRoOiAnLycgfSkgLT4gcmVkaXJlY3QKICAgICAgICAgIGFib3J0KGNyZWF0ZU5hdmlnYXRpb25SZWRpcmVjdGVkRXJyb3IoY3VycmVudCwgcm91dGUpKTsKICAgICAgICAgIGlmICh0eXBlb2YgdG8gPT09ICdvYmplY3QnICYmIHRvLnJlcGxhY2UpIHsKICAgICAgICAgICAgdGhpcyQxJDEucmVwbGFjZSh0byk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzJDEkMS5wdXNoKHRvKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gY29uZmlybSB0cmFuc2l0aW9uIGFuZCBwYXNzIG9uIHRoZSB2YWx1ZQogICAgICAgICAgbmV4dCh0byk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgYWJvcnQoZSk7CiAgICB9CiAgfTsKICBydW5RdWV1ZShxdWV1ZSwgaXRlcmF0b3IsIGZ1bmN0aW9uICgpIHsKICAgIC8vIHdhaXQgdW50aWwgYXN5bmMgY29tcG9uZW50cyBhcmUgcmVzb2x2ZWQgYmVmb3JlCiAgICAvLyBleHRyYWN0aW5nIGluLWNvbXBvbmVudCBlbnRlciBndWFyZHMKICAgIHZhciBlbnRlckd1YXJkcyA9IGV4dHJhY3RFbnRlckd1YXJkcyhhY3RpdmF0ZWQpOwogICAgdmFyIHF1ZXVlID0gZW50ZXJHdWFyZHMuY29uY2F0KHRoaXMkMSQxLnJvdXRlci5yZXNvbHZlSG9va3MpOwogICAgcnVuUXVldWUocXVldWUsIGl0ZXJhdG9yLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzJDEkMS5wZW5kaW5nICE9PSByb3V0ZSkgewogICAgICAgIHJldHVybiBhYm9ydChjcmVhdGVOYXZpZ2F0aW9uQ2FuY2VsbGVkRXJyb3IoY3VycmVudCwgcm91dGUpKTsKICAgICAgfQogICAgICB0aGlzJDEkMS5wZW5kaW5nID0gbnVsbDsKICAgICAgb25Db21wbGV0ZShyb3V0ZSk7CiAgICAgIGlmICh0aGlzJDEkMS5yb3V0ZXIuYXBwKSB7CiAgICAgICAgdGhpcyQxJDEucm91dGVyLmFwcC4kbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgaGFuZGxlUm91dGVFbnRlcmVkKHJvdXRlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfSk7Cn07Ckhpc3RvcnkucHJvdG90eXBlLnVwZGF0ZVJvdXRlID0gZnVuY3Rpb24gdXBkYXRlUm91dGUocm91dGUpIHsKICB0aGlzLmN1cnJlbnQgPSByb3V0ZTsKICB0aGlzLmNiICYmIHRoaXMuY2Iocm91dGUpOwp9OwpIaXN0b3J5LnByb3RvdHlwZS5zZXR1cExpc3RlbmVycyA9IGZ1bmN0aW9uIHNldHVwTGlzdGVuZXJzKCkgewogIC8vIERlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMgZW1wdHkKfTsKSGlzdG9yeS5wcm90b3R5cGUudGVhcmRvd24gPSBmdW5jdGlvbiB0ZWFyZG93bigpIHsKICAvLyBjbGVhbiB1cCBldmVudCBsaXN0ZW5lcnMKICAvLyBodHRwczovL2dpdGh1Yi5jb20vdnVlanMvdnVlLXJvdXRlci9pc3N1ZXMvMjM0MQogIHRoaXMubGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24gKGNsZWFudXBMaXN0ZW5lcikgewogICAgY2xlYW51cExpc3RlbmVyKCk7CiAgfSk7CiAgdGhpcy5saXN0ZW5lcnMgPSBbXTsKCiAgLy8gcmVzZXQgY3VycmVudCBoaXN0b3J5IHJvdXRlCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL3Z1ZS1yb3V0ZXIvaXNzdWVzLzMyOTQKICB0aGlzLmN1cnJlbnQgPSBTVEFSVDsKICB0aGlzLnBlbmRpbmcgPSBudWxsOwp9OwpmdW5jdGlvbiBub3JtYWxpemVCYXNlKGJhc2UpIHsKICBpZiAoIWJhc2UpIHsKICAgIGlmIChpbkJyb3dzZXIpIHsKICAgICAgLy8gcmVzcGVjdCA8YmFzZT4gdGFnCiAgICAgIHZhciBiYXNlRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdiYXNlJyk7CiAgICAgIGJhc2UgPSBiYXNlRWwgJiYgYmFzZUVsLmdldEF0dHJpYnV0ZSgnaHJlZicpIHx8ICcvJzsKICAgICAgLy8gc3RyaXAgZnVsbCBVUkwgb3JpZ2luCiAgICAgIGJhc2UgPSBiYXNlLnJlcGxhY2UoL15odHRwcz86XC9cL1teXC9dKy8sICcnKTsKICAgIH0gZWxzZSB7CiAgICAgIGJhc2UgPSAnLyc7CiAgICB9CiAgfQogIC8vIG1ha2Ugc3VyZSB0aGVyZSdzIHRoZSBzdGFydGluZyBzbGFzaAogIGlmIChiYXNlLmNoYXJBdCgwKSAhPT0gJy8nKSB7CiAgICBiYXNlID0gJy8nICsgYmFzZTsKICB9CiAgLy8gcmVtb3ZlIHRyYWlsaW5nIHNsYXNoCiAgcmV0dXJuIGJhc2UucmVwbGFjZSgvXC8kLywgJycpOwp9CmZ1bmN0aW9uIHJlc29sdmVRdWV1ZShjdXJyZW50LCBuZXh0KSB7CiAgdmFyIGk7CiAgdmFyIG1heCA9IE1hdGgubWF4KGN1cnJlbnQubGVuZ3RoLCBuZXh0Lmxlbmd0aCk7CiAgZm9yIChpID0gMDsgaSA8IG1heDsgaSsrKSB7CiAgICBpZiAoY3VycmVudFtpXSAhPT0gbmV4dFtpXSkgewogICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHVwZGF0ZWQ6IG5leHQuc2xpY2UoMCwgaSksCiAgICBhY3RpdmF0ZWQ6IG5leHQuc2xpY2UoaSksCiAgICBkZWFjdGl2YXRlZDogY3VycmVudC5zbGljZShpKQogIH07Cn0KZnVuY3Rpb24gZXh0cmFjdEd1YXJkcyhyZWNvcmRzLCBuYW1lLCBiaW5kLCByZXZlcnNlKSB7CiAgdmFyIGd1YXJkcyA9IGZsYXRNYXBDb21wb25lbnRzKHJlY29yZHMsIGZ1bmN0aW9uIChkZWYsIGluc3RhbmNlLCBtYXRjaCwga2V5KSB7CiAgICB2YXIgZ3VhcmQgPSBleHRyYWN0R3VhcmQoZGVmLCBuYW1lKTsKICAgIGlmIChndWFyZCkgewogICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShndWFyZCkgPyBndWFyZC5tYXAoZnVuY3Rpb24gKGd1YXJkKSB7CiAgICAgICAgcmV0dXJuIGJpbmQoZ3VhcmQsIGluc3RhbmNlLCBtYXRjaCwga2V5KTsKICAgICAgfSkgOiBiaW5kKGd1YXJkLCBpbnN0YW5jZSwgbWF0Y2gsIGtleSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIGZsYXR0ZW4ocmV2ZXJzZSA/IGd1YXJkcy5yZXZlcnNlKCkgOiBndWFyZHMpOwp9CmZ1bmN0aW9uIGV4dHJhY3RHdWFyZChkZWYsIGtleSkgewogIGlmICh0eXBlb2YgZGVmICE9PSAnZnVuY3Rpb24nKSB7CiAgICAvLyBleHRlbmQgbm93IHNvIHRoYXQgZ2xvYmFsIG1peGlucyBhcmUgYXBwbGllZC4KICAgIGRlZiA9IF9WdWUuZXh0ZW5kKGRlZik7CiAgfQogIHJldHVybiBkZWYub3B0aW9uc1trZXldOwp9CmZ1bmN0aW9uIGV4dHJhY3RMZWF2ZUd1YXJkcyhkZWFjdGl2YXRlZCkgewogIHJldHVybiBleHRyYWN0R3VhcmRzKGRlYWN0aXZhdGVkLCAnYmVmb3JlUm91dGVMZWF2ZScsIGJpbmRHdWFyZCwgdHJ1ZSk7Cn0KZnVuY3Rpb24gZXh0cmFjdFVwZGF0ZUhvb2tzKHVwZGF0ZWQpIHsKICByZXR1cm4gZXh0cmFjdEd1YXJkcyh1cGRhdGVkLCAnYmVmb3JlUm91dGVVcGRhdGUnLCBiaW5kR3VhcmQpOwp9CmZ1bmN0aW9uIGJpbmRHdWFyZChndWFyZCwgaW5zdGFuY2UpIHsKICBpZiAoaW5zdGFuY2UpIHsKICAgIHJldHVybiBmdW5jdGlvbiBib3VuZFJvdXRlR3VhcmQoKSB7CiAgICAgIHJldHVybiBndWFyZC5hcHBseShpbnN0YW5jZSwgYXJndW1lbnRzKTsKICAgIH07CiAgfQp9CmZ1bmN0aW9uIGV4dHJhY3RFbnRlckd1YXJkcyhhY3RpdmF0ZWQpIHsKICByZXR1cm4gZXh0cmFjdEd1YXJkcyhhY3RpdmF0ZWQsICdiZWZvcmVSb3V0ZUVudGVyJywgZnVuY3Rpb24gKGd1YXJkLCBfLCBtYXRjaCwga2V5KSB7CiAgICByZXR1cm4gYmluZEVudGVyR3VhcmQoZ3VhcmQsIG1hdGNoLCBrZXkpOwogIH0pOwp9CmZ1bmN0aW9uIGJpbmRFbnRlckd1YXJkKGd1YXJkLCBtYXRjaCwga2V5KSB7CiAgcmV0dXJuIGZ1bmN0aW9uIHJvdXRlRW50ZXJHdWFyZCh0bywgZnJvbSwgbmV4dCkgewogICAgcmV0dXJuIGd1YXJkKHRvLCBmcm9tLCBmdW5jdGlvbiAoY2IpIHsKICAgICAgaWYgKHR5cGVvZiBjYiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGlmICghbWF0Y2guZW50ZXJlZENic1trZXldKSB7CiAgICAgICAgICBtYXRjaC5lbnRlcmVkQ2JzW2tleV0gPSBbXTsKICAgICAgICB9CiAgICAgICAgbWF0Y2guZW50ZXJlZENic1trZXldLnB1c2goY2IpOwogICAgICB9CiAgICAgIG5leHQoY2IpOwogICAgfSk7CiAgfTsKfQoKLyogICovCgp2YXIgSFRNTDVIaXN0b3J5ID0gLypAX19QVVJFX18qL2Z1bmN0aW9uIChIaXN0b3J5KSB7CiAgZnVuY3Rpb24gSFRNTDVIaXN0b3J5KHJvdXRlciwgYmFzZSkgewogICAgSGlzdG9yeS5jYWxsKHRoaXMsIHJvdXRlciwgYmFzZSk7CiAgICB0aGlzLl9zdGFydExvY2F0aW9uID0gZ2V0TG9jYXRpb24odGhpcy5iYXNlKTsKICB9CiAgaWYgKEhpc3RvcnkpIEhUTUw1SGlzdG9yeS5fX3Byb3RvX18gPSBIaXN0b3J5OwogIEhUTUw1SGlzdG9yeS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEhpc3RvcnkgJiYgSGlzdG9yeS5wcm90b3R5cGUpOwogIEhUTUw1SGlzdG9yeS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBIVE1MNUhpc3Rvcnk7CiAgSFRNTDVIaXN0b3J5LnByb3RvdHlwZS5zZXR1cExpc3RlbmVycyA9IGZ1bmN0aW9uIHNldHVwTGlzdGVuZXJzKCkgewogICAgdmFyIHRoaXMkMSQxID0gdGhpczsKICAgIGlmICh0aGlzLmxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciByb3V0ZXIgPSB0aGlzLnJvdXRlcjsKICAgIHZhciBleHBlY3RTY3JvbGwgPSByb3V0ZXIub3B0aW9ucy5zY3JvbGxCZWhhdmlvcjsKICAgIHZhciBzdXBwb3J0c1Njcm9sbCA9IHN1cHBvcnRzUHVzaFN0YXRlICYmIGV4cGVjdFNjcm9sbDsKICAgIGlmIChzdXBwb3J0c1Njcm9sbCkgewogICAgICB0aGlzLmxpc3RlbmVycy5wdXNoKHNldHVwU2Nyb2xsKCkpOwogICAgfQogICAgdmFyIGhhbmRsZVJvdXRpbmdFdmVudCA9IGZ1bmN0aW9uIGhhbmRsZVJvdXRpbmdFdmVudCgpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzJDEkMS5jdXJyZW50OwoKICAgICAgLy8gQXZvaWRpbmcgZmlyc3QgYHBvcHN0YXRlYCBldmVudCBkaXNwYXRjaGVkIGluIHNvbWUgYnJvd3NlcnMgYnV0IGZpcnN0CiAgICAgIC8vIGhpc3Rvcnkgcm91dGUgbm90IHVwZGF0ZWQgc2luY2UgYXN5bmMgZ3VhcmQgYXQgdGhlIHNhbWUgdGltZS4KICAgICAgdmFyIGxvY2F0aW9uID0gZ2V0TG9jYXRpb24odGhpcyQxJDEuYmFzZSk7CiAgICAgIGlmICh0aGlzJDEkMS5jdXJyZW50ID09PSBTVEFSVCAmJiBsb2NhdGlvbiA9PT0gdGhpcyQxJDEuX3N0YXJ0TG9jYXRpb24pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhpcyQxJDEudHJhbnNpdGlvblRvKGxvY2F0aW9uLCBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgICBpZiAoc3VwcG9ydHNTY3JvbGwpIHsKICAgICAgICAgIGhhbmRsZVNjcm9sbChyb3V0ZXIsIHJvdXRlLCBjdXJyZW50LCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIGhhbmRsZVJvdXRpbmdFdmVudCk7CiAgICB0aGlzLmxpc3RlbmVycy5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgaGFuZGxlUm91dGluZ0V2ZW50KTsKICAgIH0pOwogIH07CiAgSFRNTDVIaXN0b3J5LnByb3RvdHlwZS5nbyA9IGZ1bmN0aW9uIGdvKG4pIHsKICAgIHdpbmRvdy5oaXN0b3J5LmdvKG4pOwogIH07CiAgSFRNTDVIaXN0b3J5LnByb3RvdHlwZS5wdXNoID0gZnVuY3Rpb24gcHVzaChsb2NhdGlvbiwgb25Db21wbGV0ZSwgb25BYm9ydCkgewogICAgdmFyIHRoaXMkMSQxID0gdGhpczsKICAgIHZhciByZWYgPSB0aGlzOwogICAgdmFyIGZyb21Sb3V0ZSA9IHJlZi5jdXJyZW50OwogICAgdGhpcy50cmFuc2l0aW9uVG8obG9jYXRpb24sIGZ1bmN0aW9uIChyb3V0ZSkgewogICAgICBwdXNoU3RhdGUoY2xlYW5QYXRoKHRoaXMkMSQxLmJhc2UgKyByb3V0ZS5mdWxsUGF0aCkpOwogICAgICBoYW5kbGVTY3JvbGwodGhpcyQxJDEucm91dGVyLCByb3V0ZSwgZnJvbVJvdXRlLCBmYWxzZSk7CiAgICAgIG9uQ29tcGxldGUgJiYgb25Db21wbGV0ZShyb3V0ZSk7CiAgICB9LCBvbkFib3J0KTsKICB9OwogIEhUTUw1SGlzdG9yeS5wcm90b3R5cGUucmVwbGFjZSA9IGZ1bmN0aW9uIHJlcGxhY2UobG9jYXRpb24sIG9uQ29tcGxldGUsIG9uQWJvcnQpIHsKICAgIHZhciB0aGlzJDEkMSA9IHRoaXM7CiAgICB2YXIgcmVmID0gdGhpczsKICAgIHZhciBmcm9tUm91dGUgPSByZWYuY3VycmVudDsKICAgIHRoaXMudHJhbnNpdGlvblRvKGxvY2F0aW9uLCBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgcmVwbGFjZVN0YXRlKGNsZWFuUGF0aCh0aGlzJDEkMS5iYXNlICsgcm91dGUuZnVsbFBhdGgpKTsKICAgICAgaGFuZGxlU2Nyb2xsKHRoaXMkMSQxLnJvdXRlciwgcm91dGUsIGZyb21Sb3V0ZSwgZmFsc2UpOwogICAgICBvbkNvbXBsZXRlICYmIG9uQ29tcGxldGUocm91dGUpOwogICAgfSwgb25BYm9ydCk7CiAgfTsKICBIVE1MNUhpc3RvcnkucHJvdG90eXBlLmVuc3VyZVVSTCA9IGZ1bmN0aW9uIGVuc3VyZVVSTChwdXNoKSB7CiAgICBpZiAoZ2V0TG9jYXRpb24odGhpcy5iYXNlKSAhPT0gdGhpcy5jdXJyZW50LmZ1bGxQYXRoKSB7CiAgICAgIHZhciBjdXJyZW50ID0gY2xlYW5QYXRoKHRoaXMuYmFzZSArIHRoaXMuY3VycmVudC5mdWxsUGF0aCk7CiAgICAgIHB1c2ggPyBwdXNoU3RhdGUoY3VycmVudCkgOiByZXBsYWNlU3RhdGUoY3VycmVudCk7CiAgICB9CiAgfTsKICBIVE1MNUhpc3RvcnkucHJvdG90eXBlLmdldEN1cnJlbnRMb2NhdGlvbiA9IGZ1bmN0aW9uIGdldEN1cnJlbnRMb2NhdGlvbigpIHsKICAgIHJldHVybiBnZXRMb2NhdGlvbih0aGlzLmJhc2UpOwogIH07CiAgcmV0dXJuIEhUTUw1SGlzdG9yeTsKfShIaXN0b3J5KTsKZnVuY3Rpb24gZ2V0TG9jYXRpb24oYmFzZSkgewogIHZhciBwYXRoID0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lOwogIHZhciBwYXRoTG93ZXJDYXNlID0gcGF0aC50b0xvd2VyQ2FzZSgpOwogIHZhciBiYXNlTG93ZXJDYXNlID0gYmFzZS50b0xvd2VyQ2FzZSgpOwogIC8vIGJhc2U9Ii9hIiBzaG91bGRuJ3QgdHVybiBwYXRoPSIvYXBwIiBpbnRvICIvYS9wcCIKICAvLyBodHRwczovL2dpdGh1Yi5jb20vdnVlanMvdnVlLXJvdXRlci9pc3N1ZXMvMzU1NQogIC8vIHNvIHdlIGVuc3VyZSB0aGUgdHJhaWxpbmcgc2xhc2ggaW4gdGhlIGJhc2UKICBpZiAoYmFzZSAmJiAocGF0aExvd2VyQ2FzZSA9PT0gYmFzZUxvd2VyQ2FzZSB8fCBwYXRoTG93ZXJDYXNlLmluZGV4T2YoY2xlYW5QYXRoKGJhc2VMb3dlckNhc2UgKyAnLycpKSA9PT0gMCkpIHsKICAgIHBhdGggPSBwYXRoLnNsaWNlKGJhc2UubGVuZ3RoKTsKICB9CiAgcmV0dXJuIChwYXRoIHx8ICcvJykgKyB3aW5kb3cubG9jYXRpb24uc2VhcmNoICsgd2luZG93LmxvY2F0aW9uLmhhc2g7Cn0KCi8qICAqLwoKdmFyIEhhc2hIaXN0b3J5ID0gLypAX19QVVJFX18qL2Z1bmN0aW9uIChIaXN0b3J5KSB7CiAgZnVuY3Rpb24gSGFzaEhpc3Rvcnkocm91dGVyLCBiYXNlLCBmYWxsYmFjaykgewogICAgSGlzdG9yeS5jYWxsKHRoaXMsIHJvdXRlciwgYmFzZSk7CiAgICAvLyBjaGVjayBoaXN0b3J5IGZhbGxiYWNrIGRlZXBsaW5raW5nCiAgICBpZiAoZmFsbGJhY2sgJiYgY2hlY2tGYWxsYmFjayh0aGlzLmJhc2UpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGVuc3VyZVNsYXNoKCk7CiAgfQogIGlmIChIaXN0b3J5KSBIYXNoSGlzdG9yeS5fX3Byb3RvX18gPSBIaXN0b3J5OwogIEhhc2hIaXN0b3J5LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoSGlzdG9yeSAmJiBIaXN0b3J5LnByb3RvdHlwZSk7CiAgSGFzaEhpc3RvcnkucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSGFzaEhpc3Rvcnk7CgogIC8vIHRoaXMgaXMgZGVsYXllZCB1bnRpbCB0aGUgYXBwIG1vdW50cwogIC8vIHRvIGF2b2lkIHRoZSBoYXNoY2hhbmdlIGxpc3RlbmVyIGJlaW5nIGZpcmVkIHRvbyBlYXJseQogIEhhc2hIaXN0b3J5LnByb3RvdHlwZS5zZXR1cExpc3RlbmVycyA9IGZ1bmN0aW9uIHNldHVwTGlzdGVuZXJzKCkgewogICAgdmFyIHRoaXMkMSQxID0gdGhpczsKICAgIGlmICh0aGlzLmxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciByb3V0ZXIgPSB0aGlzLnJvdXRlcjsKICAgIHZhciBleHBlY3RTY3JvbGwgPSByb3V0ZXIub3B0aW9ucy5zY3JvbGxCZWhhdmlvcjsKICAgIHZhciBzdXBwb3J0c1Njcm9sbCA9IHN1cHBvcnRzUHVzaFN0YXRlICYmIGV4cGVjdFNjcm9sbDsKICAgIGlmIChzdXBwb3J0c1Njcm9sbCkgewogICAgICB0aGlzLmxpc3RlbmVycy5wdXNoKHNldHVwU2Nyb2xsKCkpOwogICAgfQogICAgdmFyIGhhbmRsZVJvdXRpbmdFdmVudCA9IGZ1bmN0aW9uIGhhbmRsZVJvdXRpbmdFdmVudCgpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzJDEkMS5jdXJyZW50OwogICAgICBpZiAoIWVuc3VyZVNsYXNoKCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhpcyQxJDEudHJhbnNpdGlvblRvKGdldEhhc2goKSwgZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgICAgaWYgKHN1cHBvcnRzU2Nyb2xsKSB7CiAgICAgICAgICBoYW5kbGVTY3JvbGwodGhpcyQxJDEucm91dGVyLCByb3V0ZSwgY3VycmVudCwgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGlmICghc3VwcG9ydHNQdXNoU3RhdGUpIHsKICAgICAgICAgIHJlcGxhY2VIYXNoKHJvdXRlLmZ1bGxQYXRoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICAgIHZhciBldmVudFR5cGUgPSBzdXBwb3J0c1B1c2hTdGF0ZSA/ICdwb3BzdGF0ZScgOiAnaGFzaGNoYW5nZSc7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZVJvdXRpbmdFdmVudCk7CiAgICB0aGlzLmxpc3RlbmVycy5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBoYW5kbGVSb3V0aW5nRXZlbnQpOwogICAgfSk7CiAgfTsKICBIYXNoSGlzdG9yeS5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uIHB1c2gobG9jYXRpb24sIG9uQ29tcGxldGUsIG9uQWJvcnQpIHsKICAgIHZhciB0aGlzJDEkMSA9IHRoaXM7CiAgICB2YXIgcmVmID0gdGhpczsKICAgIHZhciBmcm9tUm91dGUgPSByZWYuY3VycmVudDsKICAgIHRoaXMudHJhbnNpdGlvblRvKGxvY2F0aW9uLCBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgcHVzaEhhc2gocm91dGUuZnVsbFBhdGgpOwogICAgICBoYW5kbGVTY3JvbGwodGhpcyQxJDEucm91dGVyLCByb3V0ZSwgZnJvbVJvdXRlLCBmYWxzZSk7CiAgICAgIG9uQ29tcGxldGUgJiYgb25Db21wbGV0ZShyb3V0ZSk7CiAgICB9LCBvbkFib3J0KTsKICB9OwogIEhhc2hIaXN0b3J5LnByb3RvdHlwZS5yZXBsYWNlID0gZnVuY3Rpb24gcmVwbGFjZShsb2NhdGlvbiwgb25Db21wbGV0ZSwgb25BYm9ydCkgewogICAgdmFyIHRoaXMkMSQxID0gdGhpczsKICAgIHZhciByZWYgPSB0aGlzOwogICAgdmFyIGZyb21Sb3V0ZSA9IHJlZi5jdXJyZW50OwogICAgdGhpcy50cmFuc2l0aW9uVG8obG9jYXRpb24sIGZ1bmN0aW9uIChyb3V0ZSkgewogICAgICByZXBsYWNlSGFzaChyb3V0ZS5mdWxsUGF0aCk7CiAgICAgIGhhbmRsZVNjcm9sbCh0aGlzJDEkMS5yb3V0ZXIsIHJvdXRlLCBmcm9tUm91dGUsIGZhbHNlKTsKICAgICAgb25Db21wbGV0ZSAmJiBvbkNvbXBsZXRlKHJvdXRlKTsKICAgIH0sIG9uQWJvcnQpOwogIH07CiAgSGFzaEhpc3RvcnkucHJvdG90eXBlLmdvID0gZnVuY3Rpb24gZ28obikgewogICAgd2luZG93Lmhpc3RvcnkuZ28obik7CiAgfTsKICBIYXNoSGlzdG9yeS5wcm90b3R5cGUuZW5zdXJlVVJMID0gZnVuY3Rpb24gZW5zdXJlVVJMKHB1c2gpIHsKICAgIHZhciBjdXJyZW50ID0gdGhpcy5jdXJyZW50LmZ1bGxQYXRoOwogICAgaWYgKGdldEhhc2goKSAhPT0gY3VycmVudCkgewogICAgICBwdXNoID8gcHVzaEhhc2goY3VycmVudCkgOiByZXBsYWNlSGFzaChjdXJyZW50KTsKICAgIH0KICB9OwogIEhhc2hIaXN0b3J5LnByb3RvdHlwZS5nZXRDdXJyZW50TG9jYXRpb24gPSBmdW5jdGlvbiBnZXRDdXJyZW50TG9jYXRpb24oKSB7CiAgICByZXR1cm4gZ2V0SGFzaCgpOwogIH07CiAgcmV0dXJuIEhhc2hIaXN0b3J5Owp9KEhpc3RvcnkpOwpmdW5jdGlvbiBjaGVja0ZhbGxiYWNrKGJhc2UpIHsKICB2YXIgbG9jYXRpb24gPSBnZXRMb2NhdGlvbihiYXNlKTsKICBpZiAoIS9eXC8jLy50ZXN0KGxvY2F0aW9uKSkgewogICAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2UoY2xlYW5QYXRoKGJhc2UgKyAnLyMnICsgbG9jYXRpb24pKTsKICAgIHJldHVybiB0cnVlOwogIH0KfQpmdW5jdGlvbiBlbnN1cmVTbGFzaCgpIHsKICB2YXIgcGF0aCA9IGdldEhhc2goKTsKICBpZiAocGF0aC5jaGFyQXQoMCkgPT09ICcvJykgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJlcGxhY2VIYXNoKCcvJyArIHBhdGgpOwogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBnZXRIYXNoKCkgewogIC8vIFdlIGNhbid0IHVzZSB3aW5kb3cubG9jYXRpb24uaGFzaCBoZXJlIGJlY2F1c2UgaXQncyBub3QKICAvLyBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycyAtIEZpcmVmb3ggd2lsbCBwcmUtZGVjb2RlIGl0IQogIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgdmFyIGluZGV4ID0gaHJlZi5pbmRleE9mKCcjJyk7CiAgLy8gZW1wdHkgcGF0aAogIGlmIChpbmRleCA8IDApIHsKICAgIHJldHVybiAnJzsKICB9CiAgaHJlZiA9IGhyZWYuc2xpY2UoaW5kZXggKyAxKTsKICByZXR1cm4gaHJlZjsKfQpmdW5jdGlvbiBnZXRVcmwocGF0aCkgewogIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgdmFyIGkgPSBocmVmLmluZGV4T2YoJyMnKTsKICB2YXIgYmFzZSA9IGkgPj0gMCA/IGhyZWYuc2xpY2UoMCwgaSkgOiBocmVmOwogIHJldHVybiBiYXNlICsgIiMiICsgcGF0aDsKfQpmdW5jdGlvbiBwdXNoSGFzaChwYXRoKSB7CiAgaWYgKHN1cHBvcnRzUHVzaFN0YXRlKSB7CiAgICBwdXNoU3RhdGUoZ2V0VXJsKHBhdGgpKTsKICB9IGVsc2UgewogICAgd2luZG93LmxvY2F0aW9uLmhhc2ggPSBwYXRoOwogIH0KfQpmdW5jdGlvbiByZXBsYWNlSGFzaChwYXRoKSB7CiAgaWYgKHN1cHBvcnRzUHVzaFN0YXRlKSB7CiAgICByZXBsYWNlU3RhdGUoZ2V0VXJsKHBhdGgpKTsKICB9IGVsc2UgewogICAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2UoZ2V0VXJsKHBhdGgpKTsKICB9Cn0KCi8qICAqLwoKdmFyIEFic3RyYWN0SGlzdG9yeSA9IC8qQF9fUFVSRV9fKi9mdW5jdGlvbiAoSGlzdG9yeSkgewogIGZ1bmN0aW9uIEFic3RyYWN0SGlzdG9yeShyb3V0ZXIsIGJhc2UpIHsKICAgIEhpc3RvcnkuY2FsbCh0aGlzLCByb3V0ZXIsIGJhc2UpOwogICAgdGhpcy5zdGFjayA9IFtdOwogICAgdGhpcy5pbmRleCA9IC0xOwogIH0KICBpZiAoSGlzdG9yeSkgQWJzdHJhY3RIaXN0b3J5Ll9fcHJvdG9fXyA9IEhpc3Rvcnk7CiAgQWJzdHJhY3RIaXN0b3J5LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoSGlzdG9yeSAmJiBIaXN0b3J5LnByb3RvdHlwZSk7CiAgQWJzdHJhY3RIaXN0b3J5LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFic3RyYWN0SGlzdG9yeTsKICBBYnN0cmFjdEhpc3RvcnkucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiBwdXNoKGxvY2F0aW9uLCBvbkNvbXBsZXRlLCBvbkFib3J0KSB7CiAgICB2YXIgdGhpcyQxJDEgPSB0aGlzOwogICAgdGhpcy50cmFuc2l0aW9uVG8obG9jYXRpb24sIGZ1bmN0aW9uIChyb3V0ZSkgewogICAgICB0aGlzJDEkMS5zdGFjayA9IHRoaXMkMSQxLnN0YWNrLnNsaWNlKDAsIHRoaXMkMSQxLmluZGV4ICsgMSkuY29uY2F0KHJvdXRlKTsKICAgICAgdGhpcyQxJDEuaW5kZXgrKzsKICAgICAgb25Db21wbGV0ZSAmJiBvbkNvbXBsZXRlKHJvdXRlKTsKICAgIH0sIG9uQWJvcnQpOwogIH07CiAgQWJzdHJhY3RIaXN0b3J5LnByb3RvdHlwZS5yZXBsYWNlID0gZnVuY3Rpb24gcmVwbGFjZShsb2NhdGlvbiwgb25Db21wbGV0ZSwgb25BYm9ydCkgewogICAgdmFyIHRoaXMkMSQxID0gdGhpczsKICAgIHRoaXMudHJhbnNpdGlvblRvKGxvY2F0aW9uLCBmdW5jdGlvbiAocm91dGUpIHsKICAgICAgdGhpcyQxJDEuc3RhY2sgPSB0aGlzJDEkMS5zdGFjay5zbGljZSgwLCB0aGlzJDEkMS5pbmRleCkuY29uY2F0KHJvdXRlKTsKICAgICAgb25Db21wbGV0ZSAmJiBvbkNvbXBsZXRlKHJvdXRlKTsKICAgIH0sIG9uQWJvcnQpOwogIH07CiAgQWJzdHJhY3RIaXN0b3J5LnByb3RvdHlwZS5nbyA9IGZ1bmN0aW9uIGdvKG4pIHsKICAgIHZhciB0aGlzJDEkMSA9IHRoaXM7CiAgICB2YXIgdGFyZ2V0SW5kZXggPSB0aGlzLmluZGV4ICsgbjsKICAgIGlmICh0YXJnZXRJbmRleCA8IDAgfHwgdGFyZ2V0SW5kZXggPj0gdGhpcy5zdGFjay5sZW5ndGgpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHJvdXRlID0gdGhpcy5zdGFja1t0YXJnZXRJbmRleF07CiAgICB0aGlzLmNvbmZpcm1UcmFuc2l0aW9uKHJvdXRlLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBwcmV2ID0gdGhpcyQxJDEuY3VycmVudDsKICAgICAgdGhpcyQxJDEuaW5kZXggPSB0YXJnZXRJbmRleDsKICAgICAgdGhpcyQxJDEudXBkYXRlUm91dGUocm91dGUpOwogICAgICB0aGlzJDEkMS5yb3V0ZXIuYWZ0ZXJIb29rcy5mb3JFYWNoKGZ1bmN0aW9uIChob29rKSB7CiAgICAgICAgaG9vayAmJiBob29rKHJvdXRlLCBwcmV2KTsKICAgICAgfSk7CiAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGlmIChpc05hdmlnYXRpb25GYWlsdXJlKGVyciwgTmF2aWdhdGlvbkZhaWx1cmVUeXBlLmR1cGxpY2F0ZWQpKSB7CiAgICAgICAgdGhpcyQxJDEuaW5kZXggPSB0YXJnZXRJbmRleDsKICAgICAgfQogICAgfSk7CiAgfTsKICBBYnN0cmFjdEhpc3RvcnkucHJvdG90eXBlLmdldEN1cnJlbnRMb2NhdGlvbiA9IGZ1bmN0aW9uIGdldEN1cnJlbnRMb2NhdGlvbigpIHsKICAgIHZhciBjdXJyZW50ID0gdGhpcy5zdGFja1t0aGlzLnN0YWNrLmxlbmd0aCAtIDFdOwogICAgcmV0dXJuIGN1cnJlbnQgPyBjdXJyZW50LmZ1bGxQYXRoIDogJy8nOwogIH07CiAgQWJzdHJhY3RIaXN0b3J5LnByb3RvdHlwZS5lbnN1cmVVUkwgPSBmdW5jdGlvbiBlbnN1cmVVUkwoKSB7CiAgICAvLyBub29wCiAgfTsKICByZXR1cm4gQWJzdHJhY3RIaXN0b3J5Owp9KEhpc3RvcnkpOwoKLyogICovCgp2YXIgVnVlUm91dGVyID0gZnVuY3Rpb24gVnVlUm91dGVyKG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSBvcHRpb25zID0ge307CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4odGhpcyBpbnN0YW5jZW9mIFZ1ZVJvdXRlciwgIlJvdXRlciBtdXN0IGJlIGNhbGxlZCB3aXRoIHRoZSBuZXcgb3BlcmF0b3IuIik7CiAgfQogIHRoaXMuYXBwID0gbnVsbDsKICB0aGlzLmFwcHMgPSBbXTsKICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogIHRoaXMuYmVmb3JlSG9va3MgPSBbXTsKICB0aGlzLnJlc29sdmVIb29rcyA9IFtdOwogIHRoaXMuYWZ0ZXJIb29rcyA9IFtdOwogIHRoaXMubWF0Y2hlciA9IGNyZWF0ZU1hdGNoZXIob3B0aW9ucy5yb3V0ZXMgfHwgW10sIHRoaXMpOwogIHZhciBtb2RlID0gb3B0aW9ucy5tb2RlIHx8ICdoYXNoJzsKICB0aGlzLmZhbGxiYWNrID0gbW9kZSA9PT0gJ2hpc3RvcnknICYmICFzdXBwb3J0c1B1c2hTdGF0ZSAmJiBvcHRpb25zLmZhbGxiYWNrICE9PSBmYWxzZTsKICBpZiAodGhpcy5mYWxsYmFjaykgewogICAgbW9kZSA9ICdoYXNoJzsKICB9CiAgaWYgKCFpbkJyb3dzZXIpIHsKICAgIG1vZGUgPSAnYWJzdHJhY3QnOwogIH0KICB0aGlzLm1vZGUgPSBtb2RlOwogIHN3aXRjaCAobW9kZSkgewogICAgY2FzZSAnaGlzdG9yeSc6CiAgICAgIHRoaXMuaGlzdG9yeSA9IG5ldyBIVE1MNUhpc3RvcnkodGhpcywgb3B0aW9ucy5iYXNlKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdoYXNoJzoKICAgICAgdGhpcy5oaXN0b3J5ID0gbmV3IEhhc2hIaXN0b3J5KHRoaXMsIG9wdGlvbnMuYmFzZSwgdGhpcy5mYWxsYmFjayk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnYWJzdHJhY3QnOgogICAgICB0aGlzLmhpc3RvcnkgPSBuZXcgQWJzdHJhY3RIaXN0b3J5KHRoaXMsIG9wdGlvbnMuYmFzZSk7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBhc3NlcnQoZmFsc2UsICJpbnZhbGlkIG1vZGU6ICIgKyBtb2RlKTsKICAgICAgfQogIH0KfTsKdmFyIHByb3RvdHlwZUFjY2Vzc29ycyA9IHsKICBjdXJyZW50Um91dGU6IHsKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0KfTsKVnVlUm91dGVyLnByb3RvdHlwZS5tYXRjaCA9IGZ1bmN0aW9uIG1hdGNoKHJhdywgY3VycmVudCwgcmVkaXJlY3RlZEZyb20pIHsKICByZXR1cm4gdGhpcy5tYXRjaGVyLm1hdGNoKHJhdywgY3VycmVudCwgcmVkaXJlY3RlZEZyb20pOwp9Owpwcm90b3R5cGVBY2Nlc3NvcnMuY3VycmVudFJvdXRlLmdldCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5jdXJyZW50Owp9OwpWdWVSb3V0ZXIucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiBpbml0KGFwcCAvKiBWdWUgY29tcG9uZW50IGluc3RhbmNlICovKSB7CiAgdmFyIHRoaXMkMSQxID0gdGhpczsKICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGFzc2VydChpbnN0YWxsLmluc3RhbGxlZCwgIm5vdCBpbnN0YWxsZWQuIE1ha2Ugc3VyZSB0byBjYWxsIGBWdWUudXNlKFZ1ZVJvdXRlcilgICIgKyAiYmVmb3JlIGNyZWF0aW5nIHJvb3QgaW5zdGFuY2UuIik7CiAgdGhpcy5hcHBzLnB1c2goYXBwKTsKCiAgLy8gc2V0IHVwIGFwcCBkZXN0cm95ZWQgaGFuZGxlcgogIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWUtcm91dGVyL2lzc3Vlcy8yNjM5CiAgYXBwLiRvbmNlKCdob29rOmRlc3Ryb3llZCcsIGZ1bmN0aW9uICgpIHsKICAgIC8vIGNsZWFuIG91dCBhcHAgZnJvbSB0aGlzLmFwcHMgYXJyYXkgb25jZSBkZXN0cm95ZWQKICAgIHZhciBpbmRleCA9IHRoaXMkMSQxLmFwcHMuaW5kZXhPZihhcHApOwogICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgdGhpcyQxJDEuYXBwcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgfQogICAgLy8gZW5zdXJlIHdlIHN0aWxsIGhhdmUgYSBtYWluIGFwcCBvciBudWxsIGlmIG5vIGFwcHMKICAgIC8vIHdlIGRvIG5vdCByZWxlYXNlIHRoZSByb3V0ZXIgc28gaXQgY2FuIGJlIHJldXNlZAogICAgaWYgKHRoaXMkMSQxLmFwcCA9PT0gYXBwKSB7CiAgICAgIHRoaXMkMSQxLmFwcCA9IHRoaXMkMSQxLmFwcHNbMF0gfHwgbnVsbDsKICAgIH0KICAgIGlmICghdGhpcyQxJDEuYXBwKSB7CiAgICAgIHRoaXMkMSQxLmhpc3RvcnkudGVhcmRvd24oKTsKICAgIH0KICB9KTsKCiAgLy8gbWFpbiBhcHAgcHJldmlvdXNseSBpbml0aWFsaXplZAogIC8vIHJldHVybiBhcyB3ZSBkb24ndCBuZWVkIHRvIHNldCB1cCBuZXcgaGlzdG9yeSBsaXN0ZW5lcgogIGlmICh0aGlzLmFwcCkgewogICAgcmV0dXJuOwogIH0KICB0aGlzLmFwcCA9IGFwcDsKICB2YXIgaGlzdG9yeSA9IHRoaXMuaGlzdG9yeTsKICBpZiAoaGlzdG9yeSBpbnN0YW5jZW9mIEhUTUw1SGlzdG9yeSB8fCBoaXN0b3J5IGluc3RhbmNlb2YgSGFzaEhpc3RvcnkpIHsKICAgIHZhciBoYW5kbGVJbml0aWFsU2Nyb2xsID0gZnVuY3Rpb24gaGFuZGxlSW5pdGlhbFNjcm9sbChyb3V0ZU9yRXJyb3IpIHsKICAgICAgdmFyIGZyb20gPSBoaXN0b3J5LmN1cnJlbnQ7CiAgICAgIHZhciBleHBlY3RTY3JvbGwgPSB0aGlzJDEkMS5vcHRpb25zLnNjcm9sbEJlaGF2aW9yOwogICAgICB2YXIgc3VwcG9ydHNTY3JvbGwgPSBzdXBwb3J0c1B1c2hTdGF0ZSAmJiBleHBlY3RTY3JvbGw7CiAgICAgIGlmIChzdXBwb3J0c1Njcm9sbCAmJiAnZnVsbFBhdGgnIGluIHJvdXRlT3JFcnJvcikgewogICAgICAgIGhhbmRsZVNjcm9sbCh0aGlzJDEkMSwgcm91dGVPckVycm9yLCBmcm9tLCBmYWxzZSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgc2V0dXBMaXN0ZW5lcnMgPSBmdW5jdGlvbiBzZXR1cExpc3RlbmVycyhyb3V0ZU9yRXJyb3IpIHsKICAgICAgaGlzdG9yeS5zZXR1cExpc3RlbmVycygpOwogICAgICBoYW5kbGVJbml0aWFsU2Nyb2xsKHJvdXRlT3JFcnJvcik7CiAgICB9OwogICAgaGlzdG9yeS50cmFuc2l0aW9uVG8oaGlzdG9yeS5nZXRDdXJyZW50TG9jYXRpb24oKSwgc2V0dXBMaXN0ZW5lcnMsIHNldHVwTGlzdGVuZXJzKTsKICB9CiAgaGlzdG9yeS5saXN0ZW4oZnVuY3Rpb24gKHJvdXRlKSB7CiAgICB0aGlzJDEkMS5hcHBzLmZvckVhY2goZnVuY3Rpb24gKGFwcCkgewogICAgICBhcHAuX3JvdXRlID0gcm91dGU7CiAgICB9KTsKICB9KTsKfTsKVnVlUm91dGVyLnByb3RvdHlwZS5iZWZvcmVFYWNoID0gZnVuY3Rpb24gYmVmb3JlRWFjaChmbikgewogIHJldHVybiByZWdpc3Rlckhvb2sodGhpcy5iZWZvcmVIb29rcywgZm4pOwp9OwpWdWVSb3V0ZXIucHJvdG90eXBlLmJlZm9yZVJlc29sdmUgPSBmdW5jdGlvbiBiZWZvcmVSZXNvbHZlKGZuKSB7CiAgcmV0dXJuIHJlZ2lzdGVySG9vayh0aGlzLnJlc29sdmVIb29rcywgZm4pOwp9OwpWdWVSb3V0ZXIucHJvdG90eXBlLmFmdGVyRWFjaCA9IGZ1bmN0aW9uIGFmdGVyRWFjaChmbikgewogIHJldHVybiByZWdpc3Rlckhvb2sodGhpcy5hZnRlckhvb2tzLCBmbik7Cn07ClZ1ZVJvdXRlci5wcm90b3R5cGUub25SZWFkeSA9IGZ1bmN0aW9uIG9uUmVhZHkoY2IsIGVycm9yQ2IpIHsKICB0aGlzLmhpc3Rvcnkub25SZWFkeShjYiwgZXJyb3JDYik7Cn07ClZ1ZVJvdXRlci5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIG9uRXJyb3IoZXJyb3JDYikgewogIHRoaXMuaGlzdG9yeS5vbkVycm9yKGVycm9yQ2IpOwp9OwpWdWVSb3V0ZXIucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiBwdXNoKGxvY2F0aW9uLCBvbkNvbXBsZXRlLCBvbkFib3J0KSB7CiAgdmFyIHRoaXMkMSQxID0gdGhpczsKCiAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgaWYgKCFvbkNvbXBsZXRlICYmICFvbkFib3J0ICYmIHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgdGhpcyQxJDEuaGlzdG9yeS5wdXNoKGxvY2F0aW9uLCByZXNvbHZlLCByZWplY3QpOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIHRoaXMuaGlzdG9yeS5wdXNoKGxvY2F0aW9uLCBvbkNvbXBsZXRlLCBvbkFib3J0KTsKICB9Cn07ClZ1ZVJvdXRlci5wcm90b3R5cGUucmVwbGFjZSA9IGZ1bmN0aW9uIHJlcGxhY2UobG9jYXRpb24sIG9uQ29tcGxldGUsIG9uQWJvcnQpIHsKICB2YXIgdGhpcyQxJDEgPSB0aGlzOwoKICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICBpZiAoIW9uQ29tcGxldGUgJiYgIW9uQWJvcnQgJiYgdHlwZW9mIFByb21pc2UgIT09ICd1bmRlZmluZWQnKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICB0aGlzJDEkMS5oaXN0b3J5LnJlcGxhY2UobG9jYXRpb24sIHJlc29sdmUsIHJlamVjdCk7CiAgICB9KTsKICB9IGVsc2UgewogICAgdGhpcy5oaXN0b3J5LnJlcGxhY2UobG9jYXRpb24sIG9uQ29tcGxldGUsIG9uQWJvcnQpOwogIH0KfTsKVnVlUm91dGVyLnByb3RvdHlwZS5nbyA9IGZ1bmN0aW9uIGdvKG4pIHsKICB0aGlzLmhpc3RvcnkuZ28obik7Cn07ClZ1ZVJvdXRlci5wcm90b3R5cGUuYmFjayA9IGZ1bmN0aW9uIGJhY2soKSB7CiAgdGhpcy5nbygtMSk7Cn07ClZ1ZVJvdXRlci5wcm90b3R5cGUuZm9yd2FyZCA9IGZ1bmN0aW9uIGZvcndhcmQoKSB7CiAgdGhpcy5nbygxKTsKfTsKVnVlUm91dGVyLnByb3RvdHlwZS5nZXRNYXRjaGVkQ29tcG9uZW50cyA9IGZ1bmN0aW9uIGdldE1hdGNoZWRDb21wb25lbnRzKHRvKSB7CiAgdmFyIHJvdXRlID0gdG8gPyB0by5tYXRjaGVkID8gdG8gOiB0aGlzLnJlc29sdmUodG8pLnJvdXRlIDogdGhpcy5jdXJyZW50Um91dGU7CiAgaWYgKCFyb3V0ZSkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gW10uY29uY2F0LmFwcGx5KFtdLCByb3V0ZS5tYXRjaGVkLm1hcChmdW5jdGlvbiAobSkgewogICAgcmV0dXJuIE9iamVjdC5rZXlzKG0uY29tcG9uZW50cykubWFwKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgcmV0dXJuIG0uY29tcG9uZW50c1trZXldOwogICAgfSk7CiAgfSkpOwp9OwpWdWVSb3V0ZXIucHJvdG90eXBlLnJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlKHRvLCBjdXJyZW50LCBhcHBlbmQpIHsKICBjdXJyZW50ID0gY3VycmVudCB8fCB0aGlzLmhpc3RvcnkuY3VycmVudDsKICB2YXIgbG9jYXRpb24gPSBub3JtYWxpemVMb2NhdGlvbih0bywgY3VycmVudCwgYXBwZW5kLCB0aGlzKTsKICB2YXIgcm91dGUgPSB0aGlzLm1hdGNoKGxvY2F0aW9uLCBjdXJyZW50KTsKICB2YXIgZnVsbFBhdGggPSByb3V0ZS5yZWRpcmVjdGVkRnJvbSB8fCByb3V0ZS5mdWxsUGF0aDsKICB2YXIgYmFzZSA9IHRoaXMuaGlzdG9yeS5iYXNlOwogIHZhciBocmVmID0gY3JlYXRlSHJlZihiYXNlLCBmdWxsUGF0aCwgdGhpcy5tb2RlKTsKICByZXR1cm4gewogICAgbG9jYXRpb246IGxvY2F0aW9uLAogICAgcm91dGU6IHJvdXRlLAogICAgaHJlZjogaHJlZiwKICAgIC8vIGZvciBiYWNrd2FyZHMgY29tcGF0CiAgICBub3JtYWxpemVkVG86IGxvY2F0aW9uLAogICAgcmVzb2x2ZWQ6IHJvdXRlCiAgfTsKfTsKVnVlUm91dGVyLnByb3RvdHlwZS5nZXRSb3V0ZXMgPSBmdW5jdGlvbiBnZXRSb3V0ZXMoKSB7CiAgcmV0dXJuIHRoaXMubWF0Y2hlci5nZXRSb3V0ZXMoKTsKfTsKVnVlUm91dGVyLnByb3RvdHlwZS5hZGRSb3V0ZSA9IGZ1bmN0aW9uIGFkZFJvdXRlKHBhcmVudE9yUm91dGUsIHJvdXRlKSB7CiAgdGhpcy5tYXRjaGVyLmFkZFJvdXRlKHBhcmVudE9yUm91dGUsIHJvdXRlKTsKICBpZiAodGhpcy5oaXN0b3J5LmN1cnJlbnQgIT09IFNUQVJUKSB7CiAgICB0aGlzLmhpc3RvcnkudHJhbnNpdGlvblRvKHRoaXMuaGlzdG9yeS5nZXRDdXJyZW50TG9jYXRpb24oKSk7CiAgfQp9OwpWdWVSb3V0ZXIucHJvdG90eXBlLmFkZFJvdXRlcyA9IGZ1bmN0aW9uIGFkZFJvdXRlcyhyb3V0ZXMpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgd2FybihmYWxzZSwgJ3JvdXRlci5hZGRSb3V0ZXMoKSBpcyBkZXByZWNhdGVkIGFuZCBoYXMgYmVlbiByZW1vdmVkIGluIFZ1ZSBSb3V0ZXIgNC4gVXNlIHJvdXRlci5hZGRSb3V0ZSgpIGluc3RlYWQuJyk7CiAgfQogIHRoaXMubWF0Y2hlci5hZGRSb3V0ZXMocm91dGVzKTsKICBpZiAodGhpcy5oaXN0b3J5LmN1cnJlbnQgIT09IFNUQVJUKSB7CiAgICB0aGlzLmhpc3RvcnkudHJhbnNpdGlvblRvKHRoaXMuaGlzdG9yeS5nZXRDdXJyZW50TG9jYXRpb24oKSk7CiAgfQp9OwpPYmplY3QuZGVmaW5lUHJvcGVydGllcyhWdWVSb3V0ZXIucHJvdG90eXBlLCBwcm90b3R5cGVBY2Nlc3NvcnMpOwp2YXIgVnVlUm91dGVyJDEgPSBWdWVSb3V0ZXI7CmZ1bmN0aW9uIHJlZ2lzdGVySG9vayhsaXN0LCBmbikgewogIGxpc3QucHVzaChmbik7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHZhciBpID0gbGlzdC5pbmRleE9mKGZuKTsKICAgIGlmIChpID4gLTEpIHsKICAgICAgbGlzdC5zcGxpY2UoaSwgMSk7CiAgICB9CiAgfTsKfQpmdW5jdGlvbiBjcmVhdGVIcmVmKGJhc2UsIGZ1bGxQYXRoLCBtb2RlKSB7CiAgdmFyIHBhdGggPSBtb2RlID09PSAnaGFzaCcgPyAnIycgKyBmdWxsUGF0aCA6IGZ1bGxQYXRoOwogIHJldHVybiBiYXNlID8gY2xlYW5QYXRoKGJhc2UgKyAnLycgKyBwYXRoKSA6IHBhdGg7Cn0KCi8vIFdlIGNhbm5vdCByZW1vdmUgdGhpcyBhcyBpdCB3b3VsZCBiZSBhIGJyZWFraW5nIGNoYW5nZQpWdWVSb3V0ZXIuaW5zdGFsbCA9IGluc3RhbGw7ClZ1ZVJvdXRlci52ZXJzaW9uID0gJzMuNi41JzsKVnVlUm91dGVyLmlzTmF2aWdhdGlvbkZhaWx1cmUgPSBpc05hdmlnYXRpb25GYWlsdXJlOwpWdWVSb3V0ZXIuTmF2aWdhdGlvbkZhaWx1cmVUeXBlID0gTmF2aWdhdGlvbkZhaWx1cmVUeXBlOwpWdWVSb3V0ZXIuU1RBUlRfTE9DQVRJT04gPSBTVEFSVDsKaWYgKGluQnJvd3NlciAmJiB3aW5kb3cuVnVlKSB7CiAgd2luZG93LlZ1ZS51c2UoVnVlUm91dGVyKTsKfQp2YXIgdmVyc2lvbiA9ICczLjYuNSc7CmV4cG9ydCB7IE5hdmlnYXRpb25GYWlsdXJlVHlwZSwgTGluayBhcyBSb3V0ZXJMaW5rLCBWaWV3IGFzIFJvdXRlclZpZXcsIFNUQVJUIGFzIFNUQVJUX0xPQ0FUSU9OLCBWdWVSb3V0ZXIkMSBhcyBkZWZhdWx0LCBpc05hdmlnYXRpb25GYWlsdXJlLCB2ZXJzaW9uIH07"},null]}